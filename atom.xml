<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Better world by better software</title>
  
  <subtitle>Gleb Bahmutov PhD</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://glebbahmutov.com/blog/"/>
  <updated>2020-09-01T13:32:36.300Z</updated>
  <id>https://glebbahmutov.com/blog/</id>
  
  <author>
    <name>Gleb Bahmutov</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>What I Have Done - An Analysis</title>
    <link href="https://glebbahmutov.com/blog/what-i-have-done/"/>
    <id>https://glebbahmutov.com/blog/what-i-have-done/</id>
    <published>2020-09-01T04:00:00.000Z</published>
    <updated>2020-09-01T13:32:36.300Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Note:</strong> this blog post right here is post number <strong>500</strong> 🎉🎊 so it is a good opportunity to take a quantitative look back.</p><h2><span id="the-daily-logs">The daily logs</span></h2><p>Since March of 2019 I have kept detailed daily notes about the tasks I have been working on. I used Markdown format and <a href="https://typora.io/" target="_blank" rel="noopener">Typora editor</a>, listing everything: GitHub issues, pull requests, meetings, writing blog posts, preparing and delivering presentations, etc. You can find these monthly logs in the repository <a href="https://github.com/bahmutov/daily-logs" target="_blank" rel="noopener">bahmutov/daily-logs</a>. I have redacted private and confidential information from the source files before creating the repository, thus the logs do accurately reflect my daily work.</p><p><img src="/blog/images/daily-logs/typora.png" alt="Typora editor with three monthly files opened"></p><p>You can find the monthly files grouped by year: <a href="https://github.com/bahmutov/daily-logs/tree/main/2019" target="_blank" rel="noopener">2019</a> and <a href="https://github.com/bahmutov/daily-logs/tree/main/2020" target="_blank" rel="noopener">2020</a>. Every day is level 2 heading, with the items in a plain list:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># March 2019</span><br><span class="line"></span><br><span class="line">## Wednesday 2019-03-06</span><br><span class="line"></span><br><span class="line">- iterate and publish [cypress-watch-and-reload](https://github.com/bahmutov/cypress-watch-and-reload) plugin @example</span><br><span class="line">- a few improvements to testing workshop: loading state test, warning about state reset @example</span><br><span class="line">- add custom command example to circleci-orb repo @feature</span><br><span class="line">- created **redacted** Cypress-io organization team @internal</span><br><span class="line">- created example with CircleCI parallel runs depending on branches for Spectrum [circleci-parallel-based-on-env](https://github.com/bahmutov/circleci-parallel-based-on-env) @example</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">## Thursday 2019-03-07</span><br><span class="line"></span><br><span class="line">- can CircleCI distinguish own branches from forked pull requests? @example</span><br><span class="line">  - https://circleci.com/docs/2.0/oss/</span><br><span class="line">  - https://circleci.com/docs/2.0/example-configs/</span><br><span class="line">  - Success: internal branches are running in parallel, while external pull requests run serially https://github.com/bahmutov/circleci-parallel-based-on-env BUT there is still an issue how to make CircleCI / GitHub required check to work with one or the other job</span><br><span class="line">- Published GoDaddy webinar blog post https://www.cypress.io/blog/2019/03/07/how-godaddy-created-a-culture-of-quality/ @slides</span><br><span class="line">- tweaked my code example for `getCookie` documentation page @example</span><br><span class="line">- cleaned up outside contribution to our `debugging` documentation page https://github.com/cypress-io/cypress-documentation/issues/1430 @example</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Every top level item has a category tag. The &quot;official&quot; tags are:</p><ul><li><code>@example</code> task for when I created an example or a demo application to show a concept, like examples in the <a href="https://github.com/cypress-io/cypress-example-kitchensink" target="_blank" rel="noopener">cypress-example-kitchensink</a> and <a href="https://github.com/cypress-io/cypress-example-recipes" target="_blank" rel="noopener">cypress-example-recipes</a> repositories. I also tag most of the work related to the documentation with <code>@example</code> because our docs do have lots of examples.</li><li><code>@feature</code> is the new code or fixing bugs or writing tests or documenting new feature</li><li><code>@internal</code> are utility tasks that are usually private to Cypress</li><li><code>@support</code> supporting our users</li><li><code>@slides</code> preparing for a public presentation, working on slides, sending a proposal</li><li><code>@presentation</code> the actual public presentation in front of people</li><li><code>@learning</code> is when I was learning something new</li><li><code>@hiring</code> working to hire someone</li><li><code>@blog</code> writing a blog post for <a href="https://www.cypress.io/blog/" target="_blank" rel="noopener">https://www.cypress.io/blog/</a>, <a href="https://glebbahmutov.com/blog/">https://glebbahmutov.com/blog/</a>, or some 3rd party blog</li></ul><p>Having these lightweight daily logs helps me during the team&#39;s daily standup (copy/paste into the chat bot), or to talk during the ongoing work with the team. It also tremendously helps me to remember the recent items whenever I need a link or a code snippet to share. It also helps me with &quot;Todo&quot; lists to avoid forgetting things I plan to work on in the future. Thus some of the lists are checklists, and it is ok to have some of them unfinished.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- fix incorrect links in changelog 3.2.0 @feature</span><br><span class="line">- sync with **redacted** about static site and headless content @feature</span><br><span class="line">- [x] reply to **redacted** about Connect.tech @slides</span><br><span class="line">- [x] reply to QA Guild podcast @slides</span><br><span class="line">- [ ] can we batch Renovate bot upgrades? Opened https://github.com/cypress-io/cypress-example-kitchensink/issues/220</span><br><span class="line">- [x] update json schemas blog post and demo project https://github.com/bahmutov/todo-api-with-json-schema @slides</span><br></pre></td></tr></table></figure><h2><span id="totals">Totals</span></h2><p>We can extract the items from Markdown files, group them by tag, and save the totals per month using the scripts in the repo.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run count</span><br><span class="line"></span><br><span class="line">total items 3050</span><br><span class="line">wrote file counted.json</span><br><span class="line">wrote file counted.csv</span><br><span class="line">wrote file counted.md</span><br></pre></td></tr></table></figure><p>I generate <a href="https://github.com/bahmutov/daily-logs/blob/main/counted.csv" target="_blank" rel="noopener">counted.csv</a>, <a href="https://github.com/bahmutov/daily-logs/blob/main/counted.json" target="_blank" rel="noopener">counted.json</a>, and even <a href="https://github.com/bahmutov/daily-logs/blob/main/counted.md" target="_blank" rel="noopener">counted.md</a> files. Let&#39;s look at what I have done in total over the past year and a half.</p><table><thead><tr><th>label</th><th>blog</th><th>example</th><th>feature</th><th>hiring</th><th>internal</th><th>learning</th><th>presentation</th><th>slides</th><th>support</th></tr></thead><tbody><tr><td>03-March-2019</td><td>10</td><td>33</td><td>51</td><td>6</td><td>16</td><td>6</td><td>5</td><td>27</td><td>5</td></tr><tr><td>04-April-2019</td><td>7</td><td>31</td><td>63</td><td>10</td><td>19</td><td>9</td><td>6</td><td>38</td><td>3</td></tr><tr><td>05-May-2019</td><td>11</td><td>24</td><td>67</td><td>11</td><td>14</td><td>4</td><td>3</td><td>15</td><td>1</td></tr><tr><td>06-June-2019</td><td>6</td><td>25</td><td>80</td><td>5</td><td>16</td><td>9</td><td>2</td><td>19</td><td>6</td></tr><tr><td>07-July-2019</td><td>7</td><td>24</td><td>80</td><td>13</td><td>21</td><td>5</td><td>1</td><td>28</td><td>4</td></tr><tr><td>08-August-2019</td><td>8</td><td>21</td><td>51</td><td>18</td><td>16</td><td>5</td><td>3</td><td>13</td><td>10</td></tr><tr><td>09-September-2019</td><td>9</td><td>12</td><td>80</td><td>13</td><td>18</td><td>8</td><td>4</td><td>31</td><td>11</td></tr><tr><td>10-October-2019</td><td>3</td><td>23</td><td>68</td><td>2</td><td>10</td><td>4</td><td>4</td><td>12</td><td>9</td></tr><tr><td>11-November-2019</td><td>7</td><td>22</td><td>69</td><td>1</td><td>9</td><td>4</td><td>4</td><td>8</td><td>9</td></tr><tr><td>12-December-2019</td><td>6</td><td>30</td><td>78</td><td>11</td><td>11</td><td>1</td><td>4</td><td>9</td><td>8</td></tr><tr><td>01-January-2020</td><td>5</td><td>47</td><td>83</td><td>3</td><td>7</td><td>2</td><td>2</td><td>7</td><td>8</td></tr><tr><td>02-February-2020</td><td>2</td><td>30</td><td>89</td><td>1</td><td>4</td><td>3</td><td>4</td><td>13</td><td>4</td></tr><tr><td>03-March-2020</td><td>13</td><td>41</td><td>96</td><td>2</td><td>11</td><td>5</td><td>3</td><td>16</td><td>3</td></tr><tr><td>04-April-2020</td><td>3</td><td>42</td><td>118</td><td>0</td><td>11</td><td>3</td><td>6</td><td>16</td><td>6</td></tr><tr><td>05-May-2020</td><td>7</td><td>58</td><td>112</td><td>0</td><td>8</td><td>5</td><td>3</td><td>19</td><td>9</td></tr><tr><td>06-June-2020</td><td>15</td><td>41</td><td>111</td><td>0</td><td>11</td><td>6</td><td>5</td><td>21</td><td>7</td></tr><tr><td>07-July-2020</td><td>14</td><td>47</td><td>81</td><td>1</td><td>10</td><td>7</td><td>2</td><td>7</td><td>3</td></tr><tr><td>08-August-2020</td><td>9</td><td>24</td><td>54</td><td>0</td><td>14</td><td>5</td><td>3</td><td>13</td><td>6</td></tr><tr><td><strong>total</strong></td><td>142</td><td>575</td><td>1431</td><td>97</td><td>226</td><td>91</td><td>64</td><td>312</td><td>112</td></tr><tr><td><strong>total (%)</strong></td><td>4.66</td><td>18.85</td><td>46.92</td><td>3.18</td><td>7.41</td><td>2.98</td><td>2.10</td><td>10.23</td><td>3.67</td></tr><tr><td><strong>average</strong></td><td>8</td><td>32</td><td>80</td><td>5</td><td>13</td><td>5</td><td>4</td><td>17</td><td>6</td></tr></tbody></table><p>The <strong>total (%)</strong> number divides the total of the current column against the sum of all items (3050) to show the relative number of particular tag. The <strong>average</strong> number for each column divides the total for each column by 18 months.</p><p>You can throw the above CSV into a chart, I like to plot the average breakdown of all tasks by type to get a sense of where I have spent most of my efforts.</p><p><img src="/blog/images/daily-logs/categories.png" alt="Every task type vs total as percentage"></p><p>Let&#39;s take a look at the top three types of work I have done over the past 18 months, and then at the rest.</p><h2><span id="my-top-three">My top three</span></h2><h3><span id="features-features-features">Features, features, features</span></h3><p>Every month, on average, I worked on <strong>80</strong> items that could be considered &quot;feature work&quot;: actual features for Cypress test runner and its numerous parts, build tooling, etc. This number includes the bug fixes as well - anything that touches the code and changes how it works is a &quot;feature&quot; in general sense.</p><p><img src="/blog/images/daily-logs/features.png" alt="Feature work month by month"></p><p>Even better, as the chart above shows, my productivity has generally increased lately. This is due to accumulating a lot of knowledge of Cypress internals and its build steps, and also due to putting effort to bring new features to the users, like <a href="../my-vision-for-component-tests/">component testing</a> which keeps me interested and strongly motivated.</p><h3><span id="more-examples-please">More examples please</span></h3><p>My second biggest chunk of work is creating new examples for our users. On average, I have worked on examples <strong>32</strong> times a month. In my personal opinion, no software can be successful without lots and lots and lots examples. We are working on a complex tool, it gets tricky very quickly (unfortunately), and our users will only be successful when you show them how to handle the different test scenarios.</p><p>I wanted to do more - yes, we do have <a href="https://example.cypress.io" target="_blank" rel="noopener">example.cypress.io</a> with small examples, and <a href="https://github.com/cypress-io/cypress-example-recipes" target="_blank" rel="noopener">cypress-example-recipes</a> with more than 70 larger recipes. I have contributed to both repos a lot, here is the <a href="https://github.com/cypress-io/cypress-example-recipes/graphs/contributors" target="_blank" rel="noopener">recipes repo for example</a>:</p><p><img src="/blog/images/daily-logs/recipes.png" alt="My contributions to the cypress-example-recipes repo"></p><p>But we could do more. This is why I wrote <a href="https://github.com/cypress-io/cypress-fiddle" target="_blank" rel="noopener">cypress-fiddle</a> and made a prototype site <a href="https://glebbahmutov.com/cypress-examples/">glebbahmutov.com/cypress-examples/</a> from <a href="https://github.com/bahmutov/cypress-examples" target="_blank" rel="noopener">bahmutov/cypress-examples</a>; this project would allow our team to write 10 times more examples than we have right now in a shorter amount of time.</p><h3><span id="presentations">Presentations</span></h3><p>The last top item that has occupied my time was preparing and giving presentations. I have done <a href="https://glebbahmutov.com/videos">conference talks</a>, <a href="https://on.cypress.io/webinars" target="_blank" rel="noopener">Cypress webinars</a>, and internal presentations at other companies. Every talk requires preparation, on average I have 5 times as many prep tasks (tagged <code>@slides</code>) as the presentations themselves (tagged <code>@presentation</code>).</p><h2><span id="the-bottom-four">The bottom four</span></h2><p>From the report, you can see I don&#39;t spend much time in the meetings, interviewing candidates, supporting users, or learning. Let&#39;s dig into these numbers a little bit, since they are a little bit misleading.</p><p>I can count myself lucky. I had very few internal meetings, under 10% of my tasks. The Cypress engineering process is pretty lightweight, and does not require too much team syncing. Thus the <code>@internal</code> items are only occupying a tiny percentage of my weekly activities. It might change in the future, as the company is growing. We will see.</p><p>Another interesting trend relates to hiring. I have joined Cypress 3 years ago in May of 2017 when the entire company had only five people. As we grew, I had to interview a lot of people to hire for every engineering position. As we reached our current size, the need to personally interview every candidate disappeared. Thus I could spend more time writing examples, while essentially stopping interviewing in the recent months.</p><p><img src="/blog/images/daily-logs/interviews.png" alt="Interviewing vs working on examples"></p><p>There are very few items marked <code>@support</code> - not because I do not answer users&#39; questions in <a href="https://on.cypress.io/chat" target="_blank" rel="noopener">Cypress chat</a> or on Twitter, or via GH issues. I answer these public questions a lot, usually by sending links to examples! Thus I would mark work to create a public example and send it to the user as <code>@example</code>. Most of the items marked <code>@support</code> is an actual user session with our Cypress users due to some difficulty in setting up Cypress in their environment, or running into a problem in a specific app, etc - the paid support.</p><p>Finally, the tasks marked <code>@learning</code> are honestly an undercount of the daily stream of articles, videos, and tutorials I go through. I just don&#39;t always remember to add them into the daily log. I would say about one or two items per day should be in this category, but alas I don&#39;t have a record to support it.</p><h2><span id="github-activity">GitHub Activity</span></h2><p>I am lucky to do most of my work in the open using mostly public GitHub repositories, issues, and NPM packages. Thus one can see (mostly) everything from the pas 18 months in the table below.</p><!-- prettier-ignore-start --><table><thead><tr><th>Month</th><th>GH</th><th>Commits</th><th>New repos</th><th>PRs</th><th>Reviews</th><th>Opened issues</th><th>Total</th><th>Level</th></tr></thead><tbody><tr><td><a href="./2019/03-March-2019.md">March 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-03-01&amp;to=2019-03-31" target="_blank" rel="noopener">Link</a></td><td>697</td><td>13</td><td>45</td><td>8</td><td>72</td><td>138</td><td>100%</td></tr><tr><td><a href="./2019/04-April-2019.md">April 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-04-01&amp;to=2019-04-30" target="_blank" rel="noopener">Link</a></td><td>1391</td><td>7</td><td>49</td><td>8</td><td>58</td><td>122</td><td>88%</td></tr><tr><td><a href="./2019/05-May-2019.md">May 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-05-01&amp;to=2019-05-31" target="_blank" rel="noopener">Link</a></td><td>1038</td><td>8</td><td>52</td><td>10</td><td>47</td><td>117</td><td>85%</td></tr><tr><td><a href="./2019/06-June-2019.md">June 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-06-01&amp;to=2019-06-30" target="_blank" rel="noopener">Link</a></td><td>925</td><td>12</td><td>43</td><td>13</td><td>31</td><td>99</td><td>72%</td></tr><tr><td><a href="./2019/07-July-2019.md">July 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-07-01&amp;to=2019-07-31" target="_blank" rel="noopener">Link</a></td><td>1663</td><td>13</td><td>44</td><td>16</td><td>63</td><td>136</td><td>99%</td></tr><tr><td><a href="./2019/08-August-2019.md">August 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-08-01&amp;to=2019-08-31" target="_blank" rel="noopener">Link</a></td><td>378</td><td>4</td><td>26</td><td>7</td><td>31</td><td>68</td><td>50%</td></tr><tr><td><a href="./2019/09-September-2019.md">September 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-09-01&amp;to=2019-09-30" target="_blank" rel="noopener">Link</a></td><td>715</td><td>10</td><td>24</td><td>11</td><td>30</td><td>75</td><td>54%</td></tr><tr><td><a href="./2019/10-October-2019.md">October 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-10-01&amp;to=2019-10-31" target="_blank" rel="noopener">Link</a></td><td>1095</td><td>5</td><td>42</td><td>18</td><td>41</td><td>106</td><td>77%</td></tr><tr><td><a href="./2019/11-November-2019.md">November 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-11-01&amp;to=2019-11-30" target="_blank" rel="noopener">Link</a></td><td>1012</td><td>11</td><td>39</td><td>23</td><td>58</td><td>131</td><td>95%</td></tr><tr><td><a href="./2019/12-December-2019.md">December 2019</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2019-12-01&amp;to=2019-12-31" target="_blank" rel="noopener">Link</a></td><td>1169</td><td>11</td><td>32</td><td>27</td><td>35</td><td>105</td><td>76%</td></tr><tr><td><a href="./2020/01-January-2020.md">January 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-01-01&amp;to=2020-01-31" target="_blank" rel="noopener">Link</a></td><td>802</td><td>7</td><td>62</td><td>34</td><td>41</td><td>144</td><td>104%</td></tr><tr><td><a href="./2020/02-February-2020.md">February 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-02-01&amp;to=2020-02-29" target="_blank" rel="noopener">Link</a></td><td>1190</td><td>10</td><td>79</td><td>42</td><td>80</td><td>211</td><td>160%</td></tr><tr><td><a href="./2020/03-March-2020.md">March 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-03-01&amp;to=2020-03-31" target="_blank" rel="noopener">Link</a></td><td>1386</td><td>9</td><td>81</td><td>34</td><td>74</td><td>198</td><td>143%</td></tr><tr><td><a href="./2020/04-April-2020.md">April 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-04-01&amp;to=2020-04-30" target="_blank" rel="noopener">Link</a></td><td>1145</td><td>29</td><td>85</td><td>26</td><td>89</td><td>229</td><td>166%</td></tr><tr><td><a href="./2020/05-May-2020.md">May 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-05-01&amp;to=2020-05-31" target="_blank" rel="noopener">Link</a></td><td>1311</td><td>30</td><td>89</td><td>38</td><td>102</td><td>259</td><td>188%</td></tr><tr><td><a href="./2020/06-June-2020.md">June 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-06-01&amp;to=2020-06-30" target="_blank" rel="noopener">Link</a></td><td>1183</td><td>8</td><td>51</td><td>35</td><td>66</td><td>160</td><td>116%</td></tr><tr><td><a href="./2020/07-July-2020.md">July 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-07-01&amp;to=2020-07-31" target="_blank" rel="noopener">Link</a></td><td>943</td><td>7</td><td>62</td><td>35</td><td>57</td><td>161</td><td>117%</td></tr><tr><td><a href="./2020/08-August-2020.md">August 2020</a></td><td><a href="https://github.com/bahmutov?tab=overview&amp;from=2020-08-01&amp;to=2020-08-31" target="_blank" rel="noopener">Link</a></td><td>743</td><td>4</td><td>19</td><td>27</td><td>14</td><td>64</td><td>46%</td></tr></tbody></table><!-- prettier-ignore-end --><p><strong>Total</strong> = new repos + PRs + reviews + opened issues</p><p>We take the first month of March 2019 as the base level of 100% and normalize the GH work against that month.</p><p><strong>Level</strong> = month&#39;s total / 138 * 100</p><p>Let&#39;s plot the <strong>Level</strong> column. I see a mostly productive 2020. I have skipped August 2020 since I am taking a couple of weeks off. August 2019 is also a &quot;down&quot; month since the entire family went on a trip.</p><p><img src="/blog/images/daily-logs/gh-activity.png" alt="GitHub activity normalized against the first month"></p><p>The daily logs and the GitHub activity are in agreement with each other - compare the above contributions chart to the &quot;hiring vs examples&quot; chart - the overall shape of the red example bars matches the GitHub activity chart here.</p><p>I love my open source work at <a href="https://github.com/cypress-io" target="_blank" rel="noopener">github.com/cypress-io</a> and in personal repositories <a href="https://github.com/bahmutov" target="_blank" rel="noopener">github.com/bahmutov</a>. I hope my next 18 months are as productive!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; this blog post right here is post number &lt;strong&gt;500&lt;/strong&gt; 🎉🎊 so it is a good opportunity to take a quantitat
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="advice" scheme="https://glebbahmutov.com/blog/tags/advice/"/>
    
      <category term="markdown" scheme="https://glebbahmutov.com/blog/tags/markdown/"/>
    
  </entry>
  
  <entry>
    <title>It Is OK to Get Stuck Sometimes</title>
    <link href="https://glebbahmutov.com/blog/it-is-ok-to-get-stuck/"/>
    <id>https://glebbahmutov.com/blog/it-is-ok-to-get-stuck/</id>
    <published>2020-08-25T04:00:00.000Z</published>
    <updated>2020-08-25T14:04:05.206Z</updated>
    
    <content type="html"><![CDATA[<p>Everyone gets stuck sometimes. I love and enjoy coding in JavaScript, have been doing it for a while, yet sometimes I commit simple mistakes. Most of the times, the linter or the tests catch them. But sometimes a harder to catch error slips through, stumbling me for a while. Recently, our open source test runner Cypress continuous integration broke due to Mac application code signing.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> electron-osx-sign Error executing file:</span><br><span class="line">&gt; Stdout:</span><br><span class="line">&gt; Stderr: .../node_modules/@ffmpeg-installer/darwin-x64/ffmpeg: No such file or directory</span><br></pre></td></tr></table></figure><p>We just merged a very large <a href="https://github.com/cypress-io/cypress/pull/7753" target="_blank" rel="noopener">v5.0 pull request</a>, so I naturally suspected the problem to be due to this large code change. The squashed commit included Electron application upgrade, Node version change, and lots of code and dependency changes.</p><p>The funny thing was that it has built and signed the binary from the merge commit, and the CI has started failing on the <em>next</em> build. Even funnier was that I could build and code sign Mac application just fine on my laptop using exactly the same source code. The final piece of the puzzle (that actually should have been my clue) was that the missing file &quot;.../node_modules/@ffmpeg-installer/darwin-x64/ffmpeg&quot; was actually present! Hmm. I started my investigation in <a href="https://github.com/cypress-io/cypress/issues/8299" target="_blank" rel="noopener">issue #8299</a>. I spent probably two full days looking for the source of the problem, trying to update Electron builder, playing with Mac machine versions, etc.</p><p>After 2 days I brought in the big guns: the Cypress&#39; author Brian Mann pair-programmed with me on this issue. We looked at each part of the code, ran the individual actions by themselves - it all seemed to work separately, yet fail together. Altogether we spent around 4-6 hours looking at the CI machine, learnt VIM (normally we code using VSCode) to be able to edit files directly on the CI machine, etc.</p><p>Nothing.</p><p>While looking at some unrelated thing we accidentally looked at the file <a href="https://github.com/cypress-io/cypress/blob/abf4d858694e1be3ae6b93da42c6678ad22ba290/scripts/after-pack-hook.js" target="_blank" rel="noopener">scripts/after-pack-hook.js</a> and Brian saw something suspicious. This code that copies files from each subfolder used <code>async / await</code> keywords:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'copying node_modules to'</span>, outputFolder)</span><br><span class="line"></span><br><span class="line">packages.forEach(<span class="keyword">async</span> (packageNodeModules) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'copying'</span>, packageNodeModules)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sourceFolder = join(params.packager.info._appDir, packageNodeModules)</span><br><span class="line">  <span class="keyword">const</span> destinationFolder = join(outputFolder, packageNodeModules)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> fs.copy(sourceFolder, destinationFolder)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'all node_modules subfolders copied to'</span>, outputFolder)</span><br></pre></td></tr></table></figure><p>The debug output on the CI machine looked correct:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">copying node_modules to ...</span><br><span class="line">copying folderA</span><br><span class="line">copying folderB</span><br><span class="line">copying folderC</span><br><span class="line">copying folderD</span><br><span class="line">...</span><br><span class="line">all node_modules subfolders copied to ...</span><br></pre></td></tr></table></figure><p>Do you see it? Exactly - the <code>packages.forEach</code> does NOT wait for the result of the callback function, even if it is marked <code>async</code>. Thus this code did NOT wait for the files to be copied, it just went on to the code signing part! The fix was a one line change in <a href="https://github.com/cypress-io/cypress/pull/8378" target="_blank" rel="noopener">PR #8378</a>.</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- packages.forEach(async (packageNodeModules) =&gt; &#123;</span></span><br><span class="line"><span class="addition">+ for await (const packageNodeModules of packages) &#123;</span></span><br></pre></td></tr></table></figure><p>Sigh.</p><p>So the code signing used to work accidentally, and once we upgraded the Electron framework and changed the dependencies, the copying slowed down enough for the code signing to not find the <code>ffmpeg</code> file when needed. Yet when we looked at the failed build, the copying has finished and <code>ffmpeg</code> was present, confusing us.</p><p>Last note: if we logged the folder copy operations <em>after</em> the fact we would have seen the problem, since we would see the log lines out of order:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">copying node_modules to ...</span><br><span class="line">all node_modules subfolders copied to ...</span><br><span class="line">copied folderA</span><br><span class="line">copied folderB</span><br><span class="line">copied folderC</span><br><span class="line">copied folderD</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Everyone gets stuck sometimes. I love and enjoy coding in JavaScript, have been doing it for a while, yet sometimes I commit simple mista
      
    
    </summary>
    
      <category term="people" scheme="https://glebbahmutov.com/blog/categories/people/"/>
    
    
      <category term="javascript" scheme="https://glebbahmutov.com/blog/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>Test the Preview Vercel Deploys</title>
    <link href="https://glebbahmutov.com/blog/develop-preview-test/"/>
    <id>https://glebbahmutov.com/blog/develop-preview-test/</id>
    <published>2020-08-20T04:00:00.000Z</published>
    <updated>2020-08-20T16:20:51.615Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#the-site">The site</a></li><li><a href="#vercel-deployment">Vercel deployment</a><ul><li><a href="#index-page">Index page</a></li></ul></li><li><a href="#preview-deploys">Preview deploys</a></li><li><a href="#testing">Testing</a><ul><li><a href="#testing-previews">Testing previews</a></li></ul></li><li><a href="#github-checks">GitHub Checks</a></li><li><a href="#cypress-dashboard">Cypress Dashboard</a></li><li><a href="#cypress-gh-integration">Cypress GH Integration</a></li><li><a href="#more-info">More info</a></li></ul><!-- tocstop --><h2><span id="the-site">The site</span></h2><p>Let&#39;s play with a personal site made using <a href="https://www.11ty.dev/" target="_blank" rel="noopener">11ty</a>. You can find the source code in the repo <a href="https://github.com/bahmutov/eleventy-example" target="_blank" rel="noopener">bahmutov/eleventy-example</a>. We start with a basic page in the <code>README.md</code> file.</p><figure class="highlight md"><figcaption><span>README.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># My site</span></span><br><span class="line"><span class="quote">&gt; A static site using [11ty](https://www.11ty.dev/)</span></span><br></pre></td></tr></table></figure><p>Install the <code>11ty</code> NPM package</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D @11ty/eleventy</span></span><br><span class="line">+ @11ty/eleventy@0.11.0</span><br></pre></td></tr></table></figure><p>And start the local site</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx eleventy --serve</span></span><br><span class="line">Writing _site/README/index.html from ./README.md.</span><br><span class="line">Writing _site/index.html from ./index.html.</span><br><span class="line">Wrote 2 files in 0.08 seconds (v0.11.0)</span><br><span class="line">Watching…</span><br><span class="line">[Browsersync] Access URLs:</span><br><span class="line"> -----------------------------------</span><br><span class="line">       Local: http://localhost:8081</span><br><span class="line">    External: http://10.0.0.141:8081</span><br><span class="line"> -----------------------------------</span><br><span class="line">          UI: http://localhost:3001</span><br><span class="line"> UI External: http://localhost:3001</span><br><span class="line"> -----------------------------------</span><br><span class="line">[Browsersync] Serving files from: _site</span><br></pre></td></tr></table></figure><p>The static page does not look like much - but the generator is fast and simple to use.</p><p><img src="/blog/images/deploy-preview-test/readme.png" alt="README page"></p><p><strong>Tip:</strong> by default <code>eleventy --start</code> serves the page at port 8080. If that port is busy, it automatically serves at the next available port, in this case the site was serves at port 8081.</p><h2><span id="vercel-deployment">Vercel deployment</span></h2><p>We need the entire world to see our awesome site. Let&#39;s deploy it using <a href="https://vercel.com/" target="_blank" rel="noopener">Vercel</a> platform. I have created a new project and picked &quot;11ty&quot; application&#39;s default settings for the build command and output folder.</p><p><img src="/blog/images/deploy-preview-test/settings.png" alt="Vercel project settings page"></p><p>I have linked the Vercel project with the GitHub repository <a href="https://github.com/bahmutov/eleventy-example" target="_blank" rel="noopener">bahmutov/eleventy-example</a></p><p><img src="/blog/images/deploy-preview-test/git-integration.png" alt="Vercel project is linked to the GitHub repository"></p><p>Every time we push a new commit to the <code>main</code> branch, the static site is built and deployed globally under a subdomain of <code>vercel.app</code>.</p><p><img src="/blog/images/deploy-preview-test/domains.png" alt="Production site lives at this domain"></p><p>Here is the production site deployed from the <code>main</code> branch.</p><p><img src="/blog/images/deploy-preview-test/main.png" alt="Deployed main branch is the production"></p><h3><span id="index-page">Index page</span></h3><p>We probably want to deploy the top level index page as well, and navigate to the <code>/README</code> page. Let&#39;s throw a root <code>index.html</code> there</p><figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>11ty Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hi there<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Check out <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/README"</span>&gt;</span>the README<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The navigation works: when the users clicks on the link, the browser goes to the <code>/README</code> page. When the user clicks the browser&#39;s &quot;back&quot; button, it navigates back to the index page.</p><p><img src="/blog/images/deploy-preview-test/navigation.gif" alt="Navigation is working locally"></p><h2><span id="preview-deploys">Preview deploys</span></h2><p>I want to deploy the new index page - but I am not sure if the top level navigation is going to work with an actual domain (because I seriously doubt my programming skills). It would be a nice idea to deploy the full site to a temporary <em>preview domain</em> first, test it out, and if it works correctly, then merge the pull request to the <code>main</code> branch, which deploys to production.</p><p>I will create a new branch <code>add-index-page</code> and commit the new code there:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/git/eleventy-example on add-index-page</span><br><span class="line">$ git log --oneline</span><br><span class="line">1407be3 (HEAD -&gt; add-index-page) add index page with navigation</span><br></pre></td></tr></table></figure><p>In my GitHub repository I have installed the <a href="https://vercel.com/docs/git-integrations/vercel-for-github" target="_blank" rel="noopener">Vercel GitHub App</a> which automatically deploys every pull request.</p><p><img src="/blog/images/deploy-preview-test/vercel-for-github.png" alt="Vercel for GitHub"></p><p>By pushing the new branch to the repository and opening a pull request <a href="https://github.com/bahmutov/eleventy-example/pull/2" target="_blank" rel="noopener">#2</a> I trigger the deployment. The Vercel bot comments on the PR with the deployed URL</p><p><img src="/blog/images/deploy-preview-test/preview-comment.png" alt="Preview deployment comment"></p><p>We can click on the preview URL to visit the deployed site and confirm manually that the navigation works</p><p><img src="/blog/images/deploy-preview-test/preview.gif" alt="Preview deployment shows the navigation is working"></p><p>The PR preview URL <code>https://eleventy-example-git-add-index-page.bahmutov.vercel.app/</code> is a concatenation of the project name &quot;eleventy-example&quot;, the source type &quot;git&quot;, the branch name &quot;add-index-page&quot;, my user name &quot;bahmutov&quot;, and the top level domain name &quot;vercel.app&quot;. In addition, there is a unique preview URL for <em>every commit</em>. You can find these URLs at the Vercel deploy page.</p><p><img src="/blog/images/deploy-preview-test/urls.png" alt="PR preview URLs"></p><p>If we push more commits to the branch <code>add-index-page</code>, the new deploys will get their new unique <code>eleventy-example-&lt;HASH&gt;.vercel.app</code> URLs, while the latest branch preview will still have the top level <code>&lt;project&gt;-git-&lt;branch&gt;-&lt;username&gt;.vercel.app</code> URL.</p><h2><span id="testing">Testing</span></h2><p>We have tried the PR preview manually, but a better idea to prevent bugs in the deployed web applications is to write automated end-to-end tests using <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress</a>. Let&#39;s install Cypress and write a test in our pull request.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress</span></span><br></pre></td></tr></table></figure><p>When we ran the site locally, we tested it at the <code>localhost:8080</code>. Let&#39;s put this setting into <code>cypress.json</code> file.</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:8080"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Our spec file will perform what we have done manually - it will navigate by using the link to the <code>/README</code> page and back.</p><figure class="highlight js"><figcaption><span>cypress/integration/spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="cypress" /&gt;</span></span><br><span class="line">describe(<span class="string">"11ty"</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">"navigates"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// find more Cypress commands at</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/api</span></span><br><span class="line">    cy.visit(<span class="string">"/"</span>);</span><br><span class="line">    cy.contains(<span class="string">"Hi there"</span>);</span><br><span class="line">    cy.contains(<span class="string">"a"</span>, <span class="string">"the README"</span>).click();</span><br><span class="line">    cy.location(<span class="string">"pathname"</span>).should(<span class="string">"match"</span>, /\/README\/$/);</span><br><span class="line">    cy.go(<span class="string">"back"</span>);</span><br><span class="line">    cy.contains(<span class="string">"Hi there"</span>); <span class="comment">// back on the index page</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Start Cypress with <code>npx cypress open</code> while the application is running and observe the test passing for the right reason. Hover over each command to observe the site&#39;s DOM snapshot and how it changed in response to the anchor <code>click</code> or <code>cy.go(&#39;back&#39;)</code> command.</p><p><img src="/blog/images/deploy-preview-test/navigation-test.gif" alt="Navigation test passing locally"></p><p><strong>Tip:</strong> read how to write flake-free Cypress tests when navigating from page to page in the blog post <a href="https://www.cypress.io/blog/2020/08/17/when-can-the-test-navigate/" target="_blank" rel="noopener">When Can The Test Navigate?</a>.</p><h3><span id="testing-previews">Testing previews</span></h3><p>We ran the above test locally. Let&#39;s run the same test automatically against the deployed preview URL. Luckily for us, Vercel for GitHub dispatches <em>deployment</em> events to GitHub, and we can write a GitHub Action that would execute in response to this event. Let&#39;s first simply print the event object to see if it has the target preview URL to test.</p><p><strong>Tip:</strong> if you have never used GitHub Actions, read my <a href="../trying-github-actions/">Trying GitHub Actions</a> blog post.</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/events-that-trigger-workflows</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push,</span> <span class="string">deployment,</span> <span class="string">deployment_status]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  show-event:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Dump</span> <span class="string">GitHub</span> <span class="string">context</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          GITHUB_CONTEXT:</span> <span class="string">$&#123;&#123;</span> <span class="string">toJson(github)</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">echo</span> <span class="string">"$GITHUB_CONTEXT"</span></span><br></pre></td></tr></table></figure><ul><li><code>push</code> event happens for every commit. This would give us a chance to test the site separately from the deployment. For example, we could lint the site&#39;s source text and run the Cypress tests against the site running locally.</li><li><code>deployment</code> event happens when Vercel starts the preview deploy - it does not have the deploy URL</li><li><code>deployment_status</code> event is sent by Vercel twice. First, when the preview deployment starts, and second time when the preview deployment finishes.</li></ul><p>Notice that the <code>deployment_status</code> is not listed in the PR checks - they are &quot;hidden&quot; or overwritten by the &quot;deployment&quot; event, which to me seems like a bad user interface.</p><p><img src="/blog/images/deploy-preview-test/deployment-checks.png" alt="GitHub pull request checks"></p><p>Instead, we need to look at the &quot;Actions&quot; tab to see the <code>ci</code> workflows run, and by clicking inside figure out they ran triggered by the <code>deployment_status</code> events.</p><p><img src="/blog/images/deploy-preview-test/ci-events.png" alt="CI events for every commit"></p><p>The pending <code>deployment_status</code> event has the following information inside the <code>github</code> JSON event</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;description&quot;: &quot;Vercel is deploying your app&quot;,</span><br><span class="line">&quot;environment&quot;: &quot;Preview&quot;,</span><br><span class="line">&quot;state&quot;: &quot;pending&quot;,</span><br><span class="line">&quot;target_url&quot;: &quot;https://eleventy-example-5ccl0n3a7.vercel.app&quot;</span><br></pre></td></tr></table></figure><p>The second <code>deployment_status</code> event inside the GitHub CI action has status</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;description&quot;: &quot;Deployment has completed&quot;,</span><br><span class="line">&quot;environment&quot;: &quot;Preview&quot;,</span><br><span class="line">&quot;state&quot;: &quot;success&quot;,</span><br><span class="line">&quot;target_url&quot;: &quot;https://eleventy-example-5ccl0n3a7.vercel.app&quot;</span><br></pre></td></tr></table></figure><p>We can limit the GitHub Action to only run a job when an expression is true. In our case we want to run end-to-end tests only after successful deploy - and we want to pass the &quot;target_url&quot; as <code>baseUrl</code> parameter. We can pass the base url using the <code>CYPRESS_BASE_URL</code> environment variable. Here is our updated workflow file</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/events-that-trigger-workflows</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push,</span> <span class="string">deployment,</span> <span class="string">deployment_status]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  e2e:</span></span><br><span class="line">    <span class="comment"># only runs this job on successful deploy</span></span><br><span class="line"><span class="attr">    if:</span> <span class="string">github.event_name</span> <span class="string">==</span> <span class="string">'deployment_status'</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.deployment_status.state</span> <span class="string">==</span> <span class="string">'success'</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Dump</span> <span class="string">GitHub</span> <span class="string">context</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          GITHUB_CONTEXT:</span> <span class="string">$&#123;&#123;</span> <span class="string">toJson(github)</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo "$GITHUB_CONTEXT"</span></span><br><span class="line"><span class="string"></span><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">🌲</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>When we push the commit, we can see the CI jobs skipped - except for the last job.</p><p><img src="/blog/images/deploy-preview-test/skip-jobs.png" alt="Skip all jobs but one - which runs on successful deployment"></p><p>I love requiring certain test jobs to pass before a pull request can be merged. Thus I set up protected branches with <code>e2e</code> job required to allow merging.</p><p><img src="/blog/images/deploy-preview-test/protected-branch.png" alt="Protected branch `main` requires `e2e` job to pass successfully"></p><p>The E2E job runs ... and fails!</p><p><img src="/blog/images/deploy-preview-test/fails.png" alt="Our test against the preview URL fails"></p><p><strong>Tip:</strong> debugging realistic test failures is much simpler when you have access to the screenshots and test run videos, I recommend using <a href="https://on.cypress.io/dashboard-introduction" target="_blank" rel="noopener">Cypress Dashboard</a> to <a href="https://www.cypress.io/blog/2018/08/28/record-test-artifacts-from-any-ci/" target="_blank" rel="noopener">record the test artifacts from any CI</a>.</p><p>Hmm, seems Vercel does not add a trailing slash when serving the production version of the code, while <code>11ty</code> running locally does add one.</p><p><img src="/blog/images/deploy-preview-test/trailing-slash.png" alt="The difference in trailing slashes"></p><p>Testing against the deployed preview URLs just showed its usefulness. Let&#39;s update the test to be less strict.</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- cy.location("pathname").should("match", /\/README\/$/);</span></span><br><span class="line"><span class="addition">+ cy.location("pathname").should("include", "/README");</span></span><br></pre></td></tr></table></figure><p>Perfect. The test passes locally and against the preview URL.</p><p><img src="/blog/images/deploy-preview-test/passing-e2e.png" alt="Passing E2E test"></p><p>Once the checks are green, I am confident and merge the pull request into the <code>main</code> branch. Vercel then deploys the production site. I can also remove extra CI events and only run the GitHub workflow on successful deployment. To install, cache and run Cypress we can use <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">Cypress GitHub Action</a>:</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/events-that-trigger-workflows</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[deployment_status]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  e2e:</span></span><br><span class="line">    <span class="comment"># only runs this job on successful deploy</span></span><br><span class="line"><span class="attr">    if:</span> <span class="string">github.event.deployment_status.state</span> <span class="string">==</span> <span class="string">'success'</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">🌲</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2><span id="github-checks">GitHub Checks</span></h2><p>There is one more detail that GitHub gets wrong when running tests on <code>deployment_status</code> event. It seems to be confused about <em>which commit</em> is tested, so it never reports the status back to the Pull Request. For example in <a href="https://github.com/bahmutov/eleventy-example/pull/3" target="_blank" rel="noopener">#3</a> we see a pending check.</p><p><img src="/blog/images/deploy-preview-test/no-status.png" alt="The e2e CI check is pending even after the tests have finished"></p><p>To fix this, we can send the commit status ourselves using GitHub REST API call. Here is the added section of the GitHub workflow file. If the Cypress tests pass, we post success. If the Cypress tests fail, or any job step fails, we post the failure status.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci.yml file</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">🌲</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#job-status-check-functions</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Cypress</span> <span class="string">tests</span> <span class="string">✅</span></span><br><span class="line"><span class="attr">  if:</span> <span class="string">$&#123;&#123;</span> <span class="string">success()</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># set the merge commit status check</span></span><br><span class="line">  <span class="comment"># using GitHub REST API</span></span><br><span class="line">  <span class="comment"># see https://docs.github.com/en/rest/reference/repos#create-a-commit-status</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    curl --request POST \</span></span><br><span class="line"><span class="string">    --url https://api.github.com/repos/$<span class="template-variable">&#123;&#123; github.repository &#125;&#125;</span>/statuses/$<span class="template-variable">&#123;&#123; github.sha &#125;&#125;</span> \</span></span><br><span class="line"><span class="string">    --header 'authorization: Bearer $<span class="template-variable">&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span>' \</span></span><br><span class="line"><span class="string">    --header 'content-type: application/json' \</span></span><br><span class="line"><span class="string">    --data '&#123;</span></span><br><span class="line"><span class="string">      "context": "e2e",</span></span><br><span class="line"><span class="string">      "state": "success",</span></span><br><span class="line"><span class="string">      "description": "Cypress tests passed"</span></span><br><span class="line"><span class="string">    &#125;'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">- name:</span> <span class="string">Cypress</span> <span class="string">tests</span> <span class="string">🚨</span></span><br><span class="line"><span class="attr">  if:</span> <span class="string">$&#123;&#123;</span> <span class="string">failure()</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    curl --request POST \</span></span><br><span class="line"><span class="string">    --url https://api.github.com/repos/$<span class="template-variable">&#123;&#123; github.repository &#125;&#125;</span>/statuses/$<span class="template-variable">&#123;&#123; github.sha &#125;&#125;</span> \</span></span><br><span class="line"><span class="string">    --header 'authorization: Bearer $<span class="template-variable">&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span>' \</span></span><br><span class="line"><span class="string">    --header 'content-type: application/json' \</span></span><br><span class="line"><span class="string">    --data '&#123;</span></span><br><span class="line"><span class="string">      "context": "e2e",</span></span><br><span class="line"><span class="string">      "state": "failure",</span></span><br><span class="line"><span class="string">      "description": "Cypress tests failed"</span></span><br><span class="line"><span class="string">    &#125;'</span></span><br></pre></td></tr></table></figure><p>You can see the example run in PR <a href="https://github.com/bahmutov/eleventy-example/pull/4" target="_blank" rel="noopener">#4</a>. The check &quot;e2e&quot; matches the required check name, thus the pull request is all green.</p><p><img src="/blog/images/deploy-preview-test/post-status.png" alt="Posted commit checks"></p><p>When we look at the Action steps, we can see the &quot;Post success&quot; step ran, while the &quot;Post failure&quot; step was skipped.</p><p><img src="/blog/images/deploy-preview-test/post-jobs.png" alt="Job steps"></p><p>We can even provide a link that would take us from the status check straight to the workflow run by forming the full <code>target_url</code> property when posting the status check.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--data &apos;&#123;</span><br><span class="line">  &quot;context&quot;: &quot;e2e&quot;,</span><br><span class="line">  &quot;state&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;Cypress tests passed&quot;,</span><br><span class="line">  &quot;target_url&quot;: &quot;https://github.com/$&#123;&#123; github.repository &#125;&#125;/actions/runs/$&#123;&#123; github.run_id &#125;&#125;&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure><p>This creates the little &quot;Details&quot; link on the right.</p><p><img src="/blog/images/deploy-preview-test/target_url.png" alt="Run URL in the status check"></p><h2><span id="cypress-dashboard">Cypress Dashboard</span></h2><p>I have mentioned before that every Cypress run generates a video, and every failed Cypress test automatically saves the screenshot of the failure. You can store these test artifacts on GitHub, or send them to the <a href="https://on.cypress.io/dashboard-introduction" target="_blank" rel="noopener">Cypress Dashboard</a> where they can be easily viewed. Let&#39;s set up our project for recording.</p><p>In the Cypress Desktop GUI select the &quot;Runs&quot; tab.</p><p><img src="/blog/images/deploy-preview-test/runs.png" alt="Cypress Runs tab"></p><p>Click the &quot;Set up project to record&quot; button.</p><p>I will place the &quot;eleventy-example&quot; project under my personal &quot;Gleb OSS&quot; organization that has the <a href="https://on.cypress.io/organizations#Requesting-OSS-plan-for-an-org" target="_blank" rel="noopener">Cypress Open Source Software billing plan</a>. The test recordings will be public - everyone should be able to see them.</p><p><img src="/blog/images/deploy-preview-test/set-up-project.png" alt="Setting up the project"></p><p>Once I click &quot;Set up project&quot; button, its project id will be added to the <code>cypress.json</code> file and the recording key is shown. Please keep this <a href="https://on.cypress.io/projects#Record-key" target="_blank" rel="noopener">key private</a>.</p><p><img src="/blog/images/deploy-preview-test/record-settings.png" alt="Project recording key"></p><p>I will set the recording key as a GitHub Action Secret in my repository.</p><p><img src="/blog/images/deploy-preview-test/secret.png" alt="Set the record key as GH Action Secret"></p><p>Let&#39;s update the GitHub workflow file to record test results and artifacts. We are using <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">Cypress GitHub Action</a>, thus we need to add <code>record: true</code> parameter and pass the recording secret as an environment variable.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># updated ci.yml file</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">🌲</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>The tests run on GitHub and show the recorded run URL <code>https://dashboard.cypress.io/projects/y2sysj/runs/1</code></p><p><img src="/blog/images/deploy-preview-test/recording-url.png" alt="Recorded test runs show the Dashboard URL"></p><p>At the <a href="https://dashboard.cypress.io/projects/y2sysj/runs" target="_blank" rel="noopener">Dashboard page</a> you can see every spec, every video, every screenshot, and lots of <a href="https://on.cypress.io/analytics" target="_blank" rel="noopener">test analytics</a>.</p><p><img src="/blog/images/deploy-preview-test/first-run.png" alt="First recorded run"></p><h2><span id="cypress-gh-integration">Cypress GH Integration</span></h2><p>If we are using GitHub and Cypress Dashboard, we might as well use the <a href="https://on.cypress.io/github-integration" target="_blank" rel="noopener">Cypress GitHub Integration App</a>. I can add it to all my repositories, or just install it for selected repository &quot;eleventy-example&quot;.</p><p><img src="/blog/images/deploy-preview-test/gh-app.png" alt="Installing Cypress GitHub App"></p><p>Once installed, we can configure how the Cypress GH App comments on pull requests and sets status checks.</p><p><img src="/blog/images/deploy-preview-test/configure-gh-app.png" alt="Configure Cypress GitHub App"></p><p>Let&#39;s try a new pull request <a href="https://github.com/bahmutov/eleventy-example/pull/6" target="_blank" rel="noopener">#6</a> - we will see Vercel&#39;s comment and Cypress&#39; GH comment.</p><p><img src="/blog/images/deploy-preview-test/comments.png" alt="Cypress GitHub App comments on the pull requests"></p><p>Cypress GH App adds its own status check to the commit.</p><p><img src="/blog/images/deploy-preview-test/checks.png" alt="Full set of commit status checks"></p><p>Because we have the Cypress GH status check, we could remove our custom test job check implemented using <code>curl</code> commands. I will leave them in for completeness sake.</p><h2><span id="more-info">More info</span></h2><p>If you want to test a site deployed to GitHub Pages, read <a href="../triple-tested/">Triple Tested Static Site Deployed to GitHub Pages Using GitHub Actions</a>.</p><p>You can test deployed previews using <a href="../gatsby-netlify-circle-and-cypress/">Netlify + CircleCI combination</a></p><p>For full confidence, we do recommend adding <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">visual testing</a> using open source or commercial service to your functional end-to-end tests. Visual testing will prevent any CSS or style regressions from creeping into your site.</p><p>We also recommend for complex web applications to measure the <a href="https://on.cypress.io/code-coverage" target="_blank" rel="noopener">code coverage</a> to ensure all implemented features are covered by end-to-end tests. E2E tests are extremely effective at covering a lot of code.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#the-site&quot;&gt;The site&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#vercel-deployment&quot;&gt;Vercel deployment&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#index-p
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Test The Interface Not The Implementation</title>
    <link href="https://glebbahmutov.com/blog/test-the-interface/"/>
    <id>https://glebbahmutov.com/blog/test-the-interface/</id>
    <published>2020-08-05T04:00:00.000Z</published>
    <updated>2020-08-05T14:54:59.454Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#background">Background</a></li><li><a href="#the-setup">The setup</a></li><li><a href="#hello-world">Hello World</a></li><li><a href="#expandcollapse">ExpandCollapse</a></li><li><a href="#login-form">Login form</a><ul><li><a href="#bdd-assertions">BDD assertions</a></li><li><a href="#selector-playground">Selector Playground</a></li></ul></li><li><a href="#network-requests">Network requests</a><ul><li><a href="#pizza-toppings">Pizza toppings</a></li><li><a href="#remotepizza-with-ajax-call">RemotePizza with Ajax call</a></li><li><a href="#1-dependency-injection">1. Dependency injection</a></li><li><a href="#2-dependency-injection-with-delay">2. Dependency injection with delay</a></li><li><a href="#3-stubbing-the-default-property">3. Stubbing the default property</a></li><li><a href="#4-mocking-named-imports">4. Mocking named imports</a></li><li><a href="#5-stubbing-network">5. Stubbing network</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#relate-blog-posts">Relate blog posts</a></li></ul><!-- tocstop --><p><strong>Note:</strong> you can find the source code for this blog post with both Jest + RTL and Cypress + CTL specs in the repository <a href="https://github.com/bahmutov/rtl-article-2019" target="_blank" rel="noopener">rtl-article-2019</a>.</p><h2><span id="background">Background</span></h2><p>This blog post is based on the excellent series of posts from <a href="https://blog.sapegin.me/" target="_blank" rel="noopener">Artem Sapegin</a> about testing front-end code. In particular, this blog post follows the examples from <a href="https://blog.sapegin.me/all/react-testing-3-jest-and-react-testing-library/" target="_blank" rel="noopener">Modern React testing, part 3: Jest and React Testing Library</a> blog post. As the title says, we will be testing React components, only instead of using Jest test runner plus <a href="https://testing-library.com/docs/react-testing-library/intro" target="_blank" rel="noopener">@testing-library/react</a> (known as RTL) I will be using <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress</a> + <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> to run the tests. Fear not - the change will be minimal, because we also will be using <a href="https://testing-library.com/docs/cypress-testing-library/intro" target="_blank" rel="noopener">@testing-library/cypress</a> (also called CTL). Thus our component tests will <em>look exactly</em> (well, almost, they will in fact be simpler) like before.</p><h2><span id="the-setup">The setup</span></h2><p>We install the testing tools using NPM commands</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress cypress-react-unit-test @testing-library/cypress</span></span><br><span class="line">+ @testing-library/cypress@6.0.0</span><br><span class="line">+ cypress@4.11.0</span><br><span class="line">+ cypress-react-unit-test@4.11.2</span><br></pre></td></tr></table></figure><p>The <code>cypress.json</code> file has all Cypress global configuration settings, where I enable <a href="https://on.cypress.io/experiments#Component-Testing" target="_blank" rel="noopener">component testing</a> and <a href="https://www.cypress.io/blog/2020/06/29/experimental-fetch-polyfill/" target="_blank" rel="noopener">fetch polyfill</a> experimental features.</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"experimentalComponentTesting"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"experimentalFetchPolyfill"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"testFiles"</span>: <span class="string">"**/*cy-spec.js"</span>,</span><br><span class="line">  <span class="attr">"componentFolder"</span>: <span class="string">"src"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The project uses <a href>react-scripts</a> to run the application, thus we should point Cypress to bundle specs using the same settings as the application.</p><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/plugins/react-scripts'</span>)(on, config);</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Finally, we need to load the <code>@testing-library/cypress</code> from the Cypress support file - this will set up the querying commands like <code>cy.findByText</code> we will use in our tests.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-react-unit-test#install</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>);</span><br><span class="line"><span class="comment">// https://testing-library.com/docs/cypress-testing-library/intro</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'@testing-library/cypress/add-commands'</span>);</span><br></pre></td></tr></table></figure><p>I like having component and unit tests close to the source files, thus our tests will live in the <code>src/components/__tests__</code> folder. There are Jest + RTL spec files there already; they use suffix <code>.spec.js</code>, so I will give Cypress component spec files <code>.cy-spec.js</code> suffix.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">src/components/</span><br><span class="line">  __tests__/</span><br><span class="line">    # Jest + RTL test files</span><br><span class="line">    ExpandCollapse.spec.js</span><br><span class="line">    Hello.spec.js</span><br><span class="line">    Login.spec.js</span><br><span class="line">    Pizza.spec.js</span><br><span class="line">    RemotePizza_*.spec.js</span><br><span class="line">    # Cypress + CTL test files</span><br><span class="line">    ExpandCollapse.cy-spec.js</span><br><span class="line">    Hello.cy-spec.js</span><br><span class="line">    Login.cy-spec.js</span><br><span class="line">    Pizza.cy-spec.js</span><br><span class="line">    RemotePizza.cy-spec.js</span><br><span class="line"></span><br><span class="line">  # component source files</span><br><span class="line">  ExpandCollapse.js</span><br><span class="line">  Login.js</span><br><span class="line">  Pizza.js</span><br><span class="line">  RemotePizza.js</span><br></pre></td></tr></table></figure><p>To limit Jest to only run <code>__tests_/*.spec.js</code> files we can add the following to the <code>package.json</code> file</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"jest"</span>: &#123;</span><br><span class="line">    <span class="attr">"testMatch"</span>: [</span><br><span class="line">      <span class="string">"**/__tests__/**/*.spec.js"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>There are several <code>RemotePizza_*.spec.js</code> Jest files showing the different ways of dealing with the network calls. We will look at them later; dealing with method stubbing and network control is one of the nicer Cypress features. For now, let&#39;s start with &quot;Hello World&quot; example.</p><h2><span id="hello-world">Hello World</span></h2><p>We can start by inspecting a Jest + RTL spec file <code>Hello.spec.js</code> - it does not even have a corresponding component source file, since it renders an inline JSX.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/Hello.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'@testing-library/react'</span>;</span><br><span class="line"></span><br><span class="line">test(<span class="string">'hello world'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; getByText &#125; = render(<span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello Jest!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>);</span><br><span class="line">  expect(getByText(<span class="string">'Hello Jest!'</span>)).toBeTruthy();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>The same test but using <code>cypress-react-unit-test</code> replaces <code>render</code> with <code>mount</code> and synchronous calls like <code>render</code>, <code>getByText</code> with implicitly <em>asynchronous</em> commands.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/Hello.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span>;</span><br><span class="line"></span><br><span class="line">it(<span class="string">'hello world'</span>, () =&gt; &#123;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello Jest!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>);</span><br><span class="line">  cy.findByText(<span class="string">'Hello Jest!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>Note:</strong> In @testing-library/cypress v6 synchronous commands like <code>getBy*</code> were removed in favor of asynchronous commands like <code>findBy*</code></p><p>Open Cypress and click the spec filename</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx cypress open</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yarn cypress open</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/click-test.png" alt="Click on the spec filename"></p><p>The component is mounted and shows up on the right side of the browser. The commands from the test <code>mount</code> and <code>findByText</code> are shown in the Command Log on the left.</p><p><img src="/blog/images/test-interface/hello-test.png" alt="Hello world test"></p><p>The Command Log is magical. This is where you can time travel and get more information about every command by clicking on it. Open the DevTools to see more information - because this is a real browser and real DOM elements.</p><p><img src="/blog/images/test-interface/hello-test-devtools.gif" alt="Inspecting the results of command cy.findByText"></p><p>You can see how <code>cy.findByText</code> command searched the document to find the element. Because this is a real DOM node, it is highlighted on the right automatically as you hover over its reference.</p><p><strong>Tip:</strong> you see the <code>&lt;Unknown ...&gt;</code> in the Command Log for the <code>mount</code> command - this is because the component has no JSX name. In majority of cases you would see the JSX name because there would be a function name or component class name:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'hello world component'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> HelloWorld = <span class="function"><span class="params">()</span> =&gt;</span> &lt;p&gt;Hello Jest!<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">HelloWorld</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.findByText('Hello Jest!');</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/name.png" alt="Component name displayed in the Command Log"></p><p><strong>Tip 2:</strong> Cypress has built-in <a href="https://on.cypress.io/contains" target="_blank" rel="noopener">.contains</a> command that searches by text or regular expression. Thus the above test could be written as</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'hello world component'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> HelloWorld = <span class="function"><span class="params">()</span> =&gt;</span> &lt;p&gt;Hello Jest!<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">HelloWorld</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.contains('Hello Jest!');</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p>Just like <code>cy.findTextBy</code>, if the text does not appear in the DOM within 4 seconds, the <code>cy.contains</code> command fails.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'fails if text is not found'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> HelloWorld = <span class="function"><span class="params">()</span> =&gt;</span> &lt;p&gt;Hello Jest!<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">HelloWorld</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.contains('Hello Mocha!');</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/not-found.gif" alt="Command fails after retrying for four seconds"></p><p>We can shorten the retry time globally or per command if we know that our application updates faster.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'fails if text is not found'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> HelloWorld = <span class="function"><span class="params">()</span> =&gt;</span> &lt;p&gt;Hello Jest!<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">HelloWorld</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.contains('Hello Mocha!', &#123;timeout: 200&#125;);</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/not-found-200.gif" alt="Command fails after retrying for 200 milliseconds"></p><p>The test still fails searching for the text that is not there, but now it fails after retrying for only 200ms. Cypress test runner has the built-in <a href="https://on.cypress.io/retry-ability" target="_blank" rel="noopener">retry-ability</a> which allows the tests to be less flaky, and allows us to write tests where every command is asynchronous, even if the test code looks &quot;simple&quot;. This is well shown in the next spec file testing the <code>ExpandCollapse.js</code> component.</p><h2><span id="expandcollapse">ExpandCollapse</span></h2><p>The original Jest component test is below. It renders the component, clicks on the button and checks if the children elements are shown. Then it clicks on the button again and asserts the children elements are hidden.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/ExpandCollapse.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render, fireEvent &#125; <span class="keyword">from</span> <span class="string">'@testing-library/react'</span>;</span><br><span class="line"><span class="keyword">import</span> ExpandCollapse <span class="keyword">from</span> <span class="string">'../ExpandCollapse'</span>;</span><br><span class="line"></span><br><span class="line">test(<span class="string">'button expands and collapses the content'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> children = <span class="string">'Hello world'</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; getByRole, queryByText &#125; = render(</span><br><span class="line">    &lt;ExpandCollapse excerpt=<span class="string">"Information about dogs"</span>&gt;&#123;children&#125;&lt;<span class="regexp">/ExpandCollapse&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  expect(queryByText(children)).not.toBeTruthy();</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  fireEvent.click(getByRole('button', &#123; name: /</span>expand/i &#125;));</span><br><span class="line"></span><br><span class="line">  expect(queryByText(children)).toBeTruthy();</span><br><span class="line"></span><br><span class="line">  fireEvent.click(getByRole(<span class="string">'button'</span>, &#123; <span class="attr">name</span>: <span class="regexp">/collapse/i</span> &#125;));</span><br><span class="line"></span><br><span class="line">  expect(queryByText(children)).not.toBeTruthy();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>The test is synchronous - every action like firing the click event MUST be handled by the component synchronously in order for the test to work. For example, the component has the following logic to re-render on click:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;button</span><br><span class="line">  aria-expanded=&#123;isExpanded ? <span class="string">'true'</span> : <span class="string">'false'</span>&#125;</span><br><span class="line">  onClick=&#123;() =&gt; setExpanded(!isExpanded)&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p>Later we will break the above test by introducing <code>setTimeout</code> into <code>onClick</code> handler, breaking the test. But first let&#39;s see the equivalent Cypress spec file.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/ExpandCollapse.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ExpandCollapse <span class="keyword">from</span> <span class="string">'../ExpandCollapse'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span>;</span><br><span class="line"></span><br><span class="line">it(<span class="string">'button expands and collapses the content'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> children = <span class="string">'Hello world'</span>;</span><br><span class="line">  mount(</span><br><span class="line">    &lt;ExpandCollapse excerpt=<span class="string">"Information about dogs"</span>&gt;&#123;children&#125;&lt;<span class="regexp">/ExpandCollapse&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  cy.findByText(children).should('not.exist');</span></span><br><span class="line"><span class="regexp">  cy.findByRole('button', &#123; name: /</span>expand/i &#125;).click();</span><br><span class="line">  cy.findByText(children); <span class="comment">// should exist assertion is built-in</span></span><br><span class="line">  cy.findByRole(<span class="string">'button'</span>, &#123; <span class="attr">name</span>: <span class="regexp">/collapse/i</span> &#125;).click();</span><br><span class="line">  cy.findByText(children).should(<span class="string">'not.exist'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>The test looks almost exactly the same, and very similar to the <code>HelloWorld</code> spec.</p><ul><li>we use <code>cy.findByText</code> and <code>cy.findByRole</code> commands to find the elements to test</li><li>we can add an assertion to &quot;flip&quot; the meaning of the command. For example, after clicking on the &quot;Collapse&quot; button, the element with text &quot;Hello world&quot; should not longer exist in the DOM</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.findByRole(<span class="string">'button'</span>, &#123; <span class="attr">name</span>: <span class="regexp">/collapse/i</span> &#125;).click();</span><br><span class="line">cy.findByText(children).should(<span class="string">'not.exist'</span>);</span><br></pre></td></tr></table></figure><p>The Cypress commands are declarative and asynchronous. The component might have the internal logic to only re-render after 1000ms when clicking the &quot;Collapse&quot; button - let&#39;s change the component to this:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;button</span><br><span class="line">  aria-expanded=&#123;isExpanded ? <span class="string">'true'</span> : <span class="string">'false'</span>&#125;</span><br><span class="line">  onClick=&#123;() =&gt; setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> setExpanded(!isExpanded), <span class="number">1000</span>)&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p>Instead of immediately updating the DOM, the component now &quot;waits&quot; 1 second. Our Jest test fails.</p><p><img src="/blog/images/test-interface/jest-fails.png" alt="Jest test fails if the component updates asynchronously"></p><p>In fact, the Jest test as written fails even if the component has a delay of just zero milliseconds: <code>setTimeout(..., 0)</code>. The Cypress tests meanwhile are happy as a clam. We can change the component update from synchronous to asynchronous, we can change the delay - it is fine, the Test Runner will retry its commands until the timeout or the DOM updates</p><p><img src="/blog/images/test-interface/expand-collapse.gif" alt="Modifying the component&#39;s delay while the test re-runs"></p><p>The component tests in Cypress are meant to interact with the component using its public API: the props and the DOM without assuming anything about its internal code.</p><h2><span id="login-form">Login form</span></h2><p>Our next example component renders a form with submit button. When the user fills the input fields and clicks the Submit button, the function <code>onSubmit</code> passed from the parent component as a prop is called.</p><figure class="highlight js"><figcaption><span>src/components/Login.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Login</span>(<span class="params">&#123; onSubmit &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [username, setUsername] = React.useState(<span class="string">''</span>);</span><br><span class="line">  <span class="keyword">const</span> [password, setPassword] = React.useState(<span class="string">''</span>);</span><br><span class="line">  <span class="keyword">const</span> handleSubmit = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    onSubmit(&#123; username, password &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;handleSubmit&#125; data-testid=<span class="string">"loginForm"</span>&gt;</span><br><span class="line">      &lt;h3&gt;Login&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">      &lt;label&gt;</span></span><br><span class="line"><span class="regexp">        Username</span></span><br><span class="line"><span class="regexp">        &lt;input</span></span><br><span class="line"><span class="regexp">          name="username"</span></span><br><span class="line"><span class="regexp">          value=&#123;username&#125;</span></span><br><span class="line"><span class="regexp">          onChange=&#123;event =&gt; setUsername(event.target.value)&#125;</span></span><br><span class="line"><span class="regexp">          data-testid="loginForm-username"</span></span><br><span class="line"><span class="regexp">        /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">      &lt;label&gt;</span></span><br><span class="line"><span class="regexp">        Password</span></span><br><span class="line"><span class="regexp">        &lt;input</span></span><br><span class="line"><span class="regexp">          name="password"</span></span><br><span class="line"><span class="regexp">          type="password"</span></span><br><span class="line"><span class="regexp">          value=&#123;password&#125;</span></span><br><span class="line"><span class="regexp">          onChange=&#123;event =&gt; setPassword(event.target.value)&#125;</span></span><br><span class="line"><span class="regexp">          data-testid="loginForm-password"</span></span><br><span class="line"><span class="regexp">        /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button type="submit"&gt;Log in&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>The Cypress test is below; we create a stub function using the built-in <a href="https://on.cypress.io/stub" target="_blank" rel="noopener">cy.stub</a> command. The stubs are reset automatically before each test, thus we don&#39;t need to worry about resetting them ourselves.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/Login.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> Login <span class="keyword">from</span> <span class="string">'../Login'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'form'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'submits username and password using testing-library'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> username = <span class="string">'me'</span>;</span><br><span class="line">    <span class="keyword">const</span> password = <span class="string">'please'</span>;</span><br><span class="line">    <span class="keyword">const</span> onSubmit = cy.stub();</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Login</span> <span class="attr">onSubmit</span>=<span class="string">&#123;onSubmit&#125;</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    cy.findByLabelText(/username/i).type(username);</span></span><br><span class="line"><span class="xml">    cy.findByLabelText(/password/i).type(password);</span></span><br><span class="line"><span class="xml">    cy.findByRole('button', &#123; name: /log in/i &#125;)</span></span><br><span class="line"><span class="xml">      .click()</span></span><br><span class="line"><span class="xml">      .then(() =&gt; &#123;</span></span><br><span class="line"><span class="xml">        // use explicit assertion using sinon-chai matchers</span></span><br><span class="line"><span class="xml">        /* eslint-disable-next-line no-unused-expressions */</span></span><br><span class="line"><span class="xml">        expect(onSubmit).to.be.calledOnce;</span></span><br><span class="line"><span class="xml">        expect(onSubmit).to.be.calledWith(&#123;</span></span><br><span class="line"><span class="xml">          username,</span></span><br><span class="line"><span class="xml">          password,</span></span><br><span class="line"><span class="xml">        &#125;);</span></span><br><span class="line"><span class="xml">      &#125;);</span></span><br><span class="line"><span class="xml">  &#125;);</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/login.gif" alt="Login test"></p><p>The test passes - our component does call the passed <code>onSubmit</code> prop with the password and the username object.</p><p><strong>Tip:</strong> Cypress takes a video of the entire test run and screenshot images on test failures by default, you probably want to keep the sensitive data like the password out of the Command Log. Read the blog post <a href="../keep-passwords-secret-in-e2e-tests/">Keep passwords secret in E2E tests</a> to learn how.</p><h3><span id="bdd-assertions">BDD assertions</span></h3><p>The assertion block using <code>.then</code> that checks the function stub gives away the asynchronous nature of the test.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cy.findByRole(<span class="string">'button'</span>, &#123; <span class="attr">name</span>: <span class="regexp">/log in/i</span> &#125;)</span><br><span class="line">  .click()</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// use explicit assertion using sinon-chai matchers</span></span><br><span class="line">    <span class="comment">/* eslint-disable-next-line no-unused-expressions */</span></span><br><span class="line">    expect(onSubmit).to.be.calledOnce;</span><br><span class="line">    expect(onSubmit).to.be.calledWith(&#123;</span><br><span class="line">      username,</span><br><span class="line">      password,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>We need this <code>.then</code> block to run the synchronous code <code>expect(onSubmit)...</code> assertions <em>after</em> the <code>click()</code> command. We can avoid using <code>.then</code> by giving the stub an alias using <a href="https://on.cypress.io/as" target="_blank" rel="noopener">.as</a> command. Later we can retrieve the stub using this alias and use <a href="https://on.cypress.io/assertions" target="_blank" rel="noopener">BDD assertions</a>. The relevant changes in the test are below:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a stub and save under an alias</span></span><br><span class="line">mount(<span class="xml"><span class="tag">&lt;<span class="name">Login</span> <span class="attr">onSubmit</span>=<span class="string">&#123;cy.stub().as(</span>'<span class="attr">submit</span>')&#125; /&gt;</span>);</span></span><br><span class="line"><span class="xml">...</span></span><br><span class="line"><span class="xml">cy.findByRole('button', &#123;</span></span><br><span class="line"><span class="xml">  name: /log in/i,</span></span><br><span class="line"><span class="xml">&#125;).click();</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">cy.get('@submit')</span></span><br><span class="line"><span class="xml">  .should('be.calledOnce')</span></span><br><span class="line"><span class="xml">  // .and is an alias to .should</span></span><br><span class="line"><span class="xml">  .and('calledWith', &#123; username, password &#125;);</span></span><br></pre></td></tr></table></figure><p>The test passes and you can see the alias in the Command Log when the stub is called.</p><p><img src="/blog/images/test-interface/stub-alias.png" alt="Stub alias shows when the function was called"></p><p>Cypress <a href="https://on.cypress.io/stubs-spies-and-clocks" target="_blank" rel="noopener">stubs and spies</a> are built on top of the powerful <a href="https://sinonjs.org/" target="_blank" rel="noopener">Sinon.js</a> library, and Cypress includes <a href="https://on.cypress.io/assertions#Sinon-Chai" target="_blank" rel="noopener">Sinon-Chai</a> assertion matchers. These assertions help you confirm the methods are called precisely as intended.</p><h3><span id="selector-playground">Selector Playground</span></h3><p>When the test typed the username and the password, we used <code>@testing-library/cypress</code> command <code>findByLabelText</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.findByLabelText(<span class="regexp">/username/i</span>).type(username);</span><br><span class="line">cy.findByLabelText(<span class="regexp">/password/i</span>).type(password);</span><br></pre></td></tr></table></figure><p>The <code>Login</code> component does have <a href="https://on.cypress.io/best-practices#Selecting-Elements" target="_blank" rel="noopener">good testing attributes</a> on those input fields though:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">"username"</span> value=&#123;username&#125;</span><br><span class="line">  onChange=&#123;event =&gt; setUsername(event.target.value)&#125;</span><br><span class="line">  data-testid=<span class="string">"loginForm-username"</span></span><br><span class="line">/&gt;</span><br><span class="line">&lt;input name=<span class="string">"password"</span> type=<span class="string">"password"</span> value=&#123;password&#125;</span><br><span class="line">  onChange=&#123;event =&gt; setPassword(event.target.value)&#125;</span><br><span class="line">  data-testid=<span class="string">"loginForm-password"</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure><p>Thus we can let Cypress pick the selector for us using <a href="https://on.cypress.io/selector-playground" target="_blank" rel="noopener">Selector Playground</a>. It will inspect every DOM element we hover over to suggest the most precise Cypress built-in command to select that element. In our case, the Selector Playground suggest using the <code>data-testid</code> attribute.</p><p><img src="/blog/images/test-interface/selector-playground.gif" alt="Selector Playground suggesting command for selecting the username input field"></p><p>The copied command <code>cy.get(&#39;[data-testid=loginForm-username]&#39;)</code> can be pasted directly into the spec file, and then we need to add <code>.type()</code> command.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'[data-testid=loginForm-username]'</span>).type(username)</span><br></pre></td></tr></table></figure><p>Picking selector commands using the Selector Playground is a nifty little tool for quickly writing tests.</p><h2><span id="network-requests">Network requests</span></h2><h3><span id="pizza-toppings">Pizza toppings</span></h3><p>The final component we are going to test renders the list of pizza toppings. If the list of topics is passed via a prop, the test is simple.</p><figure class="highlight js"><figcaption><span>src/components/Pizza.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Pizza</span>(<span class="params">&#123; ingredients &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h3&gt;Pizza&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ul&gt;</span></span><br><span class="line"><span class="regexp">        &#123;ingredients.map(ingredient =&gt; (</span></span><br><span class="line"><span class="regexp">          &lt;li key=&#123;ingredient&#125;&gt;&#123;ingredient&#125;&lt;/</span>li&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line">      &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>src/components/__tests__/Pizza.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span>;</span><br><span class="line"><span class="keyword">import</span> Pizza <span class="keyword">from</span> <span class="string">'../Pizza'</span>;</span><br><span class="line"></span><br><span class="line">it(<span class="string">'contains all ingredients'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> ingredients = [<span class="string">'bacon'</span>, <span class="string">'tomato'</span>, <span class="string">'mozzarella'</span>, <span class="string">'pineapples'</span>];</span><br><span class="line">  <span class="comment">// component Pizza shows the passed list of toppings</span></span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">Pizza</span> <span class="attr">ingredients</span>=<span class="string">&#123;ingredients&#125;</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  for (const ingredient of ingredients) &#123;</span></span><br><span class="line"><span class="xml">    cy.findByText(ingredient);</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/pizza.gif" alt="Verifying every topping is rendered"></p><h3><span id="remotepizza-with-ajax-call">RemotePizza with Ajax call</span></h3><p>But what if the component fetches the list of toppings from a remote REST API? Let&#39;s look at the <code>RemotePizza</code> component</p><figure class="highlight js"><figcaption><span>src/components/RemotePizza.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fetchIngredients <span class="keyword">as</span> defaultFetchIngredients &#125; <span class="keyword">from</span> <span class="string">'../services'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">RemotePizza</span>(<span class="params">&#123; fetchIngredients &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [ingredients, setIngredients] = React.useState([]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleCook = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchIngredients().then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      setIngredients(response.args.ingredients);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h3&gt;Pizza&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;handleCook&#125;&gt;Cook&lt;/</span>button&gt;</span><br><span class="line">      &#123;ingredients.length &gt; <span class="number">0</span> &amp;&amp; (</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;ingredients.map(<span class="function">(<span class="params">ingredient</span>) =&gt;</span> (</span><br><span class="line">            &lt;li key=&#123;ingredient&#125;&gt;&#123;ingredient&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">          ))&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/u</span>l&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">RemotePizza.defaultProps = &#123;</span></span><br><span class="line"><span class="regexp">  fetchIngredients: (url) =&gt; defaultFetchIngredients(url),</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure><p>Let&#39;s write component tests confirming the fetched pizza toppings are displayed correctly. We can take several approaches to this.</p><h3><span id="1-dependency-injection">1. Dependency injection</span></h3><p>The component allows passing the fetcher function via a prop. Thus we can pass a stub like before</p><figure class="highlight js"><figcaption><span>src/components/__tests__/RemotePizza.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> RemotePizza <span class="keyword">from</span> <span class="string">'../RemotePizza'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ingredients = [<span class="string">'bacon'</span>, <span class="string">'tomato'</span>, <span class="string">'mozzarella'</span>, <span class="string">'pineapples'</span>];</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'RemotePizza'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'stubs via prop (di)'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> fetchIngredients = cy.stub().resolves(&#123; <span class="attr">args</span>: &#123; ingredients &#125; &#125;);</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">RemotePizza</span> <span class="attr">fetchIngredients</span>=<span class="string">&#123;fetchIngredients&#125;</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">    cy.contains('button', /cook/i).click();</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    for (const ingredient of ingredients) &#123;</span></span><br><span class="line"><span class="xml">      cy.contains(ingredient);</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  &#125;);</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/remote-pizza-di.png" alt="Passing fetch stub as a prop"></p><h3><span id="2-dependency-injection-with-delay">2. Dependency injection with delay</span></h3><p>How does our component behave when the remote server responds after a delay? Let&#39;s pass a stub that resolves after one second delay using the <a href="http://bluebirdjs.com/docs/api-reference.html" target="_blank" rel="noopener">Bluebird Promise</a> library <a href="https://on.cypress.io/bundled-tools" target="_blank" rel="noopener">bundled with Cypress</a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'stubs via prop (di with delay)'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> fetchIngredients = cy</span><br><span class="line">    .stub()</span><br><span class="line">    <span class="comment">// resolves after 1 second delay</span></span><br><span class="line">    .resolves(</span><br><span class="line">      Cypress.Promise.resolve(&#123; <span class="attr">args</span>: &#123; ingredients &#125; &#125;).delay(<span class="number">1000</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">RemotePizza</span> <span class="attr">fetchIngredients</span>=<span class="string">&#123;fetchIngredients&#125;</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.contains('button', /cook/i).click();</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  for (const ingredient of ingredients) &#123;</span></span><br><span class="line"><span class="xml">    cy.contains(ingredient);</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p>The test passes just fine - but it shows the need for some kind of loading indicator. Our users would not know what is happening while the toppings are being fetched.</p><p><img src="/blog/images/test-interface/pizza-delay.gif" alt="The component shows nothing while the toppings are being fetched"></p><h3><span id="3-stubbing-the-default-property">3. Stubbing the default property</span></h3><p>We can &quot;reach&quot; into the component and replace the default fetch method from our test using the <code>defaultProps</code> object exposed by the component.</p><figure class="highlight js"><figcaption><span>src/components/RemotePizza.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RemotePizza.defaultProps = &#123;</span><br><span class="line">  fetchIngredients: <span class="function">(<span class="params">url</span>) =&gt;</span> defaultFetchIngredients(url),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Our test stubs the method <code>RemotePizza.defaultProps</code></p><figure class="highlight js"><figcaption><span>src/components/__tests__/RemotePizza.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'mocks method via defaultProps'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(RemotePizza.defaultProps, <span class="string">'fetchIngredients'</span>).resolves(&#123;</span><br><span class="line">    args: &#123; ingredients &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">RemotePizza</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.contains('button', /cook/i).click();</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  for (const ingredient of ingredients) &#123;</span></span><br><span class="line"><span class="xml">    cy.contains(ingredient);</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/stub-default.png" alt="Stubbing a method in the default props object"></p><h3><span id="4-mocking-named-imports">4. Mocking named imports</span></h3><p>Our <code>RemotePizza</code> component imports the default fetcher from the services module.</p><figure class="highlight js"><figcaption><span>src/components/RemotePizza.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fetchIngredients <span class="keyword">as</span> defaultFetchIngredients &#125; <span class="keyword">from</span> <span class="string">'../services'</span>;</span><br></pre></td></tr></table></figure><p>The Jest test mocked the exported function <code>fetchIngredients</code>.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/RemotePizza_jestmock.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fetchIngredients &#125; <span class="keyword">from</span> <span class="string">'../../services'</span>;</span><br><span class="line"></span><br><span class="line">jest.mock(<span class="string">'../../services'</span>);</span><br><span class="line"></span><br><span class="line">afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  fetchIngredients.mockReset();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// during test</span></span><br><span class="line">fetchIngredients.mockResolvedValue(&#123; <span class="attr">args</span>: &#123; ingredients &#125; &#125;);</span><br></pre></td></tr></table></figure><p>In Cypress we can mock the <code>fetchIngredients</code> import using the included Sinon <a href="https://on.cypress.io/stub" target="_blank" rel="noopener">cy.stub</a> just like before.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/RemotePizza.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prepare for import mocking</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> services <span class="keyword">from</span> <span class="string">'../../services'</span>;</span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks named import from services'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(services, <span class="string">'fetchIngredients'</span>).resolves(&#123; <span class="attr">args</span>: &#123; ingredients &#125; &#125;);</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">RemotePizza</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.contains('button', /cook/i).click();</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  for (const ingredient of ingredients) &#123;</span></span><br><span class="line"><span class="xml">    cy.contains(ingredient);</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p>To mock a named ES6 module import, we import the entire module using wildcard syntax, which gives us an object. Then we stub the method of that object, just like we did when stubbing method <code>fetchIngredients</code> of the object <code>RemotePizza.defaultProps</code>.</p><p><img src="/blog/images/test-interface/stub-import.png" alt="Stubbing named ES6 module import"></p><p>Note that all Cypress spies and stubs created during the test are <a href="https://on.cypress.io/stubs-spies-and-clocks" target="_blank" rel="noopener">reset automatically</a>, thus you do not have to reset them manually.</p><h3><span id="5-stubbing-network">5. Stubbing network</span></h3><p>The above tactics for stubbing the component&#39;s method all reached deep into its implementation. With Cypress&#39; <a href="https://on.cypress.io/network-requests" target="_blank" rel="noopener">built-in network control</a> we can avoid testing the component&#39;s internals and stub the outgoing Ajax request instead.</p><figure class="highlight js"><figcaption><span>src/components/__tests__/RemotePizza.cy-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'download ingredients from internets (network mock)'</span>, () =&gt; &#123;</span><br><span class="line">  cy.server();</span><br><span class="line">  <span class="comment">// using https://on.cypress.io/route</span></span><br><span class="line">  <span class="comment">// to stub every request to particular URL a response</span></span><br><span class="line">  cy.route(<span class="string">'https://httpbin.org/anything*'</span>, &#123; <span class="attr">args</span>: &#123; ingredients &#125; &#125;).as(</span><br><span class="line">    <span class="string">'pizza'</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">RemotePizza</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">  cy.contains('button', /cook/i).click();</span></span><br><span class="line"><span class="xml">  cy.wait('@pizza'); // make sure the network stub was used</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  for (const ingredient of ingredients) &#123;</span></span><br><span class="line"><span class="xml">    cy.contains(ingredient);</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure><p>The test passes and we can see the Ajax request information in the ROUTES table of the Command Log.</p><p><img src="/blog/images/test-interface/stub-ajax.png" alt="Stubbing Ajax network request"></p><p>We can also add a delay to the network response to simulate a slow server response:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cy.route(&#123;</span><br><span class="line">  url: <span class="string">'https://httpbin.org/anything*'</span>,</span><br><span class="line">  response: &#123; <span class="attr">args</span>: &#123; ingredients &#125; &#125;,</span><br><span class="line">  delay: <span class="number">1000</span>,</span><br><span class="line">&#125;).as(<span class="string">'pizza'</span>);</span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-interface/stub-ajax-delay.gif" alt="Stubbing Ajax network request with delay of 1 second"></p><p>Using <a href="https://on.cypress.io/route" target="_blank" rel="noopener">cy.route</a> we can spy or stub network requests made by the component with ease.</p><h2><span id="conclusion">Conclusion</span></h2><ul><li>If you have existing Jest + React Testing Library tests you can quickly port them to run as Cypress component tests using <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> + <a href="https://testing-library.com/docs/cypress-testing-library/intro" target="_blank" rel="noopener">@testing-library/cypress</a>. The commands are identical.</li><li>Cypress <a href="https://on.cypress.io/test-runner" target="_blank" rel="noopener">Test Runner</a> offers advantages over running tests in the terminal<ul><li>full browser with DevTools: Electron, Chrome, Firefox, Edge instead of its emulation</li><li>Command Log with time-traveling debugger</li><li>Selector Playground</li><li>screenshots on failure</li><li>videos of the test runs on the CI server</li></ul></li><li>Cypress test syntax is declarative, and every command runs asynchronously - you can change the implementation of your components and the tests still work correctly using the built-in automatic retries</li><li>You can control the behavior of the component by passing properties when mounting it, stubbing exposed method, mocking module imports and stubbing network calls</li></ul><p>You can fine the source code and the spec files described in this blog post in repo <a href="https://github.com/bahmutov/rtl-article-2019" target="_blank" rel="noopener">rtl-article-2019</a>.</p><h2><span id="relate-blog-posts">Relate blog posts</span></h2><ul><li><a href="../my-vision-for-component-tests/">My Vision for Component Tests in Cypress</a></li><li><a href="https://itnext.io/unit-testing-react-components-with-cypress-4d4cf8cd59a0" target="_blank" rel="noopener">Unit Testing React components with Cypress</a></li><li><a href="https://dev.to/bahmutov/test-react-component-with-cypress-react-unit-test-example-4d99" target="_blank" rel="noopener">Test React Component with cypress-react-unit-test Example</a></li><li><a href="../tic-tac-toe-component-tests/">Tic-Tac-Toe Component Tests</a></li><li><a href="https://medium.com/@bahmutov/using-env-and-env-test-from-react-component-tests-c11aa2040bc8" target="_blank" rel="noopener">Using .env and .env.test from React component tests</a></li><li><a href="../open-source-visual-testing-of-components/">Visual testing for React components using open source tools</a></li><li><a href="https://dev.to/bahmutov/12-recipes-for-testing-react-applications-using-cypress-react-unit-test-46g6" target="_blank" rel="noopener">12 Recipes for testing React applications using cypress-react-unit-test</a> (compare to <a href="https://dev.to/jooforja/12-recipes-for-testing-react-applications-using-testing-library-1bh2#portal" target="_blank" rel="noopener">12 Recipes for testing React applications using Testing Library</a>)</li><li><a href="https://medium.com/swlh/cypress-unit-testing-react-components-with-typescript-77b38e5043b3" target="_blank" rel="noopener">Cypress Unit Testing React Components With TypeScript</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#background&quot;&gt;Background&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-setup&quot;&gt;The setup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#hello-world&quot;&gt;Hello
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Why Cypress?</title>
    <link href="https://glebbahmutov.com/blog/why-cypress/"/>
    <id>https://glebbahmutov.com/blog/why-cypress/</id>
    <published>2020-07-22T04:00:00.000Z</published>
    <updated>2020-07-22T15:06:50.439Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="doing-e2e-tests-is-hard-what39s-the-point-of-even-using-cypress">Doing E2E tests is hard. What&#39;s the point of even using Cypress</span></h2><p>Yes, writing end-to-end tests is hard ... because the existing tools were built for testing static sites and could not deal well with dynamic web apps. Cypress specifically was designed to solve the testing challenges presented by modern dynamic web application, and we think Cypress solves them very well.</p><p>Read the <a href="https://on.cypress.io/key-differences" target="_blank" rel="noopener">Key Differences</a> section of our documentation to understand how Cypress works, and how specifically it fits the modern web development. As far as being difficult: our users rave how writing end-to-end tests using Cypress is ... easy to learn and actually something they love!</p><p><img src="/blog/images/why-cypress/tweets2.png" alt="People love writing tests using Cypress"></p><p><img src="/blog/images/why-cypress/tweets3.png" alt="More people love writing tests using Cypress"></p><p>Search Twitter using keyword &quot;cypress.io&quot; <a href="https://twitter.com/search?q=cypress.io&amp;src=typed_query&amp;f=live" target="_blank" rel="noopener">here</a> and see for yourself what people are saying.</p><h2><span id="i-can-already-write-these-types-of-tests-using-jest-and-enzyme">I can already write these types of tests using Jest and Enzyme</span></h2><p>No, you cannot.</p><p>With Cypress you get a full real browser (Electron, Chrome, Edge, Firefox) to run your tests, with all browser APIs and a way to access the underlying machinery. This is the environment your application code will execute when the users run it.</p><p>With Jest / Enzyme / Ava / Mocha / Tape / etc you can write unit tests that execute inside JavaScript DOM emulation, output results to the terminal, have some spotty access to browser API emulations, and are nothing like the real world. Even if you jump through hoops and run your Jest / ... / X tests in a real browser using something like Karma to control the browser, then you still are limited to the component tests and not running the full end-to-end tests, you are still only exercising pieces of code.</p><p>With Cypress the setup is a single command, and you are good to go:</p><ul><li>install Cypress with <code>npm i -D cypress</code></li><li>run Cypress with <code>npx cypress open</code></li><li>start writing tests</li></ul><p>That&#39;s it. You get the benefits of running inside a real browser, exercising your full web application and the servers, full DevTools, etc.</p><p>If you want to compare apples to apples, you probably want to compare <em>component tests</em> that run in Cypress with the unit tests you write in Jest / Enzyme. Cypress supports the component tests too, and <a href="../my-vision-for-component-tests/">here is my vision for them</a>. And here is what people think about Cypress tests vs Jest tests</p><p><img src="/blog/images/why-cypress/component-test.png" alt="A person has compared Cypress component test to Jest test"></p><h2><span id="full-e2e-tests-are-slow">Full E2E tests are slow</span></h2><p>The full end-to-end tests are as fast as your application is. Often Cypress is <a href="https://www.cypress.io/blog/2018/02/05/when-can-the-test-start/" target="_blank" rel="noopener">faster than your application</a> and you have to slow it down. But I think personally the speed of an individual test is a misleading metric you should not optimize for. You should instead optimize for development speed and debugging speed.</p><h3><span id="development-speed">Development speed</span></h3><p>How fast can you write useful tests that exercise the full system and catch all potential sources of errors: logical code errors, configuration errors, deployment errors, visual errors, accessability errors, etc? Cypress users spend only minutes writing tests that go through the user stories, <a href="https://on.cypress.io/code-coverage" target="_blank" rel="noopener">covering a lot of code</a> with every single E2E test and getting the confidence the entire system works.</p><h3><span id="debugging-speed">Debugging speed</span></h3><p>If there is a test failure, how fast can you determine the source of the error and fix it? With Cypress tests running on CI you have screenshots and videos, stack traces, history of test runs - you can pretty much compare the failed run to the last successful run to <a href="https://www.cypress.io/blog/2020/06/25/when-can-the-test-log-out/" target="_blank" rel="noopener">understand why the test has failed</a>.</p><p>If the test fails while you are running Cypress tests locally using <code>cypress open</code>, you have so many options for <a href="https://on.cypress.io/debugging" target="_blank" rel="noopener">debugging the test</a>, and you have the full browser DevTools at your disposal. You have time traveling debugger, <a href="https://www.cypress.io/blog/2020/05/20/faster-debugging-with-test-failure-code-frames-in-cypress-4-6/" target="_blank" rel="noopener">code frames</a>, custom commands, etc.</p><h3><span id="continuous-integration-speed">Continuous Integration speed</span></h3><p>I agree that CI tests should finish quickly. The way to achieve short total CI time is to run end-to-end tests in parallel. You can use such <a href="https://on.cypress.io/parallelization" target="_blank" rel="noopener">parallelization</a> via Cypress Dashboard, <a href="https://github.com/kensho/multi-cypress" target="_blank" rel="noopener">roll your own</a>, or use CI-specific method of splitting tests. In &quot;normal&quot; CI runs, with dependencies cached, I find the E2E test run time under 3-5 minutes acceptable. And if I need to speed them up, with parallelization I can spin more CI boxes to cut the time further.</p><h2><span id="more-info">More info</span></h2><p>Still skeptical? I understand. Well, try it yourself. Cypress is free and open source and has excellent documentation. Try writing a test, and see if you change your mind.</p><ul><li><a href="../should-i-start-with-cypress/">Should I start with Cypress?</a></li><li><a href="https://on.cypress.io/writing-your-first-test" target="_blank" rel="noopener">Writing your first test</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2&gt;&lt;span id=&quot;doing-e2e-tests-is-hard-what39s-the-point-of-even-using-cypress&quot;&gt;Doing E2E tests is hard. What&amp;#39;s the point of even using C
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>How to Testify About Environment at a Public Hearing</title>
    <link href="https://glebbahmutov.com/blog/how-to-testify/"/>
    <id>https://glebbahmutov.com/blog/how-to-testify/</id>
    <published>2020-07-11T04:00:00.000Z</published>
    <updated>2020-07-11T20:33:19.495Z</updated>
    
    <content type="html"><![CDATA[<p>Recently I have testified at several meetings in favor of stronger laws and policies to address <a href="../climate-emergency/">the climate catastrophe</a>. I believe the more people testify in favor, the more vocal support for these policies will be, and the sooner we will get these policies passed. Only an overwhelming number of testimonies can overwhelm an inertia to keep the status quo, and we don&#39;t have time to keep the things the way they are now - the planet <a href="https://medium.com/@JKSteinberger/cogs-in-the-climate-machine-167cf16750dd" target="_blank" rel="noopener">is dying</a>.</p><p>If you care about the planet, your life, and the generation after us, you have to say so. Here is how to testify during a hearing.</p><ol><li><p>Find about the hearings. I usually get these announcements from a local environmental organization like <a href="https://350mass.org/" target="_blank" rel="noopener">350mass.org</a>. Join one or several organizations from the list below and will know about things you can do each month</p><ul><li><a href="https://350mass.org/" target="_blank" rel="noopener">350mass.org</a></li><li><a href="https://citizensclimatelobby.org/" target="_blank" rel="noopener">citizensclimatelobby.org</a></li><li><a href="https://www.sunrisemovement.org/" target="_blank" rel="noopener">sunrisemovement.org</a></li><li><a href="https://www.sierraclub.org/" target="_blank" rel="noopener">sierraclub.org</a></li></ul></li><li><p>Research the subject of the hearing. Attend a webinar, read the relevant info online, etc. Usually, the organization announcing the public hearing will have this information collected in one place. For example, before testifying about offshore wind power I have watched the informational webinar and read the info online at <a href="https://www.boem.gov/Vineyard-Wind-SEIS-Virtual-Meeting" target="_blank" rel="noopener">https://www.boem.gov/Vineyard-Wind-SEIS-Virtual-Meeting</a>.</p></li><li><p>Register to speak at the hearing. The hearings are conducted online because of the pandemic, so please register to attend / speak online.</p></li><li><p>Find out the time limit, most hearings allow up to 3 - 5 minutes per testimony.</p></li><li><p>Write your testimony down. I prefer writing how a mixture of personal story and scientific facts. I usually write 3-4 short paragraphs total, see examples below.</p></li><li><p>Practice reading your testimony a couple of times to get the timing right.</p></li><li><p>Join the hearing at the scheduled date, sometimes you need to use a special link so you are in the speaking queue.</p></li><li><p>Read your testimony when called.</p></li><li><p>Send the written testimony if the hearing allows submitting it in writing too!</p></li><li><p>Share your testimony with friends, on social media, and on your website, if you have one. Seeing you speak up will prompt more people to raise their voices too.</p></li></ol><p>That&#39;s it - it is a lot less scarry that you might think, and speaking up is very important.</p><h2><span id="questions-and-answers">Questions and answers</span></h2><ul><li><em>Isn&#39;t my testimony useless, don&#39;t they listen to lobbyists only?</em></li></ul><p>Yes, money talks. But money has to overcome obstacles like your testimony, and the more obstacles there are, the more money you need to lobby. Thus at some threshold, the vocal support wins over the lobbyists. Especially at the local and state levels, some policies do NOT clash head to head with monied opposition. For example, expanding the safer cycling streets in your town needs your vocal support to overcome the inertia, not moneyed lobbying.</p><ul><li><em>What if people judge me, or harass me? I do not want my name made public</em></li></ul><p>If you want your government to act, you have to take a stand and say so publicly. You need to at least state your name and where you live to testify, from what I have seen. A good thing about testifying in favor of environment causes, is that it actually looks good for you. Who doesn&#39;t want to save the planet? Who doesn&#39;t like trees or locally-grown organic food?</p><ul><li><em>Can I testify if I am not an expert?</em></li></ul><p>You are testifying about how you think the proposal would affect <em>you and people around you</em>, in my opinion. Research the proposal (item #2 on the list) and you will be fine. It will not be embarrassing, I guarantee it. Listen to a couple of hearings - you will see people from all walks of life speaking about the subject as they perceive it.</p><p>What is more embarrassing in my opinion are paid-for shills for moneyed interests. I have seen &quot;think tanks&quot; and politicians spew numbers in support of their positions (usually conveniently against doing anything about the climate crisis), and these numbers were for sure pulled out of their asses, I thought. You will do just fine.</p><h2><span id="examples">Examples</span></h2><p>Below are a few testimonies I have given recently. I have changed the text to remove my personal information.</p><ul><li><a href="../gas-ban-testimony/">My testimony in support of banning gas infrastructure in new construction in Cambridge, MA</a></li></ul><h3><span id="safe-bicycle-network-plan-in-cambridge">Safe bicycle network plan in Cambridge</span></h3><p>I am Gleb Bahmutov from &quot;street name&quot; and I ride my bicycle from Huron avenue to Central square to work. My wife rides her electrical scooter to work in &quot;place name&quot; and my son rides his bicycle to &quot;school name&quot; and to &quot;park name&quot;.</p><p>Cycling is the most convenient and fastest way to get around Cambridge, so why more people are not doing it? In my conversation with my family and with other people, the number one concern is safety. Nothing else matters it seems, but being afraid of getting hit by a car is what stops people from taking advantage of this transportation mode.</p><p>During the Corona shutdown we felt so much safer riding around, it was unbelievable. Now the cars are back, and I am afraid for my son&#39;s life again. The recent shared street initiative helps - I love riding Garden and Harvard streets, and I see many more people now with kids riding now. But we got to do better. And we got to protect people on many more streets.</p><p>Which brings me to the timeframe. Protecting more streets is nice. But it takes only a second for a car to suddenly turn without looking and to hit a bicyclist. So why does it take 5 years to offer these basic safety protections? Will this ordinance have teeth and be implemented month by month? Or will we wait another five years while nothing would be done?</p><p>Thank you.</p><h3><span id="building-offshore-wind-farm-of-the-coast-of-massachusetts">Building offshore wind farm of the coast of Massachusetts</span></h3><p>Hello, this is Gleb Bahmutov B-A-H-M-U-T-O-V from Boston, thank you for taking my call.</p><p>I am fully 100% in favor of offshore wind energy. If we want to avoid catastrophic climate collapse, we must stop burning fossil fuels today. Offshore wind gives us an immediate and technologically possible solution.</p><p>But I want to quickly address concerns about fishing. Some people say &quot;what about fishing, will all these new windmills cut into the fishing area, etc&quot;. According to  scientists, the ocean is currently doing two things for us in regards to the climate. First, because of the water&#39;s properties, the Earth&#39;s oceans absorb 90-95% of the heat we accumulate, saving us, the land dwellers from being fried from excessive heat. Every second the ocean&#39;s waters receive energy equivalent of 3 to 5 atomic bombs. Every second.</p><p>Second, the ocean&#39;s water dissolves a lot of the atmospheric carbon, &quot;burying&quot; it so to speak. Only this carbon is still there, slowly turning the water acidic. According to science the Great Barrier reef in Australia is dying due to warmer, acidic waters that literally dissolve marine microorganisms. Within 10 years this reef might die completely taking about 1/3 of all marine species with it.</p><p>The coast of New England is no different. Warmer waters are already affecting the marine life, and if this process continues, our entire fishing ecosystem might collapse. It is not the question of &quot;how will offshore wind affect the fishing industry?&quot;. The question we have to ask ourselves is &quot;will we build the offshore wind fast enough to prevent the marine life collapse going on right now?&quot;</p><p>Thank you.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently I have testified at several meetings in favor of stronger laws and policies to address &lt;a href=&quot;../climate-emergency/&quot;&gt;the clima
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Write Your First Vue Component Test</title>
    <link href="https://glebbahmutov.com/blog/first-vue-component-test/"/>
    <id>https://glebbahmutov.com/blog/first-vue-component-test/</id>
    <published>2020-07-02T04:00:00.000Z</published>
    <updated>2020-07-02T16:44:07.192Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#application">Application</a></li><li><a href="#end-to-end-tests">End-to-end tests</a></li><li><a href="#components">Components</a></li><li><a href="#component-tests">Component tests</a></li><li><a href="#app-component">App component</a></li><li><a href="#next-steps">Next steps</a></li></ul><!-- tocstop --><p>Let&#39;s create a new Vue application and write a component test using <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress</a> + <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> combo. We will use <a href="https://cli.vuejs.org/" target="_blank" rel="noopener">Vue CLI v3</a> to scaffold our application and you can find the complete application in <a href="https://github.com/bahmutov/vue-component-test-example" target="_blank" rel="noopener">bahmutov/vue-component-test-example</a> repository.</p><h2><span id="application">Application</span></h2><ol><li>First install the Vue CLI globally</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://cli.vuejs.org/</span><br></pre></td></tr></table></figure><ol start="2"><li>Create a new application</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vue create vue-component-test-example</span><br><span class="line">Vue CLI v4.4.6</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>I picked the &quot;default&quot; option to use Babel and ESLint. The folder contains the scaffolded files</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls -a</span><br><span class="line">..gitignorenode_modulespublic</span><br><span class="line">..README.mdpackage-lock.jsonsrc</span><br><span class="line">.gitbabel.config.jspackage.json</span><br></pre></td></tr></table></figure><ol start="3"><li>We can start the application and see it run at <code>localhost:8080</code> url</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm run serve</span><br></pre></td></tr></table></figure><p><img src="/blog/images/vue-unit/vue-app.png" alt="The application running at localhost:8080"></p><h2><span id="end-to-end-tests">End-to-end tests</span></h2><p>We definitely recommend ensuring your web application&#39;s quality by writing end-to-end tests. With <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress</a> E2E tests are:</p><ul><li>fast to write and run</li><li>effective at covering lots of code</li><li>can perform visual testing via 3rd-party plugins</li></ul><p>You can write E2E tests for Vue applications by using the official <a href="https://cli.vuejs.org/core-plugins/e2e-cypress.html" target="_blank" rel="noopener">@vue/cli-plugin-e2e-cypress</a> plugin. And I suggest reading one of the many blog posts on this topic, like <a href="https://medium.com/js-dojo/end-to-end-testing-a-vuejs-hackernews-clone-23b9415fd5c5" target="_blank" rel="noopener">End-To-End Testing A VueJS HackerNews Clone</a>. In this blog post I want to show how to move <a href="https://www.youtube.com/watch?v=5FnalKRjpZk&amp;amp=&amp;t=0s&amp;amp=&amp;index=5" target="_blank" rel="noopener">down one level of the testing pyramid</a> to perform <em>component testing</em>.</p><h2><span id="components">Components</span></h2><p>In our current application the <code>App.vue</code> uses <code>HelloWorld.vue</code> component.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;app&quot;&gt;</span><br><span class="line">    &lt;img alt=&quot;Vue logo&quot; src=&quot;./assets/logo.png&quot;&gt;</span><br><span class="line">    &lt;HelloWorld msg=&quot;Welcome to Your Vue.js App&quot;/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import HelloWorld from &apos;./components/HelloWorld.vue&apos;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &apos;App&apos;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    HelloWorld</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>The logic inside a component might become pretty complex. To guarantee the component still works as expected as the project becomes more complex, we need tests - and the closer the tests are to the way our users are going to use in the browser, the better. In this blog post I will show how to write realistic component tests that run in a true browser using <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a>.</p><h2><span id="component-tests">Component tests</span></h2><p>Let&#39;s update our project to be able to write Cypress component tests.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vue add cypress-experimental</span></span><br><span class="line"></span><br><span class="line">📦  Installing vue-cli-plugin-cypress-experimental...</span><br><span class="line"></span><br><span class="line">+ vue-cli-plugin-cypress-experimental@1.0.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>The <a href="https://github.com/JessicaSachs/vue-cli-plugin-cypress-experimental" target="_blank" rel="noopener">vue-cli-plugin-cypress-experimental</a> scaffolds an example component test and adds <a href="https://github.com/cypress-io/cypress" target="_blank" rel="noopener">Cypress</a> and <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> dev dependencies.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm ls cypress cypress-vue-unit-test</span></span><br><span class="line">vue-component-test-example@0.1.0 /Users/gleb/git/vue-component-test-example</span><br><span class="line">├── cypress@4.9.0</span><br><span class="line">└── cypress-vue-unit-test@3.0.0</span><br></pre></td></tr></table></figure><p>You can see the component testing enabled in <code>cypress.json</code> file</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"experimentalComponentTesting"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"componentFolder"</span>: <span class="string">"tests/components"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s write a component test for <code>HelloWorld.vue</code> component to make sure it correctly renders the property <code>msg</code>.</p><figure class="highlight js"><figcaption><span>tests/components/HelloWorld.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="cypress" /&gt;</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-vue-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> HelloWorld <span class="keyword">from</span> <span class="string">'../../src/components/HelloWorld.vue'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'HelloWorld'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'Works awesomely'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// mount command comes from</span></span><br><span class="line">    <span class="comment">// https://github.com/bahmutov/cypress-vue-unit-test</span></span><br><span class="line">    mount(HelloWorld, &#123; <span class="attr">propsData</span>: &#123;<span class="attr">msg</span>: <span class="string">'Hello, Cypress!'</span>&#125; &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now we can use any Cypress command to interact with the component</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/api</span></span><br><span class="line">    cy.contains(<span class="string">'h1'</span>, <span class="string">'Hello, Cypress!'</span>).should(<span class="string">'be.visible'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>In the test we import the component and mount it using a function from <code>cypress-vue-unit-test</code>. We pass props using <code>propsData</code> option and then the component becomes a full-fledged web application! Let&#39;s see this in action.</p><p>We can see the new script <code>test:components</code> added by <a href="https://github.com/JessicaSachs/vue-cli-plugin-cypress-experimental" target="_blank" rel="noopener">vue-cli-plugin-cypress-experimental</a>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run</span></span><br><span class="line">Scripts available in vue-component-test-example via `npm run-script`:</span><br><span class="line">  serve</span><br><span class="line">    vue-cli-service serve</span><br><span class="line">  build</span><br><span class="line">    vue-cli-service build</span><br><span class="line">  lint</span><br><span class="line">    vue-cli-service lint</span><br><span class="line">  test:components</span><br><span class="line">    vue-cli-service test:components</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm run <span class="built_in">test</span>:components</span></span><br></pre></td></tr></table></figure><p>With the above command we have started Cypress. We see a couple of component spec files in the window that opens</p><p><img src="/blog/images/vue-unit/desktop-gui.png" alt="The component tests list"></p><p><strong>Tip:</strong> use browser drop down to select a different browser amongst the browsers detected on your machine.</p><p><img src="/blog/images/vue-unit/desktop-gui-browsers.png" alt="Cypress allows to run tests using any detected supported browser"></p><p>Click on &quot;HelloWorld.spec.js&quot; file to start the test. The test shows the component running inside the browser.</p><p><img src="/blog/images/vue-unit/passing-test.png" alt="Passing HelloWorld.spec test"></p><p>We can confirm the <code>msg</code> prop was rendered in the right H1 element by hovering over the command in the Command Log on the left. The found element is highlighted in the DOM snapshot on the right.</p><p><img src="/blog/images/vue-unit/contains.png" alt="The cy.contains command finds the expected element and text"></p><p>As you edit the spec file and save it, the tests automatically re-run.</p><p><img src="/blog/images/vue-unit/update-test.gif" alt="Re-running the test on spec file save"></p><p>In fact, if you change the spec or any file it imports, even indirectly, the tests will re-run. For example, let&#39;s change <code>HelloWorld.vue</code> to show the message in H2 element instead of H1.</p><p><img src="/blog/images/vue-unit/change-h2.gif" alt="Changing the component and updating the test"></p><p>In the movie above we jumped to the failing test command using <a href="https://www.cypress.io/blog/2020/05/20/faster-debugging-with-test-failure-code-frames-in-cypress-4-6/" target="_blank" rel="noopener">Cypress Test Error Frames</a>. Clicking on the error location opens my text editor at the right command.</p><h2><span id="app-component">App component</span></h2><p>Everything in a modern Vue application is built out of components. The <code>src/App.vue</code> is a component too! Let&#39;s write a test to ensure there are essential links.</p><figure class="highlight js"><figcaption><span>tests/components/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="cypress" /&gt;</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-vue-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'../../src/App.vue'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, () =&gt; &#123;</span><br><span class="line">    mount(App)</span><br><span class="line">    cy.contains(<span class="string">'h3'</span>, <span class="string">'Essential Links'</span>)</span><br><span class="line">      .next().find(<span class="string">'li'</span>).should(<span class="string">'have.length'</span>, <span class="number">5</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The correct links are found by first finding the <code>h3</code> element, then its <a href="https://on.cypress.io/next" target="_blank" rel="noopener">next sibling</a> and then finding all <code>li</code> elements under it.</p><p><img src="/blog/images/vue-unit/app-test.png" alt="App.vue component test"></p><h2><span id="next-steps">Next steps</span></h2><p>We are very excited about component tests running inside a real browser with full <a href="https://on.cypress.io/api" target="_blank" rel="noopener">Cypress API</a>, built-in <a href="https://github.com/bahmutov/cypress-vue-unit-test#code-coverage" target="_blank" rel="noopener">code coverage</a>, huge list of <a href="https://on.cypress.io/plugins" target="_blank" rel="noopener">plugins</a> for <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">visual testing</a> and other tasks, Dashboard support, etc. Give <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> a try, open any issues found, give us feedback!</p><p>Happy Vue Testing!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#application&quot;&gt;Application&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#end-to-end-tests&quot;&gt;End-to-end tests&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#co
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="vuejs" scheme="https://glebbahmutov.com/blog/tags/vuejs/"/>
    
  </entry>
  
  <entry>
    <title>Stop The Money Pipeline</title>
    <link href="https://glebbahmutov.com/blog/stop-the-money-pipeline/"/>
    <id>https://glebbahmutov.com/blog/stop-the-money-pipeline/</id>
    <published>2020-06-17T04:00:00.000Z</published>
    <updated>2020-07-01T20:39:46.364Z</updated>
    
    <content type="html"><![CDATA[<p>Maybe huge banks are financing fossil fuels and thus the planet&#39;s destruction. You can read the entire list at <a href="https://www.ran.org/" target="_blank" rel="noopener">Rainforest Action Network</a> website. They publish <a href="https://www.ran.org/issue/banks_and_climate/" target="_blank" rel="noopener">banking report</a> every year, for example here <a href="https://www.ran.org/wp-content/uploads/2020/05/BOCC__2020_Summary_vENG_spread.pdf" target="_blank" rel="noopener">2020 report</a>. In summary, these banks are the worst twelve.</p><p><img src="/blog/images/banks/twelve.png" alt="Twelve worst banks financing fossil fuel projects"></p><p>Stopping these banks is a huge goal of the climate movement - see the <a href="https://www.stopthemoneypipeline.com/" target="_blank" rel="noopener">https://www.stopthemoneypipeline.com/</a> for actions. In spirit of stopping the money that finance the destruction, I have switched my accounts too.</p><ol><li>I have canceled <strong>Bank of America</strong> account and went with a local <a href="https://www.watertownsavings.com/" target="_blank" rel="noopener">Watertown Savings Bank</a>.</li></ol><center>  <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/i3_vlXdt-2I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>Because it is important to talk about the climate crisis, I have <a href="https://twitter.com/bahmutov/status/1257686182043037697" target="_blank" rel="noopener">tweeted about it</a>, tagging the Bank of America in the tweet. I have also called them to cancel the account and listed by reason for this.</p><p><img src="/blog/images/banks/boa-tweet.png" alt="Cutting Bank of America card tweet"></p><ol start="2"><li>I have canceled my <strong>Chase</strong> credit card (that I loved). Again, I have posted the video online and told the bank my reason for canceling the account with them was their investment in fossil fuels.</li></ol><center>  <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/TaiU1xqcxp4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>Screenshot of the <a href="https://twitter.com/bahmutov/status/1260702956598562816" target="_blank" rel="noopener">tweet</a></p><p><img src="/blog/images/banks/chase-tweet.png" alt="Cutting Chase card tweet"></p><p>So far I have not replaced the card - I am still looking at options at <a href="https://www.greenamerica.org/better-banking/take-charge-your-card/find-responsible-credit-cards" target="_blank" rel="noopener">greenamerica.org</a>.</p><ol start="3"><li>Finally, constructing fossil fuel infrastructure requires insurance. <strong>Liberty Mutual</strong> from Boston is a leader in insuring gas pipelines, oil exploration, etc. On the other hand, they were selling insurance to me for my home - insurance that is certain to become more expensive as climate breakdown increases the natural disasters. So I have switched from Liberty Mutual to <a href="travelers.com">Traveler&#39;s</a>, <a href="https://twitter.com/bahmutov/status/1268994645259882496" target="_blank" rel="noopener">tweeting about it</a></li></ol><p><img src="/blog/images/banks/liberty-tweet.png" alt="Liberty Mutual tweet"></p><p>I have called Liberty Mutual to cancel the account, and told them my reason. I also told them that I will be paying 5% per year more but I would not be paying money to be used against me and my family&#39;s future.</p><blockquote><p>I invite you to vote with your money and switch to financial institutions that do not destroy the planet. There are plenty of choices!</p></blockquote><h2><span id="update-1">Update 1</span></h2><p>After this blog post I found out that Traveler&#39;s insurance also <a href="https://www.insureourfuture.us/updates/2020/6/27/ct-climate-activists-fly-plane-with-banner-through-travelers-pga-tournament" target="_blank" rel="noopener">invests in fossil projects</a>. Thus I looked around and found <a href="https://www.lemonade.com" target="_blank" rel="noopener">Lemonade</a> - an insurance company that will <a href="https://www.lemonade.com/blog/divest_coal/" target="_blank" rel="noopener">never invest in fossil fuels</a> as noted by <a href="https://www.insureourfuture.us/updates/2019/3/4/lemonade-is-first-us-insurance-company-to-reject-fossil-fuel-investments" target="_blank" rel="noopener">others</a>.</p><p>I switched my insurance to Lemonade - and I must tell you: they have an amazing web app and mobile app experience. I have never seen a better service sign up. Never ever! Every insurance parameter was easy to understand and change and the entire thing was a pleasure. Give Lemonade a try through this referral link <a href="https://lemonade.com/r/glebbahmutov" target="_blank" rel="noopener">https://lemonade.com/r/glebbahmutov</a>, you will feel better because your premiums will not go towards burning our planet.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Maybe huge banks are financing fossil fuels and thus the planet&amp;#39;s destruction. You can read the entire list at &lt;a href=&quot;https://www.r
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Visual testing for React components using open source tools</title>
    <link href="https://glebbahmutov.com/blog/open-source-visual-testing-of-components/"/>
    <id>https://glebbahmutov.com/blog/open-source-visual-testing-of-components/</id>
    <published>2020-06-16T04:00:00.000Z</published>
    <updated>2020-07-15T15:04:56.123Z</updated>
    
    <content type="html"><![CDATA[<p>Let&#39;s take a look at a modern React application like this <a href="https://github.com/raravi/sudoku" target="_blank" rel="noopener">Sudoku</a> game that you can play online at <a href="https://sudoku-raravi.now.sh/" target="_blank" rel="noopener">https://sudoku-raravi.now.sh/</a>.</p><!-- toc --><ul><li><a href="#talks">Talks</a></li><li><a href="#sudoku-game">Sudoku game</a></li><li><a href="#implementation">Implementation</a></li><li><a href="#numbers-component">Numbers component</a></li><li><a href="#cypress-react-unit-test">cypress-react-unit-test</a></li><li><a href="#visual-testing">Visual testing</a></li><li><a href="#controlling-the-clock">Controlling the clock</a></li><li><a href="#deterministic-board">Deterministic board</a></li><li><a href="#local-workflow">Local workflow</a></li><li><a href="#continuous-integration">Continuous Integration</a></li><li><a href="#pull-request-workflow">Pull request workflow</a></li><li><a href="#summary">Summary</a></li><li><a href="#more-info">More info</a></li></ul><!-- tocstop --><h2><span id="talks">Talks</span></h2><p>I have covered this topic in a JSNationLive 2020 presentation</p><center>  <iframe src="https://slides.com/bahmutov/i-see-what-is-going-on/embed?style=light" width="576" height="420" scrolling="no" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></center><p>Video (20 minutes)</p><center>  <iframe width="560" height="315" src="https://www.youtube.com/embed/00BNExlJUU8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>Later I have shown an expanded version of this talk at Des Moines meetup</p><center>  <iframe src="https://slides.com/bahmutov/visual-testing/embed?style=light" width="576" height="420" scrolling="no" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></center><p>Video (1 hour video)</p><center>  <iframe width="560" height="315" src="https://www.youtube.com/embed/gUFdU5fQs4o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><h2><span id="sudoku-game">Sudoku game</span></h2><p>The game is nicely done. There are different difficulty levels, game modes and it looks very polished.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/lxWEE0vDq6c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>It is a well-designed web application with responsive styles for 3 different browser widths</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/w00vpIEVZPQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>The application is made out of React components, which we can see in the <code>src</code> folder, or by using React DevTools. There is <code>&lt;App /&gt;</code> and <code>&lt;Game /&gt;</code> components, and lots of smaller components matching the sections of the user interface.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/f9sbdiAEHxs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><h2><span id="implementation">Implementation</span></h2><p>Let&#39;s look at the code. <strong>Note:</strong> you can find my fork of the game at <a href="https://github.com/bahmutov/sudoku" target="_blank" rel="noopener">bahmutov/sudoku</a>, which includes all code shown in this blog post.</p><figure class="highlight js"><figcaption><span>src/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"></span><br><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, document.getElementById('root'));</span></span><br></pre></td></tr></table></figure><p>The <code>App</code> component creates the React context object, imports the application&#39;s styles and creates the <code>Game</code> component</p><figure class="highlight js"><figcaption><span>src/App.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Game &#125; <span class="keyword">from</span> <span class="string">'./Game'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./App.css'</span></span><br><span class="line"><span class="keyword">import</span> &#123; SudokuProvider &#125; <span class="keyword">from</span> <span class="string">'./context/SudokuContext'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * App is the root React component.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;SudokuProvider&gt;</span><br><span class="line">      &lt;Game /&gt;</span><br><span class="line">    &lt;<span class="regexp">/SudokuProvider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>The <code>Game</code> component is much larger source file, because it brings all the logic together</p><figure class="highlight js"><figcaption><span>src/Game.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Header &#125; <span class="keyword">from</span> <span class="string">'./components/layout/Header'</span></span><br><span class="line"><span class="keyword">import</span> &#123; GameSection &#125; <span class="keyword">from</span> <span class="string">'./components/layout/GameSection'</span></span><br><span class="line"><span class="keyword">import</span> &#123; StatusSection &#125; <span class="keyword">from</span> <span class="string">'./components/layout/StatusSection'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Footer &#125; <span class="keyword">from</span> <span class="string">'./components/layout/Footer'</span></span><br><span class="line"><span class="keyword">import</span> &#123; getUniqueSudoku &#125; <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSudokuContext &#125; <span class="keyword">from</span> <span class="string">'./context/SudokuContext'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Game = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The <code>Game</code> component renders all the components shown above, passing props that receive user events</p><figure class="highlight js"><figcaption><span>src/Game.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  &lt;&gt;</span><br><span class="line">    &lt;div className=&#123;overlay?<span class="string">"container blur"</span>:<span class="string">"container"</span>&#125;&gt;</span><br><span class="line">      &lt;Header onClick=&#123;onClickNewGame&#125;/&gt;</span><br><span class="line">      &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">        &lt;GameSection</span><br><span class="line">          onClick=&#123;(indexOfArray) =&gt; onClickCell(indexOfArray)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;StatusSection</span><br><span class="line">          onClickNumber=&#123;(number) =&gt; onClickNumber(number)&#125;</span><br><span class="line">          onChange=&#123;(e) =&gt; onChangeDifficulty(e)&#125;</span><br><span class="line">          onClickUndo=&#123;onClickUndo&#125;</span><br><span class="line">          onClickErase=&#123;onClickErase&#125;</span><br><span class="line">          onClickHint=&#123;onClickHint&#125;</span><br><span class="line">          onClickMistakesMode=&#123;onClickMistakesMode&#125;</span><br><span class="line">          onClickFastMode=&#123;onClickFastMode&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Footer /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2><span id="numbers-component">Numbers component</span></h2><p>Among individual smaller components there is <code>Numbers</code> component that you can use to enter numbers into the grid.</p><p><img src="/blog/images/sudoku/numbers.gif" alt="Numbers component"></p><p>The Numbers component receives its inputs from the parent component in two ways: via a context and via props.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useSudokuContext &#125; <span class="keyword">from</span> <span class="string">'../context/SudokuContext'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * React component for the Number Selector in the Status Section.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Numbers = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; numberSelected &#125; = useSudokuContext();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"status__numbers"</span>&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>].map(<span class="function">(<span class="params">number</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (numberSelected === number.toString()) &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">              &lt;div className=<span class="string">"status__number status__number--selected"</span></span><br><span class="line">                key=&#123;number&#125;</span><br><span class="line">                onClick=&#123;() =&gt; props.onClickNumber(number.toString())&#125;&gt;&#123;number&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">            )</span></span><br><span class="line"><span class="regexp">          &#125; else &#123;</span></span><br><span class="line"><span class="regexp">            return (</span></span><br><span class="line"><span class="regexp">              &lt;div className="status__number" key=&#123;number&#125;</span></span><br><span class="line"><span class="regexp">                onClick=&#123;() =&gt; props.onClickNumber(number.toString())&#125;&gt;&#123;number&#125;&lt;/</span>div&gt;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>For example, the currently selected number (if any) is grabbed from the context.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; numberSelected &#125; = useSudokuContext();</span><br></pre></td></tr></table></figure><p>The click handler is grabbed from the <code>props</code> argument and used to send the clicked number back to the parent component.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Numbers = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  &lt;div className=<span class="string">"status__number"</span> key=&#123;number&#125;</span><br><span class="line">    onClick=&#123;() =&gt; props.onClickNumber(number.toString())&#125;&gt;&#123;number&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>If we want to refactor the above component, how do we ensure that we don&#39;t break it? How do we ensure that it renders in exactly the same way, and that when the user clicks, the number is sent to the parent component? How do we write component tests?</p><p>In my view, the component receives its inputs, the props and the context, and generates some output. The output is both the DOM nodes the component renders, and the <code>props.onClickNumber</code> invocations on click. Let&#39;s make sure the component works this way.</p><h2><span id="cypress-react-unit-test">cypress-react-unit-test</span></h2><p>To test the React components I will install <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a>. This adaptor allows the <a href="https://github.com/cypress-io/cypress" target="_blank" rel="noopener">Cypress</a> test runner to mount React components like little mini web applications and then use the full Cypress API to interact with them. Our application uses <code>react-scripts</code>, thus the setup is trivial</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/plugins/react-scripts'</span>)(on, config)</span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"experimentalComponentTesting"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"componentFolder"</span>: <span class="string">"src"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s write our first test.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Numbers &#125; <span class="keyword">from</span> <span class="string">'./Numbers'</span></span><br><span class="line">describe(<span class="string">'Numbers'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'shows all numbers'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Numbers</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">    [1, 2, 3, 4, 5, 6, 7, 8, 9].forEach(k =&gt; &#123;</span></span><br><span class="line"><span class="xml">      cy.contains('.status__number', k)</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Open Cypress with <code>yarn cypress open</code> or <code>npx cypress open</code> and run the test. There is no need to start the application, because we are working with an individual component, not with a page.</p><p>Hmm, the test passes, all the numbers are there. But the component does not look right!</p><p><img src="/blog/images/sudoku/numbers-without-css.png" alt="First test to check all numbers are present"></p><p>I think it is very important to <em>see</em> the component to understand what the users will experience. Our component needs styles - and the styles are in the <code>src/app.css</code> file. Because we point the <code>cypress/plugins/index.js</code> at the <code>react-scripts</code> settings, the spec files will use the same loaders and bundlers as the application code. Which means we can import <code>app.css</code> from the spec file too:</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Numbers &#125; <span class="keyword">from</span> <span class="string">'./Numbers'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../App.css'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><img src="/blog/images/sudoku/numbers-with-css.png" alt="Include App.css in the test file"></p><p>This is better, but still not exactly the same. Since the CSS assumes certain document structure, we need to surround our <code>&lt;Numbers/&gt;</code> with elements with specific class names.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mount(</span><br><span class="line">  &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">    &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">      &lt;Numbers /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>This looks much better - now we see what the user is going to see.</p><p><img src="/blog/images/sudoku/numbers-styled.png" alt="Numbers component styled during test"></p><p>Super. We can also confirm that the component calls the prop <code>onClickNumber</code> when the user clicks a number in the DOM:</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'reacts to a click'</span>, () =&gt; &#123;</span><br><span class="line">  mount(</span><br><span class="line">    &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">      &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">        &lt;Numbers onClickNumber=&#123;cy.stub().as(<span class="string">'click'</span>)&#125;/&gt;</span><br><span class="line">      &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.status__number'</span>, <span class="string">'9'</span>).click()</span><br><span class="line">  cy.get(<span class="string">'@click'</span>).should(<span class="string">'have.been.calledWith'</span>, <span class="string">'9'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>In the test above we pass <a href="https://on.cypress.io/stub" target="_blank" rel="noopener">cy.stub</a> and confirm it was called with expected number 9 when the user clicks on the DOM element.</p><p><img src="/blog/images/sudoku/number-click.png" alt="Confirm the click happens"></p><p>How does our component look when there is a selected number? In order to test this, we need to wrap the <code>&lt;Numbers /&gt;</code> component with a mock context provider.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;SudokuContext&#125; <span class="keyword">from</span> <span class="string">'../context/SudokuContext'</span></span><br><span class="line">describe(<span class="string">'Numbers'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'shows selected number'</span>, () =&gt; &#123;</span><br><span class="line">    mount(</span><br><span class="line">      &lt;SudokuContext.Provider value=&#123;&#123; <span class="attr">numberSelected</span>: <span class="string">'4'</span> &#125;&#125; &gt;</span><br><span class="line">        &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">          &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">            &lt;Numbers /&gt;</span><br><span class="line">          &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/SudokuContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">    cy.contains('.status__number', '4').should('have.class', 'status__number--selected')</span></span><br><span class="line"><span class="regexp">  &#125;)</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br></pre></td></tr></table></figure><p>The number <code>4</code> does have the expected class <code>status__number--selected</code> and we do see the color difference.</p><p><img src="/blog/images/sudoku/selected-number.png" alt="Selected number 4"></p><p>Ok, but do we need to look at the tests to tell if the component looks correctly? Do we need a human in the loop? What if we change the <code>App.css</code> file and accidentally break some other component? This game has its own polished style, it would be a shame to break it accidentally.</p><h2><span id="visual-testing">Visual testing</span></h2><p>If we want to confirm the look of the component, we could assert every computed CSS property of every DOM node ... but that would be unbelievably brittle and hard to maintain. Instead, we could render the component into an image and <em>look at it</em>. While computers are not very good (yet) at understanding images, they are really good at <em>comparing</em> them. So let&#39;s generate screenshots of our component with different inputs and store those images with the code. Any time there is a pull request, we will repeat the above steps and then compare the new images pixel by pixel with saved good images.</p><p>There are many <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">commercial services</a> that do this, but in this blog post I will use open source image comparison plugin for Cypress called <a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a>. We can install it as a dev dependency and include its files in the support and plugins files.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-image-snapshot/command'</span>).addMatchImageSnapshotCommand()</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/plugins/react-scripts'</span>)(on, config)</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-image-snapshot/plugin'</span>).addMatchImageSnapshotPlugin(on, config)</span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now we get a new Cypress command <code>cy.matchImageSnapshot(&lt;snapshot name&gt;)</code>. Let&#39;s use it to create image snapshot of the Number component with selected digit &quot;4&quot;.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'shows selected number'</span>, () =&gt; &#123;</span><br><span class="line">  mount(</span><br><span class="line">    &lt;SudokuContext.Provider value=&#123;&#123; <span class="attr">numberSelected</span>: <span class="string">'4'</span> &#125;&#125; &gt;</span><br><span class="line">      &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">        &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">          &lt;Numbers /&gt;</span><br><span class="line">        &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    &lt;<span class="regexp">/SudokuContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">  cy.contains('.status__number', '4')</span></span><br><span class="line"><span class="regexp">    .should('have.class', 'status__number--selected')</span></span><br><span class="line"><span class="regexp">  cy.get('.status__numbers')</span></span><br><span class="line"><span class="regexp">    .matchImageSnapshot('numbers-selected')</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br></pre></td></tr></table></figure><p>In the test we have confirmed the component has been rendered using an assertion</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.contains(<span class="string">'.status__number'</span>, <span class="string">'4'</span>)</span><br><span class="line">  .should(<span class="string">'have.class'</span>, <span class="string">'status__number--selected'</span>)</span><br></pre></td></tr></table></figure><p>Then we create an image with the entire <code>.status__numbers</code> DOM element rendered.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'.status__numbers'</span>)</span><br><span class="line">  .matchImageSnapshot(<span class="string">'numbers-selected'</span>)</span><br></pre></td></tr></table></figure><p>The snapshots are saved in <code>cypress/snapshots</code> folder.</p><p><img src="/blog/images/sudoku/numbers-selected.snap.png" alt="Numbers component with selected number 4"></p><p>If we edit the CSS file <code>src/App.css</code> and change the text padding around the numbers like this:</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.status__number &#123;</span><br><span class="line"><span class="deletion">-   padding: 12px 0;</span></span><br><span class="line"><span class="addition">+   padding: 10px 0;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The test runs - and the generated snapshot (under the hood <code>cypress-image-snapshot</code> uses <a href="https://on.cypress.io/screenshot" target="_blank" rel="noopener">cy.screenshot</a>) is slightly different. It is hard to notice, so the pixel by pixel comparison done by the computer is perfect tool for automating it. The <code>cypress-image-snapshot</code> plugin produces the diff image in <code>cypress/snapshots/**/__diff_output__</code> folder. The diff image has three parts: on the left is the original baseline image. On the right is the current image. In the middle there is a composite image highlighting the difference.</p><p><img src="/blog/images/sudoku/numbers-selected.diff.png" alt="Padding difference is caught by image comparison"></p><p>The visual snapshots replace a lot of individual assertions. For example, there is no need to confirm that individual numbers are present in the DOM. Instead we can confirm the number of DOM elements with the class (to make sure the component has rendered) and take a single snapshot.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'shows all numbers'</span>, () =&gt; &#123;</span><br><span class="line">  mount(</span><br><span class="line">    &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">      &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">        &lt;Numbers /&gt;</span><br><span class="line">      &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">-  <span class="comment">// trying to assert every number in the DOM</span></span><br><span class="line">-  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>].forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">-    cy.contains(<span class="string">'.status__number'</span>, k)</span><br><span class="line">-  &#125;)</span><br><span class="line">+ cy.get(<span class="string">'.status__number'</span>).should(<span class="string">'have.length'</span>, <span class="number">9</span>)</span><br><span class="line">+ cy.get(<span class="string">'.status__numbers'</span>).matchImageSnapshot(<span class="string">'all-numbers'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>A single image snapshot can confirm so much - as long as the components render consistently from the same data. Let&#39;s look how to ensure it.</p><h2><span id="controlling-the-clock">Controlling the clock</span></h2><p>Inside the app, we have a timer that shows elapsed time since the start of the game</p><p><img src="/blog/images/sudoku/timer.gif" alt="Game timer"></p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">it(<span class="string">'shows the timer'</span>, () =&gt; &#123;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  // the timer starts at zero, so this is probably ok</span></span><br><span class="line"><span class="xml">  cy.contains('.status__time', '00:00')</span></span><br><span class="line"><span class="xml">    .matchImageSnapshot('timer-zero')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Hmm, how do we make sure we take consistent snapshot of a timer element that keeps changing? By controlling the <a href="https://on.cypress.io/stubs-spies-and-clocks" target="_blank" rel="noopener">clock</a> using <a href="https://on.cypress.io/clock" target="_blank" rel="noopener">cy.clock</a> and <a href="https://on.cypress.io/tick" target="_blank" rel="noopener">cy.tick</a>.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">it(<span class="string">'shows the timer'</span>, () =&gt; &#123;</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  cy.contains('.status__time', '00:00')</span></span><br><span class="line"><span class="xml">    .matchImageSnapshot('timer-zero')</span></span><br><span class="line"><span class="xml">  cy.tick(700 * 1000)</span></span><br><span class="line"><span class="xml">  cy.contains('.status__time', '11:40')</span></span><br><span class="line"><span class="xml">    .matchImageSnapshot('timer-passed')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Because we explicitly control the app&#39;s clock, the timer stays frozen at &quot;00:00&quot; when we take the first snapshot, and stays frozen at &quot;11:40&quot; when we take the second snapshot 700 seconds later. A nice bonus for this technique is that we can test an application with long actions in a blink of an eye.</p><p><img src="/blog/images/sudoku/control-the-clock.gif" alt="Controlling the clock test"></p><h2><span id="deterministic-board">Deterministic board</span></h2><p>If we can test the smaller components, why can&#39;t we mount the entire <code>&lt;App&gt;</code> and take an image snapshot? That would give us a lot of confidence.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">it(<span class="string">'shows the board'</span>, () =&gt; &#123;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  // DOES NOT WORK, JUST FOR DEMO</span></span><br><span class="line"><span class="xml">  cy.get('.container').matchImageSnapshot('the-game')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Unfortunately the above test would not work. We cannot just take a snapshot - the board is generated randomly every time the game starts. Every new board will produce a new image, breaking the test.</p><p><img src="/blog/images/sudoku/random-board.gif" alt="Random board"></p><p>Let&#39;s look how the game generates the board data. The <code>&lt;App&gt;</code> component has the <code>&lt;Game&gt;</code> child component, which imports a function to generate the board.</p><figure class="highlight js"><figcaption><span>src/Game.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getUniqueSudoku &#125; <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createNewGame</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [temporaryInitArray, temporarySolvedArray] = getUniqueSudoku(difficulty, e);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>To generate the same board, we will stub the ES6 import <code>getUniqueSudoku</code>. I have intercepted the results from <code>getUniqueSudoku()</code> call using the DevTools and saved the two arrays as two JSON fixture files.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cypress/fixtures/init-array.json</span></span><br><span class="line">[<span class="string">"0"</span>, <span class="string">"0"</span>, <span class="string">"9"</span>, <span class="string">"0"</span>, <span class="string">"2"</span>, <span class="string">"0"</span>, <span class="string">"0"</span>, ...]</span><br><span class="line"><span class="comment">// cypress/fixtures/solved-array.json</span></span><br><span class="line">[<span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"9"</span>, <span class="string">"3"</span>, <span class="string">"2"</span>, <span class="string">"8"</span>, <span class="string">"4"</span>, ...]</span><br></pre></td></tr></table></figure><p>Plugin <code>cypress-react-unit-test</code> comes with a Babel plugin that can mock ES6 module imports, and for any application that uses <code>react-scripts</code> it should work automatically. Let mock the <code>getUniqueSudoku</code> import and return the arrays loaded from the fixture files.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> UniqueSudoku <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">it(<span class="string">'shows the board'</span>, () =&gt; &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">    cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  cy.get('.container').matchImageSnapshot('the-game')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The above test always generates the same board, freezes the clock at &quot;00:00&quot; and generates a consistent snapshot image. Building on top of this approach, we can write a test that plays a move, since we have a deterministic board to start with.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> UniqueSudoku <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">it(<span class="string">'plays one move'</span>, () =&gt; &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">    cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  cy.get('.game__cell').first().click()</span></span><br><span class="line"><span class="xml">  // we can even look at the solved array!</span></span><br><span class="line"><span class="xml">  cy.contains('.status__number', '6').click()</span></span><br><span class="line"><span class="xml">  cy.get('.game__cell').first()</span></span><br><span class="line"><span class="xml">    .should('have.class', 'game__cell--highlightselected')</span></span><br><span class="line"><span class="xml">  cy.get('.container').matchImageSnapshot('same-game-made-one-move')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/sudoku/play-move.png" alt="Test that makes a move"></p><p>While a screenshot is nice, the power of Cypress comes from its full browser experience and time-traveling debugging feature. The video below shows what every test command does as we hover it.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/WcXZpqAKwQQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p><strong>Tip:</strong> if a lot of tests load the same fixture, you can load it once and store in a closure variable.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initArray</span><br><span class="line"><span class="keyword">let</span> solvedArray</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> initArray = arr)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> solvedArray = arr)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">'plays one move'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Read blog post <a href="../import-cypress-fixtures/">Import Cypress fixtures</a> for details.</p><h2><span id="local-workflow">Local workflow</span></h2><p>We can write visual tests for our components and generate consistent images by mocking data and the clock. Is this enough to use visual testing in our day-to-day life?</p><p>No.</p><p>If we take a visual snapshot in Cypress GUI opened with <code>yarn cypress open</code> on Mac we will get an image with a specific resolution, for example 1300x600 pixels. When we take the same snapshot in the headless mode using <code>yarn cypress run</code> we will get an image with only the half resolution in each dimension: 650x300 pixels. This is due to pixel density of the graphical application vs headless rendering mode. Thus I <em>disable snapshots</em> in the interactive mode from the support file.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; addMatchImageSnapshotCommand &#125; <span class="keyword">from</span> <span class="string">'cypress-image-snapshot/command'</span>;</span><br><span class="line"><span class="keyword">if</span> (Cypress.config(<span class="string">'isInteractive'</span>)) &#123;</span><br><span class="line">  Cypress.Commands.add(<span class="string">'matchImageSnapshot'</span>, () =&gt; &#123;</span><br><span class="line">    cy.log(<span class="string">'Skipping snapshot 👀'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  addMatchImageSnapshotCommand()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br></pre></td></tr></table></figure><p>When the test is running, the Command Log shows the places where the snapshots would be taken.</p><p><img src="/blog/images/sudoku/skip-snapshots.png" alt="Skipped snapshots"></p><p>To really take a snapshot, I execute <code>yarn cypress run</code>, inspect any new snapshot files, add them to the source control and push the code to the remote repository.</p><p>If I need to update a saved image snapshot, I can delete the snapshot image and execute <code>yarn cypress run</code> to save new image. Or I can run Cypress with environment variable telling the <code>cypress-image-snapshot</code> to update every snapshot if there is difference.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_updateSnapshots=<span class="literal">true</span> yarn cypress run</span></span><br></pre></td></tr></table></figure><p><strong>Note:</strong> make sure to inspect every changed snapshot before committing, since all snapshots can be updated during the above command.</p><h2><span id="continuous-integration">Continuous Integration</span></h2><p>Even when saving image snapshots in the headless mode we can encounter problems. For example, if we save the image snapshots on Mac and compare them to the images generated on Linux CI, there will be tiny pixel differences due to font rendering, aliasing, and different browser versions.</p><p><img src="/blog/images/sudoku/ci-diff.png" alt="Mac vs Linux font rendering"></p><p>The image above shows the detected pixel differences between <code>00:00</code> rendered on Mac (left) and on Linux (right). Even these tiny differences still fail the test.</p><p>We can configure the <a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a> command to accept a small percentage of different pixels per image.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// when adding matchImageSnapshot command</span></span><br><span class="line">addMatchImageSnapshotCommand(&#123;</span><br><span class="line">  failureThreshold: <span class="number">0.03</span>, <span class="comment">// threshold for entire image</span></span><br><span class="line">  failureThresholdType: <span class="string">'percent'</span>, <span class="comment">// percent of image or number of pixels</span></span><br><span class="line">  customDiffConfig: &#123; <span class="attr">threshold</span>: <span class="number">0.1</span> &#125;, <span class="comment">// threshold for each pixel</span></span><br><span class="line">  capture: <span class="string">'viewport'</span>, <span class="comment">// capture viewport in screenshot</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>I do not trust such thresholds, since they can miss actual visual problems. Instead I recommend generating image snapshots using exactly the same environment as the one on CI. This is simple to do using Docker containers from <a href="https://github.com/cypress-io/cypress-docker-images" target="_blank" rel="noopener">cypress-docker-images</a>. Instead of running the command <code>yarn cypress run</code> to generate or update snapshots, we will use a Docker image locally.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">     <span class="attr">"docker:run"</span>: <span class="string">"docker run -it -v $PWD:/e2e -w /e2e cypress/included:4.5.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Because the component tests do not require a server, we can run them with a single command using the pre-installed Cypress Docker image <code>cypress/included:&lt;version&gt;</code>. On CI we can use a Docker with exactly the same OS dependencies, fonts and browser version. Here is an example CI config</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  cypress-run:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    container:</span> <span class="string">cypress/browsers:node12.13.0-chrome80-ff74</span></span><br></pre></td></tr></table></figure><p>The Docker image <code>cypress/included:4.5.0</code> is built from <code>cypress/browsers:node12.13.0-chrome80-ff74</code> image with Cypress globally installed. Thus the browser should render the same HTML pages in exactly the same way.</p><h2><span id="pull-request-workflow">Pull request workflow</span></h2><p>Let&#39;s discuss what happens with image snapshots during pull requests. When someone opens a PR with a new feature or a bug fix, it is beneficial to separate the <em>functional</em> tests from the <em>visual</em> tests. If a button has changed its appearance, the functional tests should pass, and the visual tests should fail. This will tell us quickly if there are visual differences due to layout, color, or style changes.</p><p>For this purpose, <a href="https://github.com/bahmutov/sudoku" target="_blank" rel="noopener">bahmutov/sudoku</a> runs tests on CI with an environment variable that tells the <a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a> plugin to generate image diffs, but not fail the command <code>matchImageSnapshot</code>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Cypress</span> <span class="string">run</span> <span class="string">🧪</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line">    <span class="comment"># let's go through the tests and generate all diffs</span></span><br><span class="line"><span class="attr">    env:</span> <span class="string">failOnSnapshotDiff=false</span></span><br></pre></td></tr></table></figure><p>At the end of the run we can find these diff images and report them separately using GitHub commit status check.</p><figure class="highlight js"><figcaption><span>scripts/set-gh-check.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getVisualDiffs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> globby(<span class="string">'cypress/snapshots/**/__diff_output__/**.png'</span>)</span><br><span class="line">&#125;</span><br><span class="line">getVisualDiffs().then(<span class="function"><span class="params">list</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> setGitHubCommitStatus(list.length, envOptions)</span><br><span class="line">&#125;).catch(onError)</span><br></pre></td></tr></table></figure><p>If there are any DIFF images, then the status check will be <code>fail</code>. The video below shows a pull request where at first there are visual changes. Then the tests are updated and the next commit has no visual differences.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/BDgqweqR36Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>Whenever there are visual differences, you can inspect the diff images if you store them on CI as test artifacts; the snapshots are stored in <code>cypress/snapshots</code> folder.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Store</span> <span class="string">snapshots</span> <span class="string">📸</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">actions/upload-artifact@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">snapshots</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">cypress/snapshots</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Set</span> <span class="string">commit</span> <span class="string">status</span> <span class="string">🖼</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    node ./scripts/set-gh-check.js</span></span><br></pre></td></tr></table></figure><h2><span id="summary">Summary</span></h2><p>In this blog post we have looked at writing React component tests and using visual diffing to compare the current image against the good baseline image. We must generate the same image, which we can do by mocking the data and the clock to be deterministic. We also need to ensure that the snapshots are generated using exactly the same environment to be pixel-perfect matches.</p><p>Finally, we briefly looked at the visual tests during pull request workflow. Looking back at the entire work, I conclude:</p><ul><li>writing React component tests using <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> is fast and easy</li><li><a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a> plugin allows one to do visual testing for free, but we have to do a lot of work to manage images, render them, and review them during pull requests</li></ul><p>I would strongly recommend giving a commercial visual testing service a try: Applitools, Happo.io, and Percy.io have Cypress plugins and are free to try and cheap use.</p><h2><span id="more-info">More info</span></h2><p>Take a look at the example Sudoku repository, and especially at the long list of short videos there: <a href="https://github.com/bahmutov/sudoku#videos" target="_blank" rel="noopener">bahmutov/sudoku#videos</a>. These videos show every part of the process I have described in this blog in more detail.</p><p>You should also read the <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">Cypress visual testing guide</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Let&amp;#39;s take a look at a modern React application like this &lt;a href=&quot;https://github.com/raravi/sudoku&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;S
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
      <category term="react" scheme="https://glebbahmutov.com/blog/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>Import Cypress fixtures</title>
    <link href="https://glebbahmutov.com/blog/import-cypress-fixtures/"/>
    <id>https://glebbahmutov.com/blog/import-cypress-fixtures/</id>
    <published>2020-06-15T04:00:00.000Z</published>
    <updated>2020-06-15T13:35:07.115Z</updated>
    
    <content type="html"><![CDATA[<p>In <a href="https://github.com/bahmutov/sudoku" target="_blank" rel="noopener">bahmutov/sudoku</a> I am loading two JSON fixtures to mock a method that creates the new board. This ensures the game always starts with the same numbers and generates the same image for <a href="https://www.youtube.com/playlist?list=PLP9o9QNnQuAYhotnIDEUQNXuvXL7ZmlyZ" target="_blank" rel="noopener">visual testing</a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> UniqueSudoku <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">    cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">        cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    cy.clock()</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.get('.game__cell--filled').should('have.length', 45)</span></span><br><span class="line"><span class="xml">    cy.get('.container').matchImageSnapshot('same-game-mocked-sudoku')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/sudoku/game-board.png" alt="Mocked board creation produces the same Sudoku game"></p><p>The JSON fixtures are simple arrays, we are using <a href="https://on.cypress.io/fixture" target="_blank" rel="noopener">cy.fixture</a> command to load them.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cypress/fixtures/init-array.json</span></span><br><span class="line">[<span class="string">"0"</span>, <span class="string">"0"</span>, <span class="string">"9"</span>, <span class="string">"0"</span>, <span class="string">"2"</span>, <span class="string">"0"</span>, <span class="string">"0"</span>, ...]</span><br><span class="line"><span class="comment">// cypress/fixtures/solved-array.json</span></span><br><span class="line">[<span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"9"</span>, <span class="string">"3"</span>, <span class="string">"2"</span>, <span class="string">"8"</span>, <span class="string">"4"</span>, ...]</span><br></pre></td></tr></table></figure><p>After the first test passes, we can write a test that plays one or several moves, then another test that sets the entire board and wins the game, etc. All these tests will load the same two fixture files at the start.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">    cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">        cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    cy.clock()</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    ...</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('plays a move', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    cy.fixture('init-array').then(initArray =&gt; &#123;</span></span><br><span class="line"><span class="xml">      cy.fixture('solved-array').then(solvedArray =&gt; &#123;</span></span><br><span class="line"><span class="xml">        cy.stub(UniqueSudoku, 'getUniqueSudoku').returns([initArray, solvedArray])</span></span><br><span class="line"><span class="xml">      &#125;)</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">    cy.clock()</span></span><br><span class="line"><span class="xml">    mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    ...</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('wins the game', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    // load the solved array</span></span><br><span class="line"><span class="xml">    // and set the initial array to be same without one move</span></span><br><span class="line"><span class="xml">    cy.fixture('solved-array').then(solvedArray =&gt; &#123;</span></span><br><span class="line"><span class="xml">      const almostSolved = [...solvedArray]</span></span><br><span class="line"><span class="xml">      // by setting entry to "0" we effectively clear the cell</span></span><br><span class="line"><span class="xml">      almostSolved[0] = '0'</span></span><br><span class="line"><span class="xml">      cy.stub(UniqueSudoku, 'getUniqueSudoku').returns([almostSolved, solvedArray])</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">    cy.clock()</span></span><br><span class="line"><span class="xml">    mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    ...</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><h2><span id="beforeeach">beforeEach</span></h2><p>Loading the same fixture files in every test?! We can do better. First, let&#39;s load the fixtures in the <code>beforeEach</code> hook and save them in the test context. We will need to change our test functions from arrow functions to actual <code>function</code> functions.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).as(<span class="string">'initArray'</span>)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).as(<span class="string">'solvedArray'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([<span class="keyword">this</span>.initArray, <span class="keyword">this</span>.solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', function () &#123;</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([this.initArray, this.solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Cypress <a href="https://on.cypress.io/as" target="_blank" rel="noopener">.as</a> command saves the loaded object in the test context, which is available as a property during the test.</p><h2><span id="before">before</span></h2><p>The hook <code>beforeEach</code> runs with every test, can we load the fixtures <em>once</em>? We can run the code once using <code>before</code> hook, but that will cause a problem.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).as(<span class="string">'initArray'</span>)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).as(<span class="string">'solvedArray'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ✅ works</span></span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([<span class="keyword">this</span>.initArray, <span class="keyword">this</span>.solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', function () &#123;</span></span><br><span class="line"><span class="xml">  // 🔥 DOES NOT WORK</span></span><br><span class="line"><span class="xml">  // this.initArray is undefined</span></span><br><span class="line"><span class="xml">  // this.solvedArray is undefined</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([this.initArray, this.solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The test runner runs the <code>before</code> hook before the very first test, sets the fixtures as properties, and the first test passes. Then the test runner clears the test context and runs the second test. Thus during the second test, the properties <code>initArray</code> and <code>solvedArray</code> are undefined.</p><p>To get around this problem, let&#39;s use closure variables.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initArray</span><br><span class="line"><span class="keyword">let</span> solvedArray</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> initArray = arr)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> solvedArray = arr)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([initArray, solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([initArray, solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>I strongly recommend using closure variables instead of <code>this</code> properties. The closure variables are clearly visible and do not depend on <code>function</code> vs <code>() =&gt; {}</code> syntax.</p><h2><span id="imports">imports</span></h2><p>Another possible solution for JSON fixtures it to ... import them from the fixture file. Cypress will bundle the JSON files just fine.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> initArray <span class="keyword">from</span> <span class="string">'../cypress/fixtures/init-array.json'</span></span><br><span class="line"><span class="keyword">import</span> solvedArray <span class="keyword">from</span> <span class="string">'../cypress/fixtures/solved-array.json'</span></span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([initArray, solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([initArray, solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Happy testing!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;In &lt;a href=&quot;https://github.com/bahmutov/sudoku&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;bahmutov/sudoku&lt;/a&gt; I am loading two JSON fixtures to mock
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Tic-Tac-Toe Component Tests</title>
    <link href="https://glebbahmutov.com/blog/tic-tac-toe-component-tests/"/>
    <id>https://glebbahmutov.com/blog/tic-tac-toe-component-tests/</id>
    <published>2020-06-03T04:00:00.000Z</published>
    <updated>2020-06-03T19:51:00.767Z</updated>
    
    <content type="html"><![CDATA[<p>Let&#39;s take React <a href="https://codepen.io/gaearon/pen/LyyXgK" target="_blank" rel="noopener">Tic-Tac-Toe example</a> by someone named D Abramov. He must be somewhat important person, since this example was included in the <a href="https://reactjs.org/tutorial/tutorial.html" target="_blank" rel="noopener">React Tutorial</a>. You can find my version of the game at <a href="https://github.com/bahmutov/react-tic-tac-toe-example" target="_blank" rel="noopener">bahmutov/react-tic-tac-toe-example</a>.</p><p><img src="/blog/images/tic-tac-toe/game.png" alt="Tic-tac-toe game"></p><p>The project uses <code>react-scripts</code> to bundle and serve the application. The application itself only has 3 files in the <code>src</code> folder</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">repo/</span><br><span class="line">  package.json</span><br><span class="line">  src/</span><br><span class="line">    index.jsx</span><br><span class="line">    app.jsx</span><br><span class="line">    app.css</span><br></pre></td></tr></table></figure><p>The application file <code>src/app.jsx</code> has a few components: Square, Board, Game and a function <code>calculateWinner</code>.</p><p><img src="/blog/images/tic-tac-toe/app.png" alt="Main application file"></p><h2><span id="e2e-vs-component-tests">E2E vs component tests</span></h2><p>Usually, I consider end-to-end tests the most effective way to confirm the application works. The Cypress test interacts with the loaded application like a real user, and any error in its logic, code, bundling, or deployment is likely to be caught.</p><figure class="highlight js"><figcaption><span>cypress/integration/spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'Tic-tac-toe'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'plays'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    cy.visit(<span class="string">'http://localhost:3000'</span>)</span><br><span class="line">    cy.get(<span class="string">'.square'</span>).eq(<span class="number">0</span>).click() <span class="comment">// X</span></span><br><span class="line">    cy.get(<span class="string">'.square'</span>).eq(<span class="number">1</span>).click() <span class="comment">// O</span></span><br><span class="line">    <span class="comment">// more commands until one player wins</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The tests are nice, but what if we want to concentrate on the <code>Square</code> component? Maybe we want to refactor it, maybe we want to see how it looks with different styles or props, there could be lots of reasons we want to really stress this component in isolation from the main application.</p><h2><span id="component-tests">Component tests</span></h2><p>By adding <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> to the repo we can easily write component tests. Let&#39;s confirm the <code>Square</code> component shows the value passed via a prop. For now we can simply export <code>Square</code> from the <code>app.jsx</code> and import it in the test file, and we can place the spec file alongside the component.</p><figure class="highlight js"><figcaption><span>src/app.jsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">Square</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;button className=<span class="string">"square"</span> onClick=&#123;props.onClick&#125;&gt;</span><br><span class="line">      &#123;props.value&#125;</span><br><span class="line">    &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>src/Square.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Square &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Square'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders value'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Square</span> <span class="attr">value</span>=<span class="string">"X"</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('.square', 'X')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/tic-tac-toe/square.png" alt="Square test"></p><p>We import the component and mount it, and then use Cypress commands to interact with the live  component. Let&#39;s confirm it calls the passed prop on click. Ordinarily one would write a new unit test to separate the value test from the click test. But Cypress has built-in time traveling debugger, records movies on CI, takes screenshots on failures - you don&#39;t need to make component tests tiny just to have a good debugging experience. So I will continue expanding the same test.</p><figure class="highlight js"><figcaption><span>src/Square.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Square &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Square'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders value'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Square</span> <span class="attr">value</span>=<span class="string">"X"</span> <span class="attr">onClick</span>=<span class="string">&#123;cy.stub().as(</span>'<span class="attr">click</span>')&#125; /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('.square', 'X').click()</span></span><br><span class="line"><span class="xml">    cy.get('@click').should('be.called')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The test passes.</p><p><img src="/blog/images/tic-tac-toe/square-click.png" alt="Square click test"></p><h2><span id="styles">Styles</span></h2><p>The square component looks like a regular button, not like a board cell in the real game. This is because we only mounted the markup and never applied any styles to it. There are <a href="https://github.com/bahmutov/cypress-react-unit-test#options" target="_blank" rel="noopener">multiple options</a> for styling components during tests, but the simplest is just to import the application&#39;s CSS from the spec file.</p><figure class="highlight js"><figcaption><span>src/Square.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Square &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./app.css'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Square'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders value'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Square</span> <span class="attr">value</span>=<span class="string">"X"</span> <span class="attr">onClick</span>=<span class="string">&#123;cy.stub().as(</span>'<span class="attr">click</span>')&#125; /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('.square', 'X').click()</span></span><br><span class="line"><span class="xml">    cy.get('@click').should('be.called')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/tic-tac-toe/square-style.png" alt="styled Square"></p><p>We can <code>import &#39;./app.css&#39;</code> because the specs are bundled using the same Webpack config as the application; if you can import a resource from the application code, you should be able to import it from the component test file.</p><h2><span id="mocking-imports">Mocking imports</span></h2><p>We have passed <a href="https://on.cypress.io/stub" target="_blank" rel="noopener">cy.stub</a> to the component. This stub comes from <a href="https://sinonjs.org/" target="_blank" rel="noopener">Sinon.js</a> included with Cypress. It works great when stubbing individual functions or a method on an object. But what about mocking ES6 module exports and imports?</p><p>The game component determines the winner by calling <code>calculateWinner</code> function. The exact details are unimportant, but the code around it looks like this:</p><p><img src="/blog/images/tic-tac-toe/calculate-winner.png" alt="Game calls calculateWinner"></p><p>From the component test, we cannot reach and overwrite a private function <code>calculateWinner</code>. But we could move it into an external module and import it.</p><figure class="highlight js"><figcaption><span>src/utils.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateWinner</span>(<span class="params">squares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lines = [</span><br><span class="line">    [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">3</span>, <span class="number">6</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">4</span>, <span class="number">7</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">5</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>],</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; lines.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> [a, b, c] = lines[i];</span><br><span class="line">    <span class="keyword">if</span> (squares[a] &amp;&amp; squares[a] === squares[b] &amp;&amp; squares[a] === squares[c]) &#123;</span><br><span class="line">      <span class="keyword">return</span> squares[a];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>src/app.jsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;calculateWinner&#125; <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line"><span class="comment">// use calculateWinner to determine the winner</span></span><br></pre></td></tr></table></figure><p>Now let&#39;s write a component test for the <code>Game</code> component - and mock the ES6 module import.</p><figure class="highlight js"><figcaption><span>src/Game.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Game &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./app.css'</span></span><br><span class="line"><span class="comment">// import the module with exports we want to mock</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> utils <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Game'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'declares winner'</span>, () =&gt; &#123;</span><br><span class="line">    cy.stub(utils, <span class="string">'calculateWinner'</span>).returns(<span class="string">'X'</span>)</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Game</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('Winner: X')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The test passes - note how <code>Winner: X</code> is immediately displayed, even before the first move is played 😀</p><p><img src="/blog/images/tic-tac-toe/winner-x.png" alt="Help X win right away by mocking the ES6 module import"></p><h2><span id="unit-tests">Unit tests</span></h2><p>We can write more end-to-end and component tests, using built-in code coverage as a guide. But what about the above function <code>calculateWinner</code>? Do we only indirectly test it via component tests? No. We should also directly test it using unit tests.</p><figure class="highlight js"><figcaption><span>src/utils.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; calculateWinner &#125; <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line">describe(<span class="string">'calculateWinner'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> _ = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">const</span> x = <span class="string">'X'</span></span><br><span class="line">  <span class="keyword">const</span> o = <span class="string">'O'</span></span><br><span class="line">  it(<span class="string">'calls no winner for empty board'</span>, () =&gt; &#123;</span><br><span class="line">    expect(calculateWinner(</span><br><span class="line">      [</span><br><span class="line">        _, _, _,</span><br><span class="line">        _, _, _,</span><br><span class="line">        _, _, _,</span><br><span class="line">      ]</span><br><span class="line">    )).to.equal(<span class="literal">null</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'calls winner for X'</span>, () =&gt; &#123;</span><br><span class="line">    expect(calculateWinner(</span><br><span class="line">      [</span><br><span class="line">        _, _, x,</span><br><span class="line">        x, o, x,</span><br><span class="line">        _, o, x,</span><br><span class="line">      ]</span><br><span class="line">    )).to.equal(x)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'calls winner for O'</span>, () =&gt; &#123;</span><br><span class="line">    expect(calculateWinner(</span><br><span class="line">      [</span><br><span class="line">        _, _, o,</span><br><span class="line">        x, o, x,</span><br><span class="line">        o, o, x,</span><br><span class="line">      ]</span><br><span class="line">    )).to.equal(o)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We exercise different <a href="../data-coverage/">data inputs</a> rather than code paths to make sure the function works correctly. The tests do not have a GUI, but the Command Log still shows useful information.</p><p><img src="/blog/images/tic-tac-toe/unit-tests.png" alt="Unit tests"></p><p>If there is an error, the code frame immediately shows the problem. For example if we change the last assertion to <code>)).to.equal(x)</code> we get the <a href="https://www.cypress.io/blog/2020/05/20/faster-debugging-with-test-failure-code-frames-in-cypress-4-6/" target="_blank" rel="noopener">precise source code location</a></p><p><img src="/blog/images/tic-tac-toe/error-location.png" alt="Error location"></p><h2><span id="more-info">More info</span></h2><p>For more reasons behind component testing, read <a href="../my-vision-for-component-tests/">My Vision for Component Tests</a> blog posts, and visit the <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> repo.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Let&amp;#39;s take React &lt;a href=&quot;https://codepen.io/gaearon/pen/LyyXgK&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Tic-Tac-Toe example&lt;/a&gt; by someone na
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="react" scheme="https://glebbahmutov.com/blog/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>Be careful when running all specs together</title>
    <link href="https://glebbahmutov.com/blog/run-all-specs/"/>
    <id>https://glebbahmutov.com/blog/run-all-specs/</id>
    <published>2020-05-28T04:00:00.000Z</published>
    <updated>2020-05-28T21:36:11.979Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#example-application">Example application</a></li><li><a href="#support-file">Support file</a></li><li><a href="#before-hooks">Before hooks</a></li><li><a href="#before-hooks-when-running-all-specs">Before hooks when running all specs</a></li><li><a href="#beforeeach-hook">BeforeEach hook</a></li><li><a href="#solution">Solution</a></li></ul><!-- tocstop --><h2><span id="example-application">Example application</span></h2><p>In our example application we have two spec files and a support file.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">repo/</span><br><span class="line">  cypress/</span><br><span class="line">    integration/</span><br><span class="line">      spec-a.js</span><br><span class="line">      spec-b.js</span><br><span class="line">    support/</span><br><span class="line">      index.js</span><br><span class="line">  cypress.json</span><br></pre></td></tr></table></figure><p>The spec files have two tests each.</p><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="support-file">Support file</span></h2><p>The support file is initially empty. Let&#39;s add a single <code>console.log</code> message.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br></pre></td></tr></table></figure><p>The support file runs in the browser, right before the spec file runs. We can see the support file and the spec file downloaded by the test runner in the DevTools console (blue arrow).</p><p><img src="/blog/images/run-all-specs/two-scripts.png" alt="Support file"></p><p>The two scripts (support file and the spec file) are requested by the test runner via XHR calls and then evaluated.</p><p><img src="/blog/images/run-all-specs/script-names.png" alt="Support and spec files"></p><p>The above download mechanism is just an implementation detail. In effect it means the test runner is evaluating scripts in this order:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"support/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"integration/spec-a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>We can see that both files were bundled using Cypress&#39; built-in preprocessor.</p><p><img src="/blog/images/run-all-specs/support-bundle.png" alt="Support file bundle"></p><p><img src="/blog/images/run-all-specs/spec-bundle.png" alt="Spec file bundle"></p><p>Which means our tests are really running the following <em>concatenated</em> script:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// support/index.js</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line"><span class="comment">// integration/spec-a.js</span></span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="before-hooks">Before hooks</span></h2><p>Let&#39;s place a hook into support file and a hook into the spec file.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: before hook'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test <code>spec-a.js</code> runs and the DevTools console prints the expected output</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">support file</span><br><span class="line">support file: before hook</span><br><span class="line">spec-a file: before hook</span><br></pre></td></tr></table></figure><p>This makes sense - the support file comes first, thus its hook is executed before the spec file&#39;s hook. Similarly, if we add a hook to <code>spec-b.js</code> it will execute in the same order</p><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>DevTools console messages:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">support file</span><br><span class="line">support file: before hook</span><br><span class="line">spec-b file: before hook</span><br></pre></td></tr></table></figure></p><h2><span id="before-hooks-when-running-all-specs">Before hooks when running all specs</span></h2><p>Great, but what happens when the user selects &quot;Run all specs&quot; button?</p><p><img src="/blog/images/run-all-specs/run-all-specs-button.png" alt="Run all specs button"></p><p>We see 4 tests finish in the Test Runner, and in the DevTools Network tab we can see the support file plus each spec file requested by the test runner.</p><p><img src="/blog/images/run-all-specs/run-all-specs.png" alt="Specs requested"></p><p>The scripts are then evaluated one after another, which is equivalent to running the following test code</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The console prints the messages we expect</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">support file</span><br><span class="line">support file: before hook</span><br><span class="line">spec-a file: before hook</span><br><span class="line">spec-b file: before hook</span><br></pre></td></tr></table></figure><p>Good, no surprises here, but notice that <em>all</em> hooks executed before <em>all</em> tests. This is noticeable when adding a log message in each test.</p><p><img src="/blog/images/run-all-specs/log-from-test.png" alt="all before hooks ran before the tests"></p><p>If you assume that <code>spec-b: before</code> hook runs AFTER tests from <code>spec-a.js</code> but before tests in <code>spec-b.js</code>, you might get a wrong result here.</p><h2><span id="beforeeach-hook">BeforeEach hook</span></h2><p>Let&#39;s switch from <code>before</code> to <code>beforeEach</code> hook.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>When we run a single spec, the DevTools show the following messages.</p><p><img src="/blog/images/run-all-specs/spec-a-before-each.png" alt="Support and spec-a with beforeEach hooks"></p><p>Spec-b runs the same way by itself.</p><p>Now let&#39;s run <em>all specs</em> together. Just like before, this will be equivalent to executing this concatenated script.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Do you see the problem? Look at the printed console messages.</p><p><img src="/blog/images/run-all-specs/all-hooks.png" alt="All beforeEach hooks executed for each test"></p><p><em>Every hook</em> has run for every test. We probably did not mean for the <code>beforeEach</code> hook from <code>spec-b.js</code> to run before every test from <code>spec-a.js</code>, right? But because they were all in the same script at the root level, all three hooks are executed for every test.</p><h2><span id="solution">Solution</span></h2><ol><li><p>Never use &quot;Run all specs&quot; button. In fact, when you execute <code>cypress run</code>, Cypress never runs <em>all specs</em> together. Instead it executes &quot;support file + spec-a&quot;, then it separately executes &quot;support file + spec-b&quot; scripts.</p></li><li><p>Be wary of placing <code>before</code> or <code>beforeEach</code> hooks at the root level, instead prefer moving them into <code>describe</code> and <code>context</code> suites. This isolates the hooks, limiting them to the tests in that suite.</p></li></ol><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'spec-a file: beforeEach hook'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'spec-b file: beforeEach hook'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/run-all-specs/isolate-hooks.png" alt="Isolated hooks"></p><p>When we place the hooks into a suite like above, they apply correctly to the tests inside their suite.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#example-application&quot;&gt;Example application&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#support-file&quot;&gt;Support file&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a h
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Keep Examples Up To Date</title>
    <link href="https://glebbahmutov.com/blog/keep-examples-up-to-date/"/>
    <id>https://glebbahmutov.com/blog/keep-examples-up-to-date/</id>
    <published>2020-05-22T04:00:00.000Z</published>
    <updated>2020-05-22T14:51:20.482Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#examples-examples-examples">Examples, examples, examples</a></li><li><a href="#concentrate-on-the-most-important-dependencies">Concentrate on the most important dependencies</a></li><li><a href="#set-up-ci">Set up CI</a></li><li><a href="#add-version-badges">Add version badges</a></li><li><a href="#auto-updating-badges">Auto-updating badges</a></li></ul><!-- tocstop --><h2><span id="examples-examples-examples">Examples, examples, examples</span></h2><p>I love building tools and I love having many examples for each tool. Lots of examples make it simpler to understand how the tool works. For example <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> for testing React components has LOTS of both internal and external examples as you can see in the screenshot below:</p><p><img src="/blog/images/example-dependencies/examples.png" alt="Long list of examples"></p><p><strong>Tip:</strong> I give external example repos their own GitHub topic, in this case the topic <a href="https://github.com/topics/cypress-react-unit-test-example" target="_blank" rel="noopener">cypress-react-unit-test-example</a> has 23 GitHub repositories.</p><p>It is a challenge to keep external example repos up to date with the latest version of <code>cypress-react-unit-test</code> as this user calls out:</p><p><img src="/blog/images/example-dependencies/tweet.png" alt="Tweet asking to update try-cra-app-typescript"></p><p>So how do we keep <a href="https://github.com/bahmutov/try-cra-app-typescript" target="_blank" rel="noopener">try-cra-app-typescript</a> up-to-date?</p><h2><span id="concentrate-on-the-most-important-dependencies">Concentrate on the most important dependencies</span></h2><p>Each example might have multiple dependencies. The above project has</p><figure class="highlight js"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"@testing-library/jest-dom"</span>: <span class="string">"^4.2.4"</span>,</span><br><span class="line">    <span class="string">"@testing-library/react"</span>: <span class="string">"^9.3.2"</span>,</span><br><span class="line">    <span class="string">"@testing-library/user-event"</span>: <span class="string">"^7.1.2"</span>,</span><br><span class="line">    <span class="string">"@types/jest"</span>: <span class="string">"^24.0.0"</span>,</span><br><span class="line">    <span class="string">"@types/node"</span>: <span class="string">"^12.0.0"</span>,</span><br><span class="line">    <span class="string">"@types/react"</span>: <span class="string">"^16.9.0"</span>,</span><br><span class="line">    <span class="string">"@types/react-dom"</span>: <span class="string">"^16.9.0"</span>,</span><br><span class="line">    <span class="string">"react"</span>: <span class="string">"^16.13.1"</span>,</span><br><span class="line">    <span class="string">"react-dom"</span>: <span class="string">"^16.13.1"</span>,</span><br><span class="line">    <span class="string">"react-scripts"</span>: <span class="string">"3.4.1"</span>,</span><br><span class="line">    <span class="string">"typescript"</span>: <span class="string">"~3.7.2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"cypress"</span>: <span class="string">"4.3.0"</span>,</span><br><span class="line">    <span class="string">"cypress-react-unit-test"</span>: <span class="string">"3.0.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Because this is an example meant to demo <code>cypress-react-unit-test</code> + Cypress, we will ignore production dependencies and will only update <code>cypress</code> and <code>cypress-react-unit-test</code> dev dependencies. I will use <a href="https://renovate.whitesourcesoftware.com/" target="_blank" rel="noopener">Renovate Bot</a> to automatically open pull requests when new versions of these two dependencies are published on NPM. Following the advice I gave in <a href="../whitelist-renovate/">How To Update Only Some Dependencies Using Renovate App</a> here is <code>renovate.json</code> file</p><figure class="highlight json"><figcaption><span>renovate.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"config:base"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"automerge"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"schedule"</span>: [</span><br><span class="line">    <span class="string">"every weekend"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"updateNotScheduled"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"timezone"</span>: <span class="string">"America/New_York"</span>,</span><br><span class="line">  <span class="attr">"masterIssue"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"enabledManagers"</span>: [</span><br><span class="line">    <span class="string">"npm"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"packageRules"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"packagePatterns"</span>: [</span><br><span class="line">        <span class="string">"*"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"excludePackagePatterns"</span>: [</span><br><span class="line">        <span class="string">"cypress"</span>,</span><br><span class="line">        <span class="string">"cypress-react-unit-test"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We only need to update the dependencies we care about, and we can update them once a week during the weekend hours. When I enable Renovate GitHub Application for this repository, the app immediately opens a master issue showing the possible updates.</p><p><img src="/blog/images/example-dependencies/master-issue.png" alt="Renovate master issue"></p><h2><span id="set-up-ci">Set up CI</span></h2><p>To safely update any dependency, we must have tests and continuous integration service to run them. Following <a href="../example-ci-configs/">Example CI configs</a> I will use <a href="../trying-github-actions/">GitHub Actions</a> with <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a>.</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push,</span> <span class="string">pull_request]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  cypress-run:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">      <span class="comment"># Install NPM dependencies, cache them correctly</span></span><br><span class="line">      <span class="comment"># and run all Cypress tests</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> I always have the CI badge in the README file pointing at the <code>master</code> branch.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[![ci status][ci image]][ci url]</span><br><span class="line">[ci image]: https://github.com/bahmutov/try-cra-app-typescript/workflows/ci/badge.svg?branch=master</span><br><span class="line">[ci url]: https://github.com/bahmutov/try-cra-app-typescript/actions</span><br></pre></td></tr></table></figure><p>Now I can click on <code>cypress</code> or <code>cypress-react-unit-test</code> checkbox in the Renovate&#39;s master issue to open a pull request to update the dependency.</p><p><img src="/blog/images/example-dependencies/update-cypress.png" alt="Click checkbox next to the dependency to update"></p><p>A few seconds later a new pull request appears: Cypress dependency has been updated to v4.6.0 in <code>package.json</code> file; now it is being tested by GitHub Actions workflow.</p><p><img src="/blog/images/example-dependencies/update-cypress-pr.png" alt="Update Cypress pull request"></p><p>Once the CI finishes successfully we can manually merge the pull request or let Renovate Bot auto-merge it after an hour or so.</p><p><img src="/blog/images/example-dependencies/update-cypress-pr-green.png" alt="Cypress can be updated since the tests are green"></p><p><strong>Tip:</strong> if you use semantic release and automate the changelog writing, Renovate pull requests will show a very useful changelog. This makes it easier for the reviewer to decide how to proceed.</p><p><img src="/blog/images/example-dependencies/changelog.gif" alt="Renovate includes the release changelog from the dependency"></p><p>Sometimes a Renovate pull request shows a failed attempt to update. For example, the API for mounting component has changed between v3 and v4 (this was a breaking change).</p><p><img src="/blog/images/example-dependencies/failed-update.png" alt="Failed pull request to update cypress-react-unit-test"></p><p>We can inspect the CI output to see the error message.</p><p><img src="/blog/images/example-dependencies/failure.png" alt="Mount method has changed between v3 and v4"></p><p>I will still merge this pull request, but then I will update the tests to use <code>cypress-react-unit-test</code> using the new API. You can see the changes in commit <a href="https://github.com/bahmutov/try-cra-app-typescript/commit/aed44a77ec300d1f5af3639067ca4f86155385bb" target="_blank" rel="noopener">aed44a</a>.</p><h2><span id="add-version-badges">Add version badges</span></h2><p>I want to make it obvious to anyone looking at the <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> what the compatible Cypress and <code>cypress-react-unit-test</code> versions are right now. The simplest way in my opinion is to put the current dependency versions into the README as badges. I have a little utility for this <a href="https://github.com/bahmutov/dependency-version-badge" target="_blank" rel="noopener">dependency-version-badge</a>. We can simply run the tool using <code>npx</code> and insert two badges into the README at the first line</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx -p dependency-version-badge update-badge cypress cypress-react-unit-test</span></span><br><span class="line">npx: installed 3 in 2.091s</span><br><span class="line">⚠️ Could not find version badge for dependency "cypress"</span><br><span class="line">Insert new badge on the first line</span><br><span class="line">saving updated readme with cypress@4.6.0</span><br><span class="line">⚠️ Could not find version badge for dependency "cypress-react-unit-test"</span><br><span class="line">Insert new badge on the first line</span><br><span class="line">saving updated readme with cypress-react-unit-test@4.2.3</span><br></pre></td></tr></table></figure><p>The badges use shields.io to pull SVG of the badge and set the text to the dependency&#39;s name and version.</p><p><img src="/blog/images/example-dependencies/badges-markdown.png" alt="The first line of the README.md"></p><p>The rendered README file looks nice</p><p><img src="/blog/images/example-dependencies/badges.png" alt="Rendered README file with CI and version badges"></p><h2><span id="auto-updating-badges">Auto-updating badges</span></h2><p>We have manually set the badges with dependencies, but keeping them up to date manually is too much work. Let&#39;s update them automatically using GitHub Action. I will add another workflow file that should only run when pushing new code to <code>master</code> branch. We can further limit this action to only execute when the commit includes changes to <code>README</code>, <code>package.json</code> or the workflow file itself.</p><figure class="highlight yml"><figcaption><span>.github/workflows/badges.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">badges</span></span><br><span class="line"><span class="comment"># update README badge only if the README file changes</span></span><br><span class="line"><span class="comment"># or if the package.json file changes, or this file changes</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">README.md</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">package.json</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.github/workflows/badges.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Badges</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Update</span> <span class="string">version</span> <span class="string">badges</span> <span class="string">🏷</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npx -p dependency-version-badge update-badge cypress cypress-react-unit-test</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      # commit any changed files</span></span><br><span class="line"><span class="string">      # https://github.com/mikeal/publish-to-github-action</span></span><br><span class="line"><span class="string"></span><span class="attr">      - name:</span> <span class="string">Push</span> <span class="string">any</span> <span class="string">changes</span> <span class="string">to</span> <span class="string">repo</span> <span class="string">📤</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">mikeal/publish-to-github-action@master</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Usually there are no changes and the workflow finishes without pushing any new code</p><p><img src="/blog/images/example-dependencies/no-badge-updates.png" alt="Badges workflow when the versions stay the same"></p><p>But let&#39;s say we change the <code>cypress-react-unit-test</code> version in <code>package.json</code>. We can do it manually to simulate the version change, but normally Renovate would merge a pull request with version bump.</p><figure class="highlight diff"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- "cypress-react-unit-test": "4.2.3"</span></span><br><span class="line"><span class="addition">+ "cypress-react-unit-test": "4.2.2"</span></span><br></pre></td></tr></table></figure><p>The &quot;badges&quot; workflow runs and updates the markdown in the README file. Notice the changed Markdown file in Git status before pushing the change from the GitHub Action back to the repository.</p><p><img src="/blog/images/example-dependencies/badge-update.png" alt="Badges action has changed the README file"></p><p>You can see the automatic commit in the list of commits.</p><p><img src="/blog/images/example-dependencies/commits.png" alt="Commits show README update"></p><p><img src="/blog/images/example-dependencies/badge-commit.png" alt="README update commit shows the updated badge"></p><p>Now the example repository will stay up to date, and make it obvious to our users if the example shown is still applicable.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#examples-examples-examples&quot;&gt;Examples, examples, examples&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#concentrate-on-the-most-impo
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="markdown" scheme="https://glebbahmutov.com/blog/tags/markdown/"/>
    
      <category term="renovate" scheme="https://glebbahmutov.com/blog/tags/renovate/"/>
    
  </entry>
  
  <entry>
    <title>Mocking named TypeScript imports during tests</title>
    <link href="https://glebbahmutov.com/blog/mocking-named-typescript-imports/"/>
    <id>https://glebbahmutov.com/blog/mocking-named-typescript-imports/</id>
    <published>2020-05-20T04:00:00.000Z</published>
    <updated>2020-05-20T14:15:21.818Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Note:</strong> you can find the companion source code in <a href="https://github.com/bahmutov/mock-ts-imports" target="_blank" rel="noopener">bahmutov/mock-ts-imports</a> repository.</p><p>Imagine we have the following 2 TypeScript files.</p><figure class="highlight ts"><figcaption><span>math.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b</span><br></pre></td></tr></table></figure><figure class="highlight ts"><figcaption><span>user.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">'./math'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> compute = <span class="function">(<span class="params">a, b</span>) =&gt;</span> add(a, b)</span><br></pre></td></tr></table></figure><p>Both files use <em>named imports and exports</em> which causes problems trying to stub them from the tests.</p><h2><span id="testing-direct-named-import">Testing direct named import</span></h2><p>Let&#39;s write unit test to confirm the function <code>add</code> works. I will use <a href="https://github.com/avajs/ava" target="_blank" rel="noopener">Ava</a> test runner. To directly load TS spec files (and source code), I will use <code>ts-node</code> and <code>ava-ts</code>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D ava ava-ts typescript ts-node</span></span><br><span class="line">+ ava-ts@0.25.2</span><br><span class="line">+ ts-node@8.10.1</span><br><span class="line">+ ava@3.8.2</span><br><span class="line">+ typescript@3.9.3</span><br></pre></td></tr></table></figure><p>Our first test</p><figure class="highlight ts"><figcaption><span>math-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'ava'</span></span><br><span class="line"><span class="keyword">import</span> &#123;add&#125; <span class="keyword">from</span> <span class="string">'./math'</span></span><br><span class="line"></span><br><span class="line">test(<span class="string">'add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// testing the original function</span></span><br><span class="line">  t.deepEqual(add(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>It passes</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npx ava-ts math-spec.ts</span><br><span class="line"></span><br><span class="line">  1 passed</span><br></pre></td></tr></table></figure><h2><span id="testing-transient-named-import">Testing transient named import</span></h2><p>The module <code>math.ts</code> exports <code>add</code> that module <code>user.ts</code> calls during <code>compute</code> execution. Can we write a test for <code>user.ts</code> that stubs this indirect <code>math.ts add</code> export? Can we write a test where <code>compute</code> calls real <code>add</code>, and another test calls stubbed <code>add</code>?</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// "compute" imports "add" from "./math" using named import</span></span><br><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'ava'</span></span><br><span class="line"><span class="keyword">import</span> &#123; compute &#125; <span class="keyword">from</span> <span class="string">'./user'</span></span><br><span class="line"></span><br><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  stubSomehow(<span class="string">'./math'</span>, <span class="string">'add'</span>).returns(<span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Yes - by using a nice utility <a href="https://github.com/EmandM/ts-mock-imports" target="_blank" rel="noopener">ts-mock-imports</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i ts-mock-imports sinon</span></span><br><span class="line">+ sinon@9.0.2</span><br><span class="line">+ ts-mock-imports@1.3.0</span><br></pre></td></tr></table></figure><p>I am installing <code>ts-mock-imports</code> and its peer dependency <a href="https://sinonjs.org/" target="_blank" rel="noopener">Sinon</a>.</p><p>Let&#39;s mock named imports, even if they are loaded indirectly.</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// "compute" imports "add" from "./math" using named import</span></span><br><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'ava'</span></span><br><span class="line"><span class="keyword">import</span> &#123; compute &#125; <span class="keyword">from</span> <span class="string">'./user'</span></span><br><span class="line"><span class="keyword">import</span> &#123; ImportMock &#125; <span class="keyword">from</span> <span class="string">'ts-mock-imports'</span></span><br><span class="line"><span class="comment">// to mock "./math add" export need to import entire module</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> math <span class="keyword">from</span> <span class="string">'./math'</span></span><br><span class="line"></span><br><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Note that we had to import <code>./math</code> as <code>math</code> object to be able to mock a named import <code>add</code>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx ava-ts user-spec.ts</span></span><br><span class="line"></span><br><span class="line">  2 passed</span><br></pre></td></tr></table></figure><p>Under the hood, the <code>mockFunction</code> uses <a href="https://sinonjs.org/releases/v9.0.2/stubs/" target="_blank" rel="noopener">Sinon stubs</a>.</p><h2><span id="restore-mocks">Restore mocks</span></h2><p>Once mocked, the function <code>math.add</code> will stay mocked until restored.</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'add stays stubbed'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  t.deepEqual(compute(<span class="number">-1</span>, <span class="number">7</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx ava-ts user-spec.ts</span></span><br><span class="line"></span><br><span class="line">  3 passed</span><br></pre></td></tr></table></figure><p>I strongly recommend each test starts by restoring any mocked functions.</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(ImportMock.restore)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'add stays stubbed'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  t.deepEqual(compute(<span class="number">-1</span>, <span class="number">7</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The third test will correctly fail, because the mock <code>add</code> no longer returns 100.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx ava-ts user-spec.ts</span></span><br><span class="line"></span><br><span class="line">  2 passed</span><br><span class="line">  1 failed</span><br><span class="line"></span><br><span class="line">  add stays stubbed</span><br><span class="line"></span><br><span class="line">  /Users/gleb/git/mock-ts-imports/user-spec.ts:22</span><br><span class="line"></span><br><span class="line">   21: test('add stays stubbed', t =&gt; &#123;</span><br><span class="line">   22:   t.deepEqual(compute(-1, 7), 100)</span><br><span class="line">   23: &#125;)</span><br><span class="line"></span><br><span class="line">  Difference:</span><br><span class="line"></span><br><span class="line">  - 6</span><br><span class="line">  + 100</span><br></pre></td></tr></table></figure><p>You can also change and restore individual mock</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'stub and restore'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> stub = ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">  stub.returns(<span class="number">42</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">42</span>)</span><br><span class="line">  stub.restore()</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="more-info">More info</span></h2><ul><li><a href="../mocha-and-sinon/">Mocha and Sinon</a></li><li><a href="../lock-down-sinon-stub/">Lock Down Sinon Stub</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; you can find the companion source code in &lt;a href=&quot;https://github.com/bahmutov/mock-ts-imports&quot; target=&quot;_blank&quot; re
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="typescript" scheme="https://glebbahmutov.com/blog/tags/typescript/"/>
    
  </entry>
  
  <entry>
    <title>My Vision for Component Tests in Cypress</title>
    <link href="https://glebbahmutov.com/blog/my-vision-for-component-tests/"/>
    <id>https://glebbahmutov.com/blog/my-vision-for-component-tests/</id>
    <published>2020-04-29T04:00:00.000Z</published>
    <updated>2020-04-29T18:52:42.487Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#example-application">Example application</a></li><li><a href="#the-goal">The Goal</a></li><li><a href="#adding-tests">Adding tests</a></li><li><a href="#code-coverage">Code coverage</a></li><li><a href="#component-test">Component test</a></li><li><a href="#styles">Styles</a></li><li><a href="#testing-the-interface">Testing the interface</a></li><li><a href="#graphql-example">GraphQL example</a></li><li><a href="#components-all-the-way-down">Components all the way down</a></li><li><a href="#benefits">Benefits</a></li><li><a href="#examples">Examples</a></li><li><a href="#future-plans">Future plans</a></li><li><a href="#thank-you">Thank you</a></li></ul><!-- tocstop --><p>I have been talking about framework-specific component testing for ages now. I have even coded a bunch of adaptors like <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a>, <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> and others, that allow mounting individual components into Cypress and run them as full-fledged mini-web applications. While the initial solution was technically ok, due to the way Cypress works it has a long list of issues: React Hooks do not work, styles are often lost, etc.</p><p>I am excited to say that we have an [experimental support][<a href="https://github.com/cypress-io/cypress/releases/tag/v4.5.0]" target="_blank" rel="noopener">https://github.com/cypress-io/cypress/releases/tag/v4.5.0]</a> for a new way of binding test code in Cypress v4.5.0 that seems to solve <em>all known problems</em>. In this blog post I will show how it might work, once we release it.</p><center><strong>⚠️ Warning:</strong> component testing is currently in Alpha release. If you find a problem, please open an issue in the adaptor repo (like <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">bahmutov/cypress-react-unit-test</a>, <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">bahmutov/cypress-vue-unit-test</a>). Use this awesome feature at your own risk.</center><h2><span id="example-application">Example application</span></h2><p>I will take a nice Todo application from blog post <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-react-to-do-app-with-react-hooks" target="_blank" rel="noopener">How To Build a React To-Do App with React Hooks</a> as the starting point. You can see this application yourself at its original <a href="https://codesandbox.io/s/oj3qm2zq06" target="_blank" rel="noopener">https://codesandbox.io/s/oj3qm2zq06</a> URL.</p><p><img src="/blog/images/components/app-code.png" alt="React Todo App"></p><p>I have downloaded the code from the sandbox to my repo <a href="https://github.com/bahmutov/react-todo-with-hooks" target="_blank" rel="noopener">https://github.com/bahmutov/react-todo-with-hooks</a>; it has a CSS file and two JS files - very compact example.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/repo</span><br><span class="line">  public/</span><br><span class="line">    index.html</span><br><span class="line">  src/</span><br><span class="line">    App.css</span><br><span class="line">    App.js</span><br><span class="line">    index.js</span><br><span class="line">  package.json</span><br></pre></td></tr></table></figure><p>The application is bundled and served using <a href="https://www.npmjs.com/package/react-scripts" target="_blank" rel="noopener">react-scripts</a> which is often used to serve modern React applications.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"react"</span>: <span class="string">"16"</span>,</span><br><span class="line">    <span class="attr">"react-dom"</span>: <span class="string">"16"</span>,</span><br><span class="line">    <span class="attr">"react-scripts"</span>: <span class="string">"3.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"react-scripts start"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"react-scripts build"</span>,</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"react-scripts test"</span>,</span><br><span class="line">    <span class="attr">"eject"</span>: <span class="string">"react-scripts eject"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="the-goal">The Goal</span></h2><p>I have noticed that the application allows us to mark Todo items as completed, but it never allows to &quot;undo&quot; completing an item. Once the task is done, there is no way to get it back to the initial incomplete state.</p><p><img src="/blog/images/components/complete.gif" alt="Completing an item cannot be undone"></p><p>I would like to change &quot;complete&quot; an item into &quot;toggle&quot; an item. But I don&#39;t know the code of the application, so it is dangerous to simply start hacking. We need tests first; and we want to make sure we test the entire application before changing its behavior.</p><h2><span id="adding-tests">Adding tests</span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress</span></span><br><span class="line">+ cypress@4.5.0</span><br></pre></td></tr></table></figure><p>Our first full end-to-end test goes through a typical user story.</p><figure class="highlight js"><figcaption><span>cypress/integration/todo-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="cypress" /&gt;</span></span><br><span class="line">describe(<span class="string">'Todo App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'completes an item'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// base url is stored in "cypress.json" file</span></span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">    <span class="comment">// there are several existing todos</span></span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br><span class="line">    cy.log(<span class="string">'**adding a todo**'</span>)</span><br><span class="line">    cy.get(<span class="string">'.input'</span>).type(<span class="string">'write tests&#123;enter&#125;'</span>)</span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    cy.log(<span class="string">'**completing a todo**'</span>)</span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'write tests'</span>).contains(<span class="string">'button'</span>, <span class="string">'Complete'</span>).click()</span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'write tests'</span>)</span><br><span class="line">      .should(<span class="string">'have.css'</span>, <span class="string">'text-decoration'</span>, <span class="string">'line-through solid rgb(74, 74, 74)'</span>)</span><br><span class="line"></span><br><span class="line">    cy.log(<span class="string">'**removing a todo**'</span>)</span><br><span class="line">    <span class="comment">// due to quarantine, we have to delete an item</span></span><br><span class="line">    <span class="comment">// without completing it</span></span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'Meet friend for lunch'</span>).contains(<span class="string">'button'</span>, <span class="string">'x'</span>).click()</span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'Meet friend for lunch'</span>).should(<span class="string">'not.exist'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs and passes</p><p><img src="/blog/images/components/e2e-test.gif" alt="Full Cypress end-to-end test"></p><h2><span id="code-coverage">Code coverage</span></h2><p>Did we test all code paths in our application? The simplest way for us to find out is to measure how much of the application&#39;s code was executed by running this one e2e test. We can follow the <a href="https://on.cypress.io/code-coverage" target="_blank" rel="noopener">Cypress Code Coverage Guide</a> to set up coverage reporting.</p><center>  <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/edgeQZ8UpD0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><ol><li>Instrument the application&#39;s code while running. For any application that uses <code>react-scripts</code> we can use module <a href="https://github.com/cypress-io/instrument-cra" target="_blank" rel="noopener">cypress-io/instrument-cra</a> to do so on the fly.</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D @cypress/instrument-cra</span></span><br><span class="line">+ @cypress/instrument-cra@1.1.0</span><br></pre></td></tr></table></figure><p>When we start the application, we preload this module first - and we will have application&#39;s code instrumented.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"react-scripts -r @cypress/instrument-cra start"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>We need to add <a href="https://github.com/cypress-io/code-coverage" target="_blank" rel="noopener">@cypress/code-coverage</a> to Cypress to merge coverage from tests and save report</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D @cypress/code-coverage</span></span><br><span class="line">+ @cypress/code-coverage@3.1.0</span><br></pre></td></tr></table></figure><p>This plugin should be loaded from the support and plugins files</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'@cypress/code-coverage/support'</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/task'</span>)(on, config)</span><br><span class="line">  <span class="comment">// IMPORTANT to return the config object</span></span><br><span class="line">  <span class="comment">// with the any changed environment variables</span></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Start Cypress again and run the test. You see &quot;Saving coverage from ...&quot; and &quot;Coverage report&quot; messages at the end of the run.</p><p><img src="/blog/images/components/code-coverage-messages.png" alt="Code coverage messages"></p><p>In the folder <code>coverage</code> you will find the report in several formats, let&#39;s open the static HTML one</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> open coverage/lcov-report/index.html</span></span><br></pre></td></tr></table></figure><p>Our single end-to-end test was <em>very effective</em> at covering almost all lines of the application.</p><p><img src="/blog/images/components/code-coverage.png" alt="Total code coverage"></p><p>We can drill down into individual file coverage.</p><p><img src="/blog/images/components/code-coverage-app.png" alt="A single line missed"></p><h2><span id="component-test">Component test</span></h2><p>The line we missed is inside <code>TodoForm</code> component, and it is kind of hard to confirm its behavior. We can easily write an end-to-end test that tries to &quot;enter&quot; empty input.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'input'</span>).type(<span class="string">'&#123;enter&#125;'</span>)</span><br><span class="line"><span class="comment">// there are still 3 todos</span></span><br><span class="line">cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>BUT it does not confirm the property <code>addTodo</code> is not called at all. We really want to test the component, not the entire application.</p><p>Let&#39;s write a component test.</p><ol><li>Install <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test v4+</a></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress-react-unit-test</span></span><br><span class="line">+ @cypress-react-unit-test@4.0.0</span><br></pre></td></tr></table></figure><ol start="2"><li>In <code>cypress.json</code> enable <a href="https://on.cypress.io/experimental" target="_blank" rel="noopener">experimental Cypress feature</a></li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">  <span class="attr">"testFiles"</span>: <span class="string">"**/*spec.js"</span>,</span><br><span class="line">  <span class="attr">"experimentalComponentTesting"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"componentFolder"</span>: <span class="string">"src"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>While end-to-end tests reside by default in <code>cypress/integration</code> folder, let&#39;s place component tests right alongside the source code in <code>src</code> folder. We will filter the spec files using <code>&quot;testFiles&quot;: &quot;**/*spec.js&quot;</code> parameter.</p><ol start="3"><li>Load <code>cypress-react-unit-test</code> from the support and plugins files</li></ol><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/plugins/cra-v3'</span>)(on, config)</span><br><span class="line">  <span class="comment">// IMPORTANT to return the config object</span></span><br><span class="line">  <span class="comment">// with the any changed environment variables</span></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Unlike end-to-end tests, the component specs must be bundled the same way as the application code is. Thus we have added <a href="https://github.com/bahmutov/cypress-react-unit-test/blob/master/docs/recipes.md" target="_blank" rel="noopener">multiple plugins helpers</a> that find and use the bundling options your application is using. In this case, Cypress will find the Webpack config from <code>react-scripts</code> module and will use it.</p><p>Let&#39;s write component test!</p><figure class="highlight js"><figcaption><span>src/TodoForm.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span></span><br><span class="line"><span class="keyword">import</span> &#123;TodoForm&#125; <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'TodoForm'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'ignores empty input'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> addTodo = cy.stub()</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">TodoForm</span> <span class="attr">addTodo</span>=<span class="string">&#123;addTodo&#125;</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.get('input').type('&#123;enter&#125;')</span></span><br><span class="line"><span class="xml">    .then(() =&gt; &#123;</span></span><br><span class="line"><span class="xml">      expect(addTodo).not.have.been.called</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    cy.get('input').type('hello there&#123;enter&#125;')</span></span><br><span class="line"><span class="xml">    .then(() =&gt; &#123;</span></span><br><span class="line"><span class="xml">      expect(addTodo).to.be.calledWith('hello there')</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The component test directly imports <code>TodoForm</code> from the application code and mounts it using <code>mount</code> method from the <code>cypress-react-unit-test</code>. Once the component is mounted, it runs as a &quot;mini&quot; web application. We can use normal Cypress commands against it! Think of <code>mount</code> as <code>cy.visit</code> for components.</p><p><img src="/blog/images/components/todo-form-test.gif" alt="TodoForm component test"></p><p>You can see the component run inside Cypress iframe (where a regular web application usually runs during end-to-end test). You can interact with the component, inspect it using DevTools, see how it behaves using time-traveling debugger - all Cypress benefits apply both to end-to-end tests and to component tests. Plus code coverage is included by default!</p><h2><span id="styles">Styles</span></h2><p>When mounting a component, you might want to apply additional styles to make it look the same as in real application. The <code>mount</code> <a href="https://github.com/bahmutov/cypress-react-unit-test#options" target="_blank" rel="noopener">command options</a> let you specify inline style, CSS filename or external stylesheets. For example, here is the <code>Todo</code> component test.</p><figure class="highlight js"><figcaption><span>src/Todo.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Todo&#125; <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line">it(<span class="string">'renders new item'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    text: <span class="string">'test item'</span>,</span><br><span class="line">    isCompleted: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// application loads Bulma library from public/index.html</span></span><br><span class="line">  <span class="comment">// so let's load it from the component test too</span></span><br><span class="line">  mount(</span><br><span class="line">    &lt;Todo todo=&#123;todo&#125; /&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">      stylesheets: [</span><br><span class="line">        <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.todo button'</span>, <span class="string">'Complete'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/todo1.png" alt="First Todo test"></p><p>The buttons looks &quot;normal&quot;, but the entire component still does not look the same - because our styles come from <code>src/App.css</code> and require certain DOM structure. Let&#39;s recreate the structure and load additional CSS file in our test.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'renders with styles'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    text: <span class="string">'test item'</span>,</span><br><span class="line">    isCompleted: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> TestTodo = <span class="function"><span class="params">()</span> =&gt;</span> &lt;div className=<span class="string">"app"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">Todo</span> <span class="attr">todo</span>=<span class="string">&#123;todo&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  mount(</span><br><span class="line">    &lt;TestTodo /&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">      stylesheets: [</span><br><span class="line">        <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">      ],</span><br><span class="line">      cssFile: <span class="string">'src/App.css'</span></span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.todo button'</span>, <span class="string">'Complete'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/todo2.png" alt="Second Todo test"></p><p>Looks good.</p><h2><span id="testing-the-interface">Testing the interface</span></h2><p>As I <a href="https://www.youtube.com/watch?v=5FnalKRjpZk&amp;amp=&amp;t=0s&amp;amp=&amp;index=5" target="_blank" rel="noopener">argued before</a> - a component test is just a unit test where props are inputs and side effects like DOM, network calls, etc are outputs. Let&#39;s confirm that Todo component calls the <code>removeTodo</code> prop when the user clicks &quot;Remove&quot; button.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'deletes an item'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    text: <span class="string">'test item'</span>,</span><br><span class="line">    isCompleted: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> removeTodo = cy.stub().as(<span class="string">'remove'</span>)</span><br><span class="line"></span><br><span class="line">  mount(</span><br><span class="line">    &lt;Todo todo=&#123;todo&#125; index=&#123;<span class="number">123</span>&#125; removeTodo=&#123;removeTodo&#125; /&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">      stylesheets: [</span><br><span class="line">        <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.todo'</span>, <span class="string">'test item'</span>)</span><br><span class="line">    .find(<span class="string">'[data-cy="remove"]'</span>).click()</span><br><span class="line">  cy.get(<span class="string">'@remove'</span>).should(<span class="string">'have.been.calledWith'</span>, <span class="number">123</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/todo3.png" alt="Removing todo"></p><h2><span id="graphql-example">GraphQL example</span></h2><p>Notice how we directly passed a stub into the component as a property - because the component &quot;lives&quot; right inside the spec. By having direct access to the component, you can do amazing things - like combine mock and live GraphQL calls, see <a href="https://github.com/bahmutov/test-apollo" target="_blank" rel="noopener">bahmutov/test-apollo</a></p><figure class="highlight js"><figcaption><span>test-apollo/src/Library.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Library, GET_BOOKS&#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; MockedProvider &#125; <span class="keyword">from</span> <span class="string">'@apollo/react-testing'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// mocking GraphQL requests using</span></span><br><span class="line"><span class="comment">// https://www.apollographql.com/docs/react/development-testing/testing/#mockedprovider</span></span><br><span class="line">describe(<span class="string">'Library'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.fixture(<span class="string">'books'</span>).as(<span class="string">'books'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'shows loading while making the query'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// delays the response by 3 seconds</span></span><br><span class="line">    <span class="keyword">const</span> mocks = [</span><br><span class="line">      &#123;</span><br><span class="line">        request: &#123;</span><br><span class="line">          query: GET_BOOKS</span><br><span class="line">        &#125;,</span><br><span class="line">        result: <span class="keyword">this</span>.books,</span><br><span class="line">        delay: <span class="number">3000</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">    mount(</span><br><span class="line">      &lt;MockedProvider mocks=&#123;mocks&#125; addTypename=&#123;<span class="literal">false</span>&#125;&gt;</span><br><span class="line">        &lt;Library /&gt;</span><br><span class="line">      &lt;<span class="regexp">/MockedProvider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 😀 compare declarative testing vs promise waits in</span></span><br><span class="line">    // https://www.apollographql.com/docs/react/development-testing/testing/#testing-final-state</span><br><span class="line">    cy.contains(<span class="string">'Loading ...'</span>).should(<span class="string">'be.visible'</span>)</span><br><span class="line">    cy.get(<span class="string">'[data-cy=book]'</span>).should(<span class="string">'have.length'</span>, <span class="number">2</span>)</span><br><span class="line">    cy.contains(<span class="string">'Loading ...'</span>).should(<span class="string">'not.exist'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/graphql-test.gif" alt="Mocking GraphQL with delay component test"></p><h2><span id="components-all-the-way-down">Components all the way down</span></h2><p>Component testing can work with components of any size. We have tested <code>TodoForm</code> and <code>Todo</code> components, let&#39;s test the top-level <code>App</code> component.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    mount(</span><br><span class="line">      &lt;App /&gt;,</span><br><span class="line">      &#123;</span><br><span class="line">        stylesheets: [</span><br><span class="line">          <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works'</span>, () =&gt; &#123;</span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br><span class="line">    cy.get(<span class="string">'input.input'</span>).type(<span class="string">'Test with Cypress&#123;enter&#125;'</span>)</span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">4</span>)</span><br><span class="line">      .contains(<span class="string">'Meet friend for lunch'</span>)</span><br><span class="line">      .find(<span class="string">'[data-cy=remove]'</span>).click()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs and looks ... almost like the complete application!</p><p><img src="/blog/images/components/app-test.gif" alt="App component test"></p><p>Component testing gives you a flexibility over the scope of the code you want to test. In addition to testing your application as a whole via end-to-end tests you can test a subset of the application &quot;tree&quot;. If your application has the top level authentication that is hard to bypass from an end-to-end test - you can test the component that sits right under the authentication provider.</p><p>Finally, while we are testing components, let&#39;s test a few functions using unit tests. While this was always possible in Cypress, component testing mounting mode makes it much closer to testing the real code, because bundling the component spec is done using your application&#39;s settings.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> App, &#123;toggleOneTodo&#125; <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'toggles correctly'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> todos = [&#123;</span><br><span class="line">      isCompleted: <span class="literal">false</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      isCompleted: <span class="literal">false</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      isCompleted: <span class="literal">false</span></span><br><span class="line">    &#125;]</span><br><span class="line">    <span class="keyword">const</span> newTodos = toggleOneTodo(todos, <span class="number">2</span>)</span><br><span class="line">    expect(newTodos).to.deep.equal([&#123;</span><br><span class="line">        isCompleted: <span class="literal">false</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        isCompleted: <span class="literal">false</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        isCompleted: <span class="literal">true</span></span><br><span class="line">      &#125;])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>From the smallest units of code to the largest components - you control the scale of <em>what</em> you want to test.</p><h2><span id="benefits">Benefits</span></h2><p>In my completely biased personal opinion, Cypress component testing using the real browser has many advantages</p><table><thead><tr><th>Feature</th><th>Cypress + <code>cypress-X-unit-test</code></th></tr></thead><tbody><tr><td>Test runs in real browser</td><td>✅</td></tr><tr><td>Cross-platform</td><td>Chrome / Firefox / Microsoft Edge</td></tr><tr><td>Uses full mount</td><td>✅</td></tr><tr><td>Test speed</td><td>as fast as the app works in the browser</td></tr><tr><td>Test can use additional plugins</td><td>use any <a href="https://on.cypress.io/plugins" target="_blank" rel="noopener">Cypress plugin</a></td></tr><tr><td>Test can interact with component</td><td>use any <a href="https://on.cypress.io/api" target="_blank" rel="noopener">Cypress command</a></td></tr><tr><td>Debugging</td><td>use browser DevTools, Cypress time-traveling debugger</td></tr><tr><td>Re-run tests on file or test change</td><td>✅</td></tr><tr><td>Test output on CI</td><td>terminal, screenshots, videos</td></tr><tr><td>Tests can be run in parallel</td><td>✅ via <a href="https://on.cypress.io/parallelization" target="_blank" rel="noopener">parallelization</a></td></tr><tr><td>Test against interface</td><td>✅ and can use <code>@testing-library/cypress</code></td></tr><tr><td>Spying and mocking</td><td>Sinon library</td></tr><tr><td>Code coverage</td><td>✅</td></tr><tr><td>Visual testing</td><td>✅ via <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">visual plugins</a></td></tr></tbody></table><h2><span id="examples">Examples</span></h2><p>We have forked a number of 3rd party projects to confirm component testing works.</p><table><thead><tr><th>Repo</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://github.com/bahmutov/try-cra-with-unit-test" target="_blank" rel="noopener">try-cra-with-unit-test</a></td><td>Hello world initialized with CRAv3</td></tr><tr><td><a href="https://github.com/bahmutov/try-cra-app-typescript" target="_blank" rel="noopener">try-cra-app-typescript</a></td><td>Hello world initialized with CRAv3 <code>--typescript</code></td></tr><tr><td><a href="https://github.com/bahmutov/react-todo-with-hooks" target="_blank" rel="noopener">react-todo-with-hooks</a></td><td>Modern web application using hooks</td></tr><tr><td><a href="https://github.com/bahmutov/test-redux-examples" target="_blank" rel="noopener">test-redux-examples</a></td><td>Example apps copies from official Redux repo and tested as components</td></tr><tr><td><a href="https://github.com/bahmutov/test-react-hooks-animations" target="_blank" rel="noopener">test-react-hooks-animations</a></td><td>Testing React springs fun blob animation</td></tr><tr><td><a href="https://github.com/bahmutov/test-mdx-example" target="_blank" rel="noopener">test-mdx-example</a></td><td>Example testing MDX components using Cypress</td></tr><tr><td><a href="https://github.com/bahmutov/test-apollo" target="_blank" rel="noopener">test-apollo</a></td><td>Component testing an application that uses Apollo GraphQL library</td></tr><tr><td><a href="https://github.com/bahmutov/test-xstate-react" target="_blank" rel="noopener">test-xstate-react</a></td><td>XState component testing using Cypress</td></tr><tr><td><a href="https://github.com/bahmutov/test-react-router-v5" target="_blank" rel="noopener">test-react-router-v5</a></td><td>A few tests of React Router v5</td></tr><tr><td><a href="https://github.com/bahmutov/test-material-ui" target="_blank" rel="noopener">test-material-ui</a></td><td>Testing Material UI components: date pickers, lists, autocomplete</td></tr><tr><td><a href="https://github.com/bahmutov/test-d3-react-gauge" target="_blank" rel="noopener">test-d3-react-gauge</a></td><td>Testing React D3 gauges</td></tr><tr><td><a href="https://github.com/bahmutov/storybook-code-coverage" target="_blank" rel="noopener">storybook-code-coverage</a></td><td>Example app where we get 100% code coverage easily with a single integration spec and a few component specs, replacing <a href="https://dev.to/penx/combining-storybook-cypress-and-jest-code-coverage-4pa5" target="_blank" rel="noopener">several tools</a></td></tr><tr><td><a href="https://github.com/bahmutov/react-loading-skeleton" target="_blank" rel="noopener">react-loading-skeleton</a></td><td>One to one Storybook tests for React skeleton components. Uses local <code>.babelrc</code> settings without Webpack config</td></tr><tr><td><a href="https://github.com/bahmutov/test-swr" target="_blank" rel="noopener">test-swr</a></td><td>Component test for <a href="https://github.com/zeit/swr" target="_blank" rel="noopener">Zeit SWR</a> hooks for remote data fetching</td></tr></tbody></table><p>To find more examples, see GitHub topic <a href="https://github.com/topics/cypress-react-unit-test-example" target="_blank" rel="noopener">cypress-react-unit-test-example</a></p><h2><span id="future-plans">Future plans</span></h2><p>We have already released new versions of <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> and <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> and plan to upgrade other framework adaptors (Angular, Svelte, etc) to be compatible with <code>experimentalComponentTesting: true</code> mode.</p><h2><span id="thank-you">Thank you</span></h2><p>Special thank you 👏 to <a href="https://twitter.com/dmtrKovalenko" target="_blank" rel="noopener">Dmitriy Kovalenko @dmtrKovalenko</a> for making Cypress Test Runner and React adaptor work through these PRs <a href="https://github.com/cypress-io/cypress/pull/5923" target="_blank" rel="noopener">#5923</a> and <a href="https://github.com/bahmutov/cypress-react-unit-test/pull/108" target="_blank" rel="noopener">#108</a>. They have removed the technical limitations that prevented React Hooks, component styles and other features from working correctly inside the component tests.</p><p>Another big shout out goes to <a href="https://twitter.com/_JessicaSachs" target="_blank" rel="noopener">Jessica Sachs @_JessicaSachs</a> for working on component testing support in <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> 👏.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#example-application&quot;&gt;Example application&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-goal&quot;&gt;The Goal&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Cleaning Up Space on Development Machine</title>
    <link href="https://glebbahmutov.com/blog/cleaning-up-space/"/>
    <id>https://glebbahmutov.com/blog/cleaning-up-space/</id>
    <published>2020-04-10T04:00:00.000Z</published>
    <updated>2020-04-09T15:48:22.684Z</updated>
    
    <content type="html"><![CDATA[<p>If you run out of space on your development machine, you probably have old Docker images sitting around, a giant number of <code>node_modules</code> and maybe a number of old versions of Cypress test runner that you don&#39;t need anymore. Let&#39;s clean everything up.</p><h2><span id="pruning-docker">Pruning Docker</span></h2><p>Let&#39;s <a href="https://docs.docker.com/config/pruning/" target="_blank" rel="noopener">prune Docker images</a> first. You can see how many images you have locally and how much space each takes with</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker images</span><br></pre></td></tr></table></figure><p>We can remove all image not currently used that were created more than 24 hours ago:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker image prune -a --filter <span class="string">"until=24h"</span></span><br><span class="line">WARNING! This will remove all images without at least one container associated to them.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br><span class="line"></span><br><span class="line">Deleted Images:</span><br><span class="line">untagged: node:12.4.0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Total reclaimed space: 31.17GB</span><br></pre></td></tr></table></figure><p>Next you want to look at the stopped Docker containers - they are NOT deleted by default.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br></pre></td></tr></table></figure><p>Remove them</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker container prune</span><br><span class="line">WARNING! This will remove all stopped containers.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br><span class="line">...</span><br><span class="line">Total reclaimed space: 8.155GB</span><br></pre></td></tr></table></figure><h2><span id="cleaning-node_modules">Cleaning node_modules</span></h2><p>NPM node modules are like a black hole - they weigh a lot and nothing escapes. You can quickly see how much they take on your disk using <a href="https://github.com/voidcosmos/npkill" target="_blank" rel="noopener">npkill</a> utility.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -g npkill</span><br><span class="line"><span class="comment"># run npkill from the root folder or from the folder with</span></span><br><span class="line"><span class="comment"># projects that have node_modules</span></span><br><span class="line">$ npkill</span><br></pre></td></tr></table></figure><h2><span id="remove-old-folders">Remove old folders</span></h2><p>You can list the folders by the last access time with:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ltu</span><br><span class="line">total 696</span><br><span class="line">-rw-r--r--   1 gleb  staff  344501 Apr  9 11:02 the-dark-knight.css</span><br><span class="line">drwxr-xr-x  39 gleb  staff    1248 Apr  9 11:02 webamp</span><br><span class="line">drwxr-xr-x  22 gleb  staff     704 Apr  9 11:02 circleci-orb</span><br><span class="line">drwxr-xr-x  41 gleb  staff    1312 Apr  9 11:02 cypress-services</span><br><span class="line">drwxr-xr-x  11 gleb  staff     352 Apr  9 11:02 try-percy-agent-as-npm-module</span><br><span class="line">drwxr-xr-x  15 gleb  staff     480 Apr  9 11:02 <span class="built_in">test</span>-react-router-v5</span><br><span class="line">drwxr-xr-x  14 gleb  staff     448 Apr  9 11:02 hasura-example</span><br><span class="line">drwxr-xr-x  19 gleb  staff     608 Apr  9 11:02 cypress-vue-unit-test</span><br><span class="line">...</span><br><span class="line">drwxr-xr-x  18 gleb  staff     576 Mar 26  2019 cypress-angular-unit-test</span><br><span class="line">drwxr-xr-x   2 gleb  staff      64 Mar 26  2019 cypress-blog-tests</span><br><span class="line">drwxr-xr-x   6 gleb  staff     192 Mar 26  2019 cypress-colors</span><br><span class="line">drwxr-xr-x  18 gleb  staff     576 Mar 26  2019 cypress-core-marta</span><br><span class="line">drwxr-xr-x  12 gleb  staff     384 Mar 26  2019 cypress-credentials</span><br><span class="line">drwxr-xr-x  11 gleb  staff     352 Mar 26  2019 cypress-dark-example</span><br></pre></td></tr></table></figure><p>You can probably delete the last folders - since you only accessed them a very long time ago.</p><h2><span id="folder-size">Folder size</span></h2><p>On Mac I really enjoy using <code>du</code> utility. For example, you can see the total folder size or top level plus first sublevel</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># print just the total "github-action" folder size in human format (Megabytes)</span></span><br><span class="line">$ du -h -d 0 github-action</span><br><span class="line">459Mgithub-action</span><br><span class="line"></span><br><span class="line"><span class="comment"># print the total size of the folder "github-action"</span></span><br><span class="line"><span class="comment"># and sizes of its immediate subfolders</span></span><br><span class="line">$ du -h -d 1 github-action</span><br><span class="line">1.4Mgithub-action/dist</span><br><span class="line">228Kgithub-action/images</span><br><span class="line"> 60Mgithub-action/node_modules</span><br><span class="line">377Mgithub-action/examples</span><br><span class="line"> 40Kgithub-action/.github</span><br><span class="line"> 21Mgithub-action/.git</span><br><span class="line">4.0Kgithub-action/.vscode</span><br><span class="line">459Mgithub-action</span><br></pre></td></tr></table></figure><h2><span id="mac-users-tip">Mac users tip</span></h2><p>In Finder you can select and permanently delete files (without going through the Trash app) using <code>Option</code> + <code>Command</code> + <code>Delete</code> combination.</p><p>From the terminal I recommend using <a href="https://github.com/sindresorhus/trash-cli" target="_blank" rel="noopener">trash-cli</a> that is safer to use than <code>rm</code>. <code>trash-cli</code> moves files to Trash so they can be restored.</p><h2><span id="cleaning-old-cypress-binaries">Cleaning old Cypress binaries</span></h2><p>Every time you install Cypress with <code>npm install cypress</code> it downloads NPM package <code>cypress</code> and stores it in the local <code>node_modules</code> folder. Then this NPM package runs its post-install script which checks if you need to download version <code>x.y.z</code> of the Cypress Electron-built binary. These binaries are stored in a central place on your machine to avoid re-downloading the same binary version again and again.</p><p>You can see where the binaries are stored:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/git/cypress-example-todomvc-redux on master</span><br><span class="line">$ npx cypress cache path</span><br><span class="line">/Users/gleb/Library/Caches/Cypress</span><br></pre></td></tr></table></figure><p>And the cached versions</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ npx cypress cache list</span><br><span class="line">┌─────────┬──────────────┐</span><br><span class="line">│ version │ last used    │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.0.1   │ 2 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.0.2   │ 6 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.0.3   │ 2 years ago  │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.2.0   │ 3 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.4.0   │ 6 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.4.1   │ 13 days ago  │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.5.0   │ 5 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">...</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 4.2.1   │ 10 days ago  │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 4.3.0   │ 4 days ago   │</span><br><span class="line">└─────────┴──────────────┘</span><br></pre></td></tr></table></figure><p>Unfortunately, Cypress NPM modules does not have <a href="https://github.com/cypress-io/cypress/issues/5972" target="_blank" rel="noopener"><code>cypress cache prune</code> command yet</a>, so you would need to delete the old folders manually. Let&#39;s see the folders - they are all named <code>/path/to/cache/x.y.z</code>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ltu /Users/gleb/Library/Caches/Cypress</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x  4 gleb  staff  128 Apr  9 10:46 4.2.1</span><br><span class="line">drwxr-xr-x  5 gleb  staff  160 Apr  6 19:23 3.8.2</span><br><span class="line">drwxr-xr-x  4 gleb  staff  128 Mar 31 14:26 4.3.0</span><br><span class="line">drwxr-xr-x  4 gleb  staff  128 Mar 16 17:07 4.2.0</span><br><span class="line">...</span><br><span class="line">drwxr-xr-x  3 gleb  staff   96 Mar 15  2019 3.2.0</span><br><span class="line">drwxr-xr-x  3 gleb  staff   96 Jul  9  2018 3.0.2</span><br><span class="line">drwxr-xr-x  3 gleb  staff   96 Jun  3  2018 3.0.1</span><br></pre></td></tr></table></figure><p>Each folder is quite large - unzipped Cypress is big!</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ du -h -d 0 /Users/gleb/Library/Caches/Cypress/4.0.0</span><br><span class="line">546M/Users/gleb/Library/Caches/Cypress/4.0.0</span><br></pre></td></tr></table></figure><p>Let&#39;s remove all cached Cypress v3 versions - that should free up some space!</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf /Users/gleb/Library/Caches/Cypress/3*</span><br></pre></td></tr></table></figure><p>Much better.</p><p><strong>Tip:</strong> if you need to re-install a Cypress binary version you have just deleted, run this command from the project that installed it:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx cypress install</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;If you run out of space on your development machine, you probably have old Docker images sitting around, a giant number of &lt;code&gt;node_mod
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="nodejs" scheme="https://glebbahmutov.com/blog/tags/nodejs/"/>
    
      <category term="docker" scheme="https://glebbahmutov.com/blog/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>How To Update Only Some Dependencies Using Renovate App</title>
    <link href="https://glebbahmutov.com/blog/whitelist-renovate/"/>
    <id>https://glebbahmutov.com/blog/whitelist-renovate/</id>
    <published>2020-03-31T04:00:00.000Z</published>
    <updated>2020-03-31T17:25:17.869Z</updated>
    
    <content type="html"><![CDATA[<p>I have a common situation - in an example repo like <a href="https://github.com/cypress-io/netlify-plugin-cypress-example" target="_blank" rel="noopener">https://github.com/cypress-io/netlify-plugin-cypress-example</a> we have lots of dependencies, but we are interested only in keeping <em>our Cypress</em> dependencies up to date. In this blog post I will show how to disable all package dependencies and then whitelist just a few ones to be checked.</p><p>I have set up repository <a href="https://github.com/bahmutov/renovate-update-single-module-example" target="_blank" rel="noopener">bahmutov/renovate-update-single-module-example</a> to show this in action. There are 2 dependencies: <code>debug</code> and <code>chalk</code>, but I am only interested in keeping <code>debug</code> up-to-date. Here is the full <a href="https://github.com/bahmutov/renovate-update-single-module-example/blob/master/renovate.json" target="_blank" rel="noopener">renovate.json</a> file</p><figure class="highlight json"><figcaption><span>renovate.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"config:base"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"enabledManagers"</span>: [<span class="string">"npm"</span>],</span><br><span class="line">  <span class="attr">"packageRules"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"packagePatterns"</span>: [<span class="string">"*"</span>],</span><br><span class="line">      <span class="attr">"excludePackagePatterns"</span>: [<span class="string">"debug"</span>],</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Thus we disable all package updates, except <code>debug</code> using <a href="https://docs.renovatebot.com/configuration-options/#excludepackagepatterns" target="_blank" rel="noopener">excludePackagePatterns</a> option, found in <a href="https://docs.renovatebot.com/" target="_blank" rel="noopener">Renovate Docs</a>.</p><p>If we go to <a href="https://app.renovatebot.com/dashboard" target="_blank" rel="noopener">Renovate Dashboard</a> (access is private to the owner of the Renovate app) we can see our check jobs.</p><p><img src="/blog/images/whitelist-renovate/dashboard.png" alt="Renovate Dashboard"></p><p>Click on any build, and in the DEBUG logs you can search for a module and see if it was disabled.</p><p><img src="/blog/images/whitelist-renovate/disabled.png" alt="Disabled chalk module"></p><h2><span id="read-more">Read more</span></h2><ul><li><a href="https://glebbahmutov.com/blog/zeit-now-renovate-and-app/">Zeit Now GitHub app + Renovate app + Cypress tests = 💝</a></li><li><a href="https://glebbahmutov.com/blog/renovate-app/">Painless Dependency Upgrades with Renovate App</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I have a common situation - in an example repo like &lt;a href=&quot;https://github.com/cypress-io/netlify-plugin-cypress-example&quot; target=&quot;_blank
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="renovate" scheme="https://glebbahmutov.com/blog/tags/renovate/"/>
    
  </entry>
  
  <entry>
    <title>Example CI configs</title>
    <link href="https://glebbahmutov.com/blog/example-ci-configs/"/>
    <id>https://glebbahmutov.com/blog/example-ci-configs/</id>
    <published>2020-03-30T04:00:00.000Z</published>
    <updated>2020-05-27T16:05:16.827Z</updated>
    
    <content type="html"><![CDATA[<p>Each snippet typically installs dependencies (with caching), runs tests and publishes new version to NPM and GitHub using <a href="https://github.com/semantic-release/semantic-release" target="_blank" rel="noopener">semantic-release</a>.</p><h2><span id="github-actions">GitHub Actions</span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Install</span> <span class="string">NPM</span> <span class="string">dependencies</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Run</span> <span class="string">tests</span> <span class="string">🧪</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Show</span> <span class="string">GitHub</span> <span class="string">variables</span> <span class="string">📊</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">github-demo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Semantic</span> <span class="string">Release</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cycjimmy/semantic-release-action@v2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          NPM_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.NPM_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Example repositories <a href="https://github.com/bahmutov/print-env" target="_blank" rel="noopener">print-env</a>, <a href="https://github.com/bahmutov/make-empty-github-commit" target="_blank" rel="noopener">make-empty-github-commit</a>.</p><p>Read more about GitHub Actions in <a href="../trying-github-actions/">Trying GitHub Actions</a> blog post. If you are doing Cypress End-to-end tests, I recommend using <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">Cypress GitHub Action</a></p><h2><span id="circleci">CircleCI</span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"><span class="attr">orbs:</span></span><br><span class="line">  <span class="comment"># Circle Node orb makes it simple to cache dependencies</span></span><br><span class="line">  <span class="comment"># https://circleci.com/orbs/registry/orb/circleci/node</span></span><br><span class="line"><span class="attr">  node:</span> <span class="string">circleci/node@1.1</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    executor:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">node/default</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">'12'</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">checkout</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node/with-cache:</span></span><br><span class="line"><span class="attr">          steps:</span></span><br><span class="line"><span class="attr">            - run:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">install</span> <span class="string">dependencies</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">                command:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">run</span> <span class="string">tests</span> <span class="string">🧪</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">e2e</span></span><br><span class="line"><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">NPM</span> <span class="string">publish</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">semantic-release</span></span><br></pre></td></tr></table></figure><p>Example repositories <a href="https://github.com/bahmutov/term-to-html" target="_blank" rel="noopener">term-to-html</a></p><p>If you are doing Cypress End-to-end tests, I recommend using <a href="https://github.com/cypress-io/circleci-orb" target="_blank" rel="noopener">Cypress CircleCI Orb</a></p><h2><span id="emoji">Emoji</span></h2><p>In the code samples above I am using emoji to quickly see each step.</p><table><thead><tr><th>Emoji</th><th>Step</th></tr></thead><tbody><tr><td><h3><span id>🛎</span></h3></td><td>Code check out from the repo</td></tr><tr><td><h3><span id>📦</span></h3></td><td>Installing and caching dependencies</td></tr><tr><td><h3><span id>🧹</span></h3></td><td>Linting source code</td></tr><tr><td><h3><span id>🧩</span></h3></td><td>Checking types, for example using <code>tsc --noEmit</code></td></tr><tr><td><h3><span id>💅</span></h3></td><td>Running <a href="./configure-prettier-in-vscode/">Prettier formatter</a></td></tr><tr><td><h3><span id>🚦</span></h3></td><td>Some sanity check before continuing</td></tr><tr><td><h3><span id>🏗</span></h3></td><td>Building application</td></tr><tr><td><h3><span id>🚛</span></h3></td><td>Moving or preparing application</td></tr><tr><td><h3><span id>🗑</span></h3></td><td>Delete file or folder</td></tr><tr><td><h3><span id>🧪</span></h3></td><td>Running tests</td></tr><tr><td><h3><span id>💨</span></h3></td><td>Running smoke tests</td></tr><tr><td><h3><span id>📊</span></h3></td><td>Running a demo step</td></tr><tr><td><h3><span id>📈</span></h3></td><td>Check code coverage</td></tr><tr><td><h3><span id>🚀</span></h3></td><td>Releasing a new version</td></tr></tbody></table><p>Here is how it looks in GitHub Actions</p><p><img src="/blog/images/ci-configs/gh-passed.png" alt="Emoji in GitHub Actions"></p><p><strong>Note:</strong> please do not use emoji in the <em>job names</em> - otherwise your GitHub commit status checks will <a href="https://github.community/t5/How-to-use-Git-and-GitHub/Emojicon-Unicode-symbols-are-not-supported-in-commit-status/td-p/5435" target="_blank" rel="noopener">stop working</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Each snippet typically installs dependencies (with caching), runs tests and publishes new version to NPM and GitHub using &lt;a href=&quot;https:
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="ci" scheme="https://glebbahmutov.com/blog/tags/ci/"/>
    
  </entry>
  
  <entry>
    <title>Testing Sentry Call with Cypress</title>
    <link href="https://glebbahmutov.com/blog/testing-sentry-with-cypress/"/>
    <id>https://glebbahmutov.com/blog/testing-sentry-with-cypress/</id>
    <published>2020-03-28T04:00:00.000Z</published>
    <updated>2020-03-29T23:17:45.493Z</updated>
    
    <content type="html"><![CDATA[<p>I love using <a href="https://sentry.io/welcome/" target="_blank" rel="noopener">Sentry</a> for tracking errors in my web applications. Recently I have added crash reporting to our open source <a href="https://github.com/350-mass-cambridge-somerville/350-actions-client" target="_blank" rel="noopener">350-mass-cambridge-somerville/350-actions-client</a> project in pull request <a href="https://github.com/350-mass-cambridge-somerville/350-actions-client/pull/24" target="_blank" rel="noopener">#24</a> - see the app at <a href="https://www.maclimateactions.com/" target="_blank" rel="noopener">https://www.maclimateactions.com/</a>.</p><p>The entire web application is tested using Cypress - let&#39;s validate that the app is sending a crash report to Sentry service using an end-to-end test too. Let&#39;s start a placeholder test that opens the app and does nothing.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'current action'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.server()</span><br><span class="line">    cy.route(<span class="string">'/actioncards/latest/'</span>, <span class="string">'fixture:latest'</span>)</span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">    <span class="comment">// check the page - should have info from the stubbed response</span></span><br><span class="line">    <span class="comment">// loaded from cypress/fixtures/latest.json</span></span><br><span class="line">    cy.contains(<span class="string">'Action Card 23'</span>).should(<span class="string">'be.visible'</span>)</span><br><span class="line">    cy.get(<span class="string">'[data-cy=action-check-display]'</span>).should(<span class="string">'have.length'</span>, <span class="number">6</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it.only(<span class="string">'sends an error to Sentry'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// TODO write test commands</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Once the test runs and stops, open the DevTools inside Cypress. Switch to the application&#39;s context using a drop down. A nice trick to throw an unhandled exception <em>in the application, and not in the DevTools</em> it to make it asynchronous - for example by using <code>setTimeout</code> function. You can do <code>setTimeout(() =&gt; { throw new Error(&#39;test error&#39;) }, 1000)</code> and see Sentry handler executing an XHR call.</p><p><img src="/blog/images/test-sentry/sentry-error.png" alt="Triggering an error manually"></p><p><strong>Note:</strong> by default, Sentry uses <code>fetch</code> protocol to send the error object to its service API. Since Cypress does not support stubbing <code>fetch</code> requests yet, we force every client-side library to drop down to XHR using the example from <a href="https://github.com/cypress-io/cypress-example-recipes#stubbing-and-spying" target="_blank" rel="noopener">&quot;Stubbing window.fetch&quot;</a> recipe. We simply delete the <code>window.fetch</code> property when every window is created.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> polyfill</span><br><span class="line"></span><br><span class="line"><span class="comment">// grab fetch polyfill from remote URL, could be also from a local package</span></span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> polyfillUrl = <span class="string">'https://unpkg.com/unfetch/dist/unfetch.umd.js'</span></span><br><span class="line"></span><br><span class="line">  cy.request(polyfillUrl).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    polyfill = response.body</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Cypress.on(<span class="string">'window:before:load'</span>, win =&gt; &#123;</span><br><span class="line">  <span class="keyword">delete</span> win.fetch</span><br><span class="line">  <span class="comment">// since the application code does not ship with a polyfill</span></span><br><span class="line">  <span class="comment">// load a polyfilled "fetch" from the test</span></span><br><span class="line">  win.eval(polyfill)</span><br><span class="line">  win.fetch = win.unfetch</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Let&#39;s confirm this call happens. We need to prepare to intercept the call from the test. Look at the call&#39;s details, especially at the method and the destination URL.</p><p><img src="/blog/images/test-sentry/error-details.png" alt="Sentry call details"></p><p>Also look at the response object the Sentry service sends back to the caller.</p><p><img src="/blog/images/test-sentry/sentry-response.png" alt="Sentry response object"></p><p>Let&#39;s stub this route using <a href="https://on.cypress.io/route" target="_blank" rel="noopener"><code>cy.route</code></a> command and response with similar object.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'sends an error to Sentry'</span>, () =&gt; &#123;</span><br><span class="line">  cy.route(<span class="string">'POST'</span>, <span class="string">'https://sentry.io/api/*/store/*'</span>, &#123;</span><br><span class="line">    id: <span class="string">'abc123'</span>,</span><br><span class="line">  &#125;).as(<span class="string">'sentry'</span>)</span><br><span class="line">  <span class="comment">// create an error, as if application has thrown it</span></span><br><span class="line">  cy.window().invoke(</span><br><span class="line">    <span class="string">'setTimeout'</span>,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'test error'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// confirm the call has happened</span></span><br><span class="line">  cy.wait(<span class="string">'@sentry'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs - and we can see the stubbed XHR call to Sentry correctly detected (and stopped)</p><p><img src="/blog/images/test-sentry/sentry-api-call.png" alt="The call to Sentry API does happen on error"></p><p>Great, but - a thrown error is still a thrown error, and Cypress treats is as a test failure. Thus we need to handle it as described in the blog post <a href="https://www.cypress.io/blog/2020/03/03/testing-edge-data-cases-with-network-stubbing-and-app-actions/" target="_blank" rel="noopener">Testing Edge Data Cases with Network Stubbing and App Actions</a>. We will expect <code>uncaught:exception</code> event and will confirm it has <em>our test error message</em> and not some other <em>actual application error</em>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'sends an error to Sentry'</span>, () =&gt; &#123;</span><br><span class="line">  cy.route(<span class="string">'POST'</span>, <span class="string">'https://sentry.io/api/*/store/*'</span>, &#123;</span><br><span class="line">    id: <span class="string">'abc123'</span>,</span><br><span class="line">  &#125;).as(<span class="string">'sentry'</span>)</span><br><span class="line"></span><br><span class="line">  cy.on(<span class="string">'uncaught:exception'</span>, e =&gt; &#123;</span><br><span class="line">    <span class="comment">// only ignore OUR test error message</span></span><br><span class="line">    <span class="keyword">return</span> e.message === <span class="string">'test error'</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create an error, as if application has thrown it</span></span><br><span class="line">  cy.window().invoke(</span><br><span class="line">    <span class="string">'setTimeout'</span>,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'test error'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// confirm the call has happened</span></span><br><span class="line">  cy.wait(<span class="string">'@sentry'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test passes. Let&#39;s confirm some of the fields the Sentry browser client sends to the service - it should have at least the error message.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// confirm the call has happened</span></span><br><span class="line">cy.wait(<span class="string">'@sentry'</span>)</span><br><span class="line">  .its(<span class="string">'requestBody'</span>)</span><br><span class="line">  .should(<span class="function"><span class="params">body</span> =&gt;</span> &#123;</span><br><span class="line">    expect(body.level).to.equal(<span class="string">'error'</span>)</span><br><span class="line">    expect(body.exception.values).to.have.length(<span class="number">1</span>)</span><br><span class="line">    expect(body.exception.values[<span class="number">0</span>]).to.deep.contain(&#123;</span><br><span class="line">      type: <span class="string">'Error'</span>,</span><br><span class="line">      value: <span class="string">'test error'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-sentry/full-test.png" alt="Passing test asserting Sentry is working correctly"></p><p><strong>Tip:</strong> writing XHR assertions this way is cumbersome, I suggest using helper library <a href="https://github.com/bahmutov/cy-spok" target="_blank" rel="noopener">cy-spok</a> in the blog post <a href="https://www.cypress.io/blog/2019/12/23/asserting-network-calls-from-cypress-tests/" target="_blank" rel="noopener">Asserting Network Calls from Cypress Tests</a>.</p><h2><span id="see-also">See also</span></h2><ul><li><a href="../connecting-crash-reporting-with-end-to-end-tests/">Connecting crash reporting with end to end tests</a> shows how to add additional test information to Sentry crashes happening during end-to-end tests</li><li><a href="../simple-ajax-testing/">Simple Ajax testing</a> shows how to observe calls to Sentry from Node tests</li><li><a href="../know-unknown-unknowns-with-sentry/">Know unknown unknowns with Sentry</a> is probably my first blog post praising Sentry</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I love using &lt;a href=&quot;https://sentry.io/welcome/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Sentry&lt;/a&gt; for tracking errors in my web applications. R
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="sentry" scheme="https://glebbahmutov.com/blog/tags/sentry/"/>
    
  </entry>
  
  <entry>
    <title>Scrape Static Site with Algolia</title>
    <link href="https://glebbahmutov.com/blog/scrape-static-site-with-algolia/"/>
    <id>https://glebbahmutov.com/blog/scrape-static-site-with-algolia/</id>
    <published>2020-03-26T04:00:00.000Z</published>
    <updated>2020-04-11T21:26:07.125Z</updated>
    
    <content type="html"><![CDATA[<p>Algolia search is good. So good, that many open source projects have moved to its free <a href="https://docsearch.algolia.com/" target="_blank" rel="noopener">DocSearch</a> project. When you search VuePress documentation you are using Algolia&#39;s backend, same with Yarn docs, same with Babel docs, and many others.</p><p><img src="/blog/images/scrape/vuepress-search.gif" alt="Searching VuePress documentation thanks to Algolia"></p><p>Great, let&#39;s see how we can take a static site like <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a> and create an Algolia index for it, then scrape the site&#39;s contents. Then we will add a search to the static site powered by Algolia&#39;s index.</p><h2><span id="set-up-algolia-app">Set up Algolia app</span></h2><p>First, I created a new Algolia account and have created a new application to host my experiment.</p><p><strong>Pro tip:</strong> rename your application to something meaningful from <code>https://www.algolia.com/account/applications</code> page after creating it.</p><p><img src="/blog/images/scrape/rename-app.png" alt="Renaming Algolia application"></p><p>Then set up a new index inside the application. For this blog post I called the index <code>scrape-test</code>, the screenshot below shows the index after I have added a few records there.</p><p><img src="/blog/images/scrape/index.png" alt="Search index"></p><p>To scrape any site and send results to the index we need the application&#39;s ID and Admin Key. I have tried creating a separate key following <a href="https://docsearch.algolia.com/docs/run-your-own" target="_blank" rel="noopener">Run Your Own Scraper</a> documentation, but I was always getting &quot;Index not allowed with this API key&quot; error. So just grab the Admin Key (but keep it really secret).</p><p><img src="/blog/images/scrape/api-keys.png" alt="We will need Application ID and API key to send scraped results"></p><h2><span id="scraping-the-site">Scraping the site</span></h2><p>I have created a repo <a href="https://github.com/bahmutov/scrape-test" target="_blank" rel="noopener">bahmutov/scrape-test</a> to show scraping in action. First, we need to think what is important on the page, and the hierarchy of results. For example, text matching <code>&lt;h1&gt;</code> element is probably more important than text matching <code>&lt;h3&gt;</code>. In demo I will be scraping a VuePress site from <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a> which is a VuePress site. I can look at <a href="https://github.com/algolia/docsearch-configs/blob/master/configs/vuepress.json" target="_blank" rel="noopener">VuePress Algolia scrape config file</a> to see how they set it up.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"index_name"</span>: <span class="string">"scrape-test"</span>,</span><br><span class="line">  <span class="attr">"start_urls"</span>: [<span class="string">"https://glebbahmutov.com/triple-tested/"</span>],</span><br><span class="line">  <span class="attr">"selectors"</span>: &#123;</span><br><span class="line">    <span class="attr">"lvl0"</span>: &#123;</span><br><span class="line">      <span class="attr">"selector"</span>: <span class="string">".site-name"</span>,</span><br><span class="line">      <span class="attr">"global"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"lvl1"</span>: <span class="string">".content__default h1"</span>,</span><br><span class="line">    <span class="attr">"lvl2"</span>: <span class="string">".content__default h2"</span>,</span><br><span class="line">    <span class="attr">"lvl3"</span>: <span class="string">".content__default h3"</span>,</span><br><span class="line">    <span class="attr">"lvl4"</span>: <span class="string">".content__default h4"</span>,</span><br><span class="line">    <span class="attr">"lvl5"</span>: <span class="string">".content__default h5"</span>,</span><br><span class="line">    <span class="attr">"text"</span>: <span class="string">".content__default p, .content__default li"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The last selector <code>text</code> requires explanation. Algolia&#39;s docs suggest splitting long text blocks into individual short records, see <a href="https://www.algolia.com/doc/faq/basics/is-there-a-size-limit-for-my-index-records/" target="_blank" rel="noopener">1</a>, <a href="https://www.algolia.com/doc/guides/sending-and-managing-data/prepare-your-data/how-to/indexing-long-documents/" target="_blank" rel="noopener">2</a>. We can check the <code>text</code> selector from DevTools console to see the short records it finds.</p><p><img src="/blog/images/scrape/text-selector.png" alt="Individual paragraphs and list items found using text selector"></p><p>Let&#39;s scrape the site. The simplest way is to use <a href="https://github.com/algolia/docsearch-scraper" target="_blank" rel="noopener">Algolia-provided Docker image</a>. Here is how I run it from the root of the <code>scrape-test</code> repo (where <code>config.json</code> file lives).</p><p>I place <code>APPLICATION_ID</code> and <code>API_KEY</code> values into <code>~/.as-a/.as-a.ini</code> file under its own section.</p><p><img src="/blog/images/scrape/as-a.png" alt="Keep environment variables in .as-a.ini file"></p><p>docker pull algolia/docsearch-scraper:v1.6.0</p><p>Now I will start Docker and will use <a href="https://github.com/bahmutov/as-a" target="_blank" rel="noopener">as-a</a> to run the <a href="https://hub.docker.com/r/algolia/docsearch-scraper" target="_blank" rel="noopener">algolia/docsearch-scraper</a> image. I will pass keys as environment variables, and the config file too.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">as-a scrape-test docker run -it \</span><br><span class="line">  -e APPLICATION_ID -e API_KEY -e CONFIG="$(cat config.json)" \</span><br><span class="line">  algolia/docsearch-scraper:v1.6.0</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> DocSearch: https://glebbahmutov.com/triple-tested/ 8 records)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> DocSearch: https://glebbahmutov.com/triple-tested/about.html 3 records)</span></span><br><span class="line"></span><br><span class="line">Nb hits: 11</span><br></pre></td></tr></table></figure><p>The scraper went like a spider through all (two) pages and found records to upload to the search index. Now let&#39;s go back to Algolia&#39;s Dashboard to check what it finds.</p><h3><span id="scraping-from-the-image">Scraping from the image</span></h3><p>As a side note, we can scrape the site from inside the <code>algolia/docsearch-scraper:v1.6.0</code> Docker image <em>without</em> executing its default entrypoint. We can inspect how the Docker image is built at <a href="https://github.com/algolia/docsearch-scraper/tree/master/scraper/dev/docker" target="_blank" rel="noopener">docsearch-scraper</a>. Here is the relevant line from its Dockerfile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [&quot;pipenv&quot;, &quot;run&quot;, &quot;python&quot;, &quot;-m&quot;, &quot;src.index&quot;]</span><br></pre></td></tr></table></figure><p>Let&#39;s see - let&#39;s run the same scrape job, but instead we will start the shell. Once the Docker container starts, we will enter <code>pipenv ...</code> command to run the scraper.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ as-a scrape-test docker run -it \</span><br><span class="line">  -e APPLICATION_ID -e API_KEY -e CONFIG=&quot;$(cat config.json)&quot; \</span><br><span class="line">  --entrypoint=/bin/sh algolia/docsearch-scraper:v1.6.0</span><br><span class="line"># pipenv run python -m src.index</span><br><span class="line">&gt; DocSearch: https://glebbahmutov.com/triple-tested/ 8 records)</span><br><span class="line">&gt; DocSearch: https://glebbahmutov.com/triple-tested/about.html 3 records)</span><br><span class="line"></span><br><span class="line">Nb hits: 11</span><br></pre></td></tr></table></figure><p>Great, works the same way.</p><h2><span id="scraping-from-github-action">Scraping from GitHub Action</span></h2><p><strong>Tip:</strong> if you have never used GitHub Actions, read <a href="../trying-github-actions/">Trying GitHub Actions</a> blog post</p><p>We don&#39;t want to scrape the site from local machine, let&#39;s do it from Continuous Integration (CI) server. Since the repository is already on GitHub, let&#39;s use GH Actions. Let&#39;s create workflow file <a href="https://github.com/bahmutov/scrape-test/blob/master/.github/workflows/scrape.yml" target="_blank" rel="noopener">.github/workflows/scrape.yml</a>.</p><figure class="highlight yml"><figcaption><span>scrape.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">scrape</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  scrape:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">check</span> <span class="string">out</span> <span class="string">code</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="comment"># when scraping the site, inject secrets as environment variables</span></span><br><span class="line">      <span class="comment"># then pass their values into the Docker container using "-e" syntax</span></span><br><span class="line">      <span class="comment"># and inject config.json contents as another variable</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">scrape</span> <span class="string">the</span> <span class="string">site</span> <span class="string">🧽</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          APPLICATION_ID:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.APPLICATION_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          API_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.API_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          docker run \</span></span><br><span class="line"><span class="string">          -e APPLICATION_ID -e API_KEY \</span></span><br><span class="line"><span class="string">          -e CONFIG="$(cat config.json)" \</span></span><br><span class="line"><span class="string">          algolia/docsearch-scraper:v1.6.0</span></span><br></pre></td></tr></table></figure><p>Enter the application id and API key in repository&#39;s secrets.</p><p><img src="/blog/images/scrape/repo-secrets.png" alt="Secrets to be injected as environment variables"></p><p>Push the code and see <a href="https://github.com/bahmutov/scrape-test/actions" target="_blank" rel="noopener">Actions run</a>.</p><p><img src="/blog/images/scrape/actions.png" alt="Scraping the site from GitHub Action"></p><p><strong>Tip:</strong> if you are deploying the site to GitHub Pages, you could run the scraper AFTER deploy finishes, read <a href="../triple-tested/">Triple Tested Static Site Deployed to GitHub Pages Using GitHub Actions</a></p><h2><span id="adding-the-algolia-search-widget">Adding the Algolia search widget</span></h2><p>We have populated the search index, now let&#39;s switch our demo site from built-in client-side search to Algolia&#39;s search widget. You can see the VuePress site in <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a> repository.</p><p>I have updated the <a href="https://github.com/bahmutov/triple-tested/blob/master/docs/.vuepress/config.js" target="_blank" rel="noopener">docs/.vuepress/config.js</a> to include Algolia settings.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  title: <span class="string">'Triple Tested'</span>,</span><br><span class="line">  description: <span class="string">'Example static site'</span>,</span><br><span class="line">  base: <span class="string">'/triple-tested/'</span>,</span><br><span class="line">  themeConfig: &#123;</span><br><span class="line">    algolia: &#123;</span><br><span class="line">      <span class="comment">// DANGER 🧨💀: ONLY USE ALGOLIA PUBLIC SEARCH-ONLY API KEY</span></span><br><span class="line">      apiKey: <span class="string">'&lt;algolia search-only API key&gt;'</span>,</span><br><span class="line">      indexName: <span class="string">'scrape-test'</span>,</span><br><span class="line">      appId: <span class="string">'&lt;algolia app id&gt;'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This <code>apiKey</code> is NOT the Admin API key we have used to scrape the site, this is a key limited to searching the index only.</p><p>Once the site starts, try the search ... and you won&#39;t see any results 😟</p><p><img src="/blog/images/scrape/no-results.png" alt="The search widget comes up empty"></p><p>Open DevTools Network panel to see the queries from Algolia&#39;s search box - notice they include a <em>facet</em> <code>lang: en-US</code>.</p><p><img src="/blog/images/scrape/facets.png" alt="The search facets include the language"></p><p>Our Algolia application does not know the <em>language</em> of each record in the index. Thus we need to go back to <a href="https://github.com/algolia/docsearch-configs/blob/master/configs/vuepress.json" target="_blank" rel="noopener">DocSearch VuePress config</a> file to see how they have set it up. Among selectors we can find the following:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"selectors"</span>: &#123;</span><br><span class="line">    <span class="attr">"lang"</span>: &#123;</span><br><span class="line">      <span class="attr">"selector"</span>: <span class="string">"/html/@lang"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"xpath"</span>,</span><br><span class="line">      <span class="attr">"global"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"custom_settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"attributesForFaceting"</span>: [</span><br><span class="line">      <span class="string">"lang"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Great - the <code>lang</code> selector tells the scraper to use <code>&lt;html lang=&quot;en&quot;&gt;</code> attribute. Let&#39;s copy the above settings and scrape again. Now each record has additional facet attribute, and testing the index correctly finds the record and shows the language facet.</p><p><img src="/blog/images/scrape/updated-index.png" alt="The index has the language facet"></p><p>Going back to the widget - it is working now!</p><p><img src="/blog/images/scrape/search-works.gif" alt="The Algolia search widget finds the text"></p><p>You can try the search yourself at <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a>.</p><h2><span id="example-repos">Example repos</span></h2><ul><li><a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested/</a></li><li><a href="https://github.com/bahmutov/cypress-examples" target="_blank" rel="noopener">bahmutov/cypress-examples</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Algolia search is good. So good, that many open source projects have moved to its free &lt;a href=&quot;https://docsearch.algolia.com/&quot; target=&quot;_
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
      <category term="algolia" scheme="https://glebbahmutov.com/blog/tags/algolia/"/>
    
  </entry>
  
  <entry>
    <title>Triple Tested Static Site Deployed to GitHub Pages Using GitHub Actions</title>
    <link href="https://glebbahmutov.com/blog/triple-tested/"/>
    <id>https://glebbahmutov.com/blog/triple-tested/</id>
    <published>2020-03-24T04:00:00.000Z</published>
    <updated>2020-03-24T13:25:58.009Z</updated>
    
    <content type="html"><![CDATA[<p>This blog post shows something I have wanted to achieve for a while: <strong>deploying a fully tested static site or a web application and then testing the deployed site</strong>.</p><!-- toc --><ul><li><a href="#introduction">Introduction</a></li><li><a href="#the-static-site">The static site</a></li><li><a href="#building-the-production-site">Building the production site</a></li><li><a href="#deploying-to-github-pages">Deploying to GitHub Pages</a></li><li><a href="#local-testing">Local testing</a></li><li><a href="#local-test-on-ci">Local test on CI</a></li><li><a href="#the-problem-with-deployed-site">The problem with deployed site</a></li><li><a href="#testing-the-deployed-site">Testing the deployed site</a></li><li><a href="#testing-the-deployed-site-from-ci">Testing the deployed site from CI</a></li><li><a href="#fixing-the-deploy-url">Fixing the deploy url</a></li><li><a href="#preventing-broken-deployments">Preventing broken deployments</a></li><li><a href="#tips">Tips</a><ul><li><a href="#github-actions-badges">GitHub Actions badges</a></li><li><a href="#environment-variables">Environment variables</a></li><li><a href="#record-to-dashboard">Record to Dashboard</a></li></ul></li><li><a href="#discussion">Discussion</a></li></ul><!-- tocstop --><h2><span id="introduction">Introduction</span></h2><p>My previous attempts used a combination of continuous integration (CI) systems and deployment tools; in all cases the result is a workflow that was unnecessary complex and hard to understand. You can see these attempts for yourself from these blog posts:</p><ul><li><a href="../gatsby-netlify-circle-and-cypress/">Gatsby Netlify Circle and Cypress</a> uses CircleCI + Netlify and requires webhook back Netlify to Circle on deploy to run a test job</li><li><a href="https://www.cypress.io/blog/2018/08/28/record-test-artifacts-from-any-ci/" target="_blank" rel="noopener">Record Test Artifacts from any Docker CI</a> uses Docker image to run tests locally, but does not test the deployed site</li><li><a href="https://www.cypress.io/blog/2017/05/30/cypress-and-immutable-deploys/" target="_blank" rel="noopener">Immutable deploys and Cypress</a> uses GitLab CI to run tests locally, then deploys using Zeit Now and tests the deployed site, not too bad, but still a combination of two systems and lots of custom glue code; I am not even sure my tool <a href="https://github.com/bahmutov/now-pipeline" target="_blank" rel="noopener">now-pipeline</a> is even working still against Zeit API</li></ul><p>This blog post shows how to deploy a static site or a web apps to <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> while testing the site three times using <a href="https://github.com/features/actions" target="_blank" rel="noopener">GitHub Actions</a>:</p><ul><li>first time running site <em>in development mode</em></li><li>second time by building the production bundles and serving the site using a static server</li><li>third time <em>after deploying</em> the site to GitHub Pages</li></ul><p><strong>Source code:</strong> you can find the code for this blog post in <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a>. You can see the finished (well-tested) version of the site deployed at <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a>.</p><p>Let&#39;s roll!</p><h2><span id="the-static-site">The static site</span></h2><p>As an example, I created a static blog site using <a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener">VuePress</a>. First, let&#39;s install it using NPM</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm init --yes</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm i -D vuepress</span></span><br><span class="line">+ vuepress@1.4.0</span><br></pre></td></tr></table></figure><p>In <a href="https://github.com/bahmutov/triple-tested/blob/master/package.json" target="_blank" rel="noopener">package.json</a> we can add commands to run the local development server and build the production site:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"triple-tested"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"docs:dev"</span>: <span class="string">"vuepress dev docs"</span>,</span><br><span class="line">    <span class="attr">"docs:build"</span>: <span class="string">"vuepress build docs"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"vuepress"</span>: <span class="string">"1.4.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then I have added a new folder called <code>docs</code> with a few Markdown files - these files will be converted into HTML pages using VuePress settings from <code>docs/.vuepress</code> folder.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la docs/</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x   5 gleb  staff  160 Mar 22 17:23 .</span><br><span class="line">drwxr-xr-x  13 gleb  staff  416 Mar 22 17:30 ..</span><br><span class="line">drwxr-xr-x   4 gleb  staff  128 Mar 21 14:51 .vuepress</span><br><span class="line">-rw-r--r--   1 gleb  staff  101 Mar 22 17:28 README.md</span><br><span class="line">-rw-r--r--   1 gleb  staff  152 Mar 22 17:29 about.md</span><br><span class="line"></span><br><span class="line">$ cat docs/.vuepress/config.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  title: &apos;Triple Tested&apos;,</span><br><span class="line">  description: &apos;Example static site&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The <code>README.md</code> file has the content for the main or index page</p><figure class="highlight md"><figcaption><span>docs/README.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Main page</span></span><br><span class="line"><span class="quote">&gt; This is an experiment</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>does it work?</span><br><span class="line"><span class="bullet">- </span>maybe</span><br><span class="line"><span class="bullet">- </span>hope so!</span><br><span class="line"></span><br><span class="line">Go to [<span class="string">about page</span>](<span class="link">./about</span>)</span><br></pre></td></tr></table></figure><p>The <code>about.md</code> file has a link back to the main page</p><figure class="highlight md"><figcaption><span>docs/about.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># About</span></span><br><span class="line"></span><br><span class="line">This is a static blog used as example in [<span class="string">bahmutov/triple-tested</span>](<span class="link">https://github.com/bahmutov/triple-tested</span>) repo.</span><br><span class="line"></span><br><span class="line">Back to the [<span class="string">main page</span>](<span class="link">/</span>)</span><br></pre></td></tr></table></figure><p>We can start the local development server that bundles the Markdown files and serves the HTML pages using <code>npm run docs:dev</code> command. The <code>vuepress dev docs</code> command serves the content at port 8080 by default.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run docs:dev</span></span><br><span class="line">success [17:38:19] Build 62f9fb finished in 116 ms! ( http://localhost:8080/ )</span><br></pre></td></tr></table></figure><p>Open that URL in your browser and find a nice, clean static site</p><p><img src="/blog/images/triple-tested/main-to-about.gif" alt="Main page to About page and back"></p><p>The development server watches the source files, and automatically rebuilds the pages on changes. It also forces the browser to reload the page.</p><p><img src="/blog/images/triple-tested/develop-reload.gif" alt="Development process reloads the page when Markdown file changes"></p><p><strong>Tip:</strong> the above example used relative link <code>[about page](./about)</code>, but according to <a href="https://vuepress.vuejs.org/guide/markdown.html#links" target="_blank" rel="noopener">VuePress docs</a> you should use the file path with extension <code>[about page](./about.md)</code> to generate the correct link.</p><h2><span id="building-the-production-site">Building the production site</span></h2><p>We cannot run the <code>npm run docs:dev</code> in production though: we need to convert the Markdown into finalized HTML pages. VuePress has the <code>build</code> command that does the production build and optimizes the HTML, CSS and JavaScript asset bundles.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run docs:build</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> triple-tested@1.0.0 docs:build /Users/gleb/git/triple-tested</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> vuepress build docs</span></span><br><span class="line"></span><br><span class="line">wait Extracting site metadata...</span><br><span class="line">tip Apply theme @vuepress/theme-default ...</span><br><span class="line">tip Apply plugin container (i.e. "vuepress-plugin-container") ...</span><br><span class="line">tip Apply plugin @vuepress/register-components (i.e. "@vuepress/plugin-register-components") ...</span><br><span class="line">tip Apply plugin @vuepress/active-header-links (i.e. "@vuepress/plugin-active-header-links") ...</span><br><span class="line">tip Apply plugin @vuepress/search (i.e. "@vuepress/plugin-search") ...</span><br><span class="line">tip Apply plugin @vuepress/nprogress (i.e. "@vuepress/plugin-nprogress") ...</span><br><span class="line"></span><br><span class="line">✔ Client</span><br><span class="line">  Compiled successfully in 7.25s</span><br><span class="line"></span><br><span class="line">✔ Server</span><br><span class="line">  Compiled successfully in 4.58s</span><br><span class="line"></span><br><span class="line">wait Rendering static HTML...</span><br><span class="line">success Generated static files in docs/.vuepress/dist.</span><br></pre></td></tr></table></figure><p>The <code>build</code> command prepares the static site for <a href="https://vuepress.vuejs.org/guide/deploy.html" target="_blank" rel="noopener">deployment</a> - assuming the hosting platform &quot;simply&quot; serves the produced folder <code>docs/.vuepress/dist</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la docs/.vuepress/dist</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 22 17:57 .</span><br><span class="line">drwxr-xr-x  4 gleb  staff   128 Mar 22 17:56 ..</span><br><span class="line">-rw-r--r--  1 gleb  staff  2990 Mar 22 17:57 about.html</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 22 17:57 assets</span><br><span class="line">-rw-r--r--  1 gleb  staff  2508 Mar 22 17:57 index.html</span><br></pre></td></tr></table></figure><p>In fact, we can serve the <code>dist</code> folder ourselves to see how it looks. Let&#39;s use a quick static server utility called <a href="https://github.com/zeit/serve" target="_blank" rel="noopener">serve</a>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D serve</span></span><br><span class="line">+ serve@11.3.0</span><br><span class="line"><span class="meta">$</span><span class="bash"> npx serve docs/.vuepress/dist</span></span><br><span class="line"></span><br><span class="line">   ┌────────────────────────────────────────────────┐</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Serving!                                     │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   - Local:            http://localhost:5000    │</span><br><span class="line">   │   - On Your Network:  http://10.0.0.124:5000   │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Copied local address to clipboard!           │</span><br><span class="line">   │                                                │</span><br><span class="line">   └────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>Open <code>localhost:5000</code> in the browser - it should look and work exactly the same way as the development server, and perhaps even faster, since it was optimized for production and does not include the extra development code.</p><p><img src="/blog/images/triple-tested/dist.png" alt="Production static site served from dist/.vuepress/dist folder"></p><h2><span id="deploying-to-github-pages">Deploying to GitHub Pages</span></h2><p>Now that we have built such a beautiful content, let&#39;s host it somewhere. I will use <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Page</a> to host. I love using GH Pages for static pages, even this blog you are reading is hosted there! Any public GH repository can push HTML files into <code>gh-pages</code> branch, and the GH Pages serve it.</p><p>I could push the <code>dist</code> folder to <a href="https://github.com/bahmutov/triple-tested/tree/gh-pages" target="_blank" rel="noopener">gh-pages branch</a> manually, but I want to automate this process. Thus I have created a GitHub Actions workflow file <a href="https://github.com/bahmutov/triple-tested/blob/b0f84916ac45f1b1f83617818f365d007c3d3958/.github/workflows/ci.yml" target="_blank" rel="noopener">.github/workflow/ci.yml</a> that checks out the code, installs NPM dependencies, builds the production site and deploys the <code>dist</code> folder to the <code>gh-pages</code> branch where GitHub Pages host it:</p><figure class="highlight yml"><figcaption><span>.github/workflow/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># only deploy site from master branch</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line">      <span class="comment"># https://github.com/actions/checkout</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">NPM</span> <span class="string">install</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/marketplace/actions/github-pages-action</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Deploy</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          publish_dir:</span> <span class="string">./docs/.vuepress/dist</span></span><br></pre></td></tr></table></figure><p><strong>Note:</strong> if you have never used GitHub Actions, spend 30 minutes watching my recent talk <a href="https://www.youtube.com/watch?v=zhPqf5z_crc" target="_blank" rel="noopener">GitHub Actions in Action</a> and browse the <a href="https://slides.com/bahmutov/gh-actions" target="_blank" rel="noopener">slides</a>, or read the blog post <a href="../trying-github-actions/">Trying GitHub Actions</a>.</p><p>In the above <code>ci.yml</code> file we are using 3rd party GitHub action from repo <a href="https://github.com/peaceiris/actions-gh-pages" target="_blank" rel="noopener">peaceiris/actions-gh-pages</a> and pass it two parameters. The <code>secrets.GITHUB_TOKEN</code> is created automatically by GitHub workflow; this token allows the action to push a new commit back to the <code>gh-pages</code> branch if there are changed HTML files. The <code>public_dir</code> parameter tells the action which folder we want to deploy.</p><p><strong>Warning ⚠️:</strong> if the first deploy fails, read <a href="https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-first-deployment-with-github_token" target="_blank" rel="noopener">this issue</a> - there seems to be a bug with GH Pages and the <code>GITHUB_TOKEN</code> on first deploy. I pushed the code manually once using <a href="https://github.com/josh-egan/deploy-gh-pages" target="_blank" rel="noopener">deploy-gh-pages</a> and my personal GitHub access token <code>GH_TOKEN=... npx deploy-gh-pages ./docs/.vuepress/dist</code>. After that the <code>ci.yml</code> was able to push the new commits automatically.</p><p>You can see the workflow <code>ci</code> run at GitHub inside the repo&#39;s <a href="https://github.com/bahmutov/triple-tested/actions?query=workflow%3Aci" target="_blank" rel="noopener">Actions tab</a></p><p><img src="/blog/images/triple-tested/ci-workflow.png" alt="Workflow &quot;ci&quot; has successfully finished"></p><p>Before we look at the deployed site, let&#39;s go back to the local development mode and make sure it works correctly.</p><h2><span id="local-testing">Local testing</span></h2><p>In a section above, I have shown navigation from the Main page to the About page and back by clicking on the links.</p><p><img src="/blog/images/triple-tested/main-to-about.gif" alt="Main page to About page and back"></p><p>What if we accidentally change the filename <code>about.md</code> to <code>info.md</code>? We will have a broken link, which leads to frustrated users. Let&#39;s prevent this by adding an end-to-end Cypress test. First, we will install Cypress test runner and a useful utility <a href="https://github.com/bahmutov/start-server-and-test" target="_blank" rel="noopener">start-server-and-test</a> to help run and stop multiple processes.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress start-server-and-test</span></span><br><span class="line">+ cypress@4.2.0</span><br><span class="line">+ start-server-and-test@1.10.11</span><br></pre></td></tr></table></figure><p>When we work locally we want to run the VuePress develop command, wait for the server to respond at port 8080, then we can open Cypress. Here are the scripts:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"docs:dev"</span>: <span class="string">"vuepress dev docs"</span>,</span><br><span class="line">    <span class="attr">"docs:build"</span>: <span class="string">"vuepress build docs"</span>,</span><br><span class="line">    <span class="attr">"cy:open"</span>: <span class="string">"cypress open"</span>,</span><br><span class="line">    <span class="attr">"cy:run"</span>: <span class="string">"cypress run"</span>,</span><br><span class="line">    <span class="attr">"dev"</span>: <span class="string">"start-test docs:dev 8080 cy:open"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"cypress"</span>: <span class="string">"4.2.0"</span>,</span><br><span class="line">    <span class="attr">"serve"</span>: <span class="string">"11.3.0"</span>,</span><br><span class="line">    <span class="attr">"start-server-and-test"</span>: <span class="string">"1.10.11"</span>,</span><br><span class="line">    <span class="attr">"vuepress"</span>: <span class="string">"1.4.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Whenever we need to start everything locally, we will use <code>npm run dev</code> script. Let&#39;s write a Cypress test.</p><figure class="highlight js"><figcaption><span>cypress/integration/spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="cypress" /&gt;</span></span><br><span class="line">describe(<span class="string">'Triple tested'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'has index and about pages'</span>, () =&gt; &#123;</span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">    cy.contains(<span class="string">'h1'</span>, <span class="string">'Main page'</span>)</span><br><span class="line">    cy.contains(<span class="string">'hope so!'</span>)</span><br><span class="line">    cy.contains(<span class="string">'a'</span>, <span class="string">'about page'</span>).click()</span><br><span class="line">    cy.url().should(<span class="string">'match'</span>, /about/)</span><br><span class="line">    cy.contains(<span class="string">'h1'</span>, <span class="string">'About'</span>)</span><br><span class="line">    cy.contains(<span class="string">'a'</span>, <span class="string">'main page'</span>).click()</span><br><span class="line">    cy.url().should(<span class="string">'not.match'</span>, /about/)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test does not hardcode the URL to visit - instead the command <code>cy.visit(&#39;/&#39;)</code> relies on <code>baseUrl</code> set in the <code>cypress.json</code> file</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:8080"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Start the development server and open Cypress with NPM script</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run dev</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> start-test docs:dev 8080 cy:open</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   - runs <span class="string">"docs:dev"</span> script</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   - waits <span class="keyword">for</span> port 8080 to respond</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   - opens Cypress application</span></span><br></pre></td></tr></table></figure><p>The test in <code>spec.js</code> runs very quickly</p><p><img src="/blog/images/triple-tested/spec.gif" alt="Cypress test going from Main to About page and back using links"></p><p><strong>Tip:</strong> if we <em>only</em> wanted to check the local Markdown links, we could just do so, read the blog post <a href="../check-markdown-links/">Check links in your Markdown documents</a>. But in this blog post we want to write other kinds of functional tests.</p><p>While we are at it, we can verify the &quot;Search&quot; behavior. VuePress automatically adds search widget with page titles. Users can go to a page by typing the title:</p><p><img src="/blog/images/triple-tested/search.gif" alt="Going to the About page using the search"></p><p>Let&#39;s write a test. First, we need to select the search input box. Here is the relevant markup:</p><p><img src="/blog/images/triple-tested/search-markup.png" alt="HTML markup for search widget"></p><p><strong>Tip:</strong> I have described how to test VuePress Search widget in details in the blog post <a href="../vuepress-conditional-testing/">VuePress and some Cypress end-to-end testing tips</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'finds About page using search'</span>, () =&gt; &#123;</span><br><span class="line">  cy.visit(<span class="string">'/'</span>)</span><br><span class="line">  cy.get(<span class="string">'.search-box input'</span>).type(<span class="string">'about'</span>)</span><br><span class="line">  <span class="comment">// suggestions list appears</span></span><br><span class="line">  cy.get(<span class="string">'.suggestions li'</span>).should(<span class="string">'be.visible'</span>)</span><br><span class="line">    <span class="comment">// and should have at least 1 item</span></span><br><span class="line">    .and(<span class="string">'have.length.gte'</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// and the first search result is our "About" page</span></span><br><span class="line">    .first()</span><br><span class="line">    .contains(<span class="string">'.page-title'</span>, <span class="string">'About'</span>).click()</span><br><span class="line">  <span class="comment">// check we are on the right page</span></span><br><span class="line">  cy.title().should(<span class="string">'contain'</span>, <span class="string">'About'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs and confirms the search is working</p><p><img src="/blog/images/triple-tested/search-test.gif" alt="The search test finds the About page"></p><h2><span id="local-test-on-ci">Local test on CI</span></h2><p>Now that we have end-to-end tests, let&#39;s run them on GitHub Actions CI. We could extend the <code>ci.yml</code> with commands to start the development server in the background and run Cypress tests like this:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">NPM</span> <span class="string">install</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:develop</span> <span class="string">&amp;</span></span><br><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">cy:run</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br></pre></td></tr></table></figure><p>Or we could use <code>start-server-and-test</code> utility on CI by defining one more script:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"docs:dev"</span>: <span class="string">"vuepress dev docs"</span>,</span><br><span class="line">    <span class="attr">"cy:run"</span>: <span class="string">"cypress run"</span>,</span><br><span class="line">    <span class="attr">"dev:ci"</span>: <span class="string">"start-test docs:dev 8080 cy:run"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Where the <code>cypress run</code> command just runs Cypress headlessly.</p><figure class="highlight yml"><figcaption><span>ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">NPM</span> <span class="string">install</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">dev:ci</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br></pre></td></tr></table></figure><p>The above approach is imperfect. The action step <code>bahmutov/npm-install@v1</code> does NOT understand how to <a href="https://on.cypress.io/caching" target="_blank" rel="noopener">cache Cypress binary correctly</a>, leading to slow or failing builds. To greatly simplify running Cypress on GitHub Actions CI, we have written <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a>. This action &quot;knows&quot; how to install Cypress and NPM dependencies, cache them, start the server, and run the tests. Let&#39;s use this action:</p><figure class="highlight yml"><figcaption><span>ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:8080'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br></pre></td></tr></table></figure><p>The GitHub Actions execute and pass</p><p><img src="/blog/images/triple-tested/testing-on-ci.png" alt="Cypress tests successfully ran on GitHub"></p><p>We can see the logs from the <code>npm run docs:dev</code> command followed by the Cypress&#39; terminal output.</p><p><img src="/blog/images/triple-tested/logs.gif" alt="Cypress GitHub Action logs"></p><p>Nice, our static site will work correctly when deployed; we have tested it!</p><p>Or will it?</p><h2><span id="the-problem-with-deployed-site">The problem with deployed site</span></h2><p>We have tested the site on GitHub CI by running the VuePress development server. Then we built the site and pushed the <code>./docs/.vuepress/dist</code> folder to GitHub Pages. Everything must be good, right? Let&#39;s check.</p><p>I have a custom domain <code>glebbahmutov.com</code> <a href="https://help.github.com/en/github/working-with-github-pages/configuring-a-custom-domain-for-your-github-pages-site" target="_blank" rel="noopener">configured with GitHub Pages</a> via CloudFlare. My personal repository <a href="https://github.com/bahmutov/bahmutov.github.io" target="_blank" rel="noopener">bahmutov/bahmutov.github.io</a> is hosted at <code>https://glebbahmutov.com/</code> and every repo <code>&lt;name&gt;</code> will be available under <code>https://glebbahmutov.com/&lt;name&gt;/</code> sub path. Thus we can open <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a> and see our blog.</p><p>Let&#39;s open that URL ...</p><p><img src="/blog/images/triple-tested/deploy1.png" alt="The deployed site is terribly broken"></p><p>Oh no, the site ... does not look good. Click on the &quot;About&quot; page link - we can browser to it. But going to the &quot;Main&quot; page does not work. Instead it redirects to the top level domain <code>https://glebbahmutov.com</code>.</p><p><img src="/blog/images/triple-tested/link-to-main.png" alt="Link to the main page is wrong"></p><p>Open the DevTools Network tab and reload the main page - you will see that only the <code>index.html</code> really loads, all other links fail to load.</p><p><img src="/blog/images/triple-tested/failed-links.png" alt="Network tab shows that resources fail to load"></p><p>Clicking on any resource shows the full path - and it looks wrong, because it does not include <code>/triple-tested/</code> folder.</p><p><img src="/blog/images/triple-tested/failed-css.png" alt="Failed CSS resource"></p><p>Let&#39;s look at the source of the page - notice that all resource links start with <code>/assets/...</code>, which means they are served from the <em>root of the domain</em>.</p><p><img src="/blog/images/triple-tested/html.png" alt="Deployed site HTML"></p><p>Each resource link &quot;forgets&quot; to include the <em>base url</em> of the site - the subfolder <code>/triple-tested</code> part. We should have read the entire <a href="https://vuepress.vuejs.org/guide/deploy.html" target="_blank" rel="noopener">VuePress deployment guide</a> that explains GitHub deployment in details:</p><p><img src="/blog/images/triple-tested/vuepress-deploy.png" alt="VuePress deployment guide to GitHub Pages"></p><p>Ok, that can be done. But before we fix the problem, we need to</p><p>...</p><p>write a test for it.</p><h2><span id="testing-the-deployed-site">Testing the deployed site</span></h2><p>As you saw above, things can go wrong when deploying a site. The problems that arise are <em>outside of source code</em> of the site itself. It was not the link <code>[about page](./about)</code> from the Main page to the About page that we have tested. It was not the Search widget either. No, instead we have discovered a <em>hosting configuration</em> problem. If instead of our small static site example, we had a complex web application, we could have wrong environment variables, an invalid database connection string, an unreachable proxy address - all the things that worked perfectly locally, but were set up incorrectly in production.</p><p>To really validate the deployed production site, we need to run a quick smoke end-to-end test, just to see if the entire stack works together.</p><p>Remember how we set the base url to test in <code>cypress.json</code>? It is pointing at <code>http://localhost:8080</code>, but we can overwrite it from <a href="https://on.cypress.io/configuration" target="_blank" rel="noopener">command line or using an environment variable</a>. Let&#39;s see if our current tests catch the errors with the deployed site. Open Cypress GUI locally, but pass the full production site URL:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx cypress open --config baseUrl=https://glebbahmutov.com/triple-tested</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or equivalent</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_baseUrl=https://glebbahmutov.com/triple-tested npx cypress open</span></span><br></pre></td></tr></table></figure><p>Then run the same tests against it.</p><p><img src="/blog/images/triple-tested/testing-deploy.gif" alt="Running end-to-end tests against the deployed site"></p><p>The &quot;finds About page using search&quot; test catches the broken site - because the JavaScript bundle for the search widget did not load.</p><p><strong>Tip:</strong> notice the 404 HTTP status codes Cypress shows in its terminal output - meaning the page under test fails to load a lot of its resources! That&#39;s a red flag.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /__cypress/iframes/integration/spec.js 200 1.025 ms - 629</span><br><span class="line">GET /__cypress/tests?p=cypress/integration/spec.js-331 200 1.689 ms - -</span><br><span class="line">GET /triple-tested/ 200 2.891 ms - -</span><br><span class="line">GET /assets/css/0.styles.59ba12ca.css 404 22.829 ms - -</span><br><span class="line">GET /assets/js/app.b08d2fd8.js 404 26.132 ms - -</span><br><span class="line">GET /assets/js/5.620a0c16.js 404 31.183 ms - -</span><br><span class="line">GET /assets/js/2.28d5c6fe.js 404 32.865 ms - -</span><br><span class="line">GET /assets/js/3.d052a4f0.js 404 32.142 ms - -</span><br><span class="line">GET /assets/js/4.5f60d4ea.js 404 28.854 ms - -</span><br><span class="line">GET /assets/js/6.fa5f4b7d.js 404 30.396 ms - -</span><br><span class="line">GET /triple-tested/about 200 92.170 ms - -</span><br></pre></td></tr></table></figure><p>Why did the first test &quot;has index and about pages&quot; pass? I remember it had an assertion after navigating back from the &quot;About&quot; to the &quot;Main&quot; page... It should have failed.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.contains(<span class="string">'a'</span>, <span class="string">'main page'</span>).click()</span><br><span class="line">cy.url().should(<span class="string">'not.match'</span>, /about/)</span><br></pre></td></tr></table></figure><p>Hmm, look at the time traveling debugger - the assertion passes, but for a wrong reason - the site&#39;s url is <code>https://glebbahmutov.com</code> that does not match the regular expression <code>/about/</code>, so the test &quot;thinks&quot; everything is peachy.</p><p><img src="/blog/images/triple-tested/assertion.png" alt="The negative assertion against the URL passes"></p><p>You have to be careful about negative assertions like <code>should(&#39;not.match&#39;, ...)</code>, because they can be passing but for completely unexpected (and wrong) reasons. Let&#39;s add a <em>positive</em> assertion that checks something on the page that <em>only the right Main</em> page has.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.contains(<span class="string">'a'</span>, <span class="string">'main page'</span>).click()</span><br><span class="line">cy.url().should(<span class="string">'not.match'</span>, /about/)</span><br><span class="line"><span class="comment">// only our Main page has &lt;h1&gt;Main page&lt;/h1&gt;</span></span><br><span class="line">cy.contains(<span class="string">'h1'</span>, <span class="string">'Main page'</span>)</span><br></pre></td></tr></table></figure><p>The test fails correctly.</p><p><img src="/blog/images/triple-tested/test-fails.png" alt="The first test correctly fails"></p><p><strong>Tip:</strong> Cypress is a <em>functional testing tool</em>. Thus if the elements are present on the page, Cypress will happily click on the buttons, navigate using links, check the DOM and urls, etc. And it won&#39;t &quot;notice&quot; that the page&#39;s styles are missing, and everything looks broken. For that you need to add <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">visual testing</a>; luckily it not too difficult to do.</p><h2><span id="testing-the-deployed-site-from-ci">Testing the deployed site from CI</span></h2><p>We cannot rely on manual testing of the deployed site. We need to automatically test the site from CI after it has been deployed. Since we deploy the site to GitHub Pages from GitHub Actions, let&#39;s write <em>another action workflow</em> that would be triggered after the deploy finish. I will create a new file <code>.github/workflows/deployed.yml</code> with another GitHub workflow. Creating a separate workflow file is a great for keeping your CI files simple to understand and use.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">deployed</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  status:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test-deployed-page:</span></span><br><span class="line"><span class="attr">    if:</span> <span class="string">github.event.context</span> <span class="string">==</span> <span class="string">'github/pages'</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.state</span> <span class="string">==</span> <span class="string">'success'</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">echo</span> <span class="string">"gh-pages 📑 built successfully ✅"</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">show</span> <span class="string">deployed</span> <span class="string">page</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">curl</span> <span class="bullet">-s</span> <span class="attr">https://glebbahmutov.com/triple-tested</span></span><br></pre></td></tr></table></figure><p>This workflow only runs when a commit on the <code>master</code> branch has its status updated. GitHub Pages bot sets this status when it starts building the pages, and when it finishes the deployment. We can use <a href="https://help.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions" target="_blank" rel="noopener">GitHub Actions expressions</a> to skip the job <code>test-deployed-page</code> unless the event that triggered the workflow tells us the GitHub Pages deploy was a success.</p><p><strong>Tip:</strong> you can dump the entire GH event object and inspect all the fields in order to write the <code>if: ...</code> expressions. Here is a dummy workflow job that simply prints the event (it is a huge JSON object)</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">show-event:</span></span><br><span class="line"><span class="attr">  runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">  steps:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Dump</span> <span class="string">GitHub</span> <span class="string">context</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        GITHUB_CONTEXT:</span> <span class="string">$&#123;&#123;</span> <span class="string">toJson(github)</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">echo</span> <span class="string">"$GITHUB_CONTEXT"</span></span><br></pre></td></tr></table></figure><p>Let&#39;s see this workflow in action. I have added line <code>another one 👆</code> the <code>docs/README.md</code> file and have commited and pushed the code.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Go to [about page](./about)</span><br><span class="line">another one 👆</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git add docs/README.md</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit -m <span class="string">"another one"</span></span></span><br><span class="line">[master 1e8d247] another one</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"><span class="meta">$</span><span class="bash"> git push</span></span><br></pre></td></tr></table></figure><p>We can see the 3 workflows at GitHub: the original <code>ci.yml</code> on <code>push</code> to <code>master</code> branch, followed by the skipped <code>deployed.yml</code> workflow (because the event status is <code>pending</code>), and then the full deployed workflow runs when the page has been deployed.</p><p><img src="/blog/images/triple-tested/events.png" alt="The workflows: one builds and deploys, the other runs after the deploy"></p><p>We can click on the finished <code>deployed</code> workflow and look at the output of the <code>curl -s https://glebbahmutov.com/triple-tested</code> command. The site has been updated with new text</p><p><img src="/blog/images/triple-tested/page.png" alt="The static site has been updated"></p><p>Now that we have the workflow that runs AFTER the deploy, let&#39;s run Cypress tests there, using the same <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a> code, but just pointing the tests at the external site.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">show</span> <span class="string">deployed</span> <span class="string">page</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">curl</span> <span class="bullet">-s</span> <span class="attr">https://glebbahmutov.com/triple-tested/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># we need our source code that has package.json and Cypress specs</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    config:</span> <span class="string">baseUrl=https://glebbahmutov.com/triple-tested/</span></span><br></pre></td></tr></table></figure><p><strong>Note:</strong> if we only change the <code>deployed.yml</code> file, the deploy event WILL NOT be triggered - because the VuePress content has stayed the same! Thus we need to change some text in the <code>docs</code> folder in order to trigger a new deploy and see the tests in action. I will remove <code>another one 👆</code> line and push again.</p><p>The CI workflows shows the <code>deployed</code> workflow failing - because the tests we have added detect the broken static site</p><p><img src="/blog/images/triple-tested/deployed-workflow-failed.png" alt="The deployed workflow fails as expected"></p><p>Click on the <code>deployed</code> workflow to see both Cypress tests failing as expected.</p><p><img src="/blog/images/triple-tested/both-tests-failed.png" alt="Both tests failed against the production site"></p><p>We have automated the deployment and testing the production site. At least now we know when the deployment went badly and corrective measures should be taken.</p><h2><span id="fixing-the-deploy-url">Fixing the deploy url</span></h2><p>After reading the <a href="https://vuepress.vuejs.org/guide/deploy.html" target="_blank" rel="noopener">VuePress deploy guide</a> one more time, I open the <code>docs/.vuepress/config.js</code> file and add the <a href="https://vuepress.vuejs.org/config/#base" target="_blank" rel="noopener"><code>base</code> parameter</a>:</p><figure class="highlight js"><figcaption><span>docs/.vuepress/config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  title: <span class="string">'Triple Tested'</span>,</span><br><span class="line">  description: <span class="string">'Example static site'</span>,</span><br><span class="line">  base: <span class="string">'/triple-tested/'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The <code>base</code> parameter also changes the local url when using <code>npm run docs:dev</code> script, thus we update <code>cypress.json</code> (and related <code>start-server-and-wait</code> parameters)</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:8080/triple-tested"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:8080/triple-tested/'</span></span><br></pre></td></tr></table></figure><p>Let&#39;s push the commit, the local tests pass, then the deploy happens. And now the post-deploy Cypress tests pass!</p><p><img src="/blog/images/triple-tested/deploy-tests-passed.png" alt="Post-deploy CI job passes"></p><p>We can check the site at GitHub Pages - it is working.</p><p><img src="/blog/images/triple-tested/working-site.gif" alt="The site is working correctly"></p><p>Great!</p><h2><span id="preventing-broken-deployments">Preventing broken deployments</span></h2><p>Can we prevent a broken site from being deployed to production in the first place? Could we have caught an invalid or missing <code>base</code> configuration?</p><p>When we tested the site in the section <a href="#local-test-on-ci">Local test on CI</a>, we used the development VuePress server via <code>vuepress dev docs</code> command. The served site passed the tests, then we built the production version and deployed it. We then ran the production site - which failed at first. We should have tested the production version before deployment in a way <em>similar to the production site</em>. I have already showed that we can serve the <code>dist</code> folder using <a href="https://github.com/zeit/serve" target="_blank" rel="noopener">serve</a> module: <code>$ npx serve docs/.vuepress/dist</code>.</p><p>Let&#39;s simulate the broken build again by removing the <code>base</code> property from the file <code>docs/.vuepress/config.js</code>:</p><figure class="highlight js"><figcaption><span>docs/.vuepress/config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  title: <span class="string">'Triple Tested'</span>,</span><br><span class="line">  description: <span class="string">'Example static site'</span>,</span><br><span class="line">  <span class="comment">// removing "base" property to break production site</span></span><br><span class="line">  <span class="comment">// base: '/triple-tested/'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>To simulate sub path, we can serve the bundle from a nested folder.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> build the production site</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm run docs:build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir output</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp -r docs/.vuepress/dist output/triple-tested</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">let</span><span class="string">'s look at the "production" folder</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -la output</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x   3 gleb  staff   96 Mar 23 22:02 .</span><br><span class="line">drwxr-xr-x  14 gleb  staff  448 Mar 23 22:02 ..</span><br><span class="line">drwxr-xr-x   5 gleb  staff  160 Mar 23 22:02 triple-tested</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -la output/triple-tested/</span></span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 23 22:02 .</span><br><span class="line">drwxr-xr-x  3 gleb  staff    96 Mar 23 22:02 ..</span><br><span class="line">-rw-r--r--  1 gleb  staff  2990 Mar 23 22:02 about.html</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 23 22:02 assets</span><br><span class="line">-rw-r--r--  1 gleb  staff  2512 Mar 23 22:02 index.html</span><br></pre></td></tr></table></figure><p>Now let&#39;s serve the <code>output</code> folder</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx serve output</span></span><br><span class="line"></span><br><span class="line">   ┌────────────────────────────────────────────────┐</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Serving!                                     │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   - Local:            http://localhost:5000    │</span><br><span class="line">   │   - On Your Network:  http://10.0.0.124:5000   │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Copied local address to clipboard!           │</span><br><span class="line">   │                                                │</span><br><span class="line">   └────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>Open <code>http://localhost:5000/triple-tested</code> in the browser to see exactly the same broken site as we had in production before.</p><p><img src="/blog/images/triple-tested/serve-output.png" alt="Accessing the sub path site locally shows missing resources"></p><p>Cypress catches the broken site</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_baseUrl=http://localhost:5000/triple-tested npx cypress open</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/triple-tested/broken-prod.png" alt="Testing production bundle locally"></p><p>Let&#39;s restore the <code>base</code> property in file <code>docs/.vuepress/config.js</code>, build the site, copy the <code>dist</code> folder into <code>output</code> and try again.</p><p><img src="/blog/images/triple-tested/passing-test.png" alt="Testing production site built correctly using base sub path"></p><p>Great, the tests pass when when we correctly set the <code>base</code> property. Now we need to make sure we test the production site on CI. Let&#39;s add these commands to <a href="https://github.com/bahmutov/triple-tested/blob/master/.github/workflows/ci.yml" target="_blank" rel="noopener">ci.yml</a> file</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># only deploy site from master branch</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line">      <span class="comment"># https://github.com/actions/checkout</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:8080/triple-tested/'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Prepare</span> <span class="string">built</span> <span class="string">site</span> <span class="string">for</span> <span class="string">testing</span> <span class="string">🚛</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mkdir output</span></span><br><span class="line"><span class="string">          cp -r ./docs/.vuepress/dist output/triple-tested</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">      - name:</span> <span class="string">Test</span> <span class="string">production</span> <span class="string">site</span> <span class="string">✅</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line">          <span class="comment"># we have already installed all dependencies above</span></span><br><span class="line"><span class="attr">          install:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npx serve output'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:5000/triple-tested/'</span></span><br><span class="line"><span class="attr">          config:</span> <span class="string">baseUrl=http://localhost:5000/triple-tested/</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/marketplace/actions/github-pages-action</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Deploy</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          publish_dir:</span> <span class="string">./docs/.vuepress/dist</span></span><br></pre></td></tr></table></figure><p>The GitHub Actions run and pass.</p><p><img src="/blog/images/triple-tested/gh-passed.png" alt="GitHub Actions tested the site in dev mode and as built production bundle"></p><p>The deploy went through to GitHub Pages and then was tested the 3rd time</p><p><img src="/blog/images/triple-tested/prod-tested.png" alt="Test jobs before and after deploy have passed"></p><h2><span id="tips">Tips</span></h2><p>Before I reach the <a href="#discussion">Discussion</a> section, let me give a couple of tips.</p><h3><span id="github-actions-badges">GitHub Actions badges</span></h3><p>For each GitHub workflow you can add a <a href="../trying-github-actions/#badges">badge to README file</a>. In our case we will have two separate workflows:</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">![<span class="string">ci</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/ci/badge.svg?branch=master</span>)</span><br><span class="line">![<span class="string">deployed</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/deployed/badge.svg?branch=master</span>)</span><br></pre></td></tr></table></figure><p>If you want each badge to lead immediately to matching workflow, add destination urls</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">![ci</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/ci/badge.svg?branch=master</span>)](<span class="link">https://github.com/bahmutov/triple-tested/actions?query=workflow%3Aci</span>)</span><br><span class="line">[<span class="string">![deployed</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/deployed/badge.svg?branch=master</span>)](<span class="link">https://github.com/bahmutov/triple-tested/actions?query=workflow%3Adeployed</span>)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/triple-tested/badges.png" alt="CI badges"></p><h3><span id="environment-variables">Environment variables</span></h3><p>We can avoid hard-coding the production URL in several places in CI configuration files, and instead can use <a href="https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables" target="_blank" rel="noopener">GitHub environment variables</a> to specify the base url to test.</p><p>Instead of</p><figure class="highlight yml"><figcaption><span>deployed.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    config:</span> <span class="string">baseUrl=https://glebbahmutov.com/triple-tested/</span></span><br></pre></td></tr></table></figure><p>we will set the <code>CYPRESS_baseUrl</code> at the job level</p><figure class="highlight yml"><figcaption><span>deployed.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">deployed</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  status:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test-deployed-page:</span></span><br><span class="line"><span class="attr">    if:</span> <span class="string">github.event.context</span> <span class="string">==</span> <span class="string">'github/pages'</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.state</span> <span class="string">==</span> <span class="string">'success'</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    env:</span></span><br><span class="line"><span class="attr">      CYPRESS_baseUrl:</span> <span class="attr">https://glebbahmutov.com/triple-tested/</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">echo</span> <span class="string">"gh-pages 📑 built successfully ✅"</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">show</span> <span class="string">deployed</span> <span class="string">page</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">curl</span> <span class="bullet">-s</span> <span class="string">$CYPRESS_baseUrl</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># we need our source code that has package.json and Cypress specs</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br></pre></td></tr></table></figure><h3><span id="record-to-dashboard">Record to Dashboard</span></h3><p>GitHub Actions give you a lot of free resources for public repositories. But storing and viewing the Cypress test artifacts (screenshots on failure, videos of the test runs, test results) is inconvenient. Thus I recommend using <a href="https://on.cypress.io/dashboard-introduction" target="_blank" rel="noopener">Cypress Dashboard</a> to record the tests.</p><p>I have <a href="https://on.cypress.io/projects" target="_blank" rel="noopener">set up project to record</a> and stored the <code>CYPRESS_RECORD_KEY</code> as a secret at GitHub repo settings.</p><p><img src="/blog/images/triple-tested/record-key.png" alt="Cypress record key kept in secrets"></p><p>We can set the secret as environment variable in the specific steps that run Cypress tests, and pass <code>record: true</code> parameter. You can find all parameters in examples inside the <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a> repository.</p><figure class="highlight yml"><figcaption><span>ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:8080/triple-tested/'</span></span><br><span class="line"><span class="attr">    record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">'development'</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">'ci'</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Test</span> <span class="string">production</span> <span class="string">site</span> <span class="string">✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line">    <span class="comment"># we have already installed all dependencies above</span></span><br><span class="line"><span class="attr">    install:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npx serve output'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:5000/triple-tested/'</span></span><br><span class="line"><span class="attr">    config:</span> <span class="string">baseUrl=http://localhost:5000/triple-tested/</span></span><br><span class="line"><span class="attr">    record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">'production bundle'</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p>In the <code>deployed.yml</code> workflow we similarly record the test results</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">- uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">'production'</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>You can add a badge to the README.md pointing at the project&#39;s dashboard, so users can find the test results. The project Id is stored in <code>cypress.json</code> file, in our case it is <code>rroimy</code>.</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">![Cypress Dashboard</span>](<span class="link">https://img.shields.io/badge/cypress-dashboard-brightgreen.svg</span>)](<span class="link">https://dashboard.cypress.io/#/projects/rroimy/runs</span>)</span><br></pre></td></tr></table></figure><p>See results for yourself: <a href="https://dashboard.cypress.io/#/projects/rroimy/runs" target="_blank" rel="noopener">Cypress Dashboard</a></p><p>For each deployment, we see two runs: one is tagged <code>ci</code> and and the second one is tagged <code>production</code>.</p><p><img src="/blog/images/triple-tested/runs.png" alt="Two runs for each deployment"></p><p>In the run tagged <code>ci</code>, the two sets of tests are in two groups:</p><p><img src="/blog/images/triple-tested/ci-runs.png" alt="CI run has two groups of tests"></p><p>Each spec has its video captured, and if there were any failures, there would be screenshots too.</p><h2><span id="discussion">Discussion</span></h2><p>I have shown how to build, test and deploy a static site using GitHub Actions and Pages working together. Because many things can go wrong, I have tested the site three times:</p><ul><li>First using the development server that comes with VuePress.</li><li>Second time after building the production version by serving it locally to simulate the sub path hosting</li><li>Third time after deployment to check if the production site is working for my users</li></ul><p>While triple testing might seem like an overkill, I hope you see why it was necessary. We ran end-to-end tests after each major code transformation: building the production bundle is such a big change, it was necessary to validate the produced bundle. Deploying the site to GitHub Pages is also a big change, so we want to run tests after that. GitHub Actions allowed us to run Cypress tests in all scenarios.</p><p>We did not have to run <em>all tests</em> in every scenario. For example, we could have executed just a few smoke tests after building the production bundles and after the deployment. Read the blog post <a href="https://www.cypress.io/blog/2019/12/06/use-meaningful-smoke-tests/" target="_blank" rel="noopener">Use meaningful smoke tests</a> about running a small  subset of tests.</p><p><strong>Source code:</strong> you can find the code for this blog post in <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a>. You can see the finished (well-tested) version of the site deployed at <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;This blog post shows something I have wanted to achieve for a while: &lt;strong&gt;deploying a fully tested static site or a web application an
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>CitizenClimateLobby short pitch</title>
    <link href="https://glebbahmutov.com/blog/ccl-pitch-at-pkg/"/>
    <id>https://glebbahmutov.com/blog/ccl-pitch-at-pkg/</id>
    <published>2020-03-05T05:00:00.000Z</published>
    <updated>2020-03-06T14:00:38.963Z</updated>
    
    <content type="html"><![CDATA[<p>Hi,</p><p>Solving climate crisis is tough. It requires us to change how we behave individually, as communities, and as a city. It will require changes at the state level, but most importantly it requires addressing the problem head-on as a nation.</p><p>I personally think that safe and abundant renewable power is almost here - we have the technology and it already beats coal on price. And the only reason it has not replaced oil and fracking gas is because they don&#39;t pay for the pollution they cause.</p><p>This is where <a href="https://citizensclimatelobby.org/" target="_blank" rel="noopener">CitizenClimateLobby</a> comes in. We are completely non-partizan organization that works at the federal level, and we are successful. We now have in the House the bill called &quot;<a href="https://energyinnovationact.org/" target="_blank" rel="noopener">Energy Innovation and Carbon Dividend Act</a>&quot; that we lobby for, and it has 80 co-sponsors, both Democrats and Republicans. This bill HR 763 will tax every fossil fuel the moment it gets extracted from the ground. This tax would be collected and then distributed to every citizen of the United States. You get this check and buy renewables that suddenly are so much cheaper.</p><p>The bill is NOT the full solution, but a significant step to making the economics of renewables very very attractive.</p><p>Join us - we have a table over there with Gary - we lobby the Congress via personal visits, phone calling and media campaigns, and endorsements from the industry and prominent individuals.</p><p>Make the fossil fuel pollution expensive - and the world will get greener.</p><ul><li><a href="https://citizensclimatelobby.org/" target="_blank" rel="noopener">https://citizensclimatelobby.org/</a></li><li><a href="https://citizensclimatelobby.org/monthly-calling-campaign/" target="_blank" rel="noopener">https://citizensclimatelobby.org/monthly-calling-campaign/</a></li><li><a href="https://energyinnovationact.org/" target="_blank" rel="noopener">https://energyinnovationact.org/</a></li><li><a href="https://www.eventbrite.com/e/pkg-2020-community-conversations-climate-change-tickets-89265199615" target="_blank" rel="noopener">PKG Community Meeting page</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Hi,&lt;/p&gt;
&lt;p&gt;Solving climate crisis is tough. It requires us to change how we behave individually, as communities, and as a city. It will r
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Support Node 6 installs</title>
    <link href="https://glebbahmutov.com/blog/support-node6-installs/"/>
    <id>https://glebbahmutov.com/blog/support-node6-installs/</id>
    <published>2020-03-03T05:00:00.000Z</published>
    <updated>2020-03-03T14:52:02.360Z</updated>
    
    <content type="html"><![CDATA[<p>What is the minimum version of Node your NPM module requires? You might think it is Node 8 or Node 10 or even Node 6. But in reality you don&#39;t know - because the direct or transient NPM dependencies your project uses might require a different <em>higher</em> version, without even declaring it explicitly in the <code>engines</code> field of their <code>package.json</code> files.</p><p>Recently, we have experienced sudden &quot;bumps&quot; in minimum Node version required for our Cypress NPM package because of <a href="https://github.com/chalk/chalk" target="_blank" rel="noopener">chalk</a> and <a href="https://github.com/sindresorhus/execa" target="_blank" rel="noopener">execa</a> dependencies. While we promised supporting Node v8.0.0, due to these dependencies our true minimum Node version turned out to be v8.12.0!</p><p>The only reliable way to determine if your project runs on Node 8.0.0 is to run your NPM package on Node 8.0.0. In this blog post I will show how to bundle and transpile your NPM package so it truly runs on Node v8.0.0 or even on Node v6.</p><p><strong>Note:</strong> you can find the source code at <a href="https://github.com/bahmutov/support-node-v6" target="_blank" rel="noopener">bahmutov/support-node-v6</a></p><h2><span id="the-problem">The problem</span></h2><p>Let&#39;s start a new NPM application that uses <code>chalk</code> and <code>execa</code> to print the list of files. We want to use the latest versions of all the tools, so we are working on Node v12</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~/git/support-node-v6 on master</span><br><span class="line"><span class="meta">$</span><span class="bash"> nvm use 12</span></span><br><span class="line">Now using node v12.13.0 (npm v6.13.7)</span><br><span class="line">~/git/support-node-v6 on master</span><br><span class="line"><span class="meta">$</span><span class="bash"> npm i -S chalk execa</span></span><br><span class="line">npm notice created a lockfile as package-lock.json. You should commit this file.</span><br><span class="line">+ chalk@3.0.0</span><br><span class="line">+ execa@4.0.0</span><br></pre></td></tr></table></figure><p>Here is our application file <code>index.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Chalk is <span class="subst">$&#123;chalk.red(<span class="string">'working'</span>)&#125;</span> if you saw red`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> execa = <span class="built_in">require</span>(<span class="string">'execa'</span>)</span><br><span class="line">execa(<span class="string">'ls'</span>, [<span class="string">'-la'</span>]).then(<span class="function"><span class="params">r</span> =&gt;</span> r.stdout).then(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure><p>The app runs and the colors show up (on Node v12)</p><p><img src="/blog/images/support-node6/app.png" alt="chalk and execa work on Node 12"></p><p>Now let&#39;s try the same application on Node v6.</p><p><img src="/blog/images/support-node6/chalk-uses-spread.png" alt="chalk uses spread operator"></p><p>Because <code>chalk</code> uses spread operator, it does not run on Node v6 - and you would need to downgrade to <a href="mailto:`chalk@2.4.2" target="_blank" rel="noopener">`chalk@2.4.2</a><code>. But then the same happens with</code>execa` - it also uses the spread operator!</p><p><img src="/blog/images/support-node6/execa-uses-spread.png" alt="execa uses spread operator"></p><p>You would need to downgrade <code>execa</code> all the way to v1 to get the syntax compatible with Node v6. In the process you just lost soooo many features and fixes from <code>execa</code> and <code>chalk</code>, it is almost sad.</p><p><img src="/blog/images/support-node6/execa-v1.png" alt="execa v1 and chalk v2 work on Node 6"></p><h2><span id="bundling">Bundling</span></h2><p>Let&#39;s switch tactics. Instead of searching for an old version of <code>chalk</code> and <code>execa</code>, let&#39;s install the latest versions - and let&#39;s bundle them into a single JavaScript file. Typically, bundling is done for browsers, but we will use <a href="https://github.com/zeit/ncc" target="_blank" rel="noopener">@zeit/ncc</a> to bundle <em>for Node</em>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -S chalk execa</span><br><span class="line">+ execa@4.0.0</span><br><span class="line">+ chalk@3.0.0</span><br><span class="line">$ npm i -D @zeit/ncc</span><br><span class="line">+ @zeit/ncc@0.21.1</span><br></pre></td></tr></table></figure><p>We can use <code>ncc</code> to produce a single JavaScript file from <code>index.js</code> entry using <code>npm run build</code> script</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ npm run build</span><br><span class="line"></span><br><span class="line">&gt; support-node-v6@1.0.0 build /Users/gleb/git/support-node-v6</span><br><span class="line">&gt; ncc build index.js</span><br><span class="line"></span><br><span class="line">ncc: Version 0.21.1</span><br><span class="line">ncc: Compiling file index.js</span><br><span class="line">106kB  dist/index.js</span><br><span class="line">106kB  [920ms] - ncc 0.21.1</span><br></pre></td></tr></table></figure><p>The bundle we produced does not run on Node 6 yet.</p><p><img src="/blog/images/support-node6/bundle.png" alt="bundle does not work on Node 6 yet"></p><p>But the bundle has <em>all</em> dependencies included. We can remove <code>node_modules</code> folder and run it to prove this.</p><p><img src="/blog/images/support-node6/works-without-node-modules.png" alt="bundle works without node_modules folder"></p><p>Now we can transpile this single file to make it work on (almost) any Node version.</p><h2><span id="transpiling-down">Transpiling down</span></h2><p>I like using TypeScript compiler to transpile code.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 dist/index.js --outFile dist/out.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@types/node"</span>: <span class="string">"13.7.6"</span>,</span><br><span class="line">    <span class="attr">"typescript"</span>: <span class="string">"3.8.2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This <em>almost</em> works.</p><p><img src="/blog/images/support-node6/needs-entries.png" alt="transpile almost works"></p><p>The bundle is transpiled - the spread operators in <code>chalk</code> and <code>execa</code> have been replaced, but the bundle still has <code>Object.entries</code> method that Node v6 does not understand. We can polyfill this method though.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -S babel-polyfill</span><br><span class="line">+ babel-polyfill@6.26.0</span><br></pre></td></tr></table></figure><p>Then require the polyfill from <code>index.js</code> file</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'babel-polyfill'</span>)</span><br></pre></td></tr></table></figure><p>Let&#39;s build and transpile again.</p><p><img src="/blog/images/support-node6/works-on-node6.png" alt="works on Node 6"></p><p>Nice, the latest dependencies do work on Node v6!</p><h2><span id="tips">Tips</span></h2><h3><span id="run-scripts">Run scripts</span></h3><p>Since we only plan to distribute a single bundle, we can generate the intermediate bundle in the <code>build</code> folder, and run the transpile step post-build.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js --out build"</span>,</span><br><span class="line">    <span class="attr">"postbuild"</span>: <span class="string">"npm run transpile"</span>,</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 build/index.js --outFile dist/index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dist"</span>,</span><br><span class="line">  <span class="attr">"files"</span>: [<span class="string">"dist"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="specify-bundled-dependencies">Specify bundled dependencies</span></h3><p>We can see the produced bundle using <code>npm pack --dry</code> command.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ npm run build</span><br><span class="line">...</span><br><span class="line">$ npm pack --dry</span><br><span class="line">npm notice</span><br><span class="line">npm notice 📦  support-node-v6@1.0.0</span><br><span class="line">npm notice === Tarball Contents ===</span><br><span class="line">npm notice 598.9kB dist/index.js</span><br><span class="line">npm notice 895B    package.json</span><br><span class="line">npm notice === Tarball Details ===</span><br><span class="line">npm notice name:          support-node-v6</span><br><span class="line">npm notice version:       1.0.0</span><br><span class="line">npm notice filename:      support-node-v6-1.0.0.tgz</span><br><span class="line">npm notice package size:  114.0 kB</span><br><span class="line">npm notice unpacked size: 599.8 kB</span><br><span class="line">npm notice shasum:        f5c816747afe915e9e6cb5ad483050dbe60df662</span><br><span class="line">npm notice integrity:     sha512-pRaaeDthI0+7C[...]XYiVKrziJa60w==</span><br><span class="line">npm notice total files:   2</span><br><span class="line">npm notice</span><br><span class="line">support-node-v6-1.0.0.tgz</span><br></pre></td></tr></table></figure><p>The zipped archive has size 114 kB, which looks like a lot. But remember, that anyone installing this NPM app should only download this single file, which should be as fast as downloading multiple production dependencies. But we still list <code>execa</code> and <code>chalk</code> as production dependencies, thus our users will get two copies of them - the second one coming from the <code>dist/index.js</code> bundle.</p><p>Hmm, NPM understands <a href="http://npm.github.io/using-pkgs-docs/package-json/types/bundleddependencies.html" target="_blank" rel="noopener">bundled dependencies</a> list, but this list forces <code>chalk</code> and <code>execa</code> into the TGZ archive twice!</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dist"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js --out build"</span>,</span><br><span class="line">    <span class="attr">"postbuild"</span>: <span class="string">"npm run transpile"</span>,</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 build/index.js --outFile dist/index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"files"</span>: [<span class="string">"dist"</span>],</span><br><span class="line">  <span class="attr">"bundledDependencies"</span>: [<span class="string">"babel-polyfill"</span>, <span class="string">"chalk"</span>, <span class="string">"execa"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ npm pack --dry</span><br><span class="line">npm notice</span><br><span class="line">npm notice 📦  support-node-v6@1.0.0</span><br><span class="line">npm notice === Tarball Contents ===</span><br><span class="line">npm notice 598.9kB dist/index.js</span><br><span class="line">npm notice 958B    package.json</span><br><span class="line">npm notice === Bundled Dependencies ===</span><br><span class="line">npm notice babel-polyfill</span><br><span class="line">npm notice chalk</span><br><span class="line">npm notice execa</span><br><span class="line">npm notice === Tarball Details ===</span><br><span class="line">npm notice name:          support-node-v6</span><br><span class="line">npm notice version:       1.0.0</span><br><span class="line">npm notice filename:      support-node-v6-1.0.0.tgz</span><br><span class="line">npm notice package size:  930.7 kB</span><br><span class="line">npm notice unpacked size: 3.8 MB</span><br><span class="line">npm notice shasum:        aec06c58bc556e0050e54f690ed936978a45341f</span><br><span class="line">npm notice integrity:     sha512-+KVCnHxym0jYp[...]moDzoUVuxD6kQ==</span><br><span class="line">npm notice bundled deps:  3</span><br><span class="line">npm notice bundled files: 1910</span><br><span class="line">npm notice own files:     2</span><br><span class="line">npm notice total files:   1912</span><br><span class="line">npm notice</span><br><span class="line">support-node-v6-1.0.0.tgz</span><br></pre></td></tr></table></figure><p>Thus my advice is to move all production dependencies into <code>devDependencies</code> - they will be included in the bundle as needed and skip using <code>bundledDependencies</code>.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"support-node-v6"</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dist"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js --out build"</span>,</span><br><span class="line">    <span class="attr">"postbuild"</span>: <span class="string">"npm run transpile"</span>,</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 build/index.js --outFile dist/index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"files"</span>: [<span class="string">"dist"</span>],</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"babel-polyfill"</span>: <span class="string">"6.26.0"</span>,</span><br><span class="line">    <span class="attr">"chalk"</span>: <span class="string">"3.0.0"</span>,</span><br><span class="line">    <span class="attr">"execa"</span>: <span class="string">"4.0.0"</span>,</span><br><span class="line">    <span class="attr">"@types/node"</span>: <span class="string">"13.7.7"</span>,</span><br><span class="line">    <span class="attr">"@zeit/ncc"</span>: <span class="string">"0.21.1"</span>,</span><br><span class="line">    <span class="attr">"typescript"</span>: <span class="string">"3.8.3"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s make sure the bundled dependencies work. I have created a new NPM package in a different folder and will install and run the above project using Node v6.</p><p><img src="/blog/images/support-node6/install-from-another-project.png" alt="installing and running the bundled app on Node 6"></p><p>Perfect.</p><h3><span id="source-maps">Source maps</span></h3><p>While <code>@zeit/ncc</code> and <code>typescript</code> can both generate source maps, I could not find a way to connect the two to get the source maps to link an error back to the <em>original</em> source file. If you know how to do this, open a pull request in <a href="https://github.com/bahmutov/support-node-v6" target="_blank" rel="noopener">bahmutov/support-node-v6</a>, please.</p><h3><span id="unsupported-features">Unsupported features</span></h3><p>Some ES6+ syntax and features cannot be transpiled down, for example if your project requires WeakMaps or Proxies - you are out of luck.</p><h2><span id="alternative-use-parcel">alternative: use Parcel</span></h2><p>Instead of <code>@zeit/ncc</code> we can use <a href="https://github.com/parcel-bundler/parcel" target="_blank" rel="noopener">Parcel bundler</a> to bundle code like this:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"parcel build index.js --target node --bundle-node-modules --no-minify"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"parcel-bundler"</span>: <span class="string">"1.12.4"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="see-also">See also</span></h2><ul><li><a href="../javascript-needs-compile-step/">JavaScript needs compile step</a></li><li><a href="../precompiled-javascript/">Precompiled JavaScript</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;What is the minimum version of Node your NPM module requires? You might think it is Node 8 or Node 10 or even Node 6. But in reality you 
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="javascript" scheme="https://glebbahmutov.com/blog/tags/javascript/"/>
    
      <category term="nodejs" scheme="https://glebbahmutov.com/blog/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>Check links in your Markdown documents</title>
    <link href="https://glebbahmutov.com/blog/check-markdown-links/"/>
    <id>https://glebbahmutov.com/blog/check-markdown-links/</id>
    <published>2020-02-12T05:00:00.000Z</published>
    <updated>2020-04-11T19:14:25.851Z</updated>
    
    <content type="html"><![CDATA[<p>I want to sleep better at night, I want to know, everyone who is reading one of the many README files in my <a href="https://github.com/bahmutov/repositories" target="_blank" rel="noopener">GitHub repositories</a> has correct URLs. I love adding links to examples, blog posts, other repos - and I hate when a link is incorrect. In this blog post I will show how to check URLs from Markdown files.</p><ol><li>Install <a href="https://github.com/tcort/markdown-link-check" target="_blank" rel="noopener">markdown-link-check</a> with</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D markdown-link-check</span><br></pre></td></tr></table></figure><ol start="2"><li>Add NPM script for finding all top-level Markdown files (you can modify <code>find</code> command <a href="https://www.computerhope.com/unix/ufind.htm" target="_blank" rel="noopener">1]</a>, <a href="https://www.cyberciti.biz/faq/find-command-exclude-ignore-files/" target="_blank" rel="noopener">2</a> to find more files, if needed). Don&#39;t forget to escape <code>\</code> characters.</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"check:markdown"</span>: <span class="string">"find *.md -exec npx markdown-link-check &#123;&#125; \\;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Notice both external and local links are checked, but not the <a href="https://github.com/tcort/markdown-link-check/issues/91" target="_blank" rel="noopener">anchor tags ⚠️</a>.</p><p>You can check URLs on Mac and Linux with <code>npm run check:markdown</code> command:</p><p><img src="/blog/images/check-urls/terminal.png" alt="checking the links locally"></p><ol start="3"><li>Call the same script on CI to avoid breaking the links in the future</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">check:markdown</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/check-urls/ci.png" alt="checking the links on CI"></p><p>We can even find all Markdown files, while excluding <code>node_modules</code> folder with command</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -type f -name '*.md' ! -path './node_modules/*' ! -path './examples/*' -exec npx markdown-link-check --quiet &#123;&#125; \;</span><br></pre></td></tr></table></figure><h2><span id="exit-code">Exit code</span></h2><p>We have a problem ... the <code>find -exec</code> will feed each file to <code>markdown-link-check</code> and if one has an error, it just continues onto the next Markdown file, swallowing the error.</p><p>Instead, let&#39;s find all files likes this</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -type f -name '*.md' ! -path './node_modules/*'</span><br></pre></td></tr></table></figure><p>This prints each found filename per line like this</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> find . -<span class="built_in">type</span> f -name <span class="string">'*.md'</span> ! -path <span class="string">'./node_modules/*'</span></span></span><br><span class="line">./CODE_OF_CONDUCT.md</span><br><span class="line">./README.md</span><br><span class="line">./browsers/node12.0.0-chrome73-ff68/README.md</span><br><span class="line">./browsers/node8.15.1-chrome73/README.md</span><br><span class="line">./browsers/node10.2.1-chrome74/README.md</span><br><span class="line">./browsers/node13.3.0-chrome79-ff70/README.md</span><br><span class="line">./browsers/node12.13.0-chrome78-ff70-brave78/README.md</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>We can feed these lines into <a href="https://shapeshed.com/unix-xargs/" target="_blank" rel="noopener">xargs</a> program using <code>-L1</code> argument (one argument per lint).</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -type f -name '*.md' ! -path './node_modules/*' | xargs -L1 npx markdown-link-check --quiet</span><br></pre></td></tr></table></figure><p>Now we are talking</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> find . -<span class="built_in">type</span> f -name <span class="string">'*.md'</span> ! -path <span class="string">'./node_modules/*'</span> | xargs -L1 npx markdown-link-check --quiet</span></span><br><span class="line"></span><br><span class="line">FILE: ./CODE_OF_CONDUCT.md</span><br><span class="line"></span><br><span class="line">3 links checked.</span><br><span class="line"></span><br><span class="line">FILE: ./README.md</span><br><span class="line"></span><br><span class="line">23 links checked.</span><br><span class="line"></span><br><span class="line">FILE: ./browsers/node12.0.0-chrome73-ff68/README.md</span><br><span class="line"></span><br><span class="line">1 links checked.</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">FILE: ./base/README.md</span><br><span class="line">[✖] ubuntu16-8.16.2</span><br><span class="line">[✖] /ubuntu18-node12.14.1</span><br><span class="line">[✖] /ubuntu19-node12.14.1</span><br><span class="line"></span><br><span class="line">38 links checked.</span><br><span class="line"></span><br><span class="line">ERROR: 3 dead links found!</span><br><span class="line">[✖] ubuntu16-8.16.2 → Status: 400</span><br><span class="line">[✖] /ubuntu18-node12.14.1 → Status: 400</span><br><span class="line">[✖] /ubuntu19-node12.14.1 → Status: 400</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">FILE: ./included/3.6.1/README.md</span><br><span class="line"></span><br><span class="line">1 links checked.</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> $?</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>The search fails if any of the links are bad. Now I can sleep tight.</p><p>See example in <a href="https://github.com/cypress-io/cypress-docker-images/pull/244" target="_blank" rel="noopener">cypress-docker-images</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I want to sleep better at night, I want to know, everyone who is reading one of the many README files in my &lt;a href=&quot;https://github.com/b
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="markdown" scheme="https://glebbahmutov.com/blog/tags/markdown/"/>
    
  </entry>
  
  <entry>
    <title>My testimony in support of banning gas infrastructure in new construction in Cambridge, MA</title>
    <link href="https://glebbahmutov.com/blog/gas-ban-testimony/"/>
    <id>https://glebbahmutov.com/blog/gas-ban-testimony/</id>
    <published>2020-01-27T05:00:00.000Z</published>
    <updated>2020-01-29T14:33:53.001Z</updated>
    
    <content type="html"><![CDATA[<p>Tonight I went down to the Cambridge City Council meeting to voice my support for <a href="https://insideclimatenews.org/news/12122019/natural-gas-ban-cities-legal-cambridge-brookline-massachusetts-state-law-berkeley-california" target="_blank" rel="noopener">banning gas infrastructure in new building construction</a>. This is the testimony I gave in front of the mayor and the council.</p><p>Madam mayor, and the council. I am Gleb Bahmutov, I live at Winslow st, I love Cambridge. I am here tonight to express my strongest support for the proposed gas infrastructure in new buildings.</p><p>Last weekend I have enjoyed the unseasonably warm weather. I have enjoyed it for 10 minutes, but then I became terrified. This is abnormal and what will the summer be like? Will we be like Australia and burn? Or more likely will we have a long heat spell that will kill all the crops?</p><p>Terry Eliasen (meteorologist from WBC/CBS Boston) <a href="https://twitter.com/terrywbz/status/1221811069469044738?s=21" target="_blank" rel="noopener">tweeted today</a> that the average Boston temperature was higher than normal by 9.2 F in January. The scientists warn that to avoid the worst consequences of global warming, we need to limit the rise to 1.5 - 2 degrees Celsius, which is 4-5 degrees F. We are at 9.2.If this is not an emergency, I do not know what is.</p><p><img src="/blog/images/warm-january.png" alt="warm January in Boston"></p><p>The Rolling Stones magazine <a href="https://www.rollingstone.com/politics/politics-features/oil-gas-fracking-radioactive-investigation-937389/" target="_blank" rel="noopener">reported last week</a> that brine - the water from fracking they use to push the gases from under the ground is radioactive due to naturally occurring Radon gas but the radiation is concentrated. The industry does not measure the radioactivity, since they don&#39;t want to know it. But if they have to deal with low-level radioactive waste disposal, it will increase the cost of gas by a factor of 100 - and this is even without taking into account gas carbon price we all are about to start paying one way or another.</p><p>Building new gas infrastructure right now means the customers will be locked into paying sharply increasing prices in the nearest future.</p><p>We have plenty of natural offshore wind and solar resources to satisfy all our electricity needs many times over. To say that we can’t switch to all green, all renewable, all safe electricity 50 years after we went to the Moon is a lie, and not a very convincing lie.</p><p>Ban gas infrastructure now.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Tonight I went down to the Cambridge City Council meeting to voice my support for &lt;a href=&quot;https://insideclimatenews.org/news/12122019/na
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>A plea for climate in year 2020</title>
    <link href="https://glebbahmutov.com/blog/a-plea-for-climate-2020/"/>
    <id>https://glebbahmutov.com/blog/a-plea-for-climate-2020/</id>
    <published>2019-12-29T05:00:00.000Z</published>
    <updated>2019-12-29T20:08:49.286Z</updated>
    
    <content type="html"><![CDATA[<p>This is an email I have sent to my friends at the end of December 2019.</p><p>Hello friends,</p><p>Season greetings from Irina, Sky and me, we wish you all the best in 2020!As a new year resolution, we would like to ask everyone to take a moment to think about the climate crisis unfolding around us. If you follow the news, you can see something else going very bad: Australia is on fire, Amazon is burning due to greed, and many places in the world are experiencing water shortages - all are the effects of the warming Earth due to fossil emissions. Many scientists are trying to bring attention to the effects of global climate change in our near future. We are especially worried about Sky and the dead planet he might have to live on as an adult.To learn more about the problem, take a look at <a href="https://www.ipcc.ch/" target="_blank" rel="noopener">https://www.ipcc.ch/</a> and popular summaries in articles like <a href="https://www.theguardian.com/environment/2018/oct/08/global-warming-must-not-exceed-15c-warns-landmark-un-report" target="_blank" rel="noopener">https://www.theguardian.com/environment/2018/oct/08/global-warming-must-not-exceed-15c-warns-landmark-un-report</a> and <a href="https://www.theguardian.com/environment/2018/aug/06/domino-effect-of-climate-events-could-push-earth-into-a-hothouse-state" target="_blank" rel="noopener">https://www.theguardian.com/environment/2018/aug/06/domino-effect-of-climate-events-could-push-earth-into-a-hothouse-state</a> and <a href="https://interactive.carbonbrief.org/impacts-climate-change-one-point-five-degrees-two-degrees/" target="_blank" rel="noopener">https://interactive.carbonbrief.org/impacts-climate-change-one-point-five-degrees-two-degrees/</a> Unfortunately, the governments around the world are not acting with the urgency this crisis requires. It is up to us to save our home for ourselves and our children.</p><p>We are asking you to make a plan in 2020 to attend at least 1 meeting of each volunteer organization below. These are people like you and me trying to avert this catastrophe. You can find a local chapter pretty much everywhere across the USA.</p><p>These are the ones we attend regularly:</p><ul><li><a href="https://350.org/" target="_blank" rel="noopener">https://350.org/</a> acts locally and at the state level to switch to renewable energy</li><li><a href="https://citizensclimatelobby.org/" target="_blank" rel="noopener">https://citizensclimatelobby.org/</a> is trying to pass a federal law to put a price on fossil fuels</li><li><a href="https://www.sunrisemovement.org/" target="_blank" rel="noopener">https://www.sunrisemovement.org/</a> and <a href="https://rebellion.global/" target="_blank" rel="noopener">https://rebellion.global/</a> organize strikes and marches around the world to force politicians to act</li></ul><p>Thank you in advance.--Gleb, Irina and Sky</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;This is an email I have sent to my friends at the end of December 2019.&lt;/p&gt;
&lt;p&gt;Hello friends,&lt;/p&gt;
&lt;p&gt;Season greetings from Irina, Sky and
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Paint roof white</title>
    <link href="https://glebbahmutov.com/blog/paint-roof-white/"/>
    <id>https://glebbahmutov.com/blog/paint-roof-white/</id>
    <published>2019-12-28T05:00:00.000Z</published>
    <updated>2019-12-28T03:59:54.824Z</updated>
    
    <content type="html"><![CDATA[<p>My house is tall and narrow and lacks an attic. In the summer the bedroom gets pretty hot - because the black rubber coating of the flat roof got really really hot. I could not touch it on a sunny day without burning myself. So I have painted it white using <a href="https://www.homedepot.com/p/Henry-5-Gal-687-100-Acrylic-Enviro-White-Extreme-Elastomeric-Roof-Coating-HE687406/202091034" target="_blank" rel="noopener">Henry Acrylic Enviro-White Extreme Elastomeric Roof Coating</a>.</p><p><img src="/blog/images/roof/white-roof.jpg" alt="The completed roof"></p><p>I have used less than 5 gallons of paint, and have covered the roof with three coatings. The paint is extremely thick, almost like liquid rubber, yet it rolls easily using a regular roller. It is elastomeric - meaning it stretches without cracking as it heats.</p><p><img src="/blog/images/roof/henry-paint.jpeg" alt="Henry paint"></p><p>The difference was immense. On a hot day as I left a small unpainted patch, which I could not touch with my hand, the rest of the roof was absolutely cool to the touch - warm, but fine. We will see next summer how the hot days feel.</p><p>PS: I have heard the argument that black roofs soak the sun in the winter better. I don&#39;t put much stock into that argument - the house should be well isolated, and I am suffering from the heat a lot more than from cold temperatures.</p><p>PSS: I wish I could make a roof garden, but my roof is too small and hard to access, so I picked the white paint instead.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;My house is tall and narrow and lacks an attic. In the summer the bedroom gets pretty hot - because the black rubber coating of the flat 
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Keep passwords secret in E2E tests</title>
    <link href="https://glebbahmutov.com/blog/keep-passwords-secret-in-e2e-tests/"/>
    <id>https://glebbahmutov.com/blog/keep-passwords-secret-in-e2e-tests/</id>
    <published>2019-12-01T05:00:00.000Z</published>
    <updated>2019-12-02T14:06:54.000Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#visible-password">Visible password</a></li><li><a href="#do-not-hardcode-passwords">Do not hardcode passwords</a></li><li><a href="#validate-password">Validate password</a></li><li><a href="#avoid-ui-login">Avoid UI login</a></li><li><a href="#continuous-integration">Continuous integration</a></li><li><a href="#plugins">Plugins</a></li><li><a href="#conclusions">Conclusions</a></li></ul><!-- tocstop --><p><strong>Note:</strong> source code for this blog post is the repository <a href="https://github.com/bahmutov/keep-password-secret" target="_blank" rel="noopener">bahmutov/keep-password-secret</a>.</p><h2><span id="visible-password">Visible password</span></h2><p>Imagine we have a password-protected web application. For example I have cloned <a href="https://github.com/passport/express-4.x-local-example" target="_blank" rel="noopener">passport/express-4.x-local-example</a> - you need to enter login and password to see your personal profile. We can easily write an end-to-end test for this application using <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress</a> test runner.</p><figure class="highlight js"><figcaption><span>cypress/integration/login-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in'</span>, () =&gt; &#123;</span><br><span class="line">  cy.visit(<span class="string">'/login'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=username]'</span>).type(<span class="string">'jack'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=password]'</span>).type(<span class="string">'secret'</span>)</span><br><span class="line">  cy.get(<span class="string">'[type=Submit]'</span>).click()</span><br><span class="line"></span><br><span class="line">  cy.contains(<span class="string">'a'</span>, <span class="string">'profile'</span>).should(<span class="string">'be.visible'</span>).click()</span><br><span class="line">  cy.url().should(<span class="string">'match'</span>, /profile$/)</span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>This test passes, as you can see from the test run video. It also shows the danger: the password is clearly shown in the video during &quot;TYPE&quot; command!</p><p><img src="/blog/images/secret/login-spec.gif" alt="Login spec showing the password during cy.type"></p><p>In this blog post I will show how to ways to mitigate the security risk of showing secret information like the password text during end-to-end tests. In this case, the password is local - and it is probably fine to show it in plain text. But in other situations, when testing staging or production environment, the password to the test account should NOT be visible.</p><h2><span id="do-not-hardcode-passwords">Do not hardcode passwords</span></h2><p>The first thing I would do is to remove the hard-coded password value from the test files. Right now we have the password in each spec file source code as a string <code>cy.type(&#39;secret&#39;)</code>, and instead I will pass it as an environment variable.</p><figure class="highlight js"><figcaption><span>cypress/integration/no-password-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using env variables'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  cy.visit(<span class="string">'/login'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=username]'</span>).type(username)</span><br><span class="line">  cy.get(<span class="string">'[name=password]'</span>).type(password)</span><br><span class="line">  cy.get(<span class="string">'[type=Submit]'</span>).click()</span><br><span class="line"></span><br><span class="line">  cy.contains(<span class="string">'a'</span>, <span class="string">'profile'</span>).should(<span class="string">'be.visible'</span>).click()</span><br><span class="line">  cy.url().should(<span class="string">'match'</span>, /profile$/)</span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>I believe in most cases, the <code>username</code> can be public, while <code>password</code> should be secret. Thus it is ok to store the <code>username</code> in the <code>env</code> object of <code>cypress.json</code> file. And for completeness and clarity, I store an empty value for the <code>password</code> key - this tells anyone reading the tests to expect to pass the password to make the tests work.</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"jack"</span>,</span><br><span class="line">    <span class="attr">"password"</span>: <span class="string">""</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Great - if we run Cypress now, the test will fail, because <a href="https://on.cypress.io/type" target="_blank" rel="noopener">cy.type</a> refuses to type an empty string.</p><p><img src="/blog/images/secret/no-typing-empty-strings.png" alt="cy.type will not type an empty password string"></p><p>Cypress allows several ways to pass the environment variables, in this case, the secure way is to use an environment variable <code>CYPRESS_password=...</code> when running Cypress. Cypress will stick all unknown environment variables that start with prefix <code>CYPRESS_</code> into the <code>env</code> object automatically.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_password=secret npx cypress open|run</span></span><br></pre></td></tr></table></figure><p>When running tests locally I <em>strongly</em> recommend using my <a href="https://github.com/bahmutov/as-a" target="_blank" rel="noopener">as-a</a> utility to load groups of environment variables conveniently and cross-platform. In file <code>~/.as-a/.as-a.ini</code> I will add one more INI section and will place the secret password variable there.</p><figure class="highlight ini"><figcaption><span>~/.as-a/.as-a.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[kps]</span></span><br><span class="line"><span class="comment">; group of environment variables for keep-password-secret app</span></span><br><span class="line"><span class="attr">CYPRESS_password</span>=secret</span><br></pre></td></tr></table></figure><p>When running Cypress from my terminal I use</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as-a kps npx cypress open</span><br></pre></td></tr></table></figure><p>The password variable (and any other values in the block <code>kps</code>) will be injected just for the duration of the above command.</p><p>On Continuous Integration server, just set a secure environment variable <code>CYPRESS_password</code> to value <code>secret</code>. Most CIs mask such values automatically in the logs.</p><h2><span id="validate-password">Validate password</span></h2><p>If the user forgets to open Cypress with <code>CYPRESS_password=...</code>, or if the variable is not set on CI we get a cryptic error &quot;TYPE cannot type an empty string&quot;. It would be much nicer to give a meaningful error if the password string is empty, right. Here is an updated test that first verifies the username and password values before using them.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using env variables'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line">  expect(password, <span class="string">'password was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line"></span><br><span class="line">  cy.visit(<span class="string">'/login'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=username]'</span>).type(username)</span><br><span class="line">  cy.get(<span class="string">'[name=password]'</span>).type(password)</span><br><span class="line">  cy.get(<span class="string">'[type=Submit]'</span>).click()</span><br><span class="line"></span><br><span class="line">  cy.contains(<span class="string">'a'</span>, <span class="string">'profile'</span>).should(<span class="string">'be.visible'</span>).click()</span><br><span class="line">  cy.url().should(<span class="string">'match'</span>, /profile$/)</span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>It is working - if the developer is running Cypress test without <code>CYPRESS_password=...</code> they will get a nice error.</p><p><img src="/blog/images/secret/empty-password.png" alt="Explicit empty password error"></p><p>But this is dangerous too - notice that the username assertion <code>expect(username, &#39;username was set&#39;).to.be.a(&#39;string&#39;).and.not.be.empty</code> <em>prints the value</em> in the Command Log. If the password <em>is set</em> it will be visible in the video and any screenshot.</p><p><img src="/blog/images/secret/shown-password.png" alt="Actual password is shown when assertion passes"></p><p>To avoid assertion values reflected in the Command Log, we must throw an error ourselves like this.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line"><span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// it is ok for the username to be visible in the Command Log</span></span><br><span class="line">expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line"><span class="comment">// but the password value should not be shown</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">'string'</span> || !password) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Missing password value, set using CYPRESS_password=...'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Finally, we can avoid <code>cy.type(password)</code> showing the value it is typing by using <code>cy.type(password, {log: false})</code> option.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'[name=password]'</span>).type(password, &#123;<span class="attr">log</span>: <span class="literal">false</span>&#125;)</span><br></pre></td></tr></table></figure><p>Now the Command Log will not reveal the secret password value in the video or screenshot</p><p><img src="/blog/images/secret/hide.png" alt="Password is no longer shown"></p><p>Finally, sometimes I see assertions chained at the end of <code>cy.type</code> to confirm right away the value of the input element like this:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'[name=username]'</span>)</span><br><span class="line">  .type(username)</span><br><span class="line">  .should(<span class="string">'have.value'</span>, username)</span><br><span class="line">cy.get(<span class="string">'[name=password]'</span>)</span><br><span class="line">  .type(password, &#123;<span class="attr">log</span>: <span class="literal">false</span>&#125;)</span><br><span class="line">  .should(<span class="string">'have.value'</span>, password)</span><br></pre></td></tr></table></figure><p>The assertion <code>.should(&#39;have.value&#39;, ...)</code> also prints the value in the Command Log as shown below, revealing the password, even if just part of it in this case.</p><p><img src="/blog/images/secret/partial-should.png" alt="Implicit assertion revealing a part of the asserted value"></p><p>To avoid this, again we need to throw our own error by using <a href="https://on.cypress.io/should#Function" target="_blank" rel="noopener"><code>should(callback)</code></a> assertion form.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'[name=password]'</span>)</span><br><span class="line">  .type(password, &#123; <span class="attr">log</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">  .should(<span class="function"><span class="params">el$</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (el$.val() !== password) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Different value of typed password'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>The custom errors are not shown in the Command Log.</p><p><img src="/blog/images/secret/should-cb.png" alt="Should with callback function with custom error does not reveal value"></p><h2><span id="avoid-ui-login">Avoid UI login</span></h2><p>It is fine to test the Login user interface - but every test after that should NOT use UI to log in. It is <a href="https://www.youtube.com/watch?v=5XQOK0v_YRE" target="_blank" rel="noopener">slow and unnecessary</a>. Instead, check how the web application performs the login by looking at the DevTools during UI login. In our case, the application is performing a POST request to <code>/login</code> with the username and password form.</p><p><img src="/blog/images/secret/login-form.png" alt="Inspecting login network call to find POST form submission"></p><p>Find the recipe that matches this method among <a href="https://github.com/cypress-io/cypress-example-recipes#logging-in-recipes" target="_blank" rel="noopener">Cypress Logging in recipes</a>. In this case it is <a href="https://github.com/cypress-io/cypress-example-recipes/tree/master/examples/logging-in__html-web-forms" target="_blank" rel="noopener">HTML Web Form</a> recipe. Copying the recipe to get the following test that uses <a href="https://on.cypress.io/request" target="_blank" rel="noopener"><code>cy.request</code></a> to make the form submission post and automatically sets any returned cookies.</p><figure class="highlight js"><figcaption><span>cypress/integration/api-login-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using cy.request'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// it is ok for the username to be visible in the Command Log</span></span><br><span class="line">  expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line">  <span class="comment">// but the password value should not be shown</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">'string'</span> || !password) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Missing password value, set using CYPRESS_password=...'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cy.request(&#123;</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    url: <span class="string">'/login'</span>,</span><br><span class="line">    form: <span class="literal">true</span>,</span><br><span class="line">    body: &#123;</span><br><span class="line">      username,</span><br><span class="line">      password</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.getCookie(<span class="string">'connect.sid'</span>).should(<span class="string">'exist'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now visit the profile page</span></span><br><span class="line">  cy.visit(<span class="string">'/profile'</span>).contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/secret/api-login.png" alt="Test that logs in using cy.request API call"></p><p>Beautiful, it is working, and we can make the login reusable by making it into a <a href="https://on.cypress.io/custom-commands" target="_blank" rel="noopener">Cypress custom command</a> or by creating a reusable function (which is simpler in my opinion). I will create and export <code>login</code> function from <code>cypress/support/index.js</code> file to be used in any test that wants to log in via API. Only tests that explicitly test the login page should not use this function - the rest can quickly login without going through the UI.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logs the user by making API call to POST /login.</span></span><br><span class="line"><span class="comment"> * Make sure "cypress.json" + CYPRESS_ environment variables</span></span><br><span class="line"><span class="comment"> * have username and password values set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// it is ok for the username to be visible in the Command Log</span></span><br><span class="line">  expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line">  <span class="comment">// but the password value should not be shown</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">'string'</span> || !password) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Missing password value, set using CYPRESS_password=...'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cy.request(&#123;</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    url: <span class="string">'/login'</span>,</span><br><span class="line">    form: <span class="literal">true</span>,</span><br><span class="line">    body: &#123;</span><br><span class="line">      username,</span><br><span class="line">      password</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.getCookie(<span class="string">'connect.sid'</span>).should(<span class="string">'exist'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I really like small reusable function, partly because I can document them using JSDoc comments, as above. This gives me intelligent code completion in any place I import and use <code>login</code> function, for example from the spec file.</p><p><img src="/blog/images/secret/login-intellisense.jpeg" alt="Hovering over `login` shows JSDoc comments"></p><h2><span id="continuous-integration">Continuous integration</span></h2><p>To run <a href="https://on.cypress.io/ci" target="_blank" rel="noopener">Cypress test on CI</a> I will use CircleCI - it is simple to set up, especially by using <a href="https://github.com/cypress-io/circleci-orb" target="_blank" rel="noopener">Cypress CircleCI Orb</a>.</p><figure class="highlight yaml"><figcaption><span>circle.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"><span class="attr">orbs:</span></span><br><span class="line"><span class="attr">  cypress:</span> <span class="string">cypress-io/cypress@1</span></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    jobs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cypress/run:</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npm start'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:3000'</span></span><br><span class="line">          <span class="comment"># save test run videos and screenshots on CircleCI</span></span><br><span class="line">          <span class="comment"># and they are publicly viewable, so make sure there</span></span><br><span class="line">          <span class="comment"># are no passwords in clear text!</span></span><br><span class="line"><span class="attr">          store_artifacts:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>You can find the project at <a href="https://circleci.com/gh/bahmutov/keep-password-secret" target="_blank" rel="noopener">https://circleci.com/gh/bahmutov/keep-password-secret</a>. <a href="https://circleci.com/gh/bahmutov/keep-password-secret/2" target="_blank" rel="noopener">The first run fails</a> - because I have not set <code>CYPRESS_password</code> environment variable yet.</p><p><img src="/blog/images/secret/first-run.png" alt="Run fails because we have not set CYPRESS_password yet"></p><p>We can set the required <a href="https://circleci.com/docs/2.0/env-vars/" target="_blank" rel="noopener">environment variable on CircleCI</a>, but I really like the new <a href="https://circleci.com/docs/2.0/contexts/" target="_blank" rel="noopener">CircleCI security contexts</a> because they:</p><ul><li>allow explicitly listing the context that a job expects in the circle.yml file</li><li>inject or stop the job depending on the security permission of the context</li></ul><p>So I will create a new security context <code>keep-password-secret</code> and will add the variable password there</p><p><img src="/blog/images/secret/context.png" alt="Created security context with the password environment variable"></p><p><strong>Tip:</strong> longer passwords are better, because UI masking still reveals a half of the word!</p><p>Change the <code>cypress/run</code> job by requiring the new context we have created</p><figure class="highlight yml"><figcaption><span>circle.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"><span class="attr">orbs:</span></span><br><span class="line"><span class="attr">  cypress:</span> <span class="string">cypress-io/cypress@1</span></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    jobs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cypress/run:</span></span><br><span class="line"><span class="attr">          context:</span> <span class="string">keep-password-secret</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npm start'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:3000'</span></span><br><span class="line">          <span class="comment"># save test run videos and screenshots on CircleCI</span></span><br><span class="line">          <span class="comment"># and they are publicly viewable, so make sure there</span></span><br><span class="line">          <span class="comment"># are no passwords in clear text!</span></span><br><span class="line"><span class="attr">          store_artifacts:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>And the <a href="https://circleci.com/gh/bahmutov/keep-password-secret/3" target="_blank" rel="noopener">tests pass</a>! Check out the test artifacts - you can see password in the video <code>login-spec.js.mp4</code> that shows the original, insecure spec file.</p><p><img src="/blog/images/secret/visible-password.png" alt="Password is visible in the public video stored on the CI"></p><p>But the password should not be visible in any other video - because we have modified the spec code to be less &quot;chatty&quot;.</p><h2><span id="plugins">Plugins</span></h2><p>Watch out for any <a href="https://on.cypress.io/plugins" target="_blank" rel="noopener">plugins</a> you use with Cypress Test Runner - they might be printing secrets too. For example, I will add <a href="https://github.com/bahmutov/cypress-failed-log" target="_blank" rel="noopener">cypress-failed-log</a> plugin that prints commands to the terminal.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -D cypress-failed-log</span><br></pre></td></tr></table></figure><p>The add to the support file the following<figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-failed-log'</span>)</span><br></pre></td></tr></table></figure></p><p>and to the plugins file<figure class="highlight js"><figcaption><span>cypport/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// `on` is used to hook into various events Cypress emits</span></span><br><span class="line">  <span class="comment">// `config` is the resolved Cypress config</span></span><br><span class="line">  on(<span class="string">'task'</span>, &#123;</span><br><span class="line">    failed: <span class="built_in">require</span>(<span class="string">'cypress-failed-log/src/failed'</span>)()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Let&#39;s try this module. Let&#39;s run it locally WITH <code>CYPRESS_password=secret</code> set. I will be using <code>npm test</code> script</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"node ./server"</span>,</span><br><span class="line">    <span class="attr">"dev"</span>: <span class="string">"start-test 3000 'cypress open'"</span>,</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"start-test 3000 'cypress run'"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When running <code>as-a kps npm test</code> everything runs ok - nothing sensitive is printed to the terminal. But make a test fail - for example like this</p><figure class="highlight js"><figcaption><span>cypress/integration/no-password-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using env variables'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  ... the rest <span class="keyword">of</span> the test</span><br><span class="line">  <span class="comment">// and now an incorrect assertion</span></span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com2'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Let&#39;s test this - to make sure no sensitive information is printed on failure.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ as<span class="_">-a</span> kps npx start-test 3000 \</span><br><span class="line">  <span class="string">'cypress run --spec cypress/integration/no-password-spec.js'</span></span><br></pre></td></tr></table></figure><p>The spec runs, fails - and the <code>cypress-failed-log</code> plugin prints the each command - but does not reveal anything sensitive.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  1) logs in using env variables</span><br><span class="line">assert username was set: expected jack to be a string</span><br><span class="line">assert username was set: expected jack not to be empty</span><br><span class="line">visit /login</span><br><span class="line">get [name=username]</span><br><span class="line">type jack</span><br><span class="line">assert expected &lt;input&gt; to have value jack</span><br><span class="line">get [name=password]</span><br><span class="line">get [type=Submit]</span><br><span class="line">click</span><br><span class="line">form sub --submitting form--</span><br><span class="line">page load --waiting for new page to load--</span><br><span class="line">new url http://localhost:3000/</span><br><span class="line">contains a, profile</span><br><span class="line">assert expected &lt;a&gt; to be visible</span><br><span class="line">click</span><br><span class="line">page load --waiting for new page to load--</span><br><span class="line">new url http://localhost:3000/profile</span><br><span class="line">url</span><br><span class="line">assert expected http://localhost:3000/profile to match /profile$/</span><br><span class="line">contains Email: jack@example.com2</span><br><span class="line"></span><br><span class="line">  0 passing (8s)</span><br><span class="line">  1 failing</span><br><span class="line"></span><br><span class="line">  1)  logs in using env variables:</span><br><span class="line">     CypressError: Timed out retrying: Expected to find content: &apos;Email: jack@example.com2&apos; but never did.</span><br></pre></td></tr></table></figure><p>Perfect. This plugin also saves a JSON file with the error - and the file does not reveal the password either.</p><figure class="highlight json"><figcaption><span>cypress/logs/failed-logs-in-using-env-variables.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"specName"</span>: <span class="string">"no-password-spec.js"</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"logs in using env variables"</span>,</span><br><span class="line">  <span class="attr">"suiteName"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"testName"</span>: <span class="string">" logs in using env variables"</span>,</span><br><span class="line">  <span class="attr">"testError"</span>: <span class="string">"Timed out retrying: Expected to find content: 'Email: jack@example.com2' but never did."</span>,</span><br><span class="line">  <span class="attr">"testCommands"</span>: [</span><br><span class="line">    <span class="string">"assert username was set: expected **jack** to be a string"</span>,</span><br><span class="line">    <span class="string">"assert username was set: expected **jack** not to be empty"</span>,</span><br><span class="line">    <span class="string">"visit /login"</span>,</span><br><span class="line">    <span class="string">"get [name=username]"</span>,</span><br><span class="line">    <span class="string">"type jack"</span>,</span><br><span class="line">    <span class="string">"assert expected **&lt;input&gt;** to have value **jack**"</span>,</span><br><span class="line">    <span class="string">"get [name=password]"</span>,</span><br><span class="line">    <span class="string">"get [type=Submit]"</span>,</span><br><span class="line">    <span class="string">"click "</span>,</span><br><span class="line">    <span class="string">"form sub --submitting form--"</span>,</span><br><span class="line">    <span class="string">"page load --waiting for new page to load--"</span>,</span><br><span class="line">    <span class="string">"new url http://localhost:3000/"</span>,</span><br><span class="line">    <span class="string">"contains a, profile"</span>,</span><br><span class="line">    <span class="string">"assert expected **&lt;a&gt;** to be **visible**"</span>,</span><br><span class="line">    <span class="string">"click "</span>,</span><br><span class="line">    <span class="string">"page load --waiting for new page to load--"</span>,</span><br><span class="line">    <span class="string">"new url http://localhost:3000/profile"</span>,</span><br><span class="line">    <span class="string">"url "</span>,</span><br><span class="line">    <span class="string">"assert expected **http://localhost:3000/profile** to match /profile$/"</span>,</span><br><span class="line">    <span class="string">"contains Email: jack@example.com2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"screenshot"</span>: <span class="string">"logs-in-using-env-variables-failed.png"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Great - this plugin seems safe to use.</p><h2><span id="conclusions">Conclusions</span></h2><p>Keeping sensitive information out of public logs, screenshots and videos is a very important and ongoing concern. Make sure that every commit even if it  <em>only changes the tests</em> goes through code review. If a password has been accidentally revealed, even during the pull request, revoke it and use a new one. For example, here is a quick way to get a random password using Node from the terminal</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node -p <span class="string">"crypto.randomBytes(16).toString('hex')"</span></span><br><span class="line">d01ce7056fb2eab425161dcfa5bdb502</span><br></pre></td></tr></table></figure><p>Read more about Cypress and ways to use it in the linked resourced</p><ul><li><a href="../cypress-tips-and-tricks/">Cypress tips and tricks</a></li><li><a href="https://www.cypress.io/blog" target="_blank" rel="noopener">Cypress technical blog</a></li><li>My <a href="../cypress-talks/">recent Cypress talks</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#visible-password&quot;&gt;Visible password&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#do-not-hardcode-passwords&quot;&gt;Do not hardcode passwor
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="security" scheme="https://glebbahmutov.com/blog/tags/security/"/>
    
  </entry>
  
  <entry>
    <title>How to set up Mocha with Sinon.js</title>
    <link href="https://glebbahmutov.com/blog/mocha-and-sinon/"/>
    <id>https://glebbahmutov.com/blog/mocha-and-sinon/</id>
    <published>2019-11-29T05:00:00.000Z</published>
    <updated>2020-02-18T16:17:39.093Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#basic-setup">Basic setup</a></li><li><a href="#sandbox">Sandbox</a></li><li><a href="#global-sandbox">Global sandbox</a></li><li><a href="#ci-setup">CI setup</a></li><li><a href="#assertions">Assertions</a></li><li><a href="#matches">Matches</a></li><li><a href="#see-also">See also</a></li></ul><!-- tocstop --><p>Let&#39;s say we have a small Node program and want to confirm it logs &quot;Hello&quot; string to the console</p><figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Hello'</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123; app &#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">module</span>.parent) &#123;</span><br><span class="line">  app()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ npm start</span><br><span class="line">&gt; node ./app</span><br><span class="line"></span><br><span class="line">Hello</span><br></pre></td></tr></table></figure><p>We need a test runner to write a test and an ability to spy <code>console.log</code> method. We could write both the test runner and method spying ourselves, but there are already 2 great tools for this: <a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha.js</a> and <a href="https://sinonjs.org/" target="_blank" rel="noopener">Sinon.js</a>. Let&#39;s use them.</p><p><strong>Note:</strong> you can find the source code for this blog post in <a href="https://github.com/bahmutov/mocha-sinon-example" target="_blank" rel="noopener">mocha-sinon-example</a> repository.</p><h2><span id="basic-setup">Basic setup</span></h2><p>First, install both NPM dependencies</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add -D mocha sinon</span><br><span class="line">info Direct dependencies</span><br><span class="line">├─ mocha@6.2.2</span><br><span class="line">└─ sinon@7.5.0</span><br></pre></td></tr></table></figure><p>Next, write a spec file <code>test/app-spec.js</code> that will import <code>app</code>, set up spying and then confirm the spy was called with expected argument</p><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">'../app'</span>)</span><br><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sinon.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>To run unit tests, I like using NPM script command <code>npm test</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"mocha 'test/*-spec.js'"</span>,</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"node ./app"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The test passes</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ npm t</span><br><span class="line"></span><br><span class="line">&gt; mocha-sinon-example@1.0.0 test /Users/gleb/git/mocha-sinon-example</span><br><span class="line">&gt; mocha &apos;test/*-spec.js&apos;</span><br><span class="line"></span><br><span class="line">Hello</span><br><span class="line">  ✓ logs Hello</span><br><span class="line"></span><br><span class="line">  1 passing (5ms)</span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> whenever there is new code pulled for the project, I like using shortcut <code>npm it</code> to run <code>npm install</code> + <code>npm test</code> together. Even better, I could use shortcut <code>npm cit</code> that runs <code>npm ci</code> + <code>npm test</code> together.</p><h2><span id="sandbox">Sandbox</span></h2><p>We have set up a <a href="https://sinonjs.org/releases/v7.5.0/spies/" target="_blank" rel="noopener">Sinon spy</a> on the global <code>console.log</code> - but we have not cleared it. This could lead to unexpected behavior in the unit tests that follow. For example if the next test runs by itself it works</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sinon.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line">it.only(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sinon.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>But when the two tests run together the second attempt to spy causes an error.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) logs again:</span><br><span class="line">     TypeError: Attempted to wrap log which is already wrapped</span><br></pre></td></tr></table></figure><p>We really don&#39;t want the two tests to be dependent on each other. Thus I strongly recommend using <a href="https://sinonjs.org/releases/v7.5.0/sandbox/" target="_blank" rel="noopener">Sinon sandboxes</a>. We could create the sandbox once and reset the sandbox before each test in a single call.</p><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">'../app'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sandbox</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  sandbox = sinon.createSandbox()</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  sandbox.restore()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  <span class="comment">// no problems</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="global-sandbox">Global sandbox</span></h2><p>Rather than each spec file creating a sandbox (and restoring it), we could move the <code>before</code> and <code>beforeEach</code> hooks into its own test helper file, creating <a href="https://mochajs.org/#root-level-hooks" target="_blank" rel="noopener">root-level hooks</a>.</p><figure class="highlight js"><figcaption><span>test/helper.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  global.sandbox = sinon.createSandbox()</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  global.sandbox.restore()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">'../app'</span>)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  <span class="comment">// no problems</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>I change the NPM test script to load the helper file</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"mocha test/helper 'test/*-spec.js'"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="ci-setup">CI setup</span></h2><p>Let&#39;s run these tests on CI - I will use GitHub Actions because <a href="../trying-github-actions/">they are awesome</a>. I have added <code>.github/workflows/test.yml</code> file.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">main</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">npm</span> <span class="string">t</span></span><br></pre></td></tr></table></figure><p>The code is checked out, <a href="https://github.com/bahmutov/npm-install" target="_blank" rel="noopener">bahmutov/npm-install</a> action runs <code>yarn</code> with caching of NPM dependencies, and then <code>npm t</code> runs unit tests.</p><p><img src="/blog/images/mocha-sinon/action.png" alt="GitHub Action output"></p><h2><span id="assertions">Assertions</span></h2><p>In the above example, we used a plain Error in case the spy was not called as expected.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Sinon.js comes with <code>assert</code> methods that can help produce better error messages with more context. For example, if we expect the spy to have been called with &quot;Bye&quot; for some reason, the error message prints the actual calls</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'sinon'</span>).assert.calledWith(log, <span class="string">'Bye'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/mocha-sinon/sinon-assert.png" alt="Sinon.assert error message"></p><p>Even better is to bring in <a href="https://www.chaijs.com/" target="_blank" rel="noopener">Chai</a> assertions with <a href="https://github.com/domenic/sinon-chai" target="_blank" rel="noopener">Sinon.js Chai</a> plugin.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add -D chai sinon-chai</span><br><span class="line">info Direct dependencies</span><br><span class="line">├─ chai@4.2.0</span><br><span class="line">└─ sinon-chai@3.3.0</span><br></pre></td></tr></table></figure><p>Then add to the <code>test/helper.js</code> file the following</p><figure class="highlight js"><figcaption><span>test/helper.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chai = <span class="built_in">require</span>(<span class="string">'chai'</span>)</span><br><span class="line"><span class="keyword">const</span> sinonChai = <span class="built_in">require</span>(<span class="string">'sinon-chai'</span>)</span><br><span class="line">chai.use(sinonChai)</span><br><span class="line">global.expect = chai.expect</span><br><span class="line"><span class="comment">// global Sinon sandbox code ...</span></span><br></pre></td></tr></table></figure><p>Now we can use easy to read assertions inside the specs</p><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  expect(log).to.have.been.calledOnceWith(<span class="string">'Hello'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="matches">Matches</span></h2><p>If you don&#39;t know the exact argument a stub or a spy should be called, you can use <code>sinon.match</code> utils. For example, if the code calls the method with <code>o.method(&#39;hello&#39;, name)</code> then you can assert it with</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line"><span class="keyword">const</span> greeting = sinon.spy(o, <span class="string">'method'</span>)</span><br><span class="line">expect(greeting).to.have.been.calledOnceWithExactly(<span class="string">'hello'</span>, sinon.match.string)</span><br></pre></td></tr></table></figure><h2><span id="see-also">See also</span></h2><ul><li><a href="../spying-on-methods">Spying on methods</a></li><li><a href="../picking-javascript-testing-framework">Picking JavaScript testing framework</a></li><li><a href="../lock-down-sinon-stub">Lock down Sinon stub</a></li><li><a href="../unit-testing-cli-programs">Unit testing CLI programs</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#basic-setup&quot;&gt;Basic setup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sandbox&quot;&gt;Sandbox&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#global-sandbox&quot;&gt;Glob
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="javascript" scheme="https://glebbahmutov.com/blog/tags/javascript/"/>
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
  </entry>
  
  <entry>
    <title>Cypress Talks</title>
    <link href="https://glebbahmutov.com/blog/cypress-talks/"/>
    <id>https://glebbahmutov.com/blog/cypress-talks/</id>
    <published>2019-11-19T05:00:00.000Z</published>
    <updated>2019-11-19T03:36:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>Lately I had the privilege to speak at several conferences about Cypress.io and our testing philosophy. This blog post collects the videos and slides for easy access, and I plan to be adding new videos as I talk about Cypress at other events.</p><h2><span id="reactiveconf-2019">ReactiveConf 2019</span></h2><p><strong>Cypress.io - the State of the Art End-to-end Testing Tool</strong> Oct 2019</p><p>Presented at ReactiveConf 2019 in Prague, Czech Republic, <a href="https://www.youtube.com/watch?v=JL3QKQO80fs" target="_blank" rel="noopener">video</a>, <a href="https://slides.com/bahmutov/state-of-the-art/" target="_blank" rel="noopener">slides</a></p><center>  <iframe data-cy="talk" width="560" height="315" src="https://www.youtube.com/embed/JL3QKQO80fs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><h3><span id="main-sections">Main sections</span></h3><ul><li>Lint pyramid <a href="https://youtu.be/JL3QKQO80fs?t=226" target="_blank" rel="noopener">video at 3m46s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/lint-pyramid" target="_blank" rel="noopener">slides</a> (Prettier, ESLint, <code>@ts-check</code>)</li><li>Tests and plugins <a href="https://youtu.be/JL3QKQO80fs?t=429" target="_blank" rel="noopener">video at 7m9s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/only-tests" target="_blank" rel="noopener">slides</a> (unit, component, web application, visual testing, a11y testing, API testing)</li><li>Code coverage <a href="https://youtu.be/JL3QKQO80fs?t=699" target="_blank" rel="noopener">video at 11m39s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/code-coverage" target="_blank" rel="noopener">slides</a></li><li>Splitting end-to-end test via App Actions and checkpoints <a href="https://youtu.be/JL3QKQO80fs?t=1205" target="_blank" rel="noopener">video at 20m5s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/test-length" target="_blank" rel="noopener">slides</a>, read <a href="https://www.cypress.io/blog/2019/10/29/split-a-very-long-cypress-test-into-shorter-ones-using-app-actions/" target="_blank" rel="noopener">Split a very long Cypress test into shorter ones using App Actions</a> blog post</li></ul><h2><span id="allthingsopen">AllThingsOpen</span></h2><p><strong>Achievement Unlocked</strong> Oct 2019, <a href="https://youtu.be/2gP1-TNDzK4" target="_blank" rel="noopener">video</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked" target="_blank" rel="noopener">slides</a></p><center>  <iframe width="560" height="315" src="https://www.youtube.com/embed/2gP1-TNDzK4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><h3><span id="main-sections">Main sections</span></h3><ul><li>Tests and plugins <a href="https://youtu.be/2gP1-TNDzK4?t=367" target="_blank" rel="noopener">video at 6m5s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/only-tests" target="_blank" rel="noopener">slides</a>, check out <a href="https://on.cypress.io/plugins" target="_blank" rel="noopener">Cypress plugins</a></li><li>Cypress code coverage plugin <a href="https://youtu.be/2gP1-TNDzK4?t=764" target="_blank" rel="noopener">video at 12m44s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/code-coverage" target="_blank" rel="noopener">slides</a><ul><li>end-to-end, unit and full-stack code coverage, read <a href="https://on.cypress.io/code-coverage" target="_blank" rel="noopener">Cypress code coverage guide</a></li></ul></li><li>Cypress as a business <a href="https://youtu.be/2gP1-TNDzK4?t=1238" target="_blank" rel="noopener">video at 20m38s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/business" target="_blank" rel="noopener">slides</a><ul><li>How we make money as a company while giving the Test Runner away for free</li></ul></li><li>Current and future work <a href="https://youtu.be/2gP1-TNDzK4?t=1881" target="_blank" rel="noopener">videp at 31m21s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/roadmap" target="_blank" rel="noopener">slides</a><ul><li>Test analytics</li><li>Run tagging</li><li>Firefox support</li><li>Better errors</li><li>Test retries</li></ul></li></ul><h2><span id="revojs">Revo.js</span></h2><p>A great community conference in Timisoara, Romania. I recommend it 100%.</p><p><strong>Wait, before you write your next test...</strong> Oct 2019, <a href="https://youtu.be/T_jr0buAZ_Y" target="_blank" rel="noopener">video</a>, <a href="https://cypress.slides.com/cypress-io/next-test" target="_blank" rel="noopener">slides</a></p><center>  <iframe width="560" height="315" src="https://www.youtube.com/embed/T_jr0buAZ_Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>Slides at <a href="https://cypress.slides.com/cypress-io/next-test" target="_blank" rel="noopener">https://cypress.slides.com/cypress-io/next-test</a>, and the talk covers</p><ul><li>How I avoid writing tests by using linters</li><li>How code coverage is a great tool for directing test writing</li><li>How I make tests faster by using <a href="https://www.cypress.io/blog/2019/01/03/stop-using-page-objects-and-start-using-app-actions/" target="_blank" rel="noopener">app actions</a>, read blog post <a href="https://www.cypress.io/blog/2019/10/29/split-a-very-long-cypress-test-into-shorter-ones-using-app-actions/" target="_blank" rel="noopener">Split a very long Cypress test into shorter ones using App Actions</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Lately I had the privilege to speak at several conferences about Cypress.io and our testing philosophy. This blog post collects the video
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
</feed>
