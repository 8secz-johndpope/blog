<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HTTP/2 server push on Dokku | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Please read Getting started with Http/2 and server push for the base for this example. Main links  source code for this post plain http1.1 server http2 server  The problem with HTTP 1.1The current tex">
<meta name="keywords" content="nodejs,performance,docker">
<meta property="og:type" content="article">
<meta property="og:title" content="HTTP&#x2F;2 server push on Dokku">
<meta property="og:url" content="https://glebbahmutov.com/blog/server-push-on-dokku/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="Please read Getting started with Http/2 and server push for the base for this example. Main links  source code for this post plain http1.1 server http2 server  The problem with HTTP 1.1The current tex">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/plain/local-http1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/http2-support.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/plain-http2/plain-http2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/ab7c58e363a3800fbb979e80eac888f462dbb30c/local-http2-with-push.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/push/dokku-with-push.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/push/dokku-without-push.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/local-bud-proxy.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/dokku-bud-http1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/dokku-bud-http2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/http1-vs-server-push-browser-caching.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/http2-cached.png">
<meta property="og:updated_time" content="2018-02-14T02:33:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HTTP&#x2F;2 server push on Dokku">
<meta name="twitter:description" content="Please read Getting started with Http/2 and server push for the base for this example. Main links  source code for this post plain http1.1 server http2 server  The problem with HTTP 1.1The current tex">
<meta name="twitter:image" content="https://raw.githubusercontent.com/bahmutov/http2-push-example/plain/local-http1.png">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!-- <div id="banner"></div> -->
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../index.html" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <!-- <span class="no-mobile">Software advice from</span> -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">
          <a id="subtitle" href="http://glebbahmutov.com">Gleb Bahmutov PhD</a>
        </span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-server-push-on-dokku" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2017-01-06T05:00:00.000Z" itemprop="datePublished">Jan 6 2017</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      HTTP/2 server push on Dokku
    </h1>

    <h2 class="article-title" itemprop="name">
      Speed up resources by pushing them from a Node HTTP/2 server.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Please read <a href="https://deanhume.com/Home/BlogPost/getting-started-with-http-2-and-server-push/10152" target="_blank" rel="noopener">Getting started with Http/2 and server push</a> for the
base for this example.</p>
<p><strong>Main links</strong></p>
<ul>
<li><a href="https://github.com/bahmutov/http2-push-example" target="_blank" rel="noopener">source code for this post</a></li>
<li><a href="http://gleb-demos.com:32772" target="_blank" rel="noopener">plain http1.1 server</a></li>
<li><a href="https://gleb-demos.com:1443/" target="_blank" rel="noopener">http2 server</a></li>
</ul>
<h2><span id="the-problem-with-http-11">The problem with HTTP 1.1</span></h2><p>The current text HTTP standard breaks when your website is serving many
resources. First, the HTML page is fetched, then the browser requests
other resources linked from the page. Each request opens a new connection
(involves TLS and HTTP handshakes) which is expensive. The typical
waterfall is well-known to the web developers; the resources stack down
and to the right in the DevTools Network panel.</p>
<p>For example, here is a local HTTPS server (with self-signed certificate),
serving a page which includes two images from folder <code>public</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">'https'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(express.static(<span class="string">'public'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tlsOptions = &#123;</span><br><span class="line">  key: fs.readFileSync(<span class="string">'./server.key'</span>),</span><br><span class="line">  cert: fs.readFileSync(<span class="string">'./server.crt'</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">5000</span></span><br><span class="line">server.createServer(tlsOptions, app).listen(port, err =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'listening on port'</span>, port)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>We can connect to the server <code>https://localhost:5000</code> in Chrome (I am using
version 55) and observe the download times. Not too bad, because the network
only has to perform local download, yet we the images only start downloading
after the page has finished.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/plain/local-http1.png" alt="HTTP 1.1"></p>
<p>Of course, the browsers try to anticipate the future download, and might
prefetch the images immediately. The ultimate logic lies with the page though.</p>
<p>Can we do something different? When the server is serving the index page from
<code>public/index.html</code>, the <em>page</em> knows that the user will ask for two images
next. If only we could put more logic into the server and immediately
<strong>push</strong> these images to the client browser, we could speed things up.</p>
<h2><span id="enter-http2">Enter HTTP/2</span></h2><p><a href="https://http2.github.io/" target="_blank" rel="noopener">HTTP/2</a> is a major performance-related reworking
of the existing HTTP protocol. A single connection can multiplex multiple
binary resources, greatly improving the overall web browsing performance.</p>
<p>In our case, we can use take advantage of HTTP/2 feature called &quot;Server push&quot;
to transfer two binary images to the client <em>in the same connection stream
with <code>index.html</code></em>. Here is the code, which takes advantage of a Nodejs
module called <a href="https://github.com/indutny/node-spdy" target="_blank" rel="noopener">spdy</a>. Despite its name,
<code>spdy</code> implements HTTP2 protocol support too. There are no changes to move
from Node <code>https</code> module to <code>spdy</code> to take advantage of HTTP/2.
Just a different module name.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">'spdy'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(morgan(<span class="string">'dev'</span>))</span><br><span class="line">app.use(express.static(<span class="string">'public'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tlsOptions = &#123;</span><br><span class="line">  key: fs.readFileSync(<span class="string">'./server.key'</span>),</span><br><span class="line">  cert: fs.readFileSync(<span class="string">'./server.crt'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">5000</span></span><br><span class="line">server.createServer(tlsOptions, app).listen(port, err =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'listening on port'</span>, port)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The Chrome browser (and other modern browsers too!) should have no problem
connecting and receiving information over HTTP2 protocol. The new protocol
has been widely adapted already, see
<a href="http://caniuse.com/#feat=http2" target="_blank" rel="noopener">http://caniuse.com/#feat=http2</a></p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/http2-support.png" alt="HTTP2 browser support"></p>
<p>In the DevTools, you might want to enable &quot;Protocol&quot; column to see the &quot;h2&quot;
text.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/plain-http2/plain-http2.png" alt="HTTP/2 baby!"></p>
<p>Yet, there is no performance benefits yet. The server has to implement that
&quot;Server Push&quot; feature that sends images when serving the <code>index.html</code>
in the same response.</p>
<h2><span id="server-push">Server push</span></h2><p>We need to serve the <code>index.html</code> page differently, and we can detect if the
server push is available or not.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, serveHome)</span><br><span class="line">app.use(express.static(<span class="string">'public'</span>))</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">serveHome</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (res.push) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'browser supports HTTP/2 Push!!!'</span>)</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  res.writeHead(<span class="number">200</span>)</span><br><span class="line">  res.end(<span class="comment">/* index.html file contents */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the client browser supports HTTP/2 (which <code>spdy</code> determines for us by
inspecting connection headers), we should push the loaded file contents.
This is very simple, and can be factored into a clean function</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> image1 = fs.readFileSync(<span class="string">'./public/images/image1.jpg'</span>)</span><br><span class="line"><span class="keyword">const</span> image2 = fs.readFileSync(<span class="string">'./public/images/image2.jpg'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushFile</span> (<span class="params">path, contents, options, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stream = res.push(path, options)</span><br><span class="line">  stream.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error)</span><br><span class="line">  stream.end(contents)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> imageOptions = &#123;</span><br><span class="line">  request: &#123;<span class="attr">accept</span>: <span class="string">'image/*'</span>&#125;,</span><br><span class="line">  response: &#123;<span class="string">'content-type'</span>: <span class="string">'image/jpeg'</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">serveHome</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (res.push) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'browser supports HTTP/2 Push!!!'</span>)</span><br><span class="line">    <span class="comment">// note we are passing response object "res"</span></span><br><span class="line">    pushFile(<span class="string">'/images/image1.jpg'</span>, image1, imageOptions, res)</span><br><span class="line">    pushFile(<span class="string">'/images/image2.jpg'</span>, image2, imageOptions, res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above function <code>serveHome</code> preemptively pushes two files that the
client &quot;might&quot; request. The server push will only match requests
with the given url and request headers.</p>
<p>The file contents has been preloaded (or it could be piped as a stream), and
we open a stream from the response object. Under the hood, the new stream
will be multiplexed in the response stream. This can be a performance
improvement, yet in my experiments it was not very obvious.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/ab7c58e363a3800fbb979e80eac888f462dbb30c/local-http2-with-push.png" alt="Server push"></p>
<h2><span id="deployment">Deployment</span></h2><p>I hope to get a sense how hard it is to get the Server Push working in
more realistic &quot;production&quot; environment.</p>
<p>Let us deploy our application to <a href="https://github.com/dokku/dokku" target="_blank" rel="noopener">Dokku</a>
which I run on a small DigitalOcean droplet. You might want to read my
other <a href="../running-multiple-applications-in-dokku/">blog post</a>
if you have never dealt with Dokku before. I will push a local branch called
&quot;push&quot; to Dokku to be the remote &quot;master&quot; branch.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push dokku push:master</span><br></pre></td></tr></table></figure>
<p>The deployment goes through and the logs show the server has started.
On Dokku:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dokku:~<span class="comment"># dokku logs http2-push-example</span></span><br><span class="line">2017-01-07T15:10:52.096201952Z app[web.1]:</span><br><span class="line">2017-01-07T15:10:52.096317957Z app[web.1]: &gt; http2-push-example@1.0.0 start /app</span><br><span class="line">2017-01-07T15:10:52.096327765Z app[web.1]: &gt; node index.js</span><br><span class="line">2017-01-07T15:10:52.096333490Z app[web.1]:</span><br><span class="line">2017-01-07T15:10:52.532157649Z app[web.1]: listening on port 5000</span><br></pre></td></tr></table></figure>
<p>The Node app is even serving the index page if we grab the internal IP of
the server process.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dokku:~<span class="comment"># cat /home/dokku/http2-push-example/nginx.conf</span></span><br><span class="line">...</span><br><span class="line">upstream http2-push-example-5000 &#123;</span><br><span class="line">  server 172.17.0.9:5000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now make the request to <code>172.17.0.9:5000</code>, but remember that we have
a self-signed certificate.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dokku:~<span class="comment"># curl https://172.17.0.9:5000 --insecure</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;HTTP2 Push Demo&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;h1&gt;HTTP2 Push FTW!&lt;/h1&gt;</span><br><span class="line">  &lt;img src=<span class="string">"./images/image1.jpg"</span> alt=<span class="string">"image 1"</span> /&gt;</span><br><span class="line">  &lt;br/&gt;</span><br><span class="line">  &lt;img src=<span class="string">"./images/image2.jpg"</span> alt=<span class="string">"image 2"</span> /&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>Yet, when we try to fetch the page from the external address, we get 502
error (I already got TLS certificate using Dokku LetsEncrypt <a href="https://github.com/dokku/dokku-letsencrypt" target="_blank" rel="noopener">plugin</a>).</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ http https://http2-push-example.gleb-demos.com</span><br><span class="line">HTTP/1.1 502 Bad Gateway</span><br></pre></td></tr></table></figure>
<p>Dokku runs two processes for each application. There is our server and
there is an Nginx proxy dealing with domain, virtual hosts, etc. The Nginx
proxy has trouble accepting our self-signed certificate AND cannot proxy
correctly HTTP/2 connections with Server Push (see first this <a href="https://trac.nginx.org/nginx/ticket/923" target="_blank" rel="noopener">issue</a>
and then the <a href="https://www.nginx.com/blog/nginx-1-9-5/" target="_blank" rel="noopener">support announcement</a>). Proxying HTTP/2
presents a very different challenge from proxying HTTP 1.1 - the connection
is long lived and binary.</p>
<p>For now we can <a href="http://dokku.viewdocs.io/dokku/advanced-usage/proxy-management/" target="_blank" rel="noopener">disable the Nginx proxy</a> and let the server
respond directly.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dokku:~<span class="comment"># dokku proxy:disable http2-push-example</span></span><br><span class="line">...</span><br><span class="line">-----&gt; VHOST support disabled. Skipping domains setup</span><br><span class="line">-----&gt; nginx support is disabled <span class="keyword">for</span> app (http2-push-example).</span><br><span class="line">-----&gt; deleting nginx.conf</span><br><span class="line">-----&gt; reloading nginx after nginx.conf deletion</span><br><span class="line">...</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       https://gleb-demos.com:32768 (container)</span><br></pre></td></tr></table></figure>
<p>Without setting up virtual host we can access the application using a random
port above.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://gleb-demos.com:32768 --insecure</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;HTTP2 Push Demo&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;h1&gt;HTTP2 Push FTW!&lt;/h1&gt;</span><br><span class="line">  &lt;img src=<span class="string">"./images/image1.jpg"</span> alt=<span class="string">"image 1"</span> /&gt;</span><br><span class="line">  &lt;br/&gt;</span><br><span class="line">  &lt;img src=<span class="string">"./images/image2.jpg"</span> alt=<span class="string">"image 2"</span> /&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>We can check if the server supports HTTP/2 (of course it should) using
<a href="https://github.com/stefanjudis/is-http2-cli#readme" target="_blank" rel="noopener">is-http2-cli</a> tool</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -g is-http2-cli</span><br><span class="line">$ is-http2 https://gleb-demos.com:32768</span><br><span class="line">âœ“ HTTP/2 supported by https://gleb-demos.com:32768</span><br><span class="line">Supported protocols: h2 http/1.1</span><br></pre></td></tr></table></figure>
<p>Opening the page in the browser shows the following network timings</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/push/dokku-with-push.png" alt="Dokku with HTTP/2 Push"></p>
<p>Same setup, but I have disabled server push in code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> homePageWithPush = <span class="function"><span class="params">files</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">false</span> &amp;&amp; res.push) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/push/dokku-without-push.png" alt="Dokku without HTTP/2 Push"></p>
<blockquote>
<p>Hmm, there is no performance gain at all! What is going on?</p>
</blockquote>
<p>You can see the HTTP/2 without server push at
<a href="https://http2.gleb-demos.com/" target="_blank" rel="noopener">https://http2.gleb-demos.com/</a>.</p>
<h2><span id="running-behind-proxy">Running behind proxy</span></h2><p>Ordinarily the Nodejs program does not handle the immediate connection from
the client. A dedicated &quot;hardened&quot; proxy like Nginx is used to receive the
TLS connection, then forward the request over regular unsecured channel to
the Node server.</p>
<p>Nginx <a href="https://trac.nginx.org/nginx/ticket/923" target="_blank" rel="noopener">does not support</a> HTTP/2 with Server Push forwarding,
thus we need a different proxy. The author of <a href="https://github.com/indutny/node-spdy" target="_blank" rel="noopener">spdy</a>
<a href="https://twitter.com/indutny" target="_blank" rel="noopener">Fedor Indutny</a> wrote <a href="https://github.com/indutny/bud" target="_blank" rel="noopener">Bud</a> - a TLS
terminator that understands HTTP/2. Big thanks for both, Fedor!</p>
<p>We can install Bud locally to try it out. While Bud is written in C, it
is distributed via NPM, and compiles as a native module on Mac.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g bud</span><br></pre></td></tr></table></figure>
<p>We need to generate a config file - there are a lot of settings!</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bud --default-config &gt; bud.default.json</span><br></pre></td></tr></table></figure>
<p>The generated <a href="https://github.com/bahmutov/http2-push-example/blob/master/bud.config.json" target="_blank" rel="noopener">bud.default.json</a> has lots of settings, but
for our purposes we just need to update only two parameters. First, we need to
set the destination for the proxy - the backend address. In our case
it is local IP and port 5000 by default.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"backend"</span>: [&#123;</span><br><span class="line">    <span class="attr">"port"</span>: <span class="number">5000</span>,</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"127.0.0.1"</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We also need to tell the proxy (the &quot;frontend&quot; connection) to forward HTTP/2
connections to the backend. We wiil add the &quot;h2&quot; protocol to the list of
handshakes to be sent to the backend.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"frontend"</span>: &#123;</span><br><span class="line">    <span class="attr">"port"</span>: <span class="number">1443</span>,</span><br><span class="line">    <span class="attr">"npn"</span>: [<span class="string">"h2"</span>, <span class="string">"http/1.1"</span>, <span class="string">"http/1.0"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let us start the Bud proxy</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ bud -c bud.config.json</span><br><span class="line">(inf) [16573] spawned bud worker&lt;16574&gt;</span><br><span class="line">(inf) [16573] bud listening on [0.0.0.0]:1443 and...</span><br><span class="line">(inf) [16573] ...forwarding to: [127.0.0.1]:5000</span><br><span class="line">(inf) [16574] Worker updated ticket key <span class="keyword">for</span> context: 0</span><br></pre></td></tr></table></figure>
<p>Then start our server. Since we no longer require TLS <em>in the Node server</em>,
we remove the certificates and create server with <code>spdy</code> module with a
configuration that allows plain non-ssl connections.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// no certificates!</span></span><br><span class="line"><span class="keyword">const</span> tlsOptions = &#123;</span><br><span class="line">  spdy: &#123;</span><br><span class="line">    plain: <span class="literal">true</span>,</span><br><span class="line">    ssl: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">server.createServer(tlsOptions, app)</span><br></pre></td></tr></table></figure>
<p>Both proxy and our server are running and the client can connect and have
HTTP/2 server push.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/local-bud-proxy.png" alt="Local HTTP/2 via Bud"></p>
<h2><span id="bud-on-dokku">Bud on Dokku</span></h2><p>Now we can push the server code to Dokku. We can also run Bud as a good
proxy there to replace Nginx for this particular application.
Because we have disabled Nginx to find the
the port the Node process is listening at, just run <code>docker ps</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">PORTS 0.0.0.0:32771-&gt;5000/tcp</span><br></pre></td></tr></table></figure>
<p>The Node process is running at the port <code>32771</code> after deployment.
We can test by going to the insecure connection <code>http://gleb-demos.com:32771</code></p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/dokku-bud-http1.png" alt="Dokku Node HTTP 1.1"></p>
<p>Let us secure the connection and allow HTTP/2 connections.
Put <code>bud.config.json</code> somewhere on Dokku and edit the backend address.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"backend"</span>: [&#123;</span><br><span class="line">    <span class="attr">"port"</span>: <span class="number">32771</span>,</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Start Bud process and keep it running when the SSH connection is terminated.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup bud --config bud.config.json &amp;</span><br></pre></td></tr></table></figure>
<p>Now connect through self-signed certificate to
<a href="https://gleb-demos.com:1443/" target="_blank" rel="noopener">https://gleb-demos.com:1443/</a></p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/dokku-bud-http2.png" alt="Bud HTTP/2 proxy on Dokku"></p>
<p>In general I found HTTP/2 connection with Server push to be
slightly faster than HTTP 1.1 page loads. Yet there is no consistent data
I could collect to prove it.</p>
<p>We should test the load on our server using HTTP2 aware tool,
like <a href="https://nghttp2.org/documentation/h2load-howto.html" target="_blank" rel="noopener">h2load</a>, but compiling this tool requires too much effort :(</p>
<h2><span id="browser-caching-is-the-real-performance-winner">Browser caching is the real performance winner</span></h2><p>The main performance benefit when downloading large resources comes not
from optimizing the network or delivery, but from NOT downloading the same
resource multiple times. In our implementation, Server Push <em>always</em> pushed
the resources without telling the browser that these resources might be
already in the browser&#39;s cache. Compare the page load performance when the
development setting &quot;Disable cache&quot; is turned off. HTTP 1.1 beats server-push
handily!</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/http1-vs-server-push-browser-caching.png" alt="Page load with browser cache turned on"></p>
<p>We need to allow browser to cache the pushed resources. Let us add the
appropriate headers to the response.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> imageOptions = &#123;</span><br><span class="line">  request: &#123;</span><br><span class="line">    accept: <span class="string">'image/*'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  response: &#123;</span><br><span class="line">    <span class="string">'content-type'</span>: <span class="string">'image/jpeg'</span>,</span><br><span class="line">    <span class="string">'cache-control'</span>: <span class="string">'public, max-age=99999'</span>,</span><br><span class="line">    <span class="string">'last-modified'</span>: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Redeploying the server to Dokku and the images are now appearing instantly
(they are part of the <code>index.html</code> page response). Note, that this changed
the application port to <code>32772</code>.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/http2-push-example/master/http2-cached.png" alt="HTTP2 resources are cached by the browser"></p>
<p>Much better.</p>
<h2><span id="thoughts">Thoughts</span></h2><p>I expected more from Server Push to be honest. Due to some flaky demo,
I once got side by side data where the HTTP/2 version was loading images in
1/3 of the time it took HTTP 1.1 to load and got super excited. Yet I could
not repeat these numbers!</p>
<p>This is another reminder to be vigilant against drawing conclusions before
the data can be confirmed.</p>
<h3><span id="additional-resources-and-reading">Additional resources and reading</span></h3><ul>
<li><a href="https://blog.cloudflare.com/tools-for-debugging-testing-and-using-http-2/" target="_blank" rel="noopener">Tools for debugging, testing and using HTTP/2</a></li>
<li><a href="https://calendar.perfplanet.com/2016/even-faster-images-using-http2-and-progressive-jpegs/" target="_blank" rel="noopener">Even Faster Images using HTTP2 and Progressive JPEGs</a></li>
<li><a href="https://calendar.perfplanet.com/2016/http2-push-the-details/" target="_blank" rel="noopener">HTTP/2 Push: The details</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/http2/" target="_blank" rel="noopener">Introduction to HTTP/2</a></li>
<li>Two great resources <a href="https://canipush.com/" target="_blank" rel="noopener">https://canipush.com/</a>
and <a href="https://shouldipush.com/" target="_blank" rel="noopener">https://shouldipush.com/</a></li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/server-push-on-dokku/" data-id="cjvv7mlq801fqloooe0p36wno" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/server-push-on-dokku/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/nodejs/">nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/performance/">performance</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../jscodeshift-example/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          jscodeshift example
        
      </div>
    </a>
  
  
    <a href="../cypress-tips-and-tricks/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Cypress tips and tricks</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">108</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">311</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">100</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">38</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">68</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/">github</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/">graphql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">160</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">76</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">91</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/zeit/">zeit</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.67px;">QUnit</a> <a href="../tags/advice/" style="font-size: 19.58px;">advice</a> <a href="../tags/angularjs/" style="font-size: 17.92px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.33px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.92px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.42px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.25px;">browser</a> <a href="../tags/ci/" style="font-size: 13.33px;">ci</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.5px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 17.5px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.83px;">d3</a> <a href="../tags/db/" style="font-size: 14.17px;">db</a> <a href="../tags/docker/" style="font-size: 13.75px;">docker</a> <a href="../tags/es6/" style="font-size: 15px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.33px;">functional</a> <a href="../tags/generators/" style="font-size: 11.67px;">generators</a> <a href="../tags/git/" style="font-size: 15px;">git</a> <a href="../tags/github/" style="font-size: 11.25px;">github</a> <a href="../tags/graphql/" style="font-size: 10.83px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.5px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.83px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 12.5px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.67px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.83px;">interview</a> <a href="../tags/jade/" style="font-size: 11.25px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.83px;">jshint</a> <a href="../tags/modular-development/" style="font-size: 16.67px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 18.75px;">nodejs</a> <a href="../tags/performance/" style="font-size: 15.83px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.25px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.08px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.42px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/reactive/" style="font-size: 14.58px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 10.83px;">reactjs</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.5px;">security</a> <a href="../tags/sentry/" style="font-size: 13.75px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.08px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.17px;">testing</a> <a href="../tags/tutorial/" style="font-size: 13.75px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 11.67px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.42px;">ui</a> <a href="../tags/vuejs/" style="font-size: 11.25px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.08px;">web workers</a> <a href="../tags/zeit/" style="font-size: 12.08px;">zeit</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../combined-end-to-end-and-unit-test-coverage/">Combined End-to-end and Unit Test Coverage</a>
          </li>
        
          <li>
            <a href="../code-coverage-by-parcel/">Code Coverage by Parcel Bundler</a>
          </li>
        
          <li>
            <a href="../using-ts-aliases-in-cypress-tests/">Using TypeScript aliases in Cypress tests</a>
          </li>
        
          <li>
            <a href="../code-coverage-for-e2e-tests/">Code Coverage for End-to-end Tests</a>
          </li>
        
          <li>
            <a href="../stub-navigator-api/">Stub navigator API in end-to-end tests</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/server-push-on-dokku/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
