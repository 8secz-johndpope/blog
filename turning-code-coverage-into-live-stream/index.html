<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Turning code coverage into live stream | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="I love code coverage and use tools like  istanbul to get the test coverage information in a lot of my projects. Recently I started using  nyc that makes it easy to collect the coverage information for">
<meta name="keywords" content="testing">
<meta property="og:type" content="article">
<meta property="og:title" content="Turning code coverage into live stream">
<meta property="og:url" content="https://glebbahmutov.com/blog/turning-code-coverage-into-live-stream/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="I love code coverage and use tools like  istanbul to get the test coverage information in a lot of my projects. Recently I started using  nyc that makes it easy to collect the coverage information for">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/liverage-client/master/images/liverage.gif">
<meta property="og:updated_time" content="2018-02-14T02:33:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Turning code coverage into live stream">
<meta name="twitter:description" content="I love code coverage and use tools like  istanbul to get the test coverage information in a lot of my projects. Recently I started using  nyc that makes it easy to collect the coverage information for">
<meta name="twitter:image" content="https://raw.githubusercontent.com/bahmutov/liverage-client/master/images/liverage.gif">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!-- <div id="banner"></div> -->
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../index.html" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <!-- <span class="no-mobile">Software advice from</span> -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">
          <a id="subtitle" href="http://glebbahmutov.com">Gleb Bahmutov PhD</a>
        </span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-turning-code-coverage-into-live-stream" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2016-05-03T22:00:00.000Z" itemprop="datePublished">May 4 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Turning code coverage into live stream
    </h1>

    <h2 class="article-title" itemprop="name">
      A neat trick for making object property updates into a live event stream.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I love <a href="../high-mpg-code-coverage/">code coverage</a> and use tools like 
<a href="https://github.com/gotwarlost/istanbul" target="_blank" rel="noopener">istanbul</a> to get the test coverage information in a lot
of my projects. Recently I started using 
<a href="https://github.com/bcoe/nyc#readme" target="_blank" rel="noopener">nyc</a> that makes it easy to collect the coverage information
for JavaScript used in any external program, like code covered by the <code>mocha src/*-spec.js</code>
command; to get code coverage we just need to prepend the command and run 
<code>nyc mocha src/*-spec.js</code> instead.</p>
<p>I have even written a <a href="https://github.com/bahmutov/was-tested#readme" target="_blank" rel="noopener">code coverage proxy</a>
that can be used to <a href="../code-coverage-proxy/">instrument live website code</a>. Website
instrumentation shows parts of the code has been covered by the users&#39; actions. Sometimes
it is fun to sit back and watch what parts of the web application&#39;s code have been executed.
Yet, just like <code>nyc</code>, the proxy sends code coverage information as one large object. 
If we send coverage information more often,
we incur a large performance penalty - comparing and diffing large objects can be costly.</p>
<p>It would be cool to flip the coverage object and remove of &quot;pull&quot; mechanism that periodically 
compares the object with its previous copy. It would use better to use the &quot;push&quot; approach 
where the coverage object emits events when new statements have been covered. 
Without <code>Object.observe</code> this seems impossible to achieve - yet there is a neat trick we can 
play with standard ES5 objects to achieve this.</p>
<p>I did not want to write and maintain another code coverage tool, thus I picked <code>nyc</code> as the
starting point. It allows preloading custom modules before running using <code>-r &lt;module name&gt;</code> syntax.
Thus whatever I wrote needed to work at the preloading step, before any code coverage has been
collected. Turns out this is exactly the best place to run the code to be prepared!</p>
<h2><span id="code-instrumentation">Code instrumentation</span></h2><p>Typical code coverage in JavaScript works like this</p>
<ul>
<li>when the source is loaded, it is instrumented, for example inside a Node 
<a href="https://github.com/bahmutov/node-hook" target="_blank" rel="noopener">require hook</a> using code transformation.
For example, <a href="https://github.com/gotwarlost/istanbul/blob/ad8ab1d7a5284407efb83d0d7a8b32eb6fbd93c4/misc/samples/coverage.js#L50" target="_blank" rel="noopener">istanbul</a> hook
will instrument every file with name matching pattern</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> istanbul = <span class="built_in">require</span>(<span class="string">'istanbul'</span>)</span><br><span class="line"><span class="keyword">var</span> hook = istanbul.hook</span><br><span class="line"><span class="keyword">var</span> Instrumenter = istanbul.Instrumenter</span><br><span class="line"><span class="keyword">var</span> cover = instrumenter.instrumentSync.bind(instrumenter)</span><br><span class="line">hook.hookRequire(isJavaScriptFilename, cover)</span><br></pre></td></tr></table></figure>
<ul>
<li>the instrumented code has a global object, called <code>__coverage__</code> with an object entry for 
each individual source file</li>
<li>each statement, function and branch has a counter inside the object entry</li>
<li>extra statements in the instrumented source update the coverage counters,
like <code>__coverage__[__filename].s[&#39;42&#39;]++</code> for example to tell that statement &#39;42&#39; has been executed one more time.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// original file</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// instrumented file</span></span><br><span class="line">global.__coverage__ = &#123;&#125;</span><br><span class="line">global.__coverage__[__filename] = &#123;</span><br><span class="line">  s: &#123;</span><br><span class="line">    <span class="string">'1'</span>: <span class="number">1</span> <span class="comment">// function declaration - executed once right away</span></span><br><span class="line">    <span class="string">'2'</span>: <span class="number">0</span> <span class="comment">// inside the function "return a + b"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  statementMap: &#123;...&#125;, <span class="comment">// maps statements into lines and columns</span></span><br><span class="line">  f: &#123;</span><br><span class="line">    <span class="string">'1'</span>: <span class="number">0</span> <span class="comment">// single function, has not been executed yet</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  global.__coverage__[__filename].s[<span class="string">'2'</span>]++</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After the instrumented file runs and the process exits, the outside process generates JSON or
HTML reports from the <code>__coverage__</code> object.</p>
<h2><span id="it-is-all-about-being-first">It is all about being first</span></h2><p>Let us say, <code>nyc</code> loads out module first, before any user code runs. That means there is no
<code>global.__coverage__</code> object yet. Thus we can create a <em>placeholder property</em> on the <code>global</code>
object; when <code>nyc</code> actually <em>sets the property</em> our &quot;setter&quot; function will run, allowing us
to do additional processing. For example we will repeat the same trick and will set up 
<em>placeholder properties for each input source file</em> to be notified.</p>
<p>I will use <code>liverage</code> name for our code, standing for &quot;live code coverage&quot; (and not &quot;live rage&quot;
as some might guess). You can find the finished project at 
<a href="https://github.com/bahmutov/liverage" target="_blank" rel="noopener">bahmutov/liverage</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// liverage module</span></span><br><span class="line"><span class="keyword">var</span> cover</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(global, <span class="string">'__coverage__'</span>, &#123;</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  get: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cover</span><br><span class="line">  &#125;,</span><br><span class="line">  set: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setting new coverage object'</span>)</span><br><span class="line">    cover = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>To the outside world, even to the <code>nyc</code> module that runs <em>after</em> this code, setting the
<code>global.__coverage__</code> variable seems to work just like before. Yet, the first time (the global
object itself is only set once) the property is set, we get to run our own &quot;setter&quot; function.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nyc -r liverage mocha *-spec.js</span><br><span class="line">setting new coverage object</span><br><span class="line">(mocha output)</span><br></pre></td></tr></table></figure>
<h2><span id="be-ready-for-any-file">Be ready for any file</span></h2><p>The coverage object will have information for many files, each file will add an entry
whenever it gets loaded</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"/Users/home/me/project/foo.js"</span>: &#123; ... &#125;,</span><br><span class="line">  <span class="string">"/Users/home/me/project/src/bar.js"</span>: &#123; ... &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can definitely control which files to cover, and which ones to exclude using 
<a href="https://github.com/bcoe/nyc#excluding-files" target="_blank" rel="noopener">nyc options</a>. We need to add placeholder properties
for all file entries to play the same trick as we have played before with the coverage object
itself. The problem is, we knew the expected property name <code>__coverage__</code> before, but in this
case we do not know what property names will be added.</p>
<p>Inside <code>liverage</code> code we can either parse the command line and options from <code>package.json</code> 
and try to match the <code>nyc</code> logic. Or we can brute force the problem. When running the tool,
we probably are only interested in any JavaScript source file in the current folder, excluding
<code>node_modules</code> folder. Thus I grab all source files and add placeholder entries to the coverage
object right away.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findSourceFiles</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> toFull = <span class="function">(<span class="params">name</span>) =&gt;</span> path.resolve(name)</span><br><span class="line">  <span class="keyword">return</span> glob.sync(<span class="string">'&#123;src,examples&#125;/**/*.js'</span>)</span><br><span class="line">    .concat(glob.sync(<span class="string">'*.js'</span>))</span><br><span class="line">    .map(toFull)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> jsFiles = findSourceFiles()</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(global, <span class="string">'__coverage__'</span>, &#123;</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  get: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cover</span><br><span class="line">  &#125;,</span><br><span class="line">  set: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setting new coverage object'</span>)</span><br><span class="line">    <span class="comment">// prepare for every source file ;)</span></span><br><span class="line">    jsFiles.forEach(<span class="function">(<span class="params">filename</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> fileCoverage</span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(value, filename, &#123;</span><br><span class="line">        configurable: <span class="literal">true</span>,</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        get: <span class="function"><span class="params">()</span> =&gt;</span> fileCoverage,</span><br><span class="line">        set: <span class="function">(<span class="params">coverage</span>) =&gt;</span> &#123;</span><br><span class="line">          fileCoverage = coverage</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    cover = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>At the end of the run, the coverage object will have multiple empty values still for files
that were not part of the run, for example &quot;/Users/home/me/project/src/bar.js&quot; entry was a
placeholder object that never got set by <code>nyc</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"/Users/home/me/project/foo.js"</span>: &#123; ... &#125;,</span><br><span class="line">  <span class="string">"/Users/home/me/project/src/bar.js"</span>: <span class="literal">undefined</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is not problem for <code>nyc</code> - it is robust enough to skip the empty entries when computing
the final coverage reports.</p>
<h2><span id="be-ready-to-go-live">Be ready to go live</span></h2><p>Our code knows when the global coverage object is created, and each file coverage object is
added to it.</p>
<p>Finally, we are at the last step where we play the same &quot;placeholder&quot; trick for the third time.
For each file loaded, <code>nyc</code> will set the coverage information object. Whenever it is set,
our &quot;setter&quot; method runs, thus we have synchronous access to the file coverage object between
the moment it was created but before the execution begins. The coverage object has entries for
each statement - this is the most important coverage information we want to convert to an event
emitter. The inside of the instrumented file looks something like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fileCoverage = &#123;</span><br><span class="line">  s: &#123; <span class="comment">// statement coverage</span></span><br><span class="line">    <span class="string">'1'</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">'2'</span>: <span class="number">1</span>,</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  statementMap: &#123; <span class="comment">// statement to source map</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  f: &#123; <span class="comment">// function coverage</span></span><br><span class="line">    <span class="string">'1'</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  b: &#123; <span class="comment">// if / else branch coverage</span></span><br><span class="line">    <span class="string">'1'</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">global.__coverage__[__filename] = fileCoverage</span><br></pre></td></tr></table></figure>
<p>When this file coverage object is set, we need to replace the individual primitives inside the <code>s</code>
object with &quot;smarter setter&quot; functions that will notify our code that a particular statement
has new value. This is simple to do; in this case we do not even have to anticipate the future
property names since the full object is already there for us.</p>
<p>The property conversion has been factored out into a self-contained function that replaces
the existing properties inside <code>fileCoverage.s</code> object with &quot;set&quot; functions.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">liveStatementCoverage</span> (<span class="params">cb, filename, fileCoverage</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(fileCoverage.s).forEach(<span class="function">(<span class="params">statementIndex</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> counter = fileCoverage.s[statementIndex]</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(fileCoverage.s, statementIndex, &#123;</span><br><span class="line">      enumerable: <span class="literal">true</span>,</span><br><span class="line">      get: <span class="function"><span class="params">()</span> =&gt;</span> counter,</span><br><span class="line">      set: <span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">        counter = x</span><br><span class="line">        cb(&#123;</span><br><span class="line">          filename: filename,</span><br><span class="line">          s: statementIndex,</span><br><span class="line">          counter: x</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> fileCoverage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>From our &quot;liverage&quot; module we simply call the above function whenever we get a new file coverage
object, passing our event emitter as a callback.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// liverage</span></span><br><span class="line"><span class="keyword">const</span> startServer = <span class="built_in">require</span>(<span class="string">'./ws-coverage'</span>)</span><br><span class="line"><span class="keyword">const</span> server = startServer() <span class="comment">// our WebSocket server</span></span><br><span class="line">jsFiles.forEach(<span class="function">(<span class="params">filename</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> fileCoverage</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(value, filename, &#123;</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="params">()</span> =&gt;</span> fileCoverage,</span><br><span class="line">    set: <span class="function">(<span class="params">coverage</span>) =&gt;</span> &#123;</span><br><span class="line">      fileCoverage = liveStatementCoverage(server.broadcast, filename, coverage)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Every covered statement will be broadcast to the connected clients, thus every client
can observe the server&#39;s code been covered in real time.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/liverage-client/master/images/liverage.gif" alt="liverage"></p>
<p>Above: an example client implemented using CycleJs, code in 
<a href="https://github.com/bahmutov/liverage-client" target="_blank" rel="noopener">bahmutov/liverage-client</a></p>
<h2><span id="conclusion">Conclusion</span></h2><p>Even without <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/observe" target="_blank" rel="noopener">Object.observe</a>
we can get real time object value updates if we can predict the future property names. In this
case we had to forecast the property names three times in order to preemptively define
property with our &quot;setter&quot; function. Yet at the end we got a useful &quot;push&quot; system for observing
code coverage events.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/turning-code-coverage-into-live-stream/" data-id="cjjy2yz3x00xrf0oo4j20qmao" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/turning-code-coverage-into-live-stream/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/testing/">testing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../oscon/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          OReilly OSCON
        
      </div>
    </a>
  
  
    <a href="../getting-good-at-fp/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Getting good at FP</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">102</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">286</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">98</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">67</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/">graphql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">160</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">71</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">73</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.67px;">QUnit</a> <a href="../tags/advice/" style="font-size: 19.58px;">advice</a> <a href="../tags/angularjs/" style="font-size: 17.92px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.33px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.92px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.42px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.67px;">browser</a> <a href="../tags/ci/" style="font-size: 12.92px;">ci</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.5px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 15.83px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.83px;">d3</a> <a href="../tags/db/" style="font-size: 14.17px;">db</a> <a href="../tags/docker/" style="font-size: 13.33px;">docker</a> <a href="../tags/es6/" style="font-size: 15px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.33px;">functional</a> <a href="../tags/generators/" style="font-size: 11.67px;">generators</a> <a href="../tags/git/" style="font-size: 14.17px;">git</a> <a href="../tags/graphql/" style="font-size: 10px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.5px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.83px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 12.08px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.67px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.83px;">interview</a> <a href="../tags/jade/" style="font-size: 11.25px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.83px;">jshint</a> <a href="../tags/modular-development/" style="font-size: 17.08px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 18.75px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.25px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.25px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.5px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.42px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/reactive/" style="font-size: 14.58px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 10.42px;">reactjs</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.5px;">security</a> <a href="../tags/sentry/" style="font-size: 13.75px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.08px;">service workers</a> <a href="../tags/testing/" style="font-size: 19.17px;">testing</a> <a href="../tags/tutorial/" style="font-size: 13.75px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 10.42px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.42px;">ui</a> <a href="../tags/vuejs/" style="font-size: 11.25px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.08px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../gatsby-netlify-circle-and-cypress/">Gatsby Netlify Circle and Cypress</a>
          </li>
        
          <li>
            <a href="../powerful-cy-task/">Incredibly Powerful cy.task</a>
          </li>
        
          <li>
            <a href="../rolling-for-test/">Rolling for a Test</a>
          </li>
        
          <li>
            <a href="../tested-live-documentation/">Tested live documentation is a thing with MDX, Docz and Cypress</a>
          </li>
        
          <li>
            <a href="../trying-graphql/">Trying GraphQL</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/turning-code-coverage-into-live-stream/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
