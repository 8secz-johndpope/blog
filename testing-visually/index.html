<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Testing how an application renders a drawing with Cypress and Percy.io | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Note: you can find the source code for this blog post at github.com/cypress-io/angular-pizza-creator and a live demo of the application at toddmotto.com/angular-pizza-creator/. Note 2: the webinar vid">
<meta name="keywords" content="testing,cypress">
<meta property="og:type" content="article">
<meta property="og:title" content="Testing how an application renders a drawing with Cypress and Percy.io">
<meta property="og:url" content="https://glebbahmutov.com/blog/testing-visually/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="Note: you can find the source code for this blog post at github.com/cypress-io/angular-pizza-creator and a live demo of the application at toddmotto.com/angular-pizza-creator/. Note 2: the webinar vid">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/pizza.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/order-placed.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/order-spec.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/green-pizza.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/visual-spec.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/percy-start.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/percy-runs.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/percy-ci-message.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/two-new-snapshots.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/there-are-changes.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/percy-diff.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/link-repo-to-percy-project.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/auto-approve-master.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/2-checks.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/percy-check.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/approved.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/testing-visually/merged.png">
<meta property="og:updated_time" content="2019-05-10T13:26:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Testing how an application renders a drawing with Cypress and Percy.io">
<meta name="twitter:description" content="Note: you can find the source code for this blog post at github.com/cypress-io/angular-pizza-creator and a live demo of the application at toddmotto.com/angular-pizza-creator/. Note 2: the webinar vid">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/testing-visually/pizza.gif">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <!-- global digital climate strike -->
  <!-- https://digital.globalclimatestrike.net/#website-assets -->
  <script src="https://assets.digitalclimatestrike.net/widget.js" async></script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!-- <div id="banner"></div> -->
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../index.html" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <!-- <span class="no-mobile">Software advice from</span> -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">
          <a id="subtitle" href="http://glebbahmutov.com">Gleb Bahmutov PhD</a>
        </span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-testing-visually" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2019-03-30T04:00:00.000Z" itemprop="datePublished">Mar 30 2019</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Testing how an application renders a drawing with Cypress and Percy.io
    </h1>

    <h2 class="article-title" itemprop="name">
      End-to-end testing a rendered pizza using Cypress.io test runner and image diffing Percy.io plugin.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>Note:</strong> you can find the source code for this blog post at <a href="https://github.com/cypress-io/angular-pizza-creator" target="_blank" rel="noopener">github.com/cypress-io/angular-pizza-creator</a> and a live demo of the application at <a href="https://toddmotto.com/angular-pizza-creator/" target="_blank" rel="noopener">toddmotto.com/angular-pizza-creator/</a>.</p>
<p><strong>Note 2:</strong> the webinar video has been posted at <a href="https://www.youtube.com/watch?v=MXfZeE9RQDw" target="_blank" rel="noopener">www.youtube.com/watch?v=MXfZeE9RQDw</a> and the slides at <a href="https://slides.com/bahmutov/visual-testing-with-percy" target="_blank" rel="noopener">slides.com/bahmutov/visual-testing-with-percy</a>.</p>
<p><strong>Table of contents</strong></p>
<!-- toc -->
<ul>
<li><a href="#ordering-a-pizza">Ordering a pizza</a></li>
<li><a href="#custom-commands">Custom commands</a></li>
<li><a href="#visual-testing">Visual testing</a></li>
<li><a href="#visual-testing-workflow">Visual testing workflow</a></li>
<li><a href="#conclusions">Conclusions</a></li>
</ul>
<!-- tocstop -->
<h2><span id="ordering-a-pizza">Ordering a pizza</span></h2><p>There is a nice little web application at <a href="https://toddmotto.com/angular-pizza-creator/" target="_blank" rel="noopener">toddmotto.com/angular-pizza-creator/</a> for ordering a pizza. It does not actually order pizza, but it surely looks appetizing!</p>
<p><img src="/blog/images/testing-visually/pizza.gif" alt="Making my own pizza"></p>
<p>When we click on a topping, the order changes price, and the pizza rendering gets a new set of sliced toppings dropped. If we are building a web application like this, how do we test it?</p>
<p>First, we need to ensure that the we can build the pizza we want and that the order is going to cost us the right amount. We can write such test using a functional end-to-end test runner <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress.io</a>. Our first test will check the following user story:</p>
<ul>
<li>user needs to enter delivery information before they can place an order</li>
<li>user needs to pick at least one topping before they can place an order</li>
<li>the total order price should be correct</li>
<li>when the order is placed, a window alert pops up with the message &quot;Order placed&quot;</li>
</ul>
<p>At the end the web application looks like this</p>
<p><img src="/blog/images/testing-visually/order-placed.png" alt="Order placed"></p>
<p>Here is our first <a href="https://github.com/cypress-io/angular-pizza-creator/blob/master/cypress/integration/order-spec.js" target="_blank" rel="noopener">cypress/integration/order-spec.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="Cypress" /&gt;</span></span><br><span class="line">context(<span class="string">'Pizza Creator'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// uses base url setting from cypress.json</span></span><br><span class="line">    <span class="comment">// which right now points at "localhost:3000"</span></span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'orders custom pizza'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// enter delivery information</span></span><br><span class="line">    cy.get(<span class="string">'[formcontrolname="name"]'</span>).type(<span class="string">'Joe'</span>)</span><br><span class="line">    cy.get(<span class="string">'[formcontrolname="email"]'</span>).type(<span class="string">'foo@bar.com'</span>)</span><br><span class="line">    cy.get(<span class="string">'[formcontrolname="confirm"]'</span>).type(<span class="string">'foo@bar.com'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// without complete delivery information,</span></span><br><span class="line">    <span class="comment">// we should not be able to place the order</span></span><br><span class="line">    cy.get(<span class="string">'button[type="submit"]'</span>).should(<span class="string">'be.disabled'</span>)</span><br><span class="line"></span><br><span class="line">    cy.get(<span class="string">'[formcontrolname="address"]'</span>).type(<span class="string">'1 Pizza st'</span>)</span><br><span class="line">    cy.get(<span class="string">'[formcontrolname="postcode"]'</span>).type(<span class="string">'12345'</span>)</span><br><span class="line">    cy.get(<span class="string">'[formcontrolname="phone"]'</span>).type(<span class="string">'1234567890'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// still cannot order pizza - need to pick toppings</span></span><br><span class="line">    cy.get(<span class="string">'button[type="submit"]'</span>).should(<span class="string">'be.disabled'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add a few toppings</span></span><br><span class="line">    cy.contains(<span class="string">'label.pizza-topping'</span>, <span class="string">'Pepperoni'</span>).click()</span><br><span class="line">    cy.contains(<span class="string">'label.pizza-topping'</span>, <span class="string">'Onion'</span>).click()</span><br><span class="line">    cy.contains(<span class="string">'label.pizza-topping'</span>, <span class="string">'Mozzarella'</span>).click()</span><br><span class="line">    cy.contains(<span class="string">'label.pizza-topping'</span>, <span class="string">'Basil'</span>).click()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check the price and order pizza</span></span><br><span class="line">    cy.contains(<span class="string">'.pizza-summary__total-price'</span>, <span class="string">'Total: $12.75'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let us confirm we can place our order,</span></span><br><span class="line">    <span class="comment">// but first, prepare for "window.alert" call</span></span><br><span class="line">    cy.on(<span class="string">'window:alert'</span>, cy.stub().as(<span class="string">'alert'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now the button should be enabled</span></span><br><span class="line">    cy.get(<span class="string">'button[type="submit"]'</span>)</span><br><span class="line">      .should(<span class="string">'be.enabled'</span>)</span><br><span class="line">      .click()</span><br><span class="line">    cy.get(<span class="string">'@alert'</span>).should(<span class="string">'have.been.calledWithExactly'</span>, <span class="string">'Order placed'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// scroll pizza view back into view</span></span><br><span class="line">    cy.get(<span class="string">'form'</span>)</span><br><span class="line">      .scrollIntoView(&#123;&#125;)</span><br><span class="line">      .should(<span class="string">'be.visible'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>which passes locally</p>
<p><img src="/blog/images/testing-visually/order-spec.gif" alt="Order spec passing locally"></p>
<h2><span id="custom-commands">Custom commands</span></h2><p>If we plan to write more tests, entering delivery and picking toppings actions will quickly lead to lots of duplicate test code. We can factor them out to <a href="https://on.cypress.io/custom-commands" target="_blank" rel="noopener">custom commands</a>, making our test code more readable and dry. I will write the following into <a href="https://github.com/cypress-io/angular-pizza-creator/blob/master/cypress/support/index.js" target="_blank" rel="noopener">cypress/support/index.js</a> file:</p>
<figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Returns selector for a form control using name attribute */</span></span><br><span class="line"><span class="keyword">const</span> f = <span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`[formcontrolname="<span class="subst">$&#123;name&#125;</span>"]`</span></span><br><span class="line"></span><br><span class="line">Cypress.Commands.add(<span class="string">'enterForm'</span>, (name, text) =&gt; &#123;</span><br><span class="line">  <span class="comment">// enter text into the form control without Command Log messages</span></span><br><span class="line">  <span class="keyword">const</span> quiet = &#123; <span class="attr">log</span>: <span class="literal">false</span> &#125;</span><br><span class="line">  cy.get(f(name), quiet).type(text, quiet)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Cypress.Commands.add(<span class="string">'enterDeliveryInformation'</span>, () =&gt; &#123;</span><br><span class="line">  cy.enterForm(<span class="string">'name'</span>, <span class="string">'Joe'</span>)</span><br><span class="line">  cy.enterForm(<span class="string">'email'</span>, <span class="string">'foo@bar.com'</span>)</span><br><span class="line">  cy.enterForm(<span class="string">'confirm'</span>, <span class="string">'foo@bar.com'</span>)</span><br><span class="line">  cy.enterForm(<span class="string">'address'</span>, <span class="string">'1 Pizza st'</span>)</span><br><span class="line">  cy.enterForm(<span class="string">'postcode'</span>, <span class="string">'12345'</span>)</span><br><span class="line">  cy.enterForm(<span class="string">'phone'</span>, <span class="string">'1234567890'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Cypress.Commands.add(<span class="string">'pickToppings'</span>, (...toppings) =&gt; &#123;</span><br><span class="line">  toppings.forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">    cy.contains(<span class="string">'label.pizza-topping'</span>, name).click()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The support file is bundled with each spec file, thus my <a href="https://github.com/cypress-io/angular-pizza-creator/blob/master/cypress/integration/dry-spec.js" target="_blank" rel="noopener">cypress/integration/dry-spec.js</a> can immediate use the new Cypress commands.</p>
<figure class="highlight js"><figcaption><span>cypress/integration/dry-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'orders custom pizza'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  cy.enterDeliveryInformation()</span><br><span class="line">  cy.pickToppings(<span class="string">'Pepperoni'</span>, <span class="string">'Onion'</span>, <span class="string">'Mozzarella'</span>, <span class="string">'Basil'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check the price and order pizza</span></span><br><span class="line">  cy.contains(<span class="string">'.pizza-summary__total-price'</span>, <span class="string">'Total: $12.75'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// let us confirm we can place our order,</span></span><br><span class="line">  <span class="comment">// but first, prepare for "window.alert" call</span></span><br><span class="line">  cy.on(<span class="string">'window:alert'</span>, cy.stub().as(<span class="string">'alert'</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now the button should be enabled</span></span><br><span class="line">  cy.get(<span class="string">'button[type="submit"]'</span>)</span><br><span class="line">    .should(<span class="string">'be.enabled'</span>)</span><br><span class="line">    .click()</span><br><span class="line">  cy.get(<span class="string">'@alert'</span>).should(<span class="string">'have.been.calledWithExactly'</span>, <span class="string">'Order placed'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// scroll pizza view back into view</span></span><br><span class="line">  cy.get(<span class="string">'form'</span>)</span><br><span class="line">    .scrollIntoView(&#123;&#125;)</span><br><span class="line">    .should(<span class="string">'be.visible'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Beautiful, I ❤️ readable functional tests.</p>
<h2><span id="visual-testing">Visual testing</span></h2><p>Hmm, we can verify the order side of the application - but what about the beautiful animated pizza drawing? Are the toppings falling onto the pizza crust - or do they accidentally land outside the circle? And what if someone changes the pie from the mouth-watering <code>#FFDC71</code> to much less appetizing <code>#71FF71</code>?</p>
<p><img src="/blog/images/testing-visually/green-pizza.png" alt="No, thank you"></p>
<p>A functional test cannot catch all possible changes in style, color and position - there are just too many assertions to make. Instead we need to compare the result as an image - and we need to compare it to a &quot;good&quot; baseline image. As long as the images match and the functional tests pass, our pizza app is working.</p>
<p>When dealing with images, we need to think where the baseline images are going to be stored - they quickly become a nuisance as their number grows. Think how many binary images can a Git repository hold until it becomes a nightmare to clone.</p>
<p>Also a huge problem with image diffing is the process of reviewing them and approving the visual changes. I would prefer to have an online service that shows me and other team members the differences in a nice convenient manner. I don&#39;t want to manually download images from CI to view them!</p>
<p>We need a complete solution, so today I will look at <a href="https://percy.io/" target="_blank" rel="noopener">Percy.io</a> visual diffing service. I have signed up for free with my GitHub account and created a project <a href="https://percy.io/cypress-io/angular-pizza-creator" target="_blank" rel="noopener">percy.io/cypress-io/angular-pizza-creator</a> that you can see for yourself. My setup follows the <a href="https://docs.percy.io/docs/cypress-tutorial" target="_blank" rel="noopener">Percy Cypress tutorial</a>.</p>
<p>In my project I have added <a href="https://github.com/percy/percy-cypress" target="_blank" rel="noopener">@percy/cypress</a> development dependency.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yarn add --dev @percy/cypress</span><br><span class="line">...</span><br><span class="line">success Saved 1 new dependency.</span><br><span class="line">info Direct dependencies</span><br><span class="line">└─ @percy/cypress@1.0.4</span><br></pre></td></tr></table></figure>
<p>Then I have added a single line to my <a href="https://github.com/cypress-io/angular-pizza-creator/blob/master/cypress/support/index.js" target="_blank" rel="noopener">support file</a></p>
<figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'@percy/cypress'</span></span><br><span class="line"><span class="comment">// the rest of my custom commands</span></span><br></pre></td></tr></table></figure>
<p>The imported <code>@percy/cypress</code> adds its own custom command <code>cy.percySnapshot()</code>. I write a test that snapshots the pizza before adding any topics and after in <a href="https://github.com/cypress-io/angular-pizza-creator/blob/master/cypress/integration/visual-spec.js" target="_blank" rel="noopener">visual-spec.js</a>:</p>
<figure class="highlight js"><figcaption><span>cypress/integration/visual-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'draws pizza correctly'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  cy.percySnapshot(<span class="string">'Empty Pizza'</span>)</span><br><span class="line"></span><br><span class="line">  cy.enterDeliveryInformation()</span><br><span class="line">  <span class="keyword">const</span> toppings = [<span class="string">'Pepperoni'</span>, <span class="string">'Chili'</span>, <span class="string">'Onion'</span>]</span><br><span class="line">  cy.pickToppings(...toppings)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make sure the web app has updated</span></span><br><span class="line">  cy.contains(<span class="string">'.pizza-summary__total-price'</span>, <span class="string">'Total: $12.06'</span>)</span><br><span class="line">  cy.percySnapshot(toppings.join(<span class="string">' - '</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// scroll pizza view back into view</span></span><br><span class="line">  cy.get(<span class="string">'form'</span>)</span><br><span class="line">    .scrollIntoView(&#123;&#125;)</span><br><span class="line">    .should(<span class="string">'be.visible'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The test runs locally.</p>
<p><img src="/blog/images/testing-visually/visual-spec.png" alt="Visual spec passing locally"></p>
<p>Just remember: the test should take a snapshot when the application has finished rendering; and not before. The web app might take a while to redraw - maybe it is sending data to the server, or processing a complex operation. Adding an assertion is usually enough to wait as long as necessary, but no longer, thanks to the <a href="https://on.cypress.io/retry-ability" target="_blank" rel="noopener">retry-ability</a> built into most Cypress commands. To prevent the snapshot from being taken too early, like before the toppings have been applied to the order, the above test uses <code>cy.contains</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// make sure the web app has updated</span></span><br><span class="line">cy.contains(<span class="string">'.pizza-summary__total-price'</span>, <span class="string">'Total: $12.06'</span>)</span><br><span class="line">cy.percySnapshot(toppings.join(<span class="string">' - '</span>))</span><br></pre></td></tr></table></figure>
<p>I can ignore additional Percy messages in the Command Log - because I have not set up sending data for image diffing yet. In fact, I will not run image diffing locally - there is no need for it, due to asynchronous nature of image generation and comparison. Percy custom command just sends DOM snapshot and styles to Percy cloud, where the actual images are generated (across multiple browsers and resolutions) and then compared. In order to enable sending images, I need to change how I run Cypress. Usually one runs Cypress by simply executing <code>npx cypress open</code> or <code>npx cypress run</code> in headless mode. But when Percy runs it needs extra time - to send the DOM snapshots and styles to the Percy.io API. Thus I need to run Percy app, which will start Cypress and will make sure the image diffing starts, even if Cypress application finishes. The command should be:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx percy <span class="built_in">exec</span> -- cypress run</span><br></pre></td></tr></table></figure>
<p>I don&#39;t need to change anything in my <a href="https://github.com/cypress-io/angular-pizza-creator/blob/master/package.json" target="_blank" rel="noopener">package.json</a> file - because normally I just work with functional tests. Only my CI configuration file needs to change its test command to run Cypress through Percy. Since I almost always use <a href="https://github.com/cypress-io/circleci-orb" target="_blank" rel="noopener">Cypress CircleCI Orb</a> to run my end-to-end tests, here is my <a href="https://github.com/cypress-io/angular-pizza-creator/blob/master/circle.yml" target="_blank" rel="noopener">circle.yml</a> file.</p>
<figure class="highlight yaml"><figcaption><span>circle.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"><span class="attr">orbs:</span></span><br><span class="line">  <span class="comment"># import Cypress orb by specifying an exact version x.y.z</span></span><br><span class="line">  <span class="comment"># or the latest version 1.x.x using "@1" syntax</span></span><br><span class="line"><span class="attr">  cypress:</span> <span class="string">cypress-io/cypress@1</span></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    jobs:</span></span><br><span class="line">      <span class="comment"># "cypress" is the name of the imported orb</span></span><br><span class="line">      <span class="comment"># "run" is the name of the job defined in Cypress orb</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cypress/run:</span></span><br><span class="line"><span class="attr">          yarn:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment"># builds and starts the local application</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">yarn</span> <span class="string">setup</span> <span class="string">&amp;&amp;</span> <span class="string">yarn</span> <span class="string">start</span></span><br><span class="line">          <span class="comment"># waits for web application to load completely</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:3000'</span></span><br><span class="line">          <span class="comment"># runs the Cypress tests via "Percy exec"</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">npx</span> <span class="string">percy</span> <span class="string">exec</span> <span class="bullet">--</span> <span class="string">cypress</span> <span class="string">run</span> <span class="bullet">--record</span></span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong> I am recording the Cypress test results and video using <code>cypress run --record</code> on the <a href="https://on.cypress.io/dashboard-service" target="_blank" rel="noopener">Cypress Dashboard</a>, which is a separate service from Percy web application dashboard.</p>
<p>For results to be sent to the right Percy project, I grabbed the <code>PERCY_TOKEN</code> from the Percy web application and set it on CircleCI as an environment variable. Then I pushed my code. CircleCI runs <a href="https://circleci.com/gh/cypress-io/angular-pizza-creator/13" target="_blank" rel="noopener">build #13</a> which shows Percy start message:</p>
<p><img src="/blog/images/testing-visually/percy-start.png" alt="Percy starts Cypress"></p>
<p>Percy outputs messages to the terminal when snapshots are taken:</p>
<p><img src="/blog/images/testing-visually/percy-runs.png" alt="Percy snapshot message"></p>
<p>After the entire run, Percy application sends the request to generate images and compare them and exits:</p>
<p><img src="/blog/images/testing-visually/percy-ci-message.png" alt="Percy finishes after Cypress exits"></p>
<p>I can open the displayed url <a href="https://percy.io/cypress-io/angular-pizza-creator/builds/1663756" target="_blank" rel="noopener">https://percy.io/cypress-io/angular-pizza-creator/builds/1663756</a> and after a few seconds the &quot;Pending ...&quot; status changes to &quot;Unreviewed&quot;. There are two desktop screenshots (and two more generated using Firefox) that I can see.</p>
<p><img src="/blog/images/testing-visually/two-new-snapshots.png" alt="Percy asks me to review new snapshos"></p>
<p>I approve the changes - now these snapshots become the official baseline images that will be used in the future for comparisons. All images are stored in the Percy cloud, and do not clutter the project&#39;s GitHub repository.</p>
<p>Let me change the pizza crust color to green and try pushing the commit. CircleCI build passes, and Percy web application shows that there are new changes - it has detected the change in color.</p>
<p><img src="/blog/images/testing-visually/there-are-changes.png" alt="Percy shows new changes in the build"></p>
<p>We can go into &quot;baseline vs current image&quot; view and toggle diff to see where the colors have changed.</p>
<p><img src="/blog/images/testing-visually/percy-diff.gif" alt="Diffing the two images to see the changed region"></p>
<p>Perfect, Percy web application catches the visual difference - but our tests have passed, haven&#39;t they?</p>
<h2><span id="visual-testing-workflow">Visual testing workflow</span></h2><p>Visual tests with Percy do not fail Cypress tests. Instead they send the DOM snapshots and all page styles to the Percy cloud where</p>
<ul>
<li>the actual images will be generated on multiple browsers and resolutions</li>
<li>new images are compared against baseline images</li>
</ul>
<p>A project could have 100s of images, waiting for all of them in the Cypress test might mean a loooong test. Thus Percy suggests a different asynchronous workflow it its <a href="https://percy.io/how-it-works" target="_blank" rel="noopener">&quot;How it works&quot;</a> guide.</p>
<p><strong>1.</strong> Install Percy GitHub application <a href="https://github.com/marketplace/percy" target="_blank" rel="noopener">github.com/marketplace/percy</a> and link the project to the GitHub repository. This enables commit status reporting.</p>
<p><img src="/blog/images/testing-visually/link-repo-to-percy-project.png" alt="Percy project linked to GitHub repository"></p>
<p>Percy recommends using pull requests to make any changes to the code. By default Percy project settings has the <code>master</code> branch as auto-approved. I had it turned off before to show image diffs, but now I will turn it back on.</p>
<p><img src="/blog/images/testing-visually/auto-approve-master.png" alt="If the visual changes have made it to master they are auto approved"></p>
<p><strong>2.</strong> For functional and visual changes I will open a pull request. Each pull request runs functional tests AND Percy sends back image diffing results as a GitHub status check. For example <a href="https://github.com/cypress-io/angular-pizza-creator/pull/2" target="_blank" rel="noopener">angular-pizza-creator/pull/2</a> automatically gets 2 commit checks:</p>
<p><img src="/blog/images/testing-visually/2-checks.png" alt="Functional tests and visual diff status for pull request"></p>
<p><strong>3.</strong> Clicking on the failed Percy check &quot;details&quot; link brings me to the diff view:</p>
<p><img src="/blog/images/testing-visually/percy-check.png" alt="Pizza crust changed color"></p>
<p>Thus each pull request needs the functional tests to pass and for the team to review and approve the visual changes (if it makes sense) - and there could be 100s of visual changes triggered across all part of the project, even for a small style change!</p>
<p><strong>4.</strong> If I click &quot;Approve&quot; button in Percy, it changes the GitHub commit status to pass and my pull request is good to go.</p>
<p><img src="/blog/images/testing-visually/approved.png" alt="Approved changes in Percy set PR status to green"></p>
<p>The pull request was merged into <code>master</code> and the new approved images become the new baseline images</p>
<p><img src="/blog/images/testing-visually/merged.png" alt="Merged pull request status"></p>
<p>The entire process is simple and convenient.</p>
<h2><span id="conclusions">Conclusions</span></h2><p>Running both functional and visual tests gives me a peace of mind. The chances of accidentally breaking the page layout or hiding an element, or making the app look hideous goes pretty much to zero. If you would like to know more about visual testing with Cypress.io and Percy.io check out these links:</p>
<ul>
<li><a href="https://percy.io" target="_blank" rel="noopener">percy.io</a></li>
<li><a href="https://www.cypress.io" target="_blank" rel="noopener">www.cypress.io</a></li>
<li><a href="https://docs.percy.io/docs/cypress" target="_blank" rel="noopener">Percy Cypress documentation</a></li>
</ul>
<p>There are also a few open source alternatives for visual diffing that do not have the GitHub integration or the cloud component that Percy provides, check them out if you would like to do image diffing yourself: <a href="https://on.cypress.io/plugins#visual-testing" target="_blank" rel="noopener">on.cypress.io/plugins#visual-testing</a></p>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/testing-visually/" data-id="ck6dv9qa8010gt5fj0yeizc6m" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/testing-visually/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/cypress/">cypress</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/testing/">testing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../readable-tests/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Readable Cypress.io tests
        
      </div>
    </a>
  
  
    <a href="../testing-a-chart/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Testing a chart with Cypress and Applitools</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">118</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">325</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/">a11y</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">100</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/">climate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">50</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">68</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/">github</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/">graphql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">162</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">79</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/">react</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">101</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/zeit/">zeit</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.67px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10px;">a11y</a> <a href="../tags/advice/" style="font-size: 19.17px;">advice</a> <a href="../tags/angularjs/" style="font-size: 17.92px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.33px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.92px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.42px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.25px;">browser</a> <a href="../tags/ci/" style="font-size: 13.33px;">ci</a> <a href="../tags/climate/" style="font-size: 11.67px;">climate</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.5px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 17.5px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.83px;">d3</a> <a href="../tags/db/" style="font-size: 14.17px;">db</a> <a href="../tags/docker/" style="font-size: 14.17px;">docker</a> <a href="../tags/es6/" style="font-size: 15px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.33px;">functional</a> <a href="../tags/generators/" style="font-size: 11.67px;">generators</a> <a href="../tags/git/" style="font-size: 15px;">git</a> <a href="../tags/github/" style="font-size: 11.25px;">github</a> <a href="../tags/graphql/" style="font-size: 10.83px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.5px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.83px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 12.5px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.67px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.83px;">interview</a> <a href="../tags/jade/" style="font-size: 11.25px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.83px;">jshint</a> <a href="../tags/modular-development/" style="font-size: 16.67px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 18.75px;">nodejs</a> <a href="../tags/performance/" style="font-size: 15.83px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.25px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.08px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.42px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/react/" style="font-size: 10px;">react</a> <a href="../tags/reactive/" style="font-size: 14.58px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 10.83px;">reactjs</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.92px;">security</a> <a href="../tags/sentry/" style="font-size: 13.75px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.08px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.58px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 11.67px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.42px;">ui</a> <a href="../tags/vuejs/" style="font-size: 11.25px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.08px;">web workers</a> <a href="../tags/zeit/" style="font-size: 12.08px;">zeit</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../gas-ban-testimony/">My testimony in support of banning gas infrastructure in new construction in Cambridge, MA</a>
          </li>
        
          <li>
            <a href="../a-plea-for-climate-2020/">A plea for climate in year 2020</a>
          </li>
        
          <li>
            <a href="../paint-roof-white/">Paint roof white</a>
          </li>
        
          <li>
            <a href="../keep-passwords-secret-in-e2e-tests/">Keep passwords secret in E2E tests</a>
          </li>
        
          <li>
            <a href="../mocha-and-sinon/">How to set up Mocha with Sinon.js</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/testing-visually/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
