<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Deploying private NPM modules to Zeit | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Update Zeit has just released the official way to use private NPM modules, see the announcement.   Example application Authentication using NPM_TOKEN Shrink packing Bundling the server code Bundling t">
<meta name="keywords" content="advice,modular development">
<meta property="og:type" content="article">
<meta property="og:title" content="Deploying private NPM modules to Zeit">
<meta property="og:url" content="https://glebbahmutov.com/blog/deploying-private-npm-modules-to-zeit/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="Update Zeit has just released the official way to use private NPM modules, see the announcement.   Example application Authentication using NPM_TOKEN Shrink packing Bundling the server code Bundling t">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-02-14T02:33:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Deploying private NPM modules to Zeit">
<meta name="twitter:description" content="Update Zeit has just released the official way to use private NPM modules, see the announcement.   Example application Authentication using NPM_TOKEN Shrink packing Bundling the server code Bundling t">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!-- <div id="banner"></div> -->
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../index.html" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <!-- <span class="no-mobile">Software advice from</span> -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">
          <a id="subtitle" href="http://glebbahmutov.com">Gleb Bahmutov PhD</a>
        </span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-deploying-private-npm-modules-to-zeit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2016-06-30T04:00:00.000Z" itemprop="datePublished">Jun 30 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Deploying private NPM modules to Zeit
    </h1>

    <h2 class="article-title" itemprop="name">
      How to bundle a server including private modules and static files.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>Update</strong> Zeit has just released the official way to use private NPM modules,
see <a href="https://zeit.co/blog/private-npm" target="_blank" rel="noopener">the announcement</a>.</p>
<!-- toc -->
<ul>
<li><a href="#example-application">Example application</a></li>
<li><a href="#authentication-using-npm_token">Authentication using NPM_TOKEN</a></li>
<li><a href="#shrink-packing">Shrink packing</a></li>
<li><a href="#bundling-the-server-code">Bundling the server code</a></li>
<li><a href="#bundling-the-mock-read-only-file-system">Bundling the mock read-only file system</a></li>
<li><a href="#writing-the-temp-file-system">Writing the temp file system</a></li>
<li><a href="#installing-nothing">Installing nothing</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<!-- tocstop -->
<p>I have been playing with <a href="https://zeit.co/" target="_blank" rel="noopener">Zeit.co</a> - a super quick immutable deployment
environment targeted at Node projects. If I have a server in a local folder,
it could be deployed to new server almost instantly. It was a perfect
solution for deploying a <a href="../publish-release-notes-to-slack/">small web hook</a>,
or a <a href="../parallel-end-to-end-testing/">chat server</a>.</p>
<p>Yet there were two limitations:</p>
<ul>
<li>lack of environment variables support; this was simple to
<a href="../publish-release-notes-to-slack/#deployment-with-now">work around</a>
using a separate private repo and a tool like <a href="https://github.com/bahmutov/as-a#readme" target="_blank" rel="noopener">as-a</a></li>
<li>the deployment tool does not install any private NPM dependencies due
to lack of NPM authentication</li>
</ul>
<p>This post shows how I worked around the second limitation by bundling
the entire server code using <a href="https://github.com/substack/node-browserify" target="_blank" rel="noopener">browserify</a>, preparing a single
source file to be deployed. At the end there will be just a single
JavaScript deployed, with zero NPM dependencies.</p>
<h2><span id="example-application">Example application</span></h2><p>As an example I took a <a href="https://github.com/bahmutov/feathers-chat-app" target="_blank" rel="noopener">chat application server</a> implemented
on top of <a href="http://feathersjs.com/" target="_blank" rel="noopener">Feathers</a> framework. The original example already had
some modifications to make it work on Zeit</p>
<ol>
<li>No Socket.io on Zeit - I have left the REST api only</li>
<li>Local data can be written into <code>/tmp</code> folder only.</li>
<li>(Optional) the server can determine its own host url using environment
variable <code>NOW_URL</code></li>
</ol>
<p>I have published the chat app on NPM under name
<a href="https://www.npmjs.com/package/feathers-chat-app-gleb" target="_blank" rel="noopener">feathers-chat-app-gleb</a>, but to make the example
more realistic, I have included a dummy private NPM dependency.
The dependency <code>@bahmutov/private-foo</code> comes from public GitHub repo
<a href="https://github.com/bahmutov/private-foo" target="_blank" rel="noopener">private-foo</a> but the module has
been published as <em>a private scoped module</em> on NPM registry. The chat application
just prints the value exported by the private module</p>
<figure class="highlight js"><figcaption><span>src/app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> privateFoo = <span class="built_in">require</span>(<span class="string">'@bahmutov/private-foo'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'I include'</span>, privateFoo);</span><br><span class="line"><span class="comment">// npm start</span></span><br><span class="line"><span class="comment">// I include private foo</span></span><br><span class="line"><span class="comment">// Feathers application started on localhost:3030</span></span><br></pre></td></tr></table></figure>
<p>How can we deploy this application to Zeit using the <a href="https://zeit.co/now" target="_blank" rel="noopener">zeit now</a> tool?</p>
<h2><span id="authentication-using-npm_token">Authentication using NPM_TOKEN</span></h2><p>First, let us try deploying the application as is.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ now -f</span><br><span class="line">&gt; Deploying <span class="string">"/Users/irinakous/git/feathers-chat-app"</span></span><br><span class="line">&gt; Using Node.js 6.2.1 (requested: `6`)</span><br><span class="line">&gt; Ready! https://feathers-chat-app-gleb-fhzggnzoij.now.sh (copied to clipboard) [2s]</span><br><span class="line">...</span><br><span class="line">NPM install errors (too fast too see)</span><br><span class="line">...</span><br><span class="line">&gt; Building</span><br><span class="line">&gt; ▲ npm install</span><br><span class="line">&gt; Installing package subarg@^1.0.0</span><br><span class="line">&gt; Installing package through2@^2.0.0</span><br><span class="line">&gt; Installing package xtend@^4.0.0</span><br><span class="line">&gt; Installing package bn.js@^4.0.0</span><br><span class="line">&gt; Installing package inherits@^2.0.1</span><br><span class="line">&gt; Installing package minimalistic-assert@^1.0.0</span><br><span class="line">&gt; Installing package duplexer2@~0.1.0</span><br><span class="line">&gt; Installing package readable-stream@^2.0.2</span><br><span class="line">&gt; Installing package acorn@^1.0.3</span><br><span class="line">&gt; Installing package defined@^1.0.0</span><br><span class="line">&gt; ▲ npm start</span><br><span class="line">&gt; module.js:442</span><br><span class="line">&gt;     throw err;</span><br><span class="line">&gt;     ^</span><br><span class="line">&gt; Error: Cannot find module <span class="string">'feathers'</span></span><br><span class="line">&gt;     at Function.Module._resolveFilename (module.js:440:15)</span><br><span class="line">&gt;     at Function.Module._load (module.js:388:25)</span><br><span class="line">&gt;     at Module.require (module.js:468:17)</span><br><span class="line">&gt;     at require (internal/module.js:20:19)</span><br><span class="line">&gt;     at Object.&lt;anonymous&gt; (/home/nowuser/src/src/app.js:4:21)</span><br></pre></td></tr></table></figure>
<p>So the deployment fails, but the install log passes way too fast to see the
problem. To read the exception message, let us record the terminal output using
the awesome <a href="https://asciinema.org/" target="_blank" rel="noopener">asciinema</a> utility.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ asciinema rec</span><br><span class="line">$ now -f</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">~ Asciicast recording finished.</span><br><span class="line">~ Press &lt;Enter&gt; to upload, &lt;Ctrl-C&gt; to cancel.</span><br><span class="line">https://asciinema.org/a/acp3tvh8mui1o7y6goox42t29</span><br></pre></td></tr></table></figure>
<p>Opening the movie url, we can observe the detailed output, and even embed it
below</p>
<script type="text/javascript" src="https://asciinema.org/a/acp3tvh8mui1o7y6goox42t29.js" id="asciicast-acp3tvh8mui1o7y6goox42t29" async></script>

<p>Now we can see the install error clearly</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">message: &apos;Response code 404 (Not Found)&apos;,</span><br><span class="line">host: &apos;registry.npmjs.org&apos;,</span><br><span class="line">method: &apos;GET&apos;,</span><br><span class="line">path: &apos;/@bahmutov%2Fprivate-foo&apos;,</span><br><span class="line">statusCode: 404</span><br></pre></td></tr></table></figure>
<p>The install fails, as it should;
the registry returns 404 when someone is requesting our
private module. Can we copy the personal NPM auth token into the local
<code>.npmrc</code> file to allow Zeit deploy to install the private module? If we keep
the repo private, this could be acceptable solution. We can even git ignore
the <code>.npmrc</code> file to avoid checking it into the repo (and even use
a tool like <a href="https://github.com/bahmutov/ban-sensitive-files" target="_blank" rel="noopener">ban-sensitive-files</a> to prevent this
from happening).</p>
<p>Yet, running the <code>now</code> tool shows that the local <code>.npmrc</code> file is ignored
and the private scoped module is still NOT installed. Hmm.</p>
<h2><span id="shrink-packing">Shrink packing</span></h2><p>If we cannot install private dependencies from the NPM registry, we could try
including the downloaded dependencies directly in the git repo. The best way
to keep code dependencies together with source is <a href="https://github.com/JamieMason/shrinkpack" target="_blank" rel="noopener">shrinkpack</a>.</p>
<p>First, use <code>npm shrinkwrap</code> command to &quot;fix&quot; the exact versions of all
dependencies, including the private ones. We are excluding the dev dependencies
though.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm prune</span><br><span class="line">$ npm shrinkwrap</span><br><span class="line">wrote npm-shrinkwrap.json</span><br></pre></td></tr></table></figure>
<p>The written file <a href="https://github.com/bahmutov/feathers-chat-app/blob/master/npm-shrinkwrap.json" target="_blank" rel="noopener">npm-shrinkwrap.json</a> has every
dependency resolution. Here is the start of the file.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"feathers-chat-app-gleb"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@bahmutov/private-foo"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">      <span class="attr">"from"</span>: <span class="string">"@bahmutov/private-foo@*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"accepts"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.3.3"</span>,</span><br><span class="line">      <span class="attr">"from"</span>: <span class="string">"accepts@&gt;=1.3.3&lt; 1.4.0"</span>,</span><br><span class="line">      <span class="attr">"resolved"</span>: <span class="string">"http://registry.npmjs.org/accepts/-/accepts-1.3.3.tgz"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, we will run the command to pack every resolved dependency back into
the <code>.tar.gz</code> file (almost like it was downloaded from the NPM registry).</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g shrinkpack</span><br><span class="line">$ shrinkpack</span><br><span class="line">i 231 dependencies <span class="keyword">in</span> npm-shrinkwrap.json</span><br><span class="line">i 0 need removing from ./node_shrinkwrap</span><br><span class="line">i 231 need adding to ./node_shrinkwrap</span><br><span class="line">i 209 are <span class="keyword">in</span> your npm cache</span><br><span class="line">i 22 need downloading</span><br><span class="line">i 1 have a missing <span class="string">"resolved"</span> property</span><br><span class="line">? @bahmutov/private-foo@1.0.0 has no <span class="string">"dist.tarball"</span> <span class="keyword">in</span></span><br><span class="line">  /git/feathers-chat-app/node_modules/@bahmutov/private-foo/package.json</span><br><span class="line">? @bahmutov/private-foo@1.0.0 contacting registry...</span><br><span class="line">✓ <span class="built_in">set</span> missing <span class="string">"resolved"</span> property <span class="keyword">for</span> @bahmutov/private-foo@1.0.0 to</span><br><span class="line">  https://registry.npmjs.org/@bahmutov/private-foo/-/private-foo-1.0.0.tgz</span><br><span class="line">...</span><br><span class="line">shrinkpack +231 -0 ↓22 ✓1 00:07</span><br></pre></td></tr></table></figure>
<p>All the <code>.tar.gz</code> files were placed into <code>node_shrinkwrap</code> folder</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l node_shrinkwrap/</span><br><span class="line">total 9880</span><br><span class="line">-rw-r--r--  1     576 Jul  1 08:52 @bahmutov-private-foo-1.0.0.tgz</span><br><span class="line">-rw-r--r--  1    5102 Jul  1 08:52 accepts-1.3.3.tgz</span><br><span class="line">-rw-r--r--  1  136743 Jul  1 08:52 acorn-1.2.2.tgz</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>The tool also updated the <code>npm-shrinkwrap.json</code> file, setting the paths
to new <em>local</em> files</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"feathers-chat-app-gleb"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@bahmutov/private-foo"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">      <span class="attr">"from"</span>: <span class="string">"@bahmutov/private-foo@*"</span>,</span><br><span class="line">      <span class="attr">"resolved"</span>: <span class="string">"./node_shrinkwrap/@bahmutov-private-foo-1.0.0.tgz"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"accepts"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.3.3"</span>,</span><br><span class="line">      <span class="attr">"from"</span>: <span class="string">"accepts@&gt;=1.3.3&lt; 1.4.0"</span>,</span><br><span class="line">      <span class="attr">"resolved"</span>: <span class="string">"./node_shrinkwrap/accepts-1.3.3.tgz"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can check in the <code>node_shrinkwrap</code> folder into our Git repository, and
it will make <code>npm install</code> instant from now on, because the registry will
NOT be used - all the module resolutions are present locally after cloning.</p>
<p>Trying <code>now</code> deployment command, and ... it does not work. The <code>now</code> command
only uploads the JavaScript files, NOT the <code>.tar.gz</code> files. Even when I
forced it to upload by moving the <code>node_shrinkwrap</code> folder into the <code>src</code>
folder, the installation command did not resolve the local <code>.tar.gz</code> files.
Maybe the <code>now</code> command does not respect the <code>npm-shrinkwrap.json</code>, or
maybe there is some other reason. We need to find another way.</p>
<h2><span id="bundling-the-server-code">Bundling the server code</span></h2><p>Our goal is to run the application. In the &quot;normal&quot; Node mode, each piece
of JavaScript can be loaded from a separate file using <code>require(&lt;filename&gt;)</code>
call. The <code>&lt;filename&gt;</code> is resolved relative to the path, or from the
<code>node_modules</code> folder. If we cannot have some files loaded from the
<code>node_modules</code> because the install failed, we can try &quot;bundling&quot; the source
code into a single source file - just like we would for running an app
inside a browser!</p>
<p>I installed <a href="https://github.com/substack/node-browserify" target="_blank" rel="noopener">browserify</a> and used a simple
<a href="https://github.com/bahmutov/feathers-chat-app/blob/master/build.js" target="_blank" rel="noopener">build.js</a> to pass options that build a bundle targeted for
Node environment (instead of the browser).</p>
<figure class="highlight js"><figcaption><span>build.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>)</span><br><span class="line"><span class="keyword">var</span> insertGlobals = <span class="built_in">require</span>(<span class="string">'insert-module-globals'</span>)</span><br><span class="line">browserify(<span class="string">'./src/index.js'</span>, &#123;</span><br><span class="line">    builtins: <span class="literal">false</span>,</span><br><span class="line">    commondir: <span class="literal">false</span>,</span><br><span class="line">    insertGlobalVars: &#123;</span><br><span class="line">        __filename: insertGlobals.vars.__filename,</span><br><span class="line">        __dirname: insertGlobals.vars.__dirname,</span><br><span class="line">        process: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    browserField: <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line">.bundle()</span><br><span class="line">.pipe(fs.createWriteStream(<span class="string">'./src/out.js'</span>))</span><br></pre></td></tr></table></figure>
<p>Let us build the bundle and see if we can run the project <em>without</em>
<code>node_modules</code> folder.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ node build.js</span><br><span class="line">$ ls -l src/out.js</span><br><span class="line">-rw-r--r--  1  1575733 Jul  1 09:09 src/out.js</span><br><span class="line">$ node src/out.js</span><br><span class="line">I include private foo</span><br><span class="line">Feathers application started on localhost:3030</span><br><span class="line">^C</span><br><span class="line">$ mv node_modules tmp</span><br><span class="line">$ node src/out.js</span><br><span class="line">I include private foo</span><br><span class="line">Feathers application started on localhost:3030</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>I also had to move folders <code>config</code> and <code>public</code> into <code>src</code> for deployment
to include them.</p>
<p>We have all the code needed inside a single file <code>src/out.js</code>. Let run use
this bundle when running <code>now</code>. Oops, still there is a problem</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; Error: Cannot find module <span class="string">'/git/feathers-chat-app/src/config/default'</span></span><br><span class="line">&gt;     at Function.Module._resolveFilename (module.js:440:15)</span><br><span class="line">&gt;     at Function.Module._load (module.js:388:25)</span><br><span class="line">&gt;     at Module.require (module.js:468:17)</span><br><span class="line">&gt;     at require (internal/module.js:20:19)</span><br><span class="line">&gt;     at s (/home/nowuser/src/src/out.js:1:176)</span><br><span class="line">&gt;     at /home/nowuser/src/src/out.js:1:367</span><br><span class="line">&gt;     at EventEmitter.&lt;anonymous&gt; (/home/nowuser/src/src/out.js:20848:26)</span><br></pre></td></tr></table></figure>
<p>The <a href="https://github.com/feathersjs/feathers-configuration" target="_blank" rel="noopener">feathers-configuration</a> module loads config
JSON files by looking through the files in the <code>config</code> folder. This fails,
because the browserify does not include these - there is no way it can know
which files to include! So we need to hack around the config and just
load the files we need for this case ourselves. Change the <code>src/app.js</code>
to load the <code>config/default.json</code> ourselves and set the properties.</p>
<figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.configure(configuration(__dirname));</span></span><br><span class="line"><span class="keyword">const</span> defaults = <span class="built_in">require</span>(<span class="string">'./config/default'</span>)</span><br><span class="line"><span class="built_in">Object</span>.keys(defaults).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// TODO adjust the paths, merge environment settings, etc</span></span><br><span class="line">  <span class="keyword">var</span> value = defaults[key]</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isPath</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="regexp">/^\./</span>.test(s)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isPath(value)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'resolving'</span>, value)</span><br><span class="line">    value = path.resolve(__dirname, value)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'resolved'</span>, value)</span><br><span class="line">  &#125;</span><br><span class="line">  app.set(key, value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>In the future I will refactor the <code>feathers-configuration</code> module to
allow sending multiple config objects without loading them on the fly
from the file system.</p>
<p>Next, I removed <code>favicon</code> middleware, since the <code>.ico</code> file is not bundled
into JavaScript</p>
<figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app</span><br><span class="line"><span class="comment">// .use(favicon( path.join(app.get('public'), 'favicon.ico') ))</span></span><br><span class="line">  .use(<span class="string">'/'</span>, serveStatic( app.get(<span class="string">'public'</span>) ))</span><br></pre></td></tr></table></figure>
<p>At this point, the REST API is working on Zeit, which we can see
if we try to grab the list of users, for example.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ http https://feathers-chat-app-gleb-kmljntdwmf.now.sh/users</span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">X-Powered-By: Express</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"className"</span>: <span class="string">"not-authenticated"</span>,</span><br><span class="line">    <span class="string">"code"</span>: 401,</span><br><span class="line">    <span class="string">"errors"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"Authentication token missing."</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"NotAuthenticated"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>But if we try to open the deployed site in the browser we get 404!
Why do we not get served the HTML file <code>public/index.html</code>?</p>
<h2><span id="bundling-the-mock-read-only-file-system">Bundling the mock read-only file system</span></h2><p>The deployed application does not include any non-javascript files
from the <code>public</code> folder. We have the missing static pages there</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l src/public/</span><br><span class="line">total 56</span><br><span class="line">-rw-r--r--  1  3295 Jun 19 10:26 app.js</span><br><span class="line">-rw-r--r--  1  3443 Jun 19 10:26 chat.html</span><br><span class="line">-rw-r--r--  1  5533 Jun 18 23:24 favicon.ico</span><br><span class="line">-rw-r--r--  1  1410 Jun 18 23:29 index.html</span><br><span class="line">-rw-r--r--  1  1357 Jun 18 23:32 login.html</span><br><span class="line">-rw-r--r--  1  1365 Jun 18 23:33 signup.html</span><br></pre></td></tr></table></figure>
<p>Somehow we need to</p>
<ol>
<li>include the text contents of these files in the built bundle</li>
<li>serve the bundled text for each file, as the server tries to read
it from its &quot;file system&quot;</li>
</ol>
<p>I love mocking environments using browserify, see blog posts
<a href="../run-angular-in-web-worker">Angular in WebWorker</a> and
<a href="../run-express-server-in-your-browser">Express in ServiceWorker</a>.
Our current problem looks like a fun little challenge.</p>
<p>The static folder in Feathers is served using the plain Express
<a href="https://github.com/expressjs/serve-static" target="_blank" rel="noopener">serve-static</a> package,
which uses <a href="https://github.com/pillarjs/send" target="_blank" rel="noopener">send</a> module to open
a file stream to a file and pipe it back into the resource. If only these
modules had a file system that pointed at contents from the bundle!</p>
<p>Luckily there is module <a href="https://github.com/tschaub/mock-fs" target="_blank" rel="noopener">mock-fs</a> that
does exactly this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mock = <span class="built_in">require</span>(<span class="string">'mock-fs'</span>);</span><br><span class="line">mock(&#123;</span><br><span class="line">  <span class="string">'public/index.html'</span>: <span class="string">'hi there'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>During the build step we can collect all HTML files to be bundled into a single
file, then <code>require</code> this mock object when we bundle the code. We are going
to turn on the mocking, and the server will have no choice but return the
bundled responses. I have described the steps on a tiny example in separate
repo <a href="https://github.com/bahmutov/browserify-server" target="_blank" rel="noopener">browserify-server</a>.
First, the build collects all public HTML and JS files and puts the text
into a single JSON object.</p>
<figure class="highlight js"><figcaption><span>build.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">'glob'</span>)</span><br><span class="line"><span class="keyword">const</span> files = glob.sync(<span class="string">'src/public/*.js'</span>).concat(glob.sync(<span class="string">'src/public/*.html'</span>))</span><br><span class="line"><span class="keyword">const</span> mockOptions = &#123;&#125;</span><br><span class="line">files.forEach(<span class="function">(<span class="params">fullName</span>) =&gt;</span> &#123;</span><br><span class="line">  mockOptions[fullName] = read(fullName, <span class="string">'utf8'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> publicFiles = <span class="string">'./public-bundle.json'</span></span><br><span class="line">write(publicFiles,</span><br><span class="line">  <span class="built_in">JSON</span>.stringify(mockOptions, <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">'\n'</span>, <span class="string">'utf8'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'saved public files contents to'</span>, publicFiles)</span><br><span class="line"><span class="comment">// browserify commands ...</span></span><br><span class="line">browserify(<span class="string">'./start.js'</span>, &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>We also change the entry file for browserify to <code>start.js</code>, which right
away requires the original <code>index.js</code> file, and mocks the file system
using the file created.</p>
<figure class="highlight js"><figcaption><span>start.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'./src/index'</span>)</span><br><span class="line"><span class="keyword">const</span> mockOptions = <span class="built_in">require</span>(<span class="string">'./public-bundle'</span>)</span><br><span class="line"><span class="keyword">const</span> mock = <span class="built_in">require</span>(<span class="string">'mock-'</span> + <span class="string">'fs'</span>)</span><br><span class="line">mock(mockOptions)</span><br></pre></td></tr></table></figure>
<p>To avoid getting into recursive bundling, I split the <code>mock-fs</code> module name
in the <code>require(&#39;mock-&#39; + &#39;fs&#39;)</code> expression; this is a common trick to
stop <code>browserify</code> from messing with things it should leave alone.</p>
<p>We can find our HTML inside the bundle</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep <span class="string">"&lt;title&gt;"</span> src/out.js</span><br><span class="line"><span class="string">"src/public/chat.html"</span>: <span class="string">"&lt;html&gt;\n&lt;head&gt; ...</span></span><br></pre></td></tr></table></figure>
<p>We can even run the bundled code with the folder <code>src/public</code> removed</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mv src/public src/tmp</span><br><span class="line">$ npm start</span><br></pre></td></tr></table></figure>
<p>Deploying the bundle to <code>zeit</code> and ... in production the module <code>mock-fs</code>
is not found! Seems Zeit does not let you mock the file system.</p>
<p>Ok, time to find one more work around.</p>
<h2><span id="writing-the-temp-file-system">Writing the temp file system</span></h2><p>Zeit does allow you to write data into <code>/tmp</code> folder. This is where we write
the messages database for example. We have the <code>public</code> folder bundled into
our single application JavaScript file; we can just dump the files into the
<code>/tmp</code> folder at the startup step. The server app then can serve
the static files normally.</p>
<p>The build file still collects all <code>.js</code> and <code>.html</code> files in the <code>public</code>
folder, and dumps their contents into a single <code>.json</code> file</p>
<figure class="highlight js"><figcaption><span>build.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">collectPublicFiles</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">'glob'</span>)</span><br><span class="line">  <span class="keyword">const</span> files = glob.sync(<span class="string">'public/*.js'</span>).concat(glob.sync(<span class="string">'public/*.html'</span>))</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'public files\n'</span> + files.join(<span class="string">'\n'</span>))</span><br><span class="line">  <span class="keyword">const</span> read = <span class="built_in">require</span>(<span class="string">'fs'</span>).readFileSync</span><br><span class="line">  <span class="keyword">const</span> mockOptions = &#123;&#125;</span><br><span class="line">  files.forEach(<span class="function">(<span class="params">fullName</span>) =&gt;</span> &#123;</span><br><span class="line">    mockOptions[fullName] = read(fullName, <span class="string">'utf8'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> mockOptions</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mockPublicFiles</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mockOptions = collectPublicFiles()</span><br><span class="line">  <span class="comment">// console.log(mockOptions)</span></span><br><span class="line">  <span class="keyword">const</span> publicFiles = <span class="string">'./public-bundle.json'</span></span><br><span class="line">  write(publicFiles,</span><br><span class="line">    <span class="built_in">JSON</span>.stringify(mockOptions, <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">'\n'</span>, <span class="string">'utf8'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'saved public files contents to'</span>, publicFiles)</span><br><span class="line">&#125;</span><br><span class="line">mockPublicFiles()</span><br><span class="line">browserify(<span class="string">'./start.js'</span>, &#123;...&#125;)</span><br></pre></td></tr></table></figure>
<p>Then <code>start.js</code> file dumps the collected contents into <code>/tmp</code> folder</p>
<figure class="highlight js"><figcaption><span>start.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writePublicFiles</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mockOptions = <span class="built_in">require</span>(<span class="string">'./public-bundle'</span>)</span><br><span class="line">  <span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line">  <span class="keyword">const</span> outputFolder = <span class="string">'/tmp'</span></span><br><span class="line">  <span class="keyword">const</span> dirname = <span class="built_in">require</span>(<span class="string">'path'</span>).dirname</span><br><span class="line">  <span class="keyword">const</span> inTemp = <span class="built_in">require</span>(<span class="string">'path'</span>).join.bind(<span class="literal">null</span>, outputFolder)</span><br><span class="line">  <span class="keyword">const</span> mkdirp = <span class="built_in">require</span>(<span class="string">'mkdirp'</span>)</span><br><span class="line">  <span class="keyword">const</span> write = <span class="built_in">require</span>(<span class="string">'fs'</span>).writeFileSync</span><br><span class="line">  <span class="built_in">Object</span>.keys(mockOptions).forEach(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> full = inTemp(name)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'writing file'</span>, full)</span><br><span class="line">    <span class="keyword">const</span> folder = dirname(full)</span><br><span class="line">    mkdirp.sync(folder)</span><br><span class="line">    write(full, mockOptions[name], <span class="string">'utf8'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">writePublicFiles()</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./src/index'</span>)</span><br></pre></td></tr></table></figure>
<p>Let us deploy and see if we finally got a happy server</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ now</span><br><span class="line">&gt; Ready! https://feathers-chat-app-gleb-yhqzmzizjz.now.sh (copied to clipboard) [2s]</span><br><span class="line">&gt; Upload [====================] 100% 0.0s</span><br><span class="line">&gt; Sync complete (1.51MB) [8s]</span><br><span class="line">&gt; ▲ npm run now-start</span><br><span class="line">&gt; writing file /tmp/public/app.js</span><br><span class="line">&gt; writing file /tmp/public/chat.html</span><br><span class="line">&gt; writing file /tmp/public/index.html</span><br><span class="line">&gt; writing file /tmp/public/login.html</span><br><span class="line">&gt; writing file /tmp/public/signup.html</span><br><span class="line">&gt; I include private foo</span><br><span class="line">&gt; Feathers application started on localhost:3030</span><br><span class="line">&gt; Deployment complete!</span><br></pre></td></tr></table></figure>
<p>From the terminal let us fetch the index page</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ http https://feathers-chat-app-gleb-yhqzmzizjz.now.sh</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"content-type"</span> content=<span class="string">"text/html; charset=utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Feathers Chat&lt;/title&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>These are not tears of sadness, these are tears of happiness</p>
</blockquote>
<p>You can check the app yourself at the above url
<a href="https://feathers-chat-app-gleb-yhqzmzizjz.now.sh" target="_blank" rel="noopener">https://feathers-chat-app-gleb-yhqzmzizjz.now.sh</a>.</p>
<p>As the final change, I added bundling and writing the config JSON files
the same way to reuse the original <code>feathers-configuration</code> code.</p>
<h2><span id="installing-nothing">Installing nothing</span></h2><p>To speed up the deploys, we can skip the dependency deployment on Zeit.
We have already bundled everything into the single <code>src/out.js</code> file; there
is no need to run <code>npm install</code> when deploying. We can write a simple
script to empty the <code>dependencies</code> and <code>devDependencies</code> in <code>package.json</code></p>
<figure class="highlight js"><figcaption><span>no-deps.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span></span><br><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(<span class="string">'./package.json'</span>)</span><br><span class="line">pkg.dependencies = pkg.devDependencies = []</span><br><span class="line"><span class="keyword">const</span> write = <span class="built_in">require</span>(<span class="string">'fs'</span>).writeFileSync</span><br><span class="line">write(<span class="string">'./package.json'</span>, <span class="built_in">JSON</span>.stringify(pkg, <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">'\n'</span>, <span class="string">'utf8'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'removed dependencies from package.json'</span>)</span><br></pre></td></tr></table></figure>
<p>We will run the above script before the deployment, and will restore the
<code>package.json</code> back to its full state after the deploy.</p>
<figure class="highlight json"><figcaption><span>packate.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"now-start"</span>: <span class="string">"node src/out.js"</span>,</span><br><span class="line">    <span class="attr">"bundle"</span>: <span class="string">"node build.js"</span>,</span><br><span class="line">    <span class="attr">"predeploy"</span>: <span class="string">"npm run bundle &amp;&amp; node no-deps.js"</span>,</span><br><span class="line">    <span class="attr">"deploy"</span>: <span class="string">"now"</span>,</span><br><span class="line">    <span class="attr">"postdeploy"</span>: <span class="string">"git checkout package.json"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let us try this. Without removing the superfluous <code>node_modules</code> the bundling
and deployment takes 60 seconds.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ time npm run plain-deploy</span><br><span class="line">&gt; Building</span><br><span class="line">&gt; ▲ npm install</span><br><span class="line">&gt; Installing package subarg@^1.0.0</span><br><span class="line">&gt; Installing package through2@^2.0.0</span><br><span class="line">&gt; Installing package xtend@^4.0.0</span><br><span class="line">...</span><br><span class="line">&gt; Deployment complete!</span><br><span class="line">real  0m59.948s</span><br></pre></td></tr></table></figure>
<p>With just the bundling and moving just the single unchanged file it
takes 25 seconds.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ time npm run deploy</span><br><span class="line">&gt; feathers-chat-app-gleb@1.0.0 predeploy /git/feathers-chat-app</span><br><span class="line">&gt; npm run bundle &amp;&amp; node no-deps.js</span><br><span class="line">&gt; feathers-chat-app-gleb@1.0.0 bundle /git/feathers-chat-app</span><br><span class="line">&gt; node build.js</span><br><span class="line">public files</span><br><span class="line">public/app.js</span><br><span class="line">public/chat.html</span><br><span class="line">public/index.html</span><br><span class="line">public/login.html</span><br><span class="line">public/signup.html</span><br><span class="line">saved public files contents to ./public-bundle.json</span><br><span class="line">removed dependencies from package.json</span><br><span class="line">&gt; feathers-chat-app-gleb@1.0.0 deploy /git/feathers-chat-app</span><br><span class="line">&gt; now</span><br><span class="line">&gt; Deploying <span class="string">"/git/feathers-chat-app"</span></span><br><span class="line">&gt; Using Node.js undefined (requested: `6`)</span><br><span class="line">&gt; Ready! https://feathers-chat-app-gleb-rjynpwiawt.now.sh (copied to clipboard) [2s]</span><br><span class="line">&gt; Upload [====================] 100% 0.0s</span><br><span class="line">&gt; Sync complete (837B) [989ms]</span><br><span class="line">&gt; Initializing…</span><br><span class="line">&gt; Building</span><br><span class="line">&gt; ▲ npm install</span><br><span class="line">&gt; Error &#123;</span><br><span class="line">  Error: ENOENT: no such file or directory, scandir <span class="string">'/home/nowuser/src/node_modules'</span></span><br><span class="line">&gt; I include private foo</span><br><span class="line">&gt; Feathers application started on localhost:3030</span><br><span class="line">&gt; Deployment complete!</span><br><span class="line">&gt; feathers-chat-app-gleb@1.0.0 postdeploy /git/feathers-chat-app</span><br><span class="line">&gt; git checkout package.json</span><br><span class="line">real  0m24.659s</span><br></pre></td></tr></table></figure>
<p>Fast and simple.</p>
<h2><span id="conclusion">Conclusion</span></h2><p>I wish Zeit had support for private modules, yet lack of this feature was a
great opportunity for hacking together a work around. Notice that I had
pursued multiple solutions that lead to a dead end. Yet every solution that did
not work taught me something new. One just has to be patient and keep
coming up with new ideas, chipping away at the problem.</p>
<p>The final solution is a weird one; I am sure the original problem has to do
with browserified bundle not being able to properly load the regular files
due to some path mangling.
I will not pursue this further, instead I hope to see the Zeit team
implement installation of private NPM modules using proper authentication.</p>
<p>You can find the code at
<a href="https://github.com/bahmutov/feathers-chat-app" target="_blank" rel="noopener">bahmutov/feathers-chat-app</a>
and see the running application at
<a href="https://feathers-chat-app-gleb-rjynpwiawt.now.sh" target="_blank" rel="noopener">https://feathers-chat-app-gleb-rjynpwiawt.now.sh</a></p>
<p>If you like hacking the code like me, read
<a href="../better-hacker/">How to become a better hacker</a> blog post.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/deploying-private-npm-modules-to-zeit/" data-id="cjiubgfld008vcvoou3d224u8" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/deploying-private-npm-modules-to-zeit/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/advice/">advice</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/modular-development/">modular development</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../cyclejs-frontendcamp/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CycleJS FrontEnd Camp
        
      </div>
    </a>
  
  
    <a href="../parallel-end-to-end-testing/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Parallel end to end testing with Cypress, Docker and GitLab</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">102</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">284</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">98</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">67</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/">graphql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">160</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">71</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">73</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.74px;">QUnit</a> <a href="../tags/advice/" style="font-size: 19.57px;">advice</a> <a href="../tags/angularjs/" style="font-size: 17.83px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.48px;">assertions</a> <a href="../tags/ast/" style="font-size: 13.04px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.65px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.52px;">browser</a> <a href="../tags/ci/" style="font-size: 12.61px;">ci</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.61px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 15.22px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.87px;">d3</a> <a href="../tags/db/" style="font-size: 14.35px;">db</a> <a href="../tags/docker/" style="font-size: 13.48px;">docker</a> <a href="../tags/es6/" style="font-size: 15.22px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.26px;">functional</a> <a href="../tags/generators/" style="font-size: 11.74px;">generators</a> <a href="../tags/git/" style="font-size: 14.35px;">git</a> <a href="../tags/graphql/" style="font-size: 10px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.61px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.87px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 12.17px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.3px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.87px;">interview</a> <a href="../tags/jade/" style="font-size: 11.3px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.87px;">jshint</a> <a href="../tags/modular-development/" style="font-size: 16.96px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 18.7px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.09px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.3px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.39px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.43px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/reactive/" style="font-size: 14.78px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 10.43px;">reactjs</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.61px;">security</a> <a href="../tags/sentry/" style="font-size: 13.91px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.17px;">service workers</a> <a href="../tags/testing/" style="font-size: 19.13px;">testing</a> <a href="../tags/tutorial/" style="font-size: 13.91px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 10.43px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.43px;">ui</a> <a href="../tags/vuejs/" style="font-size: 11.3px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.17px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../rolling-for-test/">Rolling for a Test</a>
          </li>
        
          <li>
            <a href="../tested-live-documentation/">Tested live documentation is a thing with MDX, Docz and Cypress</a>
          </li>
        
          <li>
            <a href="../trying-graphql/">Trying GraphQL</a>
          </li>
        
          <li>
            <a href="../trying-out-redis/">Trying Redis</a>
          </li>
        
          <li>
            <a href="../vuepress-conditional-testing/">VuePress and some Cypress end-to-end testing tips</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/deploying-private-npm-modules-to-zeit/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
