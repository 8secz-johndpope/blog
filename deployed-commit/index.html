<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Deployed commit | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="I like Codeship CI - it has a very intuitive setup and a reliable continuous build and deployment service. One can build, test and deploy a Nodejs application in a few clicks. Recently I figured out h">
<meta name="keywords" content="nodejs,advice,sentry,git,gulp">
<meta property="og:type" content="article">
<meta property="og:title" content="Deployed commit">
<meta property="og:url" content="https://glebbahmutov.com/blog/deployed-commit/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="I like Codeship CI - it has a very intuitive setup and a reliable continuous build and deployment service. One can build, test and deploy a Nodejs application in a few clicks. Recently I figured out h">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-02-14T02:33:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Deployed commit">
<meta name="twitter:description" content="I like Codeship CI - it has a very intuitive setup and a reliable continuous build and deployment service. One can build, test and deploy a Nodejs application in a few clicks. Recently I figured out h">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <!-- global digital climate strike -->
  <!-- https://digital.globalclimatestrike.net/#website-assets -->
  <script src="https://assets.digitalclimatestrike.net/widget.js" async></script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
          <h2 id="subtitle-wrap">
            <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
          </h2>
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-deployed-commit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2015-04-06T04:00:00.000Z" itemprop="datePublished">Apr 6 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Deployed commit
    </h1>

    <h2 class="article-title" itemprop="name">
      How to embed the commit id in the Express application using Codeship and Heroku.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I like <a href="http://codeship.com" target="_blank" rel="noopener">Codeship</a> CI - it has a very intuitive setup and a reliable continuous
build and deployment service. One can build, test and <a href="../deploy-node-app-to-heroku/">deploy a Nodejs</a> application in a few clicks.
Recently I figured out how to embed the last built commit when building an Express application
using Codeship and deploying it to <a href="http://www.heroku.com" target="_blank" rel="noopener">Heroku</a>.</p>
<p>Imagine you have an Express application, and you need two features to better track the run time errors</p>
<h3><span id="feature-1">Feature 1</span></h3><p>Pass the last git commit id when configuring Raven server-side or client-side handler using
the <a href="http://raven-js.readthedocs.org/en/latest/config/index.html?highlight=release#release" target="_blank" rel="noopener">release</a> option.
This will allow to group the real time crash data by the release / commit id.</p>
<figure class="highlight html"><figcaption><span>index.ejs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  (<span class="function"><span class="keyword">function</span> <span class="title">initRaven</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> url = <span class="string">'&lt;%- config.SENTRY.url %&gt;'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> release = <span class="string">'&lt;%- config.RELEASE_ID %&gt;'</span> || <span class="string">'dev'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> sentryConfig = &#123;</span></span><br><span class="line"><span class="undefined">      release: release</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined">    Raven.config(url, sentryConfig).install();</span></span><br><span class="line"><span class="undefined">  &#125;());</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3><span id="feature-2">Feature 2</span></h3><p>When viewing the bundled script files, it would be nice to see a banner text with version
and commit id string to quickly determine which commit is running on the client side.
I build 4 full bundles to be statically served to the client browser:
<code>vendor-scripts.js, vendor-styles.css, application.js</code> and <code>application.css</code>.
These are minified for the production release to
<code>vendor-scripts.min.js, vendor-styles.min.css, application.min.js</code> and <code>application.min.css</code>.
Into each file I would like to add a banner comment using <a href="https://www.npmjs.com/package/gulp-header" target="_blank" rel="noopener">gulp-header</a></p>
<figure class="highlight js"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> header = <span class="built_in">require</span>(<span class="string">'gulp-header'</span>);</span><br><span class="line"><span class="keyword">var</span> pkg = <span class="built_in">require</span>(<span class="string">'./package.json'</span>);</span><br><span class="line"><span class="keyword">var</span> banner = [</span><br><span class="line">  <span class="string">'/*! &lt;%= pkg.name %&gt; - &lt;%= pkg.description %&gt;'</span>,</span><br><span class="line">  <span class="string">'* @version v&lt;%= pkg.version %&gt; &lt;%= pkg.commitId %&gt;'</span>,</span><br><span class="line">  <span class="string">'*/'</span>,</span><br><span class="line">  <span class="string">''</span>].join(<span class="string">'\n'</span>);</span><br><span class="line"><span class="comment">// task to minifiy already created application.js</span></span><br><span class="line">gulp.task(<span class="string">'min-app-scripts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> inputFilename = join(browserDestination, <span class="string">'application.js'</span>);</span><br><span class="line">    <span class="keyword">return</span> gulp.src(inputFilename)</span><br><span class="line">      .pipe(rename(&#123;<span class="attr">suffix</span>: <span class="string">'.min'</span>&#125;))</span><br><span class="line">      .pipe(uglify())</span><br><span class="line">      .pipe(header(banner, &#123; <span class="attr">pkg</span>: pkg &#125;))</span><br><span class="line">      .pipe(gulp.dest(browserDestination));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>There is one more added difficulty. When building the javascript source from a git commit on Codeship,
there is an environment variable <code>$COMMIT_ID</code> with the <code>HEAD</code> commit id. After the code has
been built, the code is pushed to Heroku, where
<em>the environment does not have the commit reference or even the git repository itself!</em> Thus we
need to figure out how to build the bundle, minify it, embed the git commit id and then ship
the application to the Heroku dyno.</p>
<h2><span id="solution">Solution</span></h2><p>I solved this problem by building full bundles on Codeship, then grabbing the commit id (using
my own script from <a href="https://github.com/bahmutov/ggit" target="_blank" rel="noopener">ggit</a> package to avoid relying on Codeship-specific assumptions).
I save the commit SHA id into a JSON file called <code>build.json</code></p>
<figure class="highlight js"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lastCommitId = <span class="built_in">require</span>(<span class="string">'ggit'</span>).lastCommitId;</span><br><span class="line">gulp.task(<span class="string">'save-commit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">  lastCommitId()</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">      fs.writeFileSync(<span class="string">'./build.json'</span>, <span class="built_in">JSON</span>.stringify(&#123; <span class="attr">RELEASE_ID</span>: id &#125;, <span class="literal">null</span>, <span class="number">2</span>), <span class="string">'utf8'</span>);</span><br><span class="line">      <span class="comment">// add to package to make available everywhere after this task</span></span><br><span class="line">      pkg.commitId = id;</span><br><span class="line">      done();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>A typical build file will contain an id like this</p>
<figure class="highlight json"><figcaption><span>build.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"RELEASE_ID"</span>: <span class="string">"d7ad085b40120b012a6b0404e801fa80e6e644ca"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In addition to saving the id in the <code>build.json</code> file I have attached the id to the package object,
making available to the banner task</p>
<figure class="highlight js"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> header = <span class="built_in">require</span>(<span class="string">'gulp-header'</span>);</span><br><span class="line"><span class="keyword">var</span> pkg = <span class="built_in">require</span>(<span class="string">'./package.json'</span>);</span><br><span class="line"><span class="keyword">var</span> banner = [</span><br><span class="line">  <span class="string">'/*! &lt;%= pkg.name %&gt; - &lt;%= pkg.description %&gt;'</span>,</span><br><span class="line">  <span class="string">'* @version v&lt;%= pkg.version %&gt; &lt;%= pkg.commitId %&gt;'</span>,</span><br><span class="line">  <span class="string">'*/'</span>,</span><br><span class="line">  <span class="string">''</span>].join(<span class="string">'\n'</span>);</span><br><span class="line">...</span><br><span class="line">gulp.task(<span class="string">'save-commit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    pkg.commitId = id;</span><br><span class="line">    done();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>I make sure to sequence the build tasks to build the full bundles first, then
grab the commit id, then to minify each budle</p>
<figure class="highlight js"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'min-app-scripts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> inputFilename = join(browserDestination, <span class="string">'application.js'</span>);</span><br><span class="line">  <span class="keyword">return</span> gulp.src(inputFilename)</span><br><span class="line">    .pipe(rename(&#123;<span class="attr">suffix</span>: <span class="string">'.min'</span>&#125;))</span><br><span class="line">    .pipe(uglify())</span><br><span class="line">    .pipe(header(banner, &#123; <span class="attr">pkg</span>: pkg &#125;))</span><br><span class="line">    .pipe(gulp.dest(browserDestination));</span><br><span class="line">&#125;);</span><br><span class="line">gulp.task(<span class="string">'min-bundles'</span>,</span><br><span class="line">  [<span class="string">'min-app-scripts'</span>, <span class="string">'min-vendor-scripts'</span>, <span class="string">'min-app-styles'</span>, <span class="string">'min-vendor-styles'</span>]);</span><br><span class="line">gulp.task(<span class="string">'bundle-and-save-commit'</span>, [<span class="string">'bundles'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  gulp.start(<span class="string">'save-commit'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">gulp.task(<span class="string">'release'</span>, [<span class="string">'bundle-and-save-commit'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  gulp.start(<span class="string">'min-bundles'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Thus each minified bundle used in the production environment has the commit id
embedded inside the banner comment at the top of the file.
Looking at the commit id makes it simple to trace the code back to the repo.</p>
<h2><span id="publishing-version-file">Publishing version file</span></h2><p>The minified bundles and <code>build.json</code> are built on the Codeship server.
I avoid committing the minified bundle files into the git repo.
They take up space and never merge without conflicts.
The <code>build.json</code> is also transient and should be ignored by the git tool,
otherwise it will constantly be modified. I added the minified files
and the <code>build.json</code> to the list of ignored filed by default.</p>
<figure class="highlight sh"><figcaption><span>.gitignore</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public/bundles/*.min.*</span><br><span class="line">build.json</span><br></pre></td></tr></table></figure>
<p>As part of the Codeship build step I <em>forcibly add</em> these files to the git
repo because I will need to copy these files
to the Heroku. Thus my Codeship Node test script in addition to the normal
NPM install and test commands has the following git commands</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build and test the bundles</span></span><br><span class="line">gulp</span><br><span class="line"><span class="comment"># commit minified bundle files and build.json</span></span><br><span class="line">git config user.email <span class="string">"ci@codeship.com"</span></span><br><span class="line">git config user.name <span class="string">"ci"</span></span><br><span class="line">git add -f public/dist/*.min.*</span><br><span class="line">git add -f build.json</span><br><span class="line">git commit -m <span class="string">"added min files and build json file"</span></span><br></pre></td></tr></table></figure>
<p>Codeship pushes code to the Heroku remote using the commit id too.
Since we just committed new code, the commit Heroku tries to push using
the built-in command is 1 commit too old. Here is the command Codeship uses
to push <code>git push heroku_&lt;project name&gt; $COMMIT_ID:refs/heads/master</code>.
To push the commit we just created we need to update the <code>$COMMIT_ID</code>
variable to the new HEAD commit id</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">git add -f build.json</span><br><span class="line">git commit -m <span class="string">"added min files and build json file"</span></span><br><span class="line">COMMIT_ID=`git <span class="built_in">log</span> --format=<span class="string">"%H"</span> -n 1`</span><br><span class="line"><span class="comment"># commit_id now points at the new last commit</span></span><br></pre></td></tr></table></figure>
<p>One last option needs to be set. Because we are building this commit
temporarily, it should be overwritten without merging the next time we
try to deploy. Thus we need to go to the Codeship project deployment
settings and flip the <code>force push</code> switch to make sure the temp commit is
force pushed <code>git push heroku_&lt;project name&gt; $COMMIT_ID:refs/heads/master -f</code>.</p>
<p>Now our production bundles have the right commit id embedded in them, and
there is <code>build.json</code> file with the last commit id.</p>
<h3><span id="alternative-last-commit-without-gulp-or-grunt">Alternative: last commit without gulp or grunt</span></h3><p>If you prefer to use npm scripts and avoid gulp or grunt tools, you can still easily grab
the last commit id and save it in <code>build.json</code>. Just add dependency on <code>ggit</code> package and use
its command by adding command to your <code>package.json</code></p>
<pre><code>npm install --save ggit
</code></pre><figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "last-commit": "ggit-last -f build.json"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The add additional command at the end of the Codeship test script</p>
<pre><code>...
npm run last-commit
</code></pre><p>This should save <code>build.json</code> after each successful test run.</p>
<h2><span id="using-commit-id-in-express-server">Using commit id in Express server</span></h2><p>If you use <a href="http://expressjs.com/" target="_blank" rel="noopener">express.js</a> as a server, it would be convenient to embed the commit id
in the served <code>meta</code> tags. One can read the <code>build.json</code> and pass the commit to the <code>response.render</code> method</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadLastCommitId</span>(<span class="params">serverApp</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> exists = <span class="built_in">require</span>(<span class="string">'fs'</span>).existsSync;</span><br><span class="line">  <span class="keyword">var</span> join = <span class="built_in">require</span>(<span class="string">'path'</span>).join;</span><br><span class="line">  <span class="comment">// assume the generated build.json is in the same folder</span></span><br><span class="line">  <span class="keyword">var</span> filename = join(__dirname, <span class="string">'./build.json'</span>);</span><br><span class="line">  <span class="keyword">if</span> (exists(filename)) &#123;</span><br><span class="line">    <span class="keyword">var</span> build = <span class="built_in">require</span>(filename);</span><br><span class="line">    serverApp.set(<span class="string">'commit'</span>, build.id);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'set last commit id to'</span>, build.id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">loadLastCommit(app);</span><br></pre></td></tr></table></figure>
<p>If the entire SHA commit id is too long (it is in my opinion), just shorten it to the first 7 chars</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shortCommitId = build.id.substr(<span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">serverApp.set(<span class="string">'commit'</span>, shortCommitId);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'set last commit id to %s from long %s'</span>, shortCommitId, build.id);</span><br></pre></td></tr></table></figure>
<p>One can then embed the commit id in any view, for example</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">middleware</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'viewFileName'</span>, &#123;</span><br><span class="line">    title: <span class="string">'My title'</span>,</span><br><span class="line">    commit: req.app.get(<span class="string">'commit'</span>) || <span class="string">'unknown'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>where the <code>viewFileName.jade</code> includes the meta tag</p>
<figure class="highlight plain"><figcaption><span>viewFileName.jade</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">doctype html</span><br><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    meta(charset=&apos;utf-8&apos;)</span><br><span class="line">    meta(name=&apos;viewport&apos;, content=&apos;width=device-width, initial-scale=1.0&apos;)</span><br><span class="line">    meta(name=&apos;commit&apos;, content=&apos;#&#123;commit&#125;&apos;)</span><br><span class="line">    title #&#123;title&#125;</span><br></pre></td></tr></table></figure>
<p>Having <code>commit</code> meta tag in each page is very convenient for debugging any potential bugs.</p>
<h2><span id="passing-commit-id-to-sentry">Passing commit id to Sentry</span></h2><p>How do we load the <code>RELEASE_ID</code> from <code>build.json</code> and pass it to both the server-side (I am using
<a href="https://github.com/bahmutov/raven-express" target="_blank" rel="noopener">raven-express</a>) and client-side Raven config? To manage all configuration
settings depending on the environment / command line option / settings file and defaults,
I am using <a href="https://github.com/indexzero/nconf" target="_blank" rel="noopener">nconf</a>. Its best feature is the hierarchical merging of settings it loads from one or json files,
with the process environment variables and command line arguments.
The server can simply load each config file in addition to the defaults. Non-existent files will be ignored.</p>
<figure class="highlight js"><figcaption><span>config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nconf = <span class="built_in">require</span>(<span class="string">'nconf'</span>);</span><br><span class="line">nconf.env().argv();</span><br><span class="line">nconf.file(<span class="string">'build.json'</span>, path.join(rootPath, <span class="string">'/build.json'</span>));</span><br><span class="line">nconf.defaults(&#123;</span><br><span class="line">    RELEASE_ID: <span class="string">'dev'</span>,</span><br><span class="line">    <span class="comment">// other settings</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Thus during runtime, the <code>RELEASE_ID</code> setting from the <code>build.json</code> will overwrite the default <code>dev</code>
value. We can use the config value when rendering the <code>index.ejs</code> template shown above</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showIndex</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> config = &#123;</span><br><span class="line">      RELEASE_ID: conf.get(<span class="string">'RELEASE_ID'</span>)</span><br><span class="line">      <span class="comment">// other settings</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> res.render(<span class="string">'index'</span>, &#123;<span class="attr">config</span>: config&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>That is it. All Sentry errors will be tagged with the code commit id, making tracing the errors
to the original source code very simple.</p>
<h2><span id="update-1-last-commit-and-built-version">Update 1 - last-commit and built-version</span></h2><p>To simplify saving / loading of the last commit SHA, I created
<a href="https://github.com/bahmutov/last-commit" target="_blank" rel="noopener">last-commit</a>. Install the package and save
it as normal dependency in your server / application.</p>
<pre><code>npm install --save last-commit
</code></pre><p>After CI builds (probably has Git repo information), run the following NPM command to save the
last commit in <code>build.json</code>: <code>npm run last</code></p>
<figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "last": "last-commit"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Follow the instructions above to deploy the generated <code>build.json</code> with the rest of the code
onto the hosted environment.</p>
<p>At the server startup, use the function exported by <code>last-commit</code> to read either
the last commit id from the repo or from <code>build.json</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> getLastCommitId = <span class="built_in">require</span>(<span class="string">'last-commit'</span>);</span><br><span class="line">getLastCommitId()</span><br><span class="line">  .tap(<span class="function"><span class="keyword">function</span> <span class="title">setCommitId</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// for example, set on the server</span></span><br><span class="line">    app.set(<span class="string">'commit'</span>, id);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>I also wrote <a href="https://github.com/bahmutov/built-version" target="_blank" rel="noopener">built-version</a>
that saves both latest Git SHA and NPM version (even for semantically
released packages).</p>
<h2><span id="update-2-render-vars">Update 2 - render-vars</span></h2><p>Commit id, version information, error catcher api string - these variables should be included in each
rendered page (assuming ExpressJS). To avoid pasting same code into each view to add these variables,
use <a href="https://github.com/bahmutov/render-vars" target="_blank" rel="noopener">render-vars</a> utility. Just add necessary variables
one by one and they will be added to whatever local variables used when calling <code>res.render</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> renderVar = include(<span class="string">'render-vars'</span>);</span><br><span class="line">renderVar(app, <span class="string">'foo'</span>, <span class="string">'bar'</span>);</span><br><span class="line">renderVar(app, <span class="string">'life'</span>, <span class="number">42</span>);</span><br><span class="line"><span class="comment">// somewhere in the controller</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> locals = &#123;</span><br><span class="line">      title: <span class="string">'Home'</span></span><br><span class="line">    &#125;;</span><br><span class="line">    res.render(<span class="string">'home'</span>, locals);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>index</code> provides just the page-specific title value, but when rendered, the template <code>home</code>
can use <code>foo</code> and <code>life</code> variables too, because they were combined with the locals before calling
<code>app.render</code> internally.</p>
<pre><code>{
    title: &apos;Home&apos;,
    foo: &apos;bar&apos;,
    life: 42
}
</code></pre><h2><span id="update-3-complete-deploy-from-circleci-to-heroku">Update 3 - complete deploy from CircleCI to Heroku</span></h2><p>Here is a complete deploy command from CirclECI to Heroku. This uses NPM
command <code>save-build</code> which runs <a href="https://github.com/bahmutov/git-last" target="_blank" rel="noopener">git-last</a> command.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"save-build"</span>: <span class="string">"git-last -f build.json"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We also need to generate a local <code>.npmrc</code> file and include it with Heroku
deploy IF we have private NPM modules and need Heroku to authenticate when
installing.</p>
<p>We will pass new commit (with <code>build.json</code> and <code>.npmrc</code> files) via <code>COMMIT_ID</code>
environment variable that we will write into <code>.circlerc</code> file to pass to the
next command. Each CircleCI command runs as its own shell script, so we cannot
simply export it.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deployment:</span></span><br><span class="line"><span class="attr">  production:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    commands:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">save-build</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cat</span> <span class="string">build.json</span></span><br><span class="line">      <span class="comment"># include the generated build file with deploy, but we have to</span></span><br><span class="line">      <span class="comment"># force it because it is normally ignored by Git</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">add</span> <span class="bullet">-f</span> <span class="string">build.json</span></span><br><span class="line">      <span class="comment"># copy .npmrc file with token variable</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">echo</span> <span class="string">'//registry.npmjs.org/:_authToken=$&#123;NPM_TOKEN&#125;'</span> <span class="string">&gt;&gt;</span> <span class="string">.npmrc</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">add</span> <span class="bullet">-f</span> <span class="string">.npmrc</span></span><br><span class="line">      <span class="comment"># before we can commit we need to set user info</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">"$CIRCLE_USERNAME@$CIRCLE_PROJECT_USERNAME"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">"CircleCI Deploy"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">commit</span> <span class="bullet">-m</span> <span class="string">"added build.json"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">echo</span> <span class="string">export</span> <span class="string">COMMIT_ID=`git</span> <span class="string">log</span> <span class="bullet">--format="%H"</span> <span class="bullet">-n</span> <span class="number">1</span><span class="string">`</span> <span class="string">&gt;&gt;</span> <span class="string">$HOME/.circlerc</span></span><br><span class="line">      <span class="comment"># commit_id now points at the new last commit</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">echo</span> <span class="string">"New commit to deploy is $COMMIT_ID"</span></span><br><span class="line">      <span class="comment"># push specific commit and force it because it is not on master</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">git</span> <span class="string">push</span> <span class="bullet">-f</span> <span class="string">git@heroku.com:&lt;project</span> <span class="string">name&gt;.git</span> <span class="string">$COMMIT_ID:master</span></span><br></pre></td></tr></table></figure>
<p>Substitute the project (repo) name in the Heroku URL in the last line to push.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/deployed-commit/" data-id="ckararx0o00ak6nfjzwpxpzqy" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/deployed-commit/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/advice/">advice</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/git/">git</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/gulp/">gulp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/nodejs/">nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/sentry/">sentry</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../less-boilerplate-in-express-app/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Less boilerplate in express app
        
      </div>
    </a>
  
  
    <a href="../angular-vs-backbone-vs-ember/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Angular vs Backbone vs Ember</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">123</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">333</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/">a11y</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">100</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/">algolia</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/">climate</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">55</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">68</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/">github</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/">graphql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">163</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/">markdown</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">81</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/">renovate</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">103</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/zeit/">zeit</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.67px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10px;">a11y</a> <a href="../tags/advice/" style="font-size: 19.17px;">advice</a> <a href="../tags/algolia/" style="font-size: 10px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.92px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.33px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.92px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.42px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.25px;">browser</a> <a href="../tags/ci/" style="font-size: 13.75px;">ci</a> <a href="../tags/climate/" style="font-size: 12.08px;">climate</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.5px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 17.5px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.83px;">d3</a> <a href="../tags/db/" style="font-size: 14.17px;">db</a> <a href="../tags/docker/" style="font-size: 14.58px;">docker</a> <a href="../tags/es6/" style="font-size: 15px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.33px;">functional</a> <a href="../tags/generators/" style="font-size: 11.67px;">generators</a> <a href="../tags/git/" style="font-size: 15px;">git</a> <a href="../tags/github/" style="font-size: 12.5px;">github</a> <a href="../tags/graphql/" style="font-size: 10.83px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.5px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.83px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 12.5px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.67px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.83px;">interview</a> <a href="../tags/jade/" style="font-size: 11.25px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.83px;">jshint</a> <a href="../tags/markdown/" style="font-size: 12.92px;">markdown</a> <a href="../tags/modular-development/" style="font-size: 16.67px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 18.75px;">nodejs</a> <a href="../tags/performance/" style="font-size: 15.83px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.25px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.08px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.42px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/reactive/" style="font-size: 14.58px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.25px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.25px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.92px;">security</a> <a href="../tags/sentry/" style="font-size: 14.17px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.08px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.58px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.42px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.08px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.42px;">ui</a> <a href="../tags/vuejs/" style="font-size: 11.25px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.08px;">web workers</a> <a href="../tags/zeit/" style="font-size: 12.08px;">zeit</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../run-all-specs/">Be careful when running all specs together</a>
          </li>
        
          <li>
            <a href="../keep-examples-up-to-date/">Keep Examples Up To Date</a>
          </li>
        
          <li>
            <a href="../mocking-named-typescript-imports/">Mocking named TypeScript imports during tests</a>
          </li>
        
          <li>
            <a href="../my-vision-for-component-tests/">My Vision for Component Tests in Cypress</a>
          </li>
        
          <li>
            <a href="../cleaning-up-space/">Cleaning Up Space on Development Machine</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/deployed-commit/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
