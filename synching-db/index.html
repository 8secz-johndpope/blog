<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Synching PouchdDB with remote DB | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="If we want to control our own data, we must know how to run our own database. To make this more attractive, let us pick a database that knows how to sync with our mobile or web application. Then we ca">
<meta name="keywords" content="db">
<meta property="og:type" content="article">
<meta property="og:title" content="Synching PouchdDB with remote DB">
<meta property="og:url" content="https://glebbahmutov.com/blog/synching-db/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="If we want to control our own data, we must know how to run our own database. To make this more attractive, let us pick a database that knows how to sync with our mobile or web application. Then we ca">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/pouch-couch-architecture.png">
<meta property="og:updated_time" content="2018-02-14T02:33:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Synching PouchdDB with remote DB">
<meta name="twitter:description" content="If we want to control our own data, we must know how to run our own database. To make this more attractive, let us pick a database that knows how to sync with our mobile or web application. Then we ca">
<meta name="twitter:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/pouch-couch-architecture.png">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!-- <div id="banner"></div> -->
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../index.html" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <!-- <span class="no-mobile">Software advice from</span> -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">
          <a id="subtitle" href="http://glebbahmutov.com">Gleb Bahmutov PhD</a>
        </span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-synching-db" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2016-09-16T04:00:00.000Z" itemprop="datePublished">Sep 16 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Synching PouchdDB with remote DB
    </h1>

    <h2 class="article-title" itemprop="name">
      How to run a database locally that syncs with central one.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If we want to control our own data, we must know how to run our own database.
To make this more attractive, let us pick a database that knows how to sync
with our mobile or web application. Then we can get an advanced feature -
offline data support almost without any extra work.</p>
<p>I will show how to run a Couch database locally and in a server (using Dokku),
and then how to write a simple web application using VueJS that works with
a local in-browser Pouch database. The Pouch database keeps the local browser
in sync with the remote Couch database.</p>
<p>A basic knowledge of Docker is required to follow this blog post.</p>
<h2><span id="running-local-couchdb">Running local CouchDB</span></h2><p>Let us try out CouchDB locally inside a Docker container using the
<a href="https://hub.docker.com/r/frodenas/couchdb/" target="_blank" rel="noopener">frodenas/couchdb</a> image.
To be able to easily replicate work, I saved the shell command into a file</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start the db inside a container</span></span><br><span class="line"><span class="comment"># with given username, password and DB name</span></span><br><span class="line">docker run -d \</span><br><span class="line">  --name couchdb \</span><br><span class="line">  -p 5984:5984 \</span><br><span class="line">  -e COUCHDB_USERNAME=iamuser \</span><br><span class="line">  -e COUCHDB_PASSWORD=mypass \</span><br><span class="line">  -e COUCHDB_DBNAME=c1 \</span><br><span class="line">  frodenas/couchdb</span><br></pre></td></tr></table></figure>
<p>This gave me a running DB named &quot;c1&quot; in about 15 seconds. Most of this time
was spent by the docker downloading the base image binaries.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ./setup-db.sh</span><br><span class="line">Unable to find image <span class="string">'frodenas/couchdb:latest'</span> locally</span><br><span class="line">latest: Pulling from frodenas/couchdb</span><br><span class="line">012a7829fd3f: Pull complete</span><br><span class="line">41158247dd50: Pull complete</span><br><span class="line">916b974d99af: Pull complete</span><br><span class="line">a3ed95caeb02: Pull complete</span><br><span class="line">5dc5d08f5c98: Pull complete</span><br><span class="line">1bee2d0b12c7: Pull complete</span><br><span class="line">745c9cfc6b90: Pull complete</span><br><span class="line">e7538cbaf2c8: Pull complete</span><br><span class="line">0e8f353191c0: Pull complete</span><br><span class="line">Digest: sha256:8b777ca1d60b7b5beab4178a8ebc412622ec43f2fec969dcf836bb11ac7ddad8</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> frodenas/couchdb:latest</span><br><span class="line">7dd6baed4d70c50929490bf24d83110b186f49ed5261b17f726d67466d30e642</span><br><span class="line">$ docker ps</span><br><span class="line">7dd6baed4d70  frodenas/couchdb 0.0.0.0:5984-&gt;5984/tcp   couchdb</span><br></pre></td></tr></table></figure>
<p>Right away you should be able to see empty database</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://localhost:5984/c1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"db_name"</span>:<span class="string">"c1"</span>,</span><br><span class="line">  <span class="string">"doc_count"</span>:0,</span><br><span class="line">  <span class="string">"doc_del_count"</span>:0,</span><br><span class="line">  <span class="string">"update_seq"</span>:0,</span><br><span class="line">  <span class="string">"purge_seq"</span>:0,</span><br><span class="line">  <span class="string">"compact_running"</span>:<span class="literal">false</span>,</span><br><span class="line">  <span class="string">"disk_size"</span>:79,</span><br><span class="line">  <span class="string">"data_size"</span>:0,</span><br><span class="line">  <span class="string">"instance_start_time"</span>:<span class="string">"1472301143096818"</span>,</span><br><span class="line">  <span class="string">"disk_format_version"</span>:6,</span><br><span class="line">  <span class="string">"committed_update_seq"</span>:0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let us connect to this database using the JavaScript
<a href="https://pouchdb.com/guides/databases.html" target="_blank" rel="noopener">PouchDB</a> library.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PouchDB = <span class="built_in">require</span>(<span class="string">'pouchdb'</span>)</span><br><span class="line"><span class="keyword">const</span> db = <span class="keyword">new</span> PouchDB(<span class="string">'http://localhost:5984/c1'</span>)</span><br><span class="line">db.info().then(<span class="built_in">console</span>.log).catch(<span class="built_in">console</span>.error)</span><br></pre></td></tr></table></figure>
<p>This gives us the same information as did the <code>curl</code> command.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ node index.js</span><br><span class="line">&#123; db_name: <span class="string">'c1'</span>,</span><br><span class="line">  doc_count: 0,</span><br><span class="line">  doc_del_count: 0,</span><br><span class="line">  update_seq: 0,</span><br><span class="line">  purge_seq: 0,</span><br><span class="line">  compact_running: <span class="literal">false</span>,</span><br><span class="line">  disk_size: 79,</span><br><span class="line">  data_size: 0,</span><br><span class="line">  instance_start_time: <span class="string">'1472301143096818'</span>,</span><br><span class="line">  disk_format_version: 6,</span><br><span class="line">  committed_update_seq: 0,</span><br><span class="line">  host: <span class="string">'http://localhost:5984/c1/'</span>,</span><br><span class="line">  auto_compaction: <span class="literal">false</span>,</span><br><span class="line">  adapter: <span class="string">'http'</span> &#125;</span><br></pre></td></tr></table></figure>
<p>Note: if the Docker is restarted, the new container with the CouchDB will
be stopped. You can simple run <code>docker restart 7dd6baed4d70</code> to get it
running again.</p>
<h2><span id="populating-data-from-command-line">Populating data from command line</span></h2><p>Since the database is empty, let us insert a couple of
<a href="https://github.com/bahmutov/fake-todos" target="_blank" rel="noopener">fake todos</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertFakeTodos</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> generate = <span class="built_in">require</span>(<span class="string">'fake-todos'</span>)</span><br><span class="line">  <span class="keyword">const</span> items = generate(n)</span><br><span class="line">  <span class="keyword">return</span> db.bulkDocs(items)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dbStats</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> db.info().then(<span class="built_in">console</span>.log)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">insertFakeTodos(<span class="number">3</span>)</span><br><span class="line">  .then(dbStats)</span><br><span class="line">  .catch(<span class="built_in">console</span>.error)</span><br></pre></td></tr></table></figure>
<p>We should get 3 documents in the database after running this code.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ node index.js</span><br><span class="line">&#123; db_name: <span class="string">'c1'</span>,</span><br><span class="line">  doc_count: 3,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can see them by running <code>db.allDocs()</code> method and printing the returned
<code>rows</code> list</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.allDocs(&#123;<span class="attr">include_docs</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">r</span> =&gt;</span> r.rows)</span><br><span class="line">  .then(<span class="built_in">console</span>.log)</span><br><span class="line">  .catch(<span class="built_in">console</span>.error)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ node index.js</span><br><span class="line">[ &#123; id: &apos;1161b310fc0d36dfe90091f25a000b9b&apos;,</span><br><span class="line">    key: &apos;1161b310fc0d36dfe90091f25a000b9b&apos;,</span><br><span class="line">    value: &#123; rev: &apos;1-545cf4fb862701be2211ac1d53133eba&apos; &#125;,</span><br><span class="line">    doc:</span><br><span class="line">     &#123; _id: &apos;1161b310fc0d36dfe90091f25a000b9b&apos;,</span><br><span class="line">       _rev: &apos;1-545cf4fb862701be2211ac1d53133eba&apos;,</span><br><span class="line">       what: &apos;fix chess&apos;,</span><br><span class="line">       due: &apos;tomorrow&apos;,</span><br><span class="line">       done: false,</span><br><span class="line">       id: &apos;24214f90-e4e6-4636-834d-d1a8dbaeb3a4&apos; &#125; &#125;,</span><br><span class="line">  &#123; id: &apos;1161b310fc0d36dfe90091f25a000fa8&apos;,</span><br><span class="line">    key: &apos;1161b310fc0d36dfe90091f25a000fa8&apos;,</span><br><span class="line">    value: &#123; rev: &apos;1-a5944cd8118a184598cc8f27736a82c1&apos; &#125;,</span><br><span class="line">    doc:</span><br><span class="line">     &#123; _id: &apos;1161b310fc0d36dfe90091f25a000fa8&apos;,</span><br><span class="line">       _rev: &apos;1-a5944cd8118a184598cc8f27736a82c1&apos;,</span><br><span class="line">       what: &apos;clean fishing rod&apos;,</span><br><span class="line">       due: &apos;tomorrow&apos;,</span><br><span class="line">       done: false,</span><br><span class="line">       id: &apos;8ad8a85a-69db-4984-8cbd-bf290776caa1&apos; &#125; &#125;,</span><br><span class="line">  &#123; id: &apos;1161b310fc0d36dfe90091f25a000ff8&apos;,</span><br><span class="line">    key: &apos;1161b310fc0d36dfe90091f25a000ff8&apos;,</span><br><span class="line">    value: &#123; rev: &apos;1-b9007b3ca9a79a2a938fe11162a7103d&apos; &#125;,</span><br><span class="line">    doc:</span><br><span class="line">     &#123; _id: &apos;1161b310fc0d36dfe90091f25a000ff8&apos;,</span><br><span class="line">       _rev: &apos;1-b9007b3ca9a79a2a938fe11162a7103d&apos;,</span><br><span class="line">       what: &apos;avoid learning distant relatives&apos;,</span><br><span class="line">       due: &apos;tomorrow&apos;,</span><br><span class="line">       done: false,</span><br><span class="line">       id: &apos;6b46a90d-852a-420d-a311-4f81f7da981e&apos; &#125; &#125; ]</span><br></pre></td></tr></table></figure>
<p>You can also see this data by fetching it from the CouchDB directly
using url <code>curl http://localhost:5984/c1/_all_docs?include_docs=true</code> or by
opening the url <code>http://localhost:5984/_utils/database.html?c1</code> in the browser.</p>
<p>PouchDB just uses the CouchDB as its data store.</p>
<h2><span id="running-pouchdb-in-the-browser">Running PouchDB in the browser</span></h2><h3><span id="cors-controlling-who-can-call-the-database">CORS: controlling who can call the database</span></h3><p>Note: this step is optional, as we are going to &quot;hide&quot; the database
behind a dedicated server later on.</p>
<p>Before we can access our CouchDB from the browser, we need to enable
<a href="https://pouchdb.com/errors.html#no_access_control_allow_origin_header" target="_blank" rel="noopener">cross domain requests</a>.
There is a tiny Node utility package to do this, which needs the user name
and the password we have used when we created the CouchDB.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -D add-cors-to-couchdb</span><br><span class="line">$ $(npm bin)/add-cors-to-couchdb http://localhost:5984 \</span><br><span class="line">  -u iamuser -p mypass</span><br><span class="line">success</span><br></pre></td></tr></table></figure>
<p>You can check the status of the CORS by going to the database web interface
at <code>http://localhost:5984/_utils/config.html</code>, the selecting &quot;login&quot;
and using the username and password from the database setup step. You should
see the following settings enabled</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cors</span><br><span class="line">credentials: true</span><br><span class="line">headers: accept, ...</span><br><span class="line">methods: GET, PUT, ...</span><br><span class="line">origins: *</span><br></pre></td></tr></table></figure>
<p>You can limit the domains by editing the &quot;origins&quot; value and specifying
a list of domains that can access the database directly.</p>
<h3><span id="using-the-couchdb-from-the-page">Using the CouchDB from the page</span></h3><p>Now let us create a page and fetch the documents just like we have done before.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>PouchDB Todos<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/pouchdb/5.4.5/pouchdb.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> db = <span class="keyword">new</span> PouchDB(<span class="string">'http://localhost:5984/c1'</span>)</span></span><br><span class="line"><span class="javascript">    db.allDocs(&#123;<span class="attr">include_docs</span>: <span class="literal">true</span>&#125;)</span></span><br><span class="line"><span class="javascript">      .then(<span class="function"><span class="params">r</span> =&gt;</span> r.rows)</span></span><br><span class="line"><span class="javascript">      .then(<span class="built_in">console</span>.log)</span></span><br><span class="line"><span class="javascript">      .catch(<span class="built_in">console</span>.error)</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>If you open this <code>index.html</code> in the browser you should see the 3 items
printed in the console. PouchDB works fine in the local Node environment, as
well as in the browser.</p>
<h2><span id="small-todo-web-application">Small Todo web application</span></h2><p>Let us make a tiny web application to show the fetched Todos and be able to
add new ones. I will use <a href="http://vuejs.org/" target="_blank" rel="noopener">Vue.js</a> for this, but I will
not implement the full example. If you want a full example, see
<a href="http://vuejs.org/examples/todomvc.html" target="_blank" rel="noopener">Vue examples page</a>.</p>
<p>All we will do is fetch the items from the PouchDB and then put them into
a table.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>PouchDB Todos<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/pouchdb/5.4.5/pouchdb.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/vue/1.0.26/vue.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>Task<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>Done?<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span><span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span> <span class="attr">v-for</span>=<span class="string">"todo in todos"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">v-text</span>=<span class="string">"todo.doc.what"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">v-text</span>=<span class="string">"todo.doc.done"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> vue = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">'#app'</span>,</span></span><br><span class="line"><span class="javascript">    db: <span class="literal">null</span>,</span></span><br><span class="line"><span class="undefined">    data: &#123;</span></span><br><span class="line"><span class="undefined">      todos: []</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.db = <span class="keyword">new</span> PouchDB(<span class="string">'http://localhost:5984/c1'</span>)</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.db.allDocs(&#123;<span class="attr">include_docs</span>: <span class="literal">true</span>&#125;)</span></span><br><span class="line"><span class="javascript">        .then(<span class="function"><span class="params">r</span> =&gt;</span> r.rows)</span></span><br><span class="line"><span class="javascript">        .then(<span class="function"><span class="params">list</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">this</span>.todos = list</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="javascript">        .catch(<span class="built_in">console</span>.error)</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>This gives us the list in the browser, but it is static - if there is
an update to the data in the database, then new items do not appear in the
web application; the user must reload the page to fetch the data again.</p>
<h2><span id="data-replication">Data replication</span></h2><p>Let us setup two way data replication - if the CouchDB gets new data,
we want to the data to propagate to the PouchDB in the browser, and vice versa.
The PouchDB has a good
<a href="https://pouchdb.com/guides/replication.html" target="_blank" rel="noopener">replication</a>
documentation page. In our case we want to keep the browser application in
sync with the CouchDB, and even handle the case when the browser loses
network connection (offline mode).</p>
<p>Instead of working directly with the remove CouchDB we will work against
a local replica</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.db = <span class="keyword">new</span> PouchDB(<span class="string">'tododb'</span>)</span><br><span class="line"><span class="keyword">var</span> remoteDB = <span class="keyword">new</span> PouchDB(<span class="string">'http://localhost:5984/c1'</span>)</span><br><span class="line"><span class="keyword">this</span>.db.sync(remoteDB, &#123;</span><br><span class="line">  live: <span class="literal">true</span>,</span><br><span class="line">  retry: <span class="literal">true</span></span><br><span class="line">&#125;).on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">change</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'data change'</span>, change)</span><br><span class="line">&#125;).on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sync error'</span>, err)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The web application works as before, but now we can stop the CouchDB
Docker container but continue working like before in the browser.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker stop 7dd6baed4d70</span><br><span class="line">7dd6baed4d70</span><br></pre></td></tr></table></figure>
<p>The data still loads in the page, but shows the failed network sync requests
if we have XHR logging enabled in the DevTools</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pouchdb.min.js:9 GET http://localhost:5984/c1/ net::ERR_CONNECTION_REFUSED</span><br></pre></td></tr></table></figure>
<p>If we start the container, the errors stop.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker restart 7dd6baed4d70</span><br></pre></td></tr></table></figure>
<p>What happens if we create new data items in the CouchDB database?
Let us use our Node program to add 3 more Todo items and observe the
PouchDB event callbacks in the browser. The browser console shows
3 new events</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data change <span class="built_in">Object</span> &#123;<span class="attr">direction</span>: <span class="string">"pull"</span>, <span class="attr">change</span>: <span class="built_in">Object</span>&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>change</code> property includes the actual new data object. While we could
use the <code>change</code> directly to update the <code>vue.data.todos</code> list, we might
as well just refetch the data, since this is now a <em>local</em> browser data
fetch! Here is the relevant web application code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vue = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  ...</span><br><span class="line">  methods: &#123;</span><br><span class="line">    fetch() &#123;</span><br><span class="line">      <span class="keyword">this</span>.db.allDocs(&#123;<span class="attr">include_docs</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">        .then(<span class="function"><span class="params">r</span> =&gt;</span> r.rows)</span><br><span class="line">        .then(<span class="function"><span class="params">list</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.todos = list</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'fetched %d todos'</span>, list.length)</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="built_in">console</span>.error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="keyword">this</span>.db = <span class="keyword">new</span> PouchDB(<span class="string">'tododb'</span>)</span><br><span class="line">    <span class="keyword">var</span> remoteDB = <span class="keyword">new</span> PouchDB(<span class="string">'http://localhost:5984/c1'</span>)</span><br><span class="line">    <span class="keyword">this</span>.db.sync(remoteDB, &#123;</span><br><span class="line">      live: <span class="literal">true</span>,</span><br><span class="line">      retry: <span class="literal">true</span></span><br><span class="line">    &#125;).on(<span class="string">'change'</span>, change =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'data change'</span>, change)</span><br><span class="line">      <span class="keyword">this</span>.fetch()</span><br><span class="line">    &#125;).on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'sync error'</span>, err)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.fetch() <span class="comment">// fetch initial</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Here is the fetch in action; as the new items are inserted into the
CouchDB, the browser PouchDB gets the updates and refreshes the list.</p>
<video src="https://raw.githubusercontent.com/bahmutov/bahmutov.github.io/master/images/pouchdb-sync.webm" controls loop autoplay></video>

<h2><span id="run-couchdb-in-the-cloud">Run CouchDB in the cloud</span></h2><p>I am a big fan of <a href="http://dokku.viewdocs.io/dokku/" target="_blank" rel="noopener">Dokku</a> and will use it
to run CouchDB on a personal <a href="https://www.digitalocean.com/" target="_blank" rel="noopener">DigitalOcean</a>
droplet. I have already described how to
<a href="../running-multiple-applications-in-dokku/">setup a Dokku instance</a>,
so I will skip the general introduction.</p>
<p>I will install the <a href="https://github.com/dokku/dokku-couchdb" target="_blank" rel="noopener">CouchDB plugin</a>
from the list of Dokku <a href="http://dokku.viewdocs.io/dokku/community/plugins/" target="_blank" rel="noopener">Community plugins</a>.
Since I do not have an application (CouchDB has built-in web server),
I will just create the service and will expose it to the web.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo dokku plugin:install https://github.com/dokku/dokku-couchdb.git couchdb</span><br><span class="line">dokku couchdb:create c1</span><br><span class="line">dokku couchdb:expose c1 6690</span><br></pre></td></tr></table></figure>
<p>The CouchDB is now running available at the direct IP address <code>&lt;ip4.com&gt;:6690</code>
which is not the best practice of course, but would work for now. Let us
insert 3 todo records - just change the database url in the <code>index.js</code>.
We can even use the domain name instead of IP4 address.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="keyword">new</span> PouchDB(<span class="string">'http://&lt;domain.com&gt;:6690/c1'</span>)</span><br></pre></td></tr></table></figure>
<p>We can see the items using the CouchDB built-in web browser, just open
in the browser url <code>http://&lt;domain.com&gt;:6690/_utils/database.html?c1</code></p>
<h3><span id="limit-direct-access-via-cors">Limit direct access via CORS</span></h3><p>Note: again, you can safely skip this step as we are going to proxy calls
to the database through a server.</p>
<p>We need to enable our browser client to call the CouchDB interface across
the domain boundary. Login into the Dokku host and lookup the CouchDB password.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dokku couchdb:info c1</span><br><span class="line">DSN: http://c1:&lt;password&gt;@dokku-couchdb-c1:5984/c1</span><br><span class="line">Config dir: /var/lib/dokku/services/couchdb/c1/config</span><br><span class="line">Data dir: /var/lib/dokku/services/couchdb/c1/data</span><br></pre></td></tr></table></figure>
<p>The <code>DSN</code> field has the long random password generated for us when we created
a CouchDB service instance. The username is the database name &quot;c1&quot;.</p>
<p>Now go back to the CouchDB web configuration interface and change
the &quot;cors|credentials&quot; value to &quot;true&quot;. The at the bottom click &quot;Add a new
section&quot; and add the following sections one by one (copy from local config
created by <code>add-cors-to-couchdb</code> utility).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">section | option    | value</span><br><span class="line">-------------------------------</span><br><span class="line">cors    | headers   | accept, authorization, content-type, origin, referer, x-csrf-token</span><br><span class="line">cors    | methods   | GET, PUT, POST, HEAD, DELETE</span><br><span class="line">cors    | origins   | *</span><br></pre></td></tr></table></figure>
<p>If you are running the PouchDB only from a certain domain, you should enter
a specific value instead of a wild card. Finally, change &#39;httpd&#39; section
value &#39;enable_cors&#39; to &quot;true&quot;.</p>
<p>The PouchDB running locally now should sync with the CouchDB running in the
cloud!</p>
<h2><span id="restricting-database-access">Restricting database access</span></h2><p>Exposing the database to the whole world is less than optimal. Plus we need
to serve the web page somehow. We can solve both problems by writing a tiny
static HTML page server + proxy to redirect the database requests.
Here is a server code that is using Express framework.
The server redirects any request to <code>/db/</code> to a local CouchDB running at the
standard port 5984.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>)</span><br><span class="line"><span class="comment">// assuming CouchDB is running locally</span></span><br><span class="line"><span class="keyword">const</span> dbUrl = <span class="string">'http://127.0.0.1:5984'</span></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(express.static(<span class="string">'public'</span>))</span><br><span class="line">app.all(<span class="string">'/db/*'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> fullUrl = dbUrl + req.url.replace(<span class="regexp">/^\/db/</span>, <span class="string">''</span>) <span class="comment">// strip leading "/db"</span></span><br><span class="line">  req.pipe(request(fullUrl)).pipe(res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">4600</span></span><br><span class="line">app.listen(port)</span><br></pre></td></tr></table></figure>
<p>The <code>index.html</code> page can be moved into folder <code>/public</code> and just go back
to the server to get the data</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started'</span>)</span><br><span class="line"><span class="keyword">this</span>.db = <span class="keyword">new</span> PouchDB(<span class="string">'tododb'</span>)</span><br><span class="line"><span class="keyword">var</span> remoteDB = <span class="keyword">new</span> PouchDB(<span class="built_in">window</span>.location.origin + <span class="string">'/db/c1'</span>)</span><br></pre></td></tr></table></figure>
<p>The application is working locally, let us deploy it.</p>
<h2><span id="deploying-server-with-hidden-database">Deploying server with hidden database</span></h2><p>Log into your Dokku box and create new application</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dokku apps create pouch-couch</span><br><span class="line">Creating pouch-couch... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>Stop exposing Couch database directly to the outside world. Instead link
it to the new <code>pouch-couch</code> app.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dokku couchdb:unexpose c1</span><br><span class="line">-----&gt; Service c1 unexposed</span><br><span class="line">$ dokku couchdb:link c1 pouch-couch</span><br><span class="line">COUCHDB_URL: http://c1:&lt;long sha&gt;@dokku-couchdb-c1:5984/c1</span><br></pre></td></tr></table></figure>
<p>The command shows long unique URL string we should be using to access the
Couch database from our proxy application. We should use this variable
name in the <code>server.js</code> if available.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dbUrl = process.env.COUCHDB_URL || <span class="string">'http://127.0.0.1:5984/c1'</span></span><br></pre></td></tr></table></figure>
<p>Add simple &quot;Procfile&quot; to the repo to let the hosting environment know we
need a web process</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="string">"web: npm start"</span> &gt; Procfile</span><br><span class="line">git add Procfile</span><br><span class="line">git commit -m <span class="string">"add proc file"</span></span><br></pre></td></tr></table></figure>
<p>Deploy the application to the Dokku server by pushing it as a Git remote</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git remote add dokku dokku@&lt;domain name&gt;.com:pouch-couch</span><br><span class="line">$ git push dokku master</span><br><span class="line">...</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       http://pouch-couch.&lt;domain name&gt;.com</span><br><span class="line">To dokku@&lt;domain name&gt;.com:pouch-couch</span><br><span class="line">   011273a..f1673ad  master -&gt; master</span><br></pre></td></tr></table></figure>
<p>If we browse to <code>http://pouch-couch.&lt;domain name&gt;.com</code> we will see an empty
HTML page (there are no tasks yet), and if we browser to
<code>http://pouch-couch.&lt;domain name&gt;.com/db/</code> we can see the CouchDB database
system information.</p>
<p>We should quickly protect the application from any interception
by <a href="running-multiple-applications-in-dokku/#setting-up-ssl-for-an-application">installing SSL</a>.
We can also protect the requests to the database in the server code if we
wanted to.</p>
<h2><span id="result">Result</span></h2><p>We got an isolated database only accessed via the Node server. The database
and the server are running in two connected Docker containers on a single
DigitalOcean &quot;droplet&quot; server.
The web client (or multiple ones) works with local database in the browser,
and the PouchDB syncs the data automatically.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/talks/master/images/pouch-couch-architecture.png" alt="pouch-couch architecture"></p>
<p>Multiple clients can connect to the same url at the same time and have
the data stay in sync, even when going offline and reconnecting. The PouchDB
synchronization does the heavy lifting, while the web app only works with the
local data source.</p>
<iframe width="853" height="480" src="https://www.youtube.com/embed/u3lXMJzEpyo?rel=0" frameborder="0" allowfullscreen>
</iframe>

<h2><span id="additional-information">Additional information</span></h2><ul>
<li><a href="https://gist.github.com/bahmutov/1003fa86980dda147ff6" target="_blank" rel="noopener">Docker basics</a>
and why I am <a href="../think-inside-the-box/">so excited about Docker</a></li>
<li><a href="http://dokku.viewdocs.io/dokku/" target="_blank" rel="noopener">Dokku docs</a></li>
<li><a href="https://couchdb.apache.org/" target="_blank" rel="noopener">CouchDB</a></li>
<li><a href="https://pouchdb.com/" target="_blank" rel="noopener">PouchDB</a></li>
<li>To avoid losing data on the remote server when the database Docker container
is restarted / updated, you should keep the data on a mounted volume
connected to the docker container, not inside the container itself.</li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  var s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/synching-db/" data-id="cjf5fgc2200uczloooprtfgbk" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/synching-db/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/db/">db</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../subresource-integrity/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Subresource integrity (SRI)
        
      </div>
    </a>
  
  
    <a href="../think-inside-the-box/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Think inside the box</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">102</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">278</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">98</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">67</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">160</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">71</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">71</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.82px;">QUnit</a> <a href="../tags/advice/" style="font-size: 19.55px;">advice</a> <a href="../tags/angularjs/" style="font-size: 18.18px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.64px;">assertions</a> <a href="../tags/ast/" style="font-size: 13.18px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.91px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.82px;">browser</a> <a href="../tags/ci/" style="font-size: 12.73px;">ci</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.73px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 14.09px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.91px;">d3</a> <a href="../tags/db/" style="font-size: 14.09px;">db</a> <a href="../tags/docker/" style="font-size: 13.64px;">docker</a> <a href="../tags/es6/" style="font-size: 15.45px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.64px;">functional</a> <a href="../tags/generators/" style="font-size: 11.82px;">generators</a> <a href="../tags/git/" style="font-size: 14.55px;">git</a> <a href="../tags/grunt/" style="font-size: 12.73px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.91px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 11.82px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.36px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.91px;">interview</a> <a href="../tags/jade/" style="font-size: 11.36px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.91px;">jshint</a> <a href="../tags/modular-development/" style="font-size: 17.27px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 19.09px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.36px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.36px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.73px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.45px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/reactive/" style="font-size: 15px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 10.45px;">reactjs</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.73px;">security</a> <a href="../tags/sentry/" style="font-size: 14.09px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.27px;">service workers</a> <a href="../tags/testing/" style="font-size: 19.09px;">testing</a> <a href="../tags/tutorial/" style="font-size: 13.18px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 10.45px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.45px;">ui</a> <a href="../tags/vuejs/" style="font-size: 10.91px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.27px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../how-i-organize-readme/">How I Organize README</a>
          </li>
        
          <li>
            <a href="../renovate-app/">Painless Dependency Upgrades with Renovate App</a>
          </li>
        
          <li>
            <a href="../debugging-mocha-using-inspector/">Debugging Mocha from Node using Chrome Inspector</a>
          </li>
        
          <li>
            <a href="../subfolders-as-dependencies/">Subfolders as Dependencies</a>
          </li>
        
          <li>
            <a href="../parcel/">Parcel Bundler</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/synching-db/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
