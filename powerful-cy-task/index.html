<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Incredibly Powerful cy.task | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="There is a new super powerful command in Cypress v3 - and that is cy.task. This command allows your tests to &amp;quot;jump&amp;quot; from the browser context to Node and run any code before returning (asynch">
<meta name="keywords" content="cypress">
<meta property="og:type" content="article">
<meta property="og:title" content="Incredibly Powerful cy.task">
<meta property="og:url" content="https://glebbahmutov.com/blog/powerful-cy-task/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="There is a new super powerful command in Cypress v3 - and that is cy.task. This command allows your tests to &amp;quot;jump&amp;quot; from the browser context to Node and run any code before returning (asynch">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/confirm-new-item-via-ui.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/finds-record.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/retry-ui.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/find-fails.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/task-retries.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/spinner-pass.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/spinner-fail.gif">
<meta property="og:updated_time" content="2018-06-27T14:47:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Incredibly Powerful cy.task">
<meta name="twitter:description" content="There is a new super powerful command in Cypress v3 - and that is cy.task. This command allows your tests to &amp;quot;jump&amp;quot; from the browser context to Node and run any code before returning (asynch">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/powerful-cy-task/confirm-new-item-via-ui.gif">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!-- <div id="banner"></div> -->
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../index.html" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <!-- <span class="no-mobile">Software advice from</span> -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">
          <a id="subtitle" href="http://glebbahmutov.com">Gleb Bahmutov PhD</a>
        </span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-powerful-cy-task" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2018-06-27T04:00:00.000Z" itemprop="datePublished">Jun 27 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Incredibly Powerful cy.task
    </h1>

    <h2 class="article-title" itemprop="name">
      How to run any Node code from your end-to-end Cypress tests using `cy.task` command.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>There is a new super powerful command in <a href="https://docs.cypress.io/guides/references/changelog.html#3-0-0" target="_blank" rel="noopener">Cypress v3</a> - and that is <a href="https://on.cypress.io/task" target="_blank" rel="noopener"><code>cy.task</code></a>. This command allows your tests to &quot;jump&quot; from the browser context to Node and run <em>any code</em> before returning (asynchronously) the result back to the test. Let me show how to use this command for &quot;deeper&quot; server-side validation.</p>
<p>Let me take a TodoMVC application as an example. This is the same web application I have tested <em>a lot</em> in <a href="https://www.cypress.io/blog/2017/11/28/testing-vue-web-application-with-vuex-data-store-and-rest-backend/" target="_blank" rel="noopener">Testing Vue web applications with Vuex data store &amp; REST backend</a> blog post. You can find all code from this blog post in <a href="https://github.com/bahmutov/cypress-task-demo" target="_blank" rel="noopener">bahmutov/cypress-task-demo</a> repository.</p>
<p>The TodoMVC application sends each new todo item entered by the user to the backend server (via XHR calls). The backend is <a href="https://github.com/typicode/json-server" target="_blank" rel="noopener">json-server</a> that saves the data as a plain JSON file called <code>data.json</code>. Good. So how can we assert that all parts of the system are working as expected?</p>
<h2><span id="testing-the-ui">Testing the UI</span></h2><p>The most obvious thing that everyone writing end-to-end tests should do is to only exercise the application via its user interface. For example, we can add a new todo item, and then confirm that the text of the item appears in the list below.</p>
<figure class="highlight js"><figcaption><span>ui.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; enterTodo, resetDatabase &#125; <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'UI'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(resetDatabase)</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'adds todo'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// random text to avoid confusion</span></span><br><span class="line">    <span class="keyword">const</span> id = Cypress._.random(<span class="number">1</span>, <span class="number">1e6</span>)</span><br><span class="line">    <span class="keyword">const</span> title = <span class="string">`todo <span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">    enterTodo(title)</span><br><span class="line">    <span class="comment">// confirm the new item has been added to the list</span></span><br><span class="line">    cy.contains(<span class="string">'.todoapp li'</span>, title)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Here is this test in action; I am hovering over &quot;CONTAINS&quot; command and Cypress highlights the new item in the DOM snapshots at that moment in test.</p>
<p><img src="/blog/images/powerful-cy-task/confirm-new-item-via-ui.gif" alt="Confirms new item has been added via UI"></p>
<p>The new item appears in the list, but was it <em>really</em> sent to the server? We could write another test to spy on the XHR call to observe the new item being sent to the server. But was the item <em>really</em> saved? Hmm, we are going deeper in the implementation details here. Why not avoid testing the <em>implementation</em> of the application and the server and instead test the <em>external</em> state - in this case the file &quot;database&quot; where the server saves data?</p>
<h2><span id="testing-the-database">Testing the database</span></h2><p>So every time the user enters new Todo item, it should be saved in the file &quot;data.json&quot; like this</p>
<figure class="highlight json"><figcaption><span>data.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"todos"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"title"</span>: <span class="string">"todo 423665"</span>,</span><br><span class="line">      <span class="attr">"completed"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"9197021112"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can write a test that adds an item via UI, but then checks the database to make sure the new record has been added. There is <a href="https://on.cypress.io/readfile" target="_blank" rel="noopener"><code>cy.readFile</code></a> that can read file contents, but it is not powerful enough:</p>
<ul>
<li><code>cy.readFile</code> fails the test if the file does not exist</li>
<li>we want to write general code that can actually query any database, not just read a file.</li>
</ul>
<p>The new command <a href="https://on.cypress.io/task" target="_blank" rel="noopener"><code>cy.task</code></a> allows us to do <em>anything</em>. This is an &quot;escape&quot; hatch - a way for the end-to-end test running in the browser to run code in Node environment.</p>
<p>So let&#39;s write a new task - and all it has to do is to find the new text in the database. We will write this code inside <code>cypress/plugins/index.js</code> file - that is the place for all Node code inside Cypress tests.</p>
<figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> repoRoot = path.join(__dirname, <span class="string">'..'</span>, <span class="string">'..'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> findRecord = <span class="function"><span class="params">title</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> dbFilename = path.join(repoRoot, <span class="string">'data.json'</span>)</span><br><span class="line">  <span class="keyword">const</span> contents = <span class="built_in">JSON</span>.parse(fs.readFileSync(dbFilename, <span class="string">'utf8'</span>))</span><br><span class="line">  <span class="keyword">const</span> todos = contents.todos</span><br><span class="line">  <span class="keyword">return</span> todos.find(<span class="function"><span class="params">record</span> =&gt;</span> record.title === title)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// "cy.task" can be used from specs to "jump" into Node environment</span></span><br><span class="line">  <span class="comment">// and doing anything you might want. For example, checking "data.json" file!</span></span><br><span class="line">  on(<span class="string">'task'</span>, &#123;</span><br><span class="line">    hasSavedRecord (title) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'looking for title "%s" in the database'</span>, title)</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Boolean</span>(findRecord(title))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can &quot;call&quot; <code>cy.task</code> passing arguments (which should be serializable).</p>
<figure class="highlight js"><figcaption><span>spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; enterTodo, resetDatabase &#125; <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'cy.task'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(resetDatabase)</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'finds record in the database'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// random text to avoid confusion</span></span><br><span class="line">    <span class="keyword">const</span> id = Cypress._.random(<span class="number">1</span>, <span class="number">1e6</span>)</span><br><span class="line">    <span class="keyword">const</span> title = <span class="string">`todo <span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">    enterTodo(title)</span><br><span class="line">    <span class="comment">// confirm the new item has been saved</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/task</span></span><br><span class="line">    cy.task(<span class="string">'hasSavedRecord'</span>, title).should(<span class="string">'equal'</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Our test is passing!</p>
<p><img src="/blog/images/powerful-cy-task/finds-record.png" alt="`cy.task` finds saved record"></p>
<p>The terminal where I started Cypress test runner shows the console log from the <code>cy.task</code> command, which happens <em>after</em> posting the item</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /todos 201 8.135 ms - -</span><br><span class="line">looking for title &quot;todo 166155&quot; in the database</span><br></pre></td></tr></table></figure>
<p>Everything is great!</p>
<p>Or is it?</p>
<h2><span id="if-at-first-you-don39t-succeed">If at first you don&#39;t succeed ...</span></h2><p>&quot;Dust yourself off and try again&quot;, right?</p>
<p>We have a problem - we really assume that the item is saved before we check for it. But in the real world things are delayed, items are buffered before being sent or saved, etc. That is why Cypress is <a href="https://on.cypress.io/should" target="_blank" rel="noopener">retrying all its commands</a> - because nothing happens instantly!</p>
<p>To simulate the problem, let me change the TodoMVC application and add a 2 second delay when adding an item.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addTodo event listener</span></span><br><span class="line">addTodo (e) &#123;</span><br><span class="line">  e.target.value = <span class="string">''</span></span><br><span class="line">  <span class="comment">// delay by 2 seconds on purpose</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.$store.dispatch(<span class="string">'addTodo'</span>)</span><br><span class="line">    <span class="keyword">this</span>.$store.dispatch(<span class="string">'clearNewTodo'</span>)</span><br><span class="line">  &#125;, <span class="number">2000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you rerun the <code>ui.js</code> test file, the test still passes - the <code>cy.contains</code> just waits for 2 seconds; it keeps observing the DOM and passes as soon as the new item text is found in the list.</p>
<p><img src="/blog/images/powerful-cy-task/retry-ui.gif" alt="UI assertion keeps checking the DOM until the text is found"></p>
<p>But if you run <code>spec.js</code> the assertion <code>cy.task(&#39;hasSavedRecord&#39;, title).should(&#39;equal&#39;, true)</code> fails!</p>
<p><img src="/blog/images/powerful-cy-task/find-fails.png" alt="`cy.task` fails to find the record"></p>
<p>Notice in the screenshot that the failed assertion is placed <em>before</em> the POST XHR request from the web application to the server. This gives us a clue that we checked the database too early.</p>
<p>The <code>cy.task</code> command <strong>does not</strong> retry. Because Cypress has no idea what your task is going to do - it probably is NOT idempotent action. For example <code>cy.get</code> is idempotent command; it does not change the state of the application, unlike <code>cy.type</code> or <code>cy.click</code> that do. Just like Cypress cannot automatically retry <code>cy.click</code> Cypress cannot retry <code>cy.task</code> command.</p>
<p>But we can!</p>
<p>Let us wrap the code that is checking the database file with a loop. We are going to keep checking the file until we find the record or hit the time limit. Instead of returning a boolean value, we are going to return a promise, and <code>cy.task</code> will automatically wait for the promise. Here is the <code>plugins/index.js</code> code that just keeps chaining promises, checking the file every 50 milliseconds.</p>
<figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> findRecord = <span class="function"><span class="params">title</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> dbFilename = path.join(repoRoot, <span class="string">'data.json'</span>)</span><br><span class="line">  <span class="keyword">const</span> contents = <span class="built_in">JSON</span>.parse(fs.readFileSync(dbFilename, <span class="string">'utf8'</span>))</span><br><span class="line">  <span class="keyword">const</span> todos = contents.todos</span><br><span class="line">  <span class="keyword">return</span> todos.find(<span class="function"><span class="params">record</span> =&gt;</span> record.title === title)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasRecordAsync = <span class="function">(<span class="params">title, ms</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> delay = <span class="number">50</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ms &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Could not find record with title "<span class="subst">$&#123;title&#125;</span>"`</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> found = findRecord(title)</span><br><span class="line">    <span class="keyword">if</span> (found) &#123;</span><br><span class="line">      <span class="keyword">return</span> resolve(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      hasRecordAsync(title, ms - delay).then(resolve, reject)</span><br><span class="line">    &#125;, <span class="number">50</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// "cy.task" can be used from specs to "jump" into Node environment</span></span><br><span class="line">  <span class="comment">// and doing anything you might want. For example, checking "data.json" file!</span></span><br><span class="line">  on(<span class="string">'task'</span>, &#123;</span><br><span class="line">    hasSavedRecord (title, ms = <span class="number">3000</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">'looking for title "%s" in the database (time limit %dms)'</span>,</span><br><span class="line">        title,</span><br><span class="line">        ms</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> hasRecordAsync(title, ms)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Our test now passes - beautiful!</p>
<p><img src="/blog/images/powerful-cy-task/task-retries.gif" alt="Task retries until passes"></p>
<p>Notice that the assertion <code>task(...).should(&#39;equal&#39;, true)</code> passes AFTER the web application sends XHR to the server.</p>
<h2><span id="making-it-beautiful">Making it beautiful</span></h2><p>User should know when the application is busy doing something, and the user should be notified when an action either succeeded or failed. Cypress command timeline shows a blue spinner while an action is being retried, and it uses icons and colors to show test commands that passed and failed. Our Node code should do the same thing for the tasks. Luckily this can be added using a nice spinner library <a href="https://github.com/sindresorhus/ora#readme" target="_blank" rel="noopener">ora</a>.</p>
<p>I will change my <code>plugins</code> code to wrap custom promise-returning code with Bluebird promise that will control a CLI spinner.</p>
<figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ora = <span class="built_in">require</span>(<span class="string">'ora'</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>)</span><br><span class="line"><span class="comment">// rest of the code is the same</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// "cy.task" can be used from specs to "jump" into Node environment</span></span><br><span class="line">  <span class="comment">// and doing anything you might want. For example, checking "data.json" file!</span></span><br><span class="line">  on(<span class="string">'task'</span>, &#123;</span><br><span class="line">    hasSavedRecord (title, ms = <span class="number">3000</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> spinner = ora(</span><br><span class="line">        <span class="string">`looking for title "<span class="subst">$&#123;title&#125;</span>" in the database`</span></span><br><span class="line">      ).start()</span><br><span class="line">      <span class="keyword">return</span> hasRecordAsync(title, ms)</span><br><span class="line">        .tap(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          spinner.succeed(<span class="string">`found "<span class="subst">$&#123;title&#125;</span>" in the database`</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .tapCatch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          spinner.fail(err.message)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here is the result - the spinner working in the terminal, showing a message on success.</p>
<p><img src="/blog/images/powerful-cy-task/spinner-pass.gif" alt="Task spinner passes"></p>
<p>Here is the spinner when the task fails.</p>
<p><img src="/blog/images/powerful-cy-task/spinner-fail.gif" alt="Task spinner fails"></p>
<h2><span id="final-thoughts">Final thoughts</span></h2><p>When writing Cypress tests automatic retries are sooo convenient - you just don&#39;t have to think at all when <em>exactly</em> the things inside your application happen. You don&#39;t have to put <code>wait(5000)</code> in order to predict delays, yet the tests keep flying because they never have to wait longer than necessary. <code>cy.task</code> gives us a tremendous power to run any Node code, but we have to wrap it with retries ourself. Luckily it is simple to do so.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/powerful-cy-task/" data-id="cjr4c52ol00nk6xoochjwkoqa" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/powerful-cy-task/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/cypress/">cypress</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../gatsby-netlify-circle-and-cypress/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Gatsby Netlify Circle and Cypress
        
      </div>
    </a>
  
  
    <a href="../rolling-for-test/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Rolling for a Test</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">107</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">300</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">100</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">68</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/">github</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/">graphql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">160</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">75</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">82</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/zeit/">zeit</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.74px;">QUnit</a> <a href="../tags/advice/" style="font-size: 19.57px;">advice</a> <a href="../tags/angularjs/" style="font-size: 17.83px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.48px;">assertions</a> <a href="../tags/ast/" style="font-size: 13.04px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.65px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.52px;">browser</a> <a href="../tags/ci/" style="font-size: 13.04px;">ci</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.61px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 16.96px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.87px;">d3</a> <a href="../tags/db/" style="font-size: 14.35px;">db</a> <a href="../tags/docker/" style="font-size: 13.91px;">docker</a> <a href="../tags/es6/" style="font-size: 15.22px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.26px;">functional</a> <a href="../tags/generators/" style="font-size: 11.74px;">generators</a> <a href="../tags/git/" style="font-size: 14.78px;">git</a> <a href="../tags/github/" style="font-size: 10.43px;">github</a> <a href="../tags/graphql/" style="font-size: 10.87px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.61px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.87px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 12.61px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.74px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.87px;">interview</a> <a href="../tags/jade/" style="font-size: 11.3px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.87px;">jshint</a> <a href="../tags/modular-development/" style="font-size: 16.96px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 18.7px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.09px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.3px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.39px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.43px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/reactive/" style="font-size: 14.78px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 10.87px;">reactjs</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.61px;">security</a> <a href="../tags/sentry/" style="font-size: 13.91px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.17px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.13px;">testing</a> <a href="../tags/tutorial/" style="font-size: 13.91px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 10.87px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.43px;">ui</a> <a href="../tags/vuejs/" style="font-size: 11.3px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.17px;">web workers</a> <a href="../tags/zeit/" style="font-size: 10px;">zeit</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../use-typescript-with-cypress/">Use TypeScript With Cypress</a>
          </li>
        
          <li>
            <a href="../cypress-is/">Cypress is just ...</a>
          </li>
        
          <li>
            <a href="../dont-help-me-say-no/">Don&#39;t help me say No</a>
          </li>
        
          <li>
            <a href="../cypress-should-callback/">Cypress should callback</a>
          </li>
        
          <li>
            <a href="../do-not-use-node-env-for-staging/">Do not use NODE_ENV for staging</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/powerful-cy-task/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
