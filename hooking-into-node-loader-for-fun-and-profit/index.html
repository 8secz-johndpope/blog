<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hooking into Node loader for fun and profit | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="When you call require(&amp;quot;filename&amp;quot;) in Node, the system resolves filename to full path (for example /user/me/filename.js), reads source from disk and evaluates the loaded JavaScript. Turns out">
<meta name="keywords" content="javascript,nodejs,ast">
<meta property="og:type" content="article">
<meta property="og:title" content="Hooking into Node loader for fun and profit">
<meta property="og:url" content="https://glebbahmutov.com/blog/hooking-into-node-loader-for-fun-and-profit/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="When you call require(&amp;quot;filename&amp;quot;) in Node, the system resolves filename to full path (for example /user/me/filename.js), reads source from disk and evaluates the loaded JavaScript. Turns out">
<meta property="og:updated_time" content="2018-02-14T02:33:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hooking into Node loader for fun and profit">
<meta name="twitter:description" content="When you call require(&amp;quot;filename&amp;quot;) in Node, the system resolves filename to full path (for example /user/me/filename.js), reads source from disk and evaluates the loaded JavaScript. Turns out">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!-- <div id="banner"></div> -->
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../index.html" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="../index.html" id="subtitle">Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <!-- <span class="no-mobile">Software advice from</span> -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">
          <a id="subtitle" href="http://glebbahmutov.com">Gleb Bahmutov PhD</a>
        </span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-hooking-into-node-loader-for-fun-and-profit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2014-01-12T05:00:00.000Z" itemprop="datePublished">Jan 12 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hooking into Node loader for fun and profit
    </h1>

    <h2 class="article-title" itemprop="name">
      Log loaded files, add code coverage and extra features on the fly.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>When you call <code>require(&quot;filename&quot;)</code> in Node, the system
resolves <code>filename</code> to full path (for example <em>/user/me/filename.js</em>),
reads source from disk and evaluates the loaded JavaScript.
Turns out, you can substitute your own logic instead of reading and
evaluating using the defaults. For example you can hook into
loading of <em>.js</em> files and strip all <code>console.log</code> calls!
I have written <a href="https://github.com/bahmutov/node-hook" target="_blank" rel="noopener">node-hook</a> that
hides the mechanics and just needs your own transform function.
I will show several useful ways the loaded source code can be
transformed.</p>
<p><strong>note:</strong> Nodejs caches the evaluated JavaScript. If you need
to transform code, make sure to install the hook first, before
any other files are loaded using <code>require</code> call. I recommend
putting all hook installations as the very first lines
in the package&#39;s main file.</p>
<h2><span id="logging-files-loaded-and-evaluated">Logging files loaded and evaluated</span></h2><p>The simplest transformation: lets prepend each loaded source file
with <code>console.log</code> call that would print the file name.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hook = <span class="built_in">require</span>(<span class="string">'node-hook'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logLoadedFilename</span>(<span class="params">source, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'console.log("'</span> + filename + <span class="string">'");\n'</span> + source;</span><br><span class="line">&#125;</span><br><span class="line">hook.hook(<span class="string">'.js'</span>, logLoadedFilename);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./dummy'</span>);</span><br><span class="line"><span class="comment">// prints fulle dummy.js filename, runs dummy.js</span></span><br></pre></td></tr></table></figure>
<p>The custom transform function <code>logLoadedFilename</code> gets two arguments,
the loaded original source and full filename. It should return
the transformed JavaScript code text. If nothing is returned, the
hook will print error message, but will continue (without evaluating
the original source!).</p>
<h2><span id="mix-and-match-different-languages">Mix and match different languages</span></h2><p>Any language that can be compiled to JavaScript could be loaded
directly from Node. For example, we could install a hook to automatically
transpile CoffeeScript files to JavaScript</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hook = <span class="built_in">require</span>(<span class="string">'node-hook'</span>);</span><br><span class="line"><span class="keyword">var</span> coffee = <span class="built_in">require</span>(<span class="string">'coffee-script'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">coffeeToJs</span>(<span class="params">source, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> coffee.compile(source, &#123;</span><br><span class="line">        filename: filename</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">hook.hook(<span class="string">'.coffee'</span>, coffeeToJs);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./dummy.coffee'</span>);</span><br></pre></td></tr></table></figure>
<p><strong>note:</strong> you don&#39;t need to actually use <em>node-hook</em> to support CoffeeScript,
it installs its own hook automatically when you use <code>require(&quot;coffee-script&quot;)</code>.</p>
<h2><span id="strip-c-style-comments-from-json-files">Strip C-style comments from JSON files</span></h2><p>Node can load and parse JSON files when you call <code>require(&quot;json filename&quot;)</code>.
I love JSON files but always felt bad they do not allow comments.
There is limited work around I describe in
<a href="../angularjs-and-javascript-nuggets/">Angular and JS nuggets</a>,
but I always wanted full C-style comments (<code>//</code> and <code>/* */</code>).
<a href="https://twitter.com/sindresorhus" target="_blank" rel="noopener">Sindre Sorhus</a>
wrote <a href="https://github.com/sindresorhus/strip-json-comments" target="_blank" rel="noopener">strip-json-comments</a>
that has single method to strip comments from any given source string.
Putting this together with require hook allows stripping comments from
JSON files automatically</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hook = <span class="built_in">require</span>(<span class="string">'node-hook'</span>);</span><br><span class="line"><span class="keyword">var</span> strip = <span class="built_in">require</span>(<span class="string">'strip-json-comments'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stripJson</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ret = strip(source);</span><br><span class="line">    <span class="comment">// str will be evaluated by Nodejs, just like eval(...)</span></span><br><span class="line">    <span class="keyword">var</span> str = <span class="string">'module.exports = '</span> + ret;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line">hook.hook(<span class="string">'.json'</span>, stripJson);</span><br></pre></td></tr></table></figure>
<p>This transformation is implemented in
<a href="https://github.com/uTest/autostrip-json-comments" target="_blank" rel="noopener">autostrip-json-comments</a></p>
<h2><span id="extend-the-javascript-language">Extend the JavaScript language</span></h2><p>I write a lot of asynchronous code using promises, and often find
myself using <code>function.bind(...)</code> syntax to do context binding and partial application.
For example when I want to print message after a promise is resolved:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// using separate function</span></span><br><span class="line">get(<span class="string">'http://www.google.com'</span>)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'google is working'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// OR shorter using .bind</span></span><br><span class="line">get(<span class="string">'http://www.google.com'</span>)</span><br><span class="line">.then(<span class="built_in">console</span>.log.bind(<span class="literal">null</span>, <span class="string">'google is working'</span>));</span><br></pre></td></tr></table></figure>
<p>Often, I see every link in the promise chain using <code>.bind</code>, increasing
code size and occluding the actual intent.
To avoid writing <code>bind</code> over and over, I wrote a small syntax shortcut
<a href="https://github.com/bahmutov/dotdot" target="_blank" rel="noopener">dotdot</a>. It hooks into
<em>.js</em> file loader and uses a regular expression to replace <code>foo..bar()</code> with
<code>foo.bar.bind(foo)</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dotdot = <span class="built_in">require</span>(<span class="string">'./src/dotdot'</span>);</span><br><span class="line"><span class="keyword">var</span> hook = <span class="built_in">require</span>(<span class="string">'node-hook'</span>).hook;</span><br><span class="line">hook(dotdot);</span><br><span class="line"><span class="comment">// now I can replace code like this</span></span><br><span class="line">asyncSquare(<span class="number">2</span>)</span><br><span class="line">    .then(<span class="built_in">console</span>.log.bind(<span class="literal">null</span>, <span class="string">'2 ='</span>))</span><br><span class="line">    .then(asyncSquare.bind(<span class="literal">null</span>, <span class="number">3</span>))</span><br><span class="line">    .then(<span class="built_in">console</span>.log.bind(<span class="literal">null</span>, <span class="string">'3 ='</span>))</span><br><span class="line">    .then(asyncSquare.bind(<span class="literal">null</span>, <span class="number">4</span>))</span><br><span class="line">    .then(<span class="built_in">console</span>.log.bind(<span class="literal">null</span>, <span class="string">'4 ='</span>));</span><br><span class="line"><span class="comment">// with</span></span><br><span class="line">asyncSquare(<span class="number">2</span>)</span><br><span class="line">    .then(<span class="built_in">console</span>..log(<span class="string">'2 ='</span>))</span><br><span class="line">    .then(asyncSquare..(<span class="number">3</span>))</span><br><span class="line">    .then(<span class="built_in">console</span>..log(<span class="string">'3 ='</span>))</span><br><span class="line">    .then(asyncSquare..(<span class="number">4</span>))</span><br><span class="line">    .then(<span class="built_in">console</span>..log(<span class="string">'4 ='</span>));</span><br></pre></td></tr></table></figure>
<h2><span id="code-coverage">Code coverage</span></h2><p>An excellent pure JavaScript code coverage library
<a href="https://npmjs.org/package/istanbul" target="_blank" rel="noopener">istanbul</a> installs its own hook, making
very drastic changes to the source code before evaluating. Basically,
it adds a separate counter and increment for each original source line:</p>
<figure class="highlight js"><figcaption><span>dummy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'first line'</span>);    <span class="comment">// line 0</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'second line'</span>);   <span class="comment">// line 1</span></span><br><span class="line"><span class="comment">// becomes</span></span><br><span class="line">__counters[<span class="string">'dummy.js'</span>][<span class="number">0</span>]++; <span class="built_in">console</span>.log(<span class="string">'first line'</span>);</span><br><span class="line">__counters[<span class="string">'dummy.js'</span>][<span class="number">1</span>]++; <span class="built_in">console</span>.log(<span class="string">'second line'</span>);</span><br></pre></td></tr></table></figure>
<p>After the execution has finished, one just looks at the <code>__counters</code> structure
to get the coverage information.</p>
<p>The actual transformation is not pure text-based like <em>dotdot</em>.
Instead, the source is first converted into an Abstract Syntax Tree (AST),
the new nodes are inserted (to keep track of branches, statements, function calls),
and then the updated tree is serialized back to source string.
You can read more about these types of code transformation in <a href="http://tobyho.com/" target="_blank" rel="noopener">Toby Ho</a>&#39;s post
<a href="http://tobyho.com/2013/12/20/falafel-source-rewriting-magicial-assert/" target="_blank" rel="noopener">Falafel, Source Rewriting, and a Magicial Assert</a>.</p>
<h2><span id="conclusion">Conclusion</span></h2><p>Transforming source code automatically on load is a powerful
tool, allowing to extend the JavaScript language itself.
There is definitely a trade off between the power and maintainence,
because the source code you see is no longer the source running.</p>
<p>The current <em>node-hook</em> implementation is rudimentary. For example,
it does not allow chaining the transformations, only a single
transform function per file extension is supported.
Another nice to have feature would be to support a user-supplied
filtering function to transform only certain source files and
not everything.</p>
<p>These transformations are not limited to Nodejs. Any AMD-style
JavaScript loader does essentially the same thing: downloads the module
source then evaluates the source. So you can install a hook and transform
the code before it evaluates. You might need to add an ability
to run user-supplied transform to the AMD loader, since none of them
provide this feature. It should be simple to do.</p>
<h2><span id="related">Related</span></h2><ul>
<li><a href="../hacking-node-require/">Hacking Node require</a></li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  var s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/hooking-into-node-loader-for-fun-and-profit/" data-id="cjest8exl00d1jkoolwbijbun" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/hooking-into-node-loader-for-fun-and-profit/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/ast/">ast</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/nodejs/">nodejs</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../give-browser-a-chance/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Give browser a chance
        
      </div>
    </a>
  
  
    <a href="../developer-value/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Developer value</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">101</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">278</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">97</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/">cypress</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/">docker</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">67</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/">hyperapp</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">160</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">71</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/">presentation</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">71</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/">typescript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/">vuejs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 11.82px;">QUnit</a> <a href="../tags/advice/" style="font-size: 19.55px;">advice</a> <a href="../tags/angularjs/" style="font-size: 18.18px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.64px;">assertions</a> <a href="../tags/ast/" style="font-size: 13.18px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.91px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 16.82px;">browser</a> <a href="../tags/ci/" style="font-size: 12.73px;">ci</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.73px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 14.09px;">cypress</a> <a href="../tags/d3/" style="font-size: 10.91px;">d3</a> <a href="../tags/db/" style="font-size: 14.09px;">db</a> <a href="../tags/docker/" style="font-size: 13.64px;">docker</a> <a href="../tags/es6/" style="font-size: 15.45px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.64px;">functional</a> <a href="../tags/generators/" style="font-size: 11.82px;">generators</a> <a href="../tags/git/" style="font-size: 14.55px;">git</a> <a href="../tags/grunt/" style="font-size: 12.73px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.91px;">gulp</a> <a href="../tags/hyperapp/" style="font-size: 11.82px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.36px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.91px;">interview</a> <a href="../tags/jade/" style="font-size: 11.36px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.91px;">jshint</a> <a href="../tags/modular-development/" style="font-size: 17.27px;">modular development</a> <a href="../tags/nodejs/" style="font-size: 19.09px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.36px;">performance</a> <a href="../tags/presentation/" style="font-size: 11.36px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.73px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.45px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/reactive/" style="font-size: 15px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 10.45px;">reactjs</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.73px;">security</a> <a href="../tags/sentry/" style="font-size: 14.09px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.27px;">service workers</a> <a href="../tags/testing/" style="font-size: 19.09px;">testing</a> <a href="../tags/tutorial/" style="font-size: 13.18px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 10.45px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.45px;">ui</a> <a href="../tags/vuejs/" style="font-size: 10.91px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.27px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../renovate-app/">Painless Dependency Upgrades with Renovate App</a>
          </li>
        
          <li>
            <a href="../debugging-mocha-using-inspector/">Debugging Mocha from Node using Chrome Inspector</a>
          </li>
        
          <li>
            <a href="../subfolders-as-dependencies/">Subfolders as Dependencies</a>
          </li>
        
          <li>
            <a href="../parcel/">Parcel Bundler</a>
          </li>
        
          <li>
            <a href="../use-lenses-in-hyperapp/">Use Lenses in Hyperapp</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/hooking-into-node-loader-for-fun-and-profit/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css">
  <script src="../fancybox/jquery.fancybox.pack.js"></script>


<script src="../js/script.js"></script>

  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
