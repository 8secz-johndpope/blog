<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Better world by better software</title>
  
  <subtitle>Gleb Bahmutov PhD</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://glebbahmutov.com/blog/"/>
  <updated>2020-06-17T02:11:31.976Z</updated>
  <id>https://glebbahmutov.com/blog/</id>
  
  <author>
    <name>Gleb Bahmutov</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Stop The Money Pipeline</title>
    <link href="https://glebbahmutov.com/blog/stop-the-money-pipeline/"/>
    <id>https://glebbahmutov.com/blog/stop-the-money-pipeline/</id>
    <published>2020-06-17T04:00:00.000Z</published>
    <updated>2020-06-17T02:11:31.976Z</updated>
    
    <content type="html"><![CDATA[<p>Maybe huge banks are financing fossil fuels and thus the planet&#39;s destruction. You can read the entire list at <a href="https://www.ran.org/" target="_blank" rel="noopener">Rainforest Action Network</a> website. They publish <a href="https://www.ran.org/issue/banks_and_climate/" target="_blank" rel="noopener">banking report</a> every year, for example here <a href="https://www.ran.org/wp-content/uploads/2020/05/BOCC__2020_Summary_vENG_spread.pdf" target="_blank" rel="noopener">2020 report</a>. In summary, these banks are the worst twelve.</p><p><img src="/blog/images/banks/twelve.png" alt="Twelve worst banks financing fossil fuel projects"></p><p>Stopping these banks is a huge goal of the climate movement - see the <a href="https://www.stopthemoneypipeline.com/" target="_blank" rel="noopener">https://www.stopthemoneypipeline.com/</a> for actions. In spirit of stopping the money that finance the destruction, I have switched my accounts too.</p><ol><li>I have canceled <strong>Bank of America</strong> account and went with a local <a href="https://www.watertownsavings.com/" target="_blank" rel="noopener">Watertown Savings Bank</a>.</li></ol><center>  <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/i3_vlXdt-2I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>Because it is important to talk about the climate crisis, I have <a href="https://twitter.com/bahmutov/status/1257686182043037697" target="_blank" rel="noopener">tweeted about it</a>, tagging the Bank of America in the tweet. I have also called them to cancel the account and listed by reason for this.</p><p><img src="/blog/images/banks/boa-tweet.png" alt="Cutting Bank of America card tweet"></p><ol start="2"><li>I have canceled my <strong>Chase</strong> credit card (that I loved). Again, I have posted the video online and told the bank my reason for canceling the account with them was their investment in fossil fuels.</li></ol><center>  <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/TaiU1xqcxp4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>Screenshot of the <a href="https://twitter.com/bahmutov/status/1260702956598562816" target="_blank" rel="noopener">tweet</a></p><p><img src="/blog/images/banks/chase-tweet.png" alt="Cutting Chase card tweet"></p><p>So far I have not replaced the card - I am still looking at options at <a href="https://www.greenamerica.org/better-banking/take-charge-your-card/find-responsible-credit-cards" target="_blank" rel="noopener">greenamerica.org</a>.</p><ol start="3"><li>Finally, constructing fossil fuel infrastructure requires insurance. <strong>Liberty Mutual</strong> from Boston is a leader in insuring gas pipelines, oil exploration, etc. On the other hand, they were selling insurance to me for my home - insurance that is certain to become more expensive as climate breakdown increases the natural disasters. So I have switched from Liberty Mutual to <a href="travelers.com">Traveler&#39;s</a>, <a href="https://twitter.com/bahmutov/status/1268994645259882496" target="_blank" rel="noopener">tweeting about it</a></li></ol><p><img src="/blog/images/banks/liberty-tweet.png" alt="Liberty Mutual tweet"></p><p>I have called Liberty Mutual to cancel the account, and told them my reason. I also told them that I will be paying 5% per year more but I would not be paying money to be used against me and my family&#39;s future.</p><blockquote><p>I invite you to vote with your money and switch to financial institutions that do not destroy the planet. There are plenty of choices!</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Maybe huge banks are financing fossil fuels and thus the planet&amp;#39;s destruction. You can read the entire list at &lt;a href=&quot;https://www.r
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Visual testing for React components using open source tools</title>
    <link href="https://glebbahmutov.com/blog/open-source-visual-testing-of-components/"/>
    <id>https://glebbahmutov.com/blog/open-source-visual-testing-of-components/</id>
    <published>2020-06-16T04:00:00.000Z</published>
    <updated>2020-06-16T12:04:33.744Z</updated>
    
    <content type="html"><![CDATA[<p>Let&#39;s take a look at a modern React application like this <a href="https://github.com/raravi/sudoku" target="_blank" rel="noopener">Sudoku</a> game that you can play online at <a href="https://sudoku-raravi.now.sh/" target="_blank" rel="noopener">https://sudoku-raravi.now.sh/</a>.</p><!-- toc --><ul><li><a href="#sudoku-game">Sudoku game</a></li><li><a href="#implementation">Implementation</a></li><li><a href="#numbers-component">Numbers component</a></li><li><a href="#cypress-react-unit-test">cypress-react-unit-test</a></li><li><a href="#visual-testing">Visual testing</a></li><li><a href="#controlling-the-clock">Controlling the clock</a></li><li><a href="#deterministic-board">Deterministic board</a></li><li><a href="#local-workflow">Local workflow</a></li><li><a href="#continuous-integration">Continuous Integration</a></li><li><a href="#pull-request-workflow">Pull request workflow</a></li><li><a href="#summary">Summary</a></li><li><a href="#more-info">More info</a></li></ul><!-- tocstop --><h2><span id="sudoku-game">Sudoku game</span></h2><p>The game is nicely done. There are different difficulty levels, game modes and it looks very polished.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/lxWEE0vDq6c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>It is a well-designed web application with responsive styles for 3 different browser widths</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/w00vpIEVZPQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>The application is made out of React components, which we can see in the <code>src</code> folder, or by using React DevTools. There is <code>&lt;App /&gt;</code> and <code>&lt;Game /&gt;</code> components, and lots of smaller components matching the sections of the user interface.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/f9sbdiAEHxs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><h2><span id="implementation">Implementation</span></h2><p>Let&#39;s look at the code. <strong>Note:</strong> you can find my fork of the game at <a href="https://github.com/bahmutov/sudoku" target="_blank" rel="noopener">bahmutov/sudoku</a>, which includes all code shown in this blog post.</p><figure class="highlight js"><figcaption><span>src/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"></span><br><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, document.getElementById('root'));</span></span><br></pre></td></tr></table></figure><p>The <code>App</code> component creates the React context object, imports the application&#39;s styles and creates the <code>Game</code> component</p><figure class="highlight js"><figcaption><span>src/App.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Game &#125; <span class="keyword">from</span> <span class="string">'./Game'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./App.css'</span></span><br><span class="line"><span class="keyword">import</span> &#123; SudokuProvider &#125; <span class="keyword">from</span> <span class="string">'./context/SudokuContext'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * App is the root React component.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;SudokuProvider&gt;</span><br><span class="line">      &lt;Game /&gt;</span><br><span class="line">    &lt;<span class="regexp">/SudokuProvider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>The <code>Game</code> component is much larger source file, because it brings all the logic together</p><figure class="highlight js"><figcaption><span>src/Game.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Header &#125; <span class="keyword">from</span> <span class="string">'./components/layout/Header'</span></span><br><span class="line"><span class="keyword">import</span> &#123; GameSection &#125; <span class="keyword">from</span> <span class="string">'./components/layout/GameSection'</span></span><br><span class="line"><span class="keyword">import</span> &#123; StatusSection &#125; <span class="keyword">from</span> <span class="string">'./components/layout/StatusSection'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Footer &#125; <span class="keyword">from</span> <span class="string">'./components/layout/Footer'</span></span><br><span class="line"><span class="keyword">import</span> &#123; getUniqueSudoku &#125; <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSudokuContext &#125; <span class="keyword">from</span> <span class="string">'./context/SudokuContext'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Game = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The <code>Game</code> component renders all the components shown above, passing props that receive user events</p><figure class="highlight js"><figcaption><span>src/Game.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  &lt;&gt;</span><br><span class="line">    &lt;div className=&#123;overlay?<span class="string">"container blur"</span>:<span class="string">"container"</span>&#125;&gt;</span><br><span class="line">      &lt;Header onClick=&#123;onClickNewGame&#125;/&gt;</span><br><span class="line">      &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">        &lt;GameSection</span><br><span class="line">          onClick=&#123;(indexOfArray) =&gt; onClickCell(indexOfArray)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;StatusSection</span><br><span class="line">          onClickNumber=&#123;(number) =&gt; onClickNumber(number)&#125;</span><br><span class="line">          onChange=&#123;(e) =&gt; onChangeDifficulty(e)&#125;</span><br><span class="line">          onClickUndo=&#123;onClickUndo&#125;</span><br><span class="line">          onClickErase=&#123;onClickErase&#125;</span><br><span class="line">          onClickHint=&#123;onClickHint&#125;</span><br><span class="line">          onClickMistakesMode=&#123;onClickMistakesMode&#125;</span><br><span class="line">          onClickFastMode=&#123;onClickFastMode&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Footer /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2><span id="numbers-component">Numbers component</span></h2><p>Among individual smaller components there is <code>Numbers</code> component that you can use to enter numbers into the grid.</p><p><img src="/blog/images/sudoku/numbers.gif" alt="Numbers component"></p><p>The Numbers component receives its inputs from the parent component in two ways: via a context and via props.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useSudokuContext &#125; <span class="keyword">from</span> <span class="string">'../context/SudokuContext'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * React component for the Number Selector in the Status Section.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Numbers = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; numberSelected &#125; = useSudokuContext();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"status__numbers"</span>&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>].map(<span class="function">(<span class="params">number</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (numberSelected === number.toString()) &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">              &lt;div className=<span class="string">"status__number status__number--selected"</span></span><br><span class="line">                key=&#123;number&#125;</span><br><span class="line">                onClick=&#123;() =&gt; props.onClickNumber(number.toString())&#125;&gt;&#123;number&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">            )</span></span><br><span class="line"><span class="regexp">          &#125; else &#123;</span></span><br><span class="line"><span class="regexp">            return (</span></span><br><span class="line"><span class="regexp">              &lt;div className="status__number" key=&#123;number&#125;</span></span><br><span class="line"><span class="regexp">                onClick=&#123;() =&gt; props.onClickNumber(number.toString())&#125;&gt;&#123;number&#125;&lt;/</span>div&gt;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>For example, the currently selected number (if any) is grabbed from the context.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; numberSelected &#125; = useSudokuContext();</span><br></pre></td></tr></table></figure><p>The click handler is grabbed from the <code>props</code> argument and used to send the clicked number back to the parent component.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Numbers = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  &lt;div className=<span class="string">"status__number"</span> key=&#123;number&#125;</span><br><span class="line">    onClick=&#123;() =&gt; props.onClickNumber(number.toString())&#125;&gt;&#123;number&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>If we want to refactor the above component, how do we ensure that we don&#39;t break it? How do we ensure that it renders in exactly the same way, and that when the user clicks, the number is sent to the parent component? How do we write component tests?</p><p>In my view, the component receives its inputs, the props and the context, and generates some output. The output is both the DOM nodes the component renders, and the <code>props.onClickNumber</code> invocations on click. Let&#39;s make sure the component works this way.</p><h2><span id="cypress-react-unit-test">cypress-react-unit-test</span></h2><p>To test the React components I will install <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a>. This adaptor allows the <a href="https://github.com/cypress-io/cypress" target="_blank" rel="noopener">Cypress</a> test runner to mount React components like little mini web applications and then use the full Cypress API to interact with them. Our application uses <code>react-scripts</code>, thus the setup is trivial</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/plugins/react-scripts'</span>)(on, config)</span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"experimentalComponentTesting"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"componentFolder"</span>: <span class="string">"src"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s write our first test.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Numbers &#125; <span class="keyword">from</span> <span class="string">'./Numbers'</span></span><br><span class="line">describe(<span class="string">'Numbers'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'shows all numbers'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Numbers</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">    [1, 2, 3, 4, 5, 6, 7, 8, 9].forEach(k =&gt; &#123;</span></span><br><span class="line"><span class="xml">      cy.contains('.status__number', k)</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Open Cypress with <code>yarn cypress open</code> or <code>npx cypress open</code> and run the test. There is no need to start the application, because we are working with an individual component, not with a page.</p><p>Hmm, the test passes, all the numbers are there. But the component does not look right!</p><p><img src="/blog/images/sudoku/numbers-without-css.png" alt="First test to check all numbers are present"></p><p>I think it is very important to <em>see</em> the component to understand what the users will experience. Our component needs styles - and the styles are in the <code>src/app.css</code> file. Because we point the <code>cypress/plugins/index.js</code> at the <code>react-scripts</code> settings, the spec files will use the same loaders and bundlers as the application code. Which means we can import <code>app.css</code> from the spec file too:</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Numbers &#125; <span class="keyword">from</span> <span class="string">'./Numbers'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../App.css'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><img src="/blog/images/sudoku/numbers-with-css.png" alt="Include App.css in the test file"></p><p>This is better, but still not exactly the same. Since the CSS assumes certain document structure, we need to surround our <code>&lt;Numbers/&gt;</code> with elements with specific class names.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mount(</span><br><span class="line">  &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">    &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">      &lt;Numbers /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>This looks much better - now we see what the user is going to see.</p><p><img src="/blog/images/sudoku/numbers-styled.png" alt="Numbers component styled during test"></p><p>Super. We can also confirm that the component calls the prop <code>onClickNumber</code> when the user clicks a number in the DOM:</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'reacts to a click'</span>, () =&gt; &#123;</span><br><span class="line">  mount(</span><br><span class="line">    &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">      &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">        &lt;Numbers onClickNumber=&#123;cy.stub().as(<span class="string">'click'</span>)&#125;/&gt;</span><br><span class="line">      &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.status__number'</span>, <span class="string">'9'</span>).click()</span><br><span class="line">  cy.get(<span class="string">'@click'</span>).should(<span class="string">'have.been.calledWith'</span>, <span class="string">'9'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>In the test above we pass <a href="https://on.cypress.io/stub" target="_blank" rel="noopener">cy.stub</a> and confirm it was called with expected number 9 when the user clicks on the DOM element.</p><p><img src="/blog/images/sudoku/number-click.png" alt="Confirm the click happens"></p><p>How does our component look when there is a selected number? In order to test this, we need to wrap the <code>&lt;Numbers /&gt;</code> component with a mock context provider.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;SudokuContext&#125; <span class="keyword">from</span> <span class="string">'../context/SudokuContext'</span></span><br><span class="line">describe(<span class="string">'Numbers'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'shows selected number'</span>, () =&gt; &#123;</span><br><span class="line">    mount(</span><br><span class="line">      &lt;SudokuContext.Provider value=&#123;&#123; <span class="attr">numberSelected</span>: <span class="string">'4'</span> &#125;&#125; &gt;</span><br><span class="line">        &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">          &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">            &lt;Numbers /&gt;</span><br><span class="line">          &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/SudokuContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">    cy.contains('.status__number', '4').should('have.class', 'status__number--selected')</span></span><br><span class="line"><span class="regexp">  &#125;)</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br></pre></td></tr></table></figure><p>The number <code>4</code> does have the expected class <code>status__number--selected</code> and we do see the color difference.</p><p><img src="/blog/images/sudoku/selected-number.png" alt="Selected number 4"></p><p>Ok, but do we need to look at the tests to tell if the component looks correctly? Do we need a human in the loop? What if we change the <code>App.css</code> file and accidentally break some other component? This game has its own polished style, it would be a shame to break it accidentally.</p><h2><span id="visual-testing">Visual testing</span></h2><p>If we want to confirm the look of the component, we could assert every computed CSS property of every DOM node ... but that would be unbelievably brittle and hard to maintain. Instead, we could render the component into an image and <em>look at it</em>. While computers are not very good (yet) at understanding images, they are really good at <em>comparing</em> them. So let&#39;s generate screenshots of our component with different inputs and store those images with the code. Any time there is a pull request, we will repeat the above steps and then compare the new images pixel by pixel with saved good images.</p><p>There are many <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">commercial services</a> that do this, but in this blog post I will use open source image comparison plugin for Cypress called <a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a>. We can install it as a dev dependency and include its files in the support and plugins files.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-image-snapshot/command'</span>).addMatchImageSnapshotCommand()</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/plugins/react-scripts'</span>)(on, config)</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-image-snapshot/plugin'</span>).addMatchImageSnapshotPlugin(on, config)</span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now we get a new Cypress command <code>cy.matchImageSnapshot(&lt;snapshot name&gt;)</code>. Let&#39;s use it to create image snapshot of the Number component with selected digit &quot;4&quot;.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'shows selected number'</span>, () =&gt; &#123;</span><br><span class="line">  mount(</span><br><span class="line">    &lt;SudokuContext.Provider value=&#123;&#123; <span class="attr">numberSelected</span>: <span class="string">'4'</span> &#125;&#125; &gt;</span><br><span class="line">      &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">        &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">          &lt;Numbers /&gt;</span><br><span class="line">        &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    &lt;<span class="regexp">/SudokuContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">  cy.contains('.status__number', '4')</span></span><br><span class="line"><span class="regexp">    .should('have.class', 'status__number--selected')</span></span><br><span class="line"><span class="regexp">  cy.get('.status__numbers')</span></span><br><span class="line"><span class="regexp">    .matchImageSnapshot('numbers-selected')</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br></pre></td></tr></table></figure><p>In the test we have confirmed the component has been rendered using an assertion</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.contains(<span class="string">'.status__number'</span>, <span class="string">'4'</span>)</span><br><span class="line">  .should(<span class="string">'have.class'</span>, <span class="string">'status__number--selected'</span>)</span><br></pre></td></tr></table></figure><p>Then we create an image with the entire <code>.status__numbers</code> DOM element rendered.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'.status__numbers'</span>)</span><br><span class="line">  .matchImageSnapshot(<span class="string">'numbers-selected'</span>)</span><br></pre></td></tr></table></figure><p>The snapshots are saved in <code>cypress/snapshots</code> folder.</p><p><img src="/blog/images/sudoku/numbers-selected.snap.png" alt="Numbers component with selected number 4"></p><p>If we edit the CSS file <code>src/App.css</code> and change the text padding around the numbers like this:</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.status__number &#123;</span><br><span class="line"><span class="deletion">-   padding: 12px 0;</span></span><br><span class="line"><span class="addition">+   padding: 10px 0;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The test runs - and the generated snapshot (under the hood <code>cypress-image-snapshot</code> uses <a href="https://on.cypress.io/screenshot" target="_blank" rel="noopener">cy.screenshot</a>) is slightly different. It is hard to notice, so the pixel by pixel comparison done by the computer is perfect tool for automating it. The <code>cypress-image-snapshot</code> plugin produces the diff image in <code>cypress/snapshots/**/__diff_output__</code> folder. The diff image has three parts: on the left is the original baseline image. On the right is the current image. In the middle there is a composite image highlighting the difference.</p><p><img src="/blog/images/sudoku/numbers-selected.diff.png" alt="Padding difference is caught by image comparison"></p><p>The visual snapshots replace a lot of individual assertions. For example, there is no need to confirm that individual numbers are present in the DOM. Instead we can confirm the number of DOM elements with the class (to make sure the component has rendered) and take a single snapshot.</p><figure class="highlight js"><figcaption><span>src/components/Numbers.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'shows all numbers'</span>, () =&gt; &#123;</span><br><span class="line">  mount(</span><br><span class="line">    &lt;div className=<span class="string">"innercontainer"</span>&gt;</span><br><span class="line">      &lt;section className=<span class="string">"status"</span>&gt;</span><br><span class="line">        &lt;Numbers /&gt;</span><br><span class="line">      &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">-  <span class="comment">// trying to assert every number in the DOM</span></span><br><span class="line">-  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>].forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">-    cy.contains(<span class="string">'.status__number'</span>, k)</span><br><span class="line">-  &#125;)</span><br><span class="line">+ cy.get(<span class="string">'.status__number'</span>).should(<span class="string">'have.length'</span>, <span class="number">9</span>)</span><br><span class="line">+ cy.get(<span class="string">'.status__numbers'</span>).matchImageSnapshot(<span class="string">'all-numbers'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>A single image snapshot can confirm so much - as long as the components render consistently from the same data. Let&#39;s look how to ensure it.</p><h2><span id="controlling-the-clock">Controlling the clock</span></h2><p>Inside the app, we have a timer that shows elapsed time since the start of the game</p><p><img src="/blog/images/sudoku/timer.gif" alt="Game timer"></p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">it(<span class="string">'shows the timer'</span>, () =&gt; &#123;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  // the timer starts at zero, so this is probably ok</span></span><br><span class="line"><span class="xml">  cy.contains('.status__time', '00:00')</span></span><br><span class="line"><span class="xml">    .matchImageSnapshot('timer-zero')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Hmm, how do we make sure we take consistent snapshot of a timer element that keeps changing? By controlling the <a href="https://on.cypress.io/stubs-spies-and-clocks" target="_blank" rel="noopener">clock</a> using <a href="https://on.cypress.io/clock" target="_blank" rel="noopener">cy.clock</a> and <a href="https://on.cypress.io/tick" target="_blank" rel="noopener">cy.tick</a>.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">it(<span class="string">'shows the timer'</span>, () =&gt; &#123;</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  cy.contains('.status__time', '00:00')</span></span><br><span class="line"><span class="xml">    .matchImageSnapshot('timer-zero')</span></span><br><span class="line"><span class="xml">  cy.tick(700 * 1000)</span></span><br><span class="line"><span class="xml">  cy.contains('.status__time', '11:40')</span></span><br><span class="line"><span class="xml">    .matchImageSnapshot('timer-passed')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Because we explicitly control the app&#39;s clock, the timer stays frozen at &quot;00:00&quot; when we take the first snapshot, and stays frozen at &quot;11:40&quot; when we take the second snapshot 700 seconds later. A nice bonus for this technique is that we can test an application with long actions in a blink of an eye.</p><p><img src="/blog/images/sudoku/control-the-clock.gif" alt="Controlling the clock test"></p><h2><span id="deterministic-board">Deterministic board</span></h2><p>If we can test the smaller components, why can&#39;t we mount the entire <code>&lt;App&gt;</code> and take an image snapshot? That would give us a lot of confidence.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">it(<span class="string">'shows the board'</span>, () =&gt; &#123;</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  // DOES NOT WORK, JUST FOR DEMO</span></span><br><span class="line"><span class="xml">  cy.get('.container').matchImageSnapshot('the-game')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Unfortunately the above test would not work. We cannot just take a snapshot - the board is generated randomly every time the game starts. Every new board will produce a new image, breaking the test.</p><p><img src="/blog/images/sudoku/random-board.gif" alt="Random board"></p><p>Let&#39;s look how the game generates the board data. The <code>&lt;App&gt;</code> component has the <code>&lt;Game&gt;</code> child component, which imports a function to generate the board.</p><figure class="highlight js"><figcaption><span>src/Game.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getUniqueSudoku &#125; <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createNewGame</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [temporaryInitArray, temporarySolvedArray] = getUniqueSudoku(difficulty, e);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>To generate the same board, we will stub the ES6 import <code>getUniqueSudoku</code>. I have intercepted the results from <code>getUniqueSudoku()</code> call using the DevTools and saved the two arrays as two JSON fixture files.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cypress/fixtures/init-array.json</span></span><br><span class="line">[<span class="string">"0"</span>, <span class="string">"0"</span>, <span class="string">"9"</span>, <span class="string">"0"</span>, <span class="string">"2"</span>, <span class="string">"0"</span>, <span class="string">"0"</span>, ...]</span><br><span class="line"><span class="comment">// cypress/fixtures/solved-array.json</span></span><br><span class="line">[<span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"9"</span>, <span class="string">"3"</span>, <span class="string">"2"</span>, <span class="string">"8"</span>, <span class="string">"4"</span>, ...]</span><br></pre></td></tr></table></figure><p>Plugin <code>cypress-react-unit-test</code> comes with a Babel plugin that can mock ES6 module imports, and for any application that uses <code>react-scripts</code> it should work automatically. Let mock the <code>getUniqueSudoku</code> import and return the arrays loaded from the fixture files.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> UniqueSudoku <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">it(<span class="string">'shows the board'</span>, () =&gt; &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">    cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  cy.get('.container').matchImageSnapshot('the-game')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The above test always generates the same board, freezes the clock at &quot;00:00&quot; and generates a consistent snapshot image. Building on top of this approach, we can write a test that plays a move, since we have a deterministic board to start with.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> UniqueSudoku <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">it(<span class="string">'plays one move'</span>, () =&gt; &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">    cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  cy.get('.game__cell').first().click()</span></span><br><span class="line"><span class="xml">  // we can even look at the solved array!</span></span><br><span class="line"><span class="xml">  cy.contains('.status__number', '6').click()</span></span><br><span class="line"><span class="xml">  cy.get('.game__cell').first()</span></span><br><span class="line"><span class="xml">    .should('have.class', 'game__cell--highlightselected')</span></span><br><span class="line"><span class="xml">  cy.get('.container').matchImageSnapshot('same-game-made-one-move')</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/sudoku/play-move.png" alt="Test that makes a move"></p><p>While a screenshot is nice, the power of Cypress comes from its full browser experience and time-traveling debugging feature. The video below shows what every test command does as we hover it.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/WcXZpqAKwQQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p><strong>Tip:</strong> if a lot of tests load the same fixture, you can load it once and store in a closure variable.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initArray</span><br><span class="line"><span class="keyword">let</span> solvedArray</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> initArray = arr)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> solvedArray = arr)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">'plays one move'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Read blog post <a href="../import-cypress-fixtures/">Import Cypress fixtures</a> for details.</p><h2><span id="local-workflow">Local workflow</span></h2><p>We can write visual tests for our components and generate consistent images by mocking data and the clock. Is this enough to use visual testing in our day-to-day life?</p><p>No.</p><p>If we take a visual snapshot in Cypress GUI opened with <code>yarn cypress open</code> on Mac we will get an image with a specific resolution, for example 1300x600 pixels. When we take the same snapshot in the headless mode using <code>yarn cypress run</code> we will get an image with only the half resolution in each dimension: 650x300 pixels. This is due to pixel density of the graphical application vs headless rendering mode. Thus I <em>disable snapshots</em> in the interactive mode from the support file.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; addMatchImageSnapshotCommand &#125; <span class="keyword">from</span> <span class="string">'cypress-image-snapshot/command'</span>;</span><br><span class="line"><span class="keyword">if</span> (Cypress.config(<span class="string">'isInteractive'</span>)) &#123;</span><br><span class="line">  Cypress.Commands.add(<span class="string">'matchImageSnapshot'</span>, () =&gt; &#123;</span><br><span class="line">    cy.log(<span class="string">'Skipping snapshot 👀'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  addMatchImageSnapshotCommand()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br></pre></td></tr></table></figure><p>When the test is running, the Command Log shows the places where the snapshots would be taken.</p><p><img src="/blog/images/sudoku/skip-snapshots.png" alt="Skipped snapshots"></p><p>To really take a snapshot, I execute <code>yarn cypress run</code>, inspect any new snapshot files, add them to the source control and push the code to the remote repository.</p><p>If I need to update a saved image snapshot, I can delete the snapshot image and execute <code>yarn cypress run</code> to save new image. Or I can run Cypress with environment variable telling the <code>cypress-image-snapshot</code> to update every snapshot if there is difference.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_updateSnapshots=<span class="literal">true</span> yarn cypress run</span></span><br></pre></td></tr></table></figure><p><strong>Note:</strong> make sure to inspect every changed snapshot before committing, since all snapshots can be updated during the above command.</p><h2><span id="continuous-integration">Continuous Integration</span></h2><p>Even when saving image snapshots in the headless mode we can encounter problems. For example, if we save the image snapshots on Mac and compare them to the images generated on Linux CI, there will be tiny pixel differences due to font rendering, aliasing, and different browser versions.</p><p><img src="/blog/images/sudoku/ci-diff.png" alt="Mac vs Linux font rendering"></p><p>The image above shows the detected pixel differences between <code>00:00</code> rendered on Mac (left) and on Linux (right). Even these tiny differences still fail the test.</p><p>We can configure the <a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a> command to accept a small percentage of different pixels per image.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// when adding matchImageSnapshot command</span></span><br><span class="line">addMatchImageSnapshotCommand(&#123;</span><br><span class="line">  failureThreshold: <span class="number">0.03</span>, <span class="comment">// threshold for entire image</span></span><br><span class="line">  failureThresholdType: <span class="string">'percent'</span>, <span class="comment">// percent of image or number of pixels</span></span><br><span class="line">  customDiffConfig: &#123; <span class="attr">threshold</span>: <span class="number">0.1</span> &#125;, <span class="comment">// threshold for each pixel</span></span><br><span class="line">  capture: <span class="string">'viewport'</span>, <span class="comment">// capture viewport in screenshot</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>I do not trust such thresholds, since they can miss actual visual problems. Instead I recommend generating image snapshots using exactly the same environment as the one on CI. This is simple to do using Docker containers from <a href="https://github.com/cypress-io/cypress-docker-images" target="_blank" rel="noopener">cypress-docker-images</a>. Instead of running the command <code>yarn cypress run</code> to generate or update snapshots, we will use a Docker image locally.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">     <span class="attr">"docker:run"</span>: <span class="string">"docker run -it -v $PWD:/e2e -w /e2e cypress/included:4.5.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Because the component tests do not require a server, we can run them with a single command using the pre-installed Cypress Docker image <code>cypress/included:&lt;version&gt;</code>. On CI we can use a Docker with exactly the same OS dependencies, fonts and browser version. Here is an example CI config</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  cypress-run:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    container:</span> <span class="string">cypress/browsers:node12.13.0-chrome80-ff74</span></span><br></pre></td></tr></table></figure><p>The Docker image <code>cypress/included:4.5.0</code> is built from <code>cypress/browsers:node12.13.0-chrome80-ff74</code> image with Cypress globally installed. Thus the browser should render the same HTML pages in exactly the same way.</p><h2><span id="pull-request-workflow">Pull request workflow</span></h2><p>Let&#39;s discuss what happens with image snapshots during pull requests. When someone opens a PR with a new feature or a bug fix, it is beneficial to separate the <em>functional</em> tests from the <em>visual</em> tests. If a button has changed its appearance, the functional tests should pass, and the visual tests should fail. This will tell us quickly if there are visual differences due to layout, color, or style changes.</p><p>For this purpose, <a href="https://github.com/bahmutov/sudoku" target="_blank" rel="noopener">bahmutov/sudoku</a> runs tests on CI with an environment variable that tells the <a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a> plugin to generate image diffs, but not fail the command <code>matchImageSnapshot</code>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Cypress</span> <span class="string">run</span> <span class="string">🧪</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line">    <span class="comment"># let's go through the tests and generate all diffs</span></span><br><span class="line"><span class="attr">    env:</span> <span class="string">failOnSnapshotDiff=false</span></span><br></pre></td></tr></table></figure><p>At the end of the run we can find these diff images and report them separately using GitHub commit status check.</p><figure class="highlight js"><figcaption><span>scripts/set-gh-check.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getVisualDiffs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> globby(<span class="string">'cypress/snapshots/**/__diff_output__/**.png'</span>)</span><br><span class="line">&#125;</span><br><span class="line">getVisualDiffs().then(<span class="function"><span class="params">list</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> setGitHubCommitStatus(list.length, envOptions)</span><br><span class="line">&#125;).catch(onError)</span><br></pre></td></tr></table></figure><p>If there are any DIFF images, then the status check will be <code>fail</code>. The video below shows a pull request where at first there are visual changes. Then the tests are updated and the next commit has no visual differences.</p><iframe style="width: 100%; height: 400px" src="https://www.youtube-nocookie.com/embed/BDgqweqR36Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>Whenever there are visual differences, you can inspect the diff images if you store them on CI as test artifacts; the snapshots are stored in <code>cypress/snapshots</code> folder.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Store</span> <span class="string">snapshots</span> <span class="string">📸</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">actions/upload-artifact@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">snapshots</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">cypress/snapshots</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Set</span> <span class="string">commit</span> <span class="string">status</span> <span class="string">🖼</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    node ./scripts/set-gh-check.js</span></span><br></pre></td></tr></table></figure><h2><span id="summary">Summary</span></h2><p>In this blog post we have looked at writing React component tests and using visual diffing to compare the current image against the good baseline image. We must generate the same image, which we can do by mocking the data and the clock to be deterministic. We also need to ensure that the snapshots are generated using exactly the same environment to be pixel-perfect matches.</p><p>Finally, we briefly looked at the visual tests during pull request workflow. Looking back at the entire work, I conclude:</p><ul><li>writing React component tests using <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> is fast and easy</li><li><a href="https://github.com/palmerhq/cypress-image-snapshot" target="_blank" rel="noopener">cypress-image-snapshot</a> plugin allows one to do visual testing for free, but we have to do a lot of work to manage images, render them, and review them during pull requests</li></ul><p>I would strongly recommend giving a commercial visual testing service a try: Applitools, Happo.io, and Percy.io have Cypress plugins and are free to try and cheap use.</p><h2><span id="more-info">More info</span></h2><p>Take a look at the example Sudoku repository, and especially at the long list of short videos there: <a href="https://github.com/bahmutov/sudoku#videos" target="_blank" rel="noopener">bahmutov/sudoku#videos</a>. These videos show every part of the process I have described in this blog in more detail.</p><p>You should also read the <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">Cypress visual testing guide</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Let&amp;#39;s take a look at a modern React application like this &lt;a href=&quot;https://github.com/raravi/sudoku&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;S
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
      <category term="react" scheme="https://glebbahmutov.com/blog/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>Import Cypress fixtures</title>
    <link href="https://glebbahmutov.com/blog/import-cypress-fixtures/"/>
    <id>https://glebbahmutov.com/blog/import-cypress-fixtures/</id>
    <published>2020-06-15T04:00:00.000Z</published>
    <updated>2020-06-15T13:35:07.115Z</updated>
    
    <content type="html"><![CDATA[<p>In <a href="https://github.com/bahmutov/sudoku" target="_blank" rel="noopener">bahmutov/sudoku</a> I am loading two JSON fixtures to mock a method that creates the new board. This ensures the game always starts with the same numbers and generates the same image for <a href="https://www.youtube.com/playlist?list=PLP9o9QNnQuAYhotnIDEUQNXuvXL7ZmlyZ" target="_blank" rel="noopener">visual testing</a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> UniqueSudoku <span class="keyword">from</span> <span class="string">'./solver/UniqueSudoku'</span></span><br><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">    cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">        cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    cy.clock()</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.get('.game__cell--filled').should('have.length', 45)</span></span><br><span class="line"><span class="xml">    cy.get('.container').matchImageSnapshot('same-game-mocked-sudoku')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/sudoku/game-board.png" alt="Mocked board creation produces the same Sudoku game"></p><p>The JSON fixtures are simple arrays, we are using <a href="https://on.cypress.io/fixture" target="_blank" rel="noopener">cy.fixture</a> command to load them.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cypress/fixtures/init-array.json</span></span><br><span class="line">[<span class="string">"0"</span>, <span class="string">"0"</span>, <span class="string">"9"</span>, <span class="string">"0"</span>, <span class="string">"2"</span>, <span class="string">"0"</span>, <span class="string">"0"</span>, ...]</span><br><span class="line"><span class="comment">// cypress/fixtures/solved-array.json</span></span><br><span class="line">[<span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"9"</span>, <span class="string">"3"</span>, <span class="string">"2"</span>, <span class="string">"8"</span>, <span class="string">"4"</span>, ...]</span><br></pre></td></tr></table></figure><p>After the first test passes, we can write a test that plays one or several moves, then another test that sets the entire board and wins the game, etc. All these tests will load the same two fixture files at the start.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">    cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">initArray</span> =&gt;</span> &#123;</span><br><span class="line">      cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">solvedArray</span> =&gt;</span> &#123;</span><br><span class="line">        cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>).returns([initArray, solvedArray])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    cy.clock()</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    ...</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('plays a move', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    cy.fixture('init-array').then(initArray =&gt; &#123;</span></span><br><span class="line"><span class="xml">      cy.fixture('solved-array').then(solvedArray =&gt; &#123;</span></span><br><span class="line"><span class="xml">        cy.stub(UniqueSudoku, 'getUniqueSudoku').returns([initArray, solvedArray])</span></span><br><span class="line"><span class="xml">      &#125;)</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">    cy.clock()</span></span><br><span class="line"><span class="xml">    mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    ...</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('wins the game', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    // load the solved array</span></span><br><span class="line"><span class="xml">    // and set the initial array to be same without one move</span></span><br><span class="line"><span class="xml">    cy.fixture('solved-array').then(solvedArray =&gt; &#123;</span></span><br><span class="line"><span class="xml">      const almostSolved = [...solvedArray]</span></span><br><span class="line"><span class="xml">      // by setting entry to "0" we effectively clear the cell</span></span><br><span class="line"><span class="xml">      almostSolved[0] = '0'</span></span><br><span class="line"><span class="xml">      cy.stub(UniqueSudoku, 'getUniqueSudoku').returns([almostSolved, solvedArray])</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">    cy.clock()</span></span><br><span class="line"><span class="xml">    mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    ...</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><h2><span id="beforeeach">beforeEach</span></h2><p>Loading the same fixture files in every test?! We can do better. First, let&#39;s load the fixtures in the <code>beforeEach</code> hook and save them in the test context. We will need to change our test functions from arrow functions to actual <code>function</code> functions.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).as(<span class="string">'initArray'</span>)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).as(<span class="string">'solvedArray'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([<span class="keyword">this</span>.initArray, <span class="keyword">this</span>.solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', function () &#123;</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([this.initArray, this.solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Cypress <a href="https://on.cypress.io/as" target="_blank" rel="noopener">.as</a> command saves the loaded object in the test context, which is available as a property during the test.</p><h2><span id="before">before</span></h2><p>The hook <code>beforeEach</code> runs with every test, can we load the fixtures <em>once</em>? We can run the code once using <code>before</code> hook, but that will cause a problem.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).as(<span class="string">'initArray'</span>)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).as(<span class="string">'solvedArray'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ✅ works</span></span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([<span class="keyword">this</span>.initArray, <span class="keyword">this</span>.solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', function () &#123;</span></span><br><span class="line"><span class="xml">  // 🔥 DOES NOT WORK</span></span><br><span class="line"><span class="xml">  // this.initArray is undefined</span></span><br><span class="line"><span class="xml">  // this.solvedArray is undefined</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([this.initArray, this.solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The test runner runs the <code>before</code> hook before the very first test, sets the fixtures as properties, and the first test passes. Then the test runner clears the test context and runs the second test. Thus during the second test, the properties <code>initArray</code> and <code>solvedArray</code> are undefined.</p><p>To get around this problem, let&#39;s use closure variables.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initArray</span><br><span class="line"><span class="keyword">let</span> solvedArray</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.fixture(<span class="string">'init-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> initArray = arr)</span><br><span class="line">  cy.fixture(<span class="string">'solved-array'</span>).then(<span class="function"><span class="params">arr</span> =&gt;</span> solvedArray = arr)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([initArray, solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([initArray, solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>I strongly recommend using closure variables instead of <code>this</code> properties. The closure variables are clearly visible and do not depend on <code>function</code> vs <code>() =&gt; {}</code> syntax.</p><h2><span id="imports">imports</span></h2><p>Another possible solution for JSON fixtures it to ... import them from the fixture file. Cypress will bundle the JSON files just fine.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> initArray <span class="keyword">from</span> <span class="string">'../cypress/fixtures/init-array.json'</span></span><br><span class="line"><span class="keyword">import</span> solvedArray <span class="keyword">from</span> <span class="string">'../cypress/fixtures/solved-array.json'</span></span><br><span class="line"></span><br><span class="line">it(<span class="string">'mocks board creation'</span>, () =&gt; &#123;</span><br><span class="line">  cy.stub(UniqueSudoku, <span class="string">'getUniqueSudoku'</span>)</span><br><span class="line">    .returns([initArray, solvedArray])</span><br><span class="line">  cy.clock()</span><br><span class="line">  mount(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">it('plays a move', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">  cy.stub(UniqueSudoku, 'getUniqueSudoku')</span></span><br><span class="line"><span class="xml">    .returns([initArray, solvedArray])</span></span><br><span class="line"><span class="xml">  cy.clock()</span></span><br><span class="line"><span class="xml">  mount(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">  ...</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>Happy testing!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;In &lt;a href=&quot;https://github.com/bahmutov/sudoku&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;bahmutov/sudoku&lt;/a&gt; I am loading two JSON fixtures to mock
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Tic-Tac-Toe Component Tests</title>
    <link href="https://glebbahmutov.com/blog/tic-tac-toe-component-tests/"/>
    <id>https://glebbahmutov.com/blog/tic-tac-toe-component-tests/</id>
    <published>2020-06-03T04:00:00.000Z</published>
    <updated>2020-06-03T19:51:00.767Z</updated>
    
    <content type="html"><![CDATA[<p>Let&#39;s take React <a href="https://codepen.io/gaearon/pen/LyyXgK" target="_blank" rel="noopener">Tic-Tac-Toe example</a> by someone named D Abramov. He must be somewhat important person, since this example was included in the <a href="https://reactjs.org/tutorial/tutorial.html" target="_blank" rel="noopener">React Tutorial</a>. You can find my version of the game at <a href="https://github.com/bahmutov/react-tic-tac-toe-example" target="_blank" rel="noopener">bahmutov/react-tic-tac-toe-example</a>.</p><p><img src="/blog/images/tic-tac-toe/game.png" alt="Tic-tac-toe game"></p><p>The project uses <code>react-scripts</code> to bundle and serve the application. The application itself only has 3 files in the <code>src</code> folder</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">repo/</span><br><span class="line">  package.json</span><br><span class="line">  src/</span><br><span class="line">    index.jsx</span><br><span class="line">    app.jsx</span><br><span class="line">    app.css</span><br></pre></td></tr></table></figure><p>The application file <code>src/app.jsx</code> has a few components: Square, Board, Game and a function <code>calculateWinner</code>.</p><p><img src="/blog/images/tic-tac-toe/app.png" alt="Main application file"></p><h2><span id="e2e-vs-component-tests">E2E vs component tests</span></h2><p>Usually, I consider end-to-end tests the most effective way to confirm the application works. The Cypress test interacts with the loaded application like a real user, and any error in its logic, code, bundling, or deployment is likely to be caught.</p><figure class="highlight js"><figcaption><span>cypress/integration/spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'Tic-tac-toe'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'plays'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    cy.visit(<span class="string">'http://localhost:3000'</span>)</span><br><span class="line">    cy.get(<span class="string">'.square'</span>).eq(<span class="number">0</span>).click() <span class="comment">// X</span></span><br><span class="line">    cy.get(<span class="string">'.square'</span>).eq(<span class="number">1</span>).click() <span class="comment">// O</span></span><br><span class="line">    <span class="comment">// more commands until one player wins</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The tests are nice, but what if we want to concentrate on the <code>Square</code> component? Maybe we want to refactor it, maybe we want to see how it looks with different styles or props, there could be lots of reasons we want to really stress this component in isolation from the main application.</p><h2><span id="component-tests">Component tests</span></h2><p>By adding <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> to the repo we can easily write component tests. Let&#39;s confirm the <code>Square</code> component shows the value passed via a prop. For now we can simply export <code>Square</code> from the <code>app.jsx</code> and import it in the test file, and we can place the spec file alongside the component.</p><figure class="highlight js"><figcaption><span>src/app.jsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">Square</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;button className=<span class="string">"square"</span> onClick=&#123;props.onClick&#125;&gt;</span><br><span class="line">      &#123;props.value&#125;</span><br><span class="line">    &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>src/Square.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Square &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Square'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders value'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Square</span> <span class="attr">value</span>=<span class="string">"X"</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('.square', 'X')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/tic-tac-toe/square.png" alt="Square test"></p><p>We import the component and mount it, and then use Cypress commands to interact with the live  component. Let&#39;s confirm it calls the passed prop on click. Ordinarily one would write a new unit test to separate the value test from the click test. But Cypress has built-in time traveling debugger, records movies on CI, takes screenshots on failures - you don&#39;t need to make component tests tiny just to have a good debugging experience. So I will continue expanding the same test.</p><figure class="highlight js"><figcaption><span>src/Square.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Square &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Square'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders value'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Square</span> <span class="attr">value</span>=<span class="string">"X"</span> <span class="attr">onClick</span>=<span class="string">&#123;cy.stub().as(</span>'<span class="attr">click</span>')&#125; /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('.square', 'X').click()</span></span><br><span class="line"><span class="xml">    cy.get('@click').should('be.called')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The test passes.</p><p><img src="/blog/images/tic-tac-toe/square-click.png" alt="Square click test"></p><h2><span id="styles">Styles</span></h2><p>The square component looks like a regular button, not like a board cell in the real game. This is because we only mounted the markup and never applied any styles to it. There are <a href="https://github.com/bahmutov/cypress-react-unit-test#options" target="_blank" rel="noopener">multiple options</a> for styling components during tests, but the simplest is just to import the application&#39;s CSS from the spec file.</p><figure class="highlight js"><figcaption><span>src/Square.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Square &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./app.css'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Square'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders value'</span>, () =&gt; &#123;</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Square</span> <span class="attr">value</span>=<span class="string">"X"</span> <span class="attr">onClick</span>=<span class="string">&#123;cy.stub().as(</span>'<span class="attr">click</span>')&#125; /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('.square', 'X').click()</span></span><br><span class="line"><span class="xml">    cy.get('@click').should('be.called')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/tic-tac-toe/square-style.png" alt="styled Square"></p><p>We can <code>import &#39;./app.css&#39;</code> because the specs are bundled using the same Webpack config as the application; if you can import a resource from the application code, you should be able to import it from the component test file.</p><h2><span id="mocking-imports">Mocking imports</span></h2><p>We have passed <a href="https://on.cypress.io/stub" target="_blank" rel="noopener">cy.stub</a> to the component. This stub comes from <a href="https://sinonjs.org/" target="_blank" rel="noopener">Sinon.js</a> included with Cypress. It works great when stubbing individual functions or a method on an object. But what about mocking ES6 module exports and imports?</p><p>The game component determines the winner by calling <code>calculateWinner</code> function. The exact details are unimportant, but the code around it looks like this:</p><p><img src="/blog/images/tic-tac-toe/calculate-winner.png" alt="Game calls calculateWinner"></p><p>From the component test, we cannot reach and overwrite a private function <code>calculateWinner</code>. But we could move it into an external module and import it.</p><figure class="highlight js"><figcaption><span>src/utils.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateWinner</span>(<span class="params">squares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lines = [</span><br><span class="line">    [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">3</span>, <span class="number">6</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">4</span>, <span class="number">7</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">5</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>],</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; lines.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> [a, b, c] = lines[i];</span><br><span class="line">    <span class="keyword">if</span> (squares[a] &amp;&amp; squares[a] === squares[b] &amp;&amp; squares[a] === squares[c]) &#123;</span><br><span class="line">      <span class="keyword">return</span> squares[a];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>src/app.jsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;calculateWinner&#125; <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line"><span class="comment">// use calculateWinner to determine the winner</span></span><br></pre></td></tr></table></figure><p>Now let&#39;s write a component test for the <code>Game</code> component - and mock the ES6 module import.</p><figure class="highlight js"><figcaption><span>src/Game.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Game &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./app.css'</span></span><br><span class="line"><span class="comment">// import the module with exports we want to mock</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> utils <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Game'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'declares winner'</span>, () =&gt; &#123;</span><br><span class="line">    cy.stub(utils, <span class="string">'calculateWinner'</span>).returns(<span class="string">'X'</span>)</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">Game</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.contains('Winner: X')</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The test passes - note how <code>Winner: X</code> is immediately displayed, even before the first move is played 😀</p><p><img src="/blog/images/tic-tac-toe/winner-x.png" alt="Help X win right away by mocking the ES6 module import"></p><h2><span id="unit-tests">Unit tests</span></h2><p>We can write more end-to-end and component tests, using built-in code coverage as a guide. But what about the above function <code>calculateWinner</code>? Do we only indirectly test it via component tests? No. We should also directly test it using unit tests.</p><figure class="highlight js"><figcaption><span>src/utils.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; calculateWinner &#125; <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line">describe(<span class="string">'calculateWinner'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> _ = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">const</span> x = <span class="string">'X'</span></span><br><span class="line">  <span class="keyword">const</span> o = <span class="string">'O'</span></span><br><span class="line">  it(<span class="string">'calls no winner for empty board'</span>, () =&gt; &#123;</span><br><span class="line">    expect(calculateWinner(</span><br><span class="line">      [</span><br><span class="line">        _, _, _,</span><br><span class="line">        _, _, _,</span><br><span class="line">        _, _, _,</span><br><span class="line">      ]</span><br><span class="line">    )).to.equal(<span class="literal">null</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'calls winner for X'</span>, () =&gt; &#123;</span><br><span class="line">    expect(calculateWinner(</span><br><span class="line">      [</span><br><span class="line">        _, _, x,</span><br><span class="line">        x, o, x,</span><br><span class="line">        _, o, x,</span><br><span class="line">      ]</span><br><span class="line">    )).to.equal(x)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'calls winner for O'</span>, () =&gt; &#123;</span><br><span class="line">    expect(calculateWinner(</span><br><span class="line">      [</span><br><span class="line">        _, _, o,</span><br><span class="line">        x, o, x,</span><br><span class="line">        o, o, x,</span><br><span class="line">      ]</span><br><span class="line">    )).to.equal(o)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We exercise different <a href="../data-coverage/">data inputs</a> rather than code paths to make sure the function works correctly. The tests do not have a GUI, but the Command Log still shows useful information.</p><p><img src="/blog/images/tic-tac-toe/unit-tests.png" alt="Unit tests"></p><p>If there is an error, the code frame immediately shows the problem. For example if we change the last assertion to <code>)).to.equal(x)</code> we get the <a href="https://www.cypress.io/blog/2020/05/20/faster-debugging-with-test-failure-code-frames-in-cypress-4-6/" target="_blank" rel="noopener">precise source code location</a></p><p><img src="/blog/images/tic-tac-toe/error-location.png" alt="Error location"></p><h2><span id="more-info">More info</span></h2><p>For more reasons behind component testing, read <a href="../my-vision-for-component-tests/">My Vision for Component Tests</a> blog posts, and visit the <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> repo.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Let&amp;#39;s take React &lt;a href=&quot;https://codepen.io/gaearon/pen/LyyXgK&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Tic-Tac-Toe example&lt;/a&gt; by someone na
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="react" scheme="https://glebbahmutov.com/blog/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>Be careful when running all specs together</title>
    <link href="https://glebbahmutov.com/blog/run-all-specs/"/>
    <id>https://glebbahmutov.com/blog/run-all-specs/</id>
    <published>2020-05-28T04:00:00.000Z</published>
    <updated>2020-05-28T21:36:11.979Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#example-application">Example application</a></li><li><a href="#support-file">Support file</a></li><li><a href="#before-hooks">Before hooks</a></li><li><a href="#before-hooks-when-running-all-specs">Before hooks when running all specs</a></li><li><a href="#beforeeach-hook">BeforeEach hook</a></li><li><a href="#solution">Solution</a></li></ul><!-- tocstop --><h2><span id="example-application">Example application</span></h2><p>In our example application we have two spec files and a support file.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">repo/</span><br><span class="line">  cypress/</span><br><span class="line">    integration/</span><br><span class="line">      spec-a.js</span><br><span class="line">      spec-b.js</span><br><span class="line">    support/</span><br><span class="line">      index.js</span><br><span class="line">  cypress.json</span><br></pre></td></tr></table></figure><p>The spec files have two tests each.</p><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="support-file">Support file</span></h2><p>The support file is initially empty. Let&#39;s add a single <code>console.log</code> message.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br></pre></td></tr></table></figure><p>The support file runs in the browser, right before the spec file runs. We can see the support file and the spec file downloaded by the test runner in the DevTools console (blue arrow).</p><p><img src="/blog/images/run-all-specs/two-scripts.png" alt="Support file"></p><p>The two scripts (support file and the spec file) are requested by the test runner via XHR calls and then evaluated.</p><p><img src="/blog/images/run-all-specs/script-names.png" alt="Support and spec files"></p><p>The above download mechanism is just an implementation detail. In effect it means the test runner is evaluating scripts in this order:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"support/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"integration/spec-a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>We can see that both files were bundled using Cypress&#39; built-in preprocessor.</p><p><img src="/blog/images/run-all-specs/support-bundle.png" alt="Support file bundle"></p><p><img src="/blog/images/run-all-specs/spec-bundle.png" alt="Spec file bundle"></p><p>Which means our tests are really running the following <em>concatenated</em> script:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// support/index.js</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line"><span class="comment">// integration/spec-a.js</span></span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="before-hooks">Before hooks</span></h2><p>Let&#39;s place a hook into support file and a hook into the spec file.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: before hook'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test <code>spec-a.js</code> runs and the DevTools console prints the expected output</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">support file</span><br><span class="line">support file: before hook</span><br><span class="line">spec-a file: before hook</span><br></pre></td></tr></table></figure><p>This makes sense - the support file comes first, thus its hook is executed before the spec file&#39;s hook. Similarly, if we add a hook to <code>spec-b.js</code> it will execute in the same order</p><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>DevTools console messages:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">support file</span><br><span class="line">support file: before hook</span><br><span class="line">spec-b file: before hook</span><br></pre></td></tr></table></figure></p><h2><span id="before-hooks-when-running-all-specs">Before hooks when running all specs</span></h2><p>Great, but what happens when the user selects &quot;Run all specs&quot; button?</p><p><img src="/blog/images/run-all-specs/run-all-specs-button.png" alt="Run all specs button"></p><p>We see 4 tests finish in the Test Runner, and in the DevTools Network tab we can see the support file plus each spec file requested by the test runner.</p><p><img src="/blog/images/run-all-specs/run-all-specs.png" alt="Specs requested"></p><p>The scripts are then evaluated one after another, which is equivalent to running the following test code</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: before hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The console prints the messages we expect</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">support file</span><br><span class="line">support file: before hook</span><br><span class="line">spec-a file: before hook</span><br><span class="line">spec-b file: before hook</span><br></pre></td></tr></table></figure><p>Good, no surprises here, but notice that <em>all</em> hooks executed before <em>all</em> tests. This is noticeable when adding a log message in each test.</p><p><img src="/blog/images/run-all-specs/log-from-test.png" alt="all before hooks ran before the tests"></p><p>If you assume that <code>spec-b: before</code> hook runs AFTER tests from <code>spec-a.js</code> but before tests in <code>spec-b.js</code>, you might get a wrong result here.</p><h2><span id="beforeeach-hook">BeforeEach hook</span></h2><p>Let&#39;s switch from <code>before</code> to <code>beforeEach</code> hook.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>When we run a single spec, the DevTools show the following messages.</p><p><img src="/blog/images/run-all-specs/spec-a-before-each.png" alt="Support and spec-a with beforeEach hooks"></p><p>Spec-b runs the same way by itself.</p><p>Now let&#39;s run <em>all specs</em> together. Just like before, this will be equivalent to executing this concatenated script.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-a file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'spec-b file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Do you see the problem? Look at the printed console messages.</p><p><img src="/blog/images/run-all-specs/all-hooks.png" alt="All beforeEach hooks executed for each test"></p><p><em>Every hook</em> has run for every test. We probably did not mean for the <code>beforeEach</code> hook from <code>spec-b.js</code> to run before every test from <code>spec-a.js</code>, right? But because they were all in the same script at the root level, all three hooks are executed for every test.</p><h2><span id="solution">Solution</span></h2><ol><li><p>Never use &quot;Run all specs&quot; button. In fact, when you execute <code>cypress run</code>, Cypress never runs <em>all specs</em> together. Instead it executes &quot;support file + spec-a&quot;, then it separately executes &quot;support file + spec-b&quot; scripts.</p></li><li><p>Be wary of placing <code>before</code> or <code>beforeEach</code> hooks at the root level, instead prefer moving them into <code>describe</code> and <code>context</code> suites. This isolates the hooks, limiting them to the tests in that suite.</p></li></ol><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'support file'</span>)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'support file: beforeEach hook'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-a.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec a'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'spec-a file: beforeEach hook'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/integration/spec-b.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">'spec b'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'spec-b file: beforeEach hook'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/run-all-specs/isolate-hooks.png" alt="Isolated hooks"></p><p>When we place the hooks into a suite like above, they apply correctly to the tests inside their suite.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#example-application&quot;&gt;Example application&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#support-file&quot;&gt;Support file&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a h
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Keep Examples Up To Date</title>
    <link href="https://glebbahmutov.com/blog/keep-examples-up-to-date/"/>
    <id>https://glebbahmutov.com/blog/keep-examples-up-to-date/</id>
    <published>2020-05-22T04:00:00.000Z</published>
    <updated>2020-05-22T14:51:20.482Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#examples-examples-examples">Examples, examples, examples</a></li><li><a href="#concentrate-on-the-most-important-dependencies">Concentrate on the most important dependencies</a></li><li><a href="#set-up-ci">Set up CI</a></li><li><a href="#add-version-badges">Add version badges</a></li><li><a href="#auto-updating-badges">Auto-updating badges</a></li></ul><!-- tocstop --><h2><span id="examples-examples-examples">Examples, examples, examples</span></h2><p>I love building tools and I love having many examples for each tool. Lots of examples make it simpler to understand how the tool works. For example <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> for testing React components has LOTS of both internal and external examples as you can see in the screenshot below:</p><p><img src="/blog/images/example-dependencies/examples.png" alt="Long list of examples"></p><p><strong>Tip:</strong> I give external example repos their own GitHub topic, in this case the topic <a href="https://github.com/topics/cypress-react-unit-test-example" target="_blank" rel="noopener">cypress-react-unit-test-example</a> has 23 GitHub repositories.</p><p>It is a challenge to keep external example repos up to date with the latest version of <code>cypress-react-unit-test</code> as this user calls out:</p><p><img src="/blog/images/example-dependencies/tweet.png" alt="Tweet asking to update try-cra-app-typescript"></p><p>So how do we keep <a href="https://github.com/bahmutov/try-cra-app-typescript" target="_blank" rel="noopener">try-cra-app-typescript</a> up-to-date?</p><h2><span id="concentrate-on-the-most-important-dependencies">Concentrate on the most important dependencies</span></h2><p>Each example might have multiple dependencies. The above project has</p><figure class="highlight js"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"@testing-library/jest-dom"</span>: <span class="string">"^4.2.4"</span>,</span><br><span class="line">    <span class="string">"@testing-library/react"</span>: <span class="string">"^9.3.2"</span>,</span><br><span class="line">    <span class="string">"@testing-library/user-event"</span>: <span class="string">"^7.1.2"</span>,</span><br><span class="line">    <span class="string">"@types/jest"</span>: <span class="string">"^24.0.0"</span>,</span><br><span class="line">    <span class="string">"@types/node"</span>: <span class="string">"^12.0.0"</span>,</span><br><span class="line">    <span class="string">"@types/react"</span>: <span class="string">"^16.9.0"</span>,</span><br><span class="line">    <span class="string">"@types/react-dom"</span>: <span class="string">"^16.9.0"</span>,</span><br><span class="line">    <span class="string">"react"</span>: <span class="string">"^16.13.1"</span>,</span><br><span class="line">    <span class="string">"react-dom"</span>: <span class="string">"^16.13.1"</span>,</span><br><span class="line">    <span class="string">"react-scripts"</span>: <span class="string">"3.4.1"</span>,</span><br><span class="line">    <span class="string">"typescript"</span>: <span class="string">"~3.7.2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"cypress"</span>: <span class="string">"4.3.0"</span>,</span><br><span class="line">    <span class="string">"cypress-react-unit-test"</span>: <span class="string">"3.0.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Because this is an example meant to demo <code>cypress-react-unit-test</code> + Cypress, we will ignore production dependencies and will only update <code>cypress</code> and <code>cypress-react-unit-test</code> dev dependencies. I will use <a href="https://renovate.whitesourcesoftware.com/" target="_blank" rel="noopener">Renovate Bot</a> to automatically open pull requests when new versions of these two dependencies are published on NPM. Following the advice I gave in <a href="../whitelist-renovate/">How To Update Only Some Dependencies Using Renovate App</a> here is <code>renovate.json</code> file</p><figure class="highlight json"><figcaption><span>renovate.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"config:base"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"automerge"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"schedule"</span>: [</span><br><span class="line">    <span class="string">"every weekend"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"updateNotScheduled"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"timezone"</span>: <span class="string">"America/New_York"</span>,</span><br><span class="line">  <span class="attr">"masterIssue"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"enabledManagers"</span>: [</span><br><span class="line">    <span class="string">"npm"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"packageRules"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"packagePatterns"</span>: [</span><br><span class="line">        <span class="string">"*"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"excludePackagePatterns"</span>: [</span><br><span class="line">        <span class="string">"cypress"</span>,</span><br><span class="line">        <span class="string">"cypress-react-unit-test"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We only need to update the dependencies we care about, and we can update them once a week during the weekend hours. When I enable Renovate GitHub Application for this repository, the app immediately opens a master issue showing the possible updates.</p><p><img src="/blog/images/example-dependencies/master-issue.png" alt="Renovate master issue"></p><h2><span id="set-up-ci">Set up CI</span></h2><p>To safely update any dependency, we must have tests and continuous integration service to run them. Following <a href="../example-ci-configs/">Example CI configs</a> I will use <a href="../trying-github-actions/">GitHub Actions</a> with <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a>.</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push,</span> <span class="string">pull_request]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  cypress-run:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">      <span class="comment"># Install NPM dependencies, cache them correctly</span></span><br><span class="line">      <span class="comment"># and run all Cypress tests</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> I always have the CI badge in the README file pointing at the <code>master</code> branch.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[![ci status][ci image]][ci url]</span><br><span class="line">[ci image]: https://github.com/bahmutov/try-cra-app-typescript/workflows/ci/badge.svg?branch=master</span><br><span class="line">[ci url]: https://github.com/bahmutov/try-cra-app-typescript/actions</span><br></pre></td></tr></table></figure><p>Now I can click on <code>cypress</code> or <code>cypress-react-unit-test</code> checkbox in the Renovate&#39;s master issue to open a pull request to update the dependency.</p><p><img src="/blog/images/example-dependencies/update-cypress.png" alt="Click checkbox next to the dependency to update"></p><p>A few seconds later a new pull request appears: Cypress dependency has been updated to v4.6.0 in <code>package.json</code> file; now it is being tested by GitHub Actions workflow.</p><p><img src="/blog/images/example-dependencies/update-cypress-pr.png" alt="Update Cypress pull request"></p><p>Once the CI finishes successfully we can manually merge the pull request or let Renovate Bot auto-merge it after an hour or so.</p><p><img src="/blog/images/example-dependencies/update-cypress-pr-green.png" alt="Cypress can be updated since the tests are green"></p><p><strong>Tip:</strong> if you use semantic release and automate the changelog writing, Renovate pull requests will show a very useful changelog. This makes it easier for the reviewer to decide how to proceed.</p><p><img src="/blog/images/example-dependencies/changelog.gif" alt="Renovate includes the release changelog from the dependency"></p><p>Sometimes a Renovate pull request shows a failed attempt to update. For example, the API for mounting component has changed between v3 and v4 (this was a breaking change).</p><p><img src="/blog/images/example-dependencies/failed-update.png" alt="Failed pull request to update cypress-react-unit-test"></p><p>We can inspect the CI output to see the error message.</p><p><img src="/blog/images/example-dependencies/failure.png" alt="Mount method has changed between v3 and v4"></p><p>I will still merge this pull request, but then I will update the tests to use <code>cypress-react-unit-test</code> using the new API. You can see the changes in commit <a href="https://github.com/bahmutov/try-cra-app-typescript/commit/aed44a77ec300d1f5af3639067ca4f86155385bb" target="_blank" rel="noopener">aed44a</a>.</p><h2><span id="add-version-badges">Add version badges</span></h2><p>I want to make it obvious to anyone looking at the <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> what the compatible Cypress and <code>cypress-react-unit-test</code> versions are right now. The simplest way in my opinion is to put the current dependency versions into the README as badges. I have a little utility for this <a href="https://github.com/bahmutov/dependency-version-badge" target="_blank" rel="noopener">dependency-version-badge</a>. We can simply run the tool using <code>npx</code> and insert two badges into the README at the first line</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx -p dependency-version-badge update-badge cypress cypress-react-unit-test</span></span><br><span class="line">npx: installed 3 in 2.091s</span><br><span class="line">⚠️ Could not find version badge for dependency "cypress"</span><br><span class="line">Insert new badge on the first line</span><br><span class="line">saving updated readme with cypress@4.6.0</span><br><span class="line">⚠️ Could not find version badge for dependency "cypress-react-unit-test"</span><br><span class="line">Insert new badge on the first line</span><br><span class="line">saving updated readme with cypress-react-unit-test@4.2.3</span><br></pre></td></tr></table></figure><p>The badges use shields.io to pull SVG of the badge and set the text to the dependency&#39;s name and version.</p><p><img src="/blog/images/example-dependencies/badges-markdown.png" alt="The first line of the README.md"></p><p>The rendered README file looks nice</p><p><img src="/blog/images/example-dependencies/badges.png" alt="Rendered README file with CI and version badges"></p><h2><span id="auto-updating-badges">Auto-updating badges</span></h2><p>We have manually set the badges with dependencies, but keeping them up to date manually is too much work. Let&#39;s update them automatically using GitHub Action. I will add another workflow file that should only run when pushing new code to <code>master</code> branch. We can further limit this action to only execute when the commit includes changes to <code>README</code>, <code>package.json</code> or the workflow file itself.</p><figure class="highlight yml"><figcaption><span>.github/workflows/badges.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">badges</span></span><br><span class="line"><span class="comment"># update README badge only if the README file changes</span></span><br><span class="line"><span class="comment"># or if the package.json file changes, or this file changes</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">README.md</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">package.json</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.github/workflows/badges.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Badges</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Update</span> <span class="string">version</span> <span class="string">badges</span> <span class="string">🏷</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npx -p dependency-version-badge update-badge cypress cypress-react-unit-test</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      # commit any changed files</span></span><br><span class="line"><span class="string">      # https://github.com/mikeal/publish-to-github-action</span></span><br><span class="line"><span class="string"></span><span class="attr">      - name:</span> <span class="string">Push</span> <span class="string">any</span> <span class="string">changes</span> <span class="string">to</span> <span class="string">repo</span> <span class="string">📤</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">mikeal/publish-to-github-action@master</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Usually there are no changes and the workflow finishes without pushing any new code</p><p><img src="/blog/images/example-dependencies/no-badge-updates.png" alt="Badges workflow when the versions stay the same"></p><p>But let&#39;s say we change the <code>cypress-react-unit-test</code> version in <code>package.json</code>. We can do it manually to simulate the version change, but normally Renovate would merge a pull request with version bump.</p><figure class="highlight diff"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- "cypress-react-unit-test": "4.2.3"</span></span><br><span class="line"><span class="addition">+ "cypress-react-unit-test": "4.2.2"</span></span><br></pre></td></tr></table></figure><p>The &quot;badges&quot; workflow runs and updates the markdown in the README file. Notice the changed Markdown file in Git status before pushing the change from the GitHub Action back to the repository.</p><p><img src="/blog/images/example-dependencies/badge-update.png" alt="Badges action has changed the README file"></p><p>You can see the automatic commit in the list of commits.</p><p><img src="/blog/images/example-dependencies/commits.png" alt="Commits show README update"></p><p><img src="/blog/images/example-dependencies/badge-commit.png" alt="README update commit shows the updated badge"></p><p>Now the example repository will stay up to date, and make it obvious to our users if the example shown is still applicable.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#examples-examples-examples&quot;&gt;Examples, examples, examples&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#concentrate-on-the-most-impo
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="markdown" scheme="https://glebbahmutov.com/blog/tags/markdown/"/>
    
      <category term="renovate" scheme="https://glebbahmutov.com/blog/tags/renovate/"/>
    
  </entry>
  
  <entry>
    <title>Mocking named TypeScript imports during tests</title>
    <link href="https://glebbahmutov.com/blog/mocking-named-typescript-imports/"/>
    <id>https://glebbahmutov.com/blog/mocking-named-typescript-imports/</id>
    <published>2020-05-20T04:00:00.000Z</published>
    <updated>2020-05-20T14:15:21.818Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Note:</strong> you can find the companion source code in <a href="https://github.com/bahmutov/mock-ts-imports" target="_blank" rel="noopener">bahmutov/mock-ts-imports</a> repository.</p><p>Imagine we have the following 2 TypeScript files.</p><figure class="highlight ts"><figcaption><span>math.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b</span><br></pre></td></tr></table></figure><figure class="highlight ts"><figcaption><span>user.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">'./math'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> compute = <span class="function">(<span class="params">a, b</span>) =&gt;</span> add(a, b)</span><br></pre></td></tr></table></figure><p>Both files use <em>named imports and exports</em> which causes problems trying to stub them from the tests.</p><h2><span id="testing-direct-named-import">Testing direct named import</span></h2><p>Let&#39;s write unit test to confirm the function <code>add</code> works. I will use <a href="https://github.com/avajs/ava" target="_blank" rel="noopener">Ava</a> test runner. To directly load TS spec files (and source code), I will use <code>ts-node</code> and <code>ava-ts</code>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D ava ava-ts typescript ts-node</span></span><br><span class="line">+ ava-ts@0.25.2</span><br><span class="line">+ ts-node@8.10.1</span><br><span class="line">+ ava@3.8.2</span><br><span class="line">+ typescript@3.9.3</span><br></pre></td></tr></table></figure><p>Our first test</p><figure class="highlight ts"><figcaption><span>math-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'ava'</span></span><br><span class="line"><span class="keyword">import</span> &#123;add&#125; <span class="keyword">from</span> <span class="string">'./math'</span></span><br><span class="line"></span><br><span class="line">test(<span class="string">'add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// testing the original function</span></span><br><span class="line">  t.deepEqual(add(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>It passes</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npx ava-ts math-spec.ts</span><br><span class="line"></span><br><span class="line">  1 passed</span><br></pre></td></tr></table></figure><h2><span id="testing-transient-named-import">Testing transient named import</span></h2><p>The module <code>math.ts</code> exports <code>add</code> that module <code>user.ts</code> calls during <code>compute</code> execution. Can we write a test for <code>user.ts</code> that stubs this indirect <code>math.ts add</code> export? Can we write a test where <code>compute</code> calls real <code>add</code>, and another test calls stubbed <code>add</code>?</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// "compute" imports "add" from "./math" using named import</span></span><br><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'ava'</span></span><br><span class="line"><span class="keyword">import</span> &#123; compute &#125; <span class="keyword">from</span> <span class="string">'./user'</span></span><br><span class="line"></span><br><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  stubSomehow(<span class="string">'./math'</span>, <span class="string">'add'</span>).returns(<span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Yes - by using a nice utility <a href="https://github.com/EmandM/ts-mock-imports" target="_blank" rel="noopener">ts-mock-imports</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i ts-mock-imports sinon</span></span><br><span class="line">+ sinon@9.0.2</span><br><span class="line">+ ts-mock-imports@1.3.0</span><br></pre></td></tr></table></figure><p>I am installing <code>ts-mock-imports</code> and its peer dependency <a href="https://sinonjs.org/" target="_blank" rel="noopener">Sinon</a>.</p><p>Let&#39;s mock named imports, even if they are loaded indirectly.</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// "compute" imports "add" from "./math" using named import</span></span><br><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'ava'</span></span><br><span class="line"><span class="keyword">import</span> &#123; compute &#125; <span class="keyword">from</span> <span class="string">'./user'</span></span><br><span class="line"><span class="keyword">import</span> &#123; ImportMock &#125; <span class="keyword">from</span> <span class="string">'ts-mock-imports'</span></span><br><span class="line"><span class="comment">// to mock "./math add" export need to import entire module</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> math <span class="keyword">from</span> <span class="string">'./math'</span></span><br><span class="line"></span><br><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Note that we had to import <code>./math</code> as <code>math</code> object to be able to mock a named import <code>add</code>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx ava-ts user-spec.ts</span></span><br><span class="line"></span><br><span class="line">  2 passed</span><br></pre></td></tr></table></figure><p>Under the hood, the <code>mockFunction</code> uses <a href="https://sinonjs.org/releases/v9.0.2/stubs/" target="_blank" rel="noopener">Sinon stubs</a>.</p><h2><span id="restore-mocks">Restore mocks</span></h2><p>Once mocked, the function <code>math.add</code> will stay mocked until restored.</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'add stays stubbed'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  t.deepEqual(compute(<span class="number">-1</span>, <span class="number">7</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx ava-ts user-spec.ts</span></span><br><span class="line"></span><br><span class="line">  3 passed</span><br></pre></td></tr></table></figure><p>I strongly recommend each test starts by restoring any mocked functions.</p><figure class="highlight ts"><figcaption><span>user-spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(ImportMock.restore)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'real add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no stubbing</span></span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'stubbed add'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// somehow stub "add" from "./math.ts" to return known value like 100</span></span><br><span class="line">  ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test(<span class="string">'add stays stubbed'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  t.deepEqual(compute(<span class="number">-1</span>, <span class="number">7</span>), <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The third test will correctly fail, because the mock <code>add</code> no longer returns 100.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx ava-ts user-spec.ts</span></span><br><span class="line"></span><br><span class="line">  2 passed</span><br><span class="line">  1 failed</span><br><span class="line"></span><br><span class="line">  add stays stubbed</span><br><span class="line"></span><br><span class="line">  /Users/gleb/git/mock-ts-imports/user-spec.ts:22</span><br><span class="line"></span><br><span class="line">   21: test('add stays stubbed', t =&gt; &#123;</span><br><span class="line">   22:   t.deepEqual(compute(-1, 7), 100)</span><br><span class="line">   23: &#125;)</span><br><span class="line"></span><br><span class="line">  Difference:</span><br><span class="line"></span><br><span class="line">  - 6</span><br><span class="line">  + 100</span><br></pre></td></tr></table></figure><p>You can also change and restore individual mock</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'stub and restore'</span>, <span class="function"><span class="params">t</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> stub = ImportMock.mockFunction(math, <span class="string">'add'</span>, <span class="number">100</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">100</span>)</span><br><span class="line">  stub.returns(<span class="number">42</span>)</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">42</span>)</span><br><span class="line">  stub.restore()</span><br><span class="line">  t.deepEqual(compute(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="more-info">More info</span></h2><ul><li><a href="../mocha-and-sinon/">Mocha and Sinon</a></li><li><a href="../lock-down-sinon-stub/">Lock Down Sinon Stub</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; you can find the companion source code in &lt;a href=&quot;https://github.com/bahmutov/mock-ts-imports&quot; target=&quot;_blank&quot; re
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="typescript" scheme="https://glebbahmutov.com/blog/tags/typescript/"/>
    
  </entry>
  
  <entry>
    <title>My Vision for Component Tests in Cypress</title>
    <link href="https://glebbahmutov.com/blog/my-vision-for-component-tests/"/>
    <id>https://glebbahmutov.com/blog/my-vision-for-component-tests/</id>
    <published>2020-04-29T04:00:00.000Z</published>
    <updated>2020-04-29T18:52:42.487Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#example-application">Example application</a></li><li><a href="#the-goal">The Goal</a></li><li><a href="#adding-tests">Adding tests</a></li><li><a href="#code-coverage">Code coverage</a></li><li><a href="#component-test">Component test</a></li><li><a href="#styles">Styles</a></li><li><a href="#testing-the-interface">Testing the interface</a></li><li><a href="#graphql-example">GraphQL example</a></li><li><a href="#components-all-the-way-down">Components all the way down</a></li><li><a href="#benefits">Benefits</a></li><li><a href="#examples">Examples</a></li><li><a href="#future-plans">Future plans</a></li><li><a href="#thank-you">Thank you</a></li></ul><!-- tocstop --><p>I have been talking about framework-specific component testing for ages now. I have even coded a bunch of adaptors like <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a>, <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> and others, that allow mounting individual components into Cypress and run them as full-fledged mini-web applications. While the initial solution was technically ok, due to the way Cypress works it has a long list of issues: React Hooks do not work, styles are often lost, etc.</p><p>I am excited to say that we have an [experimental support][<a href="https://github.com/cypress-io/cypress/releases/tag/v4.5.0]" target="_blank" rel="noopener">https://github.com/cypress-io/cypress/releases/tag/v4.5.0]</a> for a new way of binding test code in Cypress v4.5.0 that seems to solve <em>all known problems</em>. In this blog post I will show how it might work, once we release it.</p><center><strong>⚠️ Warning:</strong> component testing is currently in Alpha release. If you find a problem, please open an issue in the adaptor repo (like <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">bahmutov/cypress-react-unit-test</a>, <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">bahmutov/cypress-vue-unit-test</a>). Use this awesome feature at your own risk.</center><h2><span id="example-application">Example application</span></h2><p>I will take a nice Todo application from blog post <a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-react-to-do-app-with-react-hooks" target="_blank" rel="noopener">How To Build a React To-Do App with React Hooks</a> as the starting point. You can see this application yourself at its original <a href="https://codesandbox.io/s/oj3qm2zq06" target="_blank" rel="noopener">https://codesandbox.io/s/oj3qm2zq06</a> URL.</p><p><img src="/blog/images/components/app-code.png" alt="React Todo App"></p><p>I have downloaded the code from the sandbox to my repo <a href="https://github.com/bahmutov/react-todo-with-hooks" target="_blank" rel="noopener">https://github.com/bahmutov/react-todo-with-hooks</a>; it has a CSS file and two JS files - very compact example.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/repo</span><br><span class="line">  public/</span><br><span class="line">    index.html</span><br><span class="line">  src/</span><br><span class="line">    App.css</span><br><span class="line">    App.js</span><br><span class="line">    index.js</span><br><span class="line">  package.json</span><br></pre></td></tr></table></figure><p>The application is bundled and served using <a href="https://www.npmjs.com/package/react-scripts" target="_blank" rel="noopener">react-scripts</a> which is often used to serve modern React applications.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"react"</span>: <span class="string">"16"</span>,</span><br><span class="line">    <span class="attr">"react-dom"</span>: <span class="string">"16"</span>,</span><br><span class="line">    <span class="attr">"react-scripts"</span>: <span class="string">"3.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"react-scripts start"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"react-scripts build"</span>,</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"react-scripts test"</span>,</span><br><span class="line">    <span class="attr">"eject"</span>: <span class="string">"react-scripts eject"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="the-goal">The Goal</span></h2><p>I have noticed that the application allows us to mark Todo items as completed, but it never allows to &quot;undo&quot; completing an item. Once the task is done, there is no way to get it back to the initial incomplete state.</p><p><img src="/blog/images/components/complete.gif" alt="Completing an item cannot be undone"></p><p>I would like to change &quot;complete&quot; an item into &quot;toggle&quot; an item. But I don&#39;t know the code of the application, so it is dangerous to simply start hacking. We need tests first; and we want to make sure we test the entire application before changing its behavior.</p><h2><span id="adding-tests">Adding tests</span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress</span></span><br><span class="line">+ cypress@4.5.0</span><br></pre></td></tr></table></figure><p>Our first full end-to-end test goes through a typical user story.</p><figure class="highlight js"><figcaption><span>cypress/integration/todo-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="cypress" /&gt;</span></span><br><span class="line">describe(<span class="string">'Todo App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'completes an item'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// base url is stored in "cypress.json" file</span></span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">    <span class="comment">// there are several existing todos</span></span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br><span class="line">    cy.log(<span class="string">'**adding a todo**'</span>)</span><br><span class="line">    cy.get(<span class="string">'.input'</span>).type(<span class="string">'write tests&#123;enter&#125;'</span>)</span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    cy.log(<span class="string">'**completing a todo**'</span>)</span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'write tests'</span>).contains(<span class="string">'button'</span>, <span class="string">'Complete'</span>).click()</span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'write tests'</span>)</span><br><span class="line">      .should(<span class="string">'have.css'</span>, <span class="string">'text-decoration'</span>, <span class="string">'line-through solid rgb(74, 74, 74)'</span>)</span><br><span class="line"></span><br><span class="line">    cy.log(<span class="string">'**removing a todo**'</span>)</span><br><span class="line">    <span class="comment">// due to quarantine, we have to delete an item</span></span><br><span class="line">    <span class="comment">// without completing it</span></span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'Meet friend for lunch'</span>).contains(<span class="string">'button'</span>, <span class="string">'x'</span>).click()</span><br><span class="line">    cy.contains(<span class="string">'.todo'</span>, <span class="string">'Meet friend for lunch'</span>).should(<span class="string">'not.exist'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs and passes</p><p><img src="/blog/images/components/e2e-test.gif" alt="Full Cypress end-to-end test"></p><h2><span id="code-coverage">Code coverage</span></h2><p>Did we test all code paths in our application? The simplest way for us to find out is to measure how much of the application&#39;s code was executed by running this one e2e test. We can follow the <a href="https://on.cypress.io/code-coverage" target="_blank" rel="noopener">Cypress Code Coverage Guide</a> to set up coverage reporting.</p><center>  <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/edgeQZ8UpD0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><ol><li>Instrument the application&#39;s code while running. For any application that uses <code>react-scripts</code> we can use module <a href="https://github.com/cypress-io/instrument-cra" target="_blank" rel="noopener">cypress-io/instrument-cra</a> to do so on the fly.</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D @cypress/instrument-cra</span></span><br><span class="line">+ @cypress/instrument-cra@1.1.0</span><br></pre></td></tr></table></figure><p>When we start the application, we preload this module first - and we will have application&#39;s code instrumented.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"react-scripts -r @cypress/instrument-cra start"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>We need to add <a href="https://github.com/cypress-io/code-coverage" target="_blank" rel="noopener">@cypress/code-coverage</a> to Cypress to merge coverage from tests and save report</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D @cypress/code-coverage</span></span><br><span class="line">+ @cypress/code-coverage@3.1.0</span><br></pre></td></tr></table></figure><p>This plugin should be loaded from the support and plugins files</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'@cypress/code-coverage/support'</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/task'</span>)(on, config)</span><br><span class="line">  <span class="comment">// IMPORTANT to return the config object</span></span><br><span class="line">  <span class="comment">// with the any changed environment variables</span></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Start Cypress again and run the test. You see &quot;Saving coverage from ...&quot; and &quot;Coverage report&quot; messages at the end of the run.</p><p><img src="/blog/images/components/code-coverage-messages.png" alt="Code coverage messages"></p><p>In the folder <code>coverage</code> you will find the report in several formats, let&#39;s open the static HTML one</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> open coverage/lcov-report/index.html</span></span><br></pre></td></tr></table></figure><p>Our single end-to-end test was <em>very effective</em> at covering almost all lines of the application.</p><p><img src="/blog/images/components/code-coverage.png" alt="Total code coverage"></p><p>We can drill down into individual file coverage.</p><p><img src="/blog/images/components/code-coverage-app.png" alt="A single line missed"></p><h2><span id="component-test">Component test</span></h2><p>The line we missed is inside <code>TodoForm</code> component, and it is kind of hard to confirm its behavior. We can easily write an end-to-end test that tries to &quot;enter&quot; empty input.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'input'</span>).type(<span class="string">'&#123;enter&#125;'</span>)</span><br><span class="line"><span class="comment">// there are still 3 todos</span></span><br><span class="line">cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>BUT it does not confirm the property <code>addTodo</code> is not called at all. We really want to test the component, not the entire application.</p><p>Let&#39;s write a component test.</p><ol><li>Install <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test v4+</a></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress-react-unit-test</span></span><br><span class="line">+ @cypress-react-unit-test@4.0.0</span><br></pre></td></tr></table></figure><ol start="2"><li>In <code>cypress.json</code> enable <a href="https://on.cypress.io/experimental" target="_blank" rel="noopener">experimental Cypress feature</a></li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">  <span class="attr">"testFiles"</span>: <span class="string">"**/*spec.js"</span>,</span><br><span class="line">  <span class="attr">"experimentalComponentTesting"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"componentFolder"</span>: <span class="string">"src"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>While end-to-end tests reside by default in <code>cypress/integration</code> folder, let&#39;s place component tests right alongside the source code in <code>src</code> folder. We will filter the spec files using <code>&quot;testFiles&quot;: &quot;**/*spec.js&quot;</code> parameter.</p><ol start="3"><li>Load <code>cypress-react-unit-test</code> from the support and plugins files</li></ol><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/support'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'cypress-react-unit-test/plugins/cra-v3'</span>)(on, config)</span><br><span class="line">  <span class="comment">// IMPORTANT to return the config object</span></span><br><span class="line">  <span class="comment">// with the any changed environment variables</span></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Unlike end-to-end tests, the component specs must be bundled the same way as the application code is. Thus we have added <a href="https://github.com/bahmutov/cypress-react-unit-test/blob/master/docs/recipes.md" target="_blank" rel="noopener">multiple plugins helpers</a> that find and use the bundling options your application is using. In this case, Cypress will find the Webpack config from <code>react-scripts</code> module and will use it.</p><p>Let&#39;s write component test!</p><figure class="highlight js"><figcaption><span>src/TodoForm.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span></span><br><span class="line"><span class="keyword">import</span> &#123;TodoForm&#125; <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'TodoForm'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'ignores empty input'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> addTodo = cy.stub()</span><br><span class="line">    mount(<span class="xml"><span class="tag">&lt;<span class="name">TodoForm</span> <span class="attr">addTodo</span>=<span class="string">&#123;addTodo&#125;</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">    cy.get('input').type('&#123;enter&#125;')</span></span><br><span class="line"><span class="xml">    .then(() =&gt; &#123;</span></span><br><span class="line"><span class="xml">      expect(addTodo).not.have.been.called</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    cy.get('input').type('hello there&#123;enter&#125;')</span></span><br><span class="line"><span class="xml">    .then(() =&gt; &#123;</span></span><br><span class="line"><span class="xml">      expect(addTodo).to.be.calledWith('hello there')</span></span><br><span class="line"><span class="xml">    &#125;)</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure><p>The component test directly imports <code>TodoForm</code> from the application code and mounts it using <code>mount</code> method from the <code>cypress-react-unit-test</code>. Once the component is mounted, it runs as a &quot;mini&quot; web application. We can use normal Cypress commands against it! Think of <code>mount</code> as <code>cy.visit</code> for components.</p><p><img src="/blog/images/components/todo-form-test.gif" alt="TodoForm component test"></p><p>You can see the component run inside Cypress iframe (where a regular web application usually runs during end-to-end test). You can interact with the component, inspect it using DevTools, see how it behaves using time-traveling debugger - all Cypress benefits apply both to end-to-end tests and to component tests. Plus code coverage is included by default!</p><h2><span id="styles">Styles</span></h2><p>When mounting a component, you might want to apply additional styles to make it look the same as in real application. The <code>mount</code> <a href="https://github.com/bahmutov/cypress-react-unit-test#options" target="_blank" rel="noopener">command options</a> let you specify inline style, CSS filename or external stylesheets. For example, here is the <code>Todo</code> component test.</p><figure class="highlight js"><figcaption><span>src/Todo.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Todo&#125; <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line">it(<span class="string">'renders new item'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    text: <span class="string">'test item'</span>,</span><br><span class="line">    isCompleted: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// application loads Bulma library from public/index.html</span></span><br><span class="line">  <span class="comment">// so let's load it from the component test too</span></span><br><span class="line">  mount(</span><br><span class="line">    &lt;Todo todo=&#123;todo&#125; /&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">      stylesheets: [</span><br><span class="line">        <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.todo button'</span>, <span class="string">'Complete'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/todo1.png" alt="First Todo test"></p><p>The buttons looks &quot;normal&quot;, but the entire component still does not look the same - because our styles come from <code>src/App.css</code> and require certain DOM structure. Let&#39;s recreate the structure and load additional CSS file in our test.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'renders with styles'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    text: <span class="string">'test item'</span>,</span><br><span class="line">    isCompleted: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> TestTodo = <span class="function"><span class="params">()</span> =&gt;</span> &lt;div className=<span class="string">"app"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">Todo</span> <span class="attr">todo</span>=<span class="string">&#123;todo&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  mount(</span><br><span class="line">    &lt;TestTodo /&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">      stylesheets: [</span><br><span class="line">        <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">      ],</span><br><span class="line">      cssFile: <span class="string">'src/App.css'</span></span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.todo button'</span>, <span class="string">'Complete'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/todo2.png" alt="Second Todo test"></p><p>Looks good.</p><h2><span id="testing-the-interface">Testing the interface</span></h2><p>As I <a href="https://www.youtube.com/watch?v=5FnalKRjpZk&amp;amp=&amp;t=0s&amp;amp=&amp;index=5" target="_blank" rel="noopener">argued before</a> - a component test is just a unit test where props are inputs and side effects like DOM, network calls, etc are outputs. Let&#39;s confirm that Todo component calls the <code>removeTodo</code> prop when the user clicks &quot;Remove&quot; button.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'deletes an item'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    text: <span class="string">'test item'</span>,</span><br><span class="line">    isCompleted: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> removeTodo = cy.stub().as(<span class="string">'remove'</span>)</span><br><span class="line"></span><br><span class="line">  mount(</span><br><span class="line">    &lt;Todo todo=&#123;todo&#125; index=&#123;<span class="number">123</span>&#125; removeTodo=&#123;removeTodo&#125; /&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">      stylesheets: [</span><br><span class="line">        <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  cy.contains(<span class="string">'.todo'</span>, <span class="string">'test item'</span>)</span><br><span class="line">    .find(<span class="string">'[data-cy="remove"]'</span>).click()</span><br><span class="line">  cy.get(<span class="string">'@remove'</span>).should(<span class="string">'have.been.calledWith'</span>, <span class="number">123</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/todo3.png" alt="Removing todo"></p><h2><span id="graphql-example">GraphQL example</span></h2><p>Notice how we directly passed a stub into the component as a property - because the component &quot;lives&quot; right inside the spec. By having direct access to the component, you can do amazing things - like combine mock and live GraphQL calls, see <a href="https://github.com/bahmutov/test-apollo" target="_blank" rel="noopener">bahmutov/test-apollo</a></p><figure class="highlight js"><figcaption><span>test-apollo/src/Library.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Library, GET_BOOKS&#125; <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"><span class="keyword">import</span> &#123; MockedProvider &#125; <span class="keyword">from</span> <span class="string">'@apollo/react-testing'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// mocking GraphQL requests using</span></span><br><span class="line"><span class="comment">// https://www.apollographql.com/docs/react/development-testing/testing/#mockedprovider</span></span><br><span class="line">describe(<span class="string">'Library'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.fixture(<span class="string">'books'</span>).as(<span class="string">'books'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'shows loading while making the query'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// delays the response by 3 seconds</span></span><br><span class="line">    <span class="keyword">const</span> mocks = [</span><br><span class="line">      &#123;</span><br><span class="line">        request: &#123;</span><br><span class="line">          query: GET_BOOKS</span><br><span class="line">        &#125;,</span><br><span class="line">        result: <span class="keyword">this</span>.books,</span><br><span class="line">        delay: <span class="number">3000</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">    mount(</span><br><span class="line">      &lt;MockedProvider mocks=&#123;mocks&#125; addTypename=&#123;<span class="literal">false</span>&#125;&gt;</span><br><span class="line">        &lt;Library /&gt;</span><br><span class="line">      &lt;<span class="regexp">/MockedProvider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 😀 compare declarative testing vs promise waits in</span></span><br><span class="line">    // https://www.apollographql.com/docs/react/development-testing/testing/#testing-final-state</span><br><span class="line">    cy.contains(<span class="string">'Loading ...'</span>).should(<span class="string">'be.visible'</span>)</span><br><span class="line">    cy.get(<span class="string">'[data-cy=book]'</span>).should(<span class="string">'have.length'</span>, <span class="number">2</span>)</span><br><span class="line">    cy.contains(<span class="string">'Loading ...'</span>).should(<span class="string">'not.exist'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/components/graphql-test.gif" alt="Mocking GraphQL with delay component test"></p><h2><span id="components-all-the-way-down">Components all the way down</span></h2><p>Component testing can work with components of any size. We have tested <code>TodoForm</code> and <code>Todo</code> components, let&#39;s test the top-level <code>App</code> component.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">'cypress-react-unit-test'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    mount(</span><br><span class="line">      &lt;App /&gt;,</span><br><span class="line">      &#123;</span><br><span class="line">        stylesheets: [</span><br><span class="line">          <span class="string">'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'works'</span>, () =&gt; &#123;</span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br><span class="line">    cy.get(<span class="string">'input.input'</span>).type(<span class="string">'Test with Cypress&#123;enter&#125;'</span>)</span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">4</span>)</span><br><span class="line">      .contains(<span class="string">'Meet friend for lunch'</span>)</span><br><span class="line">      .find(<span class="string">'[data-cy=remove]'</span>).click()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cy.get(<span class="string">'.todo'</span>).should(<span class="string">'have.length'</span>, <span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs and looks ... almost like the complete application!</p><p><img src="/blog/images/components/app-test.gif" alt="App component test"></p><p>Component testing gives you a flexibility over the scope of the code you want to test. In addition to testing your application as a whole via end-to-end tests you can test a subset of the application &quot;tree&quot;. If your application has the top level authentication that is hard to bypass from an end-to-end test - you can test the component that sits right under the authentication provider.</p><p>Finally, while we are testing components, let&#39;s test a few functions using unit tests. While this was always possible in Cypress, component testing mounting mode makes it much closer to testing the real code, because bundling the component spec is done using your application&#39;s settings.</p><figure class="highlight js"><figcaption><span>src/App.spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> App, &#123;toggleOneTodo&#125; <span class="keyword">from</span> <span class="string">"./App"</span></span><br><span class="line">describe(<span class="string">'App'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'toggles correctly'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> todos = [&#123;</span><br><span class="line">      isCompleted: <span class="literal">false</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      isCompleted: <span class="literal">false</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      isCompleted: <span class="literal">false</span></span><br><span class="line">    &#125;]</span><br><span class="line">    <span class="keyword">const</span> newTodos = toggleOneTodo(todos, <span class="number">2</span>)</span><br><span class="line">    expect(newTodos).to.deep.equal([&#123;</span><br><span class="line">        isCompleted: <span class="literal">false</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        isCompleted: <span class="literal">false</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        isCompleted: <span class="literal">true</span></span><br><span class="line">      &#125;])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>From the smallest units of code to the largest components - you control the scale of <em>what</em> you want to test.</p><h2><span id="benefits">Benefits</span></h2><p>In my completely biased personal opinion, Cypress component testing using the real browser has many advantages</p><table><thead><tr><th>Feature</th><th>Cypress + <code>cypress-X-unit-test</code></th></tr></thead><tbody><tr><td>Test runs in real browser</td><td>✅</td></tr><tr><td>Cross-platform</td><td>Chrome / Firefox / Microsoft Edge</td></tr><tr><td>Uses full mount</td><td>✅</td></tr><tr><td>Test speed</td><td>as fast as the app works in the browser</td></tr><tr><td>Test can use additional plugins</td><td>use any <a href="https://on.cypress.io/plugins" target="_blank" rel="noopener">Cypress plugin</a></td></tr><tr><td>Test can interact with component</td><td>use any <a href="https://on.cypress.io/api" target="_blank" rel="noopener">Cypress command</a></td></tr><tr><td>Debugging</td><td>use browser DevTools, Cypress time-traveling debugger</td></tr><tr><td>Re-run tests on file or test change</td><td>✅</td></tr><tr><td>Test output on CI</td><td>terminal, screenshots, videos</td></tr><tr><td>Tests can be run in parallel</td><td>✅ via <a href="https://on.cypress.io/parallelization" target="_blank" rel="noopener">parallelization</a></td></tr><tr><td>Test against interface</td><td>✅ and can use <code>@testing-library/cypress</code></td></tr><tr><td>Spying and mocking</td><td>Sinon library</td></tr><tr><td>Code coverage</td><td>✅</td></tr><tr><td>Visual testing</td><td>✅ via <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">visual plugins</a></td></tr></tbody></table><h2><span id="examples">Examples</span></h2><p>We have forked a number of 3rd party projects to confirm component testing works.</p><table><thead><tr><th>Repo</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://github.com/bahmutov/try-cra-with-unit-test" target="_blank" rel="noopener">try-cra-with-unit-test</a></td><td>Hello world initialized with CRAv3</td></tr><tr><td><a href="https://github.com/bahmutov/try-cra-app-typescript" target="_blank" rel="noopener">try-cra-app-typescript</a></td><td>Hello world initialized with CRAv3 <code>--typescript</code></td></tr><tr><td><a href="https://github.com/bahmutov/react-todo-with-hooks" target="_blank" rel="noopener">react-todo-with-hooks</a></td><td>Modern web application using hooks</td></tr><tr><td><a href="https://github.com/bahmutov/test-redux-examples" target="_blank" rel="noopener">test-redux-examples</a></td><td>Example apps copies from official Redux repo and tested as components</td></tr><tr><td><a href="https://github.com/bahmutov/test-react-hooks-animations" target="_blank" rel="noopener">test-react-hooks-animations</a></td><td>Testing React springs fun blob animation</td></tr><tr><td><a href="https://github.com/bahmutov/test-mdx-example" target="_blank" rel="noopener">test-mdx-example</a></td><td>Example testing MDX components using Cypress</td></tr><tr><td><a href="https://github.com/bahmutov/test-apollo" target="_blank" rel="noopener">test-apollo</a></td><td>Component testing an application that uses Apollo GraphQL library</td></tr><tr><td><a href="https://github.com/bahmutov/test-xstate-react" target="_blank" rel="noopener">test-xstate-react</a></td><td>XState component testing using Cypress</td></tr><tr><td><a href="https://github.com/bahmutov/test-react-router-v5" target="_blank" rel="noopener">test-react-router-v5</a></td><td>A few tests of React Router v5</td></tr><tr><td><a href="https://github.com/bahmutov/test-material-ui" target="_blank" rel="noopener">test-material-ui</a></td><td>Testing Material UI components: date pickers, lists, autocomplete</td></tr><tr><td><a href="https://github.com/bahmutov/test-d3-react-gauge" target="_blank" rel="noopener">test-d3-react-gauge</a></td><td>Testing React D3 gauges</td></tr><tr><td><a href="https://github.com/bahmutov/storybook-code-coverage" target="_blank" rel="noopener">storybook-code-coverage</a></td><td>Example app where we get 100% code coverage easily with a single integration spec and a few component specs, replacing <a href="https://dev.to/penx/combining-storybook-cypress-and-jest-code-coverage-4pa5" target="_blank" rel="noopener">several tools</a></td></tr><tr><td><a href="https://github.com/bahmutov/react-loading-skeleton" target="_blank" rel="noopener">react-loading-skeleton</a></td><td>One to one Storybook tests for React skeleton components. Uses local <code>.babelrc</code> settings without Webpack config</td></tr><tr><td><a href="https://github.com/bahmutov/test-swr" target="_blank" rel="noopener">test-swr</a></td><td>Component test for <a href="https://github.com/zeit/swr" target="_blank" rel="noopener">Zeit SWR</a> hooks for remote data fetching</td></tr></tbody></table><p>To find more examples, see GitHub topic <a href="https://github.com/topics/cypress-react-unit-test-example" target="_blank" rel="noopener">cypress-react-unit-test-example</a></p><h2><span id="future-plans">Future plans</span></h2><p>We have already released new versions of <a href="https://github.com/bahmutov/cypress-react-unit-test" target="_blank" rel="noopener">cypress-react-unit-test</a> and <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> and plan to upgrade other framework adaptors (Angular, Svelte, etc) to be compatible with <code>experimentalComponentTesting: true</code> mode.</p><h2><span id="thank-you">Thank you</span></h2><p>Special thank you 👏 to <a href="https://twitter.com/dmtrKovalenko" target="_blank" rel="noopener">Dmitriy Kovalenko @dmtrKovalenko</a> for making Cypress Test Runner and React adaptor work through these PRs <a href="https://github.com/cypress-io/cypress/pull/5923" target="_blank" rel="noopener">#5923</a> and <a href="https://github.com/bahmutov/cypress-react-unit-test/pull/108" target="_blank" rel="noopener">#108</a>. They have removed the technical limitations that prevented React Hooks, component styles and other features from working correctly inside the component tests.</p><p>Another big shout out goes to <a href="https://twitter.com/_JessicaSachs" target="_blank" rel="noopener">Jessica Sachs @_JessicaSachs</a> for working on component testing support in <a href="https://github.com/bahmutov/cypress-vue-unit-test" target="_blank" rel="noopener">cypress-vue-unit-test</a> 👏.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#example-application&quot;&gt;Example application&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-goal&quot;&gt;The Goal&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Cleaning Up Space on Development Machine</title>
    <link href="https://glebbahmutov.com/blog/cleaning-up-space/"/>
    <id>https://glebbahmutov.com/blog/cleaning-up-space/</id>
    <published>2020-04-10T04:00:00.000Z</published>
    <updated>2020-04-09T15:48:22.684Z</updated>
    
    <content type="html"><![CDATA[<p>If you run out of space on your development machine, you probably have old Docker images sitting around, a giant number of <code>node_modules</code> and maybe a number of old versions of Cypress test runner that you don&#39;t need anymore. Let&#39;s clean everything up.</p><h2><span id="pruning-docker">Pruning Docker</span></h2><p>Let&#39;s <a href="https://docs.docker.com/config/pruning/" target="_blank" rel="noopener">prune Docker images</a> first. You can see how many images you have locally and how much space each takes with</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker images</span><br></pre></td></tr></table></figure><p>We can remove all image not currently used that were created more than 24 hours ago:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker image prune -a --filter <span class="string">"until=24h"</span></span><br><span class="line">WARNING! This will remove all images without at least one container associated to them.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br><span class="line"></span><br><span class="line">Deleted Images:</span><br><span class="line">untagged: node:12.4.0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Total reclaimed space: 31.17GB</span><br></pre></td></tr></table></figure><p>Next you want to look at the stopped Docker containers - they are NOT deleted by default.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br></pre></td></tr></table></figure><p>Remove them</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker container prune</span><br><span class="line">WARNING! This will remove all stopped containers.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br><span class="line">...</span><br><span class="line">Total reclaimed space: 8.155GB</span><br></pre></td></tr></table></figure><h2><span id="cleaning-node_modules">Cleaning node_modules</span></h2><p>NPM node modules are like a black hole - they weigh a lot and nothing escapes. You can quickly see how much they take on your disk using <a href="https://github.com/voidcosmos/npkill" target="_blank" rel="noopener">npkill</a> utility.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -g npkill</span><br><span class="line"><span class="comment"># run npkill from the root folder or from the folder with</span></span><br><span class="line"><span class="comment"># projects that have node_modules</span></span><br><span class="line">$ npkill</span><br></pre></td></tr></table></figure><h2><span id="remove-old-folders">Remove old folders</span></h2><p>You can list the folders by the last access time with:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ltu</span><br><span class="line">total 696</span><br><span class="line">-rw-r--r--   1 gleb  staff  344501 Apr  9 11:02 the-dark-knight.css</span><br><span class="line">drwxr-xr-x  39 gleb  staff    1248 Apr  9 11:02 webamp</span><br><span class="line">drwxr-xr-x  22 gleb  staff     704 Apr  9 11:02 circleci-orb</span><br><span class="line">drwxr-xr-x  41 gleb  staff    1312 Apr  9 11:02 cypress-services</span><br><span class="line">drwxr-xr-x  11 gleb  staff     352 Apr  9 11:02 try-percy-agent-as-npm-module</span><br><span class="line">drwxr-xr-x  15 gleb  staff     480 Apr  9 11:02 <span class="built_in">test</span>-react-router-v5</span><br><span class="line">drwxr-xr-x  14 gleb  staff     448 Apr  9 11:02 hasura-example</span><br><span class="line">drwxr-xr-x  19 gleb  staff     608 Apr  9 11:02 cypress-vue-unit-test</span><br><span class="line">...</span><br><span class="line">drwxr-xr-x  18 gleb  staff     576 Mar 26  2019 cypress-angular-unit-test</span><br><span class="line">drwxr-xr-x   2 gleb  staff      64 Mar 26  2019 cypress-blog-tests</span><br><span class="line">drwxr-xr-x   6 gleb  staff     192 Mar 26  2019 cypress-colors</span><br><span class="line">drwxr-xr-x  18 gleb  staff     576 Mar 26  2019 cypress-core-marta</span><br><span class="line">drwxr-xr-x  12 gleb  staff     384 Mar 26  2019 cypress-credentials</span><br><span class="line">drwxr-xr-x  11 gleb  staff     352 Mar 26  2019 cypress-dark-example</span><br></pre></td></tr></table></figure><p>You can probably delete the last folders - since you only accessed them a very long time ago.</p><h2><span id="folder-size">Folder size</span></h2><p>On Mac I really enjoy using <code>du</code> utility. For example, you can see the total folder size or top level plus first sublevel</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># print just the total "github-action" folder size in human format (Megabytes)</span></span><br><span class="line">$ du -h -d 0 github-action</span><br><span class="line">459Mgithub-action</span><br><span class="line"></span><br><span class="line"><span class="comment"># print the total size of the folder "github-action"</span></span><br><span class="line"><span class="comment"># and sizes of its immediate subfolders</span></span><br><span class="line">$ du -h -d 1 github-action</span><br><span class="line">1.4Mgithub-action/dist</span><br><span class="line">228Kgithub-action/images</span><br><span class="line"> 60Mgithub-action/node_modules</span><br><span class="line">377Mgithub-action/examples</span><br><span class="line"> 40Kgithub-action/.github</span><br><span class="line"> 21Mgithub-action/.git</span><br><span class="line">4.0Kgithub-action/.vscode</span><br><span class="line">459Mgithub-action</span><br></pre></td></tr></table></figure><h2><span id="mac-users-tip">Mac users tip</span></h2><p>In Finder you can select and permanently delete files (without going through the Trash app) using <code>Option</code> + <code>Command</code> + <code>Delete</code> combination.</p><p>From the terminal I recommend using <a href="https://github.com/sindresorhus/trash-cli" target="_blank" rel="noopener">trash-cli</a> that is safer to use than <code>rm</code>. <code>trash-cli</code> moves files to Trash so they can be restored.</p><h2><span id="cleaning-old-cypress-binaries">Cleaning old Cypress binaries</span></h2><p>Every time you install Cypress with <code>npm install cypress</code> it downloads NPM package <code>cypress</code> and stores it in the local <code>node_modules</code> folder. Then this NPM package runs its post-install script which checks if you need to download version <code>x.y.z</code> of the Cypress Electron-built binary. These binaries are stored in a central place on your machine to avoid re-downloading the same binary version again and again.</p><p>You can see where the binaries are stored:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/git/cypress-example-todomvc-redux on master</span><br><span class="line">$ npx cypress cache path</span><br><span class="line">/Users/gleb/Library/Caches/Cypress</span><br></pre></td></tr></table></figure><p>And the cached versions</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ npx cypress cache list</span><br><span class="line">┌─────────┬──────────────┐</span><br><span class="line">│ version │ last used    │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.0.1   │ 2 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.0.2   │ 6 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.0.3   │ 2 years ago  │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.2.0   │ 3 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.4.0   │ 6 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.4.1   │ 13 days ago  │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 3.5.0   │ 5 months ago │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">...</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 4.2.1   │ 10 days ago  │</span><br><span class="line">├─────────┼──────────────┤</span><br><span class="line">│ 4.3.0   │ 4 days ago   │</span><br><span class="line">└─────────┴──────────────┘</span><br></pre></td></tr></table></figure><p>Unfortunately, Cypress NPM modules does not have <a href="https://github.com/cypress-io/cypress/issues/5972" target="_blank" rel="noopener"><code>cypress cache prune</code> command yet</a>, so you would need to delete the old folders manually. Let&#39;s see the folders - they are all named <code>/path/to/cache/x.y.z</code>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ltu /Users/gleb/Library/Caches/Cypress</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x  4 gleb  staff  128 Apr  9 10:46 4.2.1</span><br><span class="line">drwxr-xr-x  5 gleb  staff  160 Apr  6 19:23 3.8.2</span><br><span class="line">drwxr-xr-x  4 gleb  staff  128 Mar 31 14:26 4.3.0</span><br><span class="line">drwxr-xr-x  4 gleb  staff  128 Mar 16 17:07 4.2.0</span><br><span class="line">...</span><br><span class="line">drwxr-xr-x  3 gleb  staff   96 Mar 15  2019 3.2.0</span><br><span class="line">drwxr-xr-x  3 gleb  staff   96 Jul  9  2018 3.0.2</span><br><span class="line">drwxr-xr-x  3 gleb  staff   96 Jun  3  2018 3.0.1</span><br></pre></td></tr></table></figure><p>Each folder is quite large - unzipped Cypress is big!</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ du -h -d 0 /Users/gleb/Library/Caches/Cypress/4.0.0</span><br><span class="line">546M/Users/gleb/Library/Caches/Cypress/4.0.0</span><br></pre></td></tr></table></figure><p>Let&#39;s remove all cached Cypress v3 versions - that should free up some space!</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf /Users/gleb/Library/Caches/Cypress/3*</span><br></pre></td></tr></table></figure><p>Much better.</p><p><strong>Tip:</strong> if you need to re-install a Cypress binary version you have just deleted, run this command from the project that installed it:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx cypress install</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;If you run out of space on your development machine, you probably have old Docker images sitting around, a giant number of &lt;code&gt;node_mod
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="nodejs" scheme="https://glebbahmutov.com/blog/tags/nodejs/"/>
    
      <category term="docker" scheme="https://glebbahmutov.com/blog/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>How To Update Only Some Dependencies Using Renovate App</title>
    <link href="https://glebbahmutov.com/blog/whitelist-renovate/"/>
    <id>https://glebbahmutov.com/blog/whitelist-renovate/</id>
    <published>2020-03-31T04:00:00.000Z</published>
    <updated>2020-03-31T17:25:17.869Z</updated>
    
    <content type="html"><![CDATA[<p>I have a common situation - in an example repo like <a href="https://github.com/cypress-io/netlify-plugin-cypress-example" target="_blank" rel="noopener">https://github.com/cypress-io/netlify-plugin-cypress-example</a> we have lots of dependencies, but we are interested only in keeping <em>our Cypress</em> dependencies up to date. In this blog post I will show how to disable all package dependencies and then whitelist just a few ones to be checked.</p><p>I have set up repository <a href="https://github.com/bahmutov/renovate-update-single-module-example" target="_blank" rel="noopener">bahmutov/renovate-update-single-module-example</a> to show this in action. There are 2 dependencies: <code>debug</code> and <code>chalk</code>, but I am only interested in keeping <code>debug</code> up-to-date. Here is the full <a href="https://github.com/bahmutov/renovate-update-single-module-example/blob/master/renovate.json" target="_blank" rel="noopener">renovate.json</a> file</p><figure class="highlight json"><figcaption><span>renovate.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"config:base"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"enabledManagers"</span>: [<span class="string">"npm"</span>],</span><br><span class="line">  <span class="attr">"packageRules"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"packagePatterns"</span>: [<span class="string">"*"</span>],</span><br><span class="line">      <span class="attr">"excludePackagePatterns"</span>: [<span class="string">"debug"</span>],</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Thus we disable all package updates, except <code>debug</code> using <a href="https://docs.renovatebot.com/configuration-options/#excludepackagepatterns" target="_blank" rel="noopener">excludePackagePatterns</a> option, found in <a href="https://docs.renovatebot.com/" target="_blank" rel="noopener">Renovate Docs</a>.</p><p>If we go to <a href="https://app.renovatebot.com/dashboard" target="_blank" rel="noopener">Renovate Dashboard</a> (access is private to the owner of the Renovate app) we can see our check jobs.</p><p><img src="/blog/images/whitelist-renovate/dashboard.png" alt="Renovate Dashboard"></p><p>Click on any build, and in the DEBUG logs you can search for a module and see if it was disabled.</p><p><img src="/blog/images/whitelist-renovate/disabled.png" alt="Disabled chalk module"></p><h2><span id="read-more">Read more</span></h2><ul><li><a href="https://glebbahmutov.com/blog/zeit-now-renovate-and-app/">Zeit Now GitHub app + Renovate app + Cypress tests = 💝</a></li><li><a href="https://glebbahmutov.com/blog/renovate-app/">Painless Dependency Upgrades with Renovate App</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I have a common situation - in an example repo like &lt;a href=&quot;https://github.com/cypress-io/netlify-plugin-cypress-example&quot; target=&quot;_blank
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="renovate" scheme="https://glebbahmutov.com/blog/tags/renovate/"/>
    
  </entry>
  
  <entry>
    <title>Example CI configs</title>
    <link href="https://glebbahmutov.com/blog/example-ci-configs/"/>
    <id>https://glebbahmutov.com/blog/example-ci-configs/</id>
    <published>2020-03-30T04:00:00.000Z</published>
    <updated>2020-05-27T16:05:16.827Z</updated>
    
    <content type="html"><![CDATA[<p>Each snippet typically installs dependencies (with caching), runs tests and publishes new version to NPM and GitHub using <a href="https://github.com/semantic-release/semantic-release" target="_blank" rel="noopener">semantic-release</a>.</p><h2><span id="github-actions">GitHub Actions</span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Install</span> <span class="string">NPM</span> <span class="string">dependencies</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Run</span> <span class="string">tests</span> <span class="string">🧪</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Show</span> <span class="string">GitHub</span> <span class="string">variables</span> <span class="string">📊</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">github-demo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Semantic</span> <span class="string">Release</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cycjimmy/semantic-release-action@v2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          NPM_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.NPM_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Example repositories <a href="https://github.com/bahmutov/print-env" target="_blank" rel="noopener">print-env</a>, <a href="https://github.com/bahmutov/make-empty-github-commit" target="_blank" rel="noopener">make-empty-github-commit</a>.</p><p>Read more about GitHub Actions in <a href="../trying-github-actions/">Trying GitHub Actions</a> blog post. If you are doing Cypress End-to-end tests, I recommend using <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">Cypress GitHub Action</a></p><h2><span id="circleci">CircleCI</span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"><span class="attr">orbs:</span></span><br><span class="line">  <span class="comment"># Circle Node orb makes it simple to cache dependencies</span></span><br><span class="line">  <span class="comment"># https://circleci.com/orbs/registry/orb/circleci/node</span></span><br><span class="line"><span class="attr">  node:</span> <span class="string">circleci/node@1.1</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    executor:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">node/default</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">'12'</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">checkout</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node/with-cache:</span></span><br><span class="line"><span class="attr">          steps:</span></span><br><span class="line"><span class="attr">            - run:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">install</span> <span class="string">dependencies</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">                command:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">run</span> <span class="string">tests</span> <span class="string">🧪</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">e2e</span></span><br><span class="line"><span class="attr">      - run:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">NPM</span> <span class="string">publish</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">semantic-release</span></span><br></pre></td></tr></table></figure><p>Example repositories <a href="https://github.com/bahmutov/term-to-html" target="_blank" rel="noopener">term-to-html</a></p><p>If you are doing Cypress End-to-end tests, I recommend using <a href="https://github.com/cypress-io/circleci-orb" target="_blank" rel="noopener">Cypress CircleCI Orb</a></p><h2><span id="emoji">Emoji</span></h2><p>In the code samples above I am using emoji to quickly see each step.</p><table><thead><tr><th>Emoji</th><th>Step</th></tr></thead><tbody><tr><td><h3><span id>🛎</span></h3></td><td>Code check out from the repo</td></tr><tr><td><h3><span id>📦</span></h3></td><td>Installing and caching dependencies</td></tr><tr><td><h3><span id>🧹</span></h3></td><td>Linting source code</td></tr><tr><td><h3><span id>🧩</span></h3></td><td>Checking types, for example using <code>tsc --noEmit</code></td></tr><tr><td><h3><span id>💅</span></h3></td><td>Running <a href="./configure-prettier-in-vscode/">Prettier formatter</a></td></tr><tr><td><h3><span id>🚦</span></h3></td><td>Some sanity check before continuing</td></tr><tr><td><h3><span id>🏗</span></h3></td><td>Building application</td></tr><tr><td><h3><span id>🚛</span></h3></td><td>Moving or preparing application</td></tr><tr><td><h3><span id>🗑</span></h3></td><td>Delete file or folder</td></tr><tr><td><h3><span id>🧪</span></h3></td><td>Running tests</td></tr><tr><td><h3><span id>💨</span></h3></td><td>Running smoke tests</td></tr><tr><td><h3><span id>📊</span></h3></td><td>Running a demo step</td></tr><tr><td><h3><span id>📈</span></h3></td><td>Check code coverage</td></tr><tr><td><h3><span id>🚀</span></h3></td><td>Releasing a new version</td></tr></tbody></table><p>Here is how it looks in GitHub Actions</p><p><img src="/blog/images/ci-configs/gh-passed.png" alt="Emoji in GitHub Actions"></p><p><strong>Note:</strong> please do not use emoji in the <em>job names</em> - otherwise your GitHub commit status checks will <a href="https://github.community/t5/How-to-use-Git-and-GitHub/Emojicon-Unicode-symbols-are-not-supported-in-commit-status/td-p/5435" target="_blank" rel="noopener">stop working</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Each snippet typically installs dependencies (with caching), runs tests and publishes new version to NPM and GitHub using &lt;a href=&quot;https:
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="ci" scheme="https://glebbahmutov.com/blog/tags/ci/"/>
    
  </entry>
  
  <entry>
    <title>Testing Sentry Call with Cypress</title>
    <link href="https://glebbahmutov.com/blog/testing-sentry-with-cypress/"/>
    <id>https://glebbahmutov.com/blog/testing-sentry-with-cypress/</id>
    <published>2020-03-28T04:00:00.000Z</published>
    <updated>2020-03-29T23:17:45.493Z</updated>
    
    <content type="html"><![CDATA[<p>I love using <a href="https://sentry.io/welcome/" target="_blank" rel="noopener">Sentry</a> for tracking errors in my web applications. Recently I have added crash reporting to our open source <a href="https://github.com/350-mass-cambridge-somerville/350-actions-client" target="_blank" rel="noopener">350-mass-cambridge-somerville/350-actions-client</a> project in pull request <a href="https://github.com/350-mass-cambridge-somerville/350-actions-client/pull/24" target="_blank" rel="noopener">#24</a> - see the app at <a href="https://www.maclimateactions.com/" target="_blank" rel="noopener">https://www.maclimateactions.com/</a>.</p><p>The entire web application is tested using Cypress - let&#39;s validate that the app is sending a crash report to Sentry service using an end-to-end test too. Let&#39;s start a placeholder test that opens the app and does nothing.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'current action'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.server()</span><br><span class="line">    cy.route(<span class="string">'/actioncards/latest/'</span>, <span class="string">'fixture:latest'</span>)</span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">    <span class="comment">// check the page - should have info from the stubbed response</span></span><br><span class="line">    <span class="comment">// loaded from cypress/fixtures/latest.json</span></span><br><span class="line">    cy.contains(<span class="string">'Action Card 23'</span>).should(<span class="string">'be.visible'</span>)</span><br><span class="line">    cy.get(<span class="string">'[data-cy=action-check-display]'</span>).should(<span class="string">'have.length'</span>, <span class="number">6</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it.only(<span class="string">'sends an error to Sentry'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// TODO write test commands</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Once the test runs and stops, open the DevTools inside Cypress. Switch to the application&#39;s context using a drop down. A nice trick to throw an unhandled exception <em>in the application, and not in the DevTools</em> it to make it asynchronous - for example by using <code>setTimeout</code> function. You can do <code>setTimeout(() =&gt; { throw new Error(&#39;test error&#39;) }, 1000)</code> and see Sentry handler executing an XHR call.</p><p><img src="/blog/images/test-sentry/sentry-error.png" alt="Triggering an error manually"></p><p><strong>Note:</strong> by default, Sentry uses <code>fetch</code> protocol to send the error object to its service API. Since Cypress does not support stubbing <code>fetch</code> requests yet, we force every client-side library to drop down to XHR using the example from <a href="https://github.com/cypress-io/cypress-example-recipes#stubbing-and-spying" target="_blank" rel="noopener">&quot;Stubbing window.fetch&quot;</a> recipe. We simply delete the <code>window.fetch</code> property when every window is created.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> polyfill</span><br><span class="line"></span><br><span class="line"><span class="comment">// grab fetch polyfill from remote URL, could be also from a local package</span></span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> polyfillUrl = <span class="string">'https://unpkg.com/unfetch/dist/unfetch.umd.js'</span></span><br><span class="line"></span><br><span class="line">  cy.request(polyfillUrl).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    polyfill = response.body</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Cypress.on(<span class="string">'window:before:load'</span>, win =&gt; &#123;</span><br><span class="line">  <span class="keyword">delete</span> win.fetch</span><br><span class="line">  <span class="comment">// since the application code does not ship with a polyfill</span></span><br><span class="line">  <span class="comment">// load a polyfilled "fetch" from the test</span></span><br><span class="line">  win.eval(polyfill)</span><br><span class="line">  win.fetch = win.unfetch</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Let&#39;s confirm this call happens. We need to prepare to intercept the call from the test. Look at the call&#39;s details, especially at the method and the destination URL.</p><p><img src="/blog/images/test-sentry/error-details.png" alt="Sentry call details"></p><p>Also look at the response object the Sentry service sends back to the caller.</p><p><img src="/blog/images/test-sentry/sentry-response.png" alt="Sentry response object"></p><p>Let&#39;s stub this route using <a href="https://on.cypress.io/route" target="_blank" rel="noopener"><code>cy.route</code></a> command and response with similar object.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'sends an error to Sentry'</span>, () =&gt; &#123;</span><br><span class="line">  cy.route(<span class="string">'POST'</span>, <span class="string">'https://sentry.io/api/*/store/*'</span>, &#123;</span><br><span class="line">    id: <span class="string">'abc123'</span>,</span><br><span class="line">  &#125;).as(<span class="string">'sentry'</span>)</span><br><span class="line">  <span class="comment">// create an error, as if application has thrown it</span></span><br><span class="line">  cy.window().invoke(</span><br><span class="line">    <span class="string">'setTimeout'</span>,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'test error'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// confirm the call has happened</span></span><br><span class="line">  cy.wait(<span class="string">'@sentry'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs - and we can see the stubbed XHR call to Sentry correctly detected (and stopped)</p><p><img src="/blog/images/test-sentry/sentry-api-call.png" alt="The call to Sentry API does happen on error"></p><p>Great, but - a thrown error is still a thrown error, and Cypress treats is as a test failure. Thus we need to handle it as described in the blog post <a href="https://www.cypress.io/blog/2020/03/03/testing-edge-data-cases-with-network-stubbing-and-app-actions/" target="_blank" rel="noopener">Testing Edge Data Cases with Network Stubbing and App Actions</a>. We will expect <code>uncaught:exception</code> event and will confirm it has <em>our test error message</em> and not some other <em>actual application error</em>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'sends an error to Sentry'</span>, () =&gt; &#123;</span><br><span class="line">  cy.route(<span class="string">'POST'</span>, <span class="string">'https://sentry.io/api/*/store/*'</span>, &#123;</span><br><span class="line">    id: <span class="string">'abc123'</span>,</span><br><span class="line">  &#125;).as(<span class="string">'sentry'</span>)</span><br><span class="line"></span><br><span class="line">  cy.on(<span class="string">'uncaught:exception'</span>, e =&gt; &#123;</span><br><span class="line">    <span class="comment">// only ignore OUR test error message</span></span><br><span class="line">    <span class="keyword">return</span> e.message === <span class="string">'test error'</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create an error, as if application has thrown it</span></span><br><span class="line">  cy.window().invoke(</span><br><span class="line">    <span class="string">'setTimeout'</span>,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'test error'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">1000</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// confirm the call has happened</span></span><br><span class="line">  cy.wait(<span class="string">'@sentry'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test passes. Let&#39;s confirm some of the fields the Sentry browser client sends to the service - it should have at least the error message.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// confirm the call has happened</span></span><br><span class="line">cy.wait(<span class="string">'@sentry'</span>)</span><br><span class="line">  .its(<span class="string">'requestBody'</span>)</span><br><span class="line">  .should(<span class="function"><span class="params">body</span> =&gt;</span> &#123;</span><br><span class="line">    expect(body.level).to.equal(<span class="string">'error'</span>)</span><br><span class="line">    expect(body.exception.values).to.have.length(<span class="number">1</span>)</span><br><span class="line">    expect(body.exception.values[<span class="number">0</span>]).to.deep.contain(&#123;</span><br><span class="line">      type: <span class="string">'Error'</span>,</span><br><span class="line">      value: <span class="string">'test error'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/test-sentry/full-test.png" alt="Passing test asserting Sentry is working correctly"></p><p><strong>Tip:</strong> writing XHR assertions this way is cumbersome, I suggest using helper library <a href="https://github.com/bahmutov/cy-spok" target="_blank" rel="noopener">cy-spok</a> in the blog post <a href="https://www.cypress.io/blog/2019/12/23/asserting-network-calls-from-cypress-tests/" target="_blank" rel="noopener">Asserting Network Calls from Cypress Tests</a>.</p><h2><span id="see-also">See also</span></h2><ul><li><a href="../connecting-crash-reporting-with-end-to-end-tests/">Connecting crash reporting with end to end tests</a> shows how to add additional test information to Sentry crashes happening during end-to-end tests</li><li><a href="../simple-ajax-testing/">Simple Ajax testing</a> shows how to observe calls to Sentry from Node tests</li><li><a href="../know-unknown-unknowns-with-sentry/">Know unknown unknowns with Sentry</a> is probably my first blog post praising Sentry</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I love using &lt;a href=&quot;https://sentry.io/welcome/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Sentry&lt;/a&gt; for tracking errors in my web applications. R
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="sentry" scheme="https://glebbahmutov.com/blog/tags/sentry/"/>
    
  </entry>
  
  <entry>
    <title>Scrape Static Site with Algolia</title>
    <link href="https://glebbahmutov.com/blog/scrape-static-site-with-algolia/"/>
    <id>https://glebbahmutov.com/blog/scrape-static-site-with-algolia/</id>
    <published>2020-03-26T04:00:00.000Z</published>
    <updated>2020-04-11T21:26:07.125Z</updated>
    
    <content type="html"><![CDATA[<p>Algolia search is good. So good, that many open source projects have moved to its free <a href="https://docsearch.algolia.com/" target="_blank" rel="noopener">DocSearch</a> project. When you search VuePress documentation you are using Algolia&#39;s backend, same with Yarn docs, same with Babel docs, and many others.</p><p><img src="/blog/images/scrape/vuepress-search.gif" alt="Searching VuePress documentation thanks to Algolia"></p><p>Great, let&#39;s see how we can take a static site like <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a> and create an Algolia index for it, then scrape the site&#39;s contents. Then we will add a search to the static site powered by Algolia&#39;s index.</p><h2><span id="set-up-algolia-app">Set up Algolia app</span></h2><p>First, I created a new Algolia account and have created a new application to host my experiment.</p><p><strong>Pro tip:</strong> rename your application to something meaningful from <code>https://www.algolia.com/account/applications</code> page after creating it.</p><p><img src="/blog/images/scrape/rename-app.png" alt="Renaming Algolia application"></p><p>Then set up a new index inside the application. For this blog post I called the index <code>scrape-test</code>, the screenshot below shows the index after I have added a few records there.</p><p><img src="/blog/images/scrape/index.png" alt="Search index"></p><p>To scrape any site and send results to the index we need the application&#39;s ID and Admin Key. I have tried creating a separate key following <a href="https://docsearch.algolia.com/docs/run-your-own" target="_blank" rel="noopener">Run Your Own Scraper</a> documentation, but I was always getting &quot;Index not allowed with this API key&quot; error. So just grab the Admin Key (but keep it really secret).</p><p><img src="/blog/images/scrape/api-keys.png" alt="We will need Application ID and API key to send scraped results"></p><h2><span id="scraping-the-site">Scraping the site</span></h2><p>I have created a repo <a href="https://github.com/bahmutov/scrape-test" target="_blank" rel="noopener">bahmutov/scrape-test</a> to show scraping in action. First, we need to think what is important on the page, and the hierarchy of results. For example, text matching <code>&lt;h1&gt;</code> element is probably more important than text matching <code>&lt;h3&gt;</code>. In demo I will be scraping a VuePress site from <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a> which is a VuePress site. I can look at <a href="https://github.com/algolia/docsearch-configs/blob/master/configs/vuepress.json" target="_blank" rel="noopener">VuePress Algolia scrape config file</a> to see how they set it up.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"index_name"</span>: <span class="string">"scrape-test"</span>,</span><br><span class="line">  <span class="attr">"start_urls"</span>: [<span class="string">"https://glebbahmutov.com/triple-tested/"</span>],</span><br><span class="line">  <span class="attr">"selectors"</span>: &#123;</span><br><span class="line">    <span class="attr">"lvl0"</span>: &#123;</span><br><span class="line">      <span class="attr">"selector"</span>: <span class="string">".site-name"</span>,</span><br><span class="line">      <span class="attr">"global"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"lvl1"</span>: <span class="string">".content__default h1"</span>,</span><br><span class="line">    <span class="attr">"lvl2"</span>: <span class="string">".content__default h2"</span>,</span><br><span class="line">    <span class="attr">"lvl3"</span>: <span class="string">".content__default h3"</span>,</span><br><span class="line">    <span class="attr">"lvl4"</span>: <span class="string">".content__default h4"</span>,</span><br><span class="line">    <span class="attr">"lvl5"</span>: <span class="string">".content__default h5"</span>,</span><br><span class="line">    <span class="attr">"text"</span>: <span class="string">".content__default p, .content__default li"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The last selector <code>text</code> requires explanation. Algolia&#39;s docs suggest splitting long text blocks into individual short records, see <a href="https://www.algolia.com/doc/faq/basics/is-there-a-size-limit-for-my-index-records/" target="_blank" rel="noopener">1</a>, <a href="https://www.algolia.com/doc/guides/sending-and-managing-data/prepare-your-data/how-to/indexing-long-documents/" target="_blank" rel="noopener">2</a>. We can check the <code>text</code> selector from DevTools console to see the short records it finds.</p><p><img src="/blog/images/scrape/text-selector.png" alt="Individual paragraphs and list items found using text selector"></p><p>Let&#39;s scrape the site. The simplest way is to use <a href="https://github.com/algolia/docsearch-scraper" target="_blank" rel="noopener">Algolia-provided Docker image</a>. Here is how I run it from the root of the <code>scrape-test</code> repo (where <code>config.json</code> file lives).</p><p>I place <code>APPLICATION_ID</code> and <code>API_KEY</code> values into <code>~/.as-a/.as-a.ini</code> file under its own section.</p><p><img src="/blog/images/scrape/as-a.png" alt="Keep environment variables in .as-a.ini file"></p><p>docker pull algolia/docsearch-scraper:v1.6.0</p><p>Now I will start Docker and will use <a href="https://github.com/bahmutov/as-a" target="_blank" rel="noopener">as-a</a> to run the <a href="https://hub.docker.com/r/algolia/docsearch-scraper" target="_blank" rel="noopener">algolia/docsearch-scraper</a> image. I will pass keys as environment variables, and the config file too.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">as-a scrape-test docker run -it \</span><br><span class="line">  -e APPLICATION_ID -e API_KEY -e CONFIG="$(cat config.json)" \</span><br><span class="line">  algolia/docsearch-scraper:v1.6.0</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> DocSearch: https://glebbahmutov.com/triple-tested/ 8 records)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> DocSearch: https://glebbahmutov.com/triple-tested/about.html 3 records)</span></span><br><span class="line"></span><br><span class="line">Nb hits: 11</span><br></pre></td></tr></table></figure><p>The scraper went like a spider through all (two) pages and found records to upload to the search index. Now let&#39;s go back to Algolia&#39;s Dashboard to check what it finds.</p><h3><span id="scraping-from-the-image">Scraping from the image</span></h3><p>As a side note, we can scrape the site from inside the <code>algolia/docsearch-scraper:v1.6.0</code> Docker image <em>without</em> executing its default entrypoint. We can inspect how the Docker image is built at <a href="https://github.com/algolia/docsearch-scraper/tree/master/scraper/dev/docker" target="_blank" rel="noopener">docsearch-scraper</a>. Here is the relevant line from its Dockerfile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [&quot;pipenv&quot;, &quot;run&quot;, &quot;python&quot;, &quot;-m&quot;, &quot;src.index&quot;]</span><br></pre></td></tr></table></figure><p>Let&#39;s see - let&#39;s run the same scrape job, but instead we will start the shell. Once the Docker container starts, we will enter <code>pipenv ...</code> command to run the scraper.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ as-a scrape-test docker run -it \</span><br><span class="line">  -e APPLICATION_ID -e API_KEY -e CONFIG=&quot;$(cat config.json)&quot; \</span><br><span class="line">  --entrypoint=/bin/sh algolia/docsearch-scraper:v1.6.0</span><br><span class="line"># pipenv run python -m src.index</span><br><span class="line">&gt; DocSearch: https://glebbahmutov.com/triple-tested/ 8 records)</span><br><span class="line">&gt; DocSearch: https://glebbahmutov.com/triple-tested/about.html 3 records)</span><br><span class="line"></span><br><span class="line">Nb hits: 11</span><br></pre></td></tr></table></figure><p>Great, works the same way.</p><h2><span id="scraping-from-github-action">Scraping from GitHub Action</span></h2><p><strong>Tip:</strong> if you have never used GitHub Actions, read <a href="../trying-github-actions/">Trying GitHub Actions</a> blog post</p><p>We don&#39;t want to scrape the site from local machine, let&#39;s do it from Continuous Integration (CI) server. Since the repository is already on GitHub, let&#39;s use GH Actions. Let&#39;s create workflow file <a href="https://github.com/bahmutov/scrape-test/blob/master/.github/workflows/scrape.yml" target="_blank" rel="noopener">.github/workflows/scrape.yml</a>.</p><figure class="highlight yml"><figcaption><span>scrape.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">scrape</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  scrape:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">check</span> <span class="string">out</span> <span class="string">code</span> <span class="string">🛎</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="comment"># when scraping the site, inject secrets as environment variables</span></span><br><span class="line">      <span class="comment"># then pass their values into the Docker container using "-e" syntax</span></span><br><span class="line">      <span class="comment"># and inject config.json contents as another variable</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">scrape</span> <span class="string">the</span> <span class="string">site</span> <span class="string">🧽</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          APPLICATION_ID:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.APPLICATION_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          API_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.API_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          docker run \</span></span><br><span class="line"><span class="string">          -e APPLICATION_ID -e API_KEY \</span></span><br><span class="line"><span class="string">          -e CONFIG="$(cat config.json)" \</span></span><br><span class="line"><span class="string">          algolia/docsearch-scraper:v1.6.0</span></span><br></pre></td></tr></table></figure><p>Enter the application id and API key in repository&#39;s secrets.</p><p><img src="/blog/images/scrape/repo-secrets.png" alt="Secrets to be injected as environment variables"></p><p>Push the code and see <a href="https://github.com/bahmutov/scrape-test/actions" target="_blank" rel="noopener">Actions run</a>.</p><p><img src="/blog/images/scrape/actions.png" alt="Scraping the site from GitHub Action"></p><p><strong>Tip:</strong> if you are deploying the site to GitHub Pages, you could run the scraper AFTER deploy finishes, read <a href="../triple-tested/">Triple Tested Static Site Deployed to GitHub Pages Using GitHub Actions</a></p><h2><span id="adding-the-algolia-search-widget">Adding the Algolia search widget</span></h2><p>We have populated the search index, now let&#39;s switch our demo site from built-in client-side search to Algolia&#39;s search widget. You can see the VuePress site in <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a> repository.</p><p>I have updated the <a href="https://github.com/bahmutov/triple-tested/blob/master/docs/.vuepress/config.js" target="_blank" rel="noopener">docs/.vuepress/config.js</a> to include Algolia settings.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  title: <span class="string">'Triple Tested'</span>,</span><br><span class="line">  description: <span class="string">'Example static site'</span>,</span><br><span class="line">  base: <span class="string">'/triple-tested/'</span>,</span><br><span class="line">  themeConfig: &#123;</span><br><span class="line">    algolia: &#123;</span><br><span class="line">      <span class="comment">// DANGER 🧨💀: ONLY USE ALGOLIA PUBLIC SEARCH-ONLY API KEY</span></span><br><span class="line">      apiKey: <span class="string">'&lt;algolia search-only API key&gt;'</span>,</span><br><span class="line">      indexName: <span class="string">'scrape-test'</span>,</span><br><span class="line">      appId: <span class="string">'&lt;algolia app id&gt;'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This <code>apiKey</code> is NOT the Admin API key we have used to scrape the site, this is a key limited to searching the index only.</p><p>Once the site starts, try the search ... and you won&#39;t see any results 😟</p><p><img src="/blog/images/scrape/no-results.png" alt="The search widget comes up empty"></p><p>Open DevTools Network panel to see the queries from Algolia&#39;s search box - notice they include a <em>facet</em> <code>lang: en-US</code>.</p><p><img src="/blog/images/scrape/facets.png" alt="The search facets include the language"></p><p>Our Algolia application does not know the <em>language</em> of each record in the index. Thus we need to go back to <a href="https://github.com/algolia/docsearch-configs/blob/master/configs/vuepress.json" target="_blank" rel="noopener">DocSearch VuePress config</a> file to see how they have set it up. Among selectors we can find the following:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"selectors"</span>: &#123;</span><br><span class="line">    <span class="attr">"lang"</span>: &#123;</span><br><span class="line">      <span class="attr">"selector"</span>: <span class="string">"/html/@lang"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"xpath"</span>,</span><br><span class="line">      <span class="attr">"global"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"custom_settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"attributesForFaceting"</span>: [</span><br><span class="line">      <span class="string">"lang"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Great - the <code>lang</code> selector tells the scraper to use <code>&lt;html lang=&quot;en&quot;&gt;</code> attribute. Let&#39;s copy the above settings and scrape again. Now each record has additional facet attribute, and testing the index correctly finds the record and shows the language facet.</p><p><img src="/blog/images/scrape/updated-index.png" alt="The index has the language facet"></p><p>Going back to the widget - it is working now!</p><p><img src="/blog/images/scrape/search-works.gif" alt="The Algolia search widget finds the text"></p><p>You can try the search yourself at <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a>.</p><h2><span id="example-repos">Example repos</span></h2><ul><li><a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested/</a></li><li><a href="https://github.com/bahmutov/cypress-examples" target="_blank" rel="noopener">bahmutov/cypress-examples</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Algolia search is good. So good, that many open source projects have moved to its free &lt;a href=&quot;https://docsearch.algolia.com/&quot; target=&quot;_
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
      <category term="algolia" scheme="https://glebbahmutov.com/blog/tags/algolia/"/>
    
  </entry>
  
  <entry>
    <title>Triple Tested Static Site Deployed to GitHub Pages Using GitHub Actions</title>
    <link href="https://glebbahmutov.com/blog/triple-tested/"/>
    <id>https://glebbahmutov.com/blog/triple-tested/</id>
    <published>2020-03-24T04:00:00.000Z</published>
    <updated>2020-03-24T13:25:58.009Z</updated>
    
    <content type="html"><![CDATA[<p>This blog post shows something I have wanted to achieve for a while: <strong>deploying a fully tested static site or a web application and then testing the deployed site</strong>.</p><!-- toc --><ul><li><a href="#introduction">Introduction</a></li><li><a href="#the-static-site">The static site</a></li><li><a href="#building-the-production-site">Building the production site</a></li><li><a href="#deploying-to-github-pages">Deploying to GitHub Pages</a></li><li><a href="#local-testing">Local testing</a></li><li><a href="#local-test-on-ci">Local test on CI</a></li><li><a href="#the-problem-with-deployed-site">The problem with deployed site</a></li><li><a href="#testing-the-deployed-site">Testing the deployed site</a></li><li><a href="#testing-the-deployed-site-from-ci">Testing the deployed site from CI</a></li><li><a href="#fixing-the-deploy-url">Fixing the deploy url</a></li><li><a href="#preventing-broken-deployments">Preventing broken deployments</a></li><li><a href="#tips">Tips</a><ul><li><a href="#github-actions-badges">GitHub Actions badges</a></li><li><a href="#environment-variables">Environment variables</a></li><li><a href="#record-to-dashboard">Record to Dashboard</a></li></ul></li><li><a href="#discussion">Discussion</a></li></ul><!-- tocstop --><h2><span id="introduction">Introduction</span></h2><p>My previous attempts used a combination of continuous integration (CI) systems and deployment tools; in all cases the result is a workflow that was unnecessary complex and hard to understand. You can see these attempts for yourself from these blog posts:</p><ul><li><a href="../gatsby-netlify-circle-and-cypress/">Gatsby Netlify Circle and Cypress</a> uses CircleCI + Netlify and requires webhook back Netlify to Circle on deploy to run a test job</li><li><a href="https://www.cypress.io/blog/2018/08/28/record-test-artifacts-from-any-ci/" target="_blank" rel="noopener">Record Test Artifacts from any Docker CI</a> uses Docker image to run tests locally, but does not test the deployed site</li><li><a href="https://www.cypress.io/blog/2017/05/30/cypress-and-immutable-deploys/" target="_blank" rel="noopener">Immutable deploys and Cypress</a> uses GitLab CI to run tests locally, then deploys using Zeit Now and tests the deployed site, not too bad, but still a combination of two systems and lots of custom glue code; I am not even sure my tool <a href="https://github.com/bahmutov/now-pipeline" target="_blank" rel="noopener">now-pipeline</a> is even working still against Zeit API</li></ul><p>This blog post shows how to deploy a static site or a web apps to <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> while testing the site three times using <a href="https://github.com/features/actions" target="_blank" rel="noopener">GitHub Actions</a>:</p><ul><li>first time running site <em>in development mode</em></li><li>second time by building the production bundles and serving the site using a static server</li><li>third time <em>after deploying</em> the site to GitHub Pages</li></ul><p><strong>Source code:</strong> you can find the code for this blog post in <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a>. You can see the finished (well-tested) version of the site deployed at <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a>.</p><p>Let&#39;s roll!</p><h2><span id="the-static-site">The static site</span></h2><p>As an example, I created a static blog site using <a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener">VuePress</a>. First, let&#39;s install it using NPM</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm init --yes</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm i -D vuepress</span></span><br><span class="line">+ vuepress@1.4.0</span><br></pre></td></tr></table></figure><p>In <a href="https://github.com/bahmutov/triple-tested/blob/master/package.json" target="_blank" rel="noopener">package.json</a> we can add commands to run the local development server and build the production site:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"triple-tested"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"docs:dev"</span>: <span class="string">"vuepress dev docs"</span>,</span><br><span class="line">    <span class="attr">"docs:build"</span>: <span class="string">"vuepress build docs"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"vuepress"</span>: <span class="string">"1.4.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then I have added a new folder called <code>docs</code> with a few Markdown files - these files will be converted into HTML pages using VuePress settings from <code>docs/.vuepress</code> folder.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la docs/</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x   5 gleb  staff  160 Mar 22 17:23 .</span><br><span class="line">drwxr-xr-x  13 gleb  staff  416 Mar 22 17:30 ..</span><br><span class="line">drwxr-xr-x   4 gleb  staff  128 Mar 21 14:51 .vuepress</span><br><span class="line">-rw-r--r--   1 gleb  staff  101 Mar 22 17:28 README.md</span><br><span class="line">-rw-r--r--   1 gleb  staff  152 Mar 22 17:29 about.md</span><br><span class="line"></span><br><span class="line">$ cat docs/.vuepress/config.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  title: &apos;Triple Tested&apos;,</span><br><span class="line">  description: &apos;Example static site&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The <code>README.md</code> file has the content for the main or index page</p><figure class="highlight md"><figcaption><span>docs/README.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Main page</span></span><br><span class="line"><span class="quote">&gt; This is an experiment</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>does it work?</span><br><span class="line"><span class="bullet">- </span>maybe</span><br><span class="line"><span class="bullet">- </span>hope so!</span><br><span class="line"></span><br><span class="line">Go to [<span class="string">about page</span>](<span class="link">./about</span>)</span><br></pre></td></tr></table></figure><p>The <code>about.md</code> file has a link back to the main page</p><figure class="highlight md"><figcaption><span>docs/about.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># About</span></span><br><span class="line"></span><br><span class="line">This is a static blog used as example in [<span class="string">bahmutov/triple-tested</span>](<span class="link">https://github.com/bahmutov/triple-tested</span>) repo.</span><br><span class="line"></span><br><span class="line">Back to the [<span class="string">main page</span>](<span class="link">/</span>)</span><br></pre></td></tr></table></figure><p>We can start the local development server that bundles the Markdown files and serves the HTML pages using <code>npm run docs:dev</code> command. The <code>vuepress dev docs</code> command serves the content at port 8080 by default.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run docs:dev</span></span><br><span class="line">success [17:38:19] Build 62f9fb finished in 116 ms! ( http://localhost:8080/ )</span><br></pre></td></tr></table></figure><p>Open that URL in your browser and find a nice, clean static site</p><p><img src="/blog/images/triple-tested/main-to-about.gif" alt="Main page to About page and back"></p><p>The development server watches the source files, and automatically rebuilds the pages on changes. It also forces the browser to reload the page.</p><p><img src="/blog/images/triple-tested/develop-reload.gif" alt="Development process reloads the page when Markdown file changes"></p><p><strong>Tip:</strong> the above example used relative link <code>[about page](./about)</code>, but according to <a href="https://vuepress.vuejs.org/guide/markdown.html#links" target="_blank" rel="noopener">VuePress docs</a> you should use the file path with extension <code>[about page](./about.md)</code> to generate the correct link.</p><h2><span id="building-the-production-site">Building the production site</span></h2><p>We cannot run the <code>npm run docs:dev</code> in production though: we need to convert the Markdown into finalized HTML pages. VuePress has the <code>build</code> command that does the production build and optimizes the HTML, CSS and JavaScript asset bundles.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run docs:build</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> triple-tested@1.0.0 docs:build /Users/gleb/git/triple-tested</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> vuepress build docs</span></span><br><span class="line"></span><br><span class="line">wait Extracting site metadata...</span><br><span class="line">tip Apply theme @vuepress/theme-default ...</span><br><span class="line">tip Apply plugin container (i.e. "vuepress-plugin-container") ...</span><br><span class="line">tip Apply plugin @vuepress/register-components (i.e. "@vuepress/plugin-register-components") ...</span><br><span class="line">tip Apply plugin @vuepress/active-header-links (i.e. "@vuepress/plugin-active-header-links") ...</span><br><span class="line">tip Apply plugin @vuepress/search (i.e. "@vuepress/plugin-search") ...</span><br><span class="line">tip Apply plugin @vuepress/nprogress (i.e. "@vuepress/plugin-nprogress") ...</span><br><span class="line"></span><br><span class="line">✔ Client</span><br><span class="line">  Compiled successfully in 7.25s</span><br><span class="line"></span><br><span class="line">✔ Server</span><br><span class="line">  Compiled successfully in 4.58s</span><br><span class="line"></span><br><span class="line">wait Rendering static HTML...</span><br><span class="line">success Generated static files in docs/.vuepress/dist.</span><br></pre></td></tr></table></figure><p>The <code>build</code> command prepares the static site for <a href="https://vuepress.vuejs.org/guide/deploy.html" target="_blank" rel="noopener">deployment</a> - assuming the hosting platform &quot;simply&quot; serves the produced folder <code>docs/.vuepress/dist</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la docs/.vuepress/dist</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 22 17:57 .</span><br><span class="line">drwxr-xr-x  4 gleb  staff   128 Mar 22 17:56 ..</span><br><span class="line">-rw-r--r--  1 gleb  staff  2990 Mar 22 17:57 about.html</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 22 17:57 assets</span><br><span class="line">-rw-r--r--  1 gleb  staff  2508 Mar 22 17:57 index.html</span><br></pre></td></tr></table></figure><p>In fact, we can serve the <code>dist</code> folder ourselves to see how it looks. Let&#39;s use a quick static server utility called <a href="https://github.com/zeit/serve" target="_blank" rel="noopener">serve</a>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D serve</span></span><br><span class="line">+ serve@11.3.0</span><br><span class="line"><span class="meta">$</span><span class="bash"> npx serve docs/.vuepress/dist</span></span><br><span class="line"></span><br><span class="line">   ┌────────────────────────────────────────────────┐</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Serving!                                     │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   - Local:            http://localhost:5000    │</span><br><span class="line">   │   - On Your Network:  http://10.0.0.124:5000   │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Copied local address to clipboard!           │</span><br><span class="line">   │                                                │</span><br><span class="line">   └────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>Open <code>localhost:5000</code> in the browser - it should look and work exactly the same way as the development server, and perhaps even faster, since it was optimized for production and does not include the extra development code.</p><p><img src="/blog/images/triple-tested/dist.png" alt="Production static site served from dist/.vuepress/dist folder"></p><h2><span id="deploying-to-github-pages">Deploying to GitHub Pages</span></h2><p>Now that we have built such a beautiful content, let&#39;s host it somewhere. I will use <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Page</a> to host. I love using GH Pages for static pages, even this blog you are reading is hosted there! Any public GH repository can push HTML files into <code>gh-pages</code> branch, and the GH Pages serve it.</p><p>I could push the <code>dist</code> folder to <a href="https://github.com/bahmutov/triple-tested/tree/gh-pages" target="_blank" rel="noopener">gh-pages branch</a> manually, but I want to automate this process. Thus I have created a GitHub Actions workflow file <a href="https://github.com/bahmutov/triple-tested/blob/b0f84916ac45f1b1f83617818f365d007c3d3958/.github/workflows/ci.yml" target="_blank" rel="noopener">.github/workflow/ci.yml</a> that checks out the code, installs NPM dependencies, builds the production site and deploys the <code>dist</code> folder to the <code>gh-pages</code> branch where GitHub Pages host it:</p><figure class="highlight yml"><figcaption><span>.github/workflow/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># only deploy site from master branch</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line">      <span class="comment"># https://github.com/actions/checkout</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">NPM</span> <span class="string">install</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/marketplace/actions/github-pages-action</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Deploy</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          publish_dir:</span> <span class="string">./docs/.vuepress/dist</span></span><br></pre></td></tr></table></figure><p><strong>Note:</strong> if you have never used GitHub Actions, spend 30 minutes watching my recent talk <a href="https://www.youtube.com/watch?v=zhPqf5z_crc" target="_blank" rel="noopener">GitHub Actions in Action</a> and browse the <a href="https://slides.com/bahmutov/gh-actions" target="_blank" rel="noopener">slides</a>, or read the blog post <a href="../trying-github-actions/">Trying GitHub Actions</a>.</p><p>In the above <code>ci.yml</code> file we are using 3rd party GitHub action from repo <a href="https://github.com/peaceiris/actions-gh-pages" target="_blank" rel="noopener">peaceiris/actions-gh-pages</a> and pass it two parameters. The <code>secrets.GITHUB_TOKEN</code> is created automatically by GitHub workflow; this token allows the action to push a new commit back to the <code>gh-pages</code> branch if there are changed HTML files. The <code>public_dir</code> parameter tells the action which folder we want to deploy.</p><p><strong>Warning ⚠️:</strong> if the first deploy fails, read <a href="https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-first-deployment-with-github_token" target="_blank" rel="noopener">this issue</a> - there seems to be a bug with GH Pages and the <code>GITHUB_TOKEN</code> on first deploy. I pushed the code manually once using <a href="https://github.com/josh-egan/deploy-gh-pages" target="_blank" rel="noopener">deploy-gh-pages</a> and my personal GitHub access token <code>GH_TOKEN=... npx deploy-gh-pages ./docs/.vuepress/dist</code>. After that the <code>ci.yml</code> was able to push the new commits automatically.</p><p>You can see the workflow <code>ci</code> run at GitHub inside the repo&#39;s <a href="https://github.com/bahmutov/triple-tested/actions?query=workflow%3Aci" target="_blank" rel="noopener">Actions tab</a></p><p><img src="/blog/images/triple-tested/ci-workflow.png" alt="Workflow &quot;ci&quot; has successfully finished"></p><p>Before we look at the deployed site, let&#39;s go back to the local development mode and make sure it works correctly.</p><h2><span id="local-testing">Local testing</span></h2><p>In a section above, I have shown navigation from the Main page to the About page and back by clicking on the links.</p><p><img src="/blog/images/triple-tested/main-to-about.gif" alt="Main page to About page and back"></p><p>What if we accidentally change the filename <code>about.md</code> to <code>info.md</code>? We will have a broken link, which leads to frustrated users. Let&#39;s prevent this by adding an end-to-end Cypress test. First, we will install Cypress test runner and a useful utility <a href="https://github.com/bahmutov/start-server-and-test" target="_blank" rel="noopener">start-server-and-test</a> to help run and stop multiple processes.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D cypress start-server-and-test</span></span><br><span class="line">+ cypress@4.2.0</span><br><span class="line">+ start-server-and-test@1.10.11</span><br></pre></td></tr></table></figure><p>When we work locally we want to run the VuePress develop command, wait for the server to respond at port 8080, then we can open Cypress. Here are the scripts:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"docs:dev"</span>: <span class="string">"vuepress dev docs"</span>,</span><br><span class="line">    <span class="attr">"docs:build"</span>: <span class="string">"vuepress build docs"</span>,</span><br><span class="line">    <span class="attr">"cy:open"</span>: <span class="string">"cypress open"</span>,</span><br><span class="line">    <span class="attr">"cy:run"</span>: <span class="string">"cypress run"</span>,</span><br><span class="line">    <span class="attr">"dev"</span>: <span class="string">"start-test docs:dev 8080 cy:open"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"cypress"</span>: <span class="string">"4.2.0"</span>,</span><br><span class="line">    <span class="attr">"serve"</span>: <span class="string">"11.3.0"</span>,</span><br><span class="line">    <span class="attr">"start-server-and-test"</span>: <span class="string">"1.10.11"</span>,</span><br><span class="line">    <span class="attr">"vuepress"</span>: <span class="string">"1.4.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Whenever we need to start everything locally, we will use <code>npm run dev</code> script. Let&#39;s write a Cypress test.</p><figure class="highlight js"><figcaption><span>cypress/integration/spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types="cypress" /&gt;</span></span><br><span class="line">describe(<span class="string">'Triple tested'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'has index and about pages'</span>, () =&gt; &#123;</span><br><span class="line">    cy.visit(<span class="string">'/'</span>)</span><br><span class="line">    cy.contains(<span class="string">'h1'</span>, <span class="string">'Main page'</span>)</span><br><span class="line">    cy.contains(<span class="string">'hope so!'</span>)</span><br><span class="line">    cy.contains(<span class="string">'a'</span>, <span class="string">'about page'</span>).click()</span><br><span class="line">    cy.url().should(<span class="string">'match'</span>, /about/)</span><br><span class="line">    cy.contains(<span class="string">'h1'</span>, <span class="string">'About'</span>)</span><br><span class="line">    cy.contains(<span class="string">'a'</span>, <span class="string">'main page'</span>).click()</span><br><span class="line">    cy.url().should(<span class="string">'not.match'</span>, /about/)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test does not hardcode the URL to visit - instead the command <code>cy.visit(&#39;/&#39;)</code> relies on <code>baseUrl</code> set in the <code>cypress.json</code> file</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:8080"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Start the development server and open Cypress with NPM script</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run dev</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> start-test docs:dev 8080 cy:open</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   - runs <span class="string">"docs:dev"</span> script</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   - waits <span class="keyword">for</span> port 8080 to respond</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   - opens Cypress application</span></span><br></pre></td></tr></table></figure><p>The test in <code>spec.js</code> runs very quickly</p><p><img src="/blog/images/triple-tested/spec.gif" alt="Cypress test going from Main to About page and back using links"></p><p><strong>Tip:</strong> if we <em>only</em> wanted to check the local Markdown links, we could just do so, read the blog post <a href="../check-markdown-links/">Check links in your Markdown documents</a>. But in this blog post we want to write other kinds of functional tests.</p><p>While we are at it, we can verify the &quot;Search&quot; behavior. VuePress automatically adds search widget with page titles. Users can go to a page by typing the title:</p><p><img src="/blog/images/triple-tested/search.gif" alt="Going to the About page using the search"></p><p>Let&#39;s write a test. First, we need to select the search input box. Here is the relevant markup:</p><p><img src="/blog/images/triple-tested/search-markup.png" alt="HTML markup for search widget"></p><p><strong>Tip:</strong> I have described how to test VuePress Search widget in details in the blog post <a href="../vuepress-conditional-testing/">VuePress and some Cypress end-to-end testing tips</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'finds About page using search'</span>, () =&gt; &#123;</span><br><span class="line">  cy.visit(<span class="string">'/'</span>)</span><br><span class="line">  cy.get(<span class="string">'.search-box input'</span>).type(<span class="string">'about'</span>)</span><br><span class="line">  <span class="comment">// suggestions list appears</span></span><br><span class="line">  cy.get(<span class="string">'.suggestions li'</span>).should(<span class="string">'be.visible'</span>)</span><br><span class="line">    <span class="comment">// and should have at least 1 item</span></span><br><span class="line">    .and(<span class="string">'have.length.gte'</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// and the first search result is our "About" page</span></span><br><span class="line">    .first()</span><br><span class="line">    .contains(<span class="string">'.page-title'</span>, <span class="string">'About'</span>).click()</span><br><span class="line">  <span class="comment">// check we are on the right page</span></span><br><span class="line">  cy.title().should(<span class="string">'contain'</span>, <span class="string">'About'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test runs and confirms the search is working</p><p><img src="/blog/images/triple-tested/search-test.gif" alt="The search test finds the About page"></p><h2><span id="local-test-on-ci">Local test on CI</span></h2><p>Now that we have end-to-end tests, let&#39;s run them on GitHub Actions CI. We could extend the <code>ci.yml</code> with commands to start the development server in the background and run Cypress tests like this:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">NPM</span> <span class="string">install</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:develop</span> <span class="string">&amp;</span></span><br><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">cy:run</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br></pre></td></tr></table></figure><p>Or we could use <code>start-server-and-test</code> utility on CI by defining one more script:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"docs:dev"</span>: <span class="string">"vuepress dev docs"</span>,</span><br><span class="line">    <span class="attr">"cy:run"</span>: <span class="string">"cypress run"</span>,</span><br><span class="line">    <span class="attr">"dev:ci"</span>: <span class="string">"start-test docs:dev 8080 cy:run"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Where the <code>cypress run</code> command just runs Cypress headlessly.</p><figure class="highlight yml"><figcaption><span>ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">NPM</span> <span class="string">install</span> <span class="string">📦</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">dev:ci</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br></pre></td></tr></table></figure><p>The above approach is imperfect. The action step <code>bahmutov/npm-install@v1</code> does NOT understand how to <a href="https://on.cypress.io/caching" target="_blank" rel="noopener">cache Cypress binary correctly</a>, leading to slow or failing builds. To greatly simplify running Cypress on GitHub Actions CI, we have written <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a>. This action &quot;knows&quot; how to install Cypress and NPM dependencies, cache them, start the server, and run the tests. Let&#39;s use this action:</p><figure class="highlight yml"><figcaption><span>ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:8080'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br></pre></td></tr></table></figure><p>The GitHub Actions execute and pass</p><p><img src="/blog/images/triple-tested/testing-on-ci.png" alt="Cypress tests successfully ran on GitHub"></p><p>We can see the logs from the <code>npm run docs:dev</code> command followed by the Cypress&#39; terminal output.</p><p><img src="/blog/images/triple-tested/logs.gif" alt="Cypress GitHub Action logs"></p><p>Nice, our static site will work correctly when deployed; we have tested it!</p><p>Or will it?</p><h2><span id="the-problem-with-deployed-site">The problem with deployed site</span></h2><p>We have tested the site on GitHub CI by running the VuePress development server. Then we built the site and pushed the <code>./docs/.vuepress/dist</code> folder to GitHub Pages. Everything must be good, right? Let&#39;s check.</p><p>I have a custom domain <code>glebbahmutov.com</code> <a href="https://help.github.com/en/github/working-with-github-pages/configuring-a-custom-domain-for-your-github-pages-site" target="_blank" rel="noopener">configured with GitHub Pages</a> via CloudFlare. My personal repository <a href="https://github.com/bahmutov/bahmutov.github.io" target="_blank" rel="noopener">bahmutov/bahmutov.github.io</a> is hosted at <code>https://glebbahmutov.com/</code> and every repo <code>&lt;name&gt;</code> will be available under <code>https://glebbahmutov.com/&lt;name&gt;/</code> sub path. Thus we can open <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a> and see our blog.</p><p>Let&#39;s open that URL ...</p><p><img src="/blog/images/triple-tested/deploy1.png" alt="The deployed site is terribly broken"></p><p>Oh no, the site ... does not look good. Click on the &quot;About&quot; page link - we can browser to it. But going to the &quot;Main&quot; page does not work. Instead it redirects to the top level domain <code>https://glebbahmutov.com</code>.</p><p><img src="/blog/images/triple-tested/link-to-main.png" alt="Link to the main page is wrong"></p><p>Open the DevTools Network tab and reload the main page - you will see that only the <code>index.html</code> really loads, all other links fail to load.</p><p><img src="/blog/images/triple-tested/failed-links.png" alt="Network tab shows that resources fail to load"></p><p>Clicking on any resource shows the full path - and it looks wrong, because it does not include <code>/triple-tested/</code> folder.</p><p><img src="/blog/images/triple-tested/failed-css.png" alt="Failed CSS resource"></p><p>Let&#39;s look at the source of the page - notice that all resource links start with <code>/assets/...</code>, which means they are served from the <em>root of the domain</em>.</p><p><img src="/blog/images/triple-tested/html.png" alt="Deployed site HTML"></p><p>Each resource link &quot;forgets&quot; to include the <em>base url</em> of the site - the subfolder <code>/triple-tested</code> part. We should have read the entire <a href="https://vuepress.vuejs.org/guide/deploy.html" target="_blank" rel="noopener">VuePress deployment guide</a> that explains GitHub deployment in details:</p><p><img src="/blog/images/triple-tested/vuepress-deploy.png" alt="VuePress deployment guide to GitHub Pages"></p><p>Ok, that can be done. But before we fix the problem, we need to</p><p>...</p><p>write a test for it.</p><h2><span id="testing-the-deployed-site">Testing the deployed site</span></h2><p>As you saw above, things can go wrong when deploying a site. The problems that arise are <em>outside of source code</em> of the site itself. It was not the link <code>[about page](./about)</code> from the Main page to the About page that we have tested. It was not the Search widget either. No, instead we have discovered a <em>hosting configuration</em> problem. If instead of our small static site example, we had a complex web application, we could have wrong environment variables, an invalid database connection string, an unreachable proxy address - all the things that worked perfectly locally, but were set up incorrectly in production.</p><p>To really validate the deployed production site, we need to run a quick smoke end-to-end test, just to see if the entire stack works together.</p><p>Remember how we set the base url to test in <code>cypress.json</code>? It is pointing at <code>http://localhost:8080</code>, but we can overwrite it from <a href="https://on.cypress.io/configuration" target="_blank" rel="noopener">command line or using an environment variable</a>. Let&#39;s see if our current tests catch the errors with the deployed site. Open Cypress GUI locally, but pass the full production site URL:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx cypress open --config baseUrl=https://glebbahmutov.com/triple-tested</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or equivalent</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_baseUrl=https://glebbahmutov.com/triple-tested npx cypress open</span></span><br></pre></td></tr></table></figure><p>Then run the same tests against it.</p><p><img src="/blog/images/triple-tested/testing-deploy.gif" alt="Running end-to-end tests against the deployed site"></p><p>The &quot;finds About page using search&quot; test catches the broken site - because the JavaScript bundle for the search widget did not load.</p><p><strong>Tip:</strong> notice the 404 HTTP status codes Cypress shows in its terminal output - meaning the page under test fails to load a lot of its resources! That&#39;s a red flag.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /__cypress/iframes/integration/spec.js 200 1.025 ms - 629</span><br><span class="line">GET /__cypress/tests?p=cypress/integration/spec.js-331 200 1.689 ms - -</span><br><span class="line">GET /triple-tested/ 200 2.891 ms - -</span><br><span class="line">GET /assets/css/0.styles.59ba12ca.css 404 22.829 ms - -</span><br><span class="line">GET /assets/js/app.b08d2fd8.js 404 26.132 ms - -</span><br><span class="line">GET /assets/js/5.620a0c16.js 404 31.183 ms - -</span><br><span class="line">GET /assets/js/2.28d5c6fe.js 404 32.865 ms - -</span><br><span class="line">GET /assets/js/3.d052a4f0.js 404 32.142 ms - -</span><br><span class="line">GET /assets/js/4.5f60d4ea.js 404 28.854 ms - -</span><br><span class="line">GET /assets/js/6.fa5f4b7d.js 404 30.396 ms - -</span><br><span class="line">GET /triple-tested/about 200 92.170 ms - -</span><br></pre></td></tr></table></figure><p>Why did the first test &quot;has index and about pages&quot; pass? I remember it had an assertion after navigating back from the &quot;About&quot; to the &quot;Main&quot; page... It should have failed.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.contains(<span class="string">'a'</span>, <span class="string">'main page'</span>).click()</span><br><span class="line">cy.url().should(<span class="string">'not.match'</span>, /about/)</span><br></pre></td></tr></table></figure><p>Hmm, look at the time traveling debugger - the assertion passes, but for a wrong reason - the site&#39;s url is <code>https://glebbahmutov.com</code> that does not match the regular expression <code>/about/</code>, so the test &quot;thinks&quot; everything is peachy.</p><p><img src="/blog/images/triple-tested/assertion.png" alt="The negative assertion against the URL passes"></p><p>You have to be careful about negative assertions like <code>should(&#39;not.match&#39;, ...)</code>, because they can be passing but for completely unexpected (and wrong) reasons. Let&#39;s add a <em>positive</em> assertion that checks something on the page that <em>only the right Main</em> page has.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.contains(<span class="string">'a'</span>, <span class="string">'main page'</span>).click()</span><br><span class="line">cy.url().should(<span class="string">'not.match'</span>, /about/)</span><br><span class="line"><span class="comment">// only our Main page has &lt;h1&gt;Main page&lt;/h1&gt;</span></span><br><span class="line">cy.contains(<span class="string">'h1'</span>, <span class="string">'Main page'</span>)</span><br></pre></td></tr></table></figure><p>The test fails correctly.</p><p><img src="/blog/images/triple-tested/test-fails.png" alt="The first test correctly fails"></p><p><strong>Tip:</strong> Cypress is a <em>functional testing tool</em>. Thus if the elements are present on the page, Cypress will happily click on the buttons, navigate using links, check the DOM and urls, etc. And it won&#39;t &quot;notice&quot; that the page&#39;s styles are missing, and everything looks broken. For that you need to add <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">visual testing</a>; luckily it not too difficult to do.</p><h2><span id="testing-the-deployed-site-from-ci">Testing the deployed site from CI</span></h2><p>We cannot rely on manual testing of the deployed site. We need to automatically test the site from CI after it has been deployed. Since we deploy the site to GitHub Pages from GitHub Actions, let&#39;s write <em>another action workflow</em> that would be triggered after the deploy finish. I will create a new file <code>.github/workflows/deployed.yml</code> with another GitHub workflow. Creating a separate workflow file is a great for keeping your CI files simple to understand and use.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">deployed</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  status:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test-deployed-page:</span></span><br><span class="line"><span class="attr">    if:</span> <span class="string">github.event.context</span> <span class="string">==</span> <span class="string">'github/pages'</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.state</span> <span class="string">==</span> <span class="string">'success'</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">echo</span> <span class="string">"gh-pages 📑 built successfully ✅"</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">show</span> <span class="string">deployed</span> <span class="string">page</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">curl</span> <span class="bullet">-s</span> <span class="attr">https://glebbahmutov.com/triple-tested</span></span><br></pre></td></tr></table></figure><p>This workflow only runs when a commit on the <code>master</code> branch has its status updated. GitHub Pages bot sets this status when it starts building the pages, and when it finishes the deployment. We can use <a href="https://help.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions" target="_blank" rel="noopener">GitHub Actions expressions</a> to skip the job <code>test-deployed-page</code> unless the event that triggered the workflow tells us the GitHub Pages deploy was a success.</p><p><strong>Tip:</strong> you can dump the entire GH event object and inspect all the fields in order to write the <code>if: ...</code> expressions. Here is a dummy workflow job that simply prints the event (it is a huge JSON object)</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">show-event:</span></span><br><span class="line"><span class="attr">  runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">  steps:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Dump</span> <span class="string">GitHub</span> <span class="string">context</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        GITHUB_CONTEXT:</span> <span class="string">$&#123;&#123;</span> <span class="string">toJson(github)</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">echo</span> <span class="string">"$GITHUB_CONTEXT"</span></span><br></pre></td></tr></table></figure><p>Let&#39;s see this workflow in action. I have added line <code>another one 👆</code> the <code>docs/README.md</code> file and have commited and pushed the code.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Go to [about page](./about)</span><br><span class="line">another one 👆</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git add docs/README.md</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit -m <span class="string">"another one"</span></span></span><br><span class="line">[master 1e8d247] another one</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"><span class="meta">$</span><span class="bash"> git push</span></span><br></pre></td></tr></table></figure><p>We can see the 3 workflows at GitHub: the original <code>ci.yml</code> on <code>push</code> to <code>master</code> branch, followed by the skipped <code>deployed.yml</code> workflow (because the event status is <code>pending</code>), and then the full deployed workflow runs when the page has been deployed.</p><p><img src="/blog/images/triple-tested/events.png" alt="The workflows: one builds and deploys, the other runs after the deploy"></p><p>We can click on the finished <code>deployed</code> workflow and look at the output of the <code>curl -s https://glebbahmutov.com/triple-tested</code> command. The site has been updated with new text</p><p><img src="/blog/images/triple-tested/page.png" alt="The static site has been updated"></p><p>Now that we have the workflow that runs AFTER the deploy, let&#39;s run Cypress tests there, using the same <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a> code, but just pointing the tests at the external site.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">show</span> <span class="string">deployed</span> <span class="string">page</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">curl</span> <span class="bullet">-s</span> <span class="attr">https://glebbahmutov.com/triple-tested/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># we need our source code that has package.json and Cypress specs</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    config:</span> <span class="string">baseUrl=https://glebbahmutov.com/triple-tested/</span></span><br></pre></td></tr></table></figure><p><strong>Note:</strong> if we only change the <code>deployed.yml</code> file, the deploy event WILL NOT be triggered - because the VuePress content has stayed the same! Thus we need to change some text in the <code>docs</code> folder in order to trigger a new deploy and see the tests in action. I will remove <code>another one 👆</code> line and push again.</p><p>The CI workflows shows the <code>deployed</code> workflow failing - because the tests we have added detect the broken static site</p><p><img src="/blog/images/triple-tested/deployed-workflow-failed.png" alt="The deployed workflow fails as expected"></p><p>Click on the <code>deployed</code> workflow to see both Cypress tests failing as expected.</p><p><img src="/blog/images/triple-tested/both-tests-failed.png" alt="Both tests failed against the production site"></p><p>We have automated the deployment and testing the production site. At least now we know when the deployment went badly and corrective measures should be taken.</p><h2><span id="fixing-the-deploy-url">Fixing the deploy url</span></h2><p>After reading the <a href="https://vuepress.vuejs.org/guide/deploy.html" target="_blank" rel="noopener">VuePress deploy guide</a> one more time, I open the <code>docs/.vuepress/config.js</code> file and add the <a href="https://vuepress.vuejs.org/config/#base" target="_blank" rel="noopener"><code>base</code> parameter</a>:</p><figure class="highlight js"><figcaption><span>docs/.vuepress/config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  title: <span class="string">'Triple Tested'</span>,</span><br><span class="line">  description: <span class="string">'Example static site'</span>,</span><br><span class="line">  base: <span class="string">'/triple-tested/'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The <code>base</code> parameter also changes the local url when using <code>npm run docs:dev</code> script, thus we update <code>cypress.json</code> (and related <code>start-server-and-wait</code> parameters)</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:8080/triple-tested"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:8080/triple-tested/'</span></span><br></pre></td></tr></table></figure><p>Let&#39;s push the commit, the local tests pass, then the deploy happens. And now the post-deploy Cypress tests pass!</p><p><img src="/blog/images/triple-tested/deploy-tests-passed.png" alt="Post-deploy CI job passes"></p><p>We can check the site at GitHub Pages - it is working.</p><p><img src="/blog/images/triple-tested/working-site.gif" alt="The site is working correctly"></p><p>Great!</p><h2><span id="preventing-broken-deployments">Preventing broken deployments</span></h2><p>Can we prevent a broken site from being deployed to production in the first place? Could we have caught an invalid or missing <code>base</code> configuration?</p><p>When we tested the site in the section <a href="#local-test-on-ci">Local test on CI</a>, we used the development VuePress server via <code>vuepress dev docs</code> command. The served site passed the tests, then we built the production version and deployed it. We then ran the production site - which failed at first. We should have tested the production version before deployment in a way <em>similar to the production site</em>. I have already showed that we can serve the <code>dist</code> folder using <a href="https://github.com/zeit/serve" target="_blank" rel="noopener">serve</a> module: <code>$ npx serve docs/.vuepress/dist</code>.</p><p>Let&#39;s simulate the broken build again by removing the <code>base</code> property from the file <code>docs/.vuepress/config.js</code>:</p><figure class="highlight js"><figcaption><span>docs/.vuepress/config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  title: <span class="string">'Triple Tested'</span>,</span><br><span class="line">  description: <span class="string">'Example static site'</span>,</span><br><span class="line">  <span class="comment">// removing "base" property to break production site</span></span><br><span class="line">  <span class="comment">// base: '/triple-tested/'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>To simulate sub path, we can serve the bundle from a nested folder.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> build the production site</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm run docs:build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir output</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp -r docs/.vuepress/dist output/triple-tested</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">let</span><span class="string">'s look at the "production" folder</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -la output</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x   3 gleb  staff   96 Mar 23 22:02 .</span><br><span class="line">drwxr-xr-x  14 gleb  staff  448 Mar 23 22:02 ..</span><br><span class="line">drwxr-xr-x   5 gleb  staff  160 Mar 23 22:02 triple-tested</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -la output/triple-tested/</span></span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 23 22:02 .</span><br><span class="line">drwxr-xr-x  3 gleb  staff    96 Mar 23 22:02 ..</span><br><span class="line">-rw-r--r--  1 gleb  staff  2990 Mar 23 22:02 about.html</span><br><span class="line">drwxr-xr-x  5 gleb  staff   160 Mar 23 22:02 assets</span><br><span class="line">-rw-r--r--  1 gleb  staff  2512 Mar 23 22:02 index.html</span><br></pre></td></tr></table></figure><p>Now let&#39;s serve the <code>output</code> folder</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx serve output</span></span><br><span class="line"></span><br><span class="line">   ┌────────────────────────────────────────────────┐</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Serving!                                     │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   - Local:            http://localhost:5000    │</span><br><span class="line">   │   - On Your Network:  http://10.0.0.124:5000   │</span><br><span class="line">   │                                                │</span><br><span class="line">   │   Copied local address to clipboard!           │</span><br><span class="line">   │                                                │</span><br><span class="line">   └────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>Open <code>http://localhost:5000/triple-tested</code> in the browser to see exactly the same broken site as we had in production before.</p><p><img src="/blog/images/triple-tested/serve-output.png" alt="Accessing the sub path site locally shows missing resources"></p><p>Cypress catches the broken site</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_baseUrl=http://localhost:5000/triple-tested npx cypress open</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/triple-tested/broken-prod.png" alt="Testing production bundle locally"></p><p>Let&#39;s restore the <code>base</code> property in file <code>docs/.vuepress/config.js</code>, build the site, copy the <code>dist</code> folder into <code>output</code> and try again.</p><p><img src="/blog/images/triple-tested/passing-test.png" alt="Testing production site built correctly using base sub path"></p><p>Great, the tests pass when when we correctly set the <code>base</code> property. Now we need to make sure we test the production site on CI. Let&#39;s add these commands to <a href="https://github.com/bahmutov/triple-tested/blob/master/.github/workflows/ci.yml" target="_blank" rel="noopener">ci.yml</a> file</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># only deploy site from master branch</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  push:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line">      <span class="comment"># https://github.com/actions/checkout</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:8080/triple-tested/'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Build</span> <span class="string">site</span> <span class="string">🏗</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">docs:build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Prepare</span> <span class="string">built</span> <span class="string">site</span> <span class="string">for</span> <span class="string">testing</span> <span class="string">🚛</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mkdir output</span></span><br><span class="line"><span class="string">          cp -r ./docs/.vuepress/dist output/triple-tested</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">      - name:</span> <span class="string">Test</span> <span class="string">production</span> <span class="string">site</span> <span class="string">✅</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line">          <span class="comment"># we have already installed all dependencies above</span></span><br><span class="line"><span class="attr">          install:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npx serve output'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:5000/triple-tested/'</span></span><br><span class="line"><span class="attr">          config:</span> <span class="string">baseUrl=http://localhost:5000/triple-tested/</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/marketplace/actions/github-pages-action</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Deploy</span> <span class="string">🚀</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          publish_dir:</span> <span class="string">./docs/.vuepress/dist</span></span><br></pre></td></tr></table></figure><p>The GitHub Actions run and pass.</p><p><img src="/blog/images/triple-tested/gh-passed.png" alt="GitHub Actions tested the site in dev mode and as built production bundle"></p><p>The deploy went through to GitHub Pages and then was tested the 3rd time</p><p><img src="/blog/images/triple-tested/prod-tested.png" alt="Test jobs before and after deploy have passed"></p><h2><span id="tips">Tips</span></h2><p>Before I reach the <a href="#discussion">Discussion</a> section, let me give a couple of tips.</p><h3><span id="github-actions-badges">GitHub Actions badges</span></h3><p>For each GitHub workflow you can add a <a href="../trying-github-actions/#badges">badge to README file</a>. In our case we will have two separate workflows:</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">![<span class="string">ci</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/ci/badge.svg?branch=master</span>)</span><br><span class="line">![<span class="string">deployed</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/deployed/badge.svg?branch=master</span>)</span><br></pre></td></tr></table></figure><p>If you want each badge to lead immediately to matching workflow, add destination urls</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">![ci</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/ci/badge.svg?branch=master</span>)](<span class="link">https://github.com/bahmutov/triple-tested/actions?query=workflow%3Aci</span>)</span><br><span class="line">[<span class="string">![deployed</span>](<span class="link">https://github.com/bahmutov/triple-tested/workflows/deployed/badge.svg?branch=master</span>)](<span class="link">https://github.com/bahmutov/triple-tested/actions?query=workflow%3Adeployed</span>)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/triple-tested/badges.png" alt="CI badges"></p><h3><span id="environment-variables">Environment variables</span></h3><p>We can avoid hard-coding the production URL in several places in CI configuration files, and instead can use <a href="https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables" target="_blank" rel="noopener">GitHub environment variables</a> to specify the base url to test.</p><p>Instead of</p><figure class="highlight yml"><figcaption><span>deployed.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    config:</span> <span class="string">baseUrl=https://glebbahmutov.com/triple-tested/</span></span><br></pre></td></tr></table></figure><p>we will set the <code>CYPRESS_baseUrl</code> at the job level</p><figure class="highlight yml"><figcaption><span>deployed.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">deployed</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line"><span class="attr">  status:</span></span><br><span class="line"><span class="attr">    branches:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test-deployed-page:</span></span><br><span class="line"><span class="attr">    if:</span> <span class="string">github.event.context</span> <span class="string">==</span> <span class="string">'github/pages'</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.state</span> <span class="string">==</span> <span class="string">'success'</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    env:</span></span><br><span class="line"><span class="attr">      CYPRESS_baseUrl:</span> <span class="attr">https://glebbahmutov.com/triple-tested/</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">echo</span> <span class="string">"gh-pages 📑 built successfully ✅"</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">show</span> <span class="string">deployed</span> <span class="string">page</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">curl</span> <span class="bullet">-s</span> <span class="string">$CYPRESS_baseUrl</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># we need our source code that has package.json and Cypress specs</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span> <span class="string">🛎️</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          persist-credentials:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br></pre></td></tr></table></figure><h3><span id="record-to-dashboard">Record to Dashboard</span></h3><p>GitHub Actions give you a lot of free resources for public repositories. But storing and viewing the Cypress test artifacts (screenshots on failure, videos of the test runs, test results) is inconvenient. Thus I recommend using <a href="https://on.cypress.io/dashboard-introduction" target="_blank" rel="noopener">Cypress Dashboard</a> to record the tests.</p><p>I have <a href="https://on.cypress.io/projects" target="_blank" rel="noopener">set up project to record</a> and stored the <code>CYPRESS_RECORD_KEY</code> as a secret at GitHub repo settings.</p><p><img src="/blog/images/triple-tested/record-key.png" alt="Cypress record key kept in secrets"></p><p>We can set the secret as environment variable in the specific steps that run Cypress tests, and pass <code>record: true</code> parameter. You can find all parameters in examples inside the <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a> repository.</p><figure class="highlight yml"><figcaption><span>ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">test</span> <span class="string">📦✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npm run docs:dev'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:8080/triple-tested/'</span></span><br><span class="line"><span class="attr">    record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">'development'</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">'ci'</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Test</span> <span class="string">production</span> <span class="string">site</span> <span class="string">✅</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line">    <span class="comment"># we have already installed all dependencies above</span></span><br><span class="line"><span class="attr">    install:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    start:</span> <span class="string">'npx serve output'</span></span><br><span class="line"><span class="attr">    wait-on:</span> <span class="string">'http://localhost:5000/triple-tested/'</span></span><br><span class="line"><span class="attr">    config:</span> <span class="string">baseUrl=http://localhost:5000/triple-tested/</span></span><br><span class="line"><span class="attr">    record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">'production bundle'</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p>In the <code>deployed.yml</code> workflow we similarly record the test results</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">- uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span> <span class="string">deployed</span> <span class="string">site</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">'production'</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>You can add a badge to the README.md pointing at the project&#39;s dashboard, so users can find the test results. The project Id is stored in <code>cypress.json</code> file, in our case it is <code>rroimy</code>.</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">![Cypress Dashboard</span>](<span class="link">https://img.shields.io/badge/cypress-dashboard-brightgreen.svg</span>)](<span class="link">https://dashboard.cypress.io/#/projects/rroimy/runs</span>)</span><br></pre></td></tr></table></figure><p>See results for yourself: <a href="https://dashboard.cypress.io/#/projects/rroimy/runs" target="_blank" rel="noopener">Cypress Dashboard</a></p><p>For each deployment, we see two runs: one is tagged <code>ci</code> and and the second one is tagged <code>production</code>.</p><p><img src="/blog/images/triple-tested/runs.png" alt="Two runs for each deployment"></p><p>In the run tagged <code>ci</code>, the two sets of tests are in two groups:</p><p><img src="/blog/images/triple-tested/ci-runs.png" alt="CI run has two groups of tests"></p><p>Each spec has its video captured, and if there were any failures, there would be screenshots too.</p><h2><span id="discussion">Discussion</span></h2><p>I have shown how to build, test and deploy a static site using GitHub Actions and Pages working together. Because many things can go wrong, I have tested the site three times:</p><ul><li>First using the development server that comes with VuePress.</li><li>Second time after building the production version by serving it locally to simulate the sub path hosting</li><li>Third time after deployment to check if the production site is working for my users</li></ul><p>While triple testing might seem like an overkill, I hope you see why it was necessary. We ran end-to-end tests after each major code transformation: building the production bundle is such a big change, it was necessary to validate the produced bundle. Deploying the site to GitHub Pages is also a big change, so we want to run tests after that. GitHub Actions allowed us to run Cypress tests in all scenarios.</p><p>We did not have to run <em>all tests</em> in every scenario. For example, we could have executed just a few smoke tests after building the production bundles and after the deployment. Read the blog post <a href="https://www.cypress.io/blog/2019/12/06/use-meaningful-smoke-tests/" target="_blank" rel="noopener">Use meaningful smoke tests</a> about running a small  subset of tests.</p><p><strong>Source code:</strong> you can find the code for this blog post in <a href="https://github.com/bahmutov/triple-tested" target="_blank" rel="noopener">bahmutov/triple-tested</a>. You can see the finished (well-tested) version of the site deployed at <a href="https://glebbahmutov.com/triple-tested/">https://glebbahmutov.com/triple-tested/</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;This blog post shows something I have wanted to achieve for a while: &lt;strong&gt;deploying a fully tested static site or a web application an
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>CitizenClimateLobby short pitch</title>
    <link href="https://glebbahmutov.com/blog/ccl-pitch-at-pkg/"/>
    <id>https://glebbahmutov.com/blog/ccl-pitch-at-pkg/</id>
    <published>2020-03-05T05:00:00.000Z</published>
    <updated>2020-03-06T14:00:38.963Z</updated>
    
    <content type="html"><![CDATA[<p>Hi,</p><p>Solving climate crisis is tough. It requires us to change how we behave individually, as communities, and as a city. It will require changes at the state level, but most importantly it requires addressing the problem head-on as a nation.</p><p>I personally think that safe and abundant renewable power is almost here - we have the technology and it already beats coal on price. And the only reason it has not replaced oil and fracking gas is because they don&#39;t pay for the pollution they cause.</p><p>This is where <a href="https://citizensclimatelobby.org/" target="_blank" rel="noopener">CitizenClimateLobby</a> comes in. We are completely non-partizan organization that works at the federal level, and we are successful. We now have in the House the bill called &quot;<a href="https://energyinnovationact.org/" target="_blank" rel="noopener">Energy Innovation and Carbon Dividend Act</a>&quot; that we lobby for, and it has 80 co-sponsors, both Democrats and Republicans. This bill HR 763 will tax every fossil fuel the moment it gets extracted from the ground. This tax would be collected and then distributed to every citizen of the United States. You get this check and buy renewables that suddenly are so much cheaper.</p><p>The bill is NOT the full solution, but a significant step to making the economics of renewables very very attractive.</p><p>Join us - we have a table over there with Gary - we lobby the Congress via personal visits, phone calling and media campaigns, and endorsements from the industry and prominent individuals.</p><p>Make the fossil fuel pollution expensive - and the world will get greener.</p><ul><li><a href="https://citizensclimatelobby.org/" target="_blank" rel="noopener">https://citizensclimatelobby.org/</a></li><li><a href="https://citizensclimatelobby.org/monthly-calling-campaign/" target="_blank" rel="noopener">https://citizensclimatelobby.org/monthly-calling-campaign/</a></li><li><a href="https://energyinnovationact.org/" target="_blank" rel="noopener">https://energyinnovationact.org/</a></li><li><a href="https://www.eventbrite.com/e/pkg-2020-community-conversations-climate-change-tickets-89265199615" target="_blank" rel="noopener">PKG Community Meeting page</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Hi,&lt;/p&gt;
&lt;p&gt;Solving climate crisis is tough. It requires us to change how we behave individually, as communities, and as a city. It will r
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Support Node 6 installs</title>
    <link href="https://glebbahmutov.com/blog/support-node6-installs/"/>
    <id>https://glebbahmutov.com/blog/support-node6-installs/</id>
    <published>2020-03-03T05:00:00.000Z</published>
    <updated>2020-03-03T14:52:02.360Z</updated>
    
    <content type="html"><![CDATA[<p>What is the minimum version of Node your NPM module requires? You might think it is Node 8 or Node 10 or even Node 6. But in reality you don&#39;t know - because the direct or transient NPM dependencies your project uses might require a different <em>higher</em> version, without even declaring it explicitly in the <code>engines</code> field of their <code>package.json</code> files.</p><p>Recently, we have experienced sudden &quot;bumps&quot; in minimum Node version required for our Cypress NPM package because of <a href="https://github.com/chalk/chalk" target="_blank" rel="noopener">chalk</a> and <a href="https://github.com/sindresorhus/execa" target="_blank" rel="noopener">execa</a> dependencies. While we promised supporting Node v8.0.0, due to these dependencies our true minimum Node version turned out to be v8.12.0!</p><p>The only reliable way to determine if your project runs on Node 8.0.0 is to run your NPM package on Node 8.0.0. In this blog post I will show how to bundle and transpile your NPM package so it truly runs on Node v8.0.0 or even on Node v6.</p><p><strong>Note:</strong> you can find the source code at <a href="https://github.com/bahmutov/support-node-v6" target="_blank" rel="noopener">bahmutov/support-node-v6</a></p><h2><span id="the-problem">The problem</span></h2><p>Let&#39;s start a new NPM application that uses <code>chalk</code> and <code>execa</code> to print the list of files. We want to use the latest versions of all the tools, so we are working on Node v12</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~/git/support-node-v6 on master</span><br><span class="line"><span class="meta">$</span><span class="bash"> nvm use 12</span></span><br><span class="line">Now using node v12.13.0 (npm v6.13.7)</span><br><span class="line">~/git/support-node-v6 on master</span><br><span class="line"><span class="meta">$</span><span class="bash"> npm i -S chalk execa</span></span><br><span class="line">npm notice created a lockfile as package-lock.json. You should commit this file.</span><br><span class="line">+ chalk@3.0.0</span><br><span class="line">+ execa@4.0.0</span><br></pre></td></tr></table></figure><p>Here is our application file <code>index.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Chalk is <span class="subst">$&#123;chalk.red(<span class="string">'working'</span>)&#125;</span> if you saw red`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> execa = <span class="built_in">require</span>(<span class="string">'execa'</span>)</span><br><span class="line">execa(<span class="string">'ls'</span>, [<span class="string">'-la'</span>]).then(<span class="function"><span class="params">r</span> =&gt;</span> r.stdout).then(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure><p>The app runs and the colors show up (on Node v12)</p><p><img src="/blog/images/support-node6/app.png" alt="chalk and execa work on Node 12"></p><p>Now let&#39;s try the same application on Node v6.</p><p><img src="/blog/images/support-node6/chalk-uses-spread.png" alt="chalk uses spread operator"></p><p>Because <code>chalk</code> uses spread operator, it does not run on Node v6 - and you would need to downgrade to <a href="mailto:`chalk@2.4.2" target="_blank" rel="noopener">`chalk@2.4.2</a><code>. But then the same happens with</code>execa` - it also uses the spread operator!</p><p><img src="/blog/images/support-node6/execa-uses-spread.png" alt="execa uses spread operator"></p><p>You would need to downgrade <code>execa</code> all the way to v1 to get the syntax compatible with Node v6. In the process you just lost soooo many features and fixes from <code>execa</code> and <code>chalk</code>, it is almost sad.</p><p><img src="/blog/images/support-node6/execa-v1.png" alt="execa v1 and chalk v2 work on Node 6"></p><h2><span id="bundling">Bundling</span></h2><p>Let&#39;s switch tactics. Instead of searching for an old version of <code>chalk</code> and <code>execa</code>, let&#39;s install the latest versions - and let&#39;s bundle them into a single JavaScript file. Typically, bundling is done for browsers, but we will use <a href="https://github.com/zeit/ncc" target="_blank" rel="noopener">@zeit/ncc</a> to bundle <em>for Node</em>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -S chalk execa</span><br><span class="line">+ execa@4.0.0</span><br><span class="line">+ chalk@3.0.0</span><br><span class="line">$ npm i -D @zeit/ncc</span><br><span class="line">+ @zeit/ncc@0.21.1</span><br></pre></td></tr></table></figure><p>We can use <code>ncc</code> to produce a single JavaScript file from <code>index.js</code> entry using <code>npm run build</code> script</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ npm run build</span><br><span class="line"></span><br><span class="line">&gt; support-node-v6@1.0.0 build /Users/gleb/git/support-node-v6</span><br><span class="line">&gt; ncc build index.js</span><br><span class="line"></span><br><span class="line">ncc: Version 0.21.1</span><br><span class="line">ncc: Compiling file index.js</span><br><span class="line">106kB  dist/index.js</span><br><span class="line">106kB  [920ms] - ncc 0.21.1</span><br></pre></td></tr></table></figure><p>The bundle we produced does not run on Node 6 yet.</p><p><img src="/blog/images/support-node6/bundle.png" alt="bundle does not work on Node 6 yet"></p><p>But the bundle has <em>all</em> dependencies included. We can remove <code>node_modules</code> folder and run it to prove this.</p><p><img src="/blog/images/support-node6/works-without-node-modules.png" alt="bundle works without node_modules folder"></p><p>Now we can transpile this single file to make it work on (almost) any Node version.</p><h2><span id="transpiling-down">Transpiling down</span></h2><p>I like using TypeScript compiler to transpile code.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 dist/index.js --outFile dist/out.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@types/node"</span>: <span class="string">"13.7.6"</span>,</span><br><span class="line">    <span class="attr">"typescript"</span>: <span class="string">"3.8.2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This <em>almost</em> works.</p><p><img src="/blog/images/support-node6/needs-entries.png" alt="transpile almost works"></p><p>The bundle is transpiled - the spread operators in <code>chalk</code> and <code>execa</code> have been replaced, but the bundle still has <code>Object.entries</code> method that Node v6 does not understand. We can polyfill this method though.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -S babel-polyfill</span><br><span class="line">+ babel-polyfill@6.26.0</span><br></pre></td></tr></table></figure><p>Then require the polyfill from <code>index.js</code> file</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'babel-polyfill'</span>)</span><br></pre></td></tr></table></figure><p>Let&#39;s build and transpile again.</p><p><img src="/blog/images/support-node6/works-on-node6.png" alt="works on Node 6"></p><p>Nice, the latest dependencies do work on Node v6!</p><h2><span id="tips">Tips</span></h2><h3><span id="run-scripts">Run scripts</span></h3><p>Since we only plan to distribute a single bundle, we can generate the intermediate bundle in the <code>build</code> folder, and run the transpile step post-build.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js --out build"</span>,</span><br><span class="line">    <span class="attr">"postbuild"</span>: <span class="string">"npm run transpile"</span>,</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 build/index.js --outFile dist/index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dist"</span>,</span><br><span class="line">  <span class="attr">"files"</span>: [<span class="string">"dist"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="specify-bundled-dependencies">Specify bundled dependencies</span></h3><p>We can see the produced bundle using <code>npm pack --dry</code> command.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ npm run build</span><br><span class="line">...</span><br><span class="line">$ npm pack --dry</span><br><span class="line">npm notice</span><br><span class="line">npm notice 📦  support-node-v6@1.0.0</span><br><span class="line">npm notice === Tarball Contents ===</span><br><span class="line">npm notice 598.9kB dist/index.js</span><br><span class="line">npm notice 895B    package.json</span><br><span class="line">npm notice === Tarball Details ===</span><br><span class="line">npm notice name:          support-node-v6</span><br><span class="line">npm notice version:       1.0.0</span><br><span class="line">npm notice filename:      support-node-v6-1.0.0.tgz</span><br><span class="line">npm notice package size:  114.0 kB</span><br><span class="line">npm notice unpacked size: 599.8 kB</span><br><span class="line">npm notice shasum:        f5c816747afe915e9e6cb5ad483050dbe60df662</span><br><span class="line">npm notice integrity:     sha512-pRaaeDthI0+7C[...]XYiVKrziJa60w==</span><br><span class="line">npm notice total files:   2</span><br><span class="line">npm notice</span><br><span class="line">support-node-v6-1.0.0.tgz</span><br></pre></td></tr></table></figure><p>The zipped archive has size 114 kB, which looks like a lot. But remember, that anyone installing this NPM app should only download this single file, which should be as fast as downloading multiple production dependencies. But we still list <code>execa</code> and <code>chalk</code> as production dependencies, thus our users will get two copies of them - the second one coming from the <code>dist/index.js</code> bundle.</p><p>Hmm, NPM understands <a href="http://npm.github.io/using-pkgs-docs/package-json/types/bundleddependencies.html" target="_blank" rel="noopener">bundled dependencies</a> list, but this list forces <code>chalk</code> and <code>execa</code> into the TGZ archive twice!</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dist"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js --out build"</span>,</span><br><span class="line">    <span class="attr">"postbuild"</span>: <span class="string">"npm run transpile"</span>,</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 build/index.js --outFile dist/index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"files"</span>: [<span class="string">"dist"</span>],</span><br><span class="line">  <span class="attr">"bundledDependencies"</span>: [<span class="string">"babel-polyfill"</span>, <span class="string">"chalk"</span>, <span class="string">"execa"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ npm pack --dry</span><br><span class="line">npm notice</span><br><span class="line">npm notice 📦  support-node-v6@1.0.0</span><br><span class="line">npm notice === Tarball Contents ===</span><br><span class="line">npm notice 598.9kB dist/index.js</span><br><span class="line">npm notice 958B    package.json</span><br><span class="line">npm notice === Bundled Dependencies ===</span><br><span class="line">npm notice babel-polyfill</span><br><span class="line">npm notice chalk</span><br><span class="line">npm notice execa</span><br><span class="line">npm notice === Tarball Details ===</span><br><span class="line">npm notice name:          support-node-v6</span><br><span class="line">npm notice version:       1.0.0</span><br><span class="line">npm notice filename:      support-node-v6-1.0.0.tgz</span><br><span class="line">npm notice package size:  930.7 kB</span><br><span class="line">npm notice unpacked size: 3.8 MB</span><br><span class="line">npm notice shasum:        aec06c58bc556e0050e54f690ed936978a45341f</span><br><span class="line">npm notice integrity:     sha512-+KVCnHxym0jYp[...]moDzoUVuxD6kQ==</span><br><span class="line">npm notice bundled deps:  3</span><br><span class="line">npm notice bundled files: 1910</span><br><span class="line">npm notice own files:     2</span><br><span class="line">npm notice total files:   1912</span><br><span class="line">npm notice</span><br><span class="line">support-node-v6-1.0.0.tgz</span><br></pre></td></tr></table></figure><p>Thus my advice is to move all production dependencies into <code>devDependencies</code> - they will be included in the bundle as needed and skip using <code>bundledDependencies</code>.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"support-node-v6"</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dist"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build index.js --out build"</span>,</span><br><span class="line">    <span class="attr">"postbuild"</span>: <span class="string">"npm run transpile"</span>,</span><br><span class="line">    <span class="attr">"transpile"</span>: <span class="string">"tsc --allowJs --target ES5 build/index.js --outFile dist/index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"files"</span>: [<span class="string">"dist"</span>],</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"babel-polyfill"</span>: <span class="string">"6.26.0"</span>,</span><br><span class="line">    <span class="attr">"chalk"</span>: <span class="string">"3.0.0"</span>,</span><br><span class="line">    <span class="attr">"execa"</span>: <span class="string">"4.0.0"</span>,</span><br><span class="line">    <span class="attr">"@types/node"</span>: <span class="string">"13.7.7"</span>,</span><br><span class="line">    <span class="attr">"@zeit/ncc"</span>: <span class="string">"0.21.1"</span>,</span><br><span class="line">    <span class="attr">"typescript"</span>: <span class="string">"3.8.3"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s make sure the bundled dependencies work. I have created a new NPM package in a different folder and will install and run the above project using Node v6.</p><p><img src="/blog/images/support-node6/install-from-another-project.png" alt="installing and running the bundled app on Node 6"></p><p>Perfect.</p><h3><span id="source-maps">Source maps</span></h3><p>While <code>@zeit/ncc</code> and <code>typescript</code> can both generate source maps, I could not find a way to connect the two to get the source maps to link an error back to the <em>original</em> source file. If you know how to do this, open a pull request in <a href="https://github.com/bahmutov/support-node-v6" target="_blank" rel="noopener">bahmutov/support-node-v6</a>, please.</p><h3><span id="unsupported-features">Unsupported features</span></h3><p>Some ES6+ syntax and features cannot be transpiled down, for example if your project requires WeakMaps or Proxies - you are out of luck.</p><h2><span id="alternative-use-parcel">alternative: use Parcel</span></h2><p>Instead of <code>@zeit/ncc</code> we can use <a href="https://github.com/parcel-bundler/parcel" target="_blank" rel="noopener">Parcel bundler</a> to bundle code like this:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"parcel build index.js --target node --bundle-node-modules --no-minify"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"parcel-bundler"</span>: <span class="string">"1.12.4"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="see-also">See also</span></h2><ul><li><a href="../javascript-needs-compile-step/">JavaScript needs compile step</a></li><li><a href="../precompiled-javascript/">Precompiled JavaScript</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;What is the minimum version of Node your NPM module requires? You might think it is Node 8 or Node 10 or even Node 6. But in reality you 
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="javascript" scheme="https://glebbahmutov.com/blog/tags/javascript/"/>
    
      <category term="nodejs" scheme="https://glebbahmutov.com/blog/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>Check links in your Markdown documents</title>
    <link href="https://glebbahmutov.com/blog/check-markdown-links/"/>
    <id>https://glebbahmutov.com/blog/check-markdown-links/</id>
    <published>2020-02-12T05:00:00.000Z</published>
    <updated>2020-04-11T19:14:25.851Z</updated>
    
    <content type="html"><![CDATA[<p>I want to sleep better at night, I want to know, everyone who is reading one of the many README files in my <a href="https://github.com/bahmutov/repositories" target="_blank" rel="noopener">GitHub repositories</a> has correct URLs. I love adding links to examples, blog posts, other repos - and I hate when a link is incorrect. In this blog post I will show how to check URLs from Markdown files.</p><ol><li>Install <a href="https://github.com/tcort/markdown-link-check" target="_blank" rel="noopener">markdown-link-check</a> with</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D markdown-link-check</span><br></pre></td></tr></table></figure><ol start="2"><li>Add NPM script for finding all top-level Markdown files (you can modify <code>find</code> command <a href="https://www.computerhope.com/unix/ufind.htm" target="_blank" rel="noopener">1]</a>, <a href="https://www.cyberciti.biz/faq/find-command-exclude-ignore-files/" target="_blank" rel="noopener">2</a> to find more files, if needed). Don&#39;t forget to escape <code>\</code> characters.</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"check:markdown"</span>: <span class="string">"find *.md -exec npx markdown-link-check &#123;&#125; \\;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Notice both external and local links are checked, but not the <a href="https://github.com/tcort/markdown-link-check/issues/91" target="_blank" rel="noopener">anchor tags ⚠️</a>.</p><p>You can check URLs on Mac and Linux with <code>npm run check:markdown</code> command:</p><p><img src="/blog/images/check-urls/terminal.png" alt="checking the links locally"></p><ol start="3"><li>Call the same script on CI to avoid breaking the links in the future</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="attr">check:markdown</span></span><br></pre></td></tr></table></figure><p><img src="/blog/images/check-urls/ci.png" alt="checking the links on CI"></p><p>We can even find all Markdown files, while excluding <code>node_modules</code> folder with command</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -type f -name '*.md' ! -path './node_modules/*' ! -path './examples/*' -exec npx markdown-link-check --quiet &#123;&#125; \;</span><br></pre></td></tr></table></figure><h2><span id="exit-code">Exit code</span></h2><p>We have a problem ... the <code>find -exec</code> will feed each file to <code>markdown-link-check</code> and if one has an error, it just continues onto the next Markdown file, swallowing the error.</p><p>Instead, let&#39;s find all files likes this</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -type f -name '*.md' ! -path './node_modules/*'</span><br></pre></td></tr></table></figure><p>This prints each found filename per line like this</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> find . -<span class="built_in">type</span> f -name <span class="string">'*.md'</span> ! -path <span class="string">'./node_modules/*'</span></span></span><br><span class="line">./CODE_OF_CONDUCT.md</span><br><span class="line">./README.md</span><br><span class="line">./browsers/node12.0.0-chrome73-ff68/README.md</span><br><span class="line">./browsers/node8.15.1-chrome73/README.md</span><br><span class="line">./browsers/node10.2.1-chrome74/README.md</span><br><span class="line">./browsers/node13.3.0-chrome79-ff70/README.md</span><br><span class="line">./browsers/node12.13.0-chrome78-ff70-brave78/README.md</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>We can feed these lines into <a href="https://shapeshed.com/unix-xargs/" target="_blank" rel="noopener">xargs</a> program using <code>-L1</code> argument (one argument per lint).</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -type f -name '*.md' ! -path './node_modules/*' | xargs -L1 npx markdown-link-check --quiet</span><br></pre></td></tr></table></figure><p>Now we are talking</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> find . -<span class="built_in">type</span> f -name <span class="string">'*.md'</span> ! -path <span class="string">'./node_modules/*'</span> | xargs -L1 npx markdown-link-check --quiet</span></span><br><span class="line"></span><br><span class="line">FILE: ./CODE_OF_CONDUCT.md</span><br><span class="line"></span><br><span class="line">3 links checked.</span><br><span class="line"></span><br><span class="line">FILE: ./README.md</span><br><span class="line"></span><br><span class="line">23 links checked.</span><br><span class="line"></span><br><span class="line">FILE: ./browsers/node12.0.0-chrome73-ff68/README.md</span><br><span class="line"></span><br><span class="line">1 links checked.</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">FILE: ./base/README.md</span><br><span class="line">[✖] ubuntu16-8.16.2</span><br><span class="line">[✖] /ubuntu18-node12.14.1</span><br><span class="line">[✖] /ubuntu19-node12.14.1</span><br><span class="line"></span><br><span class="line">38 links checked.</span><br><span class="line"></span><br><span class="line">ERROR: 3 dead links found!</span><br><span class="line">[✖] ubuntu16-8.16.2 → Status: 400</span><br><span class="line">[✖] /ubuntu18-node12.14.1 → Status: 400</span><br><span class="line">[✖] /ubuntu19-node12.14.1 → Status: 400</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">FILE: ./included/3.6.1/README.md</span><br><span class="line"></span><br><span class="line">1 links checked.</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> $?</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>The search fails if any of the links are bad. Now I can sleep tight.</p><p>See example in <a href="https://github.com/cypress-io/cypress-docker-images/pull/244" target="_blank" rel="noopener">cypress-docker-images</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I want to sleep better at night, I want to know, everyone who is reading one of the many README files in my &lt;a href=&quot;https://github.com/b
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="markdown" scheme="https://glebbahmutov.com/blog/tags/markdown/"/>
    
  </entry>
  
  <entry>
    <title>My testimony in support of banning gas infrastructure in new construction in Cambridge, MA</title>
    <link href="https://glebbahmutov.com/blog/gas-ban-testimony/"/>
    <id>https://glebbahmutov.com/blog/gas-ban-testimony/</id>
    <published>2020-01-27T05:00:00.000Z</published>
    <updated>2020-01-29T14:33:53.001Z</updated>
    
    <content type="html"><![CDATA[<p>Tonight I went down to the Cambridge City Council meeting to voice my support for <a href="https://insideclimatenews.org/news/12122019/natural-gas-ban-cities-legal-cambridge-brookline-massachusetts-state-law-berkeley-california" target="_blank" rel="noopener">banning gas infrastructure in new building construction</a>. This is the testimony I gave in front of the mayor and the council.</p><p>Madam mayor, and the council. I am Gleb Bahmutov, I live at Winslow st, I love Cambridge. I am here tonight to express my strongest support for the proposed gas infrastructure in new buildings.</p><p>Last weekend I have enjoyed the unseasonably warm weather. I have enjoyed it for 10 minutes, but then I became terrified. This is abnormal and what will the summer be like? Will we be like Australia and burn? Or more likely will we have a long heat spell that will kill all the crops?</p><p>Terry Eliasen (meteorologist from WBC/CBS Boston) <a href="https://twitter.com/terrywbz/status/1221811069469044738?s=21" target="_blank" rel="noopener">tweeted today</a> that the average Boston temperature was higher than normal by 9.2 F in January. The scientists warn that to avoid the worst consequences of global warming, we need to limit the rise to 1.5 - 2 degrees Celsius, which is 4-5 degrees F. We are at 9.2.If this is not an emergency, I do not know what is.</p><p><img src="/blog/images/warm-january.png" alt="warm January in Boston"></p><p>The Rolling Stones magazine <a href="https://www.rollingstone.com/politics/politics-features/oil-gas-fracking-radioactive-investigation-937389/" target="_blank" rel="noopener">reported last week</a> that brine - the water from fracking they use to push the gases from under the ground is radioactive due to naturally occurring Radon gas but the radiation is concentrated. The industry does not measure the radioactivity, since they don&#39;t want to know it. But if they have to deal with low-level radioactive waste disposal, it will increase the cost of gas by a factor of 100 - and this is even without taking into account gas carbon price we all are about to start paying one way or another.</p><p>Building new gas infrastructure right now means the customers will be locked into paying sharply increasing prices in the nearest future.</p><p>We have plenty of natural offshore wind and solar resources to satisfy all our electricity needs many times over. To say that we can’t switch to all green, all renewable, all safe electricity 50 years after we went to the Moon is a lie, and not a very convincing lie.</p><p>Ban gas infrastructure now.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Tonight I went down to the Cambridge City Council meeting to voice my support for &lt;a href=&quot;https://insideclimatenews.org/news/12122019/na
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>A plea for climate in year 2020</title>
    <link href="https://glebbahmutov.com/blog/a-plea-for-climate-2020/"/>
    <id>https://glebbahmutov.com/blog/a-plea-for-climate-2020/</id>
    <published>2019-12-29T05:00:00.000Z</published>
    <updated>2019-12-29T20:08:49.286Z</updated>
    
    <content type="html"><![CDATA[<p>This is an email I have sent to my friends at the end of December 2019.</p><p>Hello friends,</p><p>Season greetings from Irina, Sky and me, we wish you all the best in 2020!As a new year resolution, we would like to ask everyone to take a moment to think about the climate crisis unfolding around us. If you follow the news, you can see something else going very bad: Australia is on fire, Amazon is burning due to greed, and many places in the world are experiencing water shortages - all are the effects of the warming Earth due to fossil emissions. Many scientists are trying to bring attention to the effects of global climate change in our near future. We are especially worried about Sky and the dead planet he might have to live on as an adult.To learn more about the problem, take a look at <a href="https://www.ipcc.ch/" target="_blank" rel="noopener">https://www.ipcc.ch/</a> and popular summaries in articles like <a href="https://www.theguardian.com/environment/2018/oct/08/global-warming-must-not-exceed-15c-warns-landmark-un-report" target="_blank" rel="noopener">https://www.theguardian.com/environment/2018/oct/08/global-warming-must-not-exceed-15c-warns-landmark-un-report</a> and <a href="https://www.theguardian.com/environment/2018/aug/06/domino-effect-of-climate-events-could-push-earth-into-a-hothouse-state" target="_blank" rel="noopener">https://www.theguardian.com/environment/2018/aug/06/domino-effect-of-climate-events-could-push-earth-into-a-hothouse-state</a> and <a href="https://interactive.carbonbrief.org/impacts-climate-change-one-point-five-degrees-two-degrees/" target="_blank" rel="noopener">https://interactive.carbonbrief.org/impacts-climate-change-one-point-five-degrees-two-degrees/</a> Unfortunately, the governments around the world are not acting with the urgency this crisis requires. It is up to us to save our home for ourselves and our children.</p><p>We are asking you to make a plan in 2020 to attend at least 1 meeting of each volunteer organization below. These are people like you and me trying to avert this catastrophe. You can find a local chapter pretty much everywhere across the USA.</p><p>These are the ones we attend regularly:</p><ul><li><a href="https://350.org/" target="_blank" rel="noopener">https://350.org/</a> acts locally and at the state level to switch to renewable energy</li><li><a href="https://citizensclimatelobby.org/" target="_blank" rel="noopener">https://citizensclimatelobby.org/</a> is trying to pass a federal law to put a price on fossil fuels</li><li><a href="https://www.sunrisemovement.org/" target="_blank" rel="noopener">https://www.sunrisemovement.org/</a> and <a href="https://rebellion.global/" target="_blank" rel="noopener">https://rebellion.global/</a> organize strikes and marches around the world to force politicians to act</li></ul><p>Thank you in advance.--Gleb, Irina and Sky</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;This is an email I have sent to my friends at the end of December 2019.&lt;/p&gt;
&lt;p&gt;Hello friends,&lt;/p&gt;
&lt;p&gt;Season greetings from Irina, Sky and
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Paint roof white</title>
    <link href="https://glebbahmutov.com/blog/paint-roof-white/"/>
    <id>https://glebbahmutov.com/blog/paint-roof-white/</id>
    <published>2019-12-28T05:00:00.000Z</published>
    <updated>2019-12-28T03:59:54.824Z</updated>
    
    <content type="html"><![CDATA[<p>My house is tall and narrow and lacks an attic. In the summer the bedroom gets pretty hot - because the black rubber coating of the flat roof got really really hot. I could not touch it on a sunny day without burning myself. So I have painted it white using <a href="https://www.homedepot.com/p/Henry-5-Gal-687-100-Acrylic-Enviro-White-Extreme-Elastomeric-Roof-Coating-HE687406/202091034" target="_blank" rel="noopener">Henry Acrylic Enviro-White Extreme Elastomeric Roof Coating</a>.</p><p><img src="/blog/images/roof/white-roof.jpg" alt="The completed roof"></p><p>I have used less than 5 gallons of paint, and have covered the roof with three coatings. The paint is extremely thick, almost like liquid rubber, yet it rolls easily using a regular roller. It is elastomeric - meaning it stretches without cracking as it heats.</p><p><img src="/blog/images/roof/henry-paint.jpeg" alt="Henry paint"></p><p>The difference was immense. On a hot day as I left a small unpainted patch, which I could not touch with my hand, the rest of the roof was absolutely cool to the touch - warm, but fine. We will see next summer how the hot days feel.</p><p>PS: I have heard the argument that black roofs soak the sun in the winter better. I don&#39;t put much stock into that argument - the house should be well isolated, and I am suffering from the heat a lot more than from cold temperatures.</p><p>PSS: I wish I could make a roof garden, but my roof is too small and hard to access, so I picked the white paint instead.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;My house is tall and narrow and lacks an attic. In the summer the bedroom gets pretty hot - because the black rubber coating of the flat 
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Keep passwords secret in E2E tests</title>
    <link href="https://glebbahmutov.com/blog/keep-passwords-secret-in-e2e-tests/"/>
    <id>https://glebbahmutov.com/blog/keep-passwords-secret-in-e2e-tests/</id>
    <published>2019-12-01T05:00:00.000Z</published>
    <updated>2019-12-02T14:06:54.000Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#visible-password">Visible password</a></li><li><a href="#do-not-hardcode-passwords">Do not hardcode passwords</a></li><li><a href="#validate-password">Validate password</a></li><li><a href="#avoid-ui-login">Avoid UI login</a></li><li><a href="#continuous-integration">Continuous integration</a></li><li><a href="#plugins">Plugins</a></li><li><a href="#conclusions">Conclusions</a></li></ul><!-- tocstop --><p><strong>Note:</strong> source code for this blog post is the repository <a href="https://github.com/bahmutov/keep-password-secret" target="_blank" rel="noopener">bahmutov/keep-password-secret</a>.</p><h2><span id="visible-password">Visible password</span></h2><p>Imagine we have a password-protected web application. For example I have cloned <a href="https://github.com/passport/express-4.x-local-example" target="_blank" rel="noopener">passport/express-4.x-local-example</a> - you need to enter login and password to see your personal profile. We can easily write an end-to-end test for this application using <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress</a> test runner.</p><figure class="highlight js"><figcaption><span>cypress/integration/login-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in'</span>, () =&gt; &#123;</span><br><span class="line">  cy.visit(<span class="string">'/login'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=username]'</span>).type(<span class="string">'jack'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=password]'</span>).type(<span class="string">'secret'</span>)</span><br><span class="line">  cy.get(<span class="string">'[type=Submit]'</span>).click()</span><br><span class="line"></span><br><span class="line">  cy.contains(<span class="string">'a'</span>, <span class="string">'profile'</span>).should(<span class="string">'be.visible'</span>).click()</span><br><span class="line">  cy.url().should(<span class="string">'match'</span>, /profile$/)</span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>This test passes, as you can see from the test run video. It also shows the danger: the password is clearly shown in the video during &quot;TYPE&quot; command!</p><p><img src="/blog/images/secret/login-spec.gif" alt="Login spec showing the password during cy.type"></p><p>In this blog post I will show how to ways to mitigate the security risk of showing secret information like the password text during end-to-end tests. In this case, the password is local - and it is probably fine to show it in plain text. But in other situations, when testing staging or production environment, the password to the test account should NOT be visible.</p><h2><span id="do-not-hardcode-passwords">Do not hardcode passwords</span></h2><p>The first thing I would do is to remove the hard-coded password value from the test files. Right now we have the password in each spec file source code as a string <code>cy.type(&#39;secret&#39;)</code>, and instead I will pass it as an environment variable.</p><figure class="highlight js"><figcaption><span>cypress/integration/no-password-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using env variables'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  cy.visit(<span class="string">'/login'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=username]'</span>).type(username)</span><br><span class="line">  cy.get(<span class="string">'[name=password]'</span>).type(password)</span><br><span class="line">  cy.get(<span class="string">'[type=Submit]'</span>).click()</span><br><span class="line"></span><br><span class="line">  cy.contains(<span class="string">'a'</span>, <span class="string">'profile'</span>).should(<span class="string">'be.visible'</span>).click()</span><br><span class="line">  cy.url().should(<span class="string">'match'</span>, /profile$/)</span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>I believe in most cases, the <code>username</code> can be public, while <code>password</code> should be secret. Thus it is ok to store the <code>username</code> in the <code>env</code> object of <code>cypress.json</code> file. And for completeness and clarity, I store an empty value for the <code>password</code> key - this tells anyone reading the tests to expect to pass the password to make the tests work.</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"jack"</span>,</span><br><span class="line">    <span class="attr">"password"</span>: <span class="string">""</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Great - if we run Cypress now, the test will fail, because <a href="https://on.cypress.io/type" target="_blank" rel="noopener">cy.type</a> refuses to type an empty string.</p><p><img src="/blog/images/secret/no-typing-empty-strings.png" alt="cy.type will not type an empty password string"></p><p>Cypress allows several ways to pass the environment variables, in this case, the secure way is to use an environment variable <code>CYPRESS_password=...</code> when running Cypress. Cypress will stick all unknown environment variables that start with prefix <code>CYPRESS_</code> into the <code>env</code> object automatically.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> CYPRESS_password=secret npx cypress open|run</span></span><br></pre></td></tr></table></figure><p>When running tests locally I <em>strongly</em> recommend using my <a href="https://github.com/bahmutov/as-a" target="_blank" rel="noopener">as-a</a> utility to load groups of environment variables conveniently and cross-platform. In file <code>~/.as-a/.as-a.ini</code> I will add one more INI section and will place the secret password variable there.</p><figure class="highlight ini"><figcaption><span>~/.as-a/.as-a.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[kps]</span></span><br><span class="line"><span class="comment">; group of environment variables for keep-password-secret app</span></span><br><span class="line"><span class="attr">CYPRESS_password</span>=secret</span><br></pre></td></tr></table></figure><p>When running Cypress from my terminal I use</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as-a kps npx cypress open</span><br></pre></td></tr></table></figure><p>The password variable (and any other values in the block <code>kps</code>) will be injected just for the duration of the above command.</p><p>On Continuous Integration server, just set a secure environment variable <code>CYPRESS_password</code> to value <code>secret</code>. Most CIs mask such values automatically in the logs.</p><h2><span id="validate-password">Validate password</span></h2><p>If the user forgets to open Cypress with <code>CYPRESS_password=...</code>, or if the variable is not set on CI we get a cryptic error &quot;TYPE cannot type an empty string&quot;. It would be much nicer to give a meaningful error if the password string is empty, right. Here is an updated test that first verifies the username and password values before using them.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using env variables'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line">  expect(password, <span class="string">'password was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line"></span><br><span class="line">  cy.visit(<span class="string">'/login'</span>)</span><br><span class="line">  cy.get(<span class="string">'[name=username]'</span>).type(username)</span><br><span class="line">  cy.get(<span class="string">'[name=password]'</span>).type(password)</span><br><span class="line">  cy.get(<span class="string">'[type=Submit]'</span>).click()</span><br><span class="line"></span><br><span class="line">  cy.contains(<span class="string">'a'</span>, <span class="string">'profile'</span>).should(<span class="string">'be.visible'</span>).click()</span><br><span class="line">  cy.url().should(<span class="string">'match'</span>, /profile$/)</span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>It is working - if the developer is running Cypress test without <code>CYPRESS_password=...</code> they will get a nice error.</p><p><img src="/blog/images/secret/empty-password.png" alt="Explicit empty password error"></p><p>But this is dangerous too - notice that the username assertion <code>expect(username, &#39;username was set&#39;).to.be.a(&#39;string&#39;).and.not.be.empty</code> <em>prints the value</em> in the Command Log. If the password <em>is set</em> it will be visible in the video and any screenshot.</p><p><img src="/blog/images/secret/shown-password.png" alt="Actual password is shown when assertion passes"></p><p>To avoid assertion values reflected in the Command Log, we must throw an error ourselves like this.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line"><span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// it is ok for the username to be visible in the Command Log</span></span><br><span class="line">expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line"><span class="comment">// but the password value should not be shown</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">'string'</span> || !password) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Missing password value, set using CYPRESS_password=...'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Finally, we can avoid <code>cy.type(password)</code> showing the value it is typing by using <code>cy.type(password, {log: false})</code> option.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'[name=password]'</span>).type(password, &#123;<span class="attr">log</span>: <span class="literal">false</span>&#125;)</span><br></pre></td></tr></table></figure><p>Now the Command Log will not reveal the secret password value in the video or screenshot</p><p><img src="/blog/images/secret/hide.png" alt="Password is no longer shown"></p><p>Finally, sometimes I see assertions chained at the end of <code>cy.type</code> to confirm right away the value of the input element like this:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'[name=username]'</span>)</span><br><span class="line">  .type(username)</span><br><span class="line">  .should(<span class="string">'have.value'</span>, username)</span><br><span class="line">cy.get(<span class="string">'[name=password]'</span>)</span><br><span class="line">  .type(password, &#123;<span class="attr">log</span>: <span class="literal">false</span>&#125;)</span><br><span class="line">  .should(<span class="string">'have.value'</span>, password)</span><br></pre></td></tr></table></figure><p>The assertion <code>.should(&#39;have.value&#39;, ...)</code> also prints the value in the Command Log as shown below, revealing the password, even if just part of it in this case.</p><p><img src="/blog/images/secret/partial-should.png" alt="Implicit assertion revealing a part of the asserted value"></p><p>To avoid this, again we need to throw our own error by using <a href="https://on.cypress.io/should#Function" target="_blank" rel="noopener"><code>should(callback)</code></a> assertion form.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">'[name=password]'</span>)</span><br><span class="line">  .type(password, &#123; <span class="attr">log</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">  .should(<span class="function"><span class="params">el$</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (el$.val() !== password) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Different value of typed password'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>The custom errors are not shown in the Command Log.</p><p><img src="/blog/images/secret/should-cb.png" alt="Should with callback function with custom error does not reveal value"></p><h2><span id="avoid-ui-login">Avoid UI login</span></h2><p>It is fine to test the Login user interface - but every test after that should NOT use UI to log in. It is <a href="https://www.youtube.com/watch?v=5XQOK0v_YRE" target="_blank" rel="noopener">slow and unnecessary</a>. Instead, check how the web application performs the login by looking at the DevTools during UI login. In our case, the application is performing a POST request to <code>/login</code> with the username and password form.</p><p><img src="/blog/images/secret/login-form.png" alt="Inspecting login network call to find POST form submission"></p><p>Find the recipe that matches this method among <a href="https://github.com/cypress-io/cypress-example-recipes#logging-in-recipes" target="_blank" rel="noopener">Cypress Logging in recipes</a>. In this case it is <a href="https://github.com/cypress-io/cypress-example-recipes/tree/master/examples/logging-in__html-web-forms" target="_blank" rel="noopener">HTML Web Form</a> recipe. Copying the recipe to get the following test that uses <a href="https://on.cypress.io/request" target="_blank" rel="noopener"><code>cy.request</code></a> to make the form submission post and automatically sets any returned cookies.</p><figure class="highlight js"><figcaption><span>cypress/integration/api-login-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using cy.request'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// it is ok for the username to be visible in the Command Log</span></span><br><span class="line">  expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line">  <span class="comment">// but the password value should not be shown</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">'string'</span> || !password) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Missing password value, set using CYPRESS_password=...'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cy.request(&#123;</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    url: <span class="string">'/login'</span>,</span><br><span class="line">    form: <span class="literal">true</span>,</span><br><span class="line">    body: &#123;</span><br><span class="line">      username,</span><br><span class="line">      password</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.getCookie(<span class="string">'connect.sid'</span>).should(<span class="string">'exist'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now visit the profile page</span></span><br><span class="line">  cy.visit(<span class="string">'/profile'</span>).contains(<span class="string">'Email: jack@example.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/secret/api-login.png" alt="Test that logs in using cy.request API call"></p><p>Beautiful, it is working, and we can make the login reusable by making it into a <a href="https://on.cypress.io/custom-commands" target="_blank" rel="noopener">Cypress custom command</a> or by creating a reusable function (which is simpler in my opinion). I will create and export <code>login</code> function from <code>cypress/support/index.js</code> file to be used in any test that wants to log in via API. Only tests that explicitly test the login page should not use this function - the rest can quickly login without going through the UI.</p><figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logs the user by making API call to POST /login.</span></span><br><span class="line"><span class="comment"> * Make sure "cypress.json" + CYPRESS_ environment variables</span></span><br><span class="line"><span class="comment"> * have username and password values set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// it is ok for the username to be visible in the Command Log</span></span><br><span class="line">  expect(username, <span class="string">'username was set'</span>).to.be.a(<span class="string">'string'</span>).and.not.be.empty</span><br><span class="line">  <span class="comment">// but the password value should not be shown</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">'string'</span> || !password) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Missing password value, set using CYPRESS_password=...'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cy.request(&#123;</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    url: <span class="string">'/login'</span>,</span><br><span class="line">    form: <span class="literal">true</span>,</span><br><span class="line">    body: &#123;</span><br><span class="line">      username,</span><br><span class="line">      password</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.getCookie(<span class="string">'connect.sid'</span>).should(<span class="string">'exist'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I really like small reusable function, partly because I can document them using JSDoc comments, as above. This gives me intelligent code completion in any place I import and use <code>login</code> function, for example from the spec file.</p><p><img src="/blog/images/secret/login-intellisense.jpeg" alt="Hovering over `login` shows JSDoc comments"></p><h2><span id="continuous-integration">Continuous integration</span></h2><p>To run <a href="https://on.cypress.io/ci" target="_blank" rel="noopener">Cypress test on CI</a> I will use CircleCI - it is simple to set up, especially by using <a href="https://github.com/cypress-io/circleci-orb" target="_blank" rel="noopener">Cypress CircleCI Orb</a>.</p><figure class="highlight yaml"><figcaption><span>circle.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"><span class="attr">orbs:</span></span><br><span class="line"><span class="attr">  cypress:</span> <span class="string">cypress-io/cypress@1</span></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    jobs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cypress/run:</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npm start'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:3000'</span></span><br><span class="line">          <span class="comment"># save test run videos and screenshots on CircleCI</span></span><br><span class="line">          <span class="comment"># and they are publicly viewable, so make sure there</span></span><br><span class="line">          <span class="comment"># are no passwords in clear text!</span></span><br><span class="line"><span class="attr">          store_artifacts:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>You can find the project at <a href="https://circleci.com/gh/bahmutov/keep-password-secret" target="_blank" rel="noopener">https://circleci.com/gh/bahmutov/keep-password-secret</a>. <a href="https://circleci.com/gh/bahmutov/keep-password-secret/2" target="_blank" rel="noopener">The first run fails</a> - because I have not set <code>CYPRESS_password</code> environment variable yet.</p><p><img src="/blog/images/secret/first-run.png" alt="Run fails because we have not set CYPRESS_password yet"></p><p>We can set the required <a href="https://circleci.com/docs/2.0/env-vars/" target="_blank" rel="noopener">environment variable on CircleCI</a>, but I really like the new <a href="https://circleci.com/docs/2.0/contexts/" target="_blank" rel="noopener">CircleCI security contexts</a> because they:</p><ul><li>allow explicitly listing the context that a job expects in the circle.yml file</li><li>inject or stop the job depending on the security permission of the context</li></ul><p>So I will create a new security context <code>keep-password-secret</code> and will add the variable password there</p><p><img src="/blog/images/secret/context.png" alt="Created security context with the password environment variable"></p><p><strong>Tip:</strong> longer passwords are better, because UI masking still reveals a half of the word!</p><p>Change the <code>cypress/run</code> job by requiring the new context we have created</p><figure class="highlight yml"><figcaption><span>circle.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"><span class="attr">orbs:</span></span><br><span class="line"><span class="attr">  cypress:</span> <span class="string">cypress-io/cypress@1</span></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    jobs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cypress/run:</span></span><br><span class="line"><span class="attr">          context:</span> <span class="string">keep-password-secret</span></span><br><span class="line"><span class="attr">          start:</span> <span class="string">'npm start'</span></span><br><span class="line"><span class="attr">          wait-on:</span> <span class="string">'http://localhost:3000'</span></span><br><span class="line">          <span class="comment"># save test run videos and screenshots on CircleCI</span></span><br><span class="line">          <span class="comment"># and they are publicly viewable, so make sure there</span></span><br><span class="line">          <span class="comment"># are no passwords in clear text!</span></span><br><span class="line"><span class="attr">          store_artifacts:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>And the <a href="https://circleci.com/gh/bahmutov/keep-password-secret/3" target="_blank" rel="noopener">tests pass</a>! Check out the test artifacts - you can see password in the video <code>login-spec.js.mp4</code> that shows the original, insecure spec file.</p><p><img src="/blog/images/secret/visible-password.png" alt="Password is visible in the public video stored on the CI"></p><p>But the password should not be visible in any other video - because we have modified the spec code to be less &quot;chatty&quot;.</p><h2><span id="plugins">Plugins</span></h2><p>Watch out for any <a href="https://on.cypress.io/plugins" target="_blank" rel="noopener">plugins</a> you use with Cypress Test Runner - they might be printing secrets too. For example, I will add <a href="https://github.com/bahmutov/cypress-failed-log" target="_blank" rel="noopener">cypress-failed-log</a> plugin that prints commands to the terminal.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -D cypress-failed-log</span><br></pre></td></tr></table></figure><p>The add to the support file the following<figure class="highlight js"><figcaption><span>cypress/support/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'cypress-failed-log'</span>)</span><br></pre></td></tr></table></figure></p><p>and to the plugins file<figure class="highlight js"><figcaption><span>cypport/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// `on` is used to hook into various events Cypress emits</span></span><br><span class="line">  <span class="comment">// `config` is the resolved Cypress config</span></span><br><span class="line">  on(<span class="string">'task'</span>, &#123;</span><br><span class="line">    failed: <span class="built_in">require</span>(<span class="string">'cypress-failed-log/src/failed'</span>)()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Let&#39;s try this module. Let&#39;s run it locally WITH <code>CYPRESS_password=secret</code> set. I will be using <code>npm test</code> script</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"node ./server"</span>,</span><br><span class="line">    <span class="attr">"dev"</span>: <span class="string">"start-test 3000 'cypress open'"</span>,</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"start-test 3000 'cypress run'"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When running <code>as-a kps npm test</code> everything runs ok - nothing sensitive is printed to the terminal. But make a test fail - for example like this</p><figure class="highlight js"><figcaption><span>cypress/integration/no-password-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs in using env variables'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> username = Cypress.env(<span class="string">'username'</span>)</span><br><span class="line">  <span class="keyword">const</span> password = Cypress.env(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">  ... the rest <span class="keyword">of</span> the test</span><br><span class="line">  <span class="comment">// and now an incorrect assertion</span></span><br><span class="line">  cy.contains(<span class="string">'Email: jack@example.com2'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Let&#39;s test this - to make sure no sensitive information is printed on failure.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ as<span class="_">-a</span> kps npx start-test 3000 \</span><br><span class="line">  <span class="string">'cypress run --spec cypress/integration/no-password-spec.js'</span></span><br></pre></td></tr></table></figure><p>The spec runs, fails - and the <code>cypress-failed-log</code> plugin prints the each command - but does not reveal anything sensitive.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  1) logs in using env variables</span><br><span class="line">assert username was set: expected jack to be a string</span><br><span class="line">assert username was set: expected jack not to be empty</span><br><span class="line">visit /login</span><br><span class="line">get [name=username]</span><br><span class="line">type jack</span><br><span class="line">assert expected &lt;input&gt; to have value jack</span><br><span class="line">get [name=password]</span><br><span class="line">get [type=Submit]</span><br><span class="line">click</span><br><span class="line">form sub --submitting form--</span><br><span class="line">page load --waiting for new page to load--</span><br><span class="line">new url http://localhost:3000/</span><br><span class="line">contains a, profile</span><br><span class="line">assert expected &lt;a&gt; to be visible</span><br><span class="line">click</span><br><span class="line">page load --waiting for new page to load--</span><br><span class="line">new url http://localhost:3000/profile</span><br><span class="line">url</span><br><span class="line">assert expected http://localhost:3000/profile to match /profile$/</span><br><span class="line">contains Email: jack@example.com2</span><br><span class="line"></span><br><span class="line">  0 passing (8s)</span><br><span class="line">  1 failing</span><br><span class="line"></span><br><span class="line">  1)  logs in using env variables:</span><br><span class="line">     CypressError: Timed out retrying: Expected to find content: &apos;Email: jack@example.com2&apos; but never did.</span><br></pre></td></tr></table></figure><p>Perfect. This plugin also saves a JSON file with the error - and the file does not reveal the password either.</p><figure class="highlight json"><figcaption><span>cypress/logs/failed-logs-in-using-env-variables.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"specName"</span>: <span class="string">"no-password-spec.js"</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"logs in using env variables"</span>,</span><br><span class="line">  <span class="attr">"suiteName"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"testName"</span>: <span class="string">" logs in using env variables"</span>,</span><br><span class="line">  <span class="attr">"testError"</span>: <span class="string">"Timed out retrying: Expected to find content: 'Email: jack@example.com2' but never did."</span>,</span><br><span class="line">  <span class="attr">"testCommands"</span>: [</span><br><span class="line">    <span class="string">"assert username was set: expected **jack** to be a string"</span>,</span><br><span class="line">    <span class="string">"assert username was set: expected **jack** not to be empty"</span>,</span><br><span class="line">    <span class="string">"visit /login"</span>,</span><br><span class="line">    <span class="string">"get [name=username]"</span>,</span><br><span class="line">    <span class="string">"type jack"</span>,</span><br><span class="line">    <span class="string">"assert expected **&lt;input&gt;** to have value **jack**"</span>,</span><br><span class="line">    <span class="string">"get [name=password]"</span>,</span><br><span class="line">    <span class="string">"get [type=Submit]"</span>,</span><br><span class="line">    <span class="string">"click "</span>,</span><br><span class="line">    <span class="string">"form sub --submitting form--"</span>,</span><br><span class="line">    <span class="string">"page load --waiting for new page to load--"</span>,</span><br><span class="line">    <span class="string">"new url http://localhost:3000/"</span>,</span><br><span class="line">    <span class="string">"contains a, profile"</span>,</span><br><span class="line">    <span class="string">"assert expected **&lt;a&gt;** to be **visible**"</span>,</span><br><span class="line">    <span class="string">"click "</span>,</span><br><span class="line">    <span class="string">"page load --waiting for new page to load--"</span>,</span><br><span class="line">    <span class="string">"new url http://localhost:3000/profile"</span>,</span><br><span class="line">    <span class="string">"url "</span>,</span><br><span class="line">    <span class="string">"assert expected **http://localhost:3000/profile** to match /profile$/"</span>,</span><br><span class="line">    <span class="string">"contains Email: jack@example.com2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"screenshot"</span>: <span class="string">"logs-in-using-env-variables-failed.png"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Great - this plugin seems safe to use.</p><h2><span id="conclusions">Conclusions</span></h2><p>Keeping sensitive information out of public logs, screenshots and videos is a very important and ongoing concern. Make sure that every commit even if it  <em>only changes the tests</em> goes through code review. If a password has been accidentally revealed, even during the pull request, revoke it and use a new one. For example, here is a quick way to get a random password using Node from the terminal</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node -p <span class="string">"crypto.randomBytes(16).toString('hex')"</span></span><br><span class="line">d01ce7056fb2eab425161dcfa5bdb502</span><br></pre></td></tr></table></figure><p>Read more about Cypress and ways to use it in the linked resourced</p><ul><li><a href="../cypress-tips-and-tricks/">Cypress tips and tricks</a></li><li><a href="https://www.cypress.io/blog" target="_blank" rel="noopener">Cypress technical blog</a></li><li>My <a href="../cypress-talks/">recent Cypress talks</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#visible-password&quot;&gt;Visible password&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#do-not-hardcode-passwords&quot;&gt;Do not hardcode passwor
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="security" scheme="https://glebbahmutov.com/blog/tags/security/"/>
    
  </entry>
  
  <entry>
    <title>How to set up Mocha with Sinon.js</title>
    <link href="https://glebbahmutov.com/blog/mocha-and-sinon/"/>
    <id>https://glebbahmutov.com/blog/mocha-and-sinon/</id>
    <published>2019-11-29T05:00:00.000Z</published>
    <updated>2020-02-18T16:17:39.093Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#basic-setup">Basic setup</a></li><li><a href="#sandbox">Sandbox</a></li><li><a href="#global-sandbox">Global sandbox</a></li><li><a href="#ci-setup">CI setup</a></li><li><a href="#assertions">Assertions</a></li><li><a href="#matches">Matches</a></li><li><a href="#see-also">See also</a></li></ul><!-- tocstop --><p>Let&#39;s say we have a small Node program and want to confirm it logs &quot;Hello&quot; string to the console</p><figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Hello'</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123; app &#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">module</span>.parent) &#123;</span><br><span class="line">  app()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ npm start</span><br><span class="line">&gt; node ./app</span><br><span class="line"></span><br><span class="line">Hello</span><br></pre></td></tr></table></figure><p>We need a test runner to write a test and an ability to spy <code>console.log</code> method. We could write both the test runner and method spying ourselves, but there are already 2 great tools for this: <a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha.js</a> and <a href="https://sinonjs.org/" target="_blank" rel="noopener">Sinon.js</a>. Let&#39;s use them.</p><p><strong>Note:</strong> you can find the source code for this blog post in <a href="https://github.com/bahmutov/mocha-sinon-example" target="_blank" rel="noopener">mocha-sinon-example</a> repository.</p><h2><span id="basic-setup">Basic setup</span></h2><p>First, install both NPM dependencies</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add -D mocha sinon</span><br><span class="line">info Direct dependencies</span><br><span class="line">├─ mocha@6.2.2</span><br><span class="line">└─ sinon@7.5.0</span><br></pre></td></tr></table></figure><p>Next, write a spec file <code>test/app-spec.js</code> that will import <code>app</code>, set up spying and then confirm the spy was called with expected argument</p><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">'../app'</span>)</span><br><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sinon.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>To run unit tests, I like using NPM script command <code>npm test</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"mocha 'test/*-spec.js'"</span>,</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"node ./app"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The test passes</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ npm t</span><br><span class="line"></span><br><span class="line">&gt; mocha-sinon-example@1.0.0 test /Users/gleb/git/mocha-sinon-example</span><br><span class="line">&gt; mocha &apos;test/*-spec.js&apos;</span><br><span class="line"></span><br><span class="line">Hello</span><br><span class="line">  ✓ logs Hello</span><br><span class="line"></span><br><span class="line">  1 passing (5ms)</span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> whenever there is new code pulled for the project, I like using shortcut <code>npm it</code> to run <code>npm install</code> + <code>npm test</code> together. Even better, I could use shortcut <code>npm cit</code> that runs <code>npm ci</code> + <code>npm test</code> together.</p><h2><span id="sandbox">Sandbox</span></h2><p>We have set up a <a href="https://sinonjs.org/releases/v7.5.0/spies/" target="_blank" rel="noopener">Sinon spy</a> on the global <code>console.log</code> - but we have not cleared it. This could lead to unexpected behavior in the unit tests that follow. For example if the next test runs by itself it works</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sinon.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line">it.only(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sinon.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>But when the two tests run together the second attempt to spy causes an error.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) logs again:</span><br><span class="line">     TypeError: Attempted to wrap log which is already wrapped</span><br></pre></td></tr></table></figure><p>We really don&#39;t want the two tests to be dependent on each other. Thus I strongly recommend using <a href="https://sinonjs.org/releases/v7.5.0/sandbox/" target="_blank" rel="noopener">Sinon sandboxes</a>. We could create the sandbox once and reset the sandbox before each test in a single call.</p><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">'../app'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sandbox</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  sandbox = sinon.createSandbox()</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  sandbox.restore()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  <span class="comment">// no problems</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="global-sandbox">Global sandbox</span></h2><p>Rather than each spec file creating a sandbox (and restoring it), we could move the <code>before</code> and <code>beforeEach</code> hooks into its own test helper file, creating <a href="https://mochajs.org/#root-level-hooks" target="_blank" rel="noopener">root-level hooks</a>.</p><figure class="highlight js"><figcaption><span>test/helper.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  global.sandbox = sinon.createSandbox()</span><br><span class="line">&#125;)</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  global.sandbox.restore()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">'../app'</span>)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  <span class="comment">// no problems</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>I change the NPM test script to load the helper file</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"mocha test/helper 'test/*-spec.js'"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="ci-setup">CI setup</span></h2><p>Let&#39;s run these tests on CI - I will use GitHub Actions because <a href="../trying-github-actions/">they are awesome</a>. I have added <code>.github/workflows/test.yml</code> file.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">main</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">npm</span> <span class="string">t</span></span><br></pre></td></tr></table></figure><p>The code is checked out, <a href="https://github.com/bahmutov/npm-install" target="_blank" rel="noopener">bahmutov/npm-install</a> action runs <code>yarn</code> with caching of NPM dependencies, and then <code>npm t</code> runs unit tests.</p><p><img src="/blog/images/mocha-sinon/action.png" alt="GitHub Action output"></p><h2><span id="assertions">Assertions</span></h2><p>In the above example, we used a plain Error in case the spy was not called as expected.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs Hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="keyword">if</span> (!log.calledOnceWith(<span class="string">'Hello'</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Log was not called'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Sinon.js comes with <code>assert</code> methods that can help produce better error messages with more context. For example, if we expect the spy to have been called with &quot;Bye&quot; for some reason, the error message prints the actual calls</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'sinon'</span>).assert.calledWith(log, <span class="string">'Bye'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/mocha-sinon/sinon-assert.png" alt="Sinon.assert error message"></p><p>Even better is to bring in <a href="https://www.chaijs.com/" target="_blank" rel="noopener">Chai</a> assertions with <a href="https://github.com/domenic/sinon-chai" target="_blank" rel="noopener">Sinon.js Chai</a> plugin.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add -D chai sinon-chai</span><br><span class="line">info Direct dependencies</span><br><span class="line">├─ chai@4.2.0</span><br><span class="line">└─ sinon-chai@3.3.0</span><br></pre></td></tr></table></figure><p>Then add to the <code>test/helper.js</code> file the following</p><figure class="highlight js"><figcaption><span>test/helper.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chai = <span class="built_in">require</span>(<span class="string">'chai'</span>)</span><br><span class="line"><span class="keyword">const</span> sinonChai = <span class="built_in">require</span>(<span class="string">'sinon-chai'</span>)</span><br><span class="line">chai.use(sinonChai)</span><br><span class="line">global.expect = chai.expect</span><br><span class="line"><span class="comment">// global Sinon sandbox code ...</span></span><br></pre></td></tr></table></figure><p>Now we can use easy to read assertions inside the specs</p><figure class="highlight js"><figcaption><span>test/app-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'logs again'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> log = sandbox.spy(<span class="built_in">console</span>, <span class="string">'log'</span>)</span><br><span class="line">  app()</span><br><span class="line">  expect(log).to.have.been.calledOnceWith(<span class="string">'Hello'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="matches">Matches</span></h2><p>If you don&#39;t know the exact argument a stub or a spy should be called, you can use <code>sinon.match</code> utils. For example, if the code calls the method with <code>o.method(&#39;hello&#39;, name)</code> then you can assert it with</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>)</span><br><span class="line"><span class="keyword">const</span> greeting = sinon.spy(o, <span class="string">'method'</span>)</span><br><span class="line">expect(greeting).to.have.been.calledOnceWithExactly(<span class="string">'hello'</span>, sinon.match.string)</span><br></pre></td></tr></table></figure><h2><span id="see-also">See also</span></h2><ul><li><a href="../spying-on-methods">Spying on methods</a></li><li><a href="../picking-javascript-testing-framework">Picking JavaScript testing framework</a></li><li><a href="../lock-down-sinon-stub">Lock down Sinon stub</a></li><li><a href="../unit-testing-cli-programs">Unit testing CLI programs</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#basic-setup&quot;&gt;Basic setup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sandbox&quot;&gt;Sandbox&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#global-sandbox&quot;&gt;Glob
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="javascript" scheme="https://glebbahmutov.com/blog/tags/javascript/"/>
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
  </entry>
  
  <entry>
    <title>Cypress Talks</title>
    <link href="https://glebbahmutov.com/blog/cypress-talks/"/>
    <id>https://glebbahmutov.com/blog/cypress-talks/</id>
    <published>2019-11-19T05:00:00.000Z</published>
    <updated>2019-11-19T03:36:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>Lately I had the privilege to speak at several conferences about Cypress.io and our testing philosophy. This blog post collects the videos and slides for easy access, and I plan to be adding new videos as I talk about Cypress at other events.</p><h2><span id="reactiveconf-2019">ReactiveConf 2019</span></h2><p><strong>Cypress.io - the State of the Art End-to-end Testing Tool</strong> Oct 2019</p><p>Presented at ReactiveConf 2019 in Prague, Czech Republic, <a href="https://www.youtube.com/watch?v=JL3QKQO80fs" target="_blank" rel="noopener">video</a>, <a href="https://slides.com/bahmutov/state-of-the-art/" target="_blank" rel="noopener">slides</a></p><center>  <iframe data-cy="talk" width="560" height="315" src="https://www.youtube.com/embed/JL3QKQO80fs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><h3><span id="main-sections">Main sections</span></h3><ul><li>Lint pyramid <a href="https://youtu.be/JL3QKQO80fs?t=226" target="_blank" rel="noopener">video at 3m46s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/lint-pyramid" target="_blank" rel="noopener">slides</a> (Prettier, ESLint, <code>@ts-check</code>)</li><li>Tests and plugins <a href="https://youtu.be/JL3QKQO80fs?t=429" target="_blank" rel="noopener">video at 7m9s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/only-tests" target="_blank" rel="noopener">slides</a> (unit, component, web application, visual testing, a11y testing, API testing)</li><li>Code coverage <a href="https://youtu.be/JL3QKQO80fs?t=699" target="_blank" rel="noopener">video at 11m39s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/code-coverage" target="_blank" rel="noopener">slides</a></li><li>Splitting end-to-end test via App Actions and checkpoints <a href="https://youtu.be/JL3QKQO80fs?t=1205" target="_blank" rel="noopener">video at 20m5s</a>, <a href="https://slides.com/bahmutov/state-of-the-art/#/test-length" target="_blank" rel="noopener">slides</a>, read <a href="https://www.cypress.io/blog/2019/10/29/split-a-very-long-cypress-test-into-shorter-ones-using-app-actions/" target="_blank" rel="noopener">Split a very long Cypress test into shorter ones using App Actions</a> blog post</li></ul><h2><span id="allthingsopen">AllThingsOpen</span></h2><p><strong>Achievement Unlocked</strong> Oct 2019, <a href="https://youtu.be/2gP1-TNDzK4" target="_blank" rel="noopener">video</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked" target="_blank" rel="noopener">slides</a></p><center>  <iframe width="560" height="315" src="https://www.youtube.com/embed/2gP1-TNDzK4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><h3><span id="main-sections">Main sections</span></h3><ul><li>Tests and plugins <a href="https://youtu.be/2gP1-TNDzK4?t=367" target="_blank" rel="noopener">video at 6m5s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/only-tests" target="_blank" rel="noopener">slides</a>, check out <a href="https://on.cypress.io/plugins" target="_blank" rel="noopener">Cypress plugins</a></li><li>Cypress code coverage plugin <a href="https://youtu.be/2gP1-TNDzK4?t=764" target="_blank" rel="noopener">video at 12m44s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/code-coverage" target="_blank" rel="noopener">slides</a><ul><li>end-to-end, unit and full-stack code coverage, read <a href="https://on.cypress.io/code-coverage" target="_blank" rel="noopener">Cypress code coverage guide</a></li></ul></li><li>Cypress as a business <a href="https://youtu.be/2gP1-TNDzK4?t=1238" target="_blank" rel="noopener">video at 20m38s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/business" target="_blank" rel="noopener">slides</a><ul><li>How we make money as a company while giving the Test Runner away for free</li></ul></li><li>Current and future work <a href="https://youtu.be/2gP1-TNDzK4?t=1881" target="_blank" rel="noopener">videp at 31m21s</a>, <a href="https://cypress.slides.com/cypress-io/achievement-unlocked/#/roadmap" target="_blank" rel="noopener">slides</a><ul><li>Test analytics</li><li>Run tagging</li><li>Firefox support</li><li>Better errors</li><li>Test retries</li></ul></li></ul><h2><span id="revojs">Revo.js</span></h2><p>A great community conference in Timisoara, Romania. I recommend it 100%.</p><p><strong>Wait, before you write your next test...</strong> Oct 2019, <a href="https://youtu.be/T_jr0buAZ_Y" target="_blank" rel="noopener">video</a>, <a href="https://cypress.slides.com/cypress-io/next-test" target="_blank" rel="noopener">slides</a></p><center>  <iframe width="560" height="315" src="https://www.youtube.com/embed/T_jr0buAZ_Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>Slides at <a href="https://cypress.slides.com/cypress-io/next-test" target="_blank" rel="noopener">https://cypress.slides.com/cypress-io/next-test</a>, and the talk covers</p><ul><li>How I avoid writing tests by using linters</li><li>How code coverage is a great tool for directing test writing</li><li>How I make tests faster by using <a href="https://www.cypress.io/blog/2019/01/03/stop-using-page-objects-and-start-using-app-actions/" target="_blank" rel="noopener">app actions</a>, read blog post <a href="https://www.cypress.io/blog/2019/10/29/split-a-very-long-cypress-test-into-shorter-ones-using-app-actions/" target="_blank" rel="noopener">Split a very long Cypress test into shorter ones using App Actions</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Lately I had the privilege to speak at several conferences about Cypress.io and our testing philosophy. This blog post collects the video
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Trying GitHub Actions</title>
    <link href="https://glebbahmutov.com/blog/trying-github-actions/"/>
    <id>https://glebbahmutov.com/blog/trying-github-actions/</id>
    <published>2019-11-15T05:00:00.000Z</published>
    <updated>2020-05-04T12:42:56.774Z</updated>
    
    <content type="html"><![CDATA[<p>Recently <a href="https://help.github.com/en/actions" target="_blank" rel="noopener">GitHub Actions</a> went into general availability with very generous <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#usage-limits" target="_blank" rel="noopener">usage limits for public repositories</a>, and I have started playing with them. Here are a couple of experiments.</p><p><strong>Note:</strong> I have covered the topics below in my recent talk <a href="https://www.youtube.com/watch?v=zhPqf5z_crc" target="_blank" rel="noopener">GitHub Actions in Actions</a>, <a href="https://slides.com/bahmutov/gh-actions/" target="_blank" rel="noopener">slides</a>.</p><h2><span id="fixing-code-formatting">Fixing code formatting</span></h2><p>It is easy to forget to <a href="../configure-prettier-in-vscode/">format code</a> before pushing it to GitHub. I usually use <a href="https://github.com/typicode/husky" target="_blank" rel="noopener">husky</a> pre-commit hooks with <a href="https://github.com/okonet/lint-staged" target="_blank" rel="noopener">lint-staged</a> but that requires configuration. It would be so much simpler if continuous integration server could run the formatting task and if there were any changed files, would commit and push them to the source repository, fixing any problems. Turns out, this is pretty (pun intended) simple as the example repo <a href="https://github.com/bahmutov/gh-action-with-prettier" target="_blank" rel="noopener">bahmutov/gh-action-with-prettier</a> shows. Here is the <a href="https://github.com/bahmutov/gh-action-with-prettier/blob/master/.github/workflows/ci.yml" target="_blank" rel="noopener">.github/workflows/ci.yml</a> file.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Prettier</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Prettier</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Cache</span> <span class="string">node</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/cache@v1</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">~/.npm</span></span><br><span class="line"><span class="attr">          key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-node-$&#123;&#123;</span> <span class="string">hashFiles('**/package-lock.json')</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          restore-keys:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            $<span class="template-variable">&#123;&#123; runner.os &#125;&#125;</span>-node-</span></span><br><span class="line"><span class="string"></span><span class="attr">      - run:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">format</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">git</span> <span class="string">status</span></span><br><span class="line">      <span class="comment"># commit any changed files</span></span><br><span class="line">      <span class="comment"># https://github.com/mikeal/publish-to-github-action</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">mikeal/publish-to-github-action@master</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>The above steps check out the remote source code, install NPM modules (with caching using <a href="https://github.com/actions/cache" target="_blank" rel="noopener">actions/cache</a> helper), then run Prettier via <code>npm run format</code> and finally use action <a href="https://github.com/mikeal/publish-to-github-action" target="_blank" rel="noopener">mikeal/publish-to-github-action</a> I have found at <a href="https://github.com/marketplace?type=actions" target="_blank" rel="noopener">GitHub Marketplace</a>. This action is super simple - it is a code I usually have written myself to commit local changes and push to remote, see <a href="https://github.com/mikeal/publish-to-github-action/blob/master/entrypoint.sh" target="_blank" rel="noopener">its entrypoint.sh</a>.</p><p>The integration of code repository (in this case GitHub) with CI (GitHub Actions) is very convenient from the security point of view. In this case, a secret <code>GITHUB_TOKEN</code> is automatically injected by the CI - allowing us to easily interact with the remote repository, no extra steps necessary.</p><p><img src="/blog/images/github-actions/code-formatted.png" alt="Code was formatted and pushed to master"></p><h2><span id="action-versioning">Action versioning</span></h2><p>Actions are fetched directly from GitHub repositories, not from NPM. Thus you can specify what action to use using a <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#jobsjob_idstepsuses" target="_blank" rel="noopener">branch name, tag or commit</a>.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line"><span class="attr">  - uses:</span> <span class="string">actions/setup-node@74bc508</span> <span class="comment"># Reference a specific commit</span></span><br><span class="line"><span class="attr">  - uses:</span> <span class="string">actions/setup-node@v1</span>      <span class="comment"># Reference the major version of a release</span></span><br><span class="line"><span class="attr">  - uses:</span> <span class="string">actions/setup-node@v1.2</span>    <span class="comment"># Reference a minor version of a release</span></span><br><span class="line"><span class="attr">  - uses:</span> <span class="string">actions/setup-node@master</span>  <span class="comment"># Reference a branch</span></span><br></pre></td></tr></table></figure><p>I recommend using either latest published branch like:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line"><span class="attr">- uses:</span> <span class="string">actions/setup-node@v1.2.1</span></span><br></pre></td></tr></table></figure><h3><span id="security">Security</span></h3><p>Using branch tags is dangerous though, read <a href="https://julienrenaux.fr/2019/12/20/github-actions-security-risk/" target="_blank" rel="noopener">this post</a> since you can execute unknown code when the tag changes. Thus if you want to sleep slightly better at night, please use the full commit sha of the actions you have reviewed.</p><h2><span id="npm-or-yarn-install">NPM or Yarn install</span></h2><p>GitHub has published <a href="https://github.com/actions/toolkit" target="_blank" rel="noopener">Actions Toolkit</a> for writing <a href="https://github.com/features/actions" target="_blank" rel="noopener">actions</a> using JavaScript or TypeScript. This is excellent - always bet on JavaScript! The only problem - some actions for a typical Node project require quite a bit of copy / paste code. For example, every Node project needs to cache <code>~/.npm</code> folder, thus it needs the following boilerplate action.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Cache</span> <span class="string">node</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">actions/cache@v1</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">~/.npm</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-node-$&#123;&#123;</span> <span class="string">hashFiles('**/package-lock.json')</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    restore-keys:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      $<span class="template-variable">&#123;&#123; runner.os &#125;&#125;</span>-node-</span></span><br><span class="line"><span class="string"></span><span class="attr">- run:</span> <span class="string">npm</span> <span class="string">ci</span></span><br></pre></td></tr></table></figure><p>Ughh, wouldn&#39;t it be nice to have nice reusable &quot;Install NPM modules and cache them, please&quot; action? Unfortunately, <a href="https://github.com/actions/cache" target="_blank" rel="noopener">action/cache</a> itself is an action - and cannot be used from JavaScript ☹️. There is a little bit of discussion <a href="https://github.com/actions/cache/issues/55" target="_blank" rel="noopener">here</a> on the issue I have opened, but worry not - Open Source to the rescue. I have cloned <code>actions/cache</code> into <a href="https://github.com/cypress-io/github-actions-cache" target="_blank" rel="noopener">cypress-io/github-actions-cache</a> and have refactored the code in branch <code>reusable-functions</code> to allow using <code>restoreCache</code> and <code>saveCache</code> functions from other JavaScript code. Easy-peasy.</p><p>Let&#39;s write <code>npm-install</code> action - here is the main logic of the action</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">restoreCachedNpm()</span><br><span class="line">.then(<span class="function"><span class="params">npmCacheHit</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'npm cache hit'</span>, npmCacheHit)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> install().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (npmCacheHit) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> saveCachedNpm()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error)</span><br><span class="line">  core.setFailed(error.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>If the previously cached <code>~/.npm</code> or <code>~/.cache/yarn</code> depending on the presence of <code>yarn.lock</code> folder was successfully restored, then we perform immutable install using <code>npm ci</code> or <code>yarn --frozen-lockfile</code> command and are done. If the cache hit was missed, then we need to save the NPM modues folder in action&#39;s cache.</p><p>Restoring and saving NPM cache folder functions use the forked <code>cache</code> module and rely on platform and lock file hash to know when a new cache is necessary.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasha = <span class="built_in">require</span>(<span class="string">'hasha'</span>)</span><br><span class="line"><span class="comment">// we are using dependency</span></span><br><span class="line"><span class="comment">// "cache": "github:cypress-io/github-actions-cache#8bec6cc"</span></span><br><span class="line"><span class="keyword">const</span> &#123; restoreCache, saveCache &#125; = <span class="built_in">require</span>(<span class="string">'cache/lib/index'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useYarn = fs.existsSync(<span class="string">'yarn.lock'</span>)</span><br><span class="line"><span class="keyword">const</span> lockFilename = useYarn ? <span class="string">'yarn.lock'</span> : <span class="string">'package-lock.json'</span></span><br><span class="line"><span class="keyword">const</span> lockHash = hasha.fromFileSync(lockFilename)</span><br><span class="line"><span class="keyword">const</span> platformAndArch = <span class="string">`<span class="subst">$&#123;process.platform&#125;</span>-<span class="subst">$&#123;process.arch&#125;</span>`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// this is simplified code for clarity</span></span><br><span class="line"><span class="comment">// see action file index.js for full details</span></span><br><span class="line"><span class="keyword">const</span> NPM_CACHE = &#123;</span><br><span class="line">  inputPath: <span class="string">'~/.npm'</span>, <span class="comment">// or '~/.cache/yarn'</span></span><br><span class="line">  primaryKey: <span class="string">`npm-<span class="subst">$&#123;platformAndArch&#125;</span>-<span class="subst">$&#123;lockHash&#125;</span>`</span>,</span><br><span class="line">  restoreKeys: <span class="string">`npm-<span class="subst">$&#123;platformAndArch&#125;</span>-`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> restoreCachedNpm = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'trying to restore cached NPM modules'</span>)</span><br><span class="line">  <span class="keyword">return</span> restoreCache(</span><br><span class="line">    NPM_CACHE.inputPath,</span><br><span class="line">    NPM_CACHE.primaryKey,</span><br><span class="line">    NPM_CACHE.restoreKeys</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> saveCachedNpm = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'saving NPM modules'</span>)</span><br><span class="line">  <span class="keyword">return</span> saveCache(NPM_CACHE.inputPath, NPM_CACHE.primaryKey)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="building-action">Building action</span></h3><p>Because the action needs to be ready to go, you need to bundle the action using <a href>zeti/ncc</a> for example. Thus the action&#39;s <code>package.json</code> file includes the <code>build</code> script.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"ncc build -o dist index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@zeit/ncc"</span>: <span class="string">"0.20.5"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The generated <code>dist</code> folder is checked in - because GitHub actions are fetched straight from GitHub source, no from NPM registry. For publishing I use another GitHub action <a href="https://github.com/cycjimmy/semantic-release-action" target="_blank" rel="noopener">cycjimmy/semantic-release-action</a> that tags and pushes new releases on GitHub and also update <code>v&lt;major version&gt;</code> branch, like <code>v1</code> to always point at the latest release.</p><p>Finally, I have described action&#39;s main properties in <a href="https://github.com/bahmutov/npm-install/blob/master/action.yml" target="_blank" rel="noopener">action.yml</a> and published it on <a href="https://github.com/marketplace/actions/npm-or-yarn-install-with-caching" target="_blank" rel="noopener">GitHub Marketplace</a>.</p><p><img src="/blog/images/github-actions/npm-install.png" alt="The lonely NPM install action"></p><p>You can see this action in ... action at <a href="https://github.com/bahmutov/npm-install-action-example/actions" target="_blank" rel="noopener">bahmutov/npm-install-action-example/actions</a>. The CI file is simple</p><figure class="highlight yml"><figcaption><span>.github/workflows/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">main</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build-and-test:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">npm</span> <span class="string">t</span></span><br></pre></td></tr></table></figure><p>Name <code>bahmutov/npm-install@v1</code> refers to branch <code>v1</code> of the GitHub repository <a href="https://github.com/bahmutov/npm-install/tree/v1" target="_blank" rel="noopener">bahmutov/npm-install</a> where the latest semantic release is pushed. On the first build, the cache is empty, and <code>npm ci</code> has to fetch NPM modules from the registry. Then the folder <code>~/.npm</code> is cached.</p><p><img src="/blog/images/github-actions/first-install.png" alt="First install"></p><p>On the second build, the cache is hit, and <code>npm ci</code> is faster - because it uses only modules from the restored <code>~/.npm</code> folder, and then skips saving unchanged cache folder.</p><p><img src="/blog/images/github-actions/second-install.png" alt="Second install"></p><p>Nice, feel free to use this action from your projects, and <a href="https://github.com/bahmutov/npm-install/issues" target="_blank" rel="noopener">open new issue</a> if you find a problem. You can also build your own actions using the <a href="https://github.com/bahmutov/npm-install#npm" target="_blank" rel="noopener">exported NPM function</a>.</p><h2><span id="end-to-end-testing">End-to-end testing</span></h2><p>Finally, I have written <a href="https://github.com/cypress-io/github-action" target="_blank" rel="noopener">cypress-io/github-action</a> to make running Cypress tests on GitHub super simple. Here is how to run tests on a single Linux machine</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">End-to-end</span> <span class="string">tests</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  cypress-run:</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">      <span class="comment"># Install NPM dependencies, cache them correctly</span></span><br><span class="line">      <span class="comment"># and run all Cypress tests</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br></pre></td></tr></table></figure><p>Here is more complicated case: running tests in parallel in <a href="https://on.cypress.io/parallelization" target="_blank" rel="noopener">load balancing mode</a></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Parallel</span> <span class="string">Cypress</span> <span class="string">Tests</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  test:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    strategy:</span></span><br><span class="line"><span class="attr">      matrix:</span></span><br><span class="line">        <span class="comment"># run 3 copies of the current job in parallel</span></span><br><span class="line"><span class="attr">        containers:</span> <span class="string">[1,</span> <span class="number">2</span><span class="string">,</span> <span class="number">3</span><span class="string">]</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Checkout</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># because of "record" and "parallel" parameters</span></span><br><span class="line">      <span class="comment"># these containers will load balance all found tests among themselves</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line"><span class="attr">        uses:</span> <span class="string">cypress-io/github-action@v1</span></span><br><span class="line"><span class="attr">        with:</span></span><br><span class="line"><span class="attr">          record:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          parallel:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          group:</span> <span class="string">'Actions example'</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line">          <span class="comment"># pass the Dashboard record key as an environment variable</span></span><br><span class="line"><span class="attr">          CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Super simple and even works across Windows, Mac and Linux machines on CI, see <a href="https://github.com/cypress-io/github-action#examples" target="_blank" rel="noopener">Cypress GitHub Action examples</a>.</p><h2><span id="npm-publishing">NPM publishing</span></h2><p>If you are a fan of <a href="https://semver.org/" target="_blank" rel="noopener">semantic versioning</a> like I am, you are probably using <a href="https://github.com/semantic-release/semantic-release" target="_blank" rel="noopener">semantic-release</a> to publish NPM packages automatically from CI. This type of release becomes even simpler with GitHub actions thanks to <a href="https://github.com/cycjimmy/semantic-release-action" target="_blank" rel="noopener">cycjimmy/semantic-release-action</a>.</p><p>First, go to <a href="https://www.npmjs.com/settings/bahmutov/tokens" target="_blank" rel="noopener">https://www.npmjs.com/settings/<username>/tokens</username></a> and get a new &quot;Read and Write&quot; token. Save it to clipboard - it will never be displayed again!</p><p>Second, go to the project&#39;s Settings / Secrets and add a new secret with name <code>NPM_TOKEN</code> and paste the NPM auth token from the clipboard.</p><p>Add the following step to your workflow</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># after test step</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Semantic</span> <span class="string">Release</span></span><br><span class="line"><span class="attr">  uses:</span> <span class="string">cycjimmy/semantic-release-action@v2</span></span><br><span class="line"><span class="attr">  id:</span> <span class="string">semantic</span></span><br><span class="line"><span class="attr">  with:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    extra_plugins:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      @semantic-release/git</span></span><br><span class="line"><span class="string">      @semantic-release/changelog</span></span><br><span class="line"><span class="string"></span><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    NPM_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.NPM_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>The <code>GITHUB_TOKEN</code> secret is automatically created and injected by the GH Action App in your repository, you don&#39;t need to create it. Each time there is a Git commit on the <code>master</code> branch since the last release, the above action will publish new NPM version and will create a GitHub release. See example in action in repo <a href="https://github.com/bahmutov/cy-spok/actions" target="_blank" rel="noopener">bahmutov/cy-spok</a>, where you can see <code>github-actions</code> user publishing releases.</p><p><img src="/blog/images/github-actions/github-action-release.png" alt="Semantic release from GH Action"></p><h2><span id="badges">Badges</span></h2><p>You can add <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/configuring-a-workflow#adding-a-workflow-status-badge-to-your-repository" target="_blank" rel="noopener">GH Action badge</a> to your README file. I prefer using the syntax that includes workflow name and explicit branch:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/&lt;OWNER&gt;/&lt;REPOSITORY&gt;/workflows/&lt;WORKFLOW_NAME&gt;/badge.svg?branch=&lt;BRANCH&gt;</span><br><span class="line"># example</span><br><span class="line">![cy-spok status](https://github.com/bahmutov/cy-spok/workflows/main/badge.svg?branch=master)</span><br></pre></td></tr></table></figure><p><img src="https://github.com/bahmutov/cy-spok/workflows/main/badge.svg?branch=master" alt="cy-spok status"></p><p>If you want to use badge as a link and go to the Actions tab of the repo, I like separating the urls into their own lines.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[![ci status][ci image]][ci url]</span><br><span class="line">[ci image]: https://github.com/bahmutov/cy-spok/workflows/main/badge.svg?branch=master</span><br><span class="line">[ci url]: https://github.com/bahmutov/cy-spok/actions</span><br></pre></td></tr></table></figure><p>One thing I like doing is creating separate workflows for the same project and putting multiple badges in the same README. If there are example projects, we could put their badges there too. This creates a single CI status &quot;dashboard&quot; in the Markdown file, something <a href="../status-dashboard-from-markdown/">I have recommended a long time ago</a></p><p><img src="/blog/images/github-actions/badges-markdown.png" alt="Status badges Markdown table"></p><p><img src="/blog/images/github-actions/badges.png" alt="Status badges"></p><h2><span id="set-commit-status">Set commit status</span></h2><p>You can set commit status using GitHub REST API, if you know GH repository and commit SHA and have a token with permissions. A REST call using curl would look like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl --request POST \</span><br><span class="line">  --url https://api.github.com/repos/$&#123;&#123; github.repository &#125;&#125;/statuses/$&#123;&#123; github.sha &#125;&#125; \</span><br><span class="line">  --header &apos;authorization: Bearer $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;&apos; \</span><br><span class="line">  --header &apos;content-type: application/json&apos; \</span><br><span class="line">  --data &apos;&#123;</span><br><span class="line">    &quot;state&quot;: &quot;success&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;REST commit status&quot;,</span><br><span class="line">    &quot;context&quot;: &quot;a test&quot;</span><br><span class="line">  &#125;&apos;</span><br></pre></td></tr></table></figure><p>When running on GitHub Actions, the repository and sha are already set via <a href="https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables#default-environment-variables" target="_blank" rel="noopener">default environment variables</a>, and the user can pass the <code>GITHUB_TOKEN</code> created by the GH App itself.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># reads GITHUB_REPOSITORY and GITHUB_SHA from environment</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Set</span> <span class="string">code</span> <span class="string">coverage</span> <span class="string">commit</span> <span class="string">status</span> <span class="string">📫</span></span><br><span class="line"><span class="attr">  run:</span> <span class="string">npx</span> <span class="string">set-gh-status</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>See implementation in <a href="https://github.com/bahmutov/check-code-coverage" target="_blank" rel="noopener">bahmutov/check-code-coverage</a>.</p><p><img src="/blog/images/github-actions/commit-status.png" alt="Commit status check"></p><h2><span id="more-examples">More examples</span></h2><ul><li><a href="https://github.com/bahmutov/auto-pr-gh-action-example" target="_blank" rel="noopener">Open or merge pull requests automatically</a></li><li>A great tutorial about using and building actions in 30 (!) parts from <a href="https://edwardthomson.com/" target="_blank" rel="noopener">Edward Thomson</a> is <a href="https://edwardthomson.com/blog/github_actions_advent_calendar.html" target="_blank" rel="noopener">here</a></li><li>while working on a GitHub action, you can unit test it, but also apply the action to examples in subfolders that act like end-to-end examples. See <a href="https://github.com/bahmutov/npm-install#testing" target="_blank" rel="noopener">bahmutov/npm-install Testing section</a></li><li>test a static site deployed to GitHub Pages before (twice) and after deploy in blog post <a href="../triple-tested/">Triple Tested</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently &lt;a href=&quot;https://help.github.com/en/actions&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub Actions&lt;/a&gt; went into general availability wi
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>Run End-to-end Tests from Markdown Files</title>
    <link href="https://glebbahmutov.com/blog/cypress-fiddle/"/>
    <id>https://glebbahmutov.com/blog/cypress-fiddle/</id>
    <published>2019-10-22T04:00:00.000Z</published>
    <updated>2020-04-22T19:21:41.353Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://on.cypress.io" target="_blank" rel="noopener">Cypress documentation</a> has a lot of examples. Pretty much every command, like <a href="https://on.cypress.io/get#Examples" target="_blank" rel="noopener"><code>cy.get</code></a> or <a href="https://on.cypress.io/last#Examples" target="_blank" rel="noopener"><code>cy.last</code></a> has several realistic examples.</p><p><img src="/blog/images/fiddle/last-example.png" alt="`cy.last` example"></p><p>There is a huge problem with documentation examples - they might be wrong. Since they are copied from tests, or written by hand without running them, there is no guarantee that they are correct with respect to the latest Cypress version.</p><p>We could write a real end-to-end test for each example and keep it in sync, but this requires a lot of work to stay up-to-date. What if we instead executed the examples <em>directly from the documentation pages</em>? After all, each example has the HTML to mount and test code to run, so it contains all the parts of a real test as code blocks.</p><p>This is what <a href="https://github.com/cypress-io/cypress-fiddle" target="_blank" rel="noopener">@cypress/fiddle</a> does. It contains a test file preprocessor that understand the Markdown file format, finds all specially marked example blocks and creates a Cypress test out of them. For example, see <a href="https://github.com/bahmutov/vuepress-cypress-test-example" target="_blank" rel="noopener">bahmutov/vuepress-cypress-test-example</a>. In that repo, the README.md file contains the following block</p><p><img src="/blog/images/fiddle/fiddle.png" alt="Markdown section with a fiddle"></p><p>Notice the special HTML comments <code>&lt;!-- fiddle DOM test --&gt;</code> and <code>&lt;!-- fiddle-end --&gt;</code>. They are ignored by Markdown render engines. Thus we can safely use them to mark the beginning and the end of each test. Inside the test we can have HTML and JavaScript code blocks. The HTML block will be mounted during the test, and the JavaScript code will be executed as the body of a test. The name of the test is encoded in the starting comment, in this case it will be &quot;DOM test&quot;. The test runs and passes.</p><p><img src="/blog/images/fiddle/dom-test.png" alt="Dom test generated from README.md section"></p><p>From the Markdown file we can generate both the static site (like <a href="https://docs.cypress.io" target="_blank" rel="noopener">https://docs.cypress.io</a>) and run Cypress tests, find one such example in <a href="https://github.com/bahmutov/vuepress-cypress-test-example" target="_blank" rel="noopener">bahmutov/vuepress-cypress-test-example</a>.</p><p>So, the <code>cy.last</code> example in the documentation becomes a fiddle like this:</p><p><img src="/blog/images/fiddle/last-fiddle.png" alt="Last fiddle"></p><p>And it runs as a test in Cypress</p><p><img src="/blog/images/fiddle/last-test.png" alt="Last fiddle test passing"></p><p>Happy testing!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://on.cypress.io&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Cypress documentation&lt;/a&gt; has a lot of examples. Pretty much every command
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="markdown" scheme="https://glebbahmutov.com/blog/tags/markdown/"/>
    
  </entry>
  
  <entry>
    <title>Cambridge MA elections</title>
    <link href="https://glebbahmutov.com/blog/cambridge-elections/"/>
    <id>https://glebbahmutov.com/blog/cambridge-elections/</id>
    <published>2019-10-21T04:00:00.000Z</published>
    <updated>2019-10-23T18:33:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>I had a chance to attend candidate forum before local elections to Cambridge, Massachusetts. All candidates appeal to me, but the climate catastrophe is the number one issue that should be on everyone&#39;s mind right now. So in this light, here are the candidates that do put the Earth&#39;s climate as their number one priority.</p><ul><li><a href="https://www.voteburhan.com/" target="_blank" rel="noopener">Burhan Azeem</a> <a href="https://twitter.com/realBurhanAzeem" target="_blank" rel="noopener">@realBurhanAzeem</a> - see <strong>update 1</strong> below.</li><li><a href="https://votequinton.com/" target="_blank" rel="noopener">Quinton Zondervan</a> <a href="https://twitter.com/qzondervan" target="_blank" rel="noopener">@qzondervan</a> is my number one choice. I fully support his <a href="https://votequinton.com/climate-platform-2019/" target="_blank" rel="noopener">Equitable Climate Response</a>, it is what we urgently need today to survive.</li><li><a href="https://pattynolan.org/" target="_blank" rel="noopener">Patty Nolan</a> <a href="https://twitter.com/PattyNolan1" target="_blank" rel="noopener">@PattyNolan1</a> shares my sense of urgency in regards to climate, read her <a href="https://pattynolan.org/priorities/#climatecrisis" target="_blank" rel="noopener">climate crisis</a> essay. Absolutely wonderful candidate.</li><li><a href="https://www.johnpitkin.org/" target="_blank" rel="noopener">John Pitkin</a> is an environmentalist, who I feel deserves to be on the council, watch his <a href="https://environmentaljusticetv.wordpress.com/2019/10/20/your-political-alternatives-john-pitkin-candidate-for-cambridge-city-council-ev-n-328-cctv/" target="_blank" rel="noopener">Cambridge TV interview</a>.</li><li><a href="https://www.vote1ilan.net/" target="_blank" rel="noopener">Ilan Levy</a> <a href="https://twitter.com/vote1ilan" target="_blank" rel="noopener">@vote1ilan</a> has a great understanding of why climate takes the back seat to the development, and what we need to do to change the city&#39;s policies.</li></ul><p><img src="/blog/images/elections/sign.jpeg" alt="My sign in support of the candidates"></p><p>I loved many other candidates and their platforms: <a href="https://www.voteadriane.com/" target="_blank" rel="noopener">Adriane Musgrave</a> <a href="https://twitter.com/abmusgrave" target="_blank" rel="noopener">@abmusgrave</a>, <a href="https://www.marcmcgovern.com/" target="_blank" rel="noopener">Marc McGovern</a> <a href="https://twitter.com/MarcGov" target="_blank" rel="noopener">@MarcGov</a> (what a great name for an elected politician), and I will vote for them - but after I put the above 4 candidates as my numbers 1 through 4. City of Cambridge has <a href="https://en.wikipedia.org/wiki/Ranked_voting" target="_blank" rel="noopener">ranked voting</a> which is an excellent system.</p><p>Voting in local elections is something every can do - and the people you elect directly affect your town and your life. Please vote with the climate emergency as number one issue this election cycle. Cambridge is a unique rich city with major tech corporations located in it - it should lead in green renewable energy and carbon draw-down.</p><h2><span id="update-1">Update 1</span></h2><p>My original list included 4 people. After getting some feedback from the others, and having a <a href="https://twitter.com/realBurhanAzeem/status/1186746538615300101" target="_blank" rel="noopener">long conversation on Twitter</a> (follows this paragraph) with <a href="https://www.voteburhan.com/" target="_blank" rel="noopener">Burhan Azeem</a> <a href="https://twitter.com/realBurhanAzeem" target="_blank" rel="noopener">@realBurhanAzeem</a> I am so happy to add him to my list of people to support. His clear eyed answer to the question &quot;what is in your opinion a realistic and science-based likely scenario with regards to the climate?&quot; is refreshing to see. We are in <strong>planet becomes unlivable</strong> phase, and by the way - Cambridge being on the shore of Atlantic ocean will not fare very well.</p><p>After the conversation below, <a href="https://twitter.com/bahmutov/status/1186763761199259650" target="_blank" rel="noopener">we have agreed</a> that Cambridge can immediately:</p><p><img src="/blog/images/elections/cambridge.png" alt="What can Cambridge do to cut carbon emissions"></p><p>Tweets below are by Burhan Azeem, <a href="https://twitter.com/realBurhanAzeem/status/1186746538615300101" target="_blank" rel="noopener">original tweet</a></p><p><img src="/blog/images/elections/burhan-convo.jpg" alt="Thread of tweets by Burhan Azeem"></p><p>Related: <a href="../climate-emergency/">Climate Emergency</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I had a chance to attend candidate forum before local elections to Cambridge, Massachusetts. All candidates appeal to me, but the climate
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="climate" scheme="https://glebbahmutov.com/blog/tags/climate/"/>
    
  </entry>
  
  <entry>
    <title>Testing Angular application via App Actions</title>
    <link href="https://glebbahmutov.com/blog/testing-angular-application-via-app-actions/"/>
    <id>https://glebbahmutov.com/blog/testing-angular-application-via-app-actions/</id>
    <published>2019-09-14T04:00:00.000Z</published>
    <updated>2019-09-14T13:41:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>You can find the entire source code for this example at <a href="https://github.com/bahmutov/angular-heroes-app-actions" target="_blank" rel="noopener">bahmutov/angular-heroes-app-actions</a>.</p><h2><span id="introduction">Introduction</span></h2><p>In my previous blog posts I have shown how end-to-end tests do not always have to go through the user interface to interact with the application <a href="https://www.cypress.io/blog/2019/01/03/stop-using-page-objects-and-start-using-app-actions/" target="_blank" rel="noopener">1</a>, <a href="../realworld-app-action/">2</a>, <a href="https://www.cypress.io/blog/2019/02/28/shrink-the-untestable-code-with-app-actions-and-effects/" target="_blank" rel="noopener">3</a>. Those examples used Vue, React and Overmind.js front-end libraries. In this blog post I will show how to access application state directly from the test code for Angular 8 application. We will access the state both to make assertions against it during test, and to dispatch actions against it. This allows us to be both quick and build our tests on top of the component&#39;s API, not on top of the page DOM.</p><!-- toc --><ul><li><a href="#regular-test">Regular test</a></li><li><a href="#exposing-heroes-component">Exposing Heroes component</a></li><li><a href="#asserting-application-state">Asserting application state</a></li><li><a href="#changing-data-inside-the-component">Changing data inside the component</a></li><li><a href="#triggering-application-update">Triggering application update</a></li><li><a href="#tests-using-app-actions">Tests using app actions</a><ul><li><a href="#avoid-setup-using-ui">Avoid setup using UI</a></li><li><a href="#prefer-controlling-app-directly">Prefer controlling app directly</a></li><li><a href="#avoiding-race-conditions">Avoiding race conditions</a></li></ul></li><li><a href="#fixing-typescript">Fixing TypeScript</a></li><li><a href="#conclusions">Conclusions</a><ul><li><a href="#see-more">See more</a></li></ul></li></ul><!-- tocstop --><h2><span id="regular-test">Regular test</span></h2><p>But first, let me give an example of a &quot;normal&quot; end-to-end test. We will write these tests first to cover individual features of the app, simulating the behavior of a normal human user. Let&#39;s take a user story like this</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- user goes to /heroes view</span><br><span class="line">- user sees list of heroes</span><br><span class="line">- &quot;Dr Nice&quot; is at the top of the list</span><br><span class="line">- user does not like &quot;Dr Nice&quot; and deletes him from the list</span><br><span class="line">- &quot;Dr Nice&quot; is gone</span><br><span class="line">- when the user reloads the page, &quot;Dr Nice&quot; appears again</span><br></pre></td></tr></table></figure><p>Here is the corresponding Cypress test, reading almost as naturally as the English sentences above.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'Returns deleted hero after reload'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  cy.get(<span class="string">'ul.heroes li'</span>).should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">    .first().should(<span class="string">'include.text'</span>, <span class="string">'Dr Nice'</span>)</span><br><span class="line">    .find(<span class="string">'.delete'</span>).click()</span><br><span class="line">  cy.get(<span class="string">'ul.heroes li'</span>)</span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">9</span>).and(<span class="string">'not.include.text'</span>, <span class="string">'Dr Nice'</span>)</span><br><span class="line">  cy.reload()</span><br><span class="line">  <span class="comment">// Dr Nice is back</span></span><br><span class="line">  cy.get(<span class="string">'ul.heroes li'</span>)</span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">    .first().should(<span class="string">'include.text'</span>, <span class="string">'Dr Nice'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/angular-app-actions/delete-and-reload.gif" alt="Deleting a hero and reloading the page test"></p><p>This test uses the application through the user interface and confirms the &quot;delete&quot; behavior. We now that the UI element <code>&lt;button class=&quot;delete&quot;&gt;</code> is really working. Let&#39;s never press it again.</p><p>When writing other tests, we can bypass clicking on &quot;Delete&quot; button, instead we can call the underlying component&#39;s &quot;delete&quot; method. This will allow us to build up better application&#39;s internal API, which are public methods in each component, rather than try to come up with a page object that encapsulates <code>cy.find(&#39;.delete&#39;).click()</code> commands.</p><p>But first we will need to somehow expose a reference to a component we want to control, so our test can even get to the component.</p><h2><span id="exposing-heroes-component">Exposing Heroes component</span></h2><p>To reach inside the application from our test, we need to pass a reference to a component or service from the app to the spec. The easiest way to do this is by attaching the reference to the <code>window</code> object. Let&#39;s pass reference to the Heroes component.</p><figure class="highlight ts"><figcaption><span>heroes.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">'app-heroes'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./heroes.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./heroes.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> HeroesComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  heroes: Hero[];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> heroService: HeroService</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.Cypress) &#123;</span><br><span class="line">      <span class="comment">// @ts-ignore</span></span><br><span class="line">      <span class="built_in">window</span>.HeroesComponent = <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the rest of the component</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If our application is running inside Cypress tests, we will set <code>window.HeroesComponent</code>. Notice <code>// @ts-ignore</code> directives - I need to use them because normally <code>window</code> object has neither <code>Cypress</code>, nor <code>HeroesComponent</code> property. The beauty of TypeScript. We will fix this later.</p><p>From our tests, we can reach into the application&#39;s <code>window</code> and use the property <code>HeroesComponent</code> <em>when it gets set</em>. We will do this via assertions taking advantage of <a href="https://on.cypress.io/retry-ability" target="_blank" rel="noopener">retry-ability</a>. Imagine the <code>window</code> starting without <code>HeroesComponent</code> and we want to wait until the property gets set. We need to use <code>should</code> assertion - it will get retried and retried until our application starts and <code>window.HeroesComponent = this</code> is executed.</p><figure class="highlight js"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'sets reference to HeroesComponent'</span>, () =&gt; &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  cy.window()</span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'HeroesComponent'</span>) <span class="comment">// yields window.HeroesComponent</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The assertion &quot;have.property&quot; automatically yields that property to the next command in the chain. Thus we can check and assert the number of heroes initially.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'starts with 10 heroes'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  cy.window()</span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'HeroesComponent'</span>) <span class="comment">// yields window.HeroesComponent</span></span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'heroes'</span>) <span class="comment">// yields window.HeroesComponent.heroes array</span></span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>If you click on any <code>SHOULD</code> command in the Command Log on the left, the yielded object will be printed to the DevTools console. You can see what the application state was at each step, which makes it simple to understand the test and application behavior.</p><p><img src="/blog/images/angular-app-actions/heroes-component.png" alt="The HeroesComponent"></p><p>It is a good idea to factor out the access to the application&#39;s component into a utility function for reuse.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getHeroesComponent = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  cy.window()</span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'HeroesComponent'</span>) <span class="comment">// yields window.HeroesComponent</span></span><br><span class="line"></span><br><span class="line">it(<span class="string">'starts with 10 heroes'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  getHeroesComponent()</span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'heroes'</span>) <span class="comment">// yields window.HeroesComponent.heroes array</span></span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Or if you prefer to a custom command</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Cypress.Commands.add(<span class="string">'getHeroesComponent'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// yields window.HeroesComponent</span></span><br><span class="line">  <span class="keyword">return</span> cy.window().should(<span class="string">'have.property'</span>, <span class="string">'HeroesComponent'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'starts with 10 heroes (custom command)'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  cy.getHeroesComponent()</span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'heroes'</span>) <span class="comment">// yields window.HeroesComponent.heroes array</span></span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>I am not a big fan of custom commands, because at least in TypeScript specs you need to either add <code>// @ts-ignore</code> or have a separate TS files that extends <code>cy</code> with new commands, see <a href="https://on.cypress.io/typescript" target="_blank" rel="noopener">Cypress TypeScript page</a>.</p><h2><span id="asserting-application-state">Asserting application state</span></h2><p>Let&#39;s use the reference to the component to check its state. We will take the same test as before and will add a few more assertions to confirm the first hero in the list before and after &quot;delete&quot;, and after page reload.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'Returns deleted hero after reload - with assertions against data'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  <span class="comment">// confirm the data in the component</span></span><br><span class="line">  getHeroes().should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    .its(<span class="string">'0'</span>)</span><br><span class="line">    .should(<span class="string">'deep.equal'</span>, &#123;</span><br><span class="line">      id: <span class="number">11</span>,</span><br><span class="line">      name: <span class="string">'Dr Nice'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="comment">// confirm the UI</span></span><br><span class="line">  cy.get(<span class="string">'ul.heroes li'</span>).should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">    .first().should(<span class="string">'include.text'</span>, <span class="string">'Dr Nice'</span>)</span><br><span class="line">    .find(<span class="string">'.delete'</span>).click()</span><br><span class="line">  cy.get(<span class="string">'ul.heroes li'</span>)</span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">9</span>).and(<span class="string">'not.include.text'</span>, <span class="string">'Dr Nice'</span>)</span><br><span class="line">  <span class="comment">// confirm the data in the component</span></span><br><span class="line">  getHeroes()</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    .its(<span class="string">'0'</span>).should(<span class="string">'deep.equal'</span>, &#123;</span><br><span class="line">      id: <span class="number">12</span>,</span><br><span class="line">      name: <span class="string">'Narco'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  cy.reload()</span><br><span class="line">  <span class="comment">// Dr Nice is back</span></span><br><span class="line">  cy.get(<span class="string">'ul.heroes li'</span>)</span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">    .first().should(<span class="string">'include.text'</span>, <span class="string">'Dr Nice'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Having assertions against the internal application data ties your tests to the implementation, so judge if it is necessary yourself. If the application&#39;s implementation has reached maturity, and won&#39;t change much in the future, it is probably ok, as it allows you to lock down the internal data details.</p><h2><span id="changing-data-inside-the-component">Changing data inside the component</span></h2><p>We know how to access data inside a component, now let&#39;s change it. Let&#39;s set the number of heroes to zero for example.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'sets zero heroes'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  cy.getHeroesComponent()</span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'heroes'</span>) <span class="comment">// yields window.HeroesComponent.heroes array</span></span><br><span class="line">    .should(<span class="string">'have.length'</span>, <span class="number">10</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">heroes</span> =&gt;</span> &#123;</span><br><span class="line">      heroes.length = <span class="number">0</span></span><br><span class="line">      cy.log(<span class="string">'cleared heroes'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Hmm, the test claims that is has cleared the list of heroes, but the app still shows all of them.</p><p><img src="/blog/images/angular-app-actions/after-clear.png" alt="Application still shows all heroes"></p><h2><span id="triggering-application-update">Triggering application update</span></h2><p>So far we have changed the data inside the application, yet the user interface does not refresh - the application has no idea that it needs to re-render. Let&#39;s force the update. To do this, we need to get a reference to <a href="https://angular.io/api/core/ApplicationRef" target="_blank" rel="noopener">ApplicationRef</a> instance, so we can call <a href="https://angular.io/api/core/ApplicationRef#tick" target="_blank" rel="noopener"><code>appRef.tick()</code></a> method.</p><p>In order to do this, we will change how the application bootstraps in <code>app.module.ts</code>. Usually we just list component to be bootstrapped like this:</p><figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; <span class="keyword">from</span> <span class="string">'./app.component'</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  bootstrap: [ AppComponent ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>But we will implement the bootstrap interface <a href="https://angular.io/api/core/DoBootstrap" target="_blank" rel="noopener">DoBootstrap</a> ourselves - because the callback gets the <code>ApplicationRef</code> argument we want to access later. Here is the small change.</p><figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule, DoBootstrap, ApplicationRef &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; <span class="keyword">from</span> <span class="string">'./app.component'</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="comment">// instead of elements to bootstrap</span></span><br><span class="line">  <span class="comment">// just put app component in the entry components list</span></span><br><span class="line">  entryComponents: [AppComponent]</span><br><span class="line">  <span class="comment">// and remove the "bootstrap" property</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule <span class="keyword">implements</span> DoBootstrap &#123;</span><br><span class="line">  ngDoBootstrap(appRef: ApplicationRef) &#123;</span><br><span class="line">    <span class="comment">// bootstrap AppComponent ourselves</span></span><br><span class="line">    appRef.bootstrap(AppComponent)</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.Cypress) &#123;</span><br><span class="line">      <span class="comment">// and save the application reference!</span></span><br><span class="line">      <span class="comment">// @ts-ignore</span></span><br><span class="line">      <span class="built_in">window</span>.appRef = appRef</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now we can force the application re-render from the DevTools console.</p><p><img src="/blog/images/angular-app-actions/app-ref-tick.gif" alt="Using application reference tick to re-render DOM"></p><p>If we can control our application from DevTools console, we can control it from Cypress - it is just JavaScript.</p><h2><span id="tests-using-app-actions">Tests using app actions</span></h2><h3><span id="avoid-setup-using-ui">Avoid setup using UI</span></h3><p>What happens when there are no heroes and the user does a search? Let&#39;s test it. Our test needs to delete all heroes from the app and then search. Hmm, deleting heroes is complicated because we don&#39;t know how many heroes the application loads. Of course Cypress has a way to click multiple buttons like this</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'deletes all heroes through UI'</span>, () =&gt; &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  <span class="comment">// confirm the heroes have loaded and select "delete" buttons</span></span><br><span class="line">  cy.get(<span class="string">'ul.heroes li button.delete'</span>)</span><br><span class="line">    .should(<span class="string">'have.length.gt'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// and delete all heroes</span></span><br><span class="line">    .click(&#123; <span class="attr">multiple</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>This works, because our application shows ALL items on the same page. Cypress just licks each delete button one by one.</p><p><img src="/blog/images/angular-app-actions/multiple-click.gif" alt="Deleting Heroes by clicking"></p><p>But I advise against this type of test, because in general a test that performs a variable number of steps is prone to be flaky and hard to understand and debug in the future. We call such tests <a href="https://on.cypress.io/conditional-testing" target="_blank" rel="noopener">non-deterministic</a> and advise against them. The test should always follow the same scenario - it should prepare the data beforehand to always follow the same path.</p><p>Imagine our application changes, and starts with zero heroes. The test will FAIL because it cannot click zero delete buttons! Imagine the test starts with 100 heroes. The test will take a long time just to delete a hundred items by clicking a hundred buttons. What if the application paginates the list? Deleting of heroes through the user interface suddenly becomes a hard problem by itself, and any test that needs to have zero heroes becomes flaky and complicated.</p><h3><span id="prefer-controlling-app-directly">Prefer controlling app directly</span></h3><p>There is a better way.</p><p>Let&#39;s avoid the unknown number of clicks problem. We can clear the list by reaching inside the application and just setting the length of list of heroes to zero.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getHeroesComponent = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  cy.window()</span><br><span class="line">    .should(<span class="string">'have.property'</span>, <span class="string">'HeroesComponent'</span>) <span class="comment">// yields window.HeroesComponent</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * yields window.HeroesComponent.heroes array</span></span><br><span class="line"><span class="comment"> * @example</span></span><br><span class="line"><span class="comment"> *  // starts with 10 heroes</span></span><br><span class="line"><span class="comment"> *  cy.visit('/heroes').should('have.length', 10)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getHeroes = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  getHeroesComponent().should(<span class="string">'have.property'</span>, <span class="string">'heroes'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the length of heroes array to 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> clearHeroes = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  getHeroes()</span><br><span class="line">    .then(<span class="function"><span class="params">heroes</span> =&gt;</span> &#123;</span><br><span class="line">      cy.log(<span class="string">`clearing <span class="subst">$&#123;heroes.length&#125;</span> heroes`</span>)</span><br><span class="line">      <span class="comment">// @ts-ignore</span></span><br><span class="line">      heroes.length = <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'deletes all heroes through app action'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  <span class="comment">// confirm the heroes have loaded - because the array has items</span></span><br><span class="line">  getHeroes().should(<span class="string">'have.length.gt'</span>, <span class="number">0</span>)</span><br><span class="line">  clearHeroes()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Great, we are settings <code>heroes.length</code> to zero, we need to re-render the application, right. So let&#39;s add <code>appRef.tick()</code> call. We will add utility function to access <code>window.appRef</code> and then to call <code>tick</code> method.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getAppRef = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  cy.window().should(<span class="string">'have.property'</span>, <span class="string">'appRef'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calls `appRef.tick()` to force UI refresh</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> tick = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  getAppRef()</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    .invoke(<span class="string">'tick'</span>)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'deletes all heroes through app action'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  <span class="comment">// confirm the heroes have loaded - because the array has items</span></span><br><span class="line">  getHeroes().should(<span class="string">'have.length.gt'</span>, <span class="number">0</span>)</span><br><span class="line">  clearHeroes()</span><br><span class="line">  tick()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test passes.</p><p><img src="/blog/images/angular-app-actions/clear-heroes.gif" alt="Deleting Heroes by app action"></p><p>There is nothing non-deterministic about this test. It will just work, assuming the initial list has more than zero items. It is also faster that going through the DOM, although in this case the difference is small in absolute terms - 1 second vs 2 seconds.</p><h3><span id="avoiding-race-conditions">Avoiding race conditions</span></h3><p>Let&#39;s extend the test. After clearing the list of heroes using app action, let&#39;s add a new hero, again using an app action and then confirm the new hero shows up in the UI. We are using the same helper functions plus a new one - <code>addHero</code></p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a new hero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> addHero = <span class="function">(<span class="params">name: <span class="built_in">string</span></span>) =&gt;</span></span><br><span class="line">  cy.window()</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    .its(<span class="string">'HeroesComponent'</span>)</span><br><span class="line">    .invoke(<span class="string">'add'</span>, name)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'shows new hero'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  clearHeroes()</span><br><span class="line">  tick()</span><br><span class="line"></span><br><span class="line">  addHero(<span class="string">'Gleb'</span>) <span class="comment">// the world needs a new hero</span></span><br><span class="line">  tick()</span><br><span class="line">  cy.contains(<span class="string">'.heroes li'</span>, <span class="string">'Gleb'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Ohhh, the test fails, guess I am no hero.</p><p><img src="/blog/images/angular-app-actions/cannot-find-new-hero.png" alt="The new hero does not appear"></p><p>Hmm, there is something weird going on. The list has been cleared, and the UI has refreshed after that. But where is the new hero? Even more suspicious is an observation that if while the <code>cy.contains</code> command is spinning trying to find the new text, I click &quot;Clear&quot; button, the new record suddenly appears, and the test passes.</p><p><img src="/blog/images/angular-app-actions/click-clear.gif" alt="Clicking clear suddenly brings the new record to UI"></p><p>Seems like our <code>tick()</code> action did NOT refresh the user interface after adding a new item, yet it did work when clearing the list of heroes. What is the difference between the two actions? Let&#39;s look at the code.</p><p>When we are clearing heroes, we are just setting <code>heroes.length = 0</code>. This is a synchronous action, thus when the test executes <code>tick()</code> the list has zero items. But the <code>addHero</code> app action calls the following code in the component:</p><figure class="highlight ts"><figcaption><span>heroes.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(name: <span class="built_in">string</span>) &#123;</span><br><span class="line">  name = name.trim();</span><br><span class="line">  <span class="keyword">if</span> (!name) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  <span class="keyword">this</span>.heroService.addHero(&#123; name &#125; <span class="keyword">as</span> Hero)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">hero</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.heroes.push(hero);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hmm, there is an Observable there - this is an asynchronous method, and if we call <code>tick()</code> from the test ... which runs in the same event loop as the application code, we refresh the UI <em>before</em> the asynchronous <code>subscribe</code> callback even runs! We have a race condition between the test calling <code>tick()</code> and calling application code.</p><p>We can try solving this problem in several ways, depending on how much we can modify our application code or slow down our tests.</p><ol><li>Add delays to app actions that involve asynchronous application methods. For example <code>addName</code> test function can just delay the next test command.</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> addHero = <span class="function">(<span class="params">name: string</span>) =&gt;</span></span><br><span class="line">  cy.window()</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    .its(<span class="string">'HeroesComponent'</span>)</span><br><span class="line">    .invoke(<span class="string">'add'</span>, name)</span><br><span class="line">    .wait(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p>Ughh, waiting an entire second? Might be too slow for the interactive mode when Cypress is running locally, yet not enough for running tests on CI, leading to flaky tests.</p><ol start="2"><li>Wait until the heroes list increases its length by 1, which means the application code has finished running <code>this.heroes.push(hero)</code>. Here is how to save the initial length of array, then call app action, then use <code>should(cb)</code> to retry until the array gets an extra item.</li></ol><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a new hero. Waits for number of heroes to increase by 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> addHero = <span class="function">(<span class="params">name: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// first, save the number of items in the list</span></span><br><span class="line">  <span class="comment">// save under alias "n", available in the test context "this.n"</span></span><br><span class="line">  getHeroes().its(<span class="string">'length'</span>).as(<span class="string">'n'</span>)</span><br><span class="line">  cy.window()</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    .its(<span class="string">'HeroesComponent'</span>)</span><br><span class="line">    .invoke(<span class="string">'add'</span>, name)</span><br><span class="line">  <span class="comment">// now retry reading "heroes" array until its length has increased by 1</span></span><br><span class="line">  getHeroes().should(<span class="function"><span class="keyword">function</span> (<span class="params">heroes</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// use "function () &#123;...&#125;" callback to make sure</span></span><br><span class="line">    <span class="comment">// "this" points at the test context</span></span><br><span class="line">    <span class="comment">// and we can access previously saved alias "n"</span></span><br><span class="line">    expect(heroes).to.have.length(<span class="keyword">this</span>.n + <span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">it(<span class="string">'shows new hero'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  clearHeroes()</span><br><span class="line">  tick()</span><br><span class="line"></span><br><span class="line">  addHero(<span class="string">'Gleb'</span>) <span class="comment">// the world needs a new hero</span></span><br><span class="line">  tick()</span><br><span class="line">  cy.contains(<span class="string">'.heroes li'</span>, <span class="string">'Gleb'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test works, and it is as fast it can be.</p><p><img src="/blog/images/angular-app-actions/retry-length-plus-1.png" alt="Waiting until array increases its length by one"></p><ol start="3"><li>Refactor application code to signal when its data has finished updating. Simply, let&#39;s return a promise from component&#39;s method <code>addName</code>. Then the Cypress test can wait for this promise to resolve.</li></ol><figure class="highlight ts"><figcaption><span>heroes.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(name: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  name = name.trim();</span><br><span class="line">  <span class="keyword">if</span> (!name) &#123; <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(); &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.heroService.addHero(&#123; name &#125; <span class="keyword">as</span> Hero)</span><br><span class="line">    .subscribe(<span class="function"><span class="params">hero</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.heroes.push(hero);</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Cypress automatically waits for promise returned from <code>cy.invoke(...)</code> to resolve, thus our test becomes really simple.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a new hero. If the application method "add(name)" returns a promise,</span></span><br><span class="line"><span class="comment"> * the Cypress test command chain automatically waits for the promise to resolve.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> addHero = <span class="function">(<span class="params">name: <span class="built_in">string</span></span>) =&gt;</span></span><br><span class="line">  cy.window()</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    .its(<span class="string">'HeroesComponent'</span>)</span><br><span class="line">    .invoke(<span class="string">'add'</span>, name)</span><br><span class="line"></span><br><span class="line">it(<span class="string">'shows new hero'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">'/heroes'</span>)</span><br><span class="line">  clearHeroes()</span><br><span class="line">  tick()</span><br><span class="line"></span><br><span class="line">  addHero(<span class="string">'Gleb'</span>) <span class="comment">// the world needs a new hero</span></span><br><span class="line">  tick()</span><br><span class="line">  cy.contains(<span class="string">'.heroes li'</span>, <span class="string">'Gleb'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="/blog/images/angular-app-actions/resolve.gif" alt="Cypress test waits for application&#39;s promise to resolve"></p><h2><span id="fixing-typescript">Fixing TypeScript</span></h2><p>Let&#39;s tell TypeScript that <code>window</code> object can have our new properties set. Create a new file <code>src/index.d.ts</code> and describe new properties that the application can add to the <code>window</code> object.</p><figure class="highlight ts"><figcaption><span>src/index.d.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HeroesComponent &#125; <span class="keyword">from</span> <span class="string">'./app/heroes/heroes.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApplicationRef &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">declare</span> global &#123;</span><br><span class="line">  <span class="keyword">interface</span> Window &#123;</span><br><span class="line">    Cypress?: unknown</span><br><span class="line">    appRef?: ApplicationRef</span><br><span class="line">    HeroesComponent?: HeroesComponent</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The file <code>src/index.d.ts</code> will be automatically loaded by TypeScript compiler while process <code>.ts</code> files in <code>src</code> folder, so the <code>window</code> object will be updated. Great, now we can remove all <code>// @ts-ignore</code> from the source code to be simply:</p><figure class="highlight ts"><figcaption><span>src/heroes.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> heroService: HeroService</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.Cypress) &#123;</span><br><span class="line">    <span class="built_in">window</span>.HeroesComponent = <span class="keyword">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now let&#39;s tell our spec files that these new properties are available on the <code>window</code>. Include the <code>src/index.d.ts</code> from the <code>cypress/tsconfig.json</code> file:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extends"</span>: <span class="string">"../tsconfig.json"</span>,</span><br><span class="line">  <span class="attr">"include"</span>: [</span><br><span class="line">    <span class="string">"*/*.ts"</span>,</span><br><span class="line">    <span class="string">"../node_modules/cypress"</span>,</span><br><span class="line">    <span class="string">"../src/index.d.ts"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now when we write a test, the window will have optional application properties, like this:</p><p><img src="/blog/images/angular-app-actions/window-prop.png" alt="IntelliSense shows the new HeroComponent property exists"></p><p>Let&#39;s cast the property returned by the <code>getHeroes()</code> utility function so that our specs &quot;know&quot; what kind of object they are asserting.</p><figure class="highlight ts"><figcaption><span>spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ApplicationRef &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Hero &#125; <span class="keyword">from</span> <span class="string">"app/hero"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * yields window.HeroesComponent.heroes array</span></span><br><span class="line"><span class="comment"> * @example</span></span><br><span class="line"><span class="comment"> *  // starts with 10 heroes</span></span><br><span class="line"><span class="comment"> *  cy.visit('/heroes').should('have.length', 10)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getHeroes = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  getHeroesComponent().should(<span class="string">'have.property'</span>, <span class="string">'heroes'</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">list</span> =&gt;</span> &lt;Hero[]&gt;&lt;unknown&gt;list) <span class="comment">// make the type work</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getAppRef = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  cy.window().should(<span class="string">'have.property'</span>, <span class="string">'appRef'</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">x</span> =&gt;</span> &lt;ApplicationRef&gt;&lt;unknown&gt;x) <span class="comment">// make the type work</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calls `appRef.tick()` to force UI refresh</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> tick = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  getAppRef()</span><br><span class="line">    .invoke(<span class="string">'tick'</span>)</span><br></pre></td></tr></table></figure><p>Now we can remove all <code>// @ts-ignore</code> from the spec file. When we have types, even hovering over <code>getAppRef().invoke</code> method correctly shows only the methods available on the <code>ApplicationRef</code> type.</p><p><img src="/blog/images/angular-app-actions/appref.gif" alt="TypeScript provides intelligent code completion for `cy.invoke` over ApplicationRef"></p><p>Finally, let&#39;s add a custom command we have added <code>cy.getHeroesComponent()</code> to TypeScript. As shown in <a href="https://on.cypress.io/typescript" target="_blank" rel="noopener">Cypress TypeScript documentation</a>, to add new commands to the global <code>cy</code> object type we need to create <code>cypress/support/index.d.ts</code></p><figure class="highlight ts"><figcaption><span>cypress/support/index.d.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">namespace</span> Cypress &#123;</span><br><span class="line">  <span class="keyword">interface</span> Chainable &#123;</span><br><span class="line">    getHeroesComponent(): Chainable&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>For some reason I could not import <code>HeroesComponent</code> and return <code>Chainable&lt;HeroesComponent&gt;</code> - TypeScript compiler would complain about generic interface. The beauty of TypeScript.</p><h2><span id="conclusions">Conclusions</span></h2><p>In this blog post I have shown how to expose an Angular component instance and access it from Cypress tests. Using the instance reference we can check the internal application&#39;s state, and also trigger data changes, bypassing user interface. I have also shown how to trigger user interface updates by getting a reference to the application during bootstrap. We have seen several solutions to race conditions between the app and the test runner. Finally I have shown how to fix TypeScript errors when we extend global <code>window</code> and <code>cy</code> objects with custom properties.</p><h3><span id="see-more">See more</span></h3><ul><li>Find the source code from this blog post at <a href="https://github.com/bahmutov/angular-heroes-app-actions" target="_blank" rel="noopener">bahmutov/angular-heroes-app-actions</a></li><li>Read <a href="https://www.cypress.io/blog/2019/01/03/stop-using-page-objects-and-start-using-app-actions/" target="_blank" rel="noopener">Stop using page objects and start using app actions</a></li><li>See more <a href="https://github.com/cypress-io/cypress-example-recipes" target="_blank" rel="noopener">Cypress recipes</a> and read my <a href="../tags/cypress/">blog posts about Cypress</a> and the official <a href="https://www.cypress.io/blog/" target="_blank" rel="noopener">Cypress blog</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;You can find the entire source code for this example at &lt;a href=&quot;https://github.com/bahmutov/angular-heroes-app-actions&quot; target=&quot;_blank&quot; 
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Visual diffing flow for your pretty CLI applications</title>
    <link href="https://glebbahmutov.com/blog/visual-diffing-for-CLI-apps/"/>
    <id>https://glebbahmutov.com/blog/visual-diffing-for-CLI-apps/</id>
    <published>2019-09-11T04:00:00.000Z</published>
    <updated>2019-09-11T03:17:29.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Note:</strong> you can find the example source code in repo <a href="https://github.com/bahmutov/percy-for-cli-example" target="_blank" rel="noopener">bahmutov/percy-for-cli-example</a>.</p><p>I have been a big fan of <a href="https://on.cypress.io/visual-testing" target="_blank" rel="noopener">visual testing</a> for web applications. Since reliable rendering of web pages and comparing images is complicated, I am a big fan of just using an existing 3rd party service like <a href="https://percy.io" target="_blank" rel="noopener">Percy.io</a> and <a href="https://applitools.com" target="_blank" rel="noopener">Applitools</a>. These services are fast, reliable, and just work.</p><p>I especially like the pull request review workflow. If a visual service detects a difference between the &quot;gold&quot; images it stores and the newly generated ones, it sets a failed commit check, and I know there are visual regressions. Anyone from the team can review the visual changes, comment, understand them. If the changes are really expected, the new images can be approved and become the new &quot;gold&quot; images to be compared against.</p><p>So that is all good and fun for web applications, but recently we have been refactoring CLI output from the <a href="http://github.com/cypress-io/cypress" target="_blank" rel="noopener">Cypress Test Runner</a> - and it is complicated. Our current output renders tables with multiple columns, uses terminal colors, text padding and alignment, hmm. We are using text snapshots, but they strip colors, and are relatively hard to judge or discuss as a team.</p><p>I want the same workflow for unit tests or CLI applications that output complex information to the terminal. That&#39;s why I have created this experiment:</p><ol><li>Capture CLI output from an app, for example from a test runner</li><li>Convert ANSI control characters that set foreground and background colors to matching HTML styles. There are many small NPM utilities that do this.</li><li>Send the generated HTML to Percy.io API<ul><li>Percy thinks this came from a real DOM snapshot</li><li>it renders the terminal HTML in a real browser</li><li>generates an image and compares it to the &quot;gold&quot;</li></ul></li></ol><p>Easy peasy.</p><p>Here is the &quot;standard&quot; Mocha run in the terminal.</p><p><img src="/blog/images/percy-cli/mocha-run.png" alt="Mocha test run"></p><p>Here is how we can spawn Mocha from a parent process, yet force colors</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// force child process to output ANSI colors</span></span><br><span class="line"><span class="comment">// if possible using FORCE_COLOR</span></span><br><span class="line"><span class="comment">// commonly used via https://github.com/chalk/supports-color</span></span><br><span class="line"><span class="comment">// const child = spawn('node', ['./colors'], &#123;</span></span><br><span class="line"><span class="keyword">const</span> spawn = <span class="built_in">require</span>(<span class="string">'child_process'</span>).spawn</span><br><span class="line"><span class="keyword">const</span> child = spawn(</span><br><span class="line">  <span class="string">'node'</span>,</span><br><span class="line">  [<span class="string">'./node_modules/.bin/mocha'</span>, <span class="string">'./spec.js'</span>, <span class="string">'--reporter'</span>, <span class="string">'spec'</span>],</span><br><span class="line">  &#123;</span><br><span class="line">    env: &#123; ...process.env, <span class="attr">FORCE_COLOR</span>: <span class="string">'2'</span> &#125;,</span><br><span class="line">    cwd: process.cwd(),</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Here is how we convert ANSI characters to HTML using <a href="https://github.com/rburns/ansi-to-html" target="_blank" rel="noopener">ansi-to-html</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// assuming the browser page is white</span></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  newline: <span class="literal">true</span>,</span><br><span class="line">  bg: <span class="string">'#fff'</span>,</span><br><span class="line">  fg: <span class="string">'#111'</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> convert = <span class="keyword">new</span> (<span class="built_in">require</span>(<span class="string">'ansi-to-html'</span>))(options)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> html = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> htmlStream = <span class="function"><span class="keyword">function</span> <span class="title">htmlStream</span>(<span class="params">stream</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    html += convert.toHtml(chunk)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">child.stdout.setEncoding(<span class="string">'utf8'</span>)</span><br><span class="line">child.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error)</span><br><span class="line">child.stdout.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// send result to Percy</span></span><br><span class="line">&#125;)</span><br><span class="line">htmlStream(child.stdout)</span><br></pre></td></tr></table></figure><p>The final HTML can be wrapped in <code>&lt;html&gt;</code> with <code>utf8</code> meta flag and will look something like this</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    example<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#0A0"</span>&gt;</span> ✓<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#555"</span>&gt;</span> works A<span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#A00"</span>&gt;</span> (1002ms)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#0A0"</span>&gt;</span> ✓<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#555"</span>&gt;</span> works B<span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#A00"</span>&gt;</span> (1005ms)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#0A0"</span>&gt;</span> ✓<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#555"</span>&gt;</span> works C<span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#A00"</span>&gt;</span> (1002ms)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#0AA"</span>&gt;</span> - skips D<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">      <span class="attr">style</span>=<span class="string">"color:#5F5"</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#0A0"</span>&gt;</span> 3 passing<span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#555"</span>&gt;</span> (3s)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#0AA"</span>&gt;</span> <span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:#0AA"</span>&gt;</span> 1 pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>We can send this HTML to Percy API by running a local Percy agent, which runs by default on port 5338 and posting the generated HTML there. Here is how to run Percy and demo project.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"demo"</span>: <span class="string">"node ./index"</span>,</span><br><span class="line">    <span class="attr">"demo-percy"</span>: <span class="string">"npx percy exec -- npm run demo"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"ansi-to-html"</span>: <span class="string">"0.6.11"</span>,</span><br><span class="line">    <span class="attr">"axios"</span>: <span class="string">"0.19.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"@percy/script"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Sending is just a POST request</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// post HTML to the Percy agent</span></span><br><span class="line"><span class="comment">// follow "cy.request" code in</span></span><br><span class="line"><span class="comment">// https://github.com/percy/percy-cypress/blob/master/lib/index.ts</span></span><br><span class="line"><span class="comment">// and https://github.com/percy/percy-agent</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="string">'http://localhost:5338/percy/snapshot'</span></span><br><span class="line">axios</span><br><span class="line">  .post(url, &#123;</span><br><span class="line">    name: <span class="string">'my example name'</span>,</span><br><span class="line">    url: <span class="string">'http://localhost/example'</span>,</span><br><span class="line">    enableJavaScript: <span class="literal">false</span>,</span><br><span class="line">    domSnapshot: html,</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(e)</span><br><span class="line">    <span class="keyword">throw</span> e</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>Percy API requires a private project token, I will inject it during run-time using <a href="https://github.com/bahmutov/as-a" target="_blank" rel="noopener">as-a</a> utility.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> as<span class="_">-a</span> percy-for-cli-example npm run demo-percy</span></span><br></pre></td></tr></table></figure><p>The scripts runs and sends its terminal to visual diffing service as HTML string.</p><p><img src="/blog/images/percy-cli/demo-run.gif" alt="Demo run"></p><p>You can find Percy dashboard for this project at <a href="https://percy.io/bahmutov/percy-for-cli-example" target="_blank" rel="noopener">percy.io/bahmutov/percy-for-cli-example</a>. All images uploaded from <code>master</code> branch are auto-approved, while images uploaded from other branches are compared to the &quot;gold&quot; images. For example the last build has 1 image with detected visual difference.</p><p><img src="/blog/images/percy-cli/list-of-snapshots.png" alt="Percy project dashboard"></p><p>Someone from the team will have to go to the build and review the visual changes and either approve or reject them. In this case the difference is just in millisecond numbers - our snapshot needs to be sanitized before sending to Percy to avoid flagging trivial changes like this.</p><p><img src="/blog/images/percy-cli/percy-changes.gif" alt="Percy shows visual difference in the terminal output"></p><ul><li>Source <a href="https://github.com/bahmutov/percy-for-cli-example" target="_blank" rel="noopener">bahmutov/percy-for-cli-example</a></li><li>Percy project <a href="https://percy.io/bahmutov/percy-for-cli-example" target="_blank" rel="noopener">percy.io/bahmutov/percy-for-cli-example</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; you can find the example source code in repo &lt;a href=&quot;https://github.com/bahmutov/percy-for-cli-example&quot; target=&quot;_
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
  </entry>
  
  <entry>
    <title>How to configure Prettier and VSCode</title>
    <link href="https://glebbahmutov.com/blog/configure-prettier-in-vscode/"/>
    <id>https://glebbahmutov.com/blog/configure-prettier-in-vscode/</id>
    <published>2019-09-09T04:00:00.000Z</published>
    <updated>2020-05-15T16:35:27.801Z</updated>
    
    <content type="html"><![CDATA[<p>You can configure JavaScript code auto-formatting with Prettier to work per-project. This allows you to get a consistent formatting without thinking or arguing about it. This blog post shows how to configure Prettier to work from command line, from VSCode and from Git hooks.</p><p>You can find the sample project with different Prettier settings configured per-subfolder at <a href="https://github.com/bahmutov/prettier-config-example" target="_blank" rel="noopener">bahmutov/prettier-config-example</a>.</p><!-- toc --><ul><li><a href="#why-prettier">Why Prettier?</a></li><li><a href="#setup">Setup</a></li><li><a href="#settings">Settings</a></li><li><a href="#vscode-setup">VSCode setup</a></li><li><a href="#format-files-from-cli">Format files from CLI</a></li><li><a href="#format-staged-files-on-commit">Format staged files on commit</a></li><li><a href="#catch-mis-formatted-files-on-ci">Catch mis-formatted files on CI</a><ul><li><a href="#using-stop-build">Using stop-build</a></li><li><a href="#using-prettier">Using Prettier</a></li></ul></li><li><a href="#common-problems">Common problems</a><ul><li><a href="#nothing-happens-on-save">Nothing happens on save</a></li><li><a href="#code-formatting-is-wrong">Code formatting is wrong</a></li></ul></li><li><a href="#tips">Tips</a><ul><li><a href="#ignoring-files">Ignoring files</a></li><li><a href="#saving-without-formatting">Saving without formatting</a></li><li><a href="#temporarily-disable-formatting">Temporarily disable formatting</a></li><li><a href="#only-format-configured-projects">Only format configured projects</a></li><li><a href="#ignore-parts-of-files">Ignore parts of files</a></li></ul></li><li><a href="#use-eslint-with-prettier">Use Eslint with Prettier</a><ul><li><a href="#disable-style-rules-in-eslint">Disable style rules in ESLint</a></li><li><a href="#eslint-and-react">ESLint and React</a></li><li><a href="#integrate-eslint-in-vscode">Integrate ESLint in VSCode</a></li><li><a href="#run-prettier-from-eslint">Run Prettier from ESLint</a></li><li><a href="#vscode-eslint-prettier-setup">VSCode + ESLint + Prettier setup</a></li><li><a href="#vscode-eslint-prettier-typescript-setup">VSCode + ESLint + Prettier + TypeScript setup</a></li><li><a href="#use-prettier-eslint-cypress">Use Prettier + ESLint + Cypress</a></li><li><a href="#catch-exclusive-tests">Catch exclusive tests</a></li><li><a href="#format-other-languages-with-prettier">Format other languages with Prettier</a></li><li><a href="#format-json-files-with-prettier">Format JSON files with Prettier</a></li><li><a href="#use-custom-settings-overrides">Use custom settings overrides</a></li></ul></li><li><a href="#common-eslint-problems">Common ESLint problems</a><ul><li><a href="#errors-shown-for-async-keyword">Errors shown for async keyword</a></li></ul></li><li><a href="#chrome-extension">Chrome extension</a></li><li><a href="#run-prettier-inside-github-action">Run Prettier inside GitHub Action</a></li></ul><!-- tocstop --><h2><span id="why-prettier">Why Prettier?</span></h2><p><a href="https://prettier.io/" target="_blank" rel="noopener">Prettier</a> reformats your JavaScript code consistently and (arguably) in way that is easy to read and understand. It takes whatever copy/pasted code snippets you put into your file and makes it look the same as the rest of the code. By using Prettier your team skips ALL disagreements about spacing, variable declarations, semi-colons, trailing commas, etc. The code just magically gets to the format you pick.</p><p>You can use Prettier from command line, or from your code editor whenever you paste or save a file. I prefer to use two solutions described in this blog post:</p><ul><li>format the file from VSCode every time I save it</li><li>format the changed files on Git commit before committing them</li></ul><p>Let me show you how to do both.</p><h2><span id="setup">Setup</span></h2><p>When setting up Prettier it is important to configure it per-project. Not every project uses the same code style, thus it is important to respect the style of whatever project you are currently working in. The demo repo <a href="https://github.com/bahmutov/prettier-config-example" target="_blank" rel="noopener">bahmutov/prettier-config-example</a> has two subfolders, each with its distinct code style, enforced by Prettier. In reality, each of your repos will have its style; I am using subfolders in order to keep the example simple.</p><p>I assume you are using NPM and have <code>package.json</code> file inside the repository. Install Prettier</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev --save-exact prettier</span><br></pre></td></tr></table></figure><p>At the root of the project create the Prettier configuration file. In my example I have two subfolders, and there is a configuration file in each subfolder:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prettier-config-example/</span><br><span class="line">  projectA/</span><br><span class="line">    .prettierrc.json</span><br><span class="line">  projectB/</span><br><span class="line">    .prettierrc.json</span><br></pre></td></tr></table></figure><p>I like using JSON configuration format so my code editor helps me. In fact, VSCode understands the Prettier configuration file format via the built-in <a href="../json-schema-for-the-win/">json schema</a>. So when I edit <code>projectA/.prettierrc.json</code> file, I get intelligent tooltips.</p><p><img src="/blog/images/prettier/prettier-intellisense.gif" alt="Picking trailing comma setting"></p><h2><span id="settings">Settings</span></h2><p>Prettier tries to enforce the same code style without 100s of options, thus there are just a few settings you can change. Here are settings I am using in the first project to make it look &quot;traditional&quot; ES5</p><figure class="highlight json"><figcaption><span>projectA/.prettierrc.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"trailingComma"</span>:<span class="string">"none"</span>,</span><br><span class="line">  <span class="attr">"tabWidth"</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">"semi"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"singleQuote"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The second project uses more modern style without semi-colons and with trailing commas.</p><figure class="highlight json"><figcaption><span>projectB/.prettierrc.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"trailingComma"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"tabWidth"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"semi"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"singleQuote"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="vscode-setup">VSCode setup</span></h2><p>To use the Prettier we have just installed from VSCode we need to install the <a href="https://github.com/prettier/prettier-vscode" target="_blank" rel="noopener">Prettier VSCode extension</a>:</p><ol><li>Launch VS Code Quick Open (Ctrl+P)</li><li>Run the following command</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ext install esbenp.prettier-vscode</span><br></pre></td></tr></table></figure><p>Because you might have global settings related to code formatting, I prefer having in each repository a file with local workspace VSCode settings. I commit this file <code>.vscode/settings.json</code> to source control to make sure everyone uses the same extension to format the code.</p><figure class="highlight json"><figcaption><span>.vscode/settings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"esbenp.prettier-vscode"</span>,</span><br><span class="line">  <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now every time we save a JavaScript file, it will be formatted using Prettier automatically. Here is me formatting <code>projectA/index.js</code> file by saving it.</p><p><img src="/blog/images/prettier/projectA.gif" alt="Prettier formats projectA/index.js"></p><p>Notice the double quotes, semi-colons, etc - Prettier has applied the settings from <code>projectA/.prettierrc.json</code>. It also split long object across multiple lines to make it easier to read.</p><p>The same JavaScript code in <code>projectB/index.js</code> gets formatted by Prettier using different local settings and ends up looking different.</p><p><img src="/blog/images/prettier/projectB.gif" alt="Prettier formats projectB/index.js"></p><p>Single quotes, no semi-colons, trailing commas.</p><p><strong>Tip:</strong> I love formatting code on &quot;Save&quot;, but I hate formatting code on &quot;Paste&quot; - because it always adds extra line breaks. So I highly recommend the following VSCode settings</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"esbenp.prettier-vscode"</span>,</span><br><span class="line">  <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"editor.formatOnPaste"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="format-files-from-cli">Format files from CLI</span></h2><p>Formatting every file as you save it is nice, but we can also format ALL source files at once using Prettier CLI. In the <code>package.json</code> add a script to format files matching the mask and to write them back to disk.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"prettier-config-example"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"format"</span>: <span class="string">"prettier --write 'projectA/*.js' 'projectB/*.js'"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"prettier"</span>: <span class="string">"1.18.2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Run this NPM script and the files will be formatted to follow the Prettier style.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ npm run format</span><br><span class="line"></span><br><span class="line">&gt; prettier-config-example@1.0.0 format /Users/gleb/git/prettier-config-example</span><br><span class="line">&gt; prettier --write &apos;projectA/*.js&apos; &apos;projectB/*.js&apos;</span><br><span class="line"></span><br><span class="line">projectA/index.js 30ms</span><br><span class="line">projectB/index.js 10ms</span><br></pre></td></tr></table></figure><p>If you want to format files with several extensions, list them using curly braces and commas. If you need to find all files in all subfolders, use <code>**</code> syntax. For example, to format all <code>.ts</code> and <code>.tsx</code> files in the <code>src</code> folder use:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prettier --write 'src/**/*.&#123;ts,tsx&#125;'</span><br></pre></td></tr></table></figure><h2><span id="format-staged-files-on-commit">Format staged files on commit</span></h2><p>Whenever we work with files locally, we might accidentally commit them without proper styling. That&#39;s where Git hooks and formatting staged files comes in handy. To consistently format all files before committing and then commit changes, I recommend using <a href="https://github.com/typicode/husky" target="_blank" rel="noopener">husky</a> + <a href="https://github.com/okonet/lint-staged" target="_blank" rel="noopener">lint-staged</a> combination of tools.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D husky lint-staged</span></span><br><span class="line">+ husky@3.0.5</span><br><span class="line">+ lint-staged@9.2.5</span><br></pre></td></tr></table></figure><p>Now configure pre-commit hook to run Prettier against staged JavaScript files. In the <code>package.json</code> set the following</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"husky"</span>: <span class="string">"3.0.5"</span>,</span><br><span class="line">    <span class="attr">"lint-staged"</span>: <span class="string">"9.2.5"</span>,</span><br><span class="line">    <span class="attr">"prettier"</span>: <span class="string">"1.18.2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"husky"</span>: &#123;</span><br><span class="line">    <span class="attr">"hooks"</span>: &#123;</span><br><span class="line">      <span class="attr">"pre-commit"</span>: <span class="string">"lint-staged"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"lint-staged"</span>: &#123;</span><br><span class="line">    <span class="attr">"*.js"</span>: [<span class="string">"prettier --write"</span>, <span class="string">"git add"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>See <a href="https://github.com/okonet/lint-staged#reformatting-the-code" target="_blank" rel="noopener">lint-staged code formatting documentation</a>.</p><p>If you try to commit changed JavaScript files, they will automatically be formatted and re-staged, ensuring only pretty JavaScript code is committed. In the Git commit shortcut output below, the &quot;Running tasks...&quot; messages comes from the <code>lint-staged</code> tool.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ g done &quot;add husky and lint-staged&quot;</span><br><span class="line">husky &gt; pre-commit (node v12.4.0)</span><br><span class="line">  ↓ Stashing changes... [skipped]</span><br><span class="line">    → No partially staged files found...</span><br><span class="line">  ✔ Running tasks...</span><br><span class="line">[master 583b92a] add husky and lint-staged</span><br><span class="line"> 2 files changed, 1513 insertions(+)</span><br></pre></td></tr></table></figure><p>Of course, you can skip the Git pre-commit hook by committing with <code>-n</code> flag.</p><p><strong>Update</strong> when using <code>husky@4</code> and <code>lint-staged@10</code> the transformed files are added to the commit automatically. For example to format JavaScript and Markdown files on commit:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"husky"</span>: &#123;</span><br><span class="line">    <span class="attr">"hooks"</span>: &#123;</span><br><span class="line">      <span class="attr">"pre-commit"</span>: <span class="string">"lint-staged"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"lint-staged"</span>: &#123;</span><br><span class="line">    <span class="attr">"*.&#123;js,md&#125;"</span>: [<span class="string">"prettier --write"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="catch-mis-formatted-files-on-ci">Catch mis-formatted files on CI</span></h2><h3><span id="using-stop-build">Using stop-build</span></h3><p>You can really enforce the formatting before pushing code to the central repository by running Prettier on CI and then detecting any changed files. Just run <a href="https://github.com/bahmutov/stop-build" target="_blank" rel="noopener">stop-build</a> after running Prettier.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">format</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npx</span> <span class="string">run</span> <span class="string">stop-build</span></span><br></pre></td></tr></table></figure><p>If any of the source files were reformatted by Prettier, the <code>stop-only</code> will detect changed source files using Git information and will exit with an error. It will list the changed files, something like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">⚠️ there are 2 changed files</span><br><span class="line">M projectA/index.js</span><br><span class="line">M projectB/index.js</span><br></pre></td></tr></table></figure><h3><span id="using-prettier">Using Prettier</span></h3><p>Prettier has built-in command <a href="https://prettier.io/docs/en/cli.html#check" target="_blank" rel="noopener"><code>--check</code></a> that validates code files against formatting. Using it from a script in <code>package.json</code> file:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"check"</span>: <span class="string">"prettier --check 'projectA/*.js' 'projectB/*.js'"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then on CI we can call the script right after <code>npm install</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npx</span> <span class="string">run</span> <span class="string">check</span></span><br></pre></td></tr></table></figure><p>Let&#39;s say one of the files has not been formatted.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ npm run check</span><br><span class="line"></span><br><span class="line">&gt; prettier-config-example@1.0.0 check /git/prettier-config-example</span><br><span class="line">&gt; prettier --check &apos;projectA/*.js&apos; &apos;projectB/*.js&apos;</span><br><span class="line"></span><br><span class="line">Checking formatting...</span><br><span class="line">projectB/index.js</span><br><span class="line">Code style issues found in the above file(s). Forgot to run Prettier?</span><br></pre></td></tr></table></figure><h2><span id="common-problems">Common problems</span></h2><h3><span id="nothing-happens-on-save">Nothing happens on save</span></h3><p>You are saving a file in VSCode ... and the code does not change. This could be due to three issues:</p><ol><li>Make sure local workspace settings have auto-format on save enabled. Open <code>.vscode/settings.json</code> file and confirm:<ul><li>VSCode Prettier extension is configured as the default formatter.</li><li>Formatting on save is enabled</li></ul></li></ol><figure class="highlight json"><figcaption><span>.vscode/settings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"esbenp.prettier-vscode"</span>,</span><br><span class="line">  <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>Prettier extension might be disabled by VSCode. Make sure the word &quot;Prettier&quot; appears on the Status Bar and has check mark symbol next to it. To check:<ul><li>Right click on the Status Bar. Make sure the &quot;Prettier&quot; extension appears there is displayed.</li></ul></li></ol><p><img src="/blog/images/prettier/show-extension.png" alt="Show Prettier extension status"></p><ol start="3"><li>Make sure there is a checkmark next to the &quot;Prettier&quot; in the Status Bar. Sometimes after enabling the extension, it is loaded, but not enabled.</li></ol><p><img src="/blog/images/prettier/prettier-not-enabled.png" alt="Prettier extension is disabled for some reason"></p><p>One thing I have noticed that sometimes saving a file enables Prettier if the <code>.vscode/settings.json</code> have the extension enabled for this workspace. For example in this animation I am saving the file with double quotes around a string, and magically the Prettier extension gets the check mark and does its job. Don&#39;t ask.</p><p><img src="/blog/images/prettier/save-enables-prettier.gif" alt="Saving file enables Prettier and formats the code"></p><p>If you click on the &quot;Prettier&quot; extension word in the status bar, it should open the Prettier output tab. It shows what Prettier extension executes, and often shows the problem. For example, the screenshot below shows that Prettier did not run because the project does not have Prettier configuration file like <code>.prettierrc</code>.</p><p><img src="/blog/images/prettier/prettier-tab.png" alt="Prettier extension tab"></p><p>If everything else fails, quit VSCode and start it again.</p><h3><span id="code-formatting-is-wrong">Code formatting is wrong</span></h3><p>Here is a little animation that shows a file being saved with Prettier setting &quot;trailingComma: true&quot;, yet the comma gets deleted somehow.</p><p><img src="/blog/images/prettier/comma-deleted.gif" alt="Saving file removes trailing comma"></p><p>Check if there are OTHER code formatting extensions installed and disable them for this workspace. For some reason, VSCode can use globally installed extension overwriting local setting. Don&#39;t ask. In my case, I had &quot;Prettier-Standard&quot; extension enabled globally. After disabling the &quot;Prettier-Standard&quot; for the current workspace, Prettier extension started working as expected.</p><p><img src="/blog/images/prettier/disable.png" alt="Disabling Prettier-Standard extension"></p><p>Why can&#39;t VSCode save the list of disabled extensions in <code>.vscode/settings.json</code>?</p><h2><span id="tips">Tips</span></h2><h3><span id="ignoring-files">Ignoring files</span></h3><p>Sometimes you have files that should not be formatted: auto-generated source files, saved snapshots, etc. You can list file masks to ignore in file <code>.prettierignore</code>. For example, to ignore all JavaScript files in <code>snapshots</code> folders use</p><figure class="highlight plain"><figcaption><span>.prettierignore</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># do not run Prettier against JavaScript files</span><br><span class="line"># in &quot;snapshots/&quot; folders</span><br><span class="line">**/snapshots/*.js</span><br></pre></td></tr></table></figure><h3><span id="saving-without-formatting">Saving without formatting</span></h3><p>If you ever work in someone else&#39;s project, please respect their formatting. In order to avoid reformatting the entire file when you save it from VSCode, save it without formatting. Run &quot;Command + Shift + P&quot; to open the Command Palette and type &quot;save without&quot; until you see &quot;File: Save without Formatting&quot; command - use that.</p><p><img src="/blog/images/prettier/save-without-formatting.png" alt="Save without formatting"></p><h3><span id="temporarily-disable-formatting">Temporarily disable formatting</span></h3><p>There is also an extension that temporarily disables format on save feature called <a href="https://marketplace.visualstudio.com/items?itemName=tombonnike.vscode-status-bar-format-toggle" target="_blank" rel="noopener">Formatting Toggle</a>. Install it in your VSCode and whenever you want to temporarily disable Prettier on save, click on the &quot;Formatting&quot; toggle in the status bar.</p><p><img src="/blog/images/prettier/format-toggle.png" alt="Save without formatting"></p><h3><span id="only-format-configured-projects">Only format configured projects</span></h3><p>In the VSCode global settings, set this option to only allow running Prettier in the folders with Prettier config file.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Prettier: Require Config</span><br><span class="line">✅ Require a prettier configuration file to format</span><br></pre></td></tr></table></figure><p><img src="/blog/images/prettier/require-prettier-config.png" alt="User global setting to require configuration file"></p><p>I definitely recommend setting this global option to avoid accidentally changing how the code looks in the projects that do not want to use your or any Prettier settings.</p><h3><span id="ignore-parts-of-files">Ignore parts of files</span></h3><p>I love using <a href="https://prettier.io/docs/en/ignore.html" target="_blank" rel="noopener">range ignore</a> to disable formatting parts of file. For example, to stop Prettier from reformatting Markdown tables use:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- prettier-ignore-start --&gt;</span><br><span class="line">name | job</span><br><span class="line">--- | ---</span><br><span class="line">Joe | student</span><br><span class="line">Mary | therapist</span><br><span class="line">&lt;!-- prettier-ignore-end --&gt;</span><br></pre></td></tr></table></figure><p>In code, you can tell Prettier to ignore the next AST node by adding <code>// prettier-ignore</code> comment. For example, in the next test we want to show the array input as a Tic-Tac-Toe board</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'returns O for second row of O'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// preserve our Tic-Tac-Toe board formatting</span></span><br><span class="line">  <span class="comment">// prettier-ignore</span></span><br><span class="line">  <span class="keyword">const</span> squares = [</span><br><span class="line">    <span class="string">'X'</span>, <span class="string">'X'</span>, <span class="literal">null</span>,</span><br><span class="line">    <span class="string">'O'</span>, <span class="string">'O'</span>, <span class="string">'O'</span>,</span><br><span class="line">    <span class="literal">null</span>, <span class="literal">null</span>, <span class="string">'X'</span></span><br><span class="line">  ]</span><br><span class="line">  <span class="keyword">const</span> winner = calculateWinner(squares)</span><br><span class="line">  expect(winner).to.equal(<span class="string">'O'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="use-eslint-with-prettier">Use Eslint with Prettier</span></h2><p>Prettier reformats JavaScript code to follow certain style, it does not check the meaning of the code. For example, Prettier happily reformats the following wrong code.</p><p><img src="/blog/images/prettier/const.gif" alt="Prettier makes this wrong code look pretty"></p><p>Static linters, like <a href="https://eslint.org/" target="_blank" rel="noopener">ESLint</a> can catch the assignment to a constant variable, so we need both:</p><ul><li>Prettier will reformat the code to be consistent in style</li><li>ESLint will analyze the meaning of code and catch potential problems</li></ul><h3><span id="disable-style-rules-in-eslint">Disable style rules in ESLint</span></h3><p>ESLint runs a long list of rules against the code, and some of these rules are stylistic, and can conflict with Prettier&#39;s style. Thus we need to configure ESLint to skip those rules. This configuration is in module <a href="https://prettier.io/docs/en/integrating-with-linters.html#eslint" target="_blank" rel="noopener">eslint-config-prettier</a>. Install it</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D eslint eslint-config-prettier</span></span><br></pre></td></tr></table></figure><p>and can be added to your project <code>.eslintrc.json</code> file. ESLint will not run without a valid configuration file.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"es6"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"extends"</span>: [<span class="string">"eslint:recommended"</span>, <span class="string">"prettier"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now when you run ESLint against this file</p><figure class="highlight js"><figcaption><span>projectC/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">'Joe'</span>; name = <span class="string">'Mary'</span></span><br></pre></td></tr></table></figure><p>Then ESLint will catch the <code>const</code> assignment error; it will also catch that the variable <code>name</code> is never used after assignment.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx eslint projectC/index.js</span></span><br><span class="line"></span><br><span class="line">/prettier-config-example/projectC/index.js</span><br><span class="line">  1:7   error  'name' is assigned a value but never used  no-unused-vars</span><br><span class="line">  1:21  error  'name' is constant                         no-const-assign</span><br><span class="line"></span><br><span class="line">✖ 2 problems (2 errors, 0 warnings)</span><br></pre></td></tr></table></figure><h3><span id="eslint-and-react">ESLint and React</span></h3><p>If you want to check React code that uses JSX, <code>import / export</code> keywords, then install a plugin <a href="https://www.npmjs.com/package/eslint-plugin-react" target="_blank" rel="noopener">eslint-plugin-react</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx i -D eslint-plugin-react</span></span><br></pre></td></tr></table></figure><p>And configure <code>.eslintrc.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"parserOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"ecmaVersion"</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="attr">"sourceType"</span>: <span class="string">"module"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"browser"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"extends"</span>: [<span class="string">"eslint:recommended"</span>, <span class="string">"plugin:react/recommended"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="integrate-eslint-in-vscode">Integrate ESLint in VSCode</span></h3><p>Since we are using VSCode, it makes sense to install <a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint" target="_blank" rel="noopener">ESLint VSCode extension</a> called <code>dbaeumer.vscode-eslint</code></p><p>Open Command Pallette with Command + P</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ext install dbaeumer.vscode-eslint</span><br></pre></td></tr></table></figure><p>Enable this extension in VSCode workspace settings</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;editor.defaultFormatter&quot;: &quot;dbaeumer.vscode-eslint&quot;,</span><br><span class="line">  &quot;editor.formatOnSave&quot;: true,</span><br><span class="line">  &quot;eslint.enable&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JavaScript files should now show ESLint errors right inside VSCode editor.</p><p><img src="/blog/images/prettier/eslint-errors.png" alt="ESLint errors"></p><p>You can see these errors for yourself by opening <code>projectC/index.js</code> in VSCode from the <a href="https://github.com/bahmutov/prettier-config-example" target="_blank" rel="noopener">example repo</a>.</p><h3><span id="run-prettier-from-eslint">Run Prettier from ESLint</span></h3><p>Since ESLint can detect and fix many of the errors it detects automatically, let&#39;s tell ESLint to run Prettier too. Here is the <a href="https://prettier.io/docs/en/integrating-with-linters.html#recommended-configuration" target="_blank" rel="noopener">recommended setup</a></p><p>Install ESLint Prettier config and plugin</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D eslint-config-prettier eslint-plugin-prettier</span></span><br></pre></td></tr></table></figure><p>Point ESLint at the recommended settings which include Prettier styles</p><figure class="highlight json"><figcaption><span>projectD/.eslintrc.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"node"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"es6"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"extends"</span>: [<span class="string">"eslint:recommended"</span>, <span class="string">"plugin:prettier/recommended"</span>],</span><br><span class="line">  <span class="attr">"rules"</span>: &#123;</span><br><span class="line">    <span class="attr">"no-console"</span>: <span class="string">"off"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Notice in the screenshot below how ESLint warnings in VSCode editor include style errors from Prettier.</p><p><img src="/blog/images/prettier/eslint-prettier.png" alt="ESLint shows Prettier errors"></p><p>If we run ESLint with <code>--fix</code> flag, it will use Prettier to auto format code, solving both stylistic and semantic problems.</p><p><img src="/blog/images/prettier/eslint-fix.gif" alt="ESLint with Prettier fixes the code formatting"></p><p>If you decide to use ESLint with Prettier rules and have configured <code>husky</code> to run <code>lint-staged</code>, point it at <code>eslint --fix</code> instead of <code>prettier --write</code>.</p><h3><span id="vscode-eslint-prettier-setup">VSCode + ESLint + Prettier setup</span></h3><p>Let&#39;s configure VSCode to use ESLint to auto-fix found issues, including Prettier. The workspace settings use <a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint" target="_blank" rel="noopener"><code>dbaeumer.vscode-eslint</code></a>.</p><p><strong>plugin v1 version (old)</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"dbaeumer.vscode-eslint"</span>,</span><br><span class="line">  <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.enable"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.alwaysShowStatus"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.autoFixOnSave"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>plugin v2 version (current)</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"dbaeumer.vscode-eslint"</span>,</span><br><span class="line">  <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.enable"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.alwaysShowStatus"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"editor.codeActionsOnSave"</span>: &#123;</span><br><span class="line">    <span class="attr">"source.fixAll.eslint"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The animation shows how saving the file fixes both style and lint problems.</p><p><img src="/blog/images/prettier/use-eslint-to-format.gif" alt="Using ESLint to auto-format and auto-fix issues on save"></p><h3><span id="vscode-eslint-prettier-typescript-setup">VSCode + ESLint + Prettier + TypeScript setup</span></h3><p>ESLint can lint TypeScript files through <a href="https://github.com/typescript-eslint/typescript-eslint" target="_blank" rel="noopener">typescript-eslint</a>, and <a href="https://github.com/prettier/prettier/issues/13" target="_blank" rel="noopener">Prettier can format TypeScript code</a>. Let&#39;s set it up.</p><p>First, if you have previous installed <a href="https://marketplace.visualstudio.com/items?itemName=eg2.tslint" target="_blank" rel="noopener">TSLint extension <code>vscode-tslint</code></a> for VSCode, uninstall it - let ESLint do everything.</p><p>Second, install a new parser and plugin modules</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D @typescript-eslint/parser @typescript-eslint/eslint-plugin</span></span><br><span class="line">+ @typescript-eslint/parser@2.2.0</span><br><span class="line">+ @typescript-eslint/eslint-plugin@2.2.0</span><br><span class="line">updated 2 packages and audited 576 packages in 2.42s</span><br><span class="line">found 0 vulnerabilities</span><br></pre></td></tr></table></figure><p>Then set the VSCode workspace settings to lint TypeScript files</p><figure class="highlight json"><figcaption><span>.vscode/settings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"dbaeumer.vscode-eslint"</span>,</span><br><span class="line">  <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.enable"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.alwaysShowStatus"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.autoFixOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"eslint.validate"</span>: [</span><br><span class="line">    <span class="string">"javascript"</span>,</span><br><span class="line">    <span class="string">"typescript"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Set the ESLint options. Parsing files will be done using <a href="https://github.com/typescript-eslint/typescript-eslint/tree/master/packages/parser" target="_blank" rel="noopener">@typescript-eslint/parser</a>, and we need <a href="https://github.com/typescript-eslint/typescript-eslint/tree/master/packages/eslint-plugin" target="_blank" rel="noopener">@typescript-eslint</a> plugin.</p><figure class="highlight json"><figcaption><span>.eslintrc.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"parser"</span>: <span class="string">"@typescript-eslint/parser"</span>,</span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"@typescript-eslint"</span>],</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"eslint:recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:@typescript-eslint/eslint-recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:@typescript-eslint/recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:prettier/recommended"</span>,</span><br><span class="line">    <span class="string">"prettier/@typescript-eslint"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"rules"</span>: &#123;</span><br><span class="line">    <span class="attr">"no-var"</span>: <span class="string">"error"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>And now you should see ESLint + Prettier errors and warnings in VSCode</p><p><img src="/blog/images/prettier/ts-eslint.png" alt="ESLint error - no vars allowed"></p><p><img src="/blog/images/prettier/ts-prettier.png" alt="Style error - no semi-colons allowed"></p><p><strong>Note:</strong> there is a bug in VSCode + ESLint extension where Prettier is not found. If you open Prettier console you can see the error, there is an <a href="https://github.com/microsoft/vscode-eslint/issues/696" target="_blank" rel="noopener">open issue</a></p><p><img src="/blog/images/prettier/prettier-error.png" alt="Prettier cannot fix the style automatically"></p><p>So we see the lint and style errors, yet cannot reformat the code automatically on save. To work around this issue, use NPM script command.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"fix-ts"</span>: <span class="string">"eslint --fix 'project-with-typescript/*.ts'"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Run this command and it should reformat the TS files and fix most ESLint issues.</p><p><img src="/blog/images/prettier/fix-ts.gif" alt="Fixing TypeScript files"></p><h3><span id="use-prettier-eslint-cypress">Use Prettier + ESLint + Cypress</span></h3><p>One final touch. If you write <a href="https://www.cypress.io" target="_blank" rel="noopener">Cypress</a> end-to-end tests, there is an official <a href="https://github.com/cypress-io/eslint-plugin-cypress" target="_blank" rel="noopener">cypress-io/eslint-plugin-cypress</a> plugin that can catch some common test mistakes. You can find an example &quot;test&quot; in <code>project-with-Cypress/index.js</code> file.</p><p>First, install the plugin</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i -D eslint-plugin-cypress</span></span><br></pre></td></tr></table></figure><p>Then extend ESLint settings</p><figure class="highlight json"><figcaption><span>project-with-Cypress/.eslintrc.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"cypress/globals"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"eslint:recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:prettier/recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:cypress/recommended"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"cypress"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s say your test tries to get back an element using <a href="https://on.cypress.io/get" target="_blank" rel="noopener"><code>cy.get</code></a> command.</p><figure class="highlight js"><figcaption><span>project-with-Cypress/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typical Cypress test</span></span><br><span class="line">it(<span class="string">'loads todos'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// this is wrong - Cypress commands are asynchronous</span></span><br><span class="line">  <span class="comment">// you cannot get element back from cy.get</span></span><br><span class="line">  <span class="comment">// see https://on.cypress.io/get</span></span><br><span class="line">  <span class="keyword">const</span> myApp = cy.get(<span class="string">'#my-app'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>This WON&#39;T work - <code>cy.get</code> does not return an element, like a Promise, the found element will be passed down the command chain. Notice how ESLint shows an error if you try to assign the value of the <code>cy.get</code> command.</p><p><img src="/blog/images/prettier/cypress-error.png" alt="ESLint shows Cypress error"></p><h3><span id="catch-exclusive-tests">Catch exclusive tests</span></h3><p>If you are writing Cypress or Mocha tests, you might accidentally leave <code>it.only</code> or <code>describe.only</code> exclusive tests. The build pipeline will be forever green giving you a false sense of confidence. You can catch exclusive tests using <a href="https://github.com/lo1tuma/eslint-plugin-mocha" target="_blank" rel="noopener">eslint-plugin-mocha</a>.</p><p>See example in subfolder &#39;project-with-mocha&#39; of the <a href="https://github.com/bahmutov/prettier-config-example" target="_blank" rel="noopener">demo repo</a>.</p><p>First, let&#39;s use the Mocha plugin and set the environment and globals.</p><figure class="highlight json"><figcaption><span>.eslintrc.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"es6"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"eslint:recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:prettier/recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:mocha/recommended"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"mocha"</span>],</span><br><span class="line">  <span class="attr">"globals"</span>: &#123;</span><br><span class="line">    <span class="attr">"describe"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"it"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"rules"</span>: &#123;</span><br><span class="line">    <span class="attr">"mocha/no-mocha-arrows"</span>: <span class="string">"off"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Second, let&#39;s try linting a spec file with an exclusive test</p><figure class="highlight js"><figcaption><span>spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'Mocha tests'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'has a test'</span>, () =&gt; &#123;</span><br><span class="line">    expect(<span class="number">1</span>).to.equal(<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it.only(<span class="string">'has another test'</span>, () =&gt; &#123;</span><br><span class="line">    expect(<span class="number">2</span>).to.equal(<span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ../node_modules/.bin/eslint .</span></span><br><span class="line"></span><br><span class="line">/Users/gleb/git/prettier-config-example/project-with-mocha/spec.js</span><br><span class="line">  8:6  warning  Unexpected exclusive mocha test  mocha/no-exclusive-tests</span><br><span class="line"></span><br><span class="line">✖ 1 problem (0 errors, 1 warning)</span><br></pre></td></tr></table></figure><p>Nice, by default the <code>mocha/no-exclusive-tests</code> rules gives a warning. I recommend running lint step in pre-commit hook, where a warning is enough. From the pre-push Git hook I recommend making this rule an error.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ../node_modules/.bin/eslint . --rule <span class="string">'mocha/no-exclusive-tests: error'</span></span></span><br><span class="line"></span><br><span class="line">/Users/gleb/git/prettier-config-example/project-with-mocha/spec.js</span><br><span class="line">  8:6  error  Unexpected exclusive mocha test  mocha/no-exclusive-tests</span><br><span class="line"></span><br><span class="line">✖ 1 problem (1 error, 0 warnings)</span><br></pre></td></tr></table></figure><h3><span id="format-other-languages-with-prettier">Format other languages with Prettier</span></h3><p>Prettier can format many languages: JavaScript, JSON, Markdown, HTML, CSS, etc. Here is formatting CSS for example.</p><p><img src="/blog/images/prettier/format-css.gif" alt="Format CSS file using Prettier"></p><h3><span id="format-json-files-with-prettier">Format JSON files with Prettier</span></h3><p>You can configure Prettier and its VSCode extension to format your JSON files. Since there is already a default JSON formatter built into VSCode, you need to tell VSCode to specifically use <code>esbenp.prettier-vscode</code> to format JSON files. Here is a sample project settings file.</p><figure class="highlight json"><figcaption><span>.vscode/settings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"esbenp.prettier-vscode"</span>,</span><br><span class="line">  <span class="attr">"[json]"</span>: &#123;</span><br><span class="line">    <span class="attr">"editor.defaultFormatter"</span>: <span class="string">"esbenp.prettier-vscode"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"json.format.enable"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/images/prettier/format-json.gif" alt="Format JSON files using Prettier"></p><h3><span id="use-custom-settings-overrides">Use custom settings overrides</span></h3><p>Here is a nice feature - you can set custom Prettier settings for some files. For example, we can use 2 spaces to indent by default, but 4 spaces to indent code blocks inside Markdown files, and 6 spaces to indent JSON files. Just because.</p><figure class="highlight json"><figcaption><span>.prettierrc.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"trailingComma"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"tabWidth"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"semi"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"singleQuote"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"overrides"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"files"</span>: <span class="string">"*.md"</span>,</span><br><span class="line">      <span class="attr">"options"</span>: &#123;</span><br><span class="line">        <span class="attr">"tabWidth"</span>: <span class="number">4</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"files"</span>: <span class="string">"*.json"</span>,</span><br><span class="line">      <span class="attr">"options"</span>: &#123;</span><br><span class="line">        <span class="attr">"tabWidth"</span>: <span class="number">6</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s save a JSON file.</p><p><img src="/blog/images/prettier/format-json-6.gif" alt="Format JSON files using Prettier with overridden settings"></p><p>And here is saving a Markdown with a code block - which gets automatically formatted using Prettier with 4 spaces per tab.</p><p><img src="/blog/images/prettier/format-md.gif" alt="Format code blocks inside Markdown files"></p><h2><span id="common-eslint-problems">Common ESLint problems</span></h2><h3><span id="errors-shown-for-async-keyword">Errors shown for async keyword</span></h3><p>Sometimes ESLint reports a problem around <code>async</code> keyword.</p><p><img src="/blog/images/prettier/async.png" alt="Misleading error after async keyword"></p><p>ESLint&#39;s parser does not understand that you are trying to use ES2017 syntax. Set the parser option in <code>.eslintrc.json</code> file to handle the <code>async / await</code> syntax.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"es6"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"node"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"parserOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"ecmaVersion"</span>: <span class="number">2017</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="chrome-extension">Chrome extension</span></h2><p>There is now Chrome <a href="https://github.com/prettier/prettier-chrome-extension" target="_blank" rel="noopener">Prettier extension</a> that can format code blocks in text areas. Seems for now it is limited to StackOverflow and GitHub.</p><h2><span id="run-prettier-inside-github-action">Run Prettier inside GitHub Action</span></h2><p>GitHub Actions are now generally available - and they can do lots of interesting things, including running Prettier on every push and if there are any changes, committing the code and pushing it to the repo. In essence, they are doing the hard work for you! Read <a href="../trying-github-actions/">Trying GitHub Actions</a> blog post for full details, here is the relevant <a href="https://github.com/bahmutov/gh-action-with-prettier/blob/master/.github/workflows/ci.yml" target="_blank" rel="noopener">CI YML file</a> from <a href="https://github.com/bahmutov/gh-action-with-prettier" target="_blank" rel="noopener">bahmutov/gh-action-with-prettier</a> repo.</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Prettier</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">Prettier</span></span><br><span class="line"><span class="attr">    runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"><span class="attr">    steps:</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">format</span></span><br><span class="line"><span class="attr">      - run:</span> <span class="string">git</span> <span class="string">status</span></span><br><span class="line">      <span class="comment"># commit any changed files</span></span><br><span class="line">      <span class="comment"># https://github.com/mikeal/publish-to-github-action</span></span><br><span class="line"><span class="attr">      - uses:</span> <span class="string">mikeal/publish-to-github-action@master</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line">          <span class="comment"># github token is automatically injected by GH Action</span></span><br><span class="line"><span class="attr">          GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Beautiful, and on every push, if there are any format changes, the code gets updated and pushed, which you can see from the list of commits.</p><p><img src="/blog/images/prettier/prettier-in-gh-action.png" alt="Prettier inside GitHub Action fixing code"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;You can configure JavaScript code auto-formatting with Prettier to work per-project. This allows you to get a consistent formatting witho
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="javascript" scheme="https://glebbahmutov.com/blog/tags/javascript/"/>
    
      <category term="tutorial" scheme="https://glebbahmutov.com/blog/tags/tutorial/"/>
    
      <category term="markdown" scheme="https://glebbahmutov.com/blog/tags/markdown/"/>
    
  </entry>
  
  <entry>
    <title>Cypress using child window</title>
    <link href="https://glebbahmutov.com/blog/cypress-using-child-window/"/>
    <id>https://glebbahmutov.com/blog/cypress-using-child-window/</id>
    <published>2019-09-03T04:00:00.000Z</published>
    <updated>2019-09-04T02:57:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>Normally, Cypress test runner loads your site inside an iframe. This allows the &quot;top&quot; parent window, controlled by Cypress a direct access to your site. Nice, but many sites work hard to avoid being iframed. Cypress already strips <code>X-frame</code> protection headers, and &quot;fixes&quot; most common <a href="https://github.com/cypress-io/cypress/issues/886" target="_blank" rel="noopener">frame-busting JavaScript code</a> like <code>if (top !== self)</code>.</p><p>Imagine the website using the following frame-busting code, and it somehow slipping Cypress JS regex</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">if</span> (top !== self) &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'top !== self !!! frame busted!'</span>)</span></span><br><span class="line"><span class="javascript">    location = <span class="string">'http://www.cypress.io'</span></span></span><br><span class="line"><span class="javascript">  &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'all is good, top === self'</span>)</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The image below shows the frame-busting in action - the site has reference to <code>self</code> window that is different from the <code>top</code> window. Also, the menu shows the different JavaScript contexts - one per window object, which is often a source of confusion.</p><p><img src="/blog/images/child-window/frame-busted.png" alt="Different contexts and frame busting"></p><p>Nothing is foolproof, especially my brain, and having a child iframe for the application under test creates its own confusion. So many times I have opened DevTools, inspecting <code>window</code> or some global object, and wondering - where is the property I have just set? &quot;Ohh, yeah, it was in the APP context, how could I forget!&quot;</p><p>What can we do instead of iframing the application under test website? Cypress needs direct access to the <code>window</code> that is going to load the site. Child iframe window is one possibility, another one is a window opened with <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/open" target="_blank" rel="noopener">window.open</a> call. As long as the <code>document.domain</code> values match between the Cypress window and the loaded site, the two windows will be able to communicate. Cypress proxy takes care of setting the <code>document.domain=&#39;localhost&#39;</code> for you, you can see that script injected into the <code>HEAD</code> element if you inspect the child iframes.</p><p><img src="/blog/images/child-window/document-domain.png" alt="Document domain set to localhost"></p><p>So, let&#39;s replace <a href="https://on.cypress.io/visit" target="_blank" rel="noopener"><code>cy.visit</code></a> with <code>window.open</code>. Here is some code I have lifted from the example repo <a href="https://github.com/bahmutov/cypress-open-child-window" target="_blank" rel="noopener">bahmutov/cypress-open-child-window</a>.</p><p><strong>Note:</strong> I am using Cypress v3.4.1 and Chrome v76 to run this code.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Cypress.Commands.add(<span class="string">'openWindow'</span>, (url, features) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> w = Cypress.config(<span class="string">'viewportWidth'</span>)</span><br><span class="line">  <span class="keyword">const</span> h = Cypress.config(<span class="string">'viewportHeight'</span>)</span><br><span class="line">  <span class="keyword">if</span> (!features) &#123;</span><br><span class="line">    features = <span class="string">`width=<span class="subst">$&#123;w&#125;</span>, height=<span class="subst">$&#123;h&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'openWindow %s "%s"'</span>, url, features)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.top.aut) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'window exists already'</span>)</span><br><span class="line">      <span class="built_in">window</span>.top.aut.close()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// https://developer.mozilla.org/en-US/docs/Web/API/Window/open</span></span><br><span class="line">    <span class="built_in">window</span>.top.aut = <span class="built_in">window</span>.top.open(url, <span class="string">'aut'</span>, features)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// letting page enough time to load and set "document.domain = localhost"</span></span><br><span class="line">    <span class="comment">// so we can access it</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      cy.state(<span class="string">'document'</span>, <span class="built_in">window</span>.top.aut.document)</span><br><span class="line">      cy.state(<span class="string">'window'</span>, <span class="built_in">window</span>.top.aut)</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;, <span class="number">500</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Note that after we get window reference, we wait 500ms to let the document to load. After that we hope the <code>document.domain</code> is set to <code>localhost</code>, allowing our Cypress Test Runner to access it without a security exception.</p><p>I am cheating here a little bit. I am using the undocumented <code>cy.state</code> function that internally stores <code>document</code> and <code>window</code> references. But this is a privilege of working on Cypress every day 😁</p><p>With the child window accessible, the test runs pretty much normally. For example, here is a test that clicks on the button and checks that the counter is displayed correctly.</p><figure class="highlight js"><figcaption><span>spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'counts clicks'</span>, () =&gt; &#123;</span><br><span class="line">  cy.openWindow(<span class="string">'/'</span>)</span><br><span class="line">  cy.contains(<span class="string">'Page body'</span>)</span><br><span class="line"></span><br><span class="line">  cy.get(<span class="string">'button'</span>)</span><br><span class="line">    .click()</span><br><span class="line">    .click()</span><br><span class="line">  cy.get(<span class="string">'#clicked'</span>).should(<span class="string">'have.text'</span>, <span class="string">'2'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"modifyObstructiveCode"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"baseUrl"</span>: <span class="string">"http://localhost:5001"</span>,</span><br><span class="line">  <span class="attr">"viewportWidth"</span>: <span class="number">400</span>,</span><br><span class="line">  <span class="attr">"viewportHeight"</span>: <span class="number">200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The Chrome windows and Cypress main window are shown below</p><p><img src="/blog/images/child-window/testing.png" alt="Tests with separate child window"></p><p>We can open DevTools in the child window and see that <code>top</code> reference is the same as <code>self</code> reference.</p><p><img src="/blog/images/child-window/top-is-self.png" alt="Top is self in the child window"></p><p>The child window has only the elements from the loaded application under test</p><p><img src="/blog/images/child-window/child-window-elements.png" alt="Elements in the child window"></p><p>There is only a single context in the child window, this makes working with JavaScript a little bit simpler.</p><p><img src="/blog/images/child-window/child-window-single-context.png" alt="Single context"></p><p>Since Cypress takes DOM snapshots for its time-traveling debugger, it still works - and the snapshots are shown <em>inside the iframe</em>.</p><p><img src="/blog/images/child-window/child-window.gif" alt="Child window time traveling debugger"></p><p><strong>Note:</strong> there are probably differences in the way child window is controlled by Cypress. At least if you want to detect from the application code if the site is running inside Cypress, instead of checking <code>window.Cypress</code> you need to test <code>window.opener &amp;&amp; window.opener.Cypress</code>.</p><p>Try it out, and open <a href="https://github.com/bahmutov/cypress-open-child-window/issues" target="_blank" rel="noopener">any issues</a> please.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Normally, Cypress test runner loads your site inside an iframe. This allows the &amp;quot;top&amp;quot; parent window, controlled by Cypress a di
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
</feed>
